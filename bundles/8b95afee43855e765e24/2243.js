"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[2243],{"../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/editing.ts":(e,t,r)=>{r.d(t,{g:()=>i,r:()=>a});var n=r("../matrix-js-sdk/src/matrix.ts"),s=r("../matrix-react-sdk/src/dispatcher/dispatcher.ts"),o=r("../matrix-react-sdk/src/dispatcher/actions.ts");function a(e){s.ZP.dispatch({action:o.a.EditEvent,event:null,timelineRenderingType:e.timelineRenderingType}),s.ZP.dispatch({action:o.a.FocusSendMessageComposer,context:e.timelineRenderingType})}function i(e,t){const r=t.getEvent().replacingEvent();!r||r.status!==n.EventStatus.QUEUED&&r.status!==n.EventStatus.NOT_SENT||e.cancelPendingEvent(r)}},"../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/message.ts":(e,t,r)=>{r.r(t),r.d(t,{editMessage:()=>R,sendMessage:()=>M});var n=r("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),s=r("../matrix-js-sdk/src/matrix.ts"),o=r("../matrix-react-sdk/src/PosthogAnalytics.ts"),a=r("../matrix-react-sdk/src/settings/SettingsStore.ts"),i=r("../matrix-react-sdk/src/sendTimePerformanceMetrics.ts"),c=r("../matrix-react-sdk/src/utils/local-room.ts"),l=r("../matrix-react-sdk/src/effects/index.ts"),m=r("../matrix-react-sdk/src/effects/utils.ts"),d=r("../matrix-react-sdk/src/dispatcher/dispatcher.ts"),p=r("../matrix-react-sdk/src/components/views/dialogs/ConfirmRedactDialog.tsx"),u=r("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/editing.ts"),g=r("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),y=r("../matrix-react-sdk/node_modules/@matrix-org/matrix-wysiwyg/dist/matrix-wysiwyg.js"),f=r("../matrix-react-sdk/src/utils/permalinks/Permalinks.ts"),v=r("../matrix-react-sdk/src/utils/Reply.ts"),h=r("../matrix-react-sdk/src/Typeguards.ts");function x(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?x(Object(r),!0).forEach((function(t){(0,g.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):x(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}const k="/me ";const T=e=>e instanceof s.MatrixEvent;async function _(e,t,{relation:r,replyToEvent:n,permalinkCreator:o,includeReplyLegacyFallback:i=!0,editedEvent:c}){const l=T(c),m=l?Boolean(c.replyEventId):T(n),d=l&&m,p=e.startsWith(k);p&&(e=e.slice(k.length)),e.startsWith("//")&&(e=e.slice(1));const u=t?await(0,y.richToPlain)(e,!1):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach((e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const r=(0,f.My)(t);(0,h.K)(r)&&(0,h.K)(r.roomIdOrAlias)&&e.replaceWith(r.roomIdOrAlias);break}}})),t.body.innerHTML}(e),g=d&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const r=t.split("\n").map((e=>e.trim()));return r.length>2&&r[0].startsWith("> ")&&0===r[1].length?`${r[0]}\n\n`:""}(c)||"",x=d&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const r=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return r&&r.outerHTML||""}(c)||"",_={msgtype:p?s.MsgType.Emote:s.MsgType.Text,body:l?`${g} * ${u}`:u},E=a.C.getValue("MessageComposerInput.useMarkdown"),w=t?e:E?await(0,y.plainToRich)(e,!0):null;w&&(_.format="org.matrix.custom.html",_.formatted_body=l?`${x} * ${w}`:w),l&&(_["m.new_content"]={msgtype:_.msgtype,body:u},w&&(_["m.new_content"].format="org.matrix.custom.html",_["m.new_content"].formatted_body=w));return function(e,t){t&&(e["m.relates_to"]=b(b({},e["m.relates_to"]||{}),t))}(_,l?b(b({},r),{},{rel_type:"m.replace",event_id:c.getId()}):r),!l&&n&&o&&(0,v.YL)(_,n,{permalinkCreator:o,includeLegacyFallback:i}),_}var E=r("../matrix-react-sdk/src/SlashCommands.tsx"),w=r("../matrix-react-sdk/src/editor/commands.tsx"),P=r("../matrix-react-sdk/src/dispatcher/actions.ts"),C=r("../matrix-react-sdk/src/components/views/rooms/SendMessageComposer.tsx");const O=["roomContext","mxClient"];async function M(e,t,r){var p;let{roomContext:u,mxClient:g}=r,y=(0,n.Z)(r,O);const{relation:f,replyToEvent:h,permalinkCreator:x}=y,{room:b}=u,T=null==b?void 0:b.roomId;if(!T)return;const M={eventName:"Composer",isEditing:!1,messageType:"Text",isReply:Boolean(h),inThread:(null==f?void 0:f.rel_type)===s.THREAD_RELATION_TYPE.name};o.S.instance.trackEvent(M);let R=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(k)){const{cmd:t,args:r}=(0,E.hW)(e);if(t){const e=(null==f?void 0:f.rel_type)===s.THREAD_RELATION_TYPE.name?null==f?void 0:f.event_id:null;let n;if([R,n]=await(0,w.dn)(g,t,r,T,null!=e?e:null),!n)return;if(!R||t.category!==E.Mv.messages&&t.category!==E.Mv.effects)return;var S,j;(0,C.lZ)(R,f),h&&(0,v.YL)(R,h,{permalinkCreator:x,includeLegacyFallback:null===(S=null===(j=R.msgtype)||void 0===j?void 0:j.startsWith("m."))||void 0===S||S})}else{const t=await(0,w.vB)(e);if(d.ZP.dispatch({action:P.a.FocusAComposer,context:u.timelineRenderingType}),!t)return}}if(null!==(p=R)&&void 0!==p||(R=await _(e,t,y)),!R.body.trim())return;a.C.getValue("Performance.addSendMessageTimingMetadata")&&(0,i.N)(R);const A=null!=f&&f.event_id&&(null==f?void 0:f.rel_type)===s.THREAD_RELATION_TYPE.name?f.event_id:null,D=(0,c.L)(T,(e=>g.sendMessage(e,A,R)),g);return h&&d.ZP.dispatch({action:"reply_to_event",event:null,context:u.timelineRenderingType}),d.ZP.dispatch({action:"message_sent"}),l.b.forEach((e=>{if(R&&(0,m.R)(R,e.emojis)){(null==f?void 0:f.rel_type)!==s.THREAD_RELATION_TYPE.name&&d.ZP.dispatch({action:`effects.${e.command}`})}})),a.C.getValue("Performance.addSendMessageTimingMetadata")&&D.then((e=>{(0,i.G)(g,T,e.event_id)})),a.C.getValue("scrollToBottomOnMessageSent")&&d.ZP.dispatch({action:"scroll_to_bottom",timelineRenderingType:u.timelineRenderingType}),D}async function R(e,{roomContext:t,mxClient:r,editorStateTransfer:n}){const s=n.getEvent();o.S.instance.trackEvent({eventName:"Composer",isEditing:!0,messageType:"Text",inThread:Boolean(null==s?void 0:s.getThread()),isReply:Boolean(s.replyEventId)});const a=await _(e,!0,{editedEvent:s}),i=a["m.new_content"];if(""===(null==i?void 0:i.body))return(0,u.g)(r,n),void(0,p.C)({mxEvent:s,onCloseDialog:()=>{(0,u.r)(t)}});let c;const l=s.getRoomId();if(function(e,t){const r=t.getEvent().getContent();return r.msgtype!==e.msgtype||r.body!==e.body||r.format!==e.format||r.formatted_body!==e.formatted_body}(i,n)&&l){(0,u.g)(r,n);const e=n.getEvent().threadRootId||null;c=r.sendMessage(l,e,a),d.ZP.dispatch({action:"message_sent"})}return(0,u.r)(t),c}}}]);
//# sourceMappingURL=2243.js.map