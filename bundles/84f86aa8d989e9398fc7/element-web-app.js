(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[8673],{"../matrix-react-sdk/res/img/e2e/verified-deprecated.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/e2e/verified-deprecated.85c94e6.svg"},"../matrix-react-sdk/res/img/element-icons/brands/apple.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/brands/apple.3f29900.svg"},"../matrix-react-sdk/res/img/element-icons/brands/facebook.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/brands/facebook.d149f4a.svg"},"../matrix-react-sdk/res/img/element-icons/brands/github.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/brands/github.de3b60e.svg"},"../matrix-react-sdk/res/img/element-icons/brands/gitlab.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/brands/gitlab.e075acd.svg"},"../matrix-react-sdk/res/img/element-icons/brands/google.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/brands/google.44aaf41.svg"},"../matrix-react-sdk/res/img/element-icons/brands/twitter.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/brands/twitter.43b393b.svg"},"../matrix-react-sdk/res/img/element-icons/room/default_app.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/room/default_app.63bac9a.svg"},"../matrix-react-sdk/res/img/element-icons/room/default_cal.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/room/default_cal.68352c5.svg"},"../matrix-react-sdk/res/img/element-icons/room/default_clock.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/room/default_clock.312a340.svg"},"../matrix-react-sdk/res/img/element-icons/room/default_doc.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/room/default_doc.6a6092c.svg"},"../matrix-react-sdk/res/img/element-icons/room/default_video.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/room/default_video.6afce87.svg"},"../matrix-react-sdk/res/img/element-icons/roomlist/dark-light-mode.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/element-icons/roomlist/dark-light-mode.87d7411.svg"},"../matrix-react-sdk/res/img/ellipsis.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/ellipsis.429f53e.svg"},"../matrix-react-sdk/res/img/matrix.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/matrix.d1fcad6.svg"},"../matrix-react-sdk/res/img/plus.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/plus.e8a5e12.svg"},"../matrix-react-sdk/res/img/room_replaced.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/room_replaced.97416ee.svg"},"../matrix-react-sdk/res/img/upload-big.svg":(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});i("./node_modules/react/index.js");const n="img/upload-big.dcf3fb1.svg"},"./src/vector/app.tsx":(e,t,i)=>{"use strict";i.r(t),i.d(t,{loadApp:()=>aI});var n=i("../matrix-js-sdk/src/matrix.ts");if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");let s;globalThis.__js_sdk_entrypoint=!0;try{s=globalThis.indexedDB}catch(e){}s&&n.setCryptoStoreFactory((()=>new n.IndexedDBCryptoStore(s,"matrix-js-sdk:crypto"))),globalThis.matrixcs=n;var o=i("./node_modules/react/index.js"),a=i("../matrix-react-sdk/src/PlatformPeg.ts"),r=i("../matrix-js-sdk/src/logger.ts"),l=i("../matrix-react-sdk/src/languageHandler.tsx"),c=i("../matrix-react-sdk/src/SdkConfig.ts");const d=[n.AutoDiscovery.ERROR_INVALID_HOMESERVER,n.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER],m=Object.values(n.AutoDiscoveryError),h=e=>m.includes(e),p=e=>{switch(e){case n.AutoDiscoveryError.GenericFailure:return(0,l.I8)("auth|autodiscovery_invalid");case n.AutoDiscoveryError.Invalid:return(0,l.I8)("auth|autodiscovery_generic_failure");case n.AutoDiscoveryError.InvalidHsBaseUrl:return(0,l.I8)("auth|autodiscovery_invalid_hs_base_url");case n.AutoDiscoveryError.InvalidHomeserver:return(0,l.I8)("auth|autodiscovery_invalid_hs");case n.AutoDiscoveryError.InvalidIsBaseUrl:return(0,l.I8)("auth|autodiscovery_invalid_is_base_url");case n.AutoDiscoveryError.InvalidIdentityServer:return(0,l.I8)("auth|autodiscovery_invalid_is");case n.AutoDiscoveryError.InvalidIs:return(0,l.I8)("auth|autodiscovery_invalid_is_response");case n.AutoDiscoveryError.MissingWellknown:return(0,l.I8)("auth|autodiscovery_no_well_known");case n.AutoDiscoveryError.InvalidJson:return(0,l.I8)("auth|autodiscovery_invalid_json");case n.AutoDiscoveryError.HomeserverTooOld:return(0,l.I8)("auth|autodiscovery_hs_incompatible")}};class u{static isLivelinessError(e){if(!e)return!1;let t=e;return e instanceof l.yh?t=e.cause:e instanceof Error&&(t=e.message),d.includes(t)}static authComponentStateForError(e,t="login"){if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let i=(0,l._t)("cannot_reach_homeserver"),s=(0,l._t)("cannot_reach_homeserver_detail");if(!u.isLivelinessError(e)){const e=c.ZP.get().brand;i=(0,l._t)("auth|misconfigured_title",{brand:e}),s=(0,l._t)("auth|misconfigured_body",{brand:e},{a:e=>o.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let a=!0;return(e instanceof Error?e.message:e)===n.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER&&(a=!1,i=(0,l._t)("auth|failed_connect_identity_server"),s="register"===t?(0,l._t)("auth|failed_connect_identity_server_register"):"reset_password"===t?(0,l._t)("auth|failed_connect_identity_server_reset_password"):(0,l._t)("auth|failed_connect_identity_server_other")),{serverIsAlive:!1,serverErrorIsFatal:a,serverDeadError:o.createElement("div",null,o.createElement("strong",null,i),o.createElement("div",null,s))}}static async validateServerConfigWithStaticUrls(e,t,i=!1){if(!e)throw new l.yh("auth|no_hs_url_provided");const s={"m.homeserver":{base_url:e}};t&&(s["m.identity_server"]={base_url:t});const o=await n.AutoDiscovery.fromDiscoveryConfig(s),a=new URL(e).hostname;return u.buildValidatedConfigFromDiscovery(a,o,i,!0)}static async validateServerName(e){const t=await n.AutoDiscovery.findClientConfig(e);return u.buildValidatedConfigFromDiscovery(e,t)}static buildValidatedConfigFromDiscovery(e,t,i=!1,s=!1){var o;if(null==t||!t["m.homeserver"])throw r.k.error("Ended up in a state of not knowing which homeserver to connect to."),new l.yh("auth|autodiscovery_unexpected_error_hs");const a=t["m.homeserver"],d=t["m.identity_server"],m=c.ZP.get("validated_server_config");let g=m&&m.isUrl;var v;if(d&&d.state===n.AutoDiscovery.SUCCESS)g=null!==(v=d.base_url)&&void 0!==v?v:void 0;else if(d&&d.state!==n.AutoDiscovery.PROMPT){if(r.k.error("Error determining preferred identity server URL:",d),d.state===n.AutoDiscovery.FAIL_ERROR){if(h(d.error))throw new l.yh(p(d.error),{cause:a.error});throw new l.yh("auth|autodiscovery_unexpected_error_is")}a.error=n.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER,d.base_url&&(g=d.base_url)}if(a.state!==n.AutoDiscovery.SUCCESS&&(r.k.error("Error processing homeserver config:",a),!i||!u.isLivelinessError(a.error))){if(h(a.error))throw new l.yh(p(a.error),{cause:a.error});throw new l.yh("auth|autodiscovery_unexpected_error_hs")}const _=a.base_url;if(!_)throw r.k.error("No homeserver URL configured"),new l.yh("auth|autodiscovery_unexpected_error_hs");let f=null!=e?e:a.server_name;const E=new URL(_);if(f||(f=E.hostname),!f)throw r.k.error("Failed to parse homeserver name from homeserver URL"),new l.yh("auth|autodiscovery_unexpected_error_hs");let y;if((null===(o=t[n.M_AUTHENTICATION.stable])||void 0===o?void 0:o.state)===n.AutoDiscovery.SUCCESS){const{authorizationEndpoint:e,registrationEndpoint:i,tokenEndpoint:s,account:o,issuer:a,metadata:r,signingKeys:l}=t[n.M_AUTHENTICATION.stable];y=Object.freeze({authorizationEndpoint:e,registrationEndpoint:i,tokenEndpoint:s,account:o,issuer:a,metadata:r,signingKeys:l})}return{hsUrl:_,hsName:f,hsNameIsDifferent:E.hostname!==f,isUrl:g,isDefault:!1,warning:a.error,isNameResolvable:!s,delegatedAuthentication:y}}}var g=i("../matrix-js-sdk/src/autodiscovery.ts"),v=i("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),_=i("../matrix-js-sdk/src/errors.ts"),f=i("../matrix-js-sdk/src/version-support.ts"),E=i("../matrix-react-sdk/src/MatrixClientPeg.ts"),y=i("../matrix-react-sdk/src/customisations/Security.ts"),b=i("../matrix-react-sdk/src/indexing/EventIndexPeg.ts"),w=i("../matrix-react-sdk/src/utils/createMatrixClient.ts"),S=i("../matrix-react-sdk/src/Notifier.ts"),C=i("../matrix-react-sdk/src/UserActivity.ts"),k=i("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),x=i("../matrix-react-sdk/src/dispatcher/dispatcher.ts"),R=i("../matrix-react-sdk/src/utils/Timer.ts");const I=new class{constructor(){(0,k.Z)(this,"unavailableTimer",null),(0,k.Z)(this,"dispatcherRef",null),(0,k.Z)(this,"state",null),(0,k.Z)(this,"onAction",(e=>{var t;"user_activity"===e.action&&(this.setState(n.SetPresence.Online),null===(t=this.unavailableTimer)||void 0===t||t.restart())}))}async start(){for(this.unavailableTimer=new R.Z(18e4),this.dispatcherRef=x.ZP.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(n.SetPresence.Unavailable)}catch(e){}}stop(){this.dispatcherRef&&(x.ZP.unregister(this.dispatcherRef),this.dispatcherRef=null),this.unavailableTimer&&(this.unavailableTimer.abort(),this.unavailableTimer=null)}getState(){return this.state}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!E.p.safeGet().isGuest())try{await E.p.safeGet().setSyncPresence(this.state),r.k.debug("Presence:",e)}catch(e){r.k.error("Failed to set presence:",e),this.state=t}}};var P=i("../matrix-react-sdk/src/utils/DMRoomMap.ts"),T=i("../matrix-react-sdk/src/Modal.tsx"),Z=i("../matrix-react-sdk/src/stores/ActiveWidgetStore.ts"),N=i("../matrix-js-sdk/src/oidc/register.ts");class D{constructor(e,t,i,n){this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=i,(0,k.Z)(this,"flows",[]),(0,k.Z)(this,"defaultDeviceDisplayName",void 0),(0,k.Z)(this,"delegatedAuthentication",void 0),(0,k.Z)(this,"tempClient",null),this.defaultDeviceDisplayName=n.defaultDeviceDisplayName,this.delegatedAuthentication=n.delegatedAuthentication}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}setDelegatedAuthentication(e){this.tempClient=null,this.delegatedAuthentication=e}createTemporaryClient(){return this.tempClient||(this.tempClient=(0,n.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})),this.tempClient}async getFlows(e){if(this.delegatedAuthentication)try{return[await M(this.delegatedAuthentication,c.ZP.get().brand,c.ZP.get().oidc_static_clients,e)]}catch(e){r.k.error(e)}const t=this.createTemporaryClient(),{flows:i}=await t.loginFlows(),s=i.find((e=>"m.login.sso"===e.type&&n.DELEGATED_OIDC_COMPATIBILITY.findIn(e)));return this.flows=s?[s]:i,this.flows}loginViaPassword(e,t,i,n){const s=!!e&&e.indexOf("@")>0;let o;o=t&&i?{type:"m.id.phone",country:t,phone:i,number:i}:s?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const a={password:n,identifier:o,initial_device_display_name:this.defaultDeviceDisplayName},l=e=>O(this.fallbackHsUrl,this.isUrl,"m.login.password",a).catch((t=>{throw r.k.log("fallback HS login failed",t),e}));let c=null;return O(this.hsUrl,this.isUrl,"m.login.password",a).catch((e=>{if(c=e,403===e.httpStatus&&this.fallbackHsUrl)return l(c);throw c})).catch((e=>{throw r.k.log("Login failed",e),e}))}}const M=async(e,t,i,n)=>{if(n&&!(e=>{const t=e.metadata.prompt_values_supported;return Array.isArray(t)&&(null==t?void 0:t.includes("create"))})(e))throw new Error("Registration is not supported by OP");const s=await(async(e,t,i,n)=>{const s=((e,t)=>{var i;const n=e.endsWith("/")?e:e+"/";return null==t||null===(i=t[n])||void 0===i?void 0:i.client_id})(e.issuer,n);return s?(r.k.debug(`Using static clientId for issuer ${e.issuer}`),s):await(0,N.X)(e,t,i)})(e,t,window.location.origin,i);return{type:"oidcNativeFlow",clientId:s}};async function O(e,t,i,s){var o;const a=(0,n.createClient)({baseUrl:e,idBaseUrl:t}),l=await a.login(i,s),c=l.well_known;var d,m;c&&(null!==(d=c["m.homeserver"])&&void 0!==d&&d.base_url&&(e=c["m.homeserver"].base_url,r.k.log(`Overrode homeserver setting with ${e} from login response`)),null!==(m=c["m.identity_server"])&&void 0!==m&&m.base_url&&(t=c["m.identity_server"].base_url,r.k.log(`Overrode IS setting with ${t} from login response`)));const h={homeserverUrl:e,identityServerUrl:t,userId:l.user_id,deviceId:l.device_id,accessToken:l.access_token};return null===(o=y.Z.examineLoginResponse)||void 0===o||o.call(y.Z,l,h),h}var A=i("../matrix-react-sdk/src/utils/StorageManager.ts"),L=i("../matrix-react-sdk/src/settings/SettingsStore.ts"),U=i("../matrix-react-sdk/src/settings/SettingLevel.ts"),F=i("../matrix-react-sdk/src/stores/ToastStore.ts"),B=i("../matrix-react-sdk/src/integrations/IntegrationManagers.ts"),V=i("../matrix-react-sdk/src/mjolnir/Mjolnir.ts"),j=i("../matrix-js-sdk/src/crypto/index.ts"),z=i("../matrix-react-sdk/src/components/views/toasts/GenericToast.tsx"),W=i("../matrix-react-sdk/src/dispatcher/actions.ts");const H="mx_snooze_bulk_unverified_device_nag",G="reviewsessions",K=e=>{F.Z.sharedInstance().addOrReplaceToast({key:G,title:(0,l._t)("encryption|verification|unverified_sessions_toast_title"),icon:"verification_warning",props:{description:(0,l._t)("encryption|verification|unverified_sessions_toast_description"),acceptLabel:(0,l._t)("action|review"),onAccept:()=>{Xe.sharedInstance().dismissUnverifiedSessions(e),x.ZP.dispatch({action:W.a.ViewUserDeviceSettings})},rejectLabel:(0,l._t)("encryption|verification|unverified_sessions_toast_reject"),onReject:()=>{Xe.sharedInstance().dismissUnverifiedSessions(e),(()=>{try{localStorage.setItem(H,String(Date.now()))}catch(e){r.k.error("Failed to persist bulk unverified device nag snooze",e)}})()}},component:z.Z,priority:50})};var q=i("../matrix-react-sdk/src/components/views/dialogs/BaseDialog.tsx"),$=i("../matrix-react-sdk/src/components/views/right_panel/EncryptionPanel.tsx");class J extends o.Component{constructor(e){var t;super(e),this.state={verificationRequest:this.props.verificationRequest},null===(t=this.props.verificationRequestPromise)||void 0===t||t.then((e=>{this.setState({verificationRequest:e})}))}render(){const e=this.state.verificationRequest,t=null==e?void 0:e.otherUserId,i=this.props.member||(t?E.p.safeGet().getUser(t):null),n=null!=e&&e.isSelfVerification?(0,l._t)("encryption|verification|verification_dialog_title_device"):(0,l._t)("encryption|verification|verification_dialog_title_user");return i?o.createElement(q.Z,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:n,hasCancel:!0},o.createElement($.Z,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:i,isRoomEncrypted:!1})):null}}var Y=i("../matrix-react-sdk/node_modules/events/events.js"),Q=i.n(Y),X=i("../matrix-js-sdk/src/crypto-api.ts"),ee=i("../matrix-react-sdk/src/SecurityManager.ts"),te=i("../matrix-react-sdk/src/components/views/dialogs/InteractiveAuthDialog.tsx"),ie=i("../matrix-react-sdk/src/contexts/SDKContext.ts"),ne=i("../matrix-react-sdk/src/utils/arrays.ts");let se=function(e){return e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished",e[e.ConfirmReset=6]="ConfirmReset",e}({});class oe extends(Q()){constructor(...e){super(...e),(0,k.Z)(this,"started",void 0),(0,k.Z)(this,"phase",void 0),(0,k.Z)(this,"verificationRequest",null),(0,k.Z)(this,"backupInfo",null),(0,k.Z)(this,"keyId",null),(0,k.Z)(this,"keyInfo",null),(0,k.Z)(this,"hasDevicesToVerifyAgainst",void 0),(0,k.Z)(this,"onUserTrustStatusChanged",(async e=>{var t;if(e!==E.p.safeGet().getSafeUserId())return;await(null===(t=E.p.safeGet().getCrypto())||void 0===t?void 0:t.getCrossSigningKeyId())&&(this.phase=se.Done,this.emit("update"))})),(0,k.Z)(this,"onVerificationRequest",(e=>{this.setActiveVerificationRequest(e)})),(0,k.Z)(this,"onVerificationRequestChange",(async()=>{var e,t;if((null===(e=this.verificationRequest)||void 0===e?void 0:e.phase)===X.VerificationPhase.Cancelled)this.verificationRequest.off(X.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if((null===(t=this.verificationRequest)||void 0===t?void 0:t.phase)===X.VerificationPhase.Done){var i;this.verificationRequest.off(X.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=null;const e=await(null===(i=E.p.safeGet().getCrypto())||void 0===i?void 0:i.getCrossSigningKeyId());this.phase=e?se.Done:se.Busy,this.emit("update")}}))}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new oe),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=se.Loading;const e=E.p.safeGet();e.on(j.qG.VerificationRequestReceived,this.onVerificationRequest),e.on(j.qG.UserTrustStatusChanged,this.onUserTrustStatusChanged);const t=e.getCrypto().getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){var e;if(!this.started)return;this.started=!1,null===(e=this.verificationRequest)||void 0===e||e.off(X.VerificationRequestEvent.Change,this.onVerificationRequestChange);const t=E.p.get();t&&(t.removeListener(j.qG.VerificationRequestReceived,this.onVerificationRequest),t.removeListener(j.qG.UserTrustStatusChanged,this.onUserTrustStatusChanged))}async fetchKeyInfo(){var e,t;if(!this.started)return;const i=E.p.safeGet(),n=await i.secretStorage.isStored("m.cross_signing.master");null===n||0===Object.keys(n).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(n)[0],this.keyInfo=n[this.keyId]);const s=await i.getDehydratedDevice(),o=i.getUserId(),a=i.getCrypto(),r=null!==(e=null===(t=(await a.getUserDeviceInfo([o])).get(o))||void 0===t?void 0:t.values())&&void 0!==e?e:[];this.hasDevicesToVerifyAgainst=await(0,ne.De)(r,(async e=>{if(s&&e.deviceId==(null==s?void 0:s.device_id))return!1;if(!e.getIdentityKey())return!1;const t=await a.getDeviceVerificationStatus(o,e.deviceId);return!(null==t||!t.signedByOwner)})),this.phase=se.Intro,this.emit("update")}async usePassPhrase(){this.phase=se.Busy,this.emit("update");try{var e;const t=E.p.safeGet(),i=await t.getKeyBackupVersion();this.backupInfo=i,this.emit("update"),await new Promise(((e,n)=>{(0,ee.zL)((async()=>{await t.checkOwnCrossSigningTrust(),e(),i&&await t.restoreKeyBackupWithSecretStorage(i)})).catch(n)})),await(null===(e=t.getCrypto())||void 0===e?void 0:e.getCrossSigningKeyId())&&(this.phase=se.Done,this.emit("update"))}catch(e){e instanceof ee.H8||r.k.log(e),this.phase=se.Intro,this.emit("update")}}skip(){this.phase=se.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=se.Finished,this.emit("update")}returnAfterSkip(){this.phase=se.Intro,this.emit("update")}reset(){this.phase=se.ConfirmReset,this.emit("update")}async resetConfirm(){try{await(0,ee.zL)((async()=>{var e;const t=E.p.safeGet();await(null===(e=t.getCrypto())||void 0===e?void 0:e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async e=>{const i=ie.m.instance.accountPasswordStore.getPassword();if(i)return void await e({type:"m.login.password",identifier:{type:"m.id.user",user:t.getSafeUserId()},user:t.getSafeUserId(),password:i});const{finished:n}=T.ZP.createDialog(te.Z,{title:(0,l._t)("encryption|bootstrap_title"),matrixClient:t,makeRequest:e}),[s]=await n;if(!s)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0})),this.phase=se.Finished}),!0)}catch(e){r.k.error("Error resetting cross-signing",e),this.phase=se.Intro}this.emit("update")}returnAfterReset(){this.phase=se.Intro,this.emit("update")}done(){var e;this.phase=se.Finished,this.emit("update"),null===(e=E.p.safeGet().crypto)||void 0===e||e.cancelAndResendAllOutgoingKeyRequests()}async setActiveVerificationRequest(e){this.started&&e.otherUserId===E.p.safeGet().getUserId()&&(this.verificationRequest&&this.verificationRequest.off(X.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on(X.VerificationRequestEvent.Change,this.onVerificationRequestChange),this.emit("update"))}lostKeys(){return!this.hasDevicesToVerifyAgainst&&!this.keyInfo}}var ae=i("../matrix-react-sdk/src/components/views/elements/AccessibleButton.tsx"),re=i("../matrix-react-sdk/src/components/views/elements/Spinner.tsx");class le extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onStoreUpdate",(()=>{const e=oe.sharedInstance();e.phase!==se.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo,lostKeys:e.lostKeys()}):this.props.onFinished()})),(0,k.Z)(this,"onUsePassphraseClick",(async()=>{oe.sharedInstance().usePassPhrase()})),(0,k.Z)(this,"onVerifyClick",(()=>{var e;const t=E.p.safeGet(),i=t.getSafeUserId(),n=t.getCrypto().requestOwnUserVerification();this.props.onFinished(),T.ZP.createDialog(J,{verificationRequestPromise:n,member:null!==(e=t.getUser(i))&&void 0!==e?e:void 0,onFinished:async()=>{(await n).cancel(),this.props.onFinished()}})})),(0,k.Z)(this,"onSkipConfirmClick",(()=>{oe.sharedInstance().skipConfirm()})),(0,k.Z)(this,"onSkipBackClick",(()=>{oe.sharedInstance().returnAfterSkip()})),(0,k.Z)(this,"onResetClick",(e=>{e.preventDefault();oe.sharedInstance().reset()})),(0,k.Z)(this,"onResetConfirmClick",(()=>{this.props.onFinished();oe.sharedInstance().resetConfirm()})),(0,k.Z)(this,"onResetBackClick",(()=>{oe.sharedInstance().returnAfterReset()})),(0,k.Z)(this,"onDoneClick",(()=>{oe.sharedInstance().done()})),(0,k.Z)(this,"onEncryptionPanelClose",(()=>{this.props.onFinished()}));const t=oe.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,verificationRequest:t.verificationRequest,backupInfo:t.backupInfo,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=oe.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const e=E.p.safeGet(),{phase:t,lostKeys:i}=this.state;if(this.state.verificationRequest&&e.getUser(this.state.verificationRequest.otherUserId))return o.createElement($.Z,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.onEncryptionPanelClose,member:e.getUser(this.state.verificationRequest.otherUserId),isRoomEncrypted:!1});if(t===se.Intro){if(i)return o.createElement("div",null,o.createElement("p",null,(0,l._t)("encryption|verification|no_key_or_device")),o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.createElement(ae.Z,{kind:"primary",onClick:this.onResetConfirmClick},(0,l._t)("encryption|verification|reset_proceed_prompt"))));{const e=oe.sharedInstance();let t,i,s;return e.keyInfo&&(n=e.keyInfo,Boolean(n.passphrase&&n.passphrase.salt&&n.passphrase.iterations))?t=(0,l._t)("encryption|verification|verify_using_key_or_phrase"):e.keyInfo&&(t=(0,l._t)("encryption|verification|verify_using_key")),t&&(i=o.createElement(ae.Z,{kind:"primary",onClick:this.onUsePassphraseClick},t)),e.hasDevicesToVerifyAgainst&&(s=o.createElement(ae.Z,{kind:"primary",onClick:this.onVerifyClick},(0,l._t)("encryption|verification|verify_using_device"))),o.createElement("div",null,o.createElement("p",null,(0,l._t)("encryption|verification|verification_description")),o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},s,i),o.createElement("div",{className:"mx_SetupEncryptionBody_reset"},(0,l._t)("encryption|reset_all_button",void 0,{a:e=>o.createElement(ae.Z,{kind:"link_inline",className:"mx_SetupEncryptionBody_reset_link",onClick:this.onResetClick},e)})))}}if(t===se.Done){let e;return e=this.state.backupInfo?o.createElement("p",null,(0,l._t)("encryption|verification|verification_success_with_backup")):o.createElement("p",null,(0,l._t)("encryption|verification|verification_success_without_backup")),o.createElement("div",null,o.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),e,o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.createElement(ae.Z,{kind:"primary",onClick:this.onDoneClick},(0,l._t)("action|done"))))}return t===se.ConfirmSkip?o.createElement("div",null,o.createElement("p",null,(0,l._t)("encryption|verification|verification_skip_warning")),o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.createElement(ae.Z,{kind:"danger_outline",onClick:this.onSkipConfirmClick},(0,l._t)("encryption|verification|verify_later")),o.createElement(ae.Z,{kind:"primary",onClick:this.onSkipBackClick},(0,l._t)("action|go_back")))):t===se.ConfirmReset?o.createElement("div",null,o.createElement("p",null,(0,l._t)("encryption|verification|verify_reset_warning_1")),o.createElement("p",null,(0,l._t)("encryption|verification|verify_reset_warning_2")),o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.createElement(ae.Z,{kind:"danger_outline",onClick:this.onResetConfirmClick},(0,l._t)("encryption|verification|reset_proceed_prompt")),o.createElement(ae.Z,{kind:"primary",onClick:this.onResetBackClick},(0,l._t)("action|go_back")))):t===se.Busy||t===se.Loading?o.createElement(re.Z,null):void r.k.log(`SetupEncryptionBody: Unknown phase ${t}`);var n}}function ce(e){return e===se.Done?i("../matrix-react-sdk/res/img/e2e/verified-deprecated.svg").Z:i("../matrix-react-sdk/res/img/e2e/warning-deprecated.svg").Z}class de extends o.Component{constructor(e){super(e),(0,k.Z)(this,"store",void 0),(0,k.Z)(this,"onStoreUpdate",(()=>{this.setState({icon:ce(this.store.phase)})})),this.store=oe.sharedInstance(),this.state={icon:ce(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return o.createElement(q.Z,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:(0,l._t)("encryption|verify_toast_title")},o.createElement(le,{onFinished:this.props.onFinished}))}}const me="setupencryption",he=e=>{switch(e){case ve.SET_UP_ENCRYPTION:return(0,l._t)("encryption|set_up_toast_title");case ve.UPGRADE_ENCRYPTION:return(0,l._t)("encryption|upgrade_toast_title");case ve.VERIFY_THIS_SESSION:return(0,l._t)("encryption|verify_toast_title")}},pe=e=>{switch(e){case ve.SET_UP_ENCRYPTION:case ve.UPGRADE_ENCRYPTION:return"secure_backup";case ve.VERIFY_THIS_SESSION:return"verification_warning"}},ue=e=>{switch(e){case ve.SET_UP_ENCRYPTION:return(0,l._t)("action|continue");case ve.UPGRADE_ENCRYPTION:return(0,l._t)("action|upgrade");case ve.VERIFY_THIS_SESSION:return(0,l._t)("action|verify")}},ge=e=>{switch(e){case ve.SET_UP_ENCRYPTION:case ve.UPGRADE_ENCRYPTION:return(0,l._t)("encryption|set_up_toast_description");case ve.VERIFY_THIS_SESSION:return(0,l._t)("encryption|verify_toast_description")}};let ve=function(e){return e.SET_UP_ENCRYPTION="set_up_encryption",e.UPGRADE_ENCRYPTION="upgrade_encryption",e.VERIFY_THIS_SESSION="verify_this_session",e}({});const _e=()=>{Xe.sharedInstance().dismissEncryptionSetup()},fe=e=>{var t;if(null!==(t=y.Z.setupEncryptionNeeded)&&void 0!==t&&t.call(y.Z,e))return;F.Z.sharedInstance().addOrReplaceToast({key:me,title:he(e),icon:pe(e),props:{description:ge(e),acceptLabel:ue(e),onAccept:async()=>{if(e===ve.VERIFY_THIS_SESSION)T.ZP.createDialog(de,{},void 0,!1,!0);else{const e=T.ZP.createDialog(re.Z,void 0,"mx_Dialog_spinner",!1,!0);try{await(0,ee.zL)()}finally{e.close()}}},rejectLabel:(0,l._t)("encryption|verification|unverified_sessions_toast_reject"),onReject:_e},component:z.Z,priority:e===ve.VERIFY_THIS_SESSION?95:40})},Ee=()=>{F.Z.sharedInstance().dismissToast(me)},ye=async(e,t)=>{var i;const n=await(null===(i=e.getCrypto())||void 0===i?void 0:i.getDeviceVerificationStatus(e.getSafeUserId(),t));return n?n.crossSigningVerified:null};var be=i("../matrix-react-sdk/node_modules/ua-parser-js/src/ua-parser.js"),we=i.n(be);let Se=function(e){return e.Desktop="Desktop",e.Mobile="Mobile",e.Web="Web",e.Unknown="Unknown",e}({});const Ce=(e,t)=>e&&[e,t].filter(Boolean).join(" "),ke=e=>{if(!e)return{deviceType:Se.Unknown};const t=new(we())(e),i=t.getBrowser(),n=t.getDevice(),s=t.getOS(),o=((e,t,i,n)=>{var s;return"Electron"===i.name?Se.Desktop:i.name?Se.Web:"mobile"===t.type||null!==(s=n.name)&&void 0!==s&&s.includes("Android")||e.indexOf("; iOS ")>-1?Se.Mobile:Se.Unknown})(e,n,i,s),a=o===Se.Web||o===Se.Desktop,r=Ce(s.name,a?void 0:s.version),l=Ce(n.vendor,n.model),c=Ce(i.name,i.version),{customDeviceModel:d,customDeviceOS:m}=o!==Se.Unknown?(e=>{if(e.includes("Mozilla/"))return{};if(!e.includes("("))return{};const t=e.substring(e.indexOf("(")+1).split("; ");return{customDeviceModel:t[0]||void 0,customDeviceOS:t[1]||void 0}})(e):{};return{deviceType:o,deviceModel:l||d,deviceOperatingSystem:r||m,client:c}};var xe;function Re(){return Re=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Re.apply(this,arguments)}function Ie(e,t){return o.createElement("svg",Re({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8 14",role:"presentation","aria-hidden":!0,ref:t},e),xe||(xe=o.createElement("path",{d:"M1.333.333C.6.333 0 .933 0 1.666l.007 2.12c0 .354.14.687.386.94L2.667 7 .393 9.286a1.332 1.332 0 00-.386.94L0 12.333c0 .733.6 1.333 1.333 1.333h5.334c.733 0 1.333-.6 1.333-1.333v-2.107c0-.353-.14-.693-.387-.94L5.333 7l2.274-2.267C7.86 4.48 8 4.14 8 3.786v-2.12C8 .933 7.4.333 6.667.333H1.333zm5.334 9.94v1.393c0 .367-.3.667-.667.667H2a.669.669 0 01-.667-.667v-1.393c0-.18.074-.347.194-.473L4 7.333l2.473 2.473c.12.12.194.294.194.467z",fill:"currentColor"})))}var Pe=o.forwardRef(Ie);let Te=function(e){return e.Verified="Verified",e.Unverified="Unverified",e.Inactive="Inactive",e.Unverifiable="Unverifiable",e}({});const Ze=7776e6,Ne=e=>!!e.last_seen_ts&&e.last_seen_ts<Date.now()-Ze,De={[Te.Verified]:e=>!!e.isVerified,[Te.Unverified]:e=>!e.isVerified,[Te.Inactive]:Ne},Me=(e,t)=>{const i=t.map((e=>De[e]));return i.length?e.filter((e=>i.every((t=>t(e))))):e};var Oe=i("../matrix-react-sdk/src/DateUtils.ts");const Ae=(e,t=(new Date).getTime())=>{if(e+5184e5>=t){const t=new Date(e);return(0,Oe.p6)(t)}return(0,Oe.SY)(new Date(e))},Le=({value:e,id:t})=>e?o.createElement("span",{"data-testid":`device-metadata-${t}`},e):null,Ue=({device:e})=>{const t=(e=>{if(Ne(e)&&e.last_seen_ts)return{id:"inactive",value:o.createElement(o.Fragment,null,o.createElement(Pe,{className:"mx_DeviceTile_inactiveIcon"}),(0,l._t)("settings|sessions|inactive_days",{inactiveAgeDays:90})+` (${Ae(e.last_seen_ts)})`)}})(e),i=e.last_seen_ts&&`${(0,l._t)("settings|sessions|last_activity")} ${Ae(e.last_seen_ts)}`,n=e.isVerified?(0,l._t)("common|verified"):(0,l._t)("common|unverified"),s=t?[t,{id:"lastSeenIp",value:e.last_seen_ip}]:[{id:"isVerified",value:n},{id:"lastActivity",value:i},{id:"lastSeenIp",value:e.last_seen_ip},{id:"deviceId",value:e.device_id}];return o.createElement(o.Fragment,null,s.map((({id:e,value:t},i)=>t?o.createElement(o.Fragment,{key:e},!!i&&" Â· ",o.createElement(Le,{id:e,value:t})):null)))};function Fe(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Be(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Fe(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Fe(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Ve(e){return"unverified_session_"+e}const je=async e=>{const t=E.p.safeGet(),i=await t.getDevice(e),n=Be(Be({},i),{},{isVerified:await ye(t,e),deviceType:Se.Unknown});F.Z.sharedInstance().addOrReplaceToast({key:Ve(e),title:(0,l._t)("encryption|verification|unverified_session_toast_title"),icon:"verification_warning",props:{description:i.display_name,detail:o.createElement(Ue,{device:n}),acceptLabel:(0,l._t)("encryption|verification|unverified_session_toast_accept"),onAccept:()=>{Xe.sharedInstance().dismissUnverifiedSessions([e])},rejectLabel:(0,l._t)("action|no"),onReject:()=>{Xe.sharedInstance().dismissUnverifiedSessions([e]),x.ZP.dispatch({action:W.a.ViewUserDeviceSettings})}},component:z.Z,priority:80})},ze=e=>{F.Z.sharedInstance().dismissToast(Ve(e))};var We=i("../matrix-react-sdk/src/utils/WellKnownUtils.ts"),He=i("../matrix-react-sdk/src/Views.ts");const Ge="io.element.matrix_client_information.",Ke=e=>`${Ge}${e}`,qe=async(e,t,i)=>{const n=e.getDeviceId(),{brand:s}=t,o=await(null==i?void 0:i.getAppVersion()),a=Ke(n),r=(()=>{if(window.electron)return;const e=new URL(window.location.href);return[e.host,e.pathname.replace(/\/$/,"")].join("")})();await e.setAccountData(a,{name:s,version:o,url:r})},$e=e=>e&&"string"==typeof e?e:void 0,Je=(e,t)=>{const i=e.getAccountData(Ke(t));if(!i)return{};const{name:n,version:s,url:o}=i.getContent();return{name:$e(n),version:$e(s),url:$e(o)}};var Ye=i("../matrix-react-sdk/src/settings/UIFeature.ts"),Qe=i("../matrix-react-sdk/src/utils/crypto/deviceInfo.ts");class Xe{constructor(){(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"dismissed",new Set),(0,k.Z)(this,"dismissedThisDeviceToast",!1),(0,k.Z)(this,"keyBackupInfo",null),(0,k.Z)(this,"keyBackupFetchedAt",null),(0,k.Z)(this,"ourDeviceIdsAtStart",null),(0,k.Z)(this,"displayingToastsForDeviceIds",new Set),(0,k.Z)(this,"running",!1),(0,k.Z)(this,"client",void 0),(0,k.Z)(this,"shouldRecordClientInformation",!1),(0,k.Z)(this,"enableBulkUnverifiedSessionsReminder",!0),(0,k.Z)(this,"deviceClientInformationSettingWatcherRef",void 0),(0,k.Z)(this,"onWillUpdateDevices",(async(e,t)=>{if(!this.client)return;if(t)return;const i=this.client.getSafeUserId();e.includes(i)&&await this.ensureDeviceIdsAtStartPopulated()})),(0,k.Z)(this,"onDevicesUpdated",(e=>{this.client&&e.includes(this.client.getSafeUserId())&&this.recheck()})),(0,k.Z)(this,"onDeviceVerificationChanged",(e=>{this.client&&e===this.client.getUserId()&&this.recheck()})),(0,k.Z)(this,"onUserTrustStatusChanged",(e=>{this.client&&e===this.client.getUserId()&&this.recheck()})),(0,k.Z)(this,"onCrossSingingKeysChanged",(()=>{this.recheck()})),(0,k.Z)(this,"onAccountData",(e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing.")||"m.megolm_backup.v1"===e.getType())&&this.recheck()})),(0,k.Z)(this,"onSync",((e,t)=>{"PREPARED"===e&&null===t&&this.recheck()})),(0,k.Z)(this,"onRoomStateEvents",(e=>{e.getType()===n.EventType.RoomEncryption&&this.recheck()})),(0,k.Z)(this,"onAction",(({action:e})=>{e===W.a.OnLoggedIn&&(this.recheck(),this.updateClientInformation())})),(0,k.Z)(this,"checkKeyBackupStatus",(async()=>{var e;if(this.keyBackupStatusChecked||!this.client)return;const t=await(null===(e=this.client.getCrypto())||void 0===e?void 0:e.getActiveSessionBackupVersion());this.keyBackupStatusChecked=!!t,t||x.ZP.dispatch({action:W.a.ReportKeyBackupNotEnabled})})),(0,k.Z)(this,"keyBackupStatusChecked",!1),(0,k.Z)(this,"onRecordClientInformationSettingChange",((e,t,i,n,s)=>{const o=this.shouldRecordClientInformation;this.shouldRecordClientInformation=!!s,this.shouldRecordClientInformation!==o&&this.updateClientInformation()})),(0,k.Z)(this,"updateClientInformation",(async()=>{if(this.client)try{var e;if(this.shouldRecordClientInformation)await qe(this.client,c.ZP.get(),null!==(e=a.Z.get())&&void 0!==e?e:void 0);else await(async e=>{const t=e.getDeviceId(),i=Ke(t),n=Je(e,t);(n.name||n.version||n.url)&&await e.deleteAccountData(i)})(this.client)}catch(e){r.k.error("Failed to update client information",e)}}))}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new Xe),window.mxDeviceListener}start(e){this.running=!0,this.client=e,this.client.on(j.qG.WillUpdateDevices,this.onWillUpdateDevices),this.client.on(j.qG.DevicesUpdated,this.onDevicesUpdated),this.client.on(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.client.on(j.qG.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.on(j.qG.KeysChanged,this.onCrossSingingKeysChanged),this.client.on(n.ClientEvent.AccountData,this.onAccountData),this.client.on(n.ClientEvent.Sync,this.onSync),this.client.on(n.RoomStateEvent.Events,this.onRoomStateEvents),this.shouldRecordClientInformation=L.C.getValue("deviceClientInformationOptIn"),this.enableBulkUnverifiedSessionsReminder=L.C.getValue(Ye.H.BulkUnverifiedSessionsReminder),this.deviceClientInformationSettingWatcherRef=L.C.watchSetting("deviceClientInformationOptIn",null,this.onRecordClientInformationSettingChange),this.dispatcherRef=x.ZP.register(this.onAction),this.recheck(),this.updateClientInformation()}stop(){this.running=!1,this.client&&(this.client.removeListener(j.qG.WillUpdateDevices,this.onWillUpdateDevices),this.client.removeListener(j.qG.DevicesUpdated,this.onDevicesUpdated),this.client.removeListener(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.client.removeListener(j.qG.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.removeListener(j.qG.KeysChanged,this.onCrossSingingKeysChanged),this.client.removeListener(n.ClientEvent.AccountData,this.onAccountData),this.client.removeListener(n.ClientEvent.Sync,this.onSync),this.client.removeListener(n.RoomStateEvent.Events,this.onRoomStateEvents)),this.deviceClientInformationSettingWatcherRef&&L.C.unwatchSetting(this.deviceClientInformationSettingWatcherRef),this.dispatcherRef&&(x.ZP.unregister(this.dispatcherRef),this.dispatcherRef=void 0),this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.keyBackupStatusChecked=!1,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set,this.client=void 0}async dismissUnverifiedSessions(e){r.k.log("Dismissing unverified sessions: "+Array.from(e).join(","));for(const t of e)this.dismissed.add(t);this.recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this.recheck()}async ensureDeviceIdsAtStartPopulated(){null===this.ourDeviceIdsAtStart&&(this.ourDeviceIdsAtStart=await this.getDeviceIds())}async getDeviceIds(){const e=this.client;return e?await(0,Qe.Z)(e,e.getSafeUserId()):new Set}async getKeyBackupInfo(){if(!this.client)return null;const e=(new Date).getTime();return(!this.keyBackupInfo||!this.keyBackupFetchedAt||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await this.client.getKeyBackupVersion(),this.keyBackupFetchedAt=e),this.keyBackupInfo}shouldShowSetupEncryptionToast(){var e;if((0,ee.LT)())return!1;const t=this.client;return null!==(e=null==t?void 0:t.getRooms().some((e=>t.isRoomEncrypted(e.roomId))))&&void 0!==e&&e}recheck(){this.doRecheck().catch((e=>{e instanceof n.ClientStoppedError||r.k.error("Error during `DeviceListener.recheck`",e)}))}async doRecheck(){var e;if(!this.running||!this.client)return;const t=this.client;if(!await t.isVersionSupported("v1.1"))return;const i=t.getCrypto();if(!i)return;if(!t.isInitialSyncComplete())return;const n=await i.isCrossSigningReady(),s=await i.isSecretStorageReady(),o=n&&s;if(this.dismissedThisDeviceToast||o)Ee(),this.checkKeyBackupStatus();else if(this.shouldShowSetupEncryptionToast())if(await i.getUserDeviceInfo([t.getSafeUserId()]),!await i.getCrossSigningKeyId()&&await i.userHasCrossSigningKeys())fe(ve.VERIFY_THIS_SESSION),this.checkKeyBackupStatus();else{await this.getKeyBackupInfo()?fe(ve.UPGRADE_ENCRYPTION):(await t.waitForClientWellKnown(),(0,We.jV)(t)&&function(){const e=window.matrixChat;return(null==e?void 0:e.state.view)===He.Z.LOGGED_IN}()?(Ee(),(0,ee.zL)()):fe(ve.SET_UP_ENCRYPTION))}await this.ensureDeviceIdsAtStartPopulated();const a=new Set,l=new Set,c=n&&Boolean(null===(e=await i.getDeviceVerificationStatus(t.getSafeUserId(),t.deviceId))||void 0===e?void 0:e.crossSigningVerified);if(n){const e=await this.getDeviceIds();for(const n of e){if(n===t.deviceId)continue;const e=await i.getDeviceVerificationStatus(t.getSafeUserId(),n);var d;if(!(null!=e&&e.crossSigningVerified||this.dismissed.has(n)))null!==(d=this.ourDeviceIdsAtStart)&&void 0!==d&&d.has(n)?a.add(n):l.add(n)}}r.k.debug("Old unverified sessions: "+Array.from(a).join(",")),r.k.debug("New unverified sessions: "+Array.from(l).join(",")),r.k.debug("Currently showing toasts for: "+Array.from(this.displayingToastsForDeviceIds).join(","));const m=(()=>{try{const e=localStorage.getItem(H),t=Number.parseInt(e||"",10);return Number.isInteger(t)&&t+6048e5>Date.now()}catch(e){return!1}})();a.size>0&&c&&this.enableBulkUnverifiedSessionsReminder&&!m?K(a):F.Z.sharedInstance().dismissToast(G);for(const e of l)je(e);for(const e of this.displayingToastsForDeviceIds)l.has(e)||(r.k.debug("Hiding unverified session toast for "+e),ze(e));this.displayingToastsForDeviceIds=l}}var et=i("../matrix-react-sdk/src/widgets/Jitsi.ts"),tt=i("../matrix-react-sdk/src/BasePlatform.ts"),it=i("../matrix-react-sdk/node_modules/rfc4648/lib/rfc4648.js"),nt=i("../matrix-react-sdk/node_modules/buffer/index.js").lW;function st(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const ot="mx_threepid_invite_";class at extends(Q()){static get instance(){return at._instance||(at._instance=new at),at._instance}storeInvite(e,t){const i=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?st(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):st(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({roomId:e},t),n=this.generateIdOf(i);return localStorage.setItem(`${ot}${n}`,JSON.stringify(i)),this.translateInvite(i)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const i=localStorage.key(t);if(null!=i&&i.startsWith(ot))try{e.push(JSON.parse(localStorage.getItem(i)))}catch(e){console.warn("Failed to parse 3pid invite",e)}}return e}getInvites(){return this.getWireInvites().map((e=>this.translateInvite(e)))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem(`${ot}${e.id}`)}generateIdOf(e){return it.pJ.stringify(nt.from(JSON.stringify(e)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}(0,k.Z)(at,"_instance",void 0);var rt=i("../matrix-react-sdk/src/PosthogAnalytics.ts"),lt=i("../matrix-react-sdk/src/LegacyCallHandler.tsx");const ct={};var dt=i("../matrix-react-sdk/src/components/views/dialogs/ErrorDialog.tsx"),mt=i("../matrix-react-sdk/src/components/views/dialogs/QuestionDialog.tsx");const ht=e=>{const t=c.ZP.get().brand,i=(0,l._t)("lazy_loading|resync_description",{brand:t});return o.createElement(mt.Z,{hasCancelButton:!1,title:(0,l._t)("lazy_loading|resync_title",{brand:t}),description:o.createElement("div",null,i),button:(0,l._t)("action|ok"),onFinished:e.onFinished})},pt=e=>{const t=c.ZP.get().brand,i=(0,l._t)("lazy_loading|disabled_description1",{brand:t,host:e.host}),n=(0,l._t)("lazy_loading|disabled_description2",{brand:t});return o.createElement(mt.Z,{hasCancelButton:!1,title:(0,l._t)("lazy_loading|disabled_title"),description:o.createElement("div",null,o.createElement("p",null,i),o.createElement("p",null,n)),button:(0,l._t)("lazy_loading|disabled_action"),onFinished:e.onFinished})};var ut=i("../matrix-react-sdk/src/components/views/dialogs/BugReportDialog.tsx"),gt=i("../matrix-react-sdk/src/components/views/elements/DialogButtons.tsx");class vt extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"sendBugReport",(()=>{T.ZP.createDialog(ut.Z,{error:this.props.error})})),(0,k.Z)(this,"onClearStorageClick",(()=>{T.ZP.createDialog(mt.Z,{title:(0,l._t)("action|sign_out"),description:o.createElement("div",null,(0,l._t)("error|session_restore|clear_storage_description")),button:(0,l._t)("action|sign_out"),danger:!0,onFinished:this.props.onFinished})})),(0,k.Z)(this,"onRefreshClick",(()=>{window.location.reload()}))}render(){const e=c.ZP.get().brand,t=o.createElement("button",{onClick:this.onClearStorageClick,className:"danger"},(0,l._t)("error|session_restore|clear_storage_button"));let i;return i=c.ZP.get().bug_report_endpoint_url?o.createElement(gt.Z,{primaryButton:(0,l._t)("bug_reporting|send_logs"),onPrimaryButtonClick:this.sendBugReport,focus:!0,hasCancel:!1},t):o.createElement(gt.Z,{primaryButton:(0,l._t)("action|refresh"),onPrimaryButtonClick:this.onRefreshClick,focus:!0,hasCancel:!1},t),o.createElement(q.Z,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,l._t)("error|session_restore|title"),contentId:"mx_Dialog_content",hasCancel:!1},o.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.createElement("p",null,(0,l._t)("error|session_restore|description_1")),o.createElement("p",null,(0,l._t)("error|session_restore|description_2",{brand:e})),o.createElement("p",null,(0,l._t)("error|session_restore|description_3"))),i)}}class _t extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"sendBugReport",(e=>{e.preventDefault(),T.ZP.createDialog(ut.Z,{})})),(0,k.Z)(this,"onSignOutClick",(()=>{this.props.onFinished(!0)}))}render(){let e;return c.ZP.get().bug_report_endpoint_url&&(e=(0,l._t)("bug_reporting|log_request",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.sendBugReport},e)})),o.createElement(q.Z,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,l._t)("error|storage_evicted_title"),contentId:"mx_Dialog_content",hasCancel:!1},o.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.createElement("p",null,(0,l._t)("error|storage_evicted_description_1")),o.createElement("p",null,(0,l._t)("error|storage_evicted_description_2")," ",e)),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|sign_out"),onPrimaryButtonClick:this.onSignOutClick,focus:!0,hasCancel:!1}))}}var ft=i("../matrix-react-sdk/src/sentry.ts"),Et=i("../matrix-react-sdk/node_modules/classnames/index.js"),yt=i.n(Et),bt=i("../matrix-react-sdk/src/components/views/dialogs/RoomSettingsDialog.tsx"),wt=i("../matrix-react-sdk/src/hooks/useSettings.ts"),St=i("../matrix-react-sdk/src/settings/enums/Layout.ts"),Ct=i("../matrix-react-sdk/src/Avatar.ts"),kt=i("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/extends.js"),xt=i("../matrix-js-sdk/src/webrtc/call.ts"),Rt=i("../matrix-react-sdk/src/utils/permalinks/Permalinks.ts"),It=i("../matrix-react-sdk/src/utils/FormattingUtils.ts"),Pt=i("../matrix-react-sdk/src/customisations/UserIdentifier.ts");class Tt extends o.Component{render(){const{fallbackName:e,member:t,colored:i,emphasizeDisplayName:n,withTooltip:s,onClick:a}=this.props,r=(null==t?void 0:t.rawDisplayName)||e,c=null==t?void 0:t.userId;let d,m,h;if(i&&(d=(0,It.kG)(null!=c?c:"")),c){var p,u;const e=null!==(p=null===(u=Pt.Z.getDisplayUserIdentifier)||void 0===u?void 0:u.call(Pt.Z,c,{withDisplayName:!0,roomId:t.roomId}))&&void 0!==p?p:c;null!=t&&t.disambiguate&&(m=o.createElement("span",{className:"mx_DisambiguatedProfile_mxid"},e)),h=(0,l._t)("timeline|disambiguated_profile",{displayName:r,matrixId:e})}const g=yt()(d,{mx_DisambiguatedProfile_displayName:n});return o.createElement("div",{className:"mx_DisambiguatedProfile",title:s?h:void 0,onClick:a},o.createElement("span",{className:g,dir:"auto"},r),m)}}var Zt=i("../matrix-react-sdk/src/hooks/room/useRoomMemberProfile.ts");function Nt({mxEvent:e,onClick:t,withTooltip:i}){var s;const a=(0,Zt.i)({userId:e.getSender(),member:e.sender});return e.getContent().msgtype!==n.MsgType.Emote?o.createElement(Tt,{fallbackName:null!==(s=e.getSender())&&void 0!==s?s:"",onClick:t,member:a,colored:!0,emphasizeDisplayName:!0,withTooltip:i}):o.createElement(o.Fragment,null)}var Dt=i("../matrix-react-sdk/src/components/views/messages/MImageBody.tsx");class Mt extends Dt.Z{constructor(...e){super(...e),(0,k.Z)(this,"onClick",(e=>{e.preventDefault()}))}wrapImage(e,t){return t}render(){if(this.state.error)return super.render();const e=this.props.mxEvent.getContent(),t=this.state.contentUrl?this.messageContent(this.state.contentUrl,this.state.thumbUrl,e,44):void 0;return o.createElement("div",{className:"mx_MImageReplyBody"},t)}}var Ot=i("../matrix-react-sdk/src/utils/EventUtils.ts"),At=i("../matrix-react-sdk/src/events/EventTileFactory.tsx"),Lt=i("../matrix-react-sdk/src/models/Call.ts"),Ut=i("../matrix-react-sdk/src/voice-broadcast/index.ts");function Ft(e,t,i,s){const o=t.getContent(),a=o.msgtype,r=t.getType();let l=!1;if(L.C.getValue("feature_msc3531_hide_messages_pending_moderation"))switch((0,Ot.Uy)(t,e)){case Ot.C7.VISIBLE_FOR_ALL:case Ot.C7.HIDDEN_TO_CURRENT_USER:break;case Ot.C7.SEE_THROUGH_FOR_CURRENT_USER:l=!0}let c=(0,At.$Y)(t,e,i),d=r.startsWith("m.key.verification")||r===n.EventType.RoomMessage&&(null==a?void 0:a.startsWith("m.key.verification"))||r===n.EventType.RoomCreate||r===n.EventType.RoomEncryption||c===At.Ge;const m=!d&&(r===n.EventType.CallInvite||Lt.gk.CALL_EVENT_TYPE.matches(r));let h=((e,t,i,s)=>!(i||s||e===n.EventType.RoomMessage||e===n.EventType.RoomMessageEncrypted||e===n.EventType.Sticker||e===n.EventType.RoomCreate||n.M_POLL_START.matches(e)||n.M_POLL_END.matches(e)||n.M_BEACON_INFO.matches(e)||e===Ut.Q6&&(null==t?void 0:t.state)===Ut.nE.Started))(r,o,d,m);const p=r===n.EventType.RoomMessage&&a===n.MsgType.Emote||n.M_POLL_START.matches(r)||n.M_BEACON_INFO.matches(r)||(0,Ot.Ar)(t)||r===Ut.Q6;return!s&&(0,At.eD)(t,e,i)||(c=(0,At.$Y)(t,e,i,!0),c===At.UG&&(d=!1,h=!0)),{hasRenderer:!!c,isInfoMessage:h,isBubbleMessage:d,isLeftAlignedBubbleMessage:m,noBubbleEvent:p,isSeeingThroughMessageHiddenForModeration:l}}var Bt=i("../matrix-react-sdk/src/components/views/messages/MFileBody.tsx"),Vt=i("../matrix-react-sdk/src/components/views/avatars/MemberAvatar.tsx"),jt=i("../matrix-react-sdk/src/components/views/messages/MVoiceMessageBody.tsx");function zt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Wt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?zt(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):zt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Ht extends o.PureComponent{constructor(...e){super(...e),(0,k.Z)(this,"anchorElement",(0,o.createRef)()),(0,k.Z)(this,"onDecrypted",(()=>{this.forceUpdate(),this.props.onHeightChanged&&this.props.onHeightChanged()})),(0,k.Z)(this,"onEventRequiresUpdate",(()=>{this.forceUpdate()})),(0,k.Z)(this,"onClick",(e=>{const t=e.target;"a"===t.tagName.toLowerCase()&&null!==t.closest("a")&&t!==this.anchorElement.current||(e.preventDefault(),this.props.toggleExpandedQuote&&e.shiftKey?this.props.toggleExpandedQuote():x.ZP.dispatch({action:W.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}))}))}componentDidMount(){this.props.mxEvent.on(n.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(n.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.on(n.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}componentWillUnmount(){this.props.mxEvent.removeListener(n.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(n.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.removeListener(n.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}render(){const e=this.props.mxEvent,t=e.getContent().msgtype,i=e.getType(),{hasRenderer:s,isInfoMessage:a,isSeeingThroughMessageHiddenForModeration:c}=Ft(E.p.safeGet(),e,!1);if(!s){const{mxEvent:e}=this.props;return r.k.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),o.createElement("div",{className:"mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"},(0,l._t)("timeline|error_no_renderer"))}const d=yt()("mx_ReplyTile",{mx_ReplyTile_inline:t===n.MsgType.Emote,mx_ReplyTile_info:a&&!e.isRedacted(),mx_ReplyTile_audio:t===n.MsgType.Audio,mx_ReplyTile_video:t===n.MsgType.Video});let m,h="#";this.props.permalinkCreator&&(h=this.props.permalinkCreator.forEvent(e.getId()));a||i===n.EventType.RoomCreate||(m=o.createElement("div",{className:"mx_ReplyTile_sender"},o.createElement(Vt.Z,{member:e.sender,fallbackUserId:e.getSender(),size:"16px"}),o.createElement(Nt,{mxEvent:e})));const p={[n.MsgType.Image]:Mt,[n.MsgType.Audio]:(0,Ot.CZ)(e)?jt.Z:Bt.ZP,[n.MsgType.Video]:Bt.ZP},u={[n.EventType.Sticker]:Mt};return o.createElement("div",{className:d},o.createElement("a",{href:h,onClick:this.onClick,ref:this.anchorElement},m,(0,At.M6)(Wt(Wt({},this.props),{},{ref:void 0,showUrlPreview:!1,overrideBodyTypes:p,overrideEventTypes:u,maxImageHeight:96,isSeeingThroughMessageHiddenForModeration:c,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),!1)))}}(0,k.Z)(Ht,"defaultProps",{onHeightChanged:()=>{}});var Gt=i("../matrix-react-sdk/src/components/views/elements/Pill.tsx"),Kt=i("../matrix-react-sdk/src/utils/Reply.ts"),qt=i("../matrix-react-sdk/src/contexts/RoomContext.ts");class $t extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"room",void 0),(0,k.Z)(this,"blockquoteRef",o.createRef()),(0,k.Z)(this,"canCollapse",(()=>this.state.events.length>1)),(0,k.Z)(this,"collapse",(()=>{this.initialize()})),(0,k.Z)(this,"onQuoteClick",(async()=>{if(!this.state.loadedEv)return;const e=[this.state.loadedEv,...this.state.events];let t=null;e.length>0&&(t=await this.getNextEvent(e[0])),this.setState({loadedEv:t,events:e}),x.ZP.fire(W.a.FocusSendMessageComposer)})),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.room=this.matrixClient.getRoom(this.props.parentEv.getRoomId())}get matrixClient(){return E.p.safeGet()}componentDidMount(){this.initialize(),this.trySetExpandableQuotes()}componentDidUpdate(){var e,t;null===(e=(t=this.props).onHeightChanged)||void 0===e||e.call(t),this.trySetExpandableQuotes()}componentWillUnmount(){this.unmounted=!0}trySetExpandableQuotes(){if(void 0===this.props.isQuoteExpanded&&this.blockquoteRef.current){const e=this.blockquoteRef.current.querySelector(".mx_EventTile_body");if(e){const t=e.querySelector("code"),i=!!t&&t.offsetHeight>=60;(e.offsetHeight>=60||i)&&this.props.setQuoteExpanded(!1)}}}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent((0,Kt.eR)(e));if(!this.unmounted)if(t){const e=await this.getNextEvent(t);this.setState({events:[t],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(e){try{const t=(0,Kt.eR)(e);return t?await this.getEvent(t):null}catch(e){return null}}async getEvent(e){var t;if(!e)return null;const i=this.room.findEventById(e);if(i)return i;try{await this.matrixClient.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch(e){return null}return null!==(t=this.room.findEventById(e))&&void 0!==t?t:null}getReplyChainColorClass(e){return(0,It.kG)(e.getSender()).replace("Username","ReplyChain")}render(){let e;if(this.state.err)e=o.createElement("blockquote",{className:"mx_ReplyChain mx_ReplyChain_error"},(0,l._t)("timeline|reply|error_loading"));else if(this.state.loadedEv&&(0,Kt._r)(this.state.events[0])){const t=this.state.loadedEv,i=this.matrixClient.getRoom(t.getRoomId());e=o.createElement("blockquote",{className:`mx_ReplyChain ${this.getReplyChainColorClass(t)}`},(0,l._t)("timeline|reply|in_reply_to",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",className:"mx_ReplyChain_show",onClick:this.onQuoteClick},e),pill:o.createElement(Gt.DR,{type:Gt.Rm.UserMention,room:null!=i?i:void 0,url:(0,Rt.KU)(t.getSender()),shouldShowPillAvatar:L.C.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.props.forExport){const t=(0,Kt.eR)(this.props.parentEv);e=o.createElement("p",{className:"mx_ReplyChain_Export"},(0,l._t)("timeline|reply|in_reply_to_for_export",{},{a:e=>o.createElement("a",{className:"mx_reply_anchor",href:`#${t}`,"data-scroll-to":t}," ",e," ")}))}else this.state.loading&&(e=o.createElement(re.Z,{w:16,h:16}));const{isQuoteExpanded:t}=this.props,i=this.state.events.map((e=>{const i=yt()({mx_ReplyChain:!0,[this.getReplyChainColorClass(e)]:!0,"mx_ReplyChain--expanded":!0===t,"mx_ReplyChain--collapsed":!1===t});return o.createElement("blockquote",{ref:this.blockquoteRef,className:i,key:e.getId()},o.createElement(Ht,{mxEvent:e,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,toggleExpandedQuote:()=>this.props.setQuoteExpanded(!this.props.isQuoteExpanded),getRelationsForEvent:this.props.getRelationsForEvent}))}));return o.createElement("div",{className:"mx_ReplyChain_wrapper"},o.createElement("div",null,e),o.createElement("div",null,i))}}(0,k.Z)($t,"contextType",qt.ZP);var Jt,Yt,Qt,Xt=i("../matrix-react-sdk/src/components/views/messages/DecryptionFailureBody.tsx"),ei=i("../matrix-react-sdk/src/components/views/avatars/RoomAvatar.tsx"),ti=i("../matrix-react-sdk/src/components/views/context_menus/MessageContextMenu.tsx"),ii=i("../matrix-react-sdk/src/components/structures/ContextMenu.tsx"),ni=i("../matrix-react-sdk/src/utils/objects.ts"),si=i("../matrix-react-sdk/src/components/views/elements/Tooltip.tsx"),oi=i("../matrix-react-sdk/src/stores/notifications/StaticNotificationState.ts"),ai=i("../matrix-react-sdk/src/components/views/rooms/NotificationBadge.tsx"),ri=i("../matrix-react-sdk/src/components/views/messages/MessageTimestamp.tsx");function li(){return li=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},li.apply(this,arguments)}function ci(e,t){return o.createElement("svg",li({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Jt||(Jt=o.createElement("circle",{cx:4.25,cy:9,r:1.25,fill:"currentColor"})),Yt||(Yt=o.createElement("circle",{cx:9,cy:9,r:1.25,fill:"currentColor"})),Qt||(Qt=o.createElement("circle",{cx:13.75,cy:9,r:1.25,fill:"currentColor"})))}var di=o.forwardRef(ci);var mi;function hi(){return hi=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},hi.apply(this,arguments)}function pi(e,t){return o.createElement("svg",hi({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),mi||(mi=o.createElement("path",{d:"M3 14h12M5 10.5l7-7",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}var ui=o.forwardRef(pi);var gi;function vi(){return vi=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},vi.apply(this,arguments)}function _i(e,t){return o.createElement("svg",vi({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),gi||(gi=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M20 1a1 1 0 00-1 1v2h-2a1 1 0 100 2h2v2a1 1 0 102 0V6h2a1 1 0 100-2h-2V2a1 1 0 00-1-1zM7 9.5C7 8.67 7.67 8 8.5 8s1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5zm8.5 1.5c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zM12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5zM4 12a8 8 0 019.774-7.803 1 1 0 10.442-1.95A10.03 10.03 0 0012 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10c0-.212-.007-.423-.02-.632a1 1 0 10-1.996.125A8 8 0 114 12z",fill:"currentColor"})))}var fi=o.forwardRef(_i);var Ei;function yi(){return yi=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},yi.apply(this,arguments)}function bi(e,t){return o.createElement("svg",yi({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",role:"presentation","aria-hidden":!0,ref:t},e),Ei||(Ei=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.523 2.964a6.418 6.418 0 0110.36 4.369h1.29c.26 0 .416.292.272.51l-2.006 3.011a.327.327 0 01-.544 0l-2.006-3.012a.327.327 0 01.272-.509h1.21a4.918 4.918 0 00-7.918-3.192 3.684 3.684 0 01-.184.136l-.014.01-.004.003-.002.001h-.001v.001l-.415-.625.414.625a.75.75 0 01-.83-1.25l.003-.001.02-.014a1.7 1.7 0 00.083-.063zm-.895 5.703H4.84a.327.327 0 00.272-.51L3.106 5.146a.327.327 0 00-.545 0L.555 8.157a.328.328 0 00.273.51h1.29a6.418 6.418 0 0010.503 4.251.75.75 0 00-.963-1.15 4.918 4.918 0 01-8.03-3.102z",clipRule:"evenodd"})))}var wi=o.forwardRef(bi);var Si,Ci;function ki(){return ki=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},ki.apply(this,arguments)}function xi(e,t){return o.createElement("svg",ki({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Si||(Si=o.createElement("path",{fill:"currentColor",d:"M5 5.25a.75.75 0 000 1.5h8a.75.75 0 000-1.5H5zm0 3a.75.75 0 000 1.5h4a.75.75 0 100-1.5H5z"})),Ci||(Ci=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 .25A2.75 2.75 0 00.25 3v14a.75.75 0 001.2.6L4.916 15c.217-.162.48-.25.75-.25H15A2.75 2.75 0 0017.75 12V3A2.75 2.75 0 0015 .25H3zM1.75 3c0-.69.56-1.25 1.25-1.25h12c.69 0 1.25.56 1.25 1.25v9c0 .69-.56 1.25-1.25 1.25H5.666a2.75 2.75 0 00-1.65.55L1.75 15.5V3z",clipRule:"evenodd"})))}var Ri=o.forwardRef(xi);var Ii;function Pi(){return Pi=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Pi.apply(this,arguments)}function Ti(e,t){return o.createElement("svg",Pi({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),Ii||(Ii=o.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z",fill:"currentColor"})))}var Zi=o.forwardRef(Ti);var Ni,Di;function Mi(){return Mi=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Mi.apply(this,arguments)}function Oi(e,t){return o.createElement("svg",Mi({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Ni||(Ni=o.createElement("path",{d:"M10.066 14.25h1.57c1.858 0 3.364-1.567 3.364-3.5s-1.506-3.5-3.364-3.5H4.534",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round"})),Di||(Di=o.createElement("path",{d:"M6.524 3.75L3 7.286l3.524 3.535",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}var Ai=o.forwardRef(Oi);var Li;function Ui(){return Ui=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Ui.apply(this,arguments)}function Fi(e,t){return o.createElement("svg",Ui({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),Li||(Li=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22 8.494a.753.753 0 011.062-.002l3.724 3.7L8.718 8.48a.753.753 0 011.062-.002.747.747 0 01.002 1.06L5.54 13.78a.753.753 0 01-1.063.002L.221 9.552a.747.747 0 01-.002-1.058zm9.562-2.988a.753.753 0 01-1.062.002l-3.724-3.7L1.283 5.52a.753.753 0 01-1.062.002.747.747 0 01-.002-1.06L4.462.22A.753.753 0 015.524.218l4.257 4.23a.747.747 0 01.001 1.058z",clipRule:"evenodd"})))}var Bi=o.forwardRef(Fi);var Vi;function ji(){return ji=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},ji.apply(this,arguments)}function zi(e,t){return o.createElement("svg",ji({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),Vi||(Vi=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22.234A.753.753 0 011.281.232l3.724 3.7L8.718.22A.753.753 0 019.781.218a.747.747 0 01.001 1.06L5.54 5.52a.753.753 0 01-1.063.002L.221 1.292A.747.747 0 01.219.235zm9.562 13.532a.753.753 0 01-1.062.002l-3.724-3.7-3.713 3.712a.753.753 0 01-1.062.002.747.747 0 01-.002-1.06L4.462 8.48a.753.753 0 011.062-.002l4.257 4.23a.747.747 0 01.001 1.058z",clipRule:"evenodd"})))}var Wi=o.forwardRef(zi);var Hi=i("../matrix-react-sdk/src/accessibility/Toolbar.tsx"),Gi=i("../matrix-react-sdk/src/accessibility/RovingTabIndex.tsx"),Ki=i("../matrix-react-sdk/src/Resend.ts"),qi=i("../matrix-react-sdk/src/utils/MediaEventHelper.ts"),$i=i("../matrix-react-sdk/res/img/download.svg"),Ji=i("../matrix-react-sdk/src/utils/FileDownloader.ts");class Yi extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"downloader",new Ji.V),(0,k.Z)(this,"onDownloadClick",(async()=>{const e=this.props.mediaEventHelperGet();if(this.state.loading||!e)return;if(e.media.isEncrypted&&this.setState({tooltip:(0,l.I8)("timeline|download_action_decrypting")}),this.setState({loading:!0}),this.state.blob)return this.doDownload(this.state.blob);const t=await e.sourceBlob.value;this.setState({blob:t}),await this.doDownload(t)})),this.state={loading:!1,tooltip:(0,l.I8)("timeline|download_action_downloading")}}async doDownload(e){await this.downloader.download({blob:e,name:this.props.mediaEventHelperGet().fileName}),this.setState({loading:!1})}render(){let e;this.state.loading&&(e=o.createElement(re.Z,{w:18,h:18}));const t=yt()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_downloadButton:!0,mx_MessageActionBar_downloadSpinnerButton:!!e});return o.createElement(Gi.yy,{className:t,title:e?(0,l._t)(this.state.tooltip):(0,l._t)("action|download"),onClick:this.onDownloadClick,disabled:!!e},o.createElement($i.J,null),e)}}var Qi=i("../matrix-react-sdk/src/components/views/emojipicker/ReactionPicker.tsx"),Xi=i("../matrix-react-sdk/src/components/views/right_panel/context.ts"),en=i("../matrix-react-sdk/src/Keyboard.ts"),tn=i("../matrix-react-sdk/src/accessibility/KeyboardShortcuts.ts"),nn=i("../matrix-react-sdk/src/voice-broadcast/types.ts");const sn=({mxEvent:e,getTile:t,getReplyChain:i,permalinkCreator:n,onFocusChange:s,getRelationsForEvent:a})=>{const[r,c,d,m]=(0,ii.av)(),[h,p]=(0,Gi.XZ)(c);(0,o.useEffect)((()=>{s(r)}),[s,r]);const u=(0,o.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),d(),h()}),[d,h]);let g;if(r&&c.current){const s=null==t?void 0:t(),r=i(),l=c.current.getBoundingClientRect();g=o.createElement(ti.Z,(0,kt.Z)({},(0,ii.LS)(l),{mxEvent:e,permalinkCreator:n,eventTileOps:s&&s.getEventTileOps?s.getEventTileOps():void 0,collapseReplyChain:null!=r&&r.canCollapse()?r.collapse:void 0,onFinished:m,getRelationsForEvent:a}))}return o.createElement(o.Fragment,null,o.createElement(ii.JY,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_optionsButton",title:(0,l._t)("common|options"),onClick:u,onContextMenu:u,isExpanded:r,inputRef:c,onFocus:h,tabIndex:p?0:-1},o.createElement(di,null)),g)},on=({mxEvent:e,reactions:t,onFocusChange:i})=>{const[n,s,a,r]=(0,ii.av)(),[c,d]=(0,Gi.XZ)(s);let m;if((0,o.useEffect)((()=>{i(n)}),[i,n]),n&&s.current){const i=s.current.getBoundingClientRect();m=o.createElement(ii.ZP,(0,kt.Z)({},(0,ii.LS)(i),{onFinished:r,managed:!1}),o.createElement(Qi.Z,{mxEvent:e,reactions:t,onFinished:r}))}const h=(0,o.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),a(),c()}),[a,c]);return o.createElement(o.Fragment,null,o.createElement(ii.JY,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|react"),onClick:h,onContextMenu:h,isExpanded:n,inputRef:s,onFocus:c,tabIndex:d?0:-1},o.createElement(fi,null)),m)},an=({mxEvent:e})=>{var t;const i=(0,o.useContext)(Xi.H),s=null==e||null===(t=e.getRelation())||void 0===t?void 0:t.rel_type,a=!!s&&s!==n.RelationType.Thread,r=t=>{t.preventDefault(),t.stopPropagation();const n=e.getThread();null!=n&&n.rootEvent&&!e.isThreadRoot?x.ec.dispatch({action:W.a.ShowThread,rootEvent:n.rootEvent,initialEvent:e,scroll_into_view:!0,highlighted:!0,push:i.isCard}):x.ec.dispatch({action:W.a.ShowThread,rootEvent:e,push:i.isCard})};return o.createElement(Gi.yy,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_threadButton",disabled:a,tooltip:o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_Tooltip_title"},a?(0,l._t)("threads|error_start_thread_existing_relation"):(0,l._t)("action|reply_in_thread"))),title:a?(0,l._t)("threads|error_start_thread_existing_relation"):(0,l._t)("action|reply_in_thread"),onClick:r,onContextMenu:r},o.createElement(Ri,null))};class rn extends o.PureComponent{constructor(...e){super(...e),(0,k.Z)(this,"onDecrypted",(()=>{this.forceUpdate()})),(0,k.Z)(this,"onBeforeRedaction",(()=>{this.forceUpdate()})),(0,k.Z)(this,"onSent",(()=>{this.forceUpdate()})),(0,k.Z)(this,"onFocusChange",(e=>{var t,i;null===(t=(i=this.props).onFocusChange)||void 0===t||t.call(i,e)})),(0,k.Z)(this,"onReplyClick",(e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType})})),(0,k.Z)(this,"onEditClick",(e=>{e.preventDefault(),e.stopPropagation(),(0,Ot.UB)(E.p.safeGet(),this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent)})),(0,k.Z)(this,"forbiddenThreadHeadMsgType",[n.MsgType.KeyVerificationRequest]),(0,k.Z)(this,"onResendClick",(e=>{e.preventDefault(),e.stopPropagation(),this.runActionOnFailedEv((e=>Ki.Z.resend(E.p.safeGet(),e)))})),(0,k.Z)(this,"onCancelClick",(e=>{this.runActionOnFailedEv((e=>Ki.Z.removeFromQueue(E.p.safeGet(),e)),(e=>(0,Ot.Be)(e.status)))}))}componentDidMount(){this.props.mxEvent.status&&this.props.mxEvent.status!==n.EventStatus.SENT&&this.props.mxEvent.on(n.MatrixEventEvent.Status,this.onSent);E.p.safeGet().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once(n.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(n.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction)}componentWillUnmount(){this.props.mxEvent.off(n.MatrixEventEvent.Status,this.onSent),this.props.mxEvent.off(n.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.off(n.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction)}get showReplyInThreadAction(){const e=this.context.timelineRenderingType!==qt.SB.Thread,t=!(this.forbiddenThreadHeadMsgType.includes(this.props.mxEvent.getContent().msgtype)||n.M_BEACON_INFO.matches(this.props.mxEvent.getType())||this.props.mxEvent.getType()===nn.Q6);return e&&t}runActionOnFailedEv(e,t){t||(t=()=>!0);const i=this.props.mxEvent,n=i.replacingEvent(),s=[i.localRedactionEvent(),n,i];for(const i of s)if(i&&t(i)){e(i);break}}render(){var e,t;const i=[];(0,Ot.pM)(E.p.safeGet(),this.props.mxEvent)&&i.push(o.createElement(Gi.yy,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|edit"),onClick:this.onEditClick,onContextMenu:this.onEditClick,key:"edit"},o.createElement(ui,null)));const s=o.createElement(Gi.yy,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|delete"),onClick:this.onCancelClick,onContextMenu:this.onCancelClick,key:"cancel"},o.createElement(Zi,null)),a=o.createElement(an,{mxEvent:this.props.mxEvent,key:"reply_thread"}),r=this.props.mxEvent,c=null===(e=r.replacingEvent())||void 0===e?void 0:e.status,d=null===(t=r.localRedactionEvent())||void 0===t?void 0:t.status,m=(0,Ot.Be)(r.status)||(0,Ot.Be)(c)||(0,Ot.Be)(d),h=[r.status,c,d].includes(n.EventStatus.NOT_SENT);if(m&&h)i.splice(0,0,o.createElement(Gi.yy,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|retry"),onClick:this.onResendClick,onContextMenu:this.onResendClick,key:"resend"},o.createElement(wi,null))),i.push(s);else{if((0,Ot.sJ)(this.props.mxEvent)?(this.context.canSendMessages&&(this.showReplyInThreadAction&&i.splice(0,0,a),i.splice(0,0,o.createElement(Gi.yy,{className:"mx_MessageActionBar_iconButton",title:(0,l._t)("action|reply"),onClick:this.onReplyClick,onContextMenu:this.onReplyClick,key:"reply"},o.createElement(Ai,null)))),this.context.canReact&&!this.context.search&&i.splice(0,0,o.createElement(on,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,key:"react"})),qi.A.isEligible(this.props.mxEvent)&&i.splice(0,0,o.createElement(Yi,{mxEvent:this.props.mxEvent,mediaEventHelperGet:()=>{var e,t;return null===(e=this.props.getTile())||void 0===e||null===(t=e.getMediaHelper)||void 0===t?void 0:t.call(e)},key:"download"}))):this.context.timelineRenderingType===qt.SB.Room&&this.props.mxEvent.getThread()&&i.unshift(a),m&&i.push(s),void 0!==this.props.isQuoteExpanded&&(0,Kt._r)(this.props.mxEvent)){const e=yt()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_expandCollapseMessageButton:!0}),t=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_Tooltip_title"},this.props.isQuoteExpanded?(0,l._t)("timeline|mab|collapse_reply_chain"):(0,l._t)("timeline|mab|expand_reply_chain")),o.createElement("div",{className:"mx_Tooltip_sub"},(0,l._t)(tn.nk[en.sr.SHIFT])+" + "+(0,l._t)("action|click")));i.push(o.createElement(Gi.yy,{className:e,title:this.props.isQuoteExpanded?(0,l._t)("timeline|mab|collapse_reply_chain"):(0,l._t)("timeline|mab|expand_reply_chain"),tooltip:t,onClick:this.props.toggleThreadExpanded,key:"expand"},this.props.isQuoteExpanded?o.createElement(Wi,null):o.createElement(Bi,null)))}i.push(o.createElement(sn,{mxEvent:this.props.mxEvent,getReplyChain:this.props.getReplyChain,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu",getRelationsForEvent:this.props.getRelationsForEvent}))}return o.createElement(Hi.Z,{className:"mx_MessageActionBar","aria-label":(0,l._t)("timeline|mab|label"),"aria-live":"off"},i)}}(0,k.Z)(rn,"contextType",qt.ZP);var ln=i("../matrix-react-sdk/node_modules/lodash/lodash.js"),cn=i("../matrix-js-sdk/src/NamespacedValue.ts"),dn=i("../matrix-react-sdk/src/accessibility/context_menu/ContextMenuTooltipButton.tsx"),mn=i("../matrix-react-sdk/src/customisations/Media.ts"),hn=i("../matrix-react-sdk/src/HtmlUtils.tsx"),pn=i("../matrix-react-sdk/src/contexts/MatrixClientContext.tsx");class un extends o.PureComponent{constructor(...e){super(...e),(0,k.Z)(this,"context",void 0)}render(){const{content:e,reactionEvents:t,mxEvent:i,visible:n}=this.props,s=this.context.getRoom(i.getRoomId());let a,r;if(s){const i=[];let n;for(const e of t){var c;const t=s.getMember(e.getSender()),o=null!==(c=null==t?void 0:t.name)&&void 0!==c?c:e.getSender();i.push(o),n=this.props.customReactionImagesEnabled&&vn.findIn(e.getContent())||void 0}const r=(0,hn.w3)(e)||n;a=o.createElement("div",null,(0,l._t)("timeline|reactions|tooltip",{shortName:r},{reactors:()=>o.createElement("div",{className:"mx_Tooltip_title"},(0,It.If)(i,6)),reactedWith:e=>r?o.createElement("div",{className:"mx_Tooltip_sub"},e):null}))}return a&&(r=o.createElement(si.Z,{visible:n,label:a})),r}}(0,k.Z)(un,"contextType",pn.ZP);class gn extends o.PureComponent{constructor(...e){super(...e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"state",{tooltipRendered:!1,tooltipVisible:!1}),(0,k.Z)(this,"onClick",(()=>{const{mxEvent:e,myReactionEvent:t,content:i}=this.props;t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:e.getId(),key:i}}),x.ZP.dispatch({action:"message_sent"}))})),(0,k.Z)(this,"onMouseOver",(()=>{this.setState({tooltipRendered:!0,tooltipVisible:!0})})),(0,k.Z)(this,"onMouseLeave",(()=>{this.setState({tooltipVisible:!1})}))}render(){const{mxEvent:e,content:t,count:i,reactionEvents:n,myReactionEvent:s}=this.props,a=yt()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!s});let r;this.state.tooltipRendered&&(r=o.createElement(un,{mxEvent:this.props.mxEvent,content:t,reactionEvents:n,visible:this.state.tooltipVisible,customReactionImagesEnabled:this.props.customReactionImagesEnabled}));const c=this.context.getRoom(e.getRoomId());let d,m;if(c){const e=[];for(const t of n){const i=c.getMember(t.getSender());e.push((null==i?void 0:i.name)||t.getSender()),m=this.props.customReactionImagesEnabled&&vn.findIn(t.getContent())||void 0}const i=(0,It.If)(e,6);d=t?(0,l._t)("timeline|reactions|label",{reactors:i,content:m||t}):i}let h=o.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t);if(this.props.customReactionImagesEnabled&&t.startsWith("mxc://")){const e=(0,mn.TS)(t).srcHttp;e&&(h=o.createElement("img",{className:"mx_ReactionsRowButton_content",alt:m||(0,l._t)("timeline|reactions|custom_reaction_fallback_label"),src:e,width:"16",height:"16"}))}return o.createElement(ae.Z,{className:a,"aria-label":d,onClick:this.onClick,disabled:this.props.disabled,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},h,o.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},i),r)}}(0,k.Z)(gn,"contextType",pn.ZP);const vn=new cn.IY("shortcode","com.beeper.reaction.shortcode"),_n=({mxEvent:e,reactions:t})=>{const[i,n,s,a]=(0,ii.av)();let r;if(i&&n.current){const i=n.current.getBoundingClientRect();r=o.createElement(ii.ZP,(0,kt.Z)({},(0,ii.LS)(i),{onFinished:a,managed:!1}),o.createElement(Qi.Z,{mxEvent:e,reactions:t,onFinished:a}))}return o.createElement(o.Fragment,null,o.createElement(dn.J,{className:yt()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:i}),title:(0,l._t)("timeline|reactions|add_reaction_prompt"),onClick:s,onContextMenu:e=>{e.preventDefault(),s()},isExpanded:i,inputRef:n}),r)};class fn extends o.PureComponent{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"onDecrypted",(()=>{this.forceUpdate()})),(0,k.Z)(this,"onReactionsChange",(()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()})),(0,k.Z)(this,"onShowAllClick",(()=>{this.setState({showAll:!0})})),this.context=t,this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once(n.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.on(n.RelationsEvent.Add,this.onReactionsChange),t.on(n.RelationsEvent.Remove,this.onReactionsChange),t.on(n.RelationsEvent.Redaction,this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off(n.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.off(n.RelationsEvent.Add,this.onReactionsChange),t.off(n.RelationsEvent.Remove,this.onReactionsChange),t.off(n.RelationsEvent.Redaction,this.onReactionsChange))}componentDidUpdate(e){this.props.reactions&&e.reactions!==this.props.reactions&&(this.props.reactions.on(n.RelationsEvent.Add,this.onReactionsChange),this.props.reactions.on(n.RelationsEvent.Remove,this.onReactionsChange),this.props.reactions.on(n.RelationsEvent.Redaction,this.onReactionsChange),this.onReactionsChange())}getMyReactions(){var e,t;const i=this.props.reactions;if(!i)return null;const n=null===(e=this.context.room)||void 0===e?void 0:e.client.getUserId();if(!n)return null;const s=null===(t=i.getAnnotationsBySender())||void 0===t?void 0:t[n];return s?[...s.values()]:null}render(){var e,t;const{mxEvent:i,reactions:n}=this.props,{myReactions:s,showAll:a}=this.state;if(!n||!(0,Ot.sJ)(i))return null;const r=L.C.getValue("feature_render_reaction_images");let c,d,m=null===(e=n.getSortedAnnotationsByKey())||void 0===e?void 0:e.map((([e,t])=>{if(!t.size)return null;const n=(0,ln.uniqBy)([...t],(e=>e.getSender())),a=null==s?void 0:s.find((t=>{var i;return!t.isRedacted()&&(null===(i=t.getRelation())||void 0===i?void 0:i.key)===e}));return o.createElement(gn,{key:e,content:e,count:n.length,mxEvent:i,reactionEvents:n,myReactionEvent:a,customReactionImagesEnabled:r,disabled:!this.context.canReact||a&&!a.isRedacted()&&!this.context.canSelfRedact})})).filter((e=>!!e));return null!==(t=m)&&void 0!==t&&t.length?(m.length>9&&!a&&(m=m.slice(0,8),c=o.createElement(ae.Z,{kind:"link_inline",className:"mx_ReactionsRow_showAll",onClick:this.onShowAllClick},(0,l._t)("action|show_all"))),this.context.canReact&&(d=o.createElement(_n,{mxEvent:i,reactions:n})),o.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":(0,l._t)("common|reactions")},m,c,d)):null}}(0,k.Z)(fn,"contextType",qt.ZP);var En,yn=i("../matrix-react-sdk/src/stores/room-list/MessagePreviewStore.ts"),bn=i("../matrix-react-sdk/src/utils/strings.ts");class wn{constructor(e,t){this.failedEventId=e,this.errorCode=t,(0,k.Z)(this,"ts",void 0),this.ts=Date.now()}}class Sn{constructor(e,t){if(this.fn=e,this.errorCodeMapFn=t,(0,k.Z)(this,"failures",new Map),(0,k.Z)(this,"visibleEvents",new Set),(0,k.Z)(this,"visibleFailures",new Map),(0,k.Z)(this,"failureCounts",{}),(0,k.Z)(this,"trackedEvents",new Set),(0,k.Z)(this,"checkInterval",null),(0,k.Z)(this,"trackInterval",null),!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if("function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}static get instance(){return Sn.internalInstance}eventDecrypted(e,t){"m.megolm.v1.aes-sha2"==e.getWireContent().algorithm&&(t?this.addDecryptionFailure(new wn(e.getId(),t.code)):this.removeDecryptionFailuresForEvent(e))}addVisibleEvent(e){const t=e.getId();this.trackedEvents.has(t)||(this.visibleEvents.add(t),this.failures.has(t)&&!this.visibleFailures.has(t)&&this.visibleFailures.set(t,this.failures.get(t)))}addDecryptionFailure(e){const t=e.failedEventId;this.trackedEvents.has(t)||(this.failures.set(t,e),this.visibleEvents.has(t)&&!this.visibleFailures.has(t)&&this.visibleFailures.set(t,e))}removeDecryptionFailuresForEvent(e){const t=e.getId();this.failures.delete(t),this.visibleFailures.delete(t)}start(){this.checkInterval=window.setInterval((()=>this.checkFailures(Date.now())),Sn.CHECK_INTERVAL_MS),this.trackInterval=window.setInterval((()=>this.trackFailures()),Sn.TRACK_INTERVAL_MS)}stop(){this.checkInterval&&clearInterval(this.checkInterval),this.trackInterval&&clearInterval(this.trackInterval),this.failures=new Map,this.visibleEvents=new Set,this.visibleFailures=new Map,this.failureCounts={}}checkFailures(e){const t=new Set,i=new Map;for(const[n,s]of this.visibleFailures)e>s.ts+Sn.GRACE_PERIOD_MS?(t.add(s),this.trackedEvents.add(n)):i.set(n,s);this.visibleFailures=i,this.aggregateFailures(t)}aggregateFailures(e){for(const t of e){const e=t.errorCode;this.failureCounts[e]=(this.failureCounts[e]||0)+1}}trackFailures(){for(const e of Object.keys(this.failureCounts))if(this.failureCounts[e]>0){const t=this.errorCodeMapFn(e);this.fn(this.failureCounts[e],t,e),this.failureCounts[e]=0}}}En=Sn,(0,k.Z)(Sn,"internalInstance",new En(((e,t,i)=>{for(let n=0;n<e;n++)rt.S.instance.trackEvent({eventName:"Error",domain:"E2EE",name:t,context:`mxc_crypto_error_type_${i}`})}),(e=>{switch(e){case"MEGOLM_UNKNOWN_INBOUND_SESSION_ID":return"OlmKeysNotSentError";case"OLM_UNKNOWN_MESSAGE_INDEX":return"OlmIndexError";case void 0:return"OlmUnspecifiedError";default:return"UnknownError"}}))),(0,k.Z)(Sn,"TRACK_INTERVAL_MS",6e4),(0,k.Z)(Sn,"CHECK_INTERVAL_MS",5e3),(0,k.Z)(Sn,"GRACE_PERIOD_MS",4e3);var Cn=i("../matrix-react-sdk/src/components/views/messages/RedactedBody.tsx"),kn=i("../matrix-react-sdk/src/PosthogTrackers.ts"),xn=i("../matrix-react-sdk/src/components/structures/ViewSource.tsx");class Rn extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onBugReport",(()=>{T.ZP.createDialog(ut.Z,{label:"react-soft-crash-tile",error:this.state.error})})),(0,k.Z)(this,"onViewSource",(()=>{T.ZP.createDialog(xn.Z,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")})),this.state={}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let i,n;return c.ZP.get().bug_report_endpoint_url&&(i=o.createElement(o.Fragment,null,"Â ",o.createElement(ae.Z,{kind:"link",onClick:this.onBugReport},(0,l._t)("bug_reporting|submit_debug_logs")))),e&&L.C.getValue("developerMode")&&(n=o.createElement(o.Fragment,null,"Â ",o.createElement(ae.Z,{onClick:this.onViewSource,kind:"link"},(0,l._t)("action|view_source")))),o.createElement("li",{className:yt()(t),"data-layout":this.props.layout},o.createElement("div",{className:"mx_EventTile_line"},o.createElement("span",null,(0,l._t)("timeline|error_rendering_message"),e&&` (${e.getType()})`,i,n)))}return this.props.children}}var In=i("../matrix-react-sdk/src/hooks/useEventEmitter.ts"),Pn=i("../matrix-react-sdk/src/hooks/useAsyncMemo.ts");const Tn=["mxEvent","thread"],Zn=({thread:e,showDisplayname:t=!1})=>{var i,s,a;const r=(0,o.useContext)(pn.ZP),c=null!==(i=(0,In.A_)(e,n.ThreadEvent.Update,(()=>e.replyToEvent)))&&void 0!==i?i:void 0,[d,m]=(0,o.useState)(null==c?void 0:c.getContent());(0,In.V4)(c,n.MatrixEventEvent.Replaced,(()=>{m(c.getContent())}));const h=(null==c?void 0:c.shouldAttemptDecryption())||(null==c?void 0:c.isBeingDecrypted());(0,In.V4)(h?c:void 0,n.MatrixEventEvent.Decrypted,(()=>{m(c.getContent())}));const p=(0,Pn.G)((async()=>{if(c)return await r.decryptEventIfNeeded(c),yn.z.instance.generatePreviewForEvent(c)}),[c,d]);return p&&c?o.createElement(o.Fragment,null,o.createElement(Vt.Z,{member:c.sender,fallbackUserId:c.getSender(),size:"24px",className:"mx_ThreadSummary_avatar"}),t&&o.createElement("div",{className:"mx_ThreadSummary_sender"},null!==(s=null===(a=c.sender)||void 0===a?void 0:a.name)&&void 0!==s?s:c.getSender()),c.isDecryptionFailure()?o.createElement("div",{className:"mx_ThreadSummary_content mx_DecryptionFailureBody",title:(0,l._t)("threads|unable_to_decrypt")},o.createElement("span",{className:"mx_ThreadSummary_message-preview"},(0,l._t)("threads|unable_to_decrypt"))):o.createElement("div",{className:"mx_ThreadSummary_content",title:p},o.createElement("span",{className:"mx_ThreadSummary_message-preview"},p))):null},Nn=e=>{let{mxEvent:t,thread:i}=e,s=(0,v.Z)(e,Tn);const a=(0,o.useContext)(qt.ZP),r=(0,o.useContext)(Xi.H),c=(0,In.A_)(i,n.ThreadEvent.Update,(()=>i.length));if(!c)return null;let d=c;return a.narrow||(d=(0,l._t)("threads|count_of_reply",{count:c})),o.createElement(ae.Z,(0,kt.Z)({},s,{className:"mx_ThreadSummary",onClick:e=>{x.ZP.dispatch({action:W.a.ShowThread,rootEvent:t,push:r.isCard}),kn.Z.trackInteraction("WebRoomTimelineThreadSummaryButton",e)},"aria-label":(0,l._t)("threads|open_thread")}),o.createElement("span",{className:"mx_ThreadSummary_replies_amount"},d),o.createElement(Zn,{thread:i,showDisplayname:!a.narrow}),o.createElement("div",{className:"mx_ThreadSummary_chevron"}))};var Dn=i("./node_modules/react-dom/index.js");class Mn extends o.Component{constructor(e){super(e),(0,k.Z)(this,"nodes",{}),(0,k.Z)(this,"children",{}),this.updateChildren(this.props.children)}componentDidUpdate(){this.updateChildren(this.props.children)}applyStyles(e,t){Object.entries(t).forEach((([t,i])=>{e.style[t]=i}))}updateChildren(e){const t=this.children||{};this.children={},o.Children.toArray(e).forEach((e=>{if(function(e){return"object"==typeof e&&"type"in e}(e))if(t[e.key]){const i=t[e.key],n=Dn.findDOMNode(this.nodes[i.key]);n&&n.style.left!==e.props.style.left&&this.applyStyles(n,{left:e.props.style.left}),this.children[e.key]=o.cloneElement(i,e.props,e.props.children)}else{const t={},i=e.props.style,n=this.props.startStyles;if(n.length>0){const e=n[0];t.style=e}t.ref=t=>this.collectNode(e.key,t,i),this.children[e.key]=o.cloneElement(e,t)}}))}collectNode(e,t,i){if(t&&void 0===this.nodes[e]&&this.props.startStyles.length>0){const e=this.props.startStyles,n=Dn.findDOMNode(t);for(let t=1;t<e.length;++t)this.applyStyles(n,e[t]);window.setTimeout((()=>{this.applyStyles(n,i)}),0)}this.nodes[e]=t}render(){return o.createElement(o.Fragment,null,Object.values(this.children))}}(0,k.Z)(Mn,"defaultProps",{startStyles:[]});var On=i("../matrix-react-sdk/src/utils/units.ts");class An extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"avatar",(0,o.createRef)()),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptInfo;e&&(this.props.checkUnmounting&&this.props.checkUnmounting()||this.buildReadReceiptInfo(e))}componentDidMount(){this.state.suppressDisplay&&this.animateMarker()}componentDidUpdate(e){const t=e.offset!==this.props.offset,i=e.hidden!==this.props.hidden;(t||i)&&this.animateMarker()}buildReadReceiptInfo(e={}){const t=this.avatar.current,i=null==t?void 0:t.offsetParent;if(!(i&&i instanceof HTMLElement))return r.k.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid horizontalContainer`),e.top=0,e.right=0,e.parent=void 0,e;const n=i.offsetParent;return n&&n instanceof HTMLElement?(e.top=t.offsetTop,e.right=t.getBoundingClientRect().right-i.getBoundingClientRect().right,e.parent=n,e):(r.k.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid verticalContainer`),e.top=0,e.right=0,e.parent=void 0,e)}readReceiptPosition(e){var t;return e.parent?(null!==(t=e.top)&&void 0!==t?t:0)+e.parent.getBoundingClientRect().top:(r.k.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no offsetParent`),0)}animateMarker(){const e=this.props.readReceiptInfo,t=this.buildReadReceiptInfo(),i=this.readReceiptPosition(t),n=e?this.readReceiptPosition(e):-Fn,s=[];null!=e&&e.right&&s.push({top:n-i,right:e.right}),s.push({top:n-i,right:0}),this.setState({suppressDisplay:!1,startStyles:s})}render(){var e;if(this.state.suppressDisplay)return o.createElement("div",{ref:this.avatar});const t={right:(0,On.a)(this.props.offset),top:"0px"};return o.createElement(Mn,{startStyles:this.state.startStyles},o.createElement(Vt.K,{member:null!==(e=this.props.member)&&void 0!==e?e:null,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true","aria-live":"off",size:"14px",style:t,inputRef:this.avatar,hideTitle:!0,tabIndex:-1}))}}var Ln=i("../matrix-react-sdk/src/components/structures/AutoHideScrollbar.tsx");function Un(e){const[t,i]=(0,o.useState)(!1);return[{showTooltip:()=>i(!0),hideTooltip:()=>i(!1)},o.createElement(si.Z,(0,kt.Z)({},e,{visible:t}))]}const Fn=16;function Bn({readReceipts:e,readReceiptMap:t,checkUnmounting:i,suppressAnimation:n,isTwelveHour:s}){const[a,r,c,d]=(0,ii.av)(),m=e.length>4?3:4,h=function(e,t){return(0,It.If)(e,t)}(e.map((e=>{var t,i;return null!==(t=null===(i=e.roomMember)||void 0===i?void 0:i.name)&&void 0!==t?t:e.userId})),m),[{showTooltip:p,hideTooltip:u},g]=Un({label:o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_Tooltip_title"},(0,l._t)("timeline|read_receipt_title",{count:e.length})),o.createElement("div",{className:"mx_Tooltip_sub"},h)),alignment:si.v.TopRight});if(0===e.length)return o.createElement("div",{className:"mx_EventTile_msgOption"},o.createElement("div",{className:"mx_ReadReceiptGroup"},o.createElement("div",{className:"mx_ReadReceiptGroup_button"},o.createElement("span",{className:"mx_ReadReceiptGroup_container"}))));const v=e.map(((e,a)=>{const{hidden:r,position:l}=function(e,t){return e<t?{hidden:!1,position:e}:{hidden:!0,position:0}}(a,m),c=e.userId;let d;return t&&(d=t[c],d||(d={},t[c]=d)),o.createElement(An,{key:c,member:e.roomMember,fallbackUserId:c,offset:10*l,hidden:r,readReceiptInfo:d,checkUnmounting:i,suppressAnimation:n,timestamp:e.ts,showTwelveHour:s})})).reverse();let _;const f=e.length-m;let E;if(f>0&&(_=o.createElement("span",{className:"mx_ReadReceiptGroup_remainder","aria-live":"off"},"+",f)),a&&r.current){const t=r.current.getBoundingClientRect();E=o.createElement(ii.ZP,(0,kt.Z)({menuClassName:"mx_ReadReceiptGroup_popup",onFinished:d},(0,ii.LS)(t)),o.createElement(Ln.Z,null,o.createElement(jn,{className:"mx_ReadReceiptGroup_title"},(0,l._t)("timeline|read_receipt_title",{count:e.length})),e.map((e=>o.createElement(Vn,(0,kt.Z)({key:e.userId},e,{isTwelveHour:s,onAfterClick:d}))))))}return o.createElement("div",{className:"mx_EventTile_msgOption"},o.createElement("div",{className:"mx_ReadReceiptGroup",role:"group","aria-label":(0,l._t)("timeline|read_receipts_label")},o.createElement(ae.Z,{className:"mx_ReadReceiptGroup_button",inputRef:r,"aria-label":h,"aria-haspopup":"true",onClick:c,onMouseOver:p,onMouseLeave:u,onFocus:p,onBlur:u},_,o.createElement("span",{className:"mx_ReadReceiptGroup_container",style:{width:10*Math.min(m,e.length)+Fn-10}},v)),g,E))}function Vn({userId:e,roomMember:t,ts:i,isTwelveHour:n,onAfterClick:s}){var a,r;const[{showTooltip:l,hideTooltip:c},d]=Un({alignment:si.v.Top,tooltipClassName:"mx_ReadReceiptGroup_person--tooltip",label:o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_Tooltip_title"},null!==(a=null==t?void 0:t.rawDisplayName)&&void 0!==a?a:e),o.createElement("div",{className:"mx_Tooltip_sub"},e))});return o.createElement(ii.sN,{className:"mx_ReadReceiptGroup_person",onClick:()=>{x.ZP.dispatch({action:W.a.ViewUser,member:null!=t?t:{userId:e},push:!1}),null==s||s()},onMouseOver:l,onMouseLeave:c,onFocus:l,onBlur:c,onWheel:c},o.createElement(Vt.Z,{member:t,fallbackUserId:e,size:"24px","aria-hidden":"true","aria-live":"off",resizeMethod:"crop",hideTitle:!0}),o.createElement("div",{className:"mx_ReadReceiptGroup_name"},o.createElement("p",null,null!==(r=null==t?void 0:t.name)&&void 0!==r?r:e),o.createElement("p",{className:"mx_ReadReceiptGroup_secondary"},(0,Oe.p6)(new Date(i),n))),d)}function jn({className:e,children:t}){const i=(0,o.useRef)(null),[n]=(0,Gi.XZ)(i);return o.createElement("h3",{className:e,role:"menuitem",onFocus:n,tabIndex:-1,ref:i},t)}var zn,Wn=i("../matrix-react-sdk/src/utils/localRoom/isLocalRoom.ts"),Hn=i("../matrix-react-sdk/src/hooks/useUnreadNotifications.ts"),Gn=i("../matrix-react-sdk/src/components/views/rooms/NotificationBadge/StatelessNotificationBadge.tsx");function Kn({room:e,threadId:t}){const{symbol:i,count:n,color:s}=(0,Hn.C)(e,t);return o.createElement(Gn.N,{symbol:i,count:n,color:s})}function qn(){return qn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},qn.apply(this,arguments)}function $n(e,t){return o.createElement("svg",qn({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),zn||(zn=o.createElement("path",{d:"M12.528 6.54l.5-.498c1.377-1.378 3.598-1.391 4.96-.03 1.361 1.362 1.348 3.583-.03 4.96l-2.37 2.37c-1.378 1.378-3.599 1.391-4.96.03m.844 4.087l-.5.499c-1.377 1.378-3.598 1.391-4.96.03-1.361-1.362-1.348-3.583.03-4.96l2.37-2.37c1.378-1.378 3.599-1.391 4.96-.03",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round"})))}var Jn=o.forwardRef($n);var Yn;function Qn(){return Qn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Qn.apply(this,arguments)}function Xn(e,t){return o.createElement("svg",Qn({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),Yn||(Yn=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M1 2.75A.75.75 0 011.75 2h.005a.75.75 0 010 1.5H1.75A.75.75 0 011 2.75zm2.495 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.005a.75.75 0 010 1.5h-.005a.75.75 0 01-.75-.75zM1 6.75A.75.75 0 011.75 6h8.5a.75.75 0 010 1.5h-8.5A.75.75 0 011 6.75zm0 3A.75.75 0 011.75 9h4.5a.75.75 0 010 1.5h-4.5A.75.75 0 011 9.75zm0 4a.75.75 0 01.75-.75h.005a.75.75 0 010 1.5H1.75a.75.75 0 01-.75-.75zm2.495 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.005a.75.75 0 010 1.5h-.005a.75.75 0 01-.75-.75z",clipRule:"evenodd"})))}var es=o.forwardRef(Xn);function ts({viewInRoom:e,copyLinkToThread:t}){return o.createElement(Hi.Z,{className:"mx_MessageActionBar","aria-label":(0,l._t)("timeline|mab|label"),"aria-live":"off"},o.createElement(Gi.yy,{className:"mx_MessageActionBar_iconButton",onClick:e,title:(0,l._t)("timeline|mab|view_in_room"),key:"view_in_room"},o.createElement(es,null)),o.createElement(Gi.yy,{className:"mx_MessageActionBar_iconButton",onClick:t,title:(0,l._t)("timeline|mab|copy_link_thread"),key:"copy_link_to_thread"},o.createElement(Jn,null)))}function is(e){return e.getUnsigned()["io.element.late_event"]}function ns(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ss(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ns(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ns(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function os(e){return!(!(0,At._6)(e)&&e.getType()!==n.EventType.RoomMessageEncrypted)}class as extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"suppressReadReceiptAnimation",void 0),(0,k.Z)(this,"isListeningForReceipts",void 0),(0,k.Z)(this,"tile",(0,o.createRef)()),(0,k.Z)(this,"replyChain",(0,o.createRef)()),(0,k.Z)(this,"ref",(0,o.createRef)()),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"updateThread",(e=>{this.setState({thread:e})})),(0,k.Z)(this,"onNewThread",(e=>{if(e.id===this.props.mxEvent.getId()){this.updateThread(e);const t=E.p.safeGet().getRoom(this.props.mxEvent.getRoomId());null==t||t.off(n.ThreadEvent.New,this.onNewThread)}})),(0,k.Z)(this,"viewInRoom",(e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:W.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0})})),(0,k.Z)(this,"copyLinkToThread",(async e=>{e.preventDefault(),e.stopPropagation();const{permalinkCreator:t,mxEvent:i}=this.props;if(!t)return;const n=t.forEvent(i.getId());await(0,bn.RO)(n)})),(0,k.Z)(this,"onRoomReceipt",((e,t)=>{t===E.p.safeGet().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate((()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(E.p.safeGet().removeListener(n.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!1)}))})),(0,k.Z)(this,"onDecrypted",(()=>{this.verifyEvent(),this.forceUpdate(this.props.onHeightChanged)})),(0,k.Z)(this,"onDeviceVerificationChanged",((e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent()})),(0,k.Z)(this,"onUserVerificationChanged",((e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent()})),(0,k.Z)(this,"onReplaced",(()=>{this.verifyEvent()})),(0,k.Z)(this,"onSenderProfileClick",(()=>{x.ZP.dispatch({action:W.a.ComposerInsert,userId:this.props.mxEvent.getSender(),timelineRenderingType:this.context.timelineRenderingType})})),(0,k.Z)(this,"onPermalinkClicked",(e=>{e.preventDefault(),x.ZP.dispatch({action:W.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:this.context.timelineRenderingType===qt.SB.Search?"MessageSearch":void 0})})),(0,k.Z)(this,"onActionBarFocusChange",(e=>{this.setState({actionBarFocused:e})})),(0,k.Z)(this,"getTile",(()=>this.tile.current)),(0,k.Z)(this,"getReplyChain",(()=>this.replyChain.current)),(0,k.Z)(this,"getReactions",(()=>{var e;if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const t=this.props.mxEvent.getId();return null!==(e=this.props.getRelationsForEvent(t,"m.annotation","m.reaction"))&&void 0!==e?e:null})),(0,k.Z)(this,"onReactionsCreated",((e,t)=>{"m.annotation"===e&&"m.reaction"===t&&this.setState({reactions:this.getReactions()})})),(0,k.Z)(this,"onContextMenu",(e=>{this.showContextMenu(e)})),(0,k.Z)(this,"onTimestampContextMenu",(e=>{var t;this.showContextMenu(e,null===(t=this.props.permalinkCreator)||void 0===t?void 0:t.forEvent(this.props.mxEvent.getId()))})),(0,k.Z)(this,"onCloseMenu",(()=>{this.setState({contextMenu:void 0,actionBarFocused:!1})})),(0,k.Z)(this,"setQuoteExpanded",(e=>{this.setState({isQuoteExpanded:e})}));const i=this.thread;this.state={actionBarFocused:!1,shieldColour:X.EventShieldColour.NONE,shieldReason:null,reactions:this.getReactions(),hover:!1,thread:i},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!E.p.safeGet().getRoom(this.props.mxEvent.getRoomId()))return!1;const e=E.p.safeGet().getSafeUserId();return this.props.mxEvent.getSender()===e&&os(this.props.mxEvent)}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&this.props.eventSendStatus!==n.EventStatus.SENT)return!1;const e=this.props.readReceipts||[],t=E.p.safeGet().getUserId();return!e.some((e=>e.userId!==t))}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||this.props.eventSendStatus===n.EventStatus.SENT)}componentDidMount(){this.suppressReadReceiptAnimation=!1;const e=E.p.safeGet();this.props.forExport||(e.on(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged),e.on(j.qG.UserTrustStatusChanged,this.onUserVerificationChanged),this.props.mxEvent.on(n.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(n.MatrixEventEvent.Replaced,this.onReplaced),Sn.instance.addVisibleEvent(this.props.mxEvent),this.props.showReactions&&this.props.mxEvent.on(n.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on(n.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0)),this.props.mxEvent.on(n.ThreadEvent.Update,this.updateThread),e.decryptEventIfNeeded(this.props.mxEvent);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.on(n.ThreadEvent.New,this.onNewThread),this.verifyEvent()}shouldComponentUpdate(e,t){return!!(0,ni.U0)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=E.p.get();if(e){e.removeListener(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged),e.removeListener(j.qG.UserTrustStatusChanged,this.onUserVerificationChanged),e.removeListener(n.RoomEvent.Receipt,this.onRoomReceipt);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.off(n.ThreadEvent.New,this.onNewThread)}this.isListeningForReceipts=!1,this.props.mxEvent.removeListener(n.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(n.MatrixEventEvent.Replaced,this.onReplaced),this.props.showReactions&&this.props.mxEvent.removeListener(n.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),this.props.mxEvent.off(n.ThreadEvent.Update,this.updateThread),this.unmounted=!1}componentDidUpdate(e,t){t.shieldColour!==this.state.shieldColour&&this.props.onHeightChanged&&this.props.onHeightChanged(),this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(E.p.safeGet().on(n.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0),e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent()}get thread(){var e;let t=this.props.mxEvent.getThread();if(!t){var i;const e=E.p.safeGet().getRoom(this.props.mxEvent.getRoomId());t=null!==(i=null==e?void 0:e.findThreadForEvent(this.props.mxEvent))&&void 0!==i?i:void 0}return null!==(e=t)&&void 0!==e?e:null}renderThreadPanelSummary(){return this.state.thread?o.createElement("div",{className:"mx_ThreadPanel_replies"},o.createElement("span",{className:"mx_ThreadPanel_replies_amount"},this.state.thread.length),o.createElement(Zn,{thread:this.state.thread})):null}renderThreadInfo(){return this.state.thread&&this.state.thread.id===this.props.mxEvent.getId()?o.createElement(Nn,{mxEvent:this.props.mxEvent,thread:this.state.thread,"data-testid":"thread-summary"}):this.context.timelineRenderingType===qt.SB.Search&&this.props.mxEvent.threadRootId?this.props.highlightLink?o.createElement("a",{className:"mx_ThreadSummary_icon",href:this.props.highlightLink},(0,l._t)("timeline|thread_info_basic")):o.createElement("p",{className:"mx_ThreadSummary_icon"},(0,l._t)("timeline|thread_info_basic")):void 0}verifyEvent(){this.doVerifyEvent().catch((e=>{const t=this.props.mxEvent;r.k.error(`Error getting encryption info on event ${t.getId()} in room ${t.getRoomId()}`,e)}))}async doVerifyEvent(){var e,t,i;const n=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if(!n.isEncrypted()||n.isRedacted())return void this.setState({shieldColour:X.EventShieldColour.NONE,shieldReason:null});const s=null!==(t=await(null===(i=E.p.safeGet().getCrypto())||void 0===i?void 0:i.getEncryptionInfoForEvent(n)))&&void 0!==t?t:null;this.unmounted||(null!==s?this.setState({shieldColour:s.shieldColour,shieldReason:s.shieldReason}):this.setState({shieldColour:X.EventShieldColour.NONE,shieldReason:null}))}propsEqual(e,t){const i=Object.keys(e),n=Object.keys(t);if(i.length!==n.length)return!1;for(let n=0;n<i.length;n++){const s=i[n];if(!t.hasOwnProperty(s))return!1;if("readReceipts"===s){const i=e[s],n=t[s];if(i===n)continue;if(!i||!n)return!1;if(i.length!==n.length)return!1;for(let e=0;e<i.length;e++){if(i[e].userId!==n[e].userId)return!1;if(i[e].roomMember!==n[e].roomMember)return!1}}else if(e[s]!==t[s])return!1}return!0}shouldHighlight(){if(this.props.forExport)return!1;if(this.context.timelineRenderingType===qt.SB.Notification)return!1;if(this.context.timelineRenderingType===qt.SB.ThreadsList)return!1;const e=E.p.safeGet(),t=e.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent),i=this.props.mxEvent.replacingEvent()?e.getPushActionsForEvent(this.props.mxEvent):void 0;return!!(null!=t&&t.tweaks||null!=i&&i.tweaks)&&(this.props.mxEvent.getSender()!==e.credentials.userId&&!!(null!=t&&t.tweaks.highlight||null!=i&&i.tweaks.highlight))}renderE2EPadlock(){var e;const t=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if((0,Wn.S)(t.getRoomId()))return null;if(t.isDecryptionFailure())return o.createElement(cs,null);if(this.state.shieldColour!==X.EventShieldColour.NONE){let e;switch(this.state.shieldReason){case null:case X.EventShieldReason.UNKNOWN:e=(0,l._t)("error|unknown");break;case X.EventShieldReason.UNVERIFIED_IDENTITY:e=(0,l._t)("encryption|event_shield_reason_unverified_identity");break;case X.EventShieldReason.UNSIGNED_DEVICE:e=(0,l._t)("encryption|event_shield_reason_unsigned_device");break;case X.EventShieldReason.UNKNOWN_DEVICE:e=(0,l._t)("encryption|event_shield_reason_unknown_device");break;case X.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED:e=(0,l._t)("encryption|event_shield_reason_authenticity_not_guaranteed");break;case X.EventShieldReason.MISMATCHED_SENDER_KEY:e=(0,l._t)("encryption|event_shield_reason_mismatched_sender_key")}return this.state.shieldColour===X.EventShieldColour.GREY?o.createElement(ms,{icon:ds.Normal,title:e}):o.createElement(ms,{icon:ds.Warning,title:e})}if(E.p.safeGet().isRoomEncrypted(t.getRoomId())){if(t.status===n.EventStatus.ENCRYPTING)return null;if(t.status===n.EventStatus.NOT_SENT)return null;if(t.isState())return null;if(t.isRedacted())return null;if(!t.isEncrypted())return o.createElement(ls,null)}return null}showContextMenu(e,t){var i;const n=e.target,s=n instanceof HTMLAnchorElement?n:n.closest("a");n instanceof HTMLImageElement||(null!==(i=a.Z.get())&&void 0!==i&&i.allowOverridingNativeContextMenus()||!(0,bn.ZT)()&&!s)&&(this.props.editState||(e.preventDefault(),e.stopPropagation(),this.setState({contextMenu:{position:{left:e.clientX,top:e.clientY,bottom:e.clientY},link:(null==s?void 0:s.href)||t},actionBarFocused:!0})))}shouldHideEvent(){var e;return(null===(e=this.props.callEventGrouper)||void 0===e?void 0:e.hangupReason)===xt.We.Replaced}renderContextMenu(){if(!this.state.contextMenu)return null;const e=this.getTile(),t=this.getReplyChain(),i=null!=e&&e.getEventTileOps?e.getEventTileOps():void 0,n=null!=t&&t.canCollapse()?t.collapse:void 0;return o.createElement(ti.Z,(0,kt.Z)({},(0,ii.vT)(this.state.contextMenu.position),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,eventTileOps:i,collapseReplyChain:n,onFinished:this.onCloseMenu,rightClick:!0,reactions:this.state.reactions,link:this.state.contextMenu.link,getRelationsForEvent:this.props.getRelationsForEvent}))}render(){var e,t,i,s;const a=this.props.mxEvent.getContent().msgtype,c=this.props.mxEvent.getType(),{hasRenderer:d,isBubbleMessage:m,isInfoMessage:h,isLeftAlignedBubbleMessage:p,noBubbleEvent:u,isSeeingThroughMessageHiddenForModeration:g}=Ft(E.p.safeGet(),this.props.mxEvent,this.context.showHiddenEvents,this.shouldHideEvent()),{isQuoteExpanded:v}=this.state;if(!d){const{mxEvent:e}=this.props;return r.k.warn(`Event type not supported: type:${c} isState:${e.isState()}`),o.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},o.createElement("div",{className:"mx_EventTile_line"},(0,l._t)("timeline|error_no_renderer")))}const _=qi.A.isEligible(this.props.mxEvent),f=yt()("mx_EventTile_line",{mx_EventTile_mediaLine:_,mx_EventTile_image:this.props.mxEvent.getType()===n.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===n.MsgType.Image,mx_EventTile_sticker:this.props.mxEvent.getType()===n.EventType.Sticker,mx_EventTile_emote:this.props.mxEvent.getType()===n.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===n.MsgType.Emote}),y=["sending","queued","encrypting"].includes(this.props.eventSendStatus),b=(0,At._6)(this.props.mxEvent)&&this.props.isRedacted,w=this.props.mxEvent.isDecryptionFailure();let S=this.props.continuation;this.context.timelineRenderingType!==qt.SB.Room&&this.context.timelineRenderingType!==qt.SB.Search&&this.context.timelineRenderingType!==qt.SB.Thread&&this.props.layout!==St.A.Bubble&&(S=!1);const C=this.context.timelineRenderingType===qt.SB.Notification,k=!!this.props.editState,R=yt()({mx_EventTile_bubbleContainer:m,mx_EventTile_leftAlignedBubble:p,mx_EventTile:!0,mx_EventTile_isEditing:k,mx_EventTile_info:h,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!k&&y,mx_EventTile_highlight:this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent||this.state.contextMenu,mx_EventTile_continuation:S||c===n.EventType.CallInvite||Lt.gk.CALL_EVENT_TYPE.matches(c),mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_bad:w,mx_EventTile_emote:a===n.MsgType.Emote,mx_EventTile_noSender:this.props.hideSender,mx_EventTile_clamp:this.context.timelineRenderingType===qt.SB.ThreadsList||C,mx_EventTile_noBubble:u}),I=null!==this.props.eventSendStatus?"off":void 0;let P="#";this.props.permalinkCreator&&(P=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const T=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let Z,N,D=null,M=null;if(C?(Z="24px",N=!0):h?(Z="14px",N=!1):this.context.timelineRenderingType===qt.SB.ThreadsList||this.context.timelineRenderingType===qt.SB.Thread&&!this.props.continuation?(Z="32px",N=!0):c===n.EventType.RoomCreate||m?(Z=null,N=!1):this.props.layout==St.A.IRC?(Z="14px",N=!0):this.props.continuation&&this.context.timelineRenderingType!==qt.SB.File||c===n.EventType.CallInvite||Lt.gk.CALL_EVENT_TYPE.matches(c)?(Z=null,N=!1):(Z="30px",N=!0),this.props.mxEvent.sender&&null!==Z){let e=null;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender;const t=!this.props.inhibitInteraction&&![qt.SB.ThreadsList,qt.SB.Notification].includes(this.context.timelineRenderingType);D=o.createElement("div",{className:"mx_EventTile_avatar"},o.createElement(Vt.Z,{member:e,size:Z,viewUserOnClick:t,forceHistorical:this.props.mxEvent.getType()===n.EventType.RoomMember}))}N&&!0!==this.props.hideSender&&(M=this.context.timelineRenderingType===qt.SB.Room||this.context.timelineRenderingType===qt.SB.Search||this.context.timelineRenderingType===qt.SB.Pinned||this.context.timelineRenderingType===qt.SB.Thread?o.createElement(Nt,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent}):this.context.timelineRenderingType===qt.SB.ThreadsList?o.createElement(Nt,{mxEvent:this.props.mxEvent,withTooltip:!0}):o.createElement(Nt,{mxEvent:this.props.mxEvent}));const O=!k&&!this.props.forExport?o.createElement(rn,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyChain:this.getReplyChain,onFocusChange:this.onActionBarFocusChange,isQuoteExpanded:v,toggleThreadExpanded:()=>this.setQuoteExpanded(!v),getRelationsForEvent:this.props.getRelationsForEvent}):void 0,A=this.props.mxEvent.getTs()&&!this.props.hideTimestamp&&(this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused||Boolean(this.state.contextMenu));let L=this.context.timelineRenderingType!==qt.SB.ThreadsList?this.props.mxEvent.getTs():null===(e=this.state.thread)||void 0===e||null===(t=e.replyToEvent)||void 0===t?void 0:t.getTs();"number"!=typeof L&&(L=this.props.mxEvent.getTs());const U=o.createElement(ri.Z,{showRelative:this.context.timelineRenderingType===qt.SB.ThreadsList,showTwelveHour:this.props.isTwelveHour,ts:L,receivedTs:null===(i=is(this.props.mxEvent))||void 0===i?void 0:i.received_ts}),F=A&&L?U:null;let B;b||(B=o.createElement(fn,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,key:"mx_EventTile_reactionsRow"}));const V=this.props.hideTimestamp?null:o.createElement("a",{href:P,onClick:this.onPermalinkClicked,"aria-label":(0,Oe.mr)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour),onContextMenu:this.onTimestampContextMenu},F),j=this.props.layout===St.A.IRC,z=j?null:V,H=j?V:null,G=this.props.layout===St.A.Bubble?U:void 0,K=!j&&!m&&this.renderE2EPadlock(),q=j&&!m&&this.renderE2EPadlock();let $;var J,Y;this.props.showReadReceipts&&($=this.shouldShowSentReceipt||this.shouldShowSendingReceipt?o.createElement(hs,{messageState:this.props.mxEvent.getAssociatedStatus()}):o.createElement(Bn,{readReceipts:null!==(J=this.props.readReceipts)&&void 0!==J?J:[],readReceiptMap:null!==(Y=this.props.readReceiptMap)&&void 0!==Y?Y:{},checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,isTwelveHour:this.props.isTwelveHour}));let Q;(0,At.eD)(this.props.mxEvent,E.p.safeGet(),this.context.showHiddenEvents)&&(0,Kt._r)(this.props.mxEvent)&&(Q=o.createElement($t,{parentEv:this.props.mxEvent,onHeightChanged:this.props.onHeightChanged,ref:this.replyChain,forExport:this.props.forExport,permalinkCreator:this.props.permalinkCreator,layout:this.props.layout,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.hover,isQuoteExpanded:v,setQuoteExpanded:this.setQuoteExpanded,getRelationsForEvent:this.props.getRelationsForEvent}));const X=(null===(s=this.props.mxEvent)||void 0===s?void 0:s.getSender())===E.p.safeGet().getUserId();switch(this.context.timelineRenderingType){case qt.SB.Thread:return o.createElement(this.props.as||"li",{ref:this.ref,className:R,"aria-live":I,"aria-atomic":!0,"data-scroll-tokens":T,"data-has-reply":!!Q,"data-layout":this.props.layout,"data-self":X,"data-event-id":this.props.mxEvent.getId(),onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[o.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},D,M),o.createElement("div",{className:f,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),Q,(0,At.Z5)(qt.SB.Thread,ss(ss({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:g,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:()=>this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),O,o.createElement("a",{href:P,onClick:this.onPermalinkClicked},F),$),B]);case qt.SB.Notification:case qt.SB.ThreadsList:{const e=E.p.safeGet().getRoom(this.props.mxEvent.getRoomId());return o.createElement(this.props.as||"li",{ref:this.ref,className:R,tabIndex:-1,"aria-live":I,"aria-atomic":"true","data-scroll-tokens":T,"data-layout":this.props.layout,"data-shape":this.context.timelineRenderingType,"data-self":X,"data-has-reply":!!Q,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1}),onClick:e=>{var t;const i=e.currentTarget;let n=-1;switch(i.parentElement&&(n=Array.from(i.parentElement.children).indexOf(i)),this.context.timelineRenderingType){case qt.SB.Notification:this.viewInRoom(e);break;case qt.SB.ThreadsList:x.ZP.dispatch({action:W.a.ShowThread,rootEvent:this.props.mxEvent,push:!0}),kn.Z.trackInteraction("WebThreadsPanelThreadItem",e,null!==(t=n)&&void 0!==t?t:-1)}}},o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_EventTile_details"},M,C&&e?o.createElement("span",{className:"mx_EventTile_truncated"}," ",(0,l._t)("timeline|in_room_name",{room:e.name},{strong:e=>o.createElement("strong",null,e)})):"",F),C&&e?o.createElement("div",{className:"mx_EventTile_avatar"},o.createElement(ei.Z,{room:e,size:"28px"})):D,o.createElement("div",{className:f,key:"mx_EventTile_line"},o.createElement("div",{className:"mx_EventTile_body"},this.props.mxEvent.isRedacted()?o.createElement(Cn.Z,{mxEvent:this.props.mxEvent}):this.props.mxEvent.isDecryptionFailure()?o.createElement(Xt.H,{mxEvent:this.props.mxEvent}):yn.z.instance.generatePreviewForEvent(this.props.mxEvent)),this.renderThreadPanelSummary()),this.context.timelineRenderingType===qt.SB.ThreadsList&&o.createElement(ts,{viewInRoom:this.viewInRoom,copyLinkToThread:this.copyLinkToThread}),$,o.createElement(Kn,{room:e||void 0,threadId:this.props.mxEvent.getId()})))}case qt.SB.File:return o.createElement(this.props.as||"li",{className:R,"aria-live":I,"aria-atomic":!0,"data-scroll-tokens":T},[o.createElement("div",{className:f,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),(0,At.Z5)(qt.SB.File,ss(ss({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:g,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents)),o.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:P,onClick:this.onPermalinkClicked},o.createElement("div",{className:"mx_EventTile_senderDetails",onContextMenu:this.onTimestampContextMenu},M,F))]);default:return o.createElement(this.props.as||"li",{ref:this.ref,className:R,tabIndex:-1,"aria-live":I,"aria-atomic":"true","data-scroll-tokens":T,"data-layout":this.props.layout,"data-self":X,"data-event-id":this.props.mxEvent.getId(),"data-has-reply":!!Q,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},o.createElement(o.Fragment,null,H,M,q,D,o.createElement("div",{className:f,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),z,K,Q,(0,At.Z5)(this.context.timelineRenderingType,ss(ss({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:g,timestamp:G,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),O,this.props.layout===St.A.IRC&&o.createElement(o.Fragment,null,B,this.renderThreadInfo())),this.props.layout!==St.A.IRC&&o.createElement(o.Fragment,null,B,this.renderThreadInfo()),$))}}}(0,k.Z)(as,"defaultProps",{onHeightChanged:function(){},forExport:!1,layout:St.A.Group}),(0,k.Z)(as,"contextType",qt.ZP);const rs=(0,o.forwardRef)(((e,t)=>{var i;return o.createElement(o.Fragment,null,o.createElement(Rn,{mxEvent:e.mxEvent,layout:null!==(i=e.layout)&&void 0!==i?i:St.A.Group},o.createElement(as,(0,kt.Z)({ref:t},e))))}));function ls(e){return o.createElement(ms,(0,kt.Z)({title:(0,l._t)("common|unencrypted"),icon:ds.Warning},e))}function cs(e){return o.createElement(ms,(0,kt.Z)({title:(0,l._t)("timeline|undecryptable_tooltip"),icon:ds.DecryptionFailure},e))}var ds=function(e){return e.Normal="normal",e.Warning="warning",e.DecryptionFailure="decryption_failure",e}(ds||{});class ms extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onHoverStart",(()=>{this.setState({hover:!0})})),(0,k.Z)(this,"onHoverEnd",(()=>{this.setState({hover:!1})})),this.state={hover:!1}}render(){let e;this.state.hover&&(e=o.createElement(si.Z,{className:"mx_EventTile_e2eIcon_tooltip",label:this.props.title}));const t=`mx_EventTile_e2eIcon mx_EventTile_e2eIcon_${this.props.icon}`;return o.createElement("div",{className:t,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd,"aria-label":this.props.title},e)}}function hs({messageState:e}){const t=(0,o.useRef)(`mx_SentReceipt_${Math.random()}`).current,i=!e||"sent"===e,n="not_sent"===e,s=yt()({mx_EventTile_receiptSent:i,mx_EventTile_receiptSending:!i&&!n});let a;n&&(a=o.createElement(ai.Z,{notification:oi.Z.RED_EXCLAMATION}));let r=(0,l._t)("timeline|send_state_sending");"encrypting"===e?r=(0,l._t)("timeline|send_state_encrypting"):i?r=(0,l._t)("timeline|send_state_sent"):n&&(r=(0,l._t)("timeline|send_state_failed"));const[{showTooltip:c,hideTooltip:d},m]=Un({id:t,label:r,alignment:si.v.TopRight});return o.createElement("div",{className:"mx_EventTile_msgOption"},o.createElement("div",{className:"mx_ReadReceiptGroup"},o.createElement("div",{className:"mx_ReadReceiptGroup_button",onMouseOver:c,onMouseLeave:d,onFocus:c,onBlur:d,"aria-describedby":t},o.createElement("span",{className:"mx_ReadReceiptGroup_container"},o.createElement("span",{className:s},a))),m))}var ps=i("../matrix-react-sdk/src/components/structures/SearchBox.tsx"),us=i("../matrix-react-sdk/src/components/views/avatars/DecoratedRoomAvatar.tsx"),gs=i("../matrix-react-sdk/src/components/views/elements/AccessibleTooltipButton.tsx"),vs=i("../matrix-react-sdk/src/stores/room-list/algorithms/tag-sorting/RecentAlgorithm.ts"),_s=i("../matrix-react-sdk/src/autocomplete/QueryMatcher.ts"),fs=i("../matrix-react-sdk/src/components/views/elements/TruncatedList.tsx"),Es=i("../matrix-react-sdk/src/components/views/rooms/E2EIcon.tsx"),ys=i("../matrix-react-sdk/src/components/views/avatars/BaseAvatar.tsx"),bs=i("../matrix-react-sdk/src/components/views/rooms/PresenceLabel.tsx");let ws=function(e){return e.Admin="admin",e.Moderator="moderator",e}({});const Ss={[ws.Admin]:(0,l.I8)("power_level|admin"),[ws.Moderator]:(0,l.I8)("power_level|mod")},Cs={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable","io.element.unreachable":"mx_EntityTile_unreachable"};class ks extends o.PureComponent{constructor(e){super(e),this.state={hover:!1}}getPresenceLabel(){if(!this.props.showPresence)return;const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1;return o.createElement(bs.Z,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})}render(){const e={mx_EntityTile:!0};this.props.className&&(e[this.props.className]=!0);var t,n;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"===t?n?Cs.offline+"_beenactive":Cs.offline+"_neveractive":t?Cs[t]:Cs.offline+"_neveractive")]=!0;const s=this.props.nameJSX||this.props.name,a=o.createElement("div",{className:"mx_EntityTile_details"},o.createElement("div",{className:"mx_EntityTile_name"},s),this.getPresenceLabel());let r,c;this.props.showInviteButton&&(r=o.createElement("div",{className:"mx_EntityTile_invite"},o.createElement("img",{alt:(0,l._t)("action|invite"),src:i("../matrix-react-sdk/res/img/plus.svg").Z,width:"16",height:"16"})));const d=this.props.powerStatus;if(d){const e=(0,l._t)(Ss[d]);c=o.createElement("div",{className:"mx_EntityTile_power"},e)}let m;const{e2eStatus:h}=this.props;h&&(m=o.createElement(Es.Z,{status:h,isUser:!0,bordered:!0}));const p=this.props.avatarJsx||o.createElement(ys.Z,{name:this.props.name,size:"36px","aria-hidden":"true"});return o.createElement("div",null,o.createElement(ae.Z,{className:yt()(e),title:this.props.title,onClick:this.props.onClick},o.createElement("div",{className:"mx_EntityTile_avatar"},p,m),a,c,r))}}(0,k.Z)(ks,"defaultProps",{onClick:()=>{},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,showPresence:!0});var xs=i("../matrix-react-sdk/src/utils/location/index.ts"),Rs=i("../matrix-react-sdk/src/stores/spaces/SpaceStore.ts");const Is=["room","component"];function Ps(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Ts(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ps(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ps(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Zs(e){let{room:t,component:i}=e,n=(0,v.Z)(e,Is);const s=function(e){const t=P.Z.shared().getUserIdForRoomId(e.roomId),i=e.getMembers().length>2;if(!e.isSpaceRoom()&&t&&!i)return{details:t};const[n,s,...o]=Rs.ZP.instance.getKnownParents(e.roomId);if(s&&(null==o||!o.length)){var a,r;const t=null===(a=e.client.getRoom(n))||void 0===a?void 0:a.name,i=null===(r=e.client.getRoom(s))||void 0===r?void 0:r.name;return{details:(0,It.If)([null!=t?t:"",null!=i?i:""]),ariaLabel:(0,l._t)("in_space1_and_space2",{space1Name:t,space2Name:i})}}if(n){var c,d;const t=null!==(c=null===(d=e.client.getRoom(n))||void 0===d?void 0:d.name)&&void 0!==c?c:"",i=o.length;return i>0?{details:(0,It.If)([t,...o],1),ariaLabel:(0,l._t)("in_space_and_n_other_spaces",{spaceName:t,count:i})}:{details:t,ariaLabel:(0,l._t)("in_space",{spaceName:t})}}return{details:e.getCanonicalAlias()}}(t);return s?o.createElement(null!=i?i:"div",Ts(Ts({},n),{},{"aria-label":s.ariaLabel}),[s.details]):o.createElement(o.Fragment,null)}const Ns=["m.relates_to"];function Ds(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Ms(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ds(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ds(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var Os=function(e){return e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed",e}(Os||{});const As=({room:e,type:t,content:i,matrixClient:n,onFinished:s})=>{const[a,r]=(0,o.useState)(Os.CanSend);let c,d,m,h=!1;return a===Os.CanSend?(c="mx_ForwardList_canSend",e.maySendMessage()||(h=!0,d=(0,l._t)("forward|no_perms_title"))):a===Os.Sending?(c="mx_ForwardList_sending",h=!0,d=(0,l._t)("forward|sending"),m=o.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":d})):a===Os.Sent?(c="mx_ForwardList_sent",h=!0,d=(0,l._t)("forward|sent"),m=o.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":d})):(c="mx_ForwardList_sendFailed",h=!0,d=(0,l._t)("timeline|send_state_failed"),m=o.createElement(ai.Z,{notification:oi.Z.RED_EXCLAMATION})),o.createElement("div",{className:"mx_ForwardList_entry"},o.createElement(gs.Z,{className:"mx_ForwardList_roomButton",onClick:t=>{x.ZP.dispatch({action:W.a.ViewRoom,room_id:e.roomId,metricsTrigger:"WebForwardShortcut",metricsViaKeyboard:"click"!==t.type}),s(!0)},title:(0,l._t)("forward|open_room"),alignment:si.v.Top},o.createElement(us.Z,{room:e,size:"32px"}),o.createElement("span",{className:"mx_ForwardList_entry_name"},e.name),o.createElement(Zs,{component:"span",className:"mx_ForwardList_entry_detail",room:e})),o.createElement(gs.Z,{kind:a===Os.Failed?"danger_outline":"primary_outline",className:`mx_ForwardList_sendButton ${c}`,onClick:async()=>{r(Os.Sending);try{await n.sendEvent(e.roomId,t,i),r(Os.Sent)}catch(e){r(Os.Failed)}},disabled:h,title:d,alignment:si.v.Top},o.createElement("div",{className:"mx_ForwardList_sendLabel"},(0,l._t)("forward|send_label")),m))},Ls=({matrixClient:e,event:t,permalinkCreator:s,onFinished:a})=>{const r=e.getSafeUserId(),[c,d]=(0,o.useState)({});(0,o.useEffect)((()=>{e.getProfileInfo(r).then((e=>d(e)))}),[e,r]);const{type:m,content:h}=(e=>{const t=e.getContent(),{"m.relates_to":i}=t,s=(0,v.Z)(t,Ns),o=n.M_BEACON.matches(e.getType())?n.EventType.RoomMessage:e.getType();if((0,Ot.Ar)(e)&&(0,xs.yQ)(s)||n.M_BEACON.matches(e.getType())){const t=n.M_TIMESTAMP.findIn(s),i=(0,xs.L7)(e);return{type:o,content:Ms(Ms({},s),n.ContentHelpers.makeLocationContent(void 0,i,t||Date.now(),void 0,n.LocationAssetType.Pin))}}return{type:o,content:s}})(t),p=new n.MatrixEvent({type:"m.room.message",sender:r,content:h,unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:t.getRoomId(),origin_server_ts:t.getTs()});p.sender={name:c.displayname||r,rawDisplayName:c.displayname,userId:r,getAvatarUrl:(...e)=>(0,Ct.cL)({avatarUrl:c.avatar_url},30,30,"crop"),getMxcAvatarUrl:()=>c.avatar_url};const[u,g]=(0,o.useState)(""),_=u.toLowerCase(),f=(0,wt.t)("layout"),E=(0,wt.t)("feature_dynamic_room_predecessors");let y=(0,o.useMemo)((()=>(0,vs.yu)(e.getVisibleRooms(E).filter((e=>"join"===e.getMyMembership()&&!e.isSpaceRoom())))),[e,E]);_&&(y=new _s.Z(y,{keys:["name"],funcs:[e=>(0,ne.gP)([e.getCanonicalAlias(),...e.getAltAliases()])],shouldMatchWordsOnly:!1}).match(_));const[b,w]=(0,o.useState)(20);return o.createElement(q.Z,{title:(0,l._t)("common|forward_message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:a,fixedWidth:!1},o.createElement("h3",null,(0,l._t)("forward|message_preview_heading")),o.createElement("div",{className:yt()("mx_ForwardDialog_preview",{mx_IRCLayout:f==St.A.IRC})},o.createElement(rs,{mxEvent:p,layout:f,permalinkCreator:s,as:"div",inhibitInteraction:!0})),o.createElement("hr",null),o.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},o.createElement(ps.Z,{className:"mx_textinput_icon mx_textinput_search",placeholder:(0,l._t)("forward|filter_placeholder"),onSearch:g,autoFocus:!0}),o.createElement(Ln.Z,{className:"mx_ForwardList_content"},y.length>0?o.createElement("div",{className:"mx_ForwardList_results"},o.createElement(fs.Z,{className:"mx_ForwardList_resultsList",truncateAt:b,createOverflowElement:function(e,t){const n=(0,l._t)("common|and_n_others",{count:e});return o.createElement(ks,{className:"mx_EntityTile_ellipsis",avatarJsx:o.createElement(ys.Z,{url:i("../matrix-react-sdk/res/img/ellipsis.svg").Z,name:"...",size:"36px"}),name:n,showPresence:!1,onClick:()=>w(t)})},getChildren:(t,i)=>y.slice(t,i).map((t=>o.createElement(As,{key:t.roomId,room:t,type:m,content:h,matrixClient:e,onFinished:a}))),getChildCount:()=>y.length})):o.createElement("span",{className:"mx_ForwardList_noResults"},(0,l._t)("common|no_results")))))};var Us=i("../matrix-react-sdk/src/createRoom.ts"),Fs=i("../matrix-react-sdk/src/Markdown.ts"),Bs=i("../matrix-react-sdk/src/components/views/elements/StyledRadioButton.tsx"),Vs=i("../matrix-react-sdk/src/components/views/elements/Field.tsx"),js=i("../matrix-react-sdk/src/components/views/elements/LabelledCheckbox.tsx");const zs=["org.matrix.msc3215.room.moderation.moderated_by"];var Ws=function(e){return e.Disagreement="org.matrix.msc3215.abuse.nature.disagreement",e.Toxic="org.matrix.msc3215.abuse.nature.toxic",e.Illegal="org.matrix.msc3215.abuse.nature.illegal",e.Spam="org.matrix.msc3215.abuse.nature.spam",e.Other="org.matrix.msc3215.abuse.nature.other",e}(Ws||{}),Hs=function(e){return e.Admin="non-standard.abuse.nature.admin",e}(Hs||{});class Gs extends o.Component{constructor(e){super(e),(0,k.Z)(this,"moderation",void 0),(0,k.Z)(this,"onIgnoreUserTooChanged",(e=>{this.setState({ignoreUserToo:e})})),(0,k.Z)(this,"onReasonChange",(({target:{value:e}})=>{this.setState({reason:e})})),(0,k.Z)(this,"onNatureChosen",(e=>{this.setState({nature:e.currentTarget.value})})),(0,k.Z)(this,"onCancel",(()=>{this.props.onFinished(!1)})),(0,k.Z)(this,"onSubmit",(async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==Ws.Other||this.state.nature==Hs.Admin)&&!e)return void this.setState({err:(0,l._t)("report_content|missing_reason")})}else if(!e)return void this.setState({err:(0,l._t)("report_content|missing_reason")});this.setState({busy:!0,err:void 0});try{const e=E.p.safeGet(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!==Hs.Admin){const i=this.state.nature,n=await(0,Us.Aw)(e,this.moderation.moderationBotUserId);if(!n)throw new l.yh("report_content|error_create_room_moderation_bot");await e.sendEvent(n,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:i,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.state.ignoreUserToo&&await e.setIgnoredUsers([...e.getIgnoredUsers(),t.getSender()]),this.props.onFinished(!0)}catch(e){r.k.error(e),this.setState({busy:!1,err:e instanceof Error?e.message:String(e)})}}));let t=null,i=null;if(L.C.getValue("feature_report_to_moderators")){const n=E.p.safeGet().getRoom(e.mxEvent.getRoomId());for(const e of zs){const s=null==n?void 0:n.currentState.getStateEvents(e,e);if(!s)continue;if(Array.isArray(s))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const o=s.event;if(!("content"in o)||"object"!=typeof o.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",o);continue}const a=o.content;"room_id"in a&&"string"==typeof a.room_id?"user_id"in a&&"string"==typeof a.user_id?(t=a.room_id,i=a.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",o):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",o)}t&&i&&(this.moderation={moderationRoomId:t,moderationBotUserId:i})}this.state={reason:"",busy:!1,err:void 0,nature:void 0,ignoreUserToo:!1}}render(){var e;let t,i;this.state.err&&(t=o.createElement("div",{className:"error"},this.state.err)),this.state.busy&&(i=o.createElement("div",{className:"progress"},o.createElement(re.Z,null)));const n=o.createElement(js.Z,{value:this.state.ignoreUserToo,label:(0,l._t)("report_content|ignore_user"),byline:(0,l._t)("report_content|hide_messages_from_user"),onChange:this.onIgnoreUserTooChanged,disabled:this.state.busy}),s=null===(e=c.ZP.getObject("report_event"))||void 0===e?void 0:e.get("admin_message_md","adminMessageMD");let a;if(s){const e=new Fs.Z(s).toHTML({externalLinks:!0});a=o.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const e=E.p.safeGet(),s=c.ZP.get("validated_server_config").hsName;let a;switch(this.state.nature){case Ws.Disagreement:a=(0,l._t)("report_content|nature_disagreement");break;case Ws.Toxic:a=(0,l._t)("report_content|nature_toxic");break;case Ws.Illegal:a=(0,l._t)("report_content|nature_illegal");break;case Ws.Spam:a=(0,l._t)("report_content|nature_spam");break;case Hs.Admin:a=e.isRoomEncrypted(this.props.mxEvent.getRoomId())?(0,l._t)("report_content|nature_nonstandard_admin_encrypted",{homeserver:s}):(0,l._t)("report_content|nature_nonstandard_admin",{homeserver:s});break;case Ws.Other:a=(0,l._t)("report_content|nature_other");break;default:a=(0,l._t)("report_content|nature")}return o.createElement(q.Z,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,l._t)("action|report_content"),contentId:"mx_ReportEventDialog"},o.createElement("div",null,o.createElement(Bs.Z,{name:"nature",value:Ws.Disagreement,checked:this.state.nature==Ws.Disagreement,onChange:this.onNatureChosen},(0,l._t)("report_content|disagree")),o.createElement(Bs.Z,{name:"nature",value:Ws.Toxic,checked:this.state.nature==Ws.Toxic,onChange:this.onNatureChosen},(0,l._t)("report_content|toxic_behaviour")),o.createElement(Bs.Z,{name:"nature",value:Ws.Illegal,checked:this.state.nature==Ws.Illegal,onChange:this.onNatureChosen},(0,l._t)("report_content|illegal_content")),o.createElement(Bs.Z,{name:"nature",value:Ws.Spam,checked:this.state.nature==Ws.Spam,onChange:this.onNatureChosen},(0,l._t)("report_content|spam_or_propaganda")),o.createElement(Bs.Z,{name:"nature",value:Hs.Admin,checked:this.state.nature==Hs.Admin,onChange:this.onNatureChosen},(0,l._t)("report_content|report_entire_room")),o.createElement(Bs.Z,{name:"nature",value:Ws.Other,checked:this.state.nature==Ws.Other,onChange:this.onNatureChosen},(0,l._t)("report_content|other_label")),o.createElement("p",null,a),o.createElement(Vs.Z,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,l._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),i,t,n),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return o.createElement(q.Z,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,l._t)("report_content|report_content_to_homeserver"),contentId:"mx_ReportEventDialog"},o.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},o.createElement("p",null,(0,l._t)("report_content|description")),a,o.createElement(Vs.Z,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,l._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),i,t,n),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}var Ks=i("../matrix-react-sdk/src/components/structures/TabbedView.tsx"),qs=i("../matrix-react-sdk/src/components/views/elements/StyledCheckbox.tsx");const $s=({room:e,children:t})=>{const[i,s]=(0,o.useState)(null==e?void 0:e.name);return(0,In.V4)(e,n.RoomEvent.Name,(()=>{s(null==e?void 0:e.name)})),(0,o.useEffect)((()=>{s(null==e?void 0:e.name)}),[e]),t?t(null!=i?i:""):o.createElement(o.Fragment,null,i||"")};let Js=function(e){return e.Appearance="SPACE_PREFERENCE_APPEARANCE_TAB",e}({});var Ys=i("../matrix-react-sdk/src/components/views/settings/tabs/SettingsTab.tsx"),Qs=i("../matrix-react-sdk/src/components/views/settings/shared/SettingsSection.tsx"),Xs=i("../matrix-react-sdk/src/components/views/settings/shared/SettingsSubsection.tsx");const eo=({space:e})=>{const t=(0,wt.t)("Spaces.showPeopleInSpace",e.roomId);return o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("space|preferences|sections_section")},o.createElement(Xs.ZP,null,o.createElement(qs.Z,{checked:!!t,onChange:i=>{L.C.setValue("Spaces.showPeopleInSpace",e.roomId,U.R.ROOM_ACCOUNT,!t)}},(0,l._t)("common|people")),o.createElement(Xs.po,null,(0,l._t)("space|preferences|show_people_in_space",{spaceName:e.name})))))},to=({space:e,initialTabId:t,onFinished:i})=>{const n=[new Ks.OK(Js.Appearance,(0,l.I8)("common|appearance"),"mx_SpacePreferencesDialog_appearanceIcon",o.createElement(eo,{space:e}))];return o.createElement(q.Z,{className:"mx_SpacePreferencesDialog",hasCancel:!0,onFinished:i,title:(0,l._t)("common|preferences"),fixedWidth:!1},o.createElement("h4",null,o.createElement($s,{room:e})),o.createElement("div",{className:"mx_SettingsDialog_content"},o.createElement(Ks.ZP,{tabs:n,initialTabId:t})))};var io=i("../matrix-react-sdk/src/hooks/useDispatcher.ts"),no=i("../matrix-react-sdk/src/components/views/spaces/SpaceBasicSettings.tsx"),so=i("../matrix-react-sdk/src/editor/serialize.ts"),oo=i("../matrix-react-sdk/src/utils/leave-behaviour.ts");const ao=e=>{var t,i;const s=null==e||null===(t=e.currentState)||void 0===t||null===(i=t.getStateEvents(n.EventType.RoomTopic,""))||void 0===i?void 0:i.getContent();return s?n.ContentHelpers.parseTopicContent(s):null};function ro(e){const[t,i]=(0,o.useState)(ao(e));return(0,In.V4)(null==e?void 0:e.currentState,n.RoomStateEvent.Events,(t=>{t.getType()===n.EventType.RoomTopic&&i(ao(e))})),(0,o.useEffect)((()=>{i(ao(e))}),[e]),t}const lo=({matrixClient:e,space:t})=>{var i,s,a;const[c,d]=(0,o.useState)(!1),[m,h]=(0,o.useState)(""),p=e.getUserId(),[u,g]=(0,o.useState)(null),v=t.currentState.maySendStateEvent(n.EventType.RoomAvatar,p),_=null!==u,[f,E]=(0,o.useState)(t.name),y=t.currentState.maySendStateEvent(n.EventType.RoomName,p),b=f!==t.name,w=null!==(i=null===(s=ao(t))||void 0===s?void 0:s.text)&&void 0!==i?i:"",[S,C]=(0,o.useState)(w),k=t.currentState.maySendStateEvent(n.EventType.RoomTopic,p),x=S!==w;return o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("common|general")},o.createElement("div",null,o.createElement("div",null,(0,l._t)("room_settings|general|description_space")),m&&o.createElement("div",{className:"mx_SpaceRoomView_errorText"},m),o.createElement(no.Z,{avatarUrl:null!==(a=(0,Ct.Eh)(t,80,80,"crop"))&&void 0!==a?a:void 0,avatarDisabled:c||!v,setAvatar:g,name:f,nameDisabled:c||!y,setName:E,topic:S,topicDisabled:c||!k,setTopic:C}),o.createElement(ae.Z,{onClick:()=>{g(null),E(t.name),C(w)},disabled:c||!(_||b||x),kind:"link"},(0,l._t)("action|cancel")),o.createElement(ae.Z,{onClick:async()=>{d(!0);const i=[];if(_&&(u?i.push((async()=>{const{content_uri:i}=await e.uploadContent(u);await e.sendStateEvent(t.roomId,n.EventType.RoomAvatar,{url:i},"")})()):i.push(e.sendStateEvent(t.roomId,n.EventType.RoomAvatar,{},""))),b&&i.push(e.setRoomName(t.roomId,f)),x){const n=(0,so.cG)(S,{forceHTML:!1});i.push(e.setRoomTopic(t.roomId,S,n))}const s=await Promise.allSettled(i);d(!1);const o=s.filter((e=>"rejected"===e.status));o.length>0&&(r.k.error("Failed to save space settings: ",o),h((0,l._t)("room_settings|general|error_save_space_settings")))},disabled:c,kind:"primary"},c?(0,l._t)("common|saving"):(0,l._t)("room_settings|general|save"))),o.createElement(Xs.ZP,{heading:(0,l._t)("room_settings|general|leave_space")},o.createElement(ae.Z,{kind:"danger",onClick:()=>{(0,oo.b)(t)}},(0,l._t)("room_settings|general|leave_space")))))};var co=i("../matrix-react-sdk/src/components/views/room_settings/AliasSettings.tsx"),mo=i("../matrix-react-sdk/src/hooks/useStateToggle.ts"),ho=i("../matrix-react-sdk/src/components/views/elements/LabelledToggleSwitch.tsx"),po=i("../matrix-react-sdk/src/hooks/useLocalEcho.ts"),uo=i("../matrix-react-sdk/src/components/views/settings/JoinRuleSettings.tsx"),go=i("../matrix-react-sdk/src/hooks/useRoomState.ts"),vo=i("../matrix-react-sdk/src/components/views/settings/SettingsFieldset.tsx");const _o=({matrixClient:e,space:t,closeSettingsFn:i})=>{const[s,a]=(0,o.useState)(""),r=(0,Pn.G)((async()=>e.isVersionSupported("v1.4").then((t=>t||e.doesServerSupportUnstableFeature("org.matrix.msc3827.stable")))),[e],!1),c=e.getUserId(),d=(0,go.c)(t,(e=>e.getJoinRule())),[m,h]=(0,po.m)((()=>{var e,i;return(null===(e=t.currentState.getStateEvents(n.EventType.RoomGuestAccess,""))||void 0===e||null===(i=e.getContent())||void 0===i?void 0:i.guest_access)===n.GuestAccess.CanJoin}),(i=>e.sendStateEvent(t.roomId,n.EventType.RoomGuestAccess,{guest_access:i?n.GuestAccess.CanJoin:n.GuestAccess.Forbidden},"")),(()=>a((0,l._t)("room_settings|visibility|error_update_guest_access")))),[p,u]=(0,po.m)((()=>{var e,i;return(null===(e=t.currentState.getStateEvents(n.EventType.RoomHistoryVisibility,""))||void 0===e||null===(i=e.getContent())||void 0===i?void 0:i.history_visibility)||n.HistoryVisibility.Shared}),(i=>e.sendStateEvent(t.roomId,n.EventType.RoomHistoryVisibility,{history_visibility:i},"")),(()=>a((0,l._t)("room_settings|visibility|error_update_history_visibility")))),[g,v]=(0,mo.R)(),_=t.currentState.maySendStateEvent(n.EventType.RoomGuestAccess,c),f=t.currentState.maySendStateEvent(n.EventType.RoomHistoryVisibility,c),E=t.currentState.mayClientSendStateEvent(n.EventType.RoomCanonicalAlias,e),y=t.currentState.getStateEvents(n.EventType.RoomCanonicalAlias,"");let b,w;return d===n.JoinRule.Public&&(b=o.createElement("div",null,o.createElement(ae.Z,{"data-testid":"toggle-guest-access-btn",onClick:v,kind:"link",className:"mx_SettingsTab_showAdvanced","aria-expanded":g},g?(0,l._t)("action|hide_advanced"):(0,l._t)("action|show_advanced")),g&&o.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},o.createElement(ho.Z,{value:m,onChange:h,disabled:!_,label:(0,l._t)("room_settings|visibility|guest_access_label")}),o.createElement("p",null,(0,l._t)("room_settings|visibility|guest_access_explainer"),o.createElement("br",null),(0,l._t)("room_settings|visibility|guest_access_explainer_public_space"))))),t.getJoinRule()===n.JoinRule.Public&&(w=o.createElement(Qs.Q,{heading:(0,l._t)("room_settings|visibility|alias_section")},o.createElement(co.Z,{roomId:t.roomId,canSetCanonicalAlias:E,canSetAliases:!0,canonicalAliasEvent:null!=y?y:void 0,hidePublishSetting:!r}))),o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("room_settings|visibility|title")},s&&o.createElement("div",{"data-testid":"space-settings-error",className:"mx_SpaceRoomView_errorText"},s),o.createElement(vo.Z,{"data-testid":"access-fieldset",legend:(0,l._t)("room_settings|access|title"),description:(0,l._t)("room_settings|access|description_space",{spaceName:t.name})},o.createElement(uo.Z,{room:t,onError:()=>a((0,l._t)("room_settings|visibility|error_failed_save")),closeSettingsFn:i}),b,o.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},o.createElement(ho.Z,{value:p===n.HistoryVisibility.WorldReadable,onChange:e=>{u(e?n.HistoryVisibility.WorldReadable:n.HistoryVisibility.Shared)},disabled:!f,label:(0,l._t)("room_settings|visibility|history_visibility_anyone_space")}),o.createElement("p",null,(0,l._t)("room_settings|visibility|history_visibility_anyone_space_description"),o.createElement("br",null),o.createElement("b",null,(0,l._t)("room_settings|visibility|history_visibility_anyone_space_recommendation"))))),w))};var fo=i("../matrix-react-sdk/src/components/views/settings/tabs/room/AdvancedRoomSettingsTab.tsx"),Eo=i("../matrix-react-sdk/src/components/views/settings/tabs/room/RolesRoomSettingsTab.tsx");let yo=function(e){return e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Roles="SPACE_ROLES_TAB",e.Advanced="SPACE_ADVANCED_TAB",e}({});const bo=({matrixClient:e,space:t,onFinished:i})=>{(0,io.P)(x.ZP,(e=>{e.action===W.a.AfterLeaveRoom&&e.room_id===t.roomId&&i()}));const n=(0,o.useMemo)((()=>[new Ks.OK(yo.General,(0,l.I8)("common|general"),"mx_SpaceSettingsDialog_generalIcon",o.createElement(lo,{matrixClient:e,space:t})),new Ks.OK(yo.Visibility,(0,l.I8)("room_settings|visibility|title"),"mx_SpaceSettingsDialog_visibilityIcon",o.createElement(_o,{matrixClient:e,space:t,closeSettingsFn:i})),new Ks.OK(yo.Roles,(0,l.I8)("room_settings|permissions|title"),"mx_RoomSettingsDialog_rolesIcon",o.createElement(Eo.Z,{room:t})),L.C.getValue(Ye.H.AdvancedSettings)?new Ks.OK(yo.Advanced,(0,l.I8)("common|advanced"),"mx_RoomSettingsDialog_warningIcon",o.createElement(fo.Z,{room:t,closeSettingsFn:i})):null].filter(Boolean)),[e,t,i]);return o.createElement(q.Z,{title:(0,l._t)("space_settings|title",{spaceName:t.name||(0,l._t)("common|unnamed_space")}),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:i,fixedWidth:!1},o.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog"},o.createElement(Ks.ZP,{tabs:n})))};var wo,So=i("../matrix-react-sdk/src/components/views/dialogs/InviteDialog.tsx"),Co=i("../matrix-react-sdk/src/components/views/dialogs/AddExistingToSpaceDialog.tsx"),ko=i("../matrix-react-sdk/src/utils/space.tsx");class xo{constructor(){(0,k.Z)(this,"isRegistered",!1),(0,k.Z)(this,"matrixClient",void 0),(0,k.Z)(this,"onDispatch",(e=>{if(this.matrixClient)switch(e.action){case"open_room_settings":T.ZP.createDialog(bt.Z,{roomId:e.room_id||ie.m.instance.roomViewStore.getRoomId(),initialTabId:e.initial_tab_id},void 0,!1,!0);break;case W.a.OpenForwardDialog:T.ZP.createDialog(Ls,{matrixClient:this.matrixClient,event:e.event,permalinkCreator:e.permalinkCreator});break;case W.a.OpenReportEventDialog:T.ZP.createDialog(Gs,{mxEvent:e.event},"mx_Dialog_reportEvent");break;case W.a.OpenSpacePreferences:T.ZP.createDialog(to,{initialTabId:e.initalTabId,space:e.space},void 0,!1,!0);break;case W.a.OpenSpaceSettings:T.ZP.createDialog(bo,{matrixClient:e.space.client,space:e.space},void 0,!1,!0);break;case W.a.OpenInviteDialog:T.ZP.createDialog(So.Z,{kind:e.kind,call:e.call,roomId:e.roomId},yt()("mx_InviteDialog_flexWrapper",e.className),!1,!0).finished.then((t=>{var i;null===(i=e.onFinishedCallback)||void 0===i||i.call(e,t)}));break;case W.a.OpenAddToExistingSpaceDialog:{const t=e.space;T.ZP.createDialog(Co.ZP,{onCreateRoomClick:e=>{(0,ko.gS)(t),kn.Z.trackInteraction("WebAddExistingToSpaceDialogCreateRoomButton",e)},onAddSubspaceClick:()=>(0,ko.UQ)(t),space:t,onFinished:e=>{e&&ie.m.instance.roomViewStore.getRoomId()===t.roomId&&x.ZP.fire(W.a.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper");break}}}))}prepare(e){this.matrixClient=e,this.isRegistered||(x.ZP.register(this.onDispatch),this.isRegistered=!0)}}wo=xo,(0,k.Z)(xo,"instance",new wo);var Ro=i("../matrix-react-sdk/src/settings/handlers/AbstractLocalStorageSettingsHandler.ts"),Io=i("../matrix-react-sdk/src/utils/ErrorUtils.tsx"),Po=i("../matrix-js-sdk/src/oidc/authorize.ts"),To=i("../matrix-js-sdk/src/randomstring.ts"),Zo=i("../matrix-js-sdk/src/oidc/error.ts");let No=function(e){return e.InvalidQueryParameters="Invalid query parameters for OIDC native login. `code` and `state` are required.",e}({});const Do=e=>{switch(e.message){case Zo.x.MissingOrInvalidStoredState:return(0,l._t)("auth|oidc|missing_or_invalid_stored_state");case No.InvalidQueryParameters:case Zo.x.CodeExchangeFailed:case Zo.x.InvalidBearerTokenResponse:case Zo.x.InvalidIdToken:default:return(0,l._t)("auth|oidc|generic_auth_error")}},Mo=async(e,t,i,n,s)=>{const o=window.location.origin,a=(0,To.O1)(10),r=s?"create":void 0,l=await(0,Po.kx)({metadata:e.metadata,redirectUri:o,clientId:t,homeserverUrl:i,identityServerUrl:n,nonce:a,prompt:r});window.location.href=l},Oo=async e=>{const{code:t,state:i}=(e=>{const t=e.code,i=e.state;if(!t||"string"!=typeof t||!i||"string"!=typeof i)throw new Error(No.InvalidQueryParameters);return{code:t,state:i}})(e),{homeserverUrl:n,tokenResponse:s,idTokenClaims:o,identityServerUrl:a,oidcClientSettings:r}=await(0,Po.iM)(t,i);return{homeserverUrl:n,identityServerUrl:a,accessToken:s.access_token,refreshToken:s.refresh_token,clientId:r.clientId,issuer:r.issuer,idTokenClaims:o}};var Ao=i("../matrix-react-sdk/src/utils/oidc/persistOidcSettings.ts"),Lo=i("../matrix-js-sdk/src/crypto/aes.ts");const Uo="mx_access_token",Fo="mx_refresh_token",Bo="access_token",Vo="refresh_token",jo="mx_has_access_token",zo="mx_has_refresh_token";async function Wo(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);const i=await window.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await window.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},i,256))}const Ho=e=>!!e&&"string"!=typeof e;async function Go(e,t,i){if(e&&Ho(t)){const n=await Wo(e),s=await(0,Lo.gy)(t,n,i);return n.fill(0),s}if("string"==typeof t)return t}async function Ko(e,t,i,n,s){if(i?localStorage.setItem(s,"true"):localStorage.removeItem(s),n){let s;if(i)try{const e=await Wo(n);s=await(0,Lo.mA)(i,e,t),e.fill(0)}catch(t){r.k.warn(`Could not encrypt token for ${e}`,t)}try{await A.tG("account",e,s||i)}catch(t){i?localStorage.setItem(e,i):localStorage.removeItem(e)}}else try{await A.tG("account",e,i)}catch(t){i?localStorage.setItem(e,i):localStorage.removeItem(e)}}async function qo(e,t){return Ko(Uo,Bo,e,t,jo)}async function $o(e,t){return Ko(Fo,Vo,e,t,zo)}class Jo extends n.OidcTokenRefresher{constructor(e,t,i,n,s,o){super(e,t,n,i,s),this.userId=o,(0,k.Z)(this,"deviceId",void 0),this.deviceId=n}async persistTokens({accessToken:e,refreshToken:t}){var i,n;const s=null!==(i=await(null===(n=a.Z.get())||void 0===n?void 0:n.getPickleKey(this.userId,this.deviceId)))&&void 0!==i?i:void 0;await qo(e,s),await $o(t,s)}}const Yo=["roomId"],Qo="mx_hs_url",Xo="mx_is_url";x.ZP.register((e=>{if(e.action===W.a.TriggerLogout)wa();else if(e.action===W.a.OverwriteLogin){ua(e.credentials,!0)}}));let ea=!1;function ta(){if(ea)throw new ia("session lock has been released")}class ia extends Error{}async function na(e={}){try{let t=e.enableGuest||!1;const i=e.guestHsUrl,s=e.guestIsUrl,o=e.fragmentQueryParams||{},a=e.defaultDeviceDisplayName;if(t&&!i&&(r.k.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&i&&o.guest_user_id&&o.guest_access_token)return r.k.log("Using guest access credentials"),ua({userId:o.guest_user_id,accessToken:o.guest_access_token,homeserverUrl:i,identityServerUrl:s,guest:!0},!0).then((()=>!0));return!!await ma({ignoreGuest:Boolean(e.ignoreGuest)})||!ea&&(!(!t||!i)&&function(e,t,i){r.k.log(`Doing guest login on ${e}`);const s=(0,n.createClient)({baseUrl:e});return s.registerGuest({body:{initial_device_display_name:i}}).then((i=>(r.k.log(`Registered as guest: ${i.user_id}`),ua({userId:i.user_id,deviceId:i.device_id,accessToken:i.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0).then((()=>!0)))),(e=>(r.k.error("Failed to register as guest",e),!1)))}(i,s,a))}catch(e){return!(e instanceof ga)&&(!ea&&async function(e){r.k.error("Unable to load session",e);const t=T.ZP.createDialog(vt,{error:e}),[i]=await t.finished;if(i)return await Sa(),!1;return na()}(e))}}async function sa(){const{hsUrl:e,userId:t,hasAccessToken:i,isGuest:n}=await ca();return e&&t&&i?[t,!!n]:[null,null]}async function oa(e,t,i){return e.code&&e.state?(console.log("We have OIDC params - attempting OIDC login"),async function(e){try{const{accessToken:t,refreshToken:i,homeserverUrl:s,identityServerUrl:o,idTokenClaims:a,clientId:l,issuer:c}=await Oo(e),{user_id:d,device_id:m,is_guest:h}=await async function(e,t,i){try{const s=(0,n.createClient)({baseUrl:t,accessToken:e,idBaseUrl:i});return await s.whoami()}catch(e){throw r.k.error("Failed to retrieve userId using accessToken",e),new Error("Failed to retrieve userId using accessToken")}}(t,s,o),p={accessToken:t,refreshToken:i,homeserverUrl:s,identityServerUrl:o,deviceId:m,userId:d,isGuest:h};return r.k.debug("Logged in via OIDC native flow"),await aa(p),(0,Ao.vs)(l,c,a),!0}catch(e){return r.k.error("Failed to login via OIDC",e),await ra(Do(e)),!1}}(e)):function(e,t,i){var s;if(!e.loginToken)return Promise.resolve(!1);console.log("We have token login params - attempting token login");const o=localStorage.getItem(tt.lc),c=null!==(s=localStorage.getItem(tt.xV))&&void 0!==s?s:void 0;if(!o)return r.k.warn("Cannot log in with token: can't determine HS URL to use"),ra((0,l._t)("auth|sso_failed_missing_storage")),Promise.resolve(!1);return O(o,c,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((async function(e){return r.k.log("Logged in with token"),await aa(e),!0})).catch((e=>{const t=()=>{var e;const t=(0,n.createClient)({baseUrl:o,idBaseUrl:c}),s=localStorage.getItem(tt.NF)||void 0;null===(e=a.Z.get())||void 0===e||e.startSingleSignOn(t,"sso",i,s,n.SSOAction.LOGIN)};return ra((0,Io.$E)(e,{hsUrl:o,hsName:o}),t),r.k.error("Failed to log in with login token:",e),!1}))}(e,t,i)}async function aa(e){await Sa(),await va(e),sessionStorage.setItem("mx_fresh_login",String(!0))}async function ra(e,t){T.ZP.createDialog(dt.Z,{title:(0,l._t)("auth|oidc|error_title"),description:e,button:(0,l._t)("action|try_again"),onFinished:t?e=>e&&t():void 0})}async function la(e){let t;try{t=await A.l8("account",e)}catch(t){r.k.error(`StorageManager.idbLoad failed for account:${e}`,t)}var i;if(!t&&(t=null!==(i=localStorage.getItem(e))&&void 0!==i?i:void 0,t))try{await A.tG("account",e,t),localStorage.removeItem(e)}catch(t){r.k.error(`migration of token ${e} to IndexedDB failed`,t)}return t}async function ca(){var e,t,i,n;const s=null!==(e=localStorage.getItem(Qo))&&void 0!==e?e:void 0,o=null!==(t=localStorage.getItem(Xo))&&void 0!==t?t:void 0,a=await la(Uo),r=await la(Fo),l="true"===localStorage.getItem(jo)||!!a,c="true"===localStorage.getItem(zo)||!!r,d=null!==(i=localStorage.getItem("mx_user_id"))&&void 0!==i?i:void 0,m=null!==(n=localStorage.getItem("mx_device_id"))&&void 0!==n?n:void 0;let h;return h=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:s,isUrl:o,hasAccessToken:l,accessToken:a,refreshToken:r,hasRefreshToken:c,userId:d,deviceId:m,isGuest:h}}async function da(){if(await async function(){const{finished:e}=T.ZP.createDialog(_t),[t]=await e;return!!t}())throw await Sa(),new ga("Aborting login in progress because of storage inconsistency")}async function ma(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:i,isUrl:n,hasAccessToken:s,accessToken:o,refreshToken:d,userId:m,deviceId:h,isGuest:p}=await ca();if(s&&!o&&await da(),o&&m&&i){var u,g;if(t&&p)return r.k.log("Ignoring stored guest account: "+m),!1;const e=null!==(u=await(null===(g=a.Z.get())||void 0===g?void 0:g.getPickleKey(m,null!=h?h:"")))&&void 0!==u?u:void 0;e?r.k.log("Got pickle key"):r.k.log("No pickle key available");const s=await Go(e,o,Bo),v=await Go(e,d,Vo),_="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),r.k.log(`Restoring session for ${m}`),await ua({userId:m,deviceId:h,accessToken:s,refreshToken:v,homeserverUrl:i,identityServerUrl:n,guest:p,pickleKey:null!=e?e:void 0,freshLogin:_},!1),async function(){var e;null===(e=E.p.get())||void 0===e||e.getVersions().then((e=>{if(!e.versions.includes(f.I)){const e="LEGACY_SERVER";F.Z.sharedInstance().addOrReplaceToast({key:e,title:(0,l._t)("unsupported_server_title"),props:{description:(0,l._t)("unsupported_server_description",{version:f.I,brand:c.ZP.get().brand}),acceptLabel:(0,l._t)("action|ok"),onAccept:()=>{F.Z.sharedInstance().dismissToast(e)}},component:z.Z,priority:98})}}))}(),!0}return r.k.log("No previous session found."),!1}async function ha(e){var t;e.freshLogin=!0,Ca();const i=e.userId&&e.deviceId?await(null===(t=a.Z.get())||void 0===t?void 0:t.createPickleKey(e.userId,e.deviceId)):null;return i?r.k.log("Created pickle key"):r.k.log("Pickle key not created"),ua(Object.assign({},e,{pickleKey:i}),!0)}async function pa(e){const t=E.p.safeGet().getUserId(),i=E.p.safeGet().getDeviceId();Ca(),localStorage.removeItem("mx_soft_logout"),_a=!1;const n=e.userId!==t||e.deviceId!==i;var s,o;(n&&r.k.warn("Clearing all data: Old session belongs to a different user/session"),e.pickleKey||void 0===e.deviceId)||(r.k.info("Lifecycle#hydrateSession: Pickle key not provided - trying to get one"),e.pickleKey=null!==(s=await(null===(o=a.Z.get())||void 0===o?void 0:o.getPickleKey(e.userId,e.deviceId)))&&void 0!==s?s:void 0);return ua(e,n)}async function ua(e,t){ta(),e.guest=Boolean(e.guest);const i=ya();r.k.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+i," freshLogin: "+e.freshLogin),t&&await Sa();const n=await A.yi();n.dataInLocalStorage&&n.cryptoInited&&!n.dataInCryptoStore&&await da();const s=await async function(e){if(!e.refreshToken)return;const t=(0,Ao.iL)();if(t)try{const i=(0,Ao.ci)(),n=(0,Ao.t9)(),s=window.location.origin,o=e.deviceId;if(!o)throw new Error("Expected deviceId in user credentials.");const a=new Jo({issuer:t},i,s,o,n,e.userId);return await a.oidcClientReady,a}catch(e){r.k.error("Failed to initialise OIDC token refresher",e)}}(e);ta(),E.p.replaceUsingCreds(e,null==s?void 0:s.doRefreshAccessToken.bind(s));const o=E.p.safeGet();if((0,ft.Tv)(e.userId),rt.S.instance.isEnabled()&&rt.S.instance.startListeningToSettingsChanges(o),e.freshLogin&&L.C.getValue("feature_dehydration")){const t=await o.rehydrateDevice();t&&(e.deviceId=t),delete e.freshLogin}if(localStorage)try{await va(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){r.k.warn("Error using local storage: can't persist session!",e)}else r.k.warn("No local storage available: can't persist session!");return ta(),x.ZP.fire(W.a.OnLoggedIn),await ba(o,!i),o}class ga extends Error{}async function va(e){var t;localStorage.setItem(Qo,e.homeserverUrl),e.identityServerUrl&&localStorage.setItem(Xo,e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),await qo(e.accessToken,e.pickleKey),await $o(e.refreshToken,e.pickleKey),e.pickleKey?localStorage.setItem("mx_has_pickle_key",String(!0)):"true"===localStorage.getItem("mx_has_pickle_key")&&r.k.error("Expected a pickle key, but none provided.  Encryption may not work."),e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=y.Z.persistCredentials)||void 0===t||t.call(y.Z,e),r.k.log(`Session persisted for ${e.userId}`)}let _a=!1;function fa(e){var t,i;const n=E.p.get();n&&(rt.S.instance.logout(),n.isGuest()?setImmediate((()=>wa())):(_a=!0,null===(t=a.Z.get())||void 0===t||t.destroyPickleKey(n.getSafeUserId(),null!==(i=n.getDeviceId())&&void 0!==i?i:""),async function(e,t){if(null!=t&&t.isUserAuthenticatedWithOidc){var i,n;const s=null!==(i=e.getAccessToken())&&void 0!==i?i:void 0,o=null!==(n=e.getRefreshToken())&&void 0!==n?n:void 0;await t.revokeTokens(s,o)}else await e.logout(!0)}(n,e).then(wa,(e=>{r.k.warn("Failed to call logout API: token will not be invalidated",e),wa()}))))}function Ea(){E.p.get()&&(localStorage.setItem("mx_soft_logout","true"),r.k.log("Soft logout initiated"),_a=!0,x.ZP.dispatch({action:"on_client_not_viable"}),Ca(!1))}function ya(){return"true"===localStorage.getItem("mx_soft_logout")}async function ba(e,t=!0){r.k.log("Lifecycle: Starting MatrixClient"),x.ZP.dispatch({action:"will_start_client"},!0),ie.m.instance.typingStore.reset(),F.Z.sharedInstance().reset(),xo.instance.prepare(e),S.default.start(),C.Z.sharedInstance().start(),P.Z.makeShared(e).start(),B.B.sharedInstance().startWatching(),Z.Z.instance.start(),lt.ZP.instance.start(),V.x.sharedInstance().start(),t?(await b.Z.init(),await E.p.start()):(r.k.warn("Caller requested only auxiliary services be started"),await E.p.assign()),ta(),L.C.runMigrations(),Xe.sharedInstance().start(e),L.C.getValue("lowBandwidth")||I.start(),et.b.getInstance().start(),x.ZP.dispatch({action:"client_started"}),ya()&&Ea()}async function wa(){var e,t;x.ZP.fire(W.a.OnLoggedOut,!0),Ca(),await Sa({deleteEverything:!0}),null===(e=ct.onLoggedOutAndStorageCleared)||void 0===e||e.call(ct),await(null===(t=a.Z.get())||void 0===t?void 0:t.clearStorage()),c.ZP.get().logout_redirect_url&&(r.k.log("Redirecting to external provider to finish logout"),window.setTimeout((()=>{window.location.href=c.ZP.get().logout_redirect_url}),100)),_a=!1}async function Sa(e){var t;if(window.localStorage){const t=L.C.getValueAt(U.R.DEVICE,"language",null,!0,!0),i=at.instance.getWireInvites(),n=window.localStorage.getItem("mx_registration_time");window.localStorage.clear(),Ro.Z.clear();try{await A._6("account",Uo)}catch(e){r.k.error("idbDelete failed for account:mx_access_token",e)}null!=e&&e.deleteEverything||(t&&await L.C.setValue("language",null,U.R.DEVICE,t),i.forEach((e=>{let{roomId:t}=e,i=(0,v.Z)(e,Yo);at.instance.storeInvite(t,i)})),n&&window.localStorage.setItem("mx_registration_time",n))}null===(t=window.sessionStorage)||void 0===t||t.clear();const i=(0,w.Z)({baseUrl:""});await b.Z.deleteEventIndex(),await i.clearStores()}function Ca(e=!0){var t;S.default.stop(),lt.ZP.instance.stop(),C.Z.sharedInstance().stop(),ie.m.instance.typingStore.reset(),I.stop(),Z.Z.instance.stop(),B.B.sharedInstance().stopWatching(),V.x.sharedInstance().stop(),Xe.sharedInstance().stop(),null===(t=P.Z.shared())||void 0===t||t.stop(),b.Z.stop();const i=E.p.get();i&&(i.stopClient(),i.removeAllListeners(),e&&(E.p.unset(),b.Z.unset(),i.store.destroy()))}window.mxLoginWithAccessToken=async(e,t)=>{const i=(0,n.createClient)({baseUrl:e,accessToken:t}),{user_id:s}=await i.whoami();await ua({homeserverUrl:e,accessToken:t,userId:s},!0)};var ka=i("../matrix-react-sdk/src/utils/SnakedObject.ts"),xa=i("../matrix-js-sdk/src/utils.ts"),Ra=(i("../matrix-react-sdk/node_modules/what-input/dist/what-input.js"),i("../matrix-react-sdk/src/RoomInvite.tsx")),Ia=i("../matrix-react-sdk/src/Rooms.ts"),Pa=i("../matrix-react-sdk/src/stores/AsyncStore.ts");const Ta={deferredAction:null};class Za extends Pa.W{constructor(){super(x.ZP,Ta)}onDispatch(e){switch(e.action){case W.a.DoAfterSyncPrepared:this.updateState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.updateState({deferredAction:null});break;case"MatrixActions.sync":{if("PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.updateState({deferredAction:null}),x.ZP.dispatch(t);break}case"on_client_not_viable":case W.a.OnLoggedOut:this.reset()}}}let Na=null;Na||(Na=new Za);var Da,Ma=i("../matrix-react-sdk/src/rageshake/submit-rageshake.ts"),Oa=i("../matrix-react-sdk/src/stores/AsyncStoreWithClient.ts");function Aa(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function La(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Aa(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Aa(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Ua="im.vector.auto_rs_request";class Fa extends Oa._{constructor(){super(x.ZP,{reportedSessionIds:new Set,lastRageshakeTime:0,initialSyncCompleted:!1}),this.onDecryptionAttempt=this.onDecryptionAttempt.bind(this),this.onDeviceMessage=this.onDeviceMessage.bind(this),this.onSyncStateChange=this.onSyncStateChange.bind(this)}static get instance(){return Fa.internalInstance}async onAction(e){if(e.action===W.a.ReportKeyBackupNotEnabled)this.onReportKeyBackupNotEnabled()}async onReady(){L.C.getValue("automaticDecryptionErrorReporting")&&this.matrixClient&&(this.matrixClient.on(n.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.on(n.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.on(n.ClientEvent.Sync,this.onSyncStateChange))}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(n.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.removeListener(n.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.removeListener(n.ClientEvent.Sync,this.onSyncStateChange))}async onDecryptionAttempt(e){if(!this.state.initialSyncCompleted)return;const t=e.getWireContent(),i=t.session_id;if(e.isDecryptionFailure()&&!this.state.reportedSessionIds.has(i)){var n;if(await(0,xa._v)(5e3),!e.isDecryptionFailure())return;const s=new Set(this.state.reportedSessionIds);await this.updateState({reportedSessionIds:s.add(i)});const o=(new Date).getTime();if(o-this.state.lastRageshakeTime<6e4)return;await this.updateState({lastRageshakeTime:o});const a={event_id:e.getId(),room_id:e.getRoomId(),session_id:i,device_id:t.device_id,user_id:e.getSender(),sender_key:t.sender_key},r=await(0,Ma.ZP)(c.ZP.get().bug_report_endpoint_url,{userText:"Auto-reporting decryption error (recipient)",sendLogs:!0,labels:["Z-UISI","web","uisi-recipient"],customApp:c.ZP.get().uisi_autorageshake_app,customFields:{auto_uisi:JSON.stringify(a)}}),l=La(La({},a),{},{recipient_rageshake:r});null===(n=this.matrixClient)||void 0===n||n.sendToDevice(Ua,new Map([["messageContent.user_id",new Map([[l.device_id,l]])]]))}}async onSyncStateChange(e,t,i){this.state.initialSyncCompleted||await this.updateState({initialSyncCompleted:!(null==i||!i.nextSyncToken)})}async onDeviceMessage(e){if(e.getType()!==Ua)return;const t=e.getContent(),i=t.recipient_rageshake||"",n=(new Date).getTime();n-this.state.lastRageshakeTime>6e4&&(await this.updateState({lastRageshakeTime:n}),await(0,Ma.ZP)(c.ZP.get().bug_report_endpoint_url,{userText:`Auto-reporting decryption error (sender)\nRecipient rageshake: ${i}`,sendLogs:!0,labels:["Z-UISI","web","uisi-sender"],customApp:c.ZP.get().uisi_autorageshake_app,customFields:{recipient_rageshake:i,auto_uisi:JSON.stringify(t)}}))}async onReportKeyBackupNotEnabled(){L.C.getValue("automaticKeyBackNotEnabledReporting")&&await(0,Ma.ZP)(c.ZP.get().bug_report_endpoint_url,{userText:"Auto-reporting key backup not enabled",sendLogs:!0,labels:["web",W.a.ReportKeyBackupNotEnabled]})}}Da=Fa,(0,k.Z)(Fa,"internalInstance",(()=>{const e=new Da;return e.start(),e})()),window.mxAutoRageshakeStore=Fa.instance;var Ba=i("../matrix-react-sdk/src/PageTypes.ts"),Va=i("../matrix-react-sdk/src/settings/controllers/ThemeController.ts");const ja=/^[a-z0-9=_\-./]+$/;class za extends Y.EventEmitter{constructor(...e){super(...e),(0,k.Z)(this,"_isResizing",!1),(0,k.Z)(this,"throttledMiddlePanel",(0,ln.throttle)((()=>this.emit("middlePanelResized")),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}var Wa=i("../matrix-react-sdk/src/settings/watchers/ThemeWatcher.ts"),Ha=i("../matrix-react-sdk/src/settings/watchers/FontWatcher.ts"),Ga=i("../matrix-react-sdk/src/RoomAliasCache.ts"),Ka=i("../matrix-react-sdk/src/MediaDeviceHandler.ts"),qa=i("../matrix-react-sdk/src/utils/FontManager.ts");const $a=({vertical:e,reverse:t,id:i,passRef:n})=>{const s=["mx_ResizeHandle"];return e?s.push("mx_ResizeHandle--vertical"):s.push("mx_ResizeHandle--horizontal"),t&&s.push("mx_ResizeHandle_reverse"),o.createElement("div",{ref:n,className:s.join(" "),"data-id":i},o.createElement("div",null))};class Ja{constructor(e,t,i,n){this.resizer=t,this.sizer=i,this.container=n,(0,k.Z)(this,"domNode",void 0),(0,k.Z)(this,"id",void 0),(0,k.Z)(this,"reverse",void 0),this.reverse=t.isReverseResizeHandle(e),this.domNode=n||(this.reverse?e.nextElementSibling:e.previousElementSibling),this.id=e.getAttribute("data-id")}copyWith(e,t,i,n){return new(0,this.constructor)(e,t,i,n)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const i=e!==this.reverse;do{var n,s;if(i)t=null===(n=t)||void 0===n?void 0:n.nextElementSibling;else t=null===(s=t)||void 0===s?void 0:s.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){var t,i;this.setRawSize(`${Math.round(e)}px`),null===(t=this.resizer.config)||void 0===t||null===(i=t.onResized)||void 0===i||i.call(t,e,this.id,this.domNode)}clearSize(){var e,t;this.sizer.clearItemSize(this.domNode),null===(e=this.resizer.config)||void 0===e||null===(t=e.onResized)||void 0===t||t.call(e,null,this.id,this.domNode)}first(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}last(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).reverse().find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}}class Ya{constructor(e,t,i){this.container=e,this.vertical=t,this.reverse=i}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.removeProperty("height"):e.style.removeProperty("width")}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}class Qa{static createSizer(e,t,i){return new Ya(e,t,i)}constructor(e){this.item=e,(0,k.Z)(this,"beforeOffset",void 0),this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}class Xa extends Qa{static createItem(e,t,i){return new Ja(e,t,i)}}class er extends Ja{notifyCollapsed(e){var t,i;null===(t=this.resizer.config)||void 0===t||null===(i=t.onCollapsed)||void 0===i||i.call(t,e,this.id,this.domNode)}get isCollapsed(){var e,t,i;return null!==(e=null===(t=this.resizer.config)||void 0===t||null===(i=t.isItemCollapsed)||void 0===i?void 0:i.call(t,this.domNode))&&void 0!==e&&e}}class tr extends Qa{static createItem(e,t,i,n){return new er(e,t,i,n)}constructor(e){var t,i;super(e),(0,k.Z)(this,"toggleSize",void 0),(0,k.Z)(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(i=t.config)||void 0===i?void 0:i.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=!!this.toggleSize&&e<this.toggleSize;t!==this.isCollapsed&&(this.isCollapsed=t,this.item.notifyCollapsed(t)),t||super.resize(e)}}class ir{constructor(e,t,i){this.container=e,this.distributorCtor=t,this.config=i,(0,k.Z)(this,"classNames",void 0),(0,k.Z)(this,"onMouseDown",(e=>{var t,i,n;if(0!==e.button)return;const s=e.target&&e.target.closest(`.${this.classNames.handle}`),o=null==this||null===(t=this.config)||void 0===t?void 0:t.handler;if(!s||!o&&s.parentElement!==this.container||o&&s!==o)return;var a,r;(e.preventDefault(),this.classNames.resizing)&&(null===(a=this.container)||void 0===a||null===(r=a.classList)||void 0===r||r.add(this.classNames.resizing));null===(i=this.config)||void 0===i||null===(n=i.onResizeStart)||void 0===n||n.call(i);const{sizer:l,distributor:c}=this.createSizerAndDistributor(s);c.start();const d=e=>{const t=l.offsetFromEvent(e);c.resizeFromContainerOffset(t)},m=document.body,h=()=>{var e,t,i,n;this.classNames.resizing&&(null===(i=this.container)||void 0===i||null===(n=i.classList)||void 0===n||n.remove(this.classNames.resizing));c.finish(),null===(e=this.config)||void 0===e||null===(t=e.onResizeStop)||void 0===t||t.call(e),m.removeEventListener("mouseup",h,!1),document.removeEventListener("mouseleave",h,!1),m.removeEventListener("mousemove",d,!1)};m.addEventListener("mouseup",h,!1),document.addEventListener("mouseleave",h,!1),m.addEventListener("mousemove",d,!1)})),(0,k.Z)(this,"onResize",(0,ln.throttle)((()=>{const e=this.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}),100,{trailing:!0,leading:!0})),(0,k.Z)(this,"getDistributors",(()=>this.getResizeHandles().map((e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})))),this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){var e,t,i;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(i=t.handler)||void 0===i?void 0:i.parentElement)&&void 0!==e?e:this.container;null==n||n.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){var e,t,i;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(i=t.handler)||void 0===i?void 0:i.parentElement)&&void 0!==e?e:this.container;null==n||n.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find((t=>t.getAttribute("data-id")===e));if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){var t;const i=e.classList.contains(this.classNames.vertical),n=this.isReverseResizeHandle(e),s=this.distributorCtor,o=null!==(t=this.config)&&void 0!==t&&t.handler?this.container:void 0,a=s.createSizer(this.container,i,n),r=s.createItem(e,this,a,null!=o?o:void 0);return{sizer:a,distributor:new s(r)}}getResizeHandles(){var e,t;return null!=this&&null!==(e=this.config)&&void 0!==e&&e.handler?[this.config.handler]:null!==(t=this.container)&&void 0!==t&&t.children?Array.from(this.container.querySelectorAll(`.${this.classNames.handle}`)):[]}}var nr=i("../matrix-react-sdk/src/stores/room-list/models.ts");const sr="serverlimit",or=()=>{F.Z.sharedInstance().dismissToast(sr)};var ar=i("../matrix-react-sdk/src/components/views/rooms/RoomList.tsx"),rr=i("../matrix-react-sdk/src/components/views/rooms/RoomSublist.tsx");class lr extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"onAction",(e=>{"focus_room_filter"===e.action&&this.openSpotlight()})),this.dispatcherRef=x.ZP.register(this.onAction)}componentWillUnmount(){x.ZP.unregister(this.dispatcherRef)}openSpotlight(){x.ZP.fire(W.a.OpenSpotlight)}render(){const e=yt()({mx_RoomSearch:!0,mx_RoomSearch_minimized:this.props.isMinimized},"mx_RoomSearch_spotlightTrigger"),t=o.createElement("div",{className:"mx_RoomSearch_icon"}),i=o.createElement("kbd",{className:"mx_RoomSearch_shortcutPrompt"},en.Mq?"â K":(0,l._t)(tn.nk[en.sr.CONTROL])+" K");return o.createElement(ae.Z,{onClick:this.openSpotlight,className:e},t,!this.props.isMinimized&&o.createElement("div",{className:"mx_RoomSearch_spotlightTriggerText"},(0,l._t)("action|search")),i)}}var cr=i("../matrix-react-sdk/src/stores/spaces/index.ts"),dr=i("../matrix-react-sdk/src/KeyBindingsManager.ts"),mr=i("../matrix-react-sdk/src/stores/UIStore.ts"),hr=i("../matrix-react-sdk/src/customisations/helpers/UIComponents.ts"),pr=i("../matrix-react-sdk/src/components/views/beta/BetaCard.tsx"),ur=i("../matrix-react-sdk/src/components/views/context_menus/IconizedContextMenu.tsx");const gr=["space","hideHeader","onFinished"],vr=e=>{let{space:t,hideHeader:i,onFinished:s}=e,a=(0,v.Z)(e,gr);const r=(0,o.useContext)(pn.ZP).getSafeUserId(),c=(0,wt.n)("feature_video_rooms"),d=(0,wt.n)("feature_element_call_video_rooms");if(!t)return null;let m=null;if("public"===t.getJoinRule()||t.canInvite(r)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,ko.N2)(t),s()};m=o.createElement(ur.$k,{"data-testid":"invite-option",className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:(0,l._t)("action|invite"),onClick:e})}let h=null,p=null;if((0,ko.PS)(t)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,ko.qS)(t),s()};h=o.createElement(ur.$k,{"data-testid":"settings-option",iconClassName:"mx_SpacePanel_iconSettings",label:(0,l._t)("common|settings"),onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),(0,oo.b)(t),s()};p=o.createElement(ur.$k,{"data-testid":"leave-option",iconClassName:"mx_SpacePanel_iconLeave",className:"mx_IconizedContextMenu_option_red",label:(0,l._t)("space|leave_dialog_action"),onClick:e})}let u=null;if(L.C.getValue("developerMode")){const e=e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:W.a.ViewRoom,room_id:t.roomId,forceTimeline:!0,metricsTrigger:void 0}),s()};u=o.createElement(ur.$k,{iconClassName:"mx_SpacePanel_iconSettings",label:(0,l._t)("space|context_menu|devtools_open_timeline"),onClick:e})}const g=t.currentState.maySendStateEvent(n.EventType.SpaceChild,r),_=g&&(0,hr.I)(Ye.y.CreateRooms),f=_&&c,E=g&&(0,hr.I)(Ye.y.CreateSpaces);let y=null;if(_||E){const e=e=>{e.preventDefault(),e.stopPropagation(),kn.Z.trackInteraction("WebSpaceContextMenuNewRoomItem",e),(0,ko.gS)(t),s()},i=e=>{e.preventDefault(),e.stopPropagation(),(0,ko.gS)(t,d?n.RoomType.UnstableCall:n.RoomType.ElementVideo),s()},a=e=>{e.preventDefault(),e.stopPropagation(),(0,ko.xR)(t),s()};y=o.createElement(o.Fragment,null,o.createElement("div",{"data-testid":"add-to-space-header",className:"mx_SpacePanel_contextMenu_separatorLabel"},(0,l._t)("action|add")),_&&o.createElement(ur.$k,{"data-testid":"new-room-option",iconClassName:"mx_SpacePanel_iconPlus",label:(0,l._t)("common|room"),onClick:e}),f&&o.createElement(ur.$k,{"data-testid":"new-video-room-option",iconClassName:"mx_SpacePanel_iconPlus",label:(0,l._t)("common|video_room"),onClick:i},o.createElement(pr.r,null)),E&&o.createElement(ur.$k,{"data-testid":"new-subspace-option",iconClassName:"mx_SpacePanel_iconPlus",label:(0,l._t)("common|space"),onClick:a},o.createElement(pr.r,null)))}const b=e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:W.a.ViewRoom,room_id:t.roomId,metricsTrigger:void 0}),s()};return o.createElement(ur.ZP,(0,kt.Z)({},a,{onFinished:s,className:"mx_SpacePanel_contextMenu",compact:!0}),!i&&o.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},t.name),o.createElement(ur.I2,{first:!0},o.createElement(ur.$k,{iconClassName:"mx_SpacePanel_iconHome",label:(0,l._t)("space|context_menu|home"),onClick:e=>{kn.Z.trackInteraction("WebSpaceContextMenuHomeItem",e),b(e)}}),m,o.createElement(ur.$k,{iconClassName:"mx_SpacePanel_iconExplore",label:_?(0,l._t)("space|context_menu|manage_and_explore"):(0,l._t)("space|context_menu|explore"),onClick:e=>{kn.Z.trackInteraction("WebSpaceContextMenuExploreRoomsItem",e),b(e)}}),o.createElement(ur.$k,{iconClassName:"mx_SpacePanel_iconPreferences",label:(0,l._t)("common|preferences"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ko.Fe)(t),s()}}),u,h,p,y))};var _r=i("../matrix-react-sdk/src/components/views/elements/InlineSpinner.tsx"),fr=i("../matrix-react-sdk/src/components/views/elements/TooltipTarget.tsx"),Er=i("../matrix-react-sdk/node_modules/react-beautiful-dnd/dist/react-beautiful-dnd.cjs.js"),yr=i("../matrix-react-sdk/src/components/views/spaces/SpaceCreateMenu.tsx");const br=(e,t)=>{let i="";if(t)for(const e of t.entries())i+=e+"/";return`mx_space_collapsed_${i+e}`};class wr{static get instance(){return wr.internalInstance||(wr.internalInstance=new wr),wr.internalInstance}setSpaceCollapsedState(e,t,i){localStorage.setItem(br(e,t),i.toString())}getSpaceCollapsedState(e,t,i){const n=localStorage.getItem(br(e,t));return n?"true"===n:i}}(0,k.Z)(wr,"internalInstance",void 0);var Sr=i("../matrix-react-sdk/src/stores/notifications/NotificationColor.ts");const Cr=["space","spaceKey","className","selected","label","contextMenuTooltip","notificationState","size","isNarrow","children","innerRef","ContextMenuComponent"],kr=["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef","dragHandleProps"],xr=["tabIndex"],Rr=e=>{var t;let{space:i,spaceKey:n,className:s,selected:a,label:r,contextMenuTooltip:c,notificationState:d,size:m,isNarrow:h,children:p,innerRef:u,ContextMenuComponent:g}=e,_=(0,v.Z)(e,Cr);const[f,E,y,b]=(0,ii.av)(u),[w,S]=(0,Gi.XZ)(E),C=S?0:-1,k=null!=n?n:null==i?void 0:i.roomId;let R,I,P=o.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},o.createElement("div",{className:"mx_SpaceButton_icon"}));if(i&&(P=o.createElement(ei.Z,{size:m,room:i,type:"square"})),k&&d){let e=(0,l._t)("a11y_jump_first_unread_room");"invite"===(null==i?void 0:i.getMyMembership())&&(e=(0,l._t)("a11y|jump_first_invite"));const t=e=>{e.stopPropagation(),e.preventDefault(),Rs.ZP.instance.setActiveRoomInSpace(k)};R=o.createElement("div",{className:"mx_SpacePanel_badgeContainer"},o.createElement(ai.Z,{onClick:t,forceCount:!1,notification:d,"aria-label":e,tabIndex:C,showUnsentTooltip:!0}))}f&&E.current&&g&&(I=o.createElement(g,(0,kt.Z)({},(0,ii.ip)(E.current.getBoundingClientRect(),0),{space:i,onFinished:b})));const T=null!==(t=_.onClick)&&void 0!==t?t:a&&i?()=>x.ZP.dispatch({action:W.a.ViewRoom,room_id:i.roomId}):()=>{k&&Rs.ZP.instance.setActiveSpace(k)};return o.createElement(gs.Z,(0,kt.Z)({},_,{className:yt()("mx_SpaceButton",s,{mx_SpaceButton_active:a,mx_SpaceButton_hasMenuOpen:f,mx_SpaceButton_narrow:h}),title:r,onClick:T,onContextMenu:y,forceHide:!h||f,inputRef:E,tabIndex:C,onFocus:w}),p,o.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},o.createElement("div",{className:"mx_SpaceButton_avatarWrapper"},P,R),!h&&o.createElement("span",{className:"mx_SpaceButton_name"},r),g&&o.createElement(dn.J,{className:"mx_SpaceButton_menuButton",onClick:y,title:c,isExpanded:f}),I))};class Ir extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"buttonRef",(0,o.createRef)()),(0,k.Z)(this,"onSpaceUpdate",(()=>{this.setState({childSpaces:this.childSpaces})})),(0,k.Z)(this,"onRoomNameChange",(()=>{this.setState({name:this.props.space.name})})),(0,k.Z)(this,"toggleCollapse",(e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;wr.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()})),(0,k.Z)(this,"onKeyDown",(e=>{var t;let i=!0;const n=(0,dr.zL)().getRoomListAction(e),s=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(n){case tn.vB.CollapseRoomListSection:if(s&&!this.isCollapsed)this.toggleCollapse(e);else{var o,a,r;const e=null===(o=this.buttonRef)||void 0===o||null===(a=o.current)||void 0===a||null===(r=a.parentElement)||void 0===r?void 0:r.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case tn.vB.ExpandRoomListSection:if(s)if(this.isCollapsed)this.toggleCollapse(e);else{var l,c,d;const e=null===(l=this.buttonRef)||void 0===l||null===(c=l.current)||void 0===c?void 0:c.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(d=t.querySelector(".mx_SpaceButton"))||void 0===d||d.focus()}break;default:i=!1}i&&(e.stopPropagation(),e.preventDefault())}));const t=wr.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={name:this.props.space.name,collapsed:t,childSpaces:this.childSpaces},Rs.ZP.instance.on(this.props.space.roomId,this.onSpaceUpdate),this.props.space.on(n.RoomEvent.Name,this.onRoomNameChange)}componentWillUnmount(){Rs.ZP.instance.off(this.props.space.roomId,this.onSpaceUpdate),this.props.space.off(n.RoomEvent.Name,this.onRoomNameChange)}get childSpaces(){return Rs.ZP.instance.getChildSpaces(this.props.space.roomId).filter((e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))}))}get isCollapsed(){return this.state.collapsed||!!this.props.isPanelCollapsed}render(){var e,t;const i=this.props,{space:n,activeSpaces:s,isNested:a,isPanelCollapsed:r,onExpand:c,parents:d,innerRef:m,dragHandleProps:h}=i,p=(0,v.Z)(i,kr),u=this.isCollapsed,g=yt()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:r,collapsed:u,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),_="invite"===n.getMyMembership(),f=_?oi.Z.forSymbol("!",Sr.v.Red):Rs.ZP.instance.getNotificationState(n.roomId),E=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;let y;E&&!u&&(y=o.createElement(Pr,{spaces:this.state.childSpaces,activeSpaces:s,isNested:!0,parents:new Set(d).add(n.roomId)}));const b=E?o.createElement(ae.Z,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":u?(0,l._t)("action|expand"):(0,l._t)("action|collapse")}):null,w=h||{},{tabIndex:S}=w,C=(0,v.Z)(w,xr),k=s.includes(n.roomId);return o.createElement("li",(0,kt.Z)({},p,{className:g,ref:m,"aria-expanded":E?!u:void 0,"aria-selected":k,role:"treeitem"}),o.createElement(Rr,(0,kt.Z)({},C,{space:n,className:_?"mx_SpaceButton_invite":void 0,selected:k,label:this.state.name,contextMenuTooltip:(0,l._t)("space|context_menu|options"),notificationState:f,isNarrow:r,size:a?"24px":"32px",onKeyDown:this.onKeyDown,ContextMenuComponent:"join"===this.props.space.getMyMembership()?vr:void 0}),b),y)}}(0,k.Z)(Ir,"contextType",pn.ZP);const Pr=({spaces:e,activeSpaces:t,isNested:i,parents:n})=>o.createElement("ul",{className:"mx_SpaceTreeLevel",role:"group"},e.map((e=>o.createElement(Ir,{key:e.roomId,activeSpaces:t,space:e,isNested:i,parents:n}))));var Tr,Zr=i("../matrix-react-sdk/src/stores/notifications/RoomNotificationStateStore.ts");function Nr(){return Nr=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Nr.apply(this,arguments)}function Dr(e,t){return o.createElement("svg",Nr({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),Tr||(Tr=o.createElement("path",{d:"M20.28 7.9l-7-5.833a2 2 0 00-2.56 0l-7 5.833A2 2 0 003 9.437V20.5a2 2 0 002 2h2a2 2 0 002-2V16a2 2 0 012-2h2a2 2 0 012 2v4.5a2 2 0 002 2h2a2 2 0 002-2V9.437a2 2 0 00-.72-1.537z",fill:"currentColor"})))}var Mr=o.forwardRef(Dr);var Or;function Ar(){return Ar=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Ar.apply(this,arguments)}function Lr(e,t){return o.createElement("svg",Ar({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Or||(Or=o.createElement("path",{d:"M8.414 1.432c.178-.576.994-.576 1.172 0l1.585 5.131h5.215c.586 0 .838.745.372 1.1l-4.244 3.243 1.604 5.194c.177.57-.483 1.03-.958.668L9 13.59l-4.16 3.178c-.475.363-1.135-.098-.959-.668l1.606-5.194-4.245-3.242c-.466-.356-.214-1.1.372-1.1H6.83l1.585-5.132z",fill:"currentColor"})))}var Ur=o.forwardRef(Lr);var Fr,Br,Vr;function jr(){return jr=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},jr.apply(this,arguments)}function zr(e,t){return o.createElement("svg",jr({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),Fr||(Fr=o.createElement("mask",{id:"members_svg__a",fill:"#fff"},o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M17.591 20.292A9.954 9.954 0 0112 22a9.956 9.956 0 01-6-2 9.985 9.985 0 01-4-8C2 6.477 6.477 2 12 2s10 4.477 10 10a9.99 9.99 0 01-4.409 8.292zM12 12.5c1.657 0 3-1.455 3-3.25S13.657 6 12 6 9 7.455 9 9.25s1.343 3.25 3 3.25zm0 7.5a7.974 7.974 0 005.563-2.251 6.002 6.002 0 00-11.126 0A7.973 7.973 0 0012 20z"}))),Br||(Br=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M17.591 20.292A9.954 9.954 0 0112 22a9.956 9.956 0 01-6-2 9.985 9.985 0 01-4-8C2 6.477 6.477 2 12 2s10 4.477 10 10a9.99 9.99 0 01-4.409 8.292zM12 12.5c1.657 0 3-1.455 3-3.25S13.657 6 12 6 9 7.455 9 9.25s1.343 3.25 3 3.25zm0 7.5a7.974 7.974 0 005.563-2.251 6.002 6.002 0 00-11.126 0A7.973 7.973 0 0012 20z",fill:"currentColor"})),Vr||(Vr=o.createElement("path",{d:"M17.591 20.292l-1.12-1.657 1.12 1.657zM6 20.001L4.799 21.6 6 20zm11.563-2.252l1.391 1.437.97-.938-.507-1.25-1.854.75zm-11.126 0l-1.854-.751-.506 1.25.969.938 1.39-1.437zM12 24c2.482 0 4.794-.756 6.71-2.05l-2.239-3.315A7.954 7.954 0 0112 20v4zm-7.201-2.4A11.956 11.956 0 0012 24v-4a7.955 7.955 0 01-4.799-1.598L4.8 21.6zM0 12c0 3.927 1.889 7.414 4.799 9.6L7.2 18.402A7.985 7.985 0 014 12H0zM12 0C5.373 0 0 5.373 0 12h4a8 8 0 018-8V0zm12 12c0-6.627-5.373-12-12-12v4a8 8 0 018 8h4zm-5.29 9.95A11.99 11.99 0 0024 12h-4a7.99 7.99 0 01-3.529 6.635l2.24 3.314zM13 9.25c0 .844-.595 1.25-1 1.25v4c2.91 0 5-2.504 5-5.25h-4zM12 8c.405 0 1 .406 1 1.25h4C17 6.504 14.91 4 12 4v4zm-1 1.25c0-.844.595-1.25 1-1.25V4C9.09 4 7 6.504 7 9.25h4zm1 1.25c-.405 0-1-.406-1-1.25H7c0 2.746 2.09 5.25 5 5.25v-4zm4.172 5.812A5.974 5.974 0 0112 18v4a9.973 9.973 0 006.954-2.814l-2.782-2.874zM12 16a4.002 4.002 0 013.71 2.5l3.707-1.502A8.002 8.002 0 0012 12v4zm-3.71 2.5A4.002 4.002 0 0112 16v-4a8.002 8.002 0 00-7.417 4.998L8.29 18.5zM12 18a5.974 5.974 0 01-4.172-1.688l-2.782 2.874A9.973 9.973 0 0012 22v-4z",fill:"currentColor",mask:"url(#members_svg__a)"})))}var Wr=o.forwardRef(zr);var Hr,Gr,Kr;function qr(){return qr=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},qr.apply(this,arguments)}function $r(e,t){return o.createElement("svg",qr({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Hr||(Hr=o.createElement("mask",{id:"hash-circle_svg__a",fill:"#fff"},o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M9 17A8 8 0 109 1a8 8 0 000 16zM8.34 5.156A.75.75 0 006.848 5l-.16 1.531H5.656a.75.75 0 000 1.5h.875L6.328 9.97h-.937a.75.75 0 000 1.5h.78l-.151 1.453a.75.75 0 101.492.156l.168-1.61H9.5l-.152 1.454a.75.75 0 101.492.156l.168-1.61h1.289a.75.75 0 000-1.5h-1.132l.202-1.937h.93a.75.75 0 000-1.5h-.773l.144-1.375A.75.75 0 1010.176 5l-.16 1.531h-1.82l.144-1.375zM9.657 9.97h-1.82l.202-1.938h1.82L9.657 9.97z"}))),Gr||(Gr=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M9 17A8 8 0 109 1a8 8 0 000 16zM8.34 5.156A.75.75 0 006.848 5l-.16 1.531H5.656a.75.75 0 000 1.5h.875L6.328 9.97h-.937a.75.75 0 000 1.5h.78l-.151 1.453a.75.75 0 101.492.156l.168-1.61H9.5l-.152 1.454a.75.75 0 101.492.156l.168-1.61h1.289a.75.75 0 000-1.5h-1.132l.202-1.937h.93a.75.75 0 000-1.5h-.773l.144-1.375A.75.75 0 1010.176 5l-.16 1.531h-1.82l.144-1.375zM9.657 9.97h-1.82l.202-1.938h1.82L9.657 9.97z",fill:"currentColor"})),Kr||(Kr=o.createElement("path",{d:"M7.672 4.332l-.139 1.326.139-1.326zm.668.824l1.326.139-1.326-.139zM6.848 5l-1.326-.138L6.848 5zm-.16 1.531v1.334h1.201l.125-1.195-1.326-.139zm-.157 1.5l1.326.139.154-1.472H6.53v1.333zM6.328 9.97v1.333H7.53l.125-1.195-1.327-.138zm-.156 1.5l1.326.138.154-1.471h-1.48v1.333zm-.152 1.453l-1.326-.139 1.326.14zm.668.824l.138-1.326-.138 1.326zm.824-.668l1.326.139-1.326-.139zm.168-1.61v-1.332H6.479l-.125 1.194 1.326.139zm1.82 0l1.326.14.154-1.473H9.5v1.334zm-.152 1.454l1.326.139-1.326-.139zm.668.824l.138-1.326-.138 1.326zm.824-.668l1.326.139-1.326-.139zm.168-1.61v-1.332H9.807l-.125 1.194 1.326.139zm.157-1.5L9.839 9.83l-.154 1.472h1.48V9.97zm.202-1.937V6.698h-1.201l-.125 1.195 1.326.138zm.157-1.5l-1.326-.138-.154 1.472h1.48V6.53zm.144-1.375l-1.326-.138 1.326.138zM11 4.332l.139-1.326-.14 1.326zM10.176 5L8.85 4.862 10.176 5zm-.16 1.531v1.334h1.201l.125-1.195-1.326-.139zm-1.82 0L6.87 6.393l-.154 1.472h1.48V6.53zm-.36 3.438L6.51 9.83l-.153 1.472h1.48V9.97zm1.82 0v1.333h1.202l.125-1.195-1.326-.138zM8.04 8.03V6.698H6.838l-.125 1.195 1.326.138zm1.82 0l1.326.139.154-1.472H9.86v1.333zM15.667 9A6.667 6.667 0 019 15.667v2.666A9.333 9.333 0 0018.333 9h-2.666zM9 2.333A6.667 6.667 0 0115.667 9h2.666A9.333 9.333 0 009-.333v2.666zM2.333 9A6.667 6.667 0 019 2.333V-.333A9.333 9.333 0 00-.333 9h2.666zM9 15.667A6.667 6.667 0 012.333 9H-.333A9.333 9.333 0 009 18.333v-2.666zM7.533 5.658a.583.583 0 01-.52-.64l2.653.277A2.083 2.083 0 007.81 3.006l-.277 2.652zm.64-.52a.583.583 0 01-.64.52l.277-2.652a2.083 2.083 0 00-2.288 1.856l2.652.277zm-.16 1.532l.16-1.531-2.651-.277-.16 1.53 2.652.278zM5.657 7.865h1.032V5.198H5.656v2.667zm.584-.584a.583.583 0 01-.584.584V5.198c-1.15 0-2.083.933-2.083 2.083H6.24zm-.584-.583c.322 0 .584.261.584.583H3.573c0 1.15.933 2.084 2.083 2.084V6.698zm.875 0h-.875v2.667h.875V6.698zm1.124 3.41l.202-1.938-2.652-.277-.203 1.937 2.653.277zM5.39 11.301h.937V8.635h-.937v2.667zm.583-.583a.583.583 0 01-.583.583V8.635c-1.151 0-2.084.933-2.084 2.084h2.667zm-.583-.583c.322 0 .583.26.583.583H3.307c0 1.15.933 2.083 2.084 2.083v-2.666zm.78 0h-.78v2.666h.78v-2.666zm1.175 2.925l.152-1.454-2.652-.277-.152 1.454 2.652.277zm-.52-.641c.32.033.553.32.52.64l-2.652-.277a2.083 2.083 0 001.855 2.29l.277-2.653zm-.64.52a.583.583 0 01.64-.52l-.277 2.652a2.083 2.083 0 002.289-1.855l-2.653-.278zm.168-1.61l-.169 1.61 2.653.277.168-1.61-2.652-.277zM9.5 10.136H7.68v2.666H9.5v-2.666zm1.174 2.925l.152-1.454-2.652-.277-.152 1.454 2.652.277zm-.52-.641c.32.033.553.32.52.64l-2.652-.277a2.083 2.083 0 001.855 2.29l.277-2.653zm-.64.52a.583.583 0 01.64-.52l-.277 2.652a2.083 2.083 0 002.289-1.855l-2.652-.278zm.168-1.61l-.168 1.61 2.652.277.168-1.61-2.652-.277zm2.615-1.194h-1.29v2.666h1.29v-2.666zm-.584.583c0-.322.262-.583.584-.583v2.666c1.15 0 2.083-.933 2.083-2.083h-2.667zm.584.583a.583.583 0 01-.584-.583h2.667c0-1.15-.933-2.084-2.083-2.084v2.667zm-1.132 0h1.132V8.635h-1.132v2.667zm-1.124-3.41L9.84 9.83l2.652.277.202-1.937-2.652-.277zm2.256-1.194h-.93v2.667h.93V6.698zm-.584.583c0-.322.262-.583.584-.583v2.667c1.15 0 2.083-.933 2.083-2.084h-2.667zm.584.584a.583.583 0 01-.584-.584h2.667c0-1.15-.933-2.083-2.083-2.083v2.667zm-.773 0h.773V5.198h-.773v2.667zm-1.182-2.847l-.144 1.375 2.652.277.144-1.375-2.652-.277zm.52.64a.583.583 0 01-.52-.64l2.652.277a2.083 2.083 0 00-1.855-2.289l-.278 2.652zm.64-.52a.583.583 0 01-.64.52l.277-2.652a2.083 2.083 0 00-2.29 1.856l2.653.277zm-.16 1.532l.16-1.531-2.652-.277-.16 1.53 2.652.278zM8.196 7.865h1.82V5.198h-1.82v2.667zM7.014 5.018L6.87 6.393l2.652.277.144-1.375-2.652-.277zm.823 6.284h1.82V8.635h-1.82v2.667zm-1.124-3.41L6.51 9.83l2.653.277.202-1.937-2.652-.277zm3.146-1.194H8.04v2.667h1.82V6.698zm1.124 3.41l.202-1.938-2.652-.277L8.33 9.83l2.653.277z",fill:"currentColor",mask:"url(#hash-circle_svg__a)"})))}var Jr=o.forwardRef($r);function Yr(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Qr(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Yr(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Yr(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Xr=(e,t)=>async i=>{const n=L.C.getValue("Spaces.enabledMetaSpaces");await L.C.setValue("Spaces.enabledMetaSpaces",null,U.R.ACCOUNT,Qr(Qr({},n),{},{[e]:i.target.checked})),kn.Z.trackInteraction(t,i,[cr.TS.Home,null,cr.TS.Favourites,cr.TS.People,cr.TS.Orphans].indexOf(e))},el=()=>{const{[cr.TS.Home]:e,[cr.TS.Favourites]:t,[cr.TS.People]:i,[cr.TS.Orphans]:n}=(0,wt.t)("Spaces.enabledMetaSpaces"),s=(0,wt.t)("Spaces.allRoomsInHome");return o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("settings|sidebar|title")},o.createElement(Xs.ZP,{heading:(0,l._t)("settings|sidebar|metaspaces_subsection"),description:(0,l._t)("settings|sidebar|spaces_explainer")},o.createElement(qs.Z,{checked:!!e,onChange:Xr(cr.TS.Home,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",disabled:e},o.createElement(Xs.po,null,o.createElement(Mr,null),(0,l._t)("common|home")),o.createElement(Xs.po,null,(0,l._t)("settings|sidebar|metaspaces_home_description"))),o.createElement(qs.Z,{checked:s,disabled:!e,onChange:async e=>{await L.C.setValue("Spaces.allRoomsInHome",null,U.R.ACCOUNT,e.target.checked),kn.Z.trackInteraction("WebSettingsSidebarTabSpacesCheckbox",e,1)},className:"mx_SidebarUserSettingsTab_checkbox mx_SidebarUserSettingsTab_homeAllRoomsCheckbox","data-testid":"mx_SidebarUserSettingsTab_homeAllRoomsCheckbox"},o.createElement(Xs.po,null,(0,l._t)("settings|sidebar|metaspaces_home_all_rooms")),o.createElement(Xs.po,null,(0,l._t)("settings|sidebar|metaspaces_home_all_rooms_description"))),o.createElement(qs.Z,{checked:!!t,onChange:Xr(cr.TS.Favourites,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},o.createElement(Xs.po,null,o.createElement(Ur,null),(0,l._t)("common|favourites")),o.createElement(Xs.po,null,(0,l._t)("settings|sidebar|metaspaces_favourites_description"))),o.createElement(qs.Z,{checked:!!i,onChange:Xr(cr.TS.People,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},o.createElement(Xs.po,null,o.createElement(Wr,null),(0,l._t)("common|people")),o.createElement(Xs.po,null,(0,l._t)("settings|sidebar|metaspaces_people_description"))),o.createElement(qs.Z,{checked:!!n,onChange:Xr(cr.TS.Orphans,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox"},o.createElement(Xs.po,null,o.createElement(Jr,null),(0,l._t)("settings|sidebar|metaspaces_orphans")),o.createElement(Xs.po,null,(0,l._t)("settings|sidebar|metaspaces_orphans_description"))))))};var tl=i("../matrix-react-sdk/src/components/views/dialogs/UserTab.ts"),il=i("../matrix-react-sdk/src/theme.ts"),nl=i("../matrix-react-sdk/src/components/views/elements/Dropdown.tsx"),sl=i("../matrix-react-sdk/src/components/views/elements/StyledRadioGroup.tsx");function ol(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function al(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ol(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ol(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class rl extends o.Component{constructor(e){super(e),(0,k.Z)(this,"themeTimer",void 0),(0,k.Z)(this,"onThemeChange",(e=>{if(this.state.theme===e)return;kn.Z.trackInteraction("WebSettingsAppearanceTabThemeSelector");const t=L.C.getValue("theme");L.C.setValue("theme",null,U.R.DEVICE,e).catch((()=>{x.ZP.dispatch({action:W.a.RecheckTheme}),this.setState({theme:t})})),this.setState({theme:e}),x.ZP.dispatch({action:W.a.RecheckTheme,forceTheme:e})})),(0,k.Z)(this,"onUseSystemThemeChanged",(e=>{this.setState({useSystemTheme:e}),L.C.setValue("use_system_theme",null,U.R.DEVICE,e),x.ZP.dispatch({action:W.a.RecheckTheme})})),(0,k.Z)(this,"onAddCustomTheme",(async()=>{let e=L.C.getValue("custom_themes");e||(e=[]),e=e.map((e=>e)),this.themeTimer&&clearTimeout(this.themeTimer);try{const t=await fetch(this.state.customThemeUrl),i=await t.json();if(!i||"string"!=typeof i.name||"object"!=typeof i.colors)return void this.setState({customThemeMessage:{text:(0,l._t)("settings|appearance|custom_theme_invalid"),isError:!0}});e.push(i)}catch(e){return r.k.error(e),void this.setState({customThemeMessage:{text:(0,l._t)("settings|appearance|custom_theme_error_downloading"),isError:!0}})}await L.C.setValue("custom_themes",null,U.R.ACCOUNT,e),this.setState({customThemeUrl:"",customThemeMessage:{text:(0,l._t)("settings|appearance|custom_theme_success"),isError:!1}}),this.themeTimer=window.setTimeout((()=>{this.setState({customThemeMessage:{text:"",isError:!1}})}),3e3)})),(0,k.Z)(this,"onCustomThemeChange",(e=>{this.setState({customThemeUrl:e.target.value})})),this.state=al(al({},rl.calculateThemeState()),{},{customThemeUrl:"",customThemeMessage:{isError:!1,text:""}})}static calculateThemeState(){const e=L.C.getValue("theme"),t=L.C.getValueAt(U.R.DEVICE,"use_system_theme",null,!1,!0),i=L.C.getValueAt(U.R.DEVICE,"theme",null,!1,!0);return t?{theme:e,useSystemTheme:!0}:i?{theme:e,useSystemTheme:!1}:{theme:e,useSystemTheme:L.C.getValueAt(U.R.DEVICE,"use_system_theme")}}renderHighContrastCheckbox(){if(!this.state.useSystemTheme&&((0,il.Bp)(this.state.theme)||(0,il.K4)(this.state.theme)))return o.createElement("div",null,o.createElement(qs.Z,{checked:(0,il.K4)(this.state.theme),onChange:e=>this.highContrastThemeChanged(e.target.checked)},(0,l._t)("settings|appearance|use_high_contrast")))}highContrastThemeChanged(e){let t;t=e?(0,il.Bp)(this.state.theme):(0,il.R9)(this.state.theme),t&&this.onThemeChange(t)}render(){let e,t;if((new Wa.Z).isSystemThemeSupported()&&(e=o.createElement("div",{"data-testid":"checkbox-use-system-theme"},o.createElement(qs.Z,{checked:this.state.useSystemTheme,onChange:e=>this.onUseSystemThemeChanged(e.target.checked)},L.C.getDisplayName("use_system_theme")))),L.C.getValue("feature_custom_themes")){let e;this.state.customThemeMessage.text&&(e=this.state.customThemeMessage.isError?o.createElement("div",{className:"text-error"},this.state.customThemeMessage.text):o.createElement("div",{className:"text-success"},this.state.customThemeMessage.text)),t=o.createElement("div",{className:"mx_SettingsTab_section"},o.createElement("form",{onSubmit:this.onAddCustomTheme},o.createElement(Vs.Z,{label:(0,l._t)("settings|appearance|custom_theme_url"),type:"text",id:"mx_GeneralUserSettingsTab_customThemeInput",autoComplete:"off",onChange:this.onCustomThemeChange,value:this.state.customThemeUrl}),o.createElement(ae.Z,{onClick:this.onAddCustomTheme,type:"submit",kind:"primary_sm",disabled:!this.state.customThemeUrl.trim()},(0,l._t)("settings|appearance|custom_theme_add_button")),e))}const i=(0,il.Gp)();return o.createElement(Xs.ZP,{heading:(0,l._t)("common|theme"),"data-testid":"mx_ThemeChoicePanel"},e,o.createElement("div",{className:"mx_ThemeChoicePanel_themeSelectors","data-testid":"theme-choice-panel-selectors"},o.createElement(sl.Z,{name:"theme",definitions:i.map((e=>({value:e.id,label:e.name,disabled:this.state.useSystemTheme,className:"mx_ThemeSelector_"+e.id}))),onChange:this.onThemeChange,value:this.apparentSelectedThemeId(),outlined:!0})),this.renderHighContrastCheckbox(),t)}apparentSelectedThemeId(){if(this.state.useSystemTheme)return;const e=(0,il.R9)(this.state.theme);return e||this.state.theme}}const ll="MATCH_SYSTEM_THEME_ID",cl=({requestClose:e})=>{const t=(0,o.useMemo)(il.Gp,[]),i=rl.calculateThemeState(),n=(0,il.R9)(i.theme),s=n||i.theme,{useSystemTheme:a}=i,r=[{id:ll,name:(0,l._t)("theme|match_system")},...t],c=a?ll:s;return o.createElement("div",{className:"mx_QuickThemeSwitcher"},o.createElement("h4",{className:"mx_QuickThemeSwitcher_heading"},(0,l._t)("common|theme")),o.createElement(nl.Z,{id:"mx_QuickSettingsButton_themePickerDropdown",onOptionChange:async t=>{kn.Z.trackInteraction("WebQuickSettingsThemeDropdown");try{t===ll?await L.C.setValue("use_system_theme",null,U.R.DEVICE,!0):(x.ZP.dispatch({action:W.a.RecheckTheme,forceTheme:t}),await Promise.all([L.C.setValue("theme",null,U.R.DEVICE,t),L.C.setValue("use_system_theme",null,U.R.DEVICE,!1)]))}catch(e){x.ZP.dispatch({action:W.a.RecheckTheme})}e()},value:c,label:(0,l._t)("common|theme")},r.map((e=>o.createElement("div",{key:e.id},e.name)))))};var dl,ml;function hl(){return hl=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},hl.apply(this,arguments)}function pl(e,t){return o.createElement("svg",hl({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),dl||(dl=o.createElement("path",{d:"M11 18.598V15h2v3.598C13 20.5 12.238 22 12 22s-1-1.5-1-3.402zM9.5 6c-.325-.167-1.714-.8-2.883-2s-.495-2 .513-2H12v4H9.5zM14.5 6c.325-.167 1.714-.8 2.883-2s.495-2-.513-2H12v4h2.5zM9.429 6h5.142L15 10H9l.429-4z",fill:"#000"})),ml||(ml=o.createElement("path",{d:"M12 9c-3.069 0-5.676 1.693-6.621 4.048C4.967 14.073 5.895 15 7 15h10c1.105 0 2.032-.927 1.621-1.952C17.677 10.693 15.07 9 12 9z",fill:"#000"})))}var ul=o.forwardRef(pl);var gl,vl,_l;function fl(){return fl=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},fl.apply(this,arguments)}function El(e,t){return o.createElement("svg",fl({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0,ref:t},e),gl||(gl=o.createElement("circle",{cx:15.5,cy:10,r:1.5,transform:"rotate(180 15.5 10)",fill:"currentColor"})),vl||(vl=o.createElement("circle",{cx:10,cy:10,r:1.5,transform:"rotate(180 10 10)",fill:"currentColor"})),_l||(_l=o.createElement("circle",{cx:4.5,cy:10,r:1.5,transform:"rotate(180 4.5 10)",fill:"currentColor"})))}var yl=o.forwardRef(El);var bl=i("../matrix-react-sdk/src/components/views/dialogs/DevtoolsDialog.tsx");const wl=({isPanelCollapsed:e=!1})=>{const[t,i,n,s]=(0,ii.av)(),{[cr.TS.Favourites]:a,[cr.TS.People]:r}=(0,wt.t)("Spaces.enabledMetaSpaces"),c=ie.m.instance.roomViewStore.getRoomId(),d=(0,wt.t)("developerMode");let m;return t&&i.current&&(m=o.createElement(ii.ZP,(0,kt.Z)({},(0,ii.xT)(i.current.getBoundingClientRect(),ii.N7.None,16),{wrapperClassName:"mx_QuickSettingsButton_ContextMenuWrapper",onFinished:s,managed:!1,focusLock:!0}),o.createElement("h2",null,(0,l._t)("quick_settings|title")),o.createElement(ae.Z,{onClick:()=>{s(),x.ZP.dispatch({action:W.a.ViewUserSettings})},kind:"primary_outline"},(0,l._t)("quick_settings|all_settings")),c&&d&&o.createElement(ae.Z,{onClick:()=>{s(),T.ZP.createDialog(bl.Z,{roomId:c},"mx_DevtoolsDialog_wrapper")},kind:"danger_outline"},(0,l._t)("devtools|title")),o.createElement("h4",{className:"mx_QuickSettingsButton_pinToSidebarHeading"},o.createElement(ul,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("quick_settings|metaspace_section")),o.createElement(qs.Z,{className:"mx_QuickSettingsButton_favouritesCheckbox",checked:!!a,onChange:Xr(cr.TS.Favourites,"WebQuickSettingsPinToSidebarCheckbox")},o.createElement(Ur,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("common|favourites")),o.createElement(qs.Z,{className:"mx_QuickSettingsButton_peopleCheckbox",checked:!!r,onChange:Xr(cr.TS.People,"WebQuickSettingsPinToSidebarCheckbox")},o.createElement(Wr,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("common|people")),o.createElement(ae.Z,{className:"mx_QuickSettingsButton_moreOptionsButton",onClick:()=>{s(),x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.Sidebar})}},o.createElement(yl,{className:"mx_QuickSettingsButton_icon"}),(0,l._t)("quick_settings|sidebar_settings")),o.createElement(cl,{requestClose:s}))),o.createElement(o.Fragment,null,o.createElement(gs.Z,{className:yt()("mx_QuickSettingsButton",{expanded:!e}),onClick:n,title:(0,l._t)("quick_settings|title"),inputRef:i,forceHide:!e,"aria-expanded":!e},e?null:(0,l._t)("common|settings")),m)};var Sl=i("../matrix-react-sdk/src/components/views/dialogs/InfoDialog.tsx"),Cl=i("../matrix-react-sdk/src/components/views/elements/ExternalLink.tsx");const kl=e=>{const t=(0,o.useRef)(null),[i,n]=(0,o.useState)(""),[s,a]=(0,mo.R)(!1);(0,o.useEffect)((()=>{var e;null===(e=t.current)||void 0===e||e.focus()}),[]);const r=()=>{e.onFinished(),T.ZP.createDialog(ut.Z,{})},d=!!c.ZP.get().bug_report_endpoint_url;let m,h;d&&(m=o.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},o.createElement("h3",null,(0,l._t)("feedback|comment_label")),o.createElement("p",null,(0,l._t)("feedback|platform_username")),o.createElement(Vs.Z,{id:"feedbackComment",label:(0,l._t)("common|feedback"),type:"text",autoComplete:"off",value:i,element:"textarea",onChange:e=>{n(e.target.value)},ref:t}),o.createElement(qs.Z,{checked:s,onChange:a},(0,l._t)("feedback|may_contact_label")))),d&&(h=o.createElement("p",{className:"mx_FeedbackDialog_section_microcopy"},(0,l._t)("feedback|pro_type",{},{debugLogsLink:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:r},e)})));const p=c.ZP.getObject("feedback").get("existing_issues_url"),u=c.ZP.getObject("feedback").get("new_issue_url");return o.createElement(mt.Z,{className:"mx_FeedbackDialog",hasCancelButton:d,title:(0,l._t)("common|feedback"),description:o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},o.createElement("h3",null,(0,l._t)("common|report_a_bug")),o.createElement("p",null,(0,l._t)("feedback|existing_issue_link",{},{existingIssuesLink:e=>o.createElement(Cl.Z,{target:"_blank",rel:"noreferrer noopener",href:p},e),newIssueLink:e=>o.createElement(Cl.Z,{target:"_blank",rel:"noreferrer noopener",href:u},e)})),h),m),button:d?(0,l._t)("feedback|send_feedback_action"):(0,l._t)("action|go_back"),buttonDisabled:d&&!i,onFinished:t=>{if(d&&t){const t=e.feature?`${e.feature}-feedback`:"feedback";(0,Ma.mv)(t,i,s),T.ZP.createDialog(Sl.Z,{title:(0,l._t)("feedback|sent"),description:(0,l._t)("bug_reporting|thank_you")})}e.onFinished()}})};var xl=i("../matrix-react-sdk/src/components/views/dialogs/security/RestoreKeyBackupDialog.tsx"),Rl=function(e){return e[e.LOADING=0]="LOADING",e[e.NO_CRYPTO=1]="NO_CRYPTO",e[e.BACKUP_ACTIVE=2]="BACKUP_ACTIVE",e[e.SERVER_BACKUP_BUT_DISABLED=3]="SERVER_BACKUP_BUT_DISABLED",e[e.NO_BACKUP=4]="NO_BACKUP",e[e.ERROR=5]="ERROR",e}(Rl||{});class Il extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onExportE2eKeysClicked",(()=>{T.ZP.createDialogAsync(i.e(3875).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx")),{matrixClient:E.p.safeGet()})})),(0,k.Z)(this,"onFinished",(e=>{e&&x.ZP.dispatch({action:"logout"}),this.props.onFinished(!!e)})),(0,k.Z)(this,"onSetRecoveryMethodClick",(()=>{this.state.backupStatus===Rl.SERVER_BACKUP_BUT_DISABLED?T.ZP.createDialog(xl.Z,void 0,void 0,!1,!0):T.ZP.createDialogAsync(i.e(4770).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/security/CreateKeyBackupDialog.tsx")),void 0,void 0,!1,!0),this.props.onFinished(!0)})),(0,k.Z)(this,"onLogoutConfirm",(()=>{x.ZP.dispatch({action:"logout"}),this.props.onFinished(!0)})),this.state={backupStatus:Rl.LOADING},window.setTimeout((()=>this.startLoadBackupStatus()),0)}startLoadBackupStatus(){this.loadBackupStatus().catch((e=>{r.k.log("Unable to fetch key backup status",e),this.setState({backupStatus:Rl.ERROR})}))}async loadBackupStatus(){const e=E.p.safeGet(),t=e.getCrypto();if(!t)return void this.setState({backupStatus:Rl.NO_CRYPTO});if(null!==await t.getActiveSessionBackupVersion())return void this.setState({backupStatus:Rl.BACKUP_ACTIVE});const i=await e.getKeyBackupVersion();this.setState({backupStatus:i?Rl.SERVER_BACKUP_BUT_DISABLED:Rl.NO_BACKUP})}renderSetupBackupDialog(){const e=o.createElement("div",null,o.createElement("p",null,(0,l._t)("auth|logout_dialog|setup_secure_backup_description_1")),o.createElement("p",null,(0,l._t)("auth|logout_dialog|setup_secure_backup_description_2")),o.createElement("p",null,(0,l._t)("encryption|setup_secure_backup|explainer")));let t;t=this.state.backupStatus===Rl.SERVER_BACKUP_BUT_DISABLED?(0,l._t)("settings|security|key_backup_connect"):(0,l._t)("auth|logout_dialog|use_key_backup");const i=o.createElement("div",null,o.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},e),o.createElement(gt.Z,{primaryButton:t,hasCancel:!1,onPrimaryButtonClick:this.onSetRecoveryMethodClick,focus:!0},o.createElement("button",{onClick:this.onLogoutConfirm},(0,l._t)("auth|logout_dialog|skip_key_backup"))),o.createElement("details",null,o.createElement("summary",{className:"mx_LogoutDialog_ExportKeyAdvanced"},(0,l._t)("common|advanced")),o.createElement("p",null,o.createElement("button",{onClick:this.onExportE2eKeysClicked},(0,l._t)("auth|logout_dialog|megolm_export")))));return o.createElement(q.Z,{title:(0,l._t)("auth|logout_dialog|setup_key_backup_title"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},i)}render(){switch(this.state.backupStatus){case Rl.LOADING:return o.createElement(q.Z,{title:(0,l._t)("action|sign_out"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},o.createElement(re.Z,null),";");case Rl.NO_CRYPTO:case Rl.BACKUP_ACTIVE:return o.createElement(mt.Z,{hasCancelButton:!0,title:(0,l._t)("action|sign_out"),description:(0,l._t)("auth|logout_dialog|description"),button:(0,l._t)("action|sign_out"),onFinished:this.onFinished});case Rl.NO_BACKUP:case Rl.SERVER_BACKUP_BUT_DISABLED:case Rl.ERROR:return this.renderSetupBackupDialog()}}}function Pl(e,t){const i=new ka.B(e).get("embedded_pages");let n=i?new ka.B(i).get("home_url"):null;var s;(n||(n=e.welcomePageUrl,n&&r.k.warn("You are using a deprecated config option: `welcomePageUrl`. Please use `embedded_pages.home_url` instead, per https://github.com/vector-im/element-web/issues/21428")),n)||(n=null===(s=(0,We.g0)(t))||void 0===s?void 0:s.home_url);return n}(0,k.Z)(Il,"defaultProps",{onFinished:function(){}});var Tl,Zl,Nl,Dl,Ml=i("../matrix-react-sdk/src/stores/OwnProfileStore.ts");function Ol(){return Ol=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Ol.apply(this,arguments)}function Al(e,t){return o.createElement("svg",Ol({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8 8",role:"presentation","aria-hidden":!0,ref:t},e),Tl||(Tl=o.createElement("path",{d:"M6.73 1.395a.333.333 0 00-.527.41l.005.006.021.029a4.121 4.121 0 01.335.587c.187.4.37.95.37 1.573 0 .622-.183 1.173-.37 1.573a4.121 4.121 0 01-.356.616l-.004.006h-.001a.333.333 0 00.527.41L6.48 6.41l.249.194v-.001l.001-.002.003-.003.009-.012a2.258 2.258 0 00.13-.19c.081-.128.189-.312.296-.542A4.43 4.43 0 007.599 4a4.43 4.43 0 00-.43-1.855 4.787 4.787 0 00-.426-.732L6.734 1.4l-.003-.004-.001-.001-.263.204.263-.205z",fill:"currentColor"})),Zl||(Zl=o.createElement("path",{d:"M5.863 2.595a.333.333 0 00-.527.409l.001.001a.575.575 0 01.044.065c.032.049.074.122.117.214.087.186.169.437.169.716 0 .28-.082.53-.169.716a1.891 1.891 0 01-.16.279l-.002.002a.333.333 0 00.527.408L5.6 5.2l.263.205v-.001l.002-.001.002-.003.005-.007a1.28 1.28 0 00.072-.105c.044-.07.101-.168.158-.29.114-.243.232-.592.232-.998s-.118-.755-.232-.998a2.56 2.56 0 00-.23-.395L5.867 2.6l-.002-.003h-.001v-.001L5.6 2.8l.263-.205zM1.204 6.605a.333.333 0 00.526-.41l-.005-.006a4.121 4.121 0 01-.356-.616A3.764 3.764 0 011 4c0-.622.182-1.173.369-1.573a4.121 4.121 0 01.356-.616l.005-.006a.333.333 0 00-.526-.41l.248.194-.248-.194-.001.001-.001.002L1.2 1.4l-.009.012a2.258 2.258 0 00-.13.19 4.786 4.786 0 00-.295.542A4.43 4.43 0 00.333 4c0 .75.218 1.398.432 1.855a4.787 4.787 0 00.425.732l.01.012.002.004h.001v.001l.264-.204-.263.205z",fill:"currentColor"})),Nl||(Nl=o.createElement("path",{d:"M2.07 5.405a.333.333 0 00.527-.409l-.001-.001a.575.575 0 01-.044-.065 1.892 1.892 0 01-.117-.214A1.716 1.716 0 012.266 4c0-.28.082-.53.17-.716a1.891 1.891 0 01.16-.279l.001-.002a.333.333 0 00-.527-.408l.263.205-.263-.205v.001l-.001.001-.002.003-.006.007a1.28 1.28 0 00-.072.105 2.562 2.562 0 00-.158.29A2.381 2.381 0 001.6 4c0 .406.118.755.231.998a2.56 2.56 0 00.23.395l.006.007.002.003v.001l.264-.204-.263.205z",fill:"currentColor"})),Dl||(Dl=o.createElement("circle",{cx:4,cy:4,r:.667,fill:"currentColor"})))}var Ll=o.forwardRef(Al);var Ul=i("../matrix-react-sdk/src/utils/Feedback.ts");class Fl extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"themeWatcherRef",void 0),(0,k.Z)(this,"dndWatcherRef",void 0),(0,k.Z)(this,"buttonRef",(0,o.createRef)()),(0,k.Z)(this,"onCurrentVoiceBroadcastRecordingChanged",(e=>{this.setState({showLiveAvatarAddon:null!==e})})),(0,k.Z)(this,"onProfileUpdate",(async()=>{this.forceUpdate()})),(0,k.Z)(this,"onSelectedSpaceUpdate",(async()=>{this.setState({selectedSpace:Rs.ZP.instance.activeSpaceRoom})})),(0,k.Z)(this,"onThemeChanged",(()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme()})})),(0,k.Z)(this,"onAction",(e=>{if(e.action===W.a.ToggleUserMenu)this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click()})),(0,k.Z)(this,"onOpenMenuClick",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:e.currentTarget.getBoundingClientRect()})})),(0,k.Z)(this,"onContextMenu",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})})),(0,k.Z)(this,"onCloseMenu",(()=>{this.setState({contextMenuPosition:null})})),(0,k.Z)(this,"onSwitchThemeClick",(e=>{e.preventDefault(),e.stopPropagation(),kn.Z.trackInteraction("WebUserMenuThemeToggleButton",e),L.C.setValue("use_system_theme",null,U.R.DEVICE,!1);let t=this.state.isDarkTheme?"light":"dark";if(this.state.isHighContrast){const e=(0,il.Bp)(t);e&&(t=e)}L.C.setValue("theme",null,U.R.DEVICE,t)})),(0,k.Z)(this,"onSettingsOpen",((e,t)=>{e.preventDefault(),e.stopPropagation();const i={action:W.a.ViewUserSettings,initialTabId:t};x.ZP.dispatch(i),this.setState({contextMenuPosition:null})})),(0,k.Z)(this,"onProvideFeedback",(e=>{e.preventDefault(),e.stopPropagation(),T.ZP.createDialog(kl),this.setState({contextMenuPosition:null})})),(0,k.Z)(this,"onSignOutClick",(async e=>{var t;e.preventDefault(),e.stopPropagation();const i=E.p.get();i&&i.isCryptoEnabled()&&null!==(t=await i.exportRoomKeys())&&void 0!==t&&t.length?T.ZP.createDialog(Il):x.ZP.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})})),(0,k.Z)(this,"onSignInClick",(()=>{x.ZP.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})})),(0,k.Z)(this,"onRegisterClick",(()=>{x.ZP.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})})),(0,k.Z)(this,"onHomeClick",(e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:W.a.ViewHomePage}),this.setState({contextMenuPosition:null})})),(0,k.Z)(this,"renderContextMenu",(()=>{if(!this.state.contextMenuPosition)return null;let e,t,n;E.p.safeGet().isGuest()&&(e=o.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},(0,l._t)("auth|sign_in_prompt",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.onSignInClick},e)}),L.C.getValue(Ye.H.Registration)?(0,l._t)("auth|create_account_prompt",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.onRegisterClick},e)}):null)),this.hasHomePage&&(t=o.createElement(ur.$k,{iconClassName:"mx_UserMenu_iconHome",label:(0,l._t)("common|home"),onClick:this.onHomeClick})),(0,Ul.y)()&&(n=o.createElement(ur.$k,{iconClassName:"mx_UserMenu_iconMessage",label:(0,l._t)("common|feedback"),onClick:this.onProvideFeedback}));let s=o.createElement(ur.I2,null,t,o.createElement(ur.$k,{iconClassName:"mx_UserMenu_iconBell",label:(0,l._t)("notifications|enable_prompt_toast_title"),onClick:e=>this.onSettingsOpen(e,tl.o.Notifications)}),o.createElement(ur.$k,{iconClassName:"mx_UserMenu_iconLock",label:(0,l._t)("room_settings|security|title"),onClick:e=>this.onSettingsOpen(e,tl.o.Security)}),o.createElement(ur.$k,{iconClassName:"mx_UserMenu_iconSettings",label:(0,l._t)("user_menu|settings"),onClick:e=>this.onSettingsOpen(e)}),n,o.createElement(ur.$k,{className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_UserMenu_iconSignOut",label:(0,l._t)("action|sign_out"),onClick:this.onSignOutClick}));E.p.safeGet().isGuest()&&(s=o.createElement(ur.I2,null,t,o.createElement(ur.$k,{iconClassName:"mx_UserMenu_iconSettings",label:(0,l._t)("common|settings"),onClick:e=>this.onSettingsOpen(e)}),n));const a=this.props.isPanelCollapsed?{left:(r=this.state.contextMenuPosition).width+r.left+8,top:r.top,chevronFace:ii.N7.None}:(e=>({left:e.left,top:e.top+e.height,chevronFace:ii.N7.None}))(this.state.contextMenuPosition);var r;return o.createElement(ur.ZP,(0,kt.Z)({},a,{onFinished:this.onCloseMenu,className:"mx_UserMenu_contextMenu"}),o.createElement("div",{className:"mx_UserMenu_contextMenu_header"},o.createElement("div",{className:"mx_UserMenu_contextMenu_name"},o.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},Ml.p.instance.displayName),o.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},Pt.Z.getDisplayUserIdentifier(E.p.safeGet().getSafeUserId(),{withDisplayName:!0}))),o.createElement(Gi.yy,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.isDarkTheme?(0,l._t)("user_menu|switch_theme_light"):(0,l._t)("user_menu|switch_theme_dark")},o.createElement("img",{src:i("../matrix-react-sdk/res/img/element-icons/roomlist/dark-light-mode.svg").Z,role:"presentation",alt:"",width:16}))),e,s)})),this.context=t,this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme(),selectedSpace:Rs.ZP.instance.activeSpaceRoom,showLiveAvatarAddon:this.context.voiceBroadcastRecordingsStore.hasCurrent()},Ml.p.instance.on(Pa.a,this.onProfileUpdate),Rs.ZP.instance.on(cr.p4,this.onSelectedSpaceUpdate)}get hasHomePage(){return!!Pl(c.ZP.get(),this.context.client)}componentDidMount(){this.context.voiceBroadcastRecordingsStore.on(Ut.Ir.CurrentChanged,this.onCurrentVoiceBroadcastRecordingChanged),this.dispatcherRef=x.ZP.register(this.onAction),this.themeWatcherRef=L.C.watchSetting("theme",null,this.onThemeChanged)}componentWillUnmount(){this.themeWatcherRef&&L.C.unwatchSetting(this.themeWatcherRef),this.dndWatcherRef&&L.C.unwatchSetting(this.dndWatcherRef),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef),Ml.p.instance.off(Pa.a,this.onProfileUpdate),Rs.ZP.instance.off(cr.p4,this.onSelectedSpaceUpdate),this.context.voiceBroadcastRecordingsStore.off(Ut.Ir.CurrentChanged,this.onCurrentVoiceBroadcastRecordingChanged)}isUserOnDarkTheme(){if(L.C.getValue("use_system_theme"))return window.matchMedia("(prefers-color-scheme: dark)").matches;{const e=L.C.getValue("theme");return e.startsWith("custom-")?!!(0,il.jp)(e.substring(7)).is_dark:"dark"===e}}isUserOnHighContrastTheme(){if(L.C.getValue("use_system_theme"))return window.matchMedia("(prefers-contrast: more)").matches;{const e=L.C.getValue("theme");return!e.startsWith("custom-")&&(0,il.K4)(e)}}render(){const e=E.p.safeGet().getSafeUserId(),t=Ml.p.instance.displayName||e,i=Ml.p.instance.getHttpAvatarUrl(32);let n;this.props.isPanelCollapsed||(n=o.createElement("div",{className:"mx_UserMenu_name"},t));const s=this.state.showLiveAvatarAddon?o.createElement("div",{className:"mx_UserMenu_userAvatarLive","data-testid":"user-menu-live-vb"},o.createElement(Ll,{className:"mx_Icon_8"})):null;return o.createElement("div",{className:"mx_UserMenu"},o.createElement(ii.lX,{className:"mx_UserMenu_contextMenuButton",onClick:this.onOpenMenuClick,inputRef:this.buttonRef,label:(0,l._t)("a11y|user_menu"),isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},o.createElement("div",{className:"mx_UserMenu_userAvatar"},o.createElement(ys.Z,{idName:e,name:t,url:i,size:"32px",className:"mx_UserMenu_userAvatar_BaseAvatar"}),s),n,this.renderContextMenu()),this.props.children)}}(0,k.Z)(Fl,"contextType",ie.f);const Bl=["children","trackHorizontalOverflow","verticalScrollsHorizontally"];class Vl extends o.Component{constructor(e){super(e),(0,k.Z)(this,"autoHideScrollbar",(0,o.createRef)()),(0,k.Z)(this,"scrollElement",void 0),(0,k.Z)(this,"likelyTrackpadUser",null),(0,k.Z)(this,"checkAgainForTrackpad",0),(0,k.Z)(this,"collectScroller",(e=>{var t,i;null===(t=(i=this.props).wrappedRef)||void 0===t||t.call(i,e),e&&!this.scrollElement&&(this.scrollElement=e,this.scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())})),(0,k.Z)(this,"checkOverflow",(()=>{if(!this.scrollElement)return;const e=this.scrollElement.scrollTop>0,t=this.scrollElement.scrollHeight>this.scrollElement.scrollTop+this.scrollElement.clientHeight,i=this.scrollElement.scrollLeft>0,n=this.scrollElement.scrollWidth>this.scrollElement.scrollLeft+this.scrollElement.clientWidth;e?this.scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this.scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),i?this.scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),n?this.scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:i?`${this.scrollElement.scrollLeft}px`:"0",rightIndicatorOffset:n?`-${this.scrollElement.scrollLeft}px`:"0"})})),(0,k.Z)(this,"onMouseWheel",(e=>{if(this.props.verticalScrollsHorizontally&&this.scrollElement){const t=0,i=1,n=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this.likelyTrackpadUser=!0,this.checkAgainForTrackpad=n+6e4):this.likelyTrackpadUser&&n>=this.checkAgainForTrackpad&&(this.likelyTrackpadUser=!1),this.likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,n=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this.scrollElement.scrollLeft+=n*i}}})),this.state={leftIndicatorOffset:"0",rightIndicatorOffset:"0"}}componentDidUpdate(e){o.Children.count(e.children)!==o.Children.count(this.props.children)&&this.checkOverflow()}componentDidMount(){this.checkOverflow(),mr.default.instance.on(mr.Q.Resize,this.checkOverflow)}componentWillUnmount(){var e;null===(e=this.scrollElement)||void 0===e||e.removeEventListener("scroll",this.checkOverflow),mr.default.instance.off(mr.Q.Resize,this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:i,verticalScrollsHorizontally:n}=e,s=(0,v.Z)(e,Bl),a={left:this.state.leftIndicatorOffset},r={right:this.state.rightIndicatorOffset},l=i?o.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:a}):null,c=i?o.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:r}):null;return o.createElement(Ln.Z,(0,kt.Z)({},s,{ref:this.autoHideScrollbar,wrappedRef:this.collectScroller,onWheel:this.onMouseWheel}),l,t,c)}}const jl=["onFinished","hideHeader"],zl=["selected","isPanelCollapsed","size"],Wl=["children","isPanelCollapsed","setPanelCollapsed","isDraggingOver","innerRef"],Hl=e=>{let{onFinished:t,hideHeader:i}=e,n=(0,v.Z)(e,jl);const s=(0,wt.t)("Spaces.allRoomsInHome");return o.createElement(ur.ZP,(0,kt.Z)({},n,{onFinished:t,className:"mx_SpacePanel_contextMenu",compact:!0}),!i&&o.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},(0,l._t)("common|home")),o.createElement(ur.I2,{first:!0},o.createElement(ur.gW,{iconClassName:"mx_SpacePanel_noIcon",label:(0,l._t)("settings|sidebar|metaspaces_home_all_rooms"),active:s,onClick:()=>{t(),L.C.setValue("Spaces.allRoomsInHome",null,U.R.ACCOUNT,!s)}})))},Gl=e=>{let{selected:t,isPanelCollapsed:i,size:n="32px"}=e,s=(0,v.Z)(e,zl);return o.createElement("li",{className:yt()("mx_SpaceItem",{collapsed:i}),role:"treeitem","aria-selected":t},o.createElement(Rr,(0,kt.Z)({},s,{selected:t,isNarrow:i,size:n})))},Kl=()=>Rs.ZP.instance.allRoomsInHome?Zr.v.instance.globalState:Rs.ZP.instance.getNotificationState(cr.TS.Home),ql=({isPanelCollapsed:e,setPanelCollapsed:t})=>{const[i,n,s,a]=(0,ii.av)();let r;(0,o.useEffect)((()=>{!e&&i&&a()}),[e]),i&&(r=o.createElement(yr.ZP,{onFinished:a}));const c=i?a:()=>{e||t(!0),s()};return o.createElement("li",{className:yt()("mx_SpaceItem mx_SpaceItem_new",{collapsed:e}),role:"treeitem","aria-selected":!1},o.createElement(Rr,{"data-testid":"create-space-button",className:yt()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:i}),label:i?(0,l._t)("action|cancel"):(0,l._t)("create_space|label"),onClick:c,isNarrow:e,innerRef:n,size:"32px"}),r)},$l={[cr.TS.Home]:({selected:e,isPanelCollapsed:t})=>{const i=(0,In.kZ)(Rs.ZP.instance,cr.Qv,(()=>Rs.ZP.instance.allRoomsInHome)),[n,s]=(0,o.useState)(Kl()),a=(0,o.useCallback)((()=>{s(Kl())}),[]);return(0,o.useEffect)(a,[a,i]),(0,In.x2)(Zr.v.instance,Zr.w,a),o.createElement(Gl,{spaceKey:cr.TS.Home,className:"mx_SpaceButton_home",selected:e,isPanelCollapsed:t,label:(0,cr.W4)(cr.TS.Home,i),notificationState:n,ContextMenuComponent:Hl,contextMenuTooltip:(0,l._t)("common|options"),size:"32px"})},[cr.TS.Favourites]:({selected:e,isPanelCollapsed:t})=>o.createElement(Gl,{spaceKey:cr.TS.Favourites,className:"mx_SpaceButton_favourites",selected:e,isPanelCollapsed:t,label:(0,cr.W4)(cr.TS.Favourites),notificationState:Rs.ZP.instance.getNotificationState(cr.TS.Favourites),size:"32px"}),[cr.TS.People]:({selected:e,isPanelCollapsed:t})=>o.createElement(Gl,{spaceKey:cr.TS.People,className:"mx_SpaceButton_people",selected:e,isPanelCollapsed:t,label:(0,cr.W4)(cr.TS.People),notificationState:Rs.ZP.instance.getNotificationState(cr.TS.People),size:"32px"}),[cr.TS.Orphans]:({selected:e,isPanelCollapsed:t})=>o.createElement(Gl,{spaceKey:cr.TS.Orphans,className:"mx_SpaceButton_orphans",selected:e,isPanelCollapsed:t,label:(0,cr.W4)(cr.TS.Orphans),notificationState:Rs.ZP.instance.getNotificationState(cr.TS.Orphans),size:"32px"})},Jl=o.memo((e=>{let{children:t,isPanelCollapsed:i,setPanelCollapsed:n,isDraggingOver:s,innerRef:a}=e,r=(0,v.Z)(e,Wl);const[c,d,m,h]=(()=>{const e=(0,In.kZ)(Rs.ZP.instance,cr.Y7,(()=>Rs.ZP.instance.invitedSpaces)),[t,i]=(0,In.kZ)(Rs.ZP.instance,cr.Ue,(()=>[Rs.ZP.instance.enabledMetaSpaces,Rs.ZP.instance.spacePanelSpaces]));return[e,t,i,(0,In.kZ)(Rs.ZP.instance,cr.p4,(()=>Rs.ZP.instance.activeSpace))]})(),p=h?[h]:[],u=d.map((e=>{const t=$l[e];return o.createElement(t,{key:e,selected:h===e,isPanelCollapsed:i})}));return o.createElement(Vl,(0,kt.Z)({},r,{wrappedRef:a,className:"mx_SpaceTreeLevel",style:s?{pointerEvents:"none"}:void 0,element:"ul",role:"tree","aria-label":(0,l._t)("common|spaces")}),u,c.map((e=>o.createElement(Ir,{key:e.roomId,space:e,activeSpaces:p,isPanelCollapsed:i,onExpand:()=>n(!1)}))),m.map(((e,t)=>o.createElement(Er._l,{key:e.roomId,draggableId:e.roomId,index:t},((t,s)=>o.createElement(Ir,(0,kt.Z)({},t.draggableProps,{dragHandleProps:t.dragHandleProps,key:e.roomId,innerRef:t.innerRef,className:s.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:p,isPanelCollapsed:i,onExpand:()=>n(!1)})))))),t,(0,hr.I)(Ye.y.CreateSpaces)&&o.createElement(ql,{isPanelCollapsed:i,setPanelCollapsed:n}))})),Yl=()=>{const[e,t]=(0,o.useState)(!1),[i,n]=(0,o.useState)(!0),s=(0,o.useRef)(null);return(0,o.useLayoutEffect)((()=>(s.current&&mr.default.instance.trackElementDimensions("SpacePanel",s.current),()=>mr.default.instance.stopTrackingElementDimensions("SpacePanel"))),[]),(0,io.P)(x.ZP,(e=>{e.action===W.a.ToggleSpacePanel&&n(!i)})),o.createElement(Gi.uP,{handleHomeEnd:!0,handleUpDown:!e},(({onKeyDownHandler:e,onDragEndHandler:a})=>o.createElement(Er.Z5,{onDragStart:()=>{t(!0)},onDragEnd:e=>{t(!1),e.destination&&(Rs.ZP.instance.moveRootSpace(e.source.index,e.destination.index),a())}},o.createElement("div",{className:yt()("mx_SpacePanel",{collapsed:i}),onKeyDown:e,ref:s},o.createElement(Fl,{isPanelCollapsed:i},o.createElement(gs.Z,{className:yt()("mx_SpacePanel_toggleCollapse",{expanded:!i}),onClick:()=>n(!i),title:i?(0,l._t)("action|expand"):(0,l._t)("action|collapse"),tooltip:o.createElement("div",null,o.createElement("div",{className:"mx_Tooltip_title"},i?(0,l._t)("action|expand"):(0,l._t)("action|collapse")),o.createElement("div",{className:"mx_Tooltip_sub"},en.Mq?"â + â§ + D":(0,l._t)(tn.nk[en.sr.CONTROL])+" + "+(0,l._t)(tn.nk[en.sr.SHIFT])+" + D"))})),o.createElement(Er.bK,{droppableId:"top-level-spaces"},((e,t)=>o.createElement(Jl,(0,kt.Z)({},e.droppableProps,{isPanelCollapsed:i,setPanelCollapsed:n,isDraggingOver:t.isDraggingOver,innerRef:e.innerRef}),e.placeholder))),o.createElement(wl,{isPanelCollapsed:i})))))},Ql=e=>({left:e.left+window.scrollX,top:e.bottom+window.scrollY+12,chevronFace:ii.N7.None});var Xl=function(e){return e[e.JoinRoom=0]="JoinRoom",e[e.BulkRedact=1]="BulkRedact",e}(Xl||{});const ec=({onVisibilityChange:e})=>{var t;const i=(0,o.useContext)(pn.ZP),[s,a,r,c]=(0,ii.av)(),[d,m,h,p]=(0,ii.av)(),[u,g]=(0,In.kZ)(Rs.ZP.instance,cr.p4,(()=>[Rs.ZP.instance.activeSpace,Rs.ZP.instance.activeSpaceRoom])),v=(0,In.kZ)(Rs.ZP.instance,cr.Qv,(()=>Rs.ZP.instance.allRoomsInHome)),_=(0,wt.n)("feature_video_rooms"),f=(0,wt.n)("feature_element_call_video_rooms"),E=(()=>{const e=(0,o.useContext)(pn.ZP),[t,i]=(0,o.useState)(new Map),s=(e,n)=>{const s=new Set(t.get(e));s.add(n),i(new Map(t).set(e,s))},a=(e,n)=>{const s=new Set(t.get(e));s.delete(n)&&i(new Map(t).set(e,s))};return(0,io.P)(x.ZP,(e=>{switch(e.action){case W.a.JoinRoom:s(Xl.JoinRoom,e.roomId);break;case W.a.JoinRoomReady:case W.a.JoinRoomError:a(Xl.JoinRoom,e.roomId);break;case W.a.BulkRedactStart:s(Xl.BulkRedact,e.roomId);break;case W.a.BulkRedactEnd:a(Xl.BulkRedact,e.roomId)}})),(0,In.V4)(e,n.ClientEvent.Room,(e=>a(Xl.JoinRoom,e.roomId))),t})(),y=g||u===cr.TS.Home;(0,o.useEffect)((()=>{s&&!y&&c()}),[c,y,s]);const b=(0,In.A_)(null!=g?g:void 0,n.RoomEvent.Name,(()=>null==g?void 0:g.name));(0,o.useEffect)((()=>{null==e||e()}),[e]);const w=(0,hr.I)(Ye.y.ExploreRooms),S=(0,hr.I)(Ye.y.CreateRooms),C=(0,hr.I)(Ye.y.CreateSpaces),k=null==g||null===(t=g.currentState)||void 0===t?void 0:t.maySendStateEvent(n.EventType.SpaceChild,i.getUserId()),R=k&&S,I=k&&C,P=S||w||C||g;let T,Z;if(s&&a.current){let e;e=g?vr:Hl,T=o.createElement(e,(0,kt.Z)({},Ql(a.current.getBoundingClientRect()),{space:g,onFinished:c,hideHeader:!0}))}else if(d&&g){let e,t;(0,ko.dp)(g)&&(e=o.createElement(ur.$k,{label:(0,l._t)("action|invite"),iconClassName:"mx_RoomListHeader_iconInvite",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ko.N2)(g),p()}})),null!=g&&g.currentState.maySendStateEvent(n.EventType.RoomAvatar,i.getUserId())&&(t=o.createElement(o.Fragment,null,o.createElement(ur.$k,{iconClassName:"mx_RoomListHeader_iconNewRoom",label:(0,l._t)("action|new_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ko.gS)(g),kn.Z.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),p()}}),_&&o.createElement(ur.$k,{iconClassName:"mx_RoomListHeader_iconNewVideoRoom",label:(0,l._t)("action|new_video_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ko.gS)(g,f?n.RoomType.UnstableCall:n.RoomType.ElementVideo),p()}},o.createElement(pr.r,null)))),T=o.createElement(ur.ZP,(0,kt.Z)({},Ql(m.current.getBoundingClientRect()),{onFinished:p,compact:!0}),o.createElement(ur.I2,{first:!0},e,t,o.createElement(ur.$k,{label:(0,l._t)("action|explore_rooms"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:W.a.ViewRoom,room_id:g.roomId,metricsTrigger:void 0}),p(),kn.Z.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e)}}),o.createElement(ur.$k,{label:(0,l._t)("action|add_existing_room"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ko.aI)(g),p()},disabled:!R,tooltip:R?void 0:(0,l._t)("spaces|error_no_permission_add_room")}),C&&o.createElement(ur.$k,{label:(0,l._t)("room_list|add_space_label"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ko.xR)(g),p()},disabled:!I,tooltip:I?void 0:(0,l._t)("spaces|error_no_permission_add_space")},o.createElement(pr.r,null))))}else if(d){let e,t;S&&(e=o.createElement(o.Fragment,null,o.createElement(ur.$k,{label:(0,l._t)("action|start_new_chat"),iconClassName:"mx_RoomListHeader_iconStartChat",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"view_create_chat"}),kn.Z.trackInteraction("WebRoomListHeaderPlusMenuCreateChatItem",e),p()}}),o.createElement(ur.$k,{label:(0,l._t)("action|new_room"),iconClassName:"mx_RoomListHeader_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"view_create_room"}),kn.Z.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),p()}}),_&&o.createElement(ur.$k,{label:(0,l._t)("action|new_video_room"),iconClassName:"mx_RoomListHeader_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"view_create_room",type:f?n.RoomType.UnstableCall:n.RoomType.ElementVideo}),p()}},o.createElement(pr.r,null)))),w&&(t=o.createElement(ur.$k,{label:(0,l._t)("room_list|join_public_room_label"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:W.a.ViewRoomDirectory}),kn.Z.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e),p()}})),T=o.createElement(ur.ZP,(0,kt.Z)({},Ql(m.current.getBoundingClientRect()),{onFinished:p,compact:!0}),o.createElement(ur.I2,{first:!0},e,t))}Z=g&&b?b:(0,cr.W4)(u,v);const N=[...E.entries()].filter((([e,t])=>t.size>0)).map((([e,t])=>{switch(e){case Xl.JoinRoom:return(0,l._t)("room_list|joining_rooms_status",{count:t.size});case Xl.BulkRedact:return(0,l._t)("room_list|redacting_messages_status",{count:t.size})}})).join("\n");let D=o.createElement("div",{className:"mx_RoomListHeader_contextLessTitle"},Z);if(y){const e={inputRef:a,onClick:r,isExpanded:s,className:"mx_RoomListHeader_contextMenuButton",children:Z};D=g?o.createElement(ii.lX,(0,kt.Z)({},e,{label:(0,l._t)("room_list|space_menu_label",{spaceName:null!=b?b:g.name})})):o.createElement(ii.JY,(0,kt.Z)({},e,{title:(0,l._t)("room_list|home_menu_label")}))}return o.createElement("div",{className:"mx_RoomListHeader"},D,N?o.createElement(fr.Z,{label:N},o.createElement(_r.Z,null)):null,P&&o.createElement(ii.JY,{inputRef:m,onClick:h,isExpanded:d,className:"mx_RoomListHeader_plusButton",title:(0,l._t)("action|add")}),T)};var tc=i("../matrix-react-sdk/src/stores/BreadcrumbsStore.ts"),ic=i("../matrix-react-sdk/src/stores/room-list/RoomListStore.ts"),nc=i("../matrix-react-sdk/node_modules/react-transition-group/cjs/index.js");const sc=({room:e,onClick:t})=>{const[i,n,s]=(0,Gi.XZ)();return o.createElement(gs.Z,{className:"mx_RoomBreadcrumbs_crumb",onClick:t,"aria-label":(0,l._t)("a11y|room_name",{name:e.name}),title:e.name,tooltipClassName:"mx_RoomBreadcrumbs_Tooltip",onFocus:i,inputRef:s,tabIndex:n?0:-1},o.createElement(us.Z,{room:e,size:"32px",displayBadge:!0,forceCount:!0,tooltipProps:{tabIndex:n?0:-1}}))};class oc extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"isMounted",!0),(0,k.Z)(this,"onBreadcrumbsUpdate",(()=>{this.isMounted&&(this.setState({doAnimation:!1,skipFirst:!0}),window.setTimeout((()=>this.setState({doAnimation:!0,skipFirst:!1})),0))})),(0,k.Z)(this,"viewRoom",((e,t,i=!1)=>{x.ZP.dispatch({action:W.a.ViewRoom,room_id:e.roomId,metricsTrigger:"WebHorizontalBreadcrumbs",metricsViaKeyboard:i})})),this.state={doAnimation:!0,skipFirst:!1},tc.$.instance.on(Pa.a,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.isMounted=!1,tc.$.instance.off(Pa.a,this.onBreadcrumbsUpdate)}render(){const e=tc.$.instance.rooms.map(((e,t)=>o.createElement(sc,{key:e.roomId,room:e,onClick:i=>this.viewRoom(e,t,"click"!==i.type)})));return e.length>0?o.createElement(nc.Kv,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs"},o.createElement(Hi.Z,{className:"mx_RoomBreadcrumbs","aria-label":(0,l._t)("room_list|breadcrumbs_label")},e.slice(this.state.skipFirst?1:0))):o.createElement("div",{className:"mx_RoomBreadcrumbs"},o.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},(0,l._t)("room_list|breadcrumbs_empty")))}}var ac=i("../matrix-react-sdk/src/components/views/typography/Heading.tsx");const rc=5e3;function lc(e,t){const[i,s]=(0,o.useState)(e),a=(0,pn.wb)(),l=function(e){const t=(0,o.useRef)(e);return t.current=e,(0,o.useCallback)(((...e)=>t.current(...e)),[])}(t);return(0,o.useEffect)((()=>{if(i)return;let e=null,t=!0;const o=async()=>{null!==e&&(clearTimeout(e),e=null),s(await l(a)),t&&(e=window.setTimeout(o,rc))};return o().catch((e=>r.k.warn("could not update user onboarding context",e))),a.on(n.ClientEvent.AccountData,o),()=>{t=!1,a.off(n.ClientEvent.AccountData,o),null!==e&&(clearTimeout(e),e=null)}}),[a,l,i]),i}var cc,dc,mc,hc,pc,uc,gc,vc,_c,fc,Ec,yc,bc,wc,Sc,Cc,kc,xc,Rc,Ic,Pc,Tc,Zc,Nc,Dc,Mc,Oc;function Ac(){return Ac=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Ac.apply(this,arguments)}function Lc(e,t){return o.createElement("svg",Ac({viewBox:"0 0 564 168",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0,ref:t},e),cc||(cc=o.createElement("defs",null,o.createElement("radialGradient",{id:"f-droid_svg__a",cx:113,cy:-12.89,r:59.662,gradientTransform:"matrix(0 1.9611 -1.9778 0 5.51 -198.6)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#fff",stopOpacity:.098,offset:0}),o.createElement("stop",{stopColor:"#fff",stopOpacity:0,offset:1})))),dc||(dc=o.createElement("path",{d:"M22 2h520c11.08 0 20 8.92 20 20v124c0 11.08-8.92 20-20 20H22c-11.08 0-20-8.92-20-20V22C2 10.92 10.92 2 22 2z",stroke:"#a6a6a6",strokeWidth:4})),mc||(mc=o.createElement("path",{d:"M199.26 45.46v-6.682h-5.499v-2.766h8.831v10.681q-1.949 1.383-4.299 2.1-2.349.7-5.015.7-5.832 0-9.131-3.4-3.283-3.415-3.283-9.497 0-6.099 3.283-9.498 3.3-3.416 9.131-3.416 2.433 0 4.616.6 2.2.6 4.049 1.766v3.583q-1.867-1.583-3.966-2.383-2.1-.8-4.416-.8-4.565 0-6.865 2.55-2.283 2.549-2.283 7.598 0 5.032 2.283 7.581 2.3 2.55 6.865 2.55 1.783 0 3.183-.3 1.4-.317 2.516-.967zm9.48-21.33h15.729v2.833h-12.364v7.365h11.847v2.832h-11.847v9.015h12.664v2.832H208.74zm18.12 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm35.14 0h3.366v24.877H262zm6.61 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm45.24 2.28q-3.666 0-5.832 2.733-2.15 2.732-2.15 7.448 0 4.699 2.15 7.431 2.166 2.733 5.832 2.733t5.799-2.733q2.15-2.732 2.15-7.431 0-4.716-2.15-7.448-2.133-2.733-5.799-2.733zm0-2.733q5.232 0 8.365 3.516 3.132 3.5 3.132 9.398 0 5.882-3.132 9.397-3.133 3.5-8.365 3.5-5.249 0-8.398-3.5-3.132-3.499-3.132-9.397t3.132-9.398q3.15-3.516 8.398-3.516zm16.76.453h4.532l11.031 20.812V24.13h3.266v24.877h-4.532l-11.031-20.812v20.812h-3.266z",fill:"#fff","aria-label":"GET IT ON"})),hc||(hc=o.createElement("path",{d:"M180.81 136v-8.118l7.19-1.391V78.017l-7.19-1.392v-8.164h53.762v18.508h-10.391l-.603-8.071h-22.034v18.6h23.657v10.438h-23.657v18.555l7.236 1.391V136zm62.16-23.66v-10.437h26.162v10.437zM277.29 136v-8.118l7.283-1.53v-48.15l-7.283-1.577v-8.164h29.641q9.045 0 15.957 4.268 6.912 4.221 10.762 11.736 3.897 7.468 3.897 17.163v1.252q0 9.602-3.85 17.117-3.804 7.468-10.67 11.736-6.865 4.268-15.91 4.268zm20.828-10.344h8.303q5.613 0 9.51-2.922 3.896-2.97 5.937-8.118 2.087-5.149 2.087-11.736v-1.299q0-6.68-2.087-11.782-2.041-5.149-5.938-8.025-3.896-2.922-9.509-2.922h-8.303zM344.79 136v-8.118l6.494-1.391V95.366l-7.19-1.392V85.81h19.807l.51 6.216.093 1.113q1.856-4.082 4.593-6.17 2.736-2.087 6.54-2.087 1.206 0 2.644.232 1.438.186 2.551.51l-1.438 12.478-6.726-.37q-2.876-.14-4.685.974-1.763 1.113-3.154 3.2v24.585l6.494 1.392V136zm63.08.98q-7.422 0-12.756-3.247t-8.164-9q-2.83-5.797-2.83-13.312v-.974q0-7.469 2.83-13.22 2.83-5.799 8.118-9.046 5.334-3.293 12.71-3.293 7.468 0 12.756 3.293 5.288 3.247 8.117 9t2.83 13.266v.974q0 7.515-2.83 13.313-2.83 5.752-8.117 9-5.289 3.247-12.664 3.247zm0-10.391q3.525 0 5.752-1.902t3.293-5.288q1.067-3.433 1.067-7.979v-.974q0-4.453-1.067-7.839-1.066-3.433-3.34-5.335-2.226-1.948-5.798-1.948-3.479 0-5.752 1.948-2.273 1.902-3.34 5.335-1.02 3.386-1.02 7.84v.973q0 4.546 1.02 7.979 1.067 3.433 3.34 5.334 2.273 1.856 5.845 1.856zM437.1 136v-8.118l6.54-1.391V95.366l-7.236-1.392V85.81h20.781v40.681l6.494 1.392V136zm6.077-60.813v-11.55h14.009v11.55zm44.293 61.793q-5.984 0-10.298-3.062-4.268-3.107-6.54-8.627-2.273-5.567-2.273-12.988v-.975q0-7.932 2.273-13.87 2.319-5.937 6.586-9.23 4.268-3.34 10.205-3.34 4.129 0 7.237 1.67 3.108 1.623 5.38 4.638V73.198l-7.236-1.391v-8.164h20.781v62.854l6.494 1.391v8.118h-18.23l-1.02-6.123q-2.366 3.479-5.66 5.288-3.246 1.81-7.7 1.81zm4.036-10.53q2.83 0 4.963-1.206 2.134-1.206 3.572-3.479v-21.292q-1.392-2.412-3.526-3.71-2.133-1.346-4.917-1.346-3.386 0-5.566 2.04-2.134 1.995-3.154 5.567-.974 3.572-.974 8.303v.975q0 6.587 2.226 10.39 2.227 3.758 7.376 3.758z",fill:"#fff","aria-label":"F-Droid"})),pc||(pc=o.createElement("path",{d:"M146.34 25.898l-11.184 14.474",fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579})),uc||(uc=o.createElement("path",{d:"M146.29 22.477c1.192.032 2.003.497 2.579 1.182-5.332 6.34-6.232 7.344-13.513 16.37-2.684 3.472-5.479 1.677-2.795-1.794l11.184-14.474a3.26 3.26 0 012.545-1.284z",color:"#000",fill:"#fff",fillOpacity:.298})),gc||(gc=o.createElement("path",{d:"M148.89 23.793a3.29 3.29 0 01.058 4.095l-11.184 14.474c-2.684 3.474-3.026-1.61-3.026-1.61s9.829-11.87 14.153-16.959z",color:"#000",fill:"#263238",fillOpacity:.2})),vc||(vc=o.createElement("path",{d:"M147 23.003c1.153 0 2.526.374 2.168 2.103-.27 1.318-12.263 15.984-12.263 15.984-2.684 3.47-6.563 1.779-3.879-1.693l11.142-14.4c.685-.763 1.603-1.957 2.832-1.994z",color:"#000",fill:"#8ab000"})),_c||(_c=o.createElement("path",{d:"M33.653 25.898l11.184 14.474",fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579})),fc||(fc=o.createElement("path",{d:"M33.711 22.477c-1.192.032-2.003.497-2.579 1.182 5.332 6.34 6.232 7.344 13.513 16.37 2.684 3.472 5.479 1.677 2.795-1.794L36.256 23.76a3.26 3.26 0 00-2.545-1.284z",color:"#000",fill:"#fff",fillOpacity:.298})),Ec||(Ec=o.createElement("path",{d:"M31.108 23.793a3.29 3.29 0 00-.058 4.095l11.184 14.474c2.684 3.474 3.026-1.61 3.026-1.61s-9.829-11.87-14.153-16.959z",color:"#000",fill:"#263238",fillOpacity:.2})),yc||(yc=o.createElement("path",{d:"M32.993 23.003c-1.153 0-2.526.374-2.168 2.103.27 1.318 12.263 15.984 12.263 15.984 2.684 3.47 6.563 1.779 3.879-1.693l-11.142-14.4c-.685-.763-1.603-1.957-2.832-1.994z",color:"#000",fill:"#8ab000"})),bc||(bc=o.createElement("path",{d:"M47.893 35.109h84.211a7.878 7.878 0 017.895 7.894v18.211a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895v-18.21a7.878 7.878 0 017.895-7.895z",fill:"#aeea00"})),wc||(wc=o.createElement("path",{d:"M47.893 42.74h84.211a7.878 7.878 0 017.895 7.895v10.526a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V50.635a7.878 7.878 0 017.895-7.895z",fill:"#263238",fillOpacity:.2})),Sc||(Sc=o.createElement("path",{d:"M47.893 35.109h84.211a7.878 7.878 0 017.895 7.894V53.53a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V43.003a7.878 7.878 0 017.895-7.894z",fill:"#fff",fillOpacity:.298})),Cc||(Cc=o.createElement("path",{d:"M47.893 38.003h84.211c4.374 0 7.895 2.883 7.895 6.462v15.079c0 3.58-3.521 6.462-7.895 6.462H47.893c-4.374 0-7.895-2.882-7.895-6.462V44.465c0-3.58 3.521-6.462 7.895-6.462z",fill:"#aeea00"})),kc||(kc=o.createElement("path",{d:"M47.893 71.944h84.211a7.878 7.878 0 017.895 7.895v52.211a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V79.839a7.878 7.878 0 017.895-7.895z",fill:"#1976d2"})),xc||(xc=o.createElement("path",{d:"M47.893 105.89h84.211a7.878 7.878 0 017.895 7.895v18.42a7.878 7.878 0 01-7.895 7.896H47.893a7.878 7.878 0 01-7.895-7.895v-18.421a7.878 7.878 0 017.895-7.895z",fill:"#263238",fillOpacity:.2})),Rc||(Rc=o.createElement("path",{d:"M47.893 71.681h84.211a7.878 7.878 0 017.895 7.895v18.421a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V79.576a7.878 7.878 0 017.895-7.895z",fill:"#fff",fillOpacity:.2})),Ic||(Ic=o.createElement("path",{d:"M47.893 75.102h84.211c4.374 0 7.895 3.19 7.895 7.154v47.693c0 3.963-3.521 7.153-7.895 7.153H47.893c-4.374 0-7.895-3.19-7.895-7.153V82.256c0-3.963 3.521-7.154 7.895-7.154z",fill:"#1976d2"})),Pc||(Pc=o.createElement("path",{d:"M89.998 89.714c-7.579 0-14 5.224-15.876 12.237h8.455a8.46 8.46 0 017.421-4.342 8.495 8.495 0 018.553 8.553 8.495 8.495 0 01-8.553 8.552 8.471 8.471 0 01-7.71-4.868h-8.3c1.69 7.279 8.242 12.763 16.01 12.763 9.038 0 16.449-7.41 16.449-16.448 0-9.037-7.41-16.448-16.448-16.448z",color:"#000",fill:"#0d47a1"})),Tc||(Tc=o.createElement("path",{d:"M115.13 106.16a25.132 25.132 0 01-25.132 25.132 25.132 25.132 0 01-25.131-25.132 25.132 25.132 0 0125.131-25.132 25.132 25.132 0 0125.132 25.132z",fill:"none",stroke:"#0d47a1",strokeLinecap:"round",strokeWidth:5})),Zc||(Zc=o.createElement("path",{d:"M73.55 52.477a8.882 10.197 0 01-8.88 10.198 8.882 10.197 0 01-8.882-10.198 8.882 10.197 0 018.881-10.197 8.882 10.197 0 018.882 10.197z",fill:"#263238",fillOpacity:.2})),Nc||(Nc=o.createElement("path",{d:"M73.55 53.793a8.882 8.882 0 01-8.88 8.882 8.882 8.882 0 01-8.882-8.882 8.882 8.882 0 018.881-8.882 8.882 8.882 0 018.882 8.882z",fill:"#fff"})),Dc||(Dc=o.createElement("path",{d:"M124.87 52.477a8.882 10.197 0 01-8.882 10.198 8.882 10.197 0 01-8.881-10.198 8.882 10.197 0 018.881-10.197 8.882 10.197 0 018.882 10.197z",fill:"#263238",fillOpacity:.2})),Mc||(Mc=o.createElement("path",{d:"M124.87 53.793a8.882 8.882 0 01-8.882 8.882 8.882 8.882 0 01-8.881-8.882 8.882 8.882 0 018.881-8.882 8.882 8.882 0 018.882 8.882z",fill:"#fff"})),Oc||(Oc=o.createElement("path",{d:"M33.71 22.47a3.29 3.29 0 00-2.662 5.336l9.474 12.262a7.894 7.894 0 00-.527 2.824v18.211a7.877 7.877 0 007.895 7.895h84.21a7.877 7.877 0 007.895-7.895v-18.21c0-1-.19-1.95-.525-2.827l9.472-12.26a3.29 3.29 0 00-2.433-5.334 3.29 3.29 0 00-2.772 1.31l-9.013 11.666a7.91 7.91 0 00-2.623-.45H47.89c-.922 0-1.8.163-2.621.45l-9.016-11.666a3.29 3.29 0 00-2.543-1.312zm14.18 49.527a7.877 7.877 0 00-7.894 7.894v52.211a7.877 7.877 0 007.894 7.895h84.211a7.877 7.877 0 007.894-7.895v-52.21a7.877 7.877 0 00-7.894-7.895z",color:"#000",fill:"url(#f-droid_svg__a)",fillRule:"evenodd"})))}var Uc=o.forwardRef(Lc);var Fc,Bc,Vc,jc,zc,Wc,Hc,Gc,Kc,qc,$c,Jc,Yc,Qc,Xc,ed,td,id,nd,sd,od,ad;function rd(){return rd=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},rd.apply(this,arguments)}function ld(e,t){return o.createElement("svg",rd({viewBox:"0 0 180 53.332",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0,ref:t},e),Fc||(Fc=o.createElement("defs",null,o.createElement("linearGradient",{id:"google-play_svg__a",x2:1,gradientTransform:"scale(-31.64 31.64) rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#00a0ff",offset:0}),o.createElement("stop",{stopColor:"#00a1ff",offset:.007}),o.createElement("stop",{stopColor:"#00beff",offset:.26}),o.createElement("stop",{stopColor:"#00d2ff",offset:.512}),o.createElement("stop",{stopColor:"#00dfff",offset:.76}),o.createElement("stop",{stopColor:"#00e3ff",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__b",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#ffe000",offset:0}),o.createElement("stop",{stopColor:"#ffbd00",offset:.409}),o.createElement("stop",{stopColor:"orange",offset:.775}),o.createElement("stop",{stopColor:"#ff9c00",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__c",x2:1,gradientTransform:"scale(-42.903 42.903) rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#ff3a44",offset:0}),o.createElement("stop",{stopColor:"#c31162",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__d",x2:1,gradientTransform:"scale(19.156 -19.156) rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#32a071",offset:0}),o.createElement("stop",{stopColor:"#2da771",offset:.069}),o.createElement("stop",{stopColor:"#15cf74",offset:.476}),o.createElement("stop",{stopColor:"#06e775",offset:.801}),o.createElement("stop",{stopColor:"#00f076",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__e",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#ccb300",offset:0}),o.createElement("stop",{stopColor:"#cc9700",offset:.409}),o.createElement("stop",{stopColor:"#cc8400",offset:.775}),o.createElement("stop",{stopColor:"#cc7d00",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__f",x2:1,gradientTransform:"scale(-42.903 42.903) rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#cc2e36",offset:0}),o.createElement("stop",{stopColor:"#9c0e4e",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__g",x2:1,gradientTransform:"scale(-31.64 31.64) rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#008de0",offset:0}),o.createElement("stop",{stopColor:"#008de0",offset:.007}),o.createElement("stop",{stopColor:"#00a7e0",offset:.26}),o.createElement("stop",{stopColor:"#00b8e0",offset:.512}),o.createElement("stop",{stopColor:"#00c4e0",offset:.76}),o.createElement("stop",{stopColor:"#00c7e0",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__h",x2:1,gradientTransform:"scale(-42.903 42.903) rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#e0333c",offset:0}),o.createElement("stop",{stopColor:"#ab0f56",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__i",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#e0c500",offset:0}),o.createElement("stop",{stopColor:"#e0a600",offset:.409}),o.createElement("stop",{stopColor:"#e09100",offset:.775}),o.createElement("stop",{stopColor:"#e08900",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__j",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#ffe840",offset:0}),o.createElement("stop",{stopColor:"#ffce40",offset:.409}),o.createElement("stop",{stopColor:"#ffbc40",offset:.775}),o.createElement("stop",{stopColor:"#ffb540",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__k",x2:1,gradientTransform:"scale(-31.64 31.64) rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#40b8ff",offset:0}),o.createElement("stop",{stopColor:"#40b9ff",offset:.007}),o.createElement("stop",{stopColor:"#40ceff",offset:.26}),o.createElement("stop",{stopColor:"#40ddff",offset:.512}),o.createElement("stop",{stopColor:"#40e7ff",offset:.76}),o.createElement("stop",{stopColor:"#40eaff",offset:1})),o.createElement("linearGradient",{id:"google-play_svg__l",x2:1,gradientTransform:"scale(19.156 -19.156) rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#65b895",offset:0}),o.createElement("stop",{stopColor:"#62bd95",offset:.069}),o.createElement("stop",{stopColor:"#50db97",offset:.476}),o.createElement("stop",{stopColor:"#44ed98",offset:.801}),o.createElement("stop",{stopColor:"#40f498",offset:1})))),Bc||(Bc=o.createElement("path",{d:"M173.33 53.332H6.67c-3.667 0-6.667-3-6.667-6.667V6.668c0-3.667 3-6.667 6.667-6.667h166.66c3.667 0 6.667 3 6.667 6.667v39.997c0 3.666-3 6.666-6.667 6.666"})),Vc||(Vc=o.createElement("path",{d:"M101.93 17.465v-5.118l-.044-1.544-.202.074 4.107 6.588h1.28V9.199h-1.295v4.816l.044 1.544.202-.074-3.927-6.286h-1.458v8.266",fill:"#fff"})),jc||(jc=o.createElement("path",{d:"M173.33 0H6.67C3.003 0 .003 3 .003 6.666v40c0 3.666 3 6.666 6.667 6.666h166.66c3.667 0 6.667-3 6.667-6.667V6.668c0-3.667-3-6.667-6.667-6.667m0 1.067c3.088 0 5.6 2.512 5.6 5.6v39.997c0 3.087-2.512 5.6-5.6 5.6H6.67a5.607 5.607 0 01-5.6-5.6v-40c0-3.087 2.512-5.6 5.6-5.6h166.66",fill:"#a6a6a6"})),zc||(zc=o.createElement("path",{d:"M63.356 13.657c0-.203-.02-.41-.058-.628l-.02-.11h-4.121v1.229h3.038v-.134l-.133-.011c-.058.67-.272 1.176-.632 1.537-.573.571-1.276.853-2.14.854-.81 0-1.499-.28-2.092-.85-.587-.568-.88-1.294-.881-2.212.001-.917.294-1.643.881-2.21.593-.571 1.281-.85 2.092-.851.902.002 1.582.3 2.088.901l.094.112.806-.807.086-.087-.079-.093c-.327-.39-.764-.7-1.3-.93a4.259 4.259 0 00-1.695-.347c-1.185-.001-2.208.416-3.038 1.24-.833.823-1.252 1.857-1.251 3.072-.001 1.215.418 2.25 1.252 3.073.829.824 1.852 1.24 3.037 1.24 1.234 0 2.258-.41 3.036-1.226l-.003.002c.691-.69 1.034-1.622 1.033-2.764M69.502 9.2h-4.937v8.265h4.937v-1.25h-3.643v-2.27h3.286v-1.227h-3.286v-2.27h3.643m4.335 0h2.234v-1.25h-5.764v1.25h2.235v7.017h1.295m7.239 0V9.199h-1.294v8.266m5.853-7.017h2.235v-1.25h-5.764v1.25h2.234v7.017h1.295m6.652-4.132c0-.903.284-1.627.85-2.203.57-.575 1.252-.858 2.078-.86.825.002 1.509.285 2.078.86.566.576.85 1.3.85 2.203s-.284 1.627-.85 2.202c-.57.576-1.253.858-2.078.86-.826-.002-1.508-.284-2.076-.86s-.852-1.3-.852-2.202zm5.957 3.058c.808-.83 1.217-1.86 1.216-3.058 0-1.193-.41-2.22-1.221-3.054-.813-.837-1.83-1.26-3.024-1.259-1.2-.001-2.221.42-3.028 1.254-.81.83-1.217 1.86-1.216 3.059-.001 1.199.406 2.228 1.214 3.06s1.83 1.253 3.03 1.251c1.2.002 2.22-.419 3.029-1.253m-7.387 12.612c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.691-2.405 5.691-5.67c0-3.287-2.555-5.67-5.691-5.67zm0 2.232c1.719 0 3.2 1.397 3.2 3.438 0 2.019-1.481 3.435-3.2 3.435-1.718 0-3.201-1.416-3.201-3.435 0-2.041 1.483-3.438 3.201-3.438zm-12.422-2.232c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.693-2.405 5.693-5.67c0-3.287-2.557-5.67-5.693-5.67zm0 2.232c1.718 0 3.201 1.397 3.201 3.438 0 2.019-1.483 3.435-3.201 3.435-1.719 0-3.2-1.416-3.2-3.435 0-2.041 1.481-3.438 3.2-3.438zm-14.772-.494v2.407h5.757c-.172 1.353-.623 2.34-1.31 3.028-.838.838-2.148 1.762-4.447 1.762-3.544 0-6.315-2.857-6.315-6.401s2.771-6.402 6.315-6.402c1.912 0 3.308.752 4.34 1.719l1.696-1.697c-1.439-1.375-3.35-2.427-6.036-2.427-4.854 0-8.935 3.952-8.935 8.807s4.08 8.806 8.935 8.806c2.621 0 4.597-.859 6.143-2.47 1.59-1.59 2.084-3.823 2.084-5.627 0-.56-.043-1.074-.129-1.504zm55.554-1.74c-2.921 0-5.348 2.3-5.348 5.672 0 3.179 2.405 5.67 5.627 5.67 2.6 0 4.105-1.59 4.727-2.514l-1.934-1.287c-.644.946-1.525 1.566-2.793 1.566-1.267 0-2.17-.578-2.75-1.716l7.582-3.137-.256-.645c-.472-1.268-1.912-3.609-4.855-3.609zm.086 2.191c.989 0 1.826.495 2.105 1.203l-5.068 2.106c-.065-2.191 1.696-3.309 2.963-3.309zm-9.126 8.807h2.493V23.332h-2.492zm-7.15-10.996c-2.835 0-5.434 2.49-5.434 5.691 0 3.18 2.599 5.65 5.434 5.65 1.353 0 2.428-.602 2.986-1.29h.086v.816c0 2.17-1.16 3.33-3.03 3.33-1.524 0-2.47-1.095-2.856-2.02l-2.17.903c.624 1.504 2.278 3.352 5.027 3.352 2.921 0 5.39-1.72 5.39-5.908v-10.18h-2.36v.921h-.087c-.558-.666-1.633-1.265-2.986-1.265zm.215 2.232c1.697 0 3.03 1.461 3.03 3.46 0 1.975-1.333 3.414-3.03 3.414-1.72 0-3.158-1.439-3.158-3.415 0-1.997 1.44-3.459 3.158-3.459zm26.545-7.904v16.668h2.486v-6.315h3.475c2.758 0 5.469-1.997 5.469-5.177s-2.711-5.176-5.47-5.176zm2.486 2.32h3.54c1.86 0 2.915 1.54 2.915 2.858 0 1.29-1.056 2.855-2.916 2.855h-3.539zm18.914 3.321c-1.8 0-3.667.792-4.44 2.55l2.21.923c.472-.922 1.349-1.223 2.273-1.223 1.286 0 2.594.773 2.615 2.144v.172c-.45-.257-1.414-.642-2.594-.642-2.38 0-4.804 1.308-4.804 3.752 0 2.23 1.951 3.668 4.138 3.668 1.673 0 2.596-.751 3.176-1.631h.084v1.287h2.402v-6.39c0-2.96-2.208-4.61-5.06-4.61zm.385 5.938c1.095 0 1.608.236 2.273.558-.193 1.544-1.52 2.639-2.957 2.639l-.002-.002c-.815 0-1.951-.405-1.951-1.414 0-1.286 1.416-1.781 2.637-1.781zm13.415-5.575l-2.852 7.227h-.085l-2.96-7.227h-2.68l4.438 10.1-2.53 5.619h2.596l6.84-15.719zm-22.4 10.664h2.488V23.331h-2.488z",fill:"#fff"})),Wc||(Wc=o.createElement("path",{d:"M14.007 43.191l-.099-.095c-.388-.41-.617-1.047-.617-1.873v.194V11.93v.203c0-.894.267-1.567.714-1.97l16.516 16.515-16.515 16.515m-.71-31.48v-.004.003m0-.01",fill:"url(#google-play_svg__a)"})),Hc||(Hc=o.createElement("path",{d:"M36.025 32.378l.126-.071 6.522-3.706c.622-.354 1.036-.782 1.243-1.236-.206.454-.621.883-1.243 1.236l-6.522 3.706-.126.071m.002-.195l-5.506-5.507 5.505-5.506 6.647 3.776c.844.48 1.318 1.098 1.397 1.73v.002c-.08.63-.553 1.248-1.397 1.728l-6.646 3.777",fill:"url(#google-play_svg__b)"})),Gc||(Gc=o.createElement("path",{d:"M15.184 43.819a1.723 1.723 0 00.002 0 2.515 2.515 0 00-.002 0m0-.195c-.46 0-.863-.15-1.177-.433l16.515-16.516 5.506 5.507L16.68 43.176c-.536.304-1.043.447-1.494.447m-1.182-.241a1.814 1.814 0 01-.086-.084l.086.084",fill:"url(#google-play_svg__c)"})),Kc||(Kc=o.createElement("path",{d:"M30.52 26.676L14.004 10.16a1.716 1.716 0 011.177-.433c.452 0 .96.145 1.496.449L36.025 21.17l-5.506 5.506m5.63-5.63L16.677 9.98c-.536-.304-1.044-.448-1.496-.448h-.005.007c.451 0 .959.144 1.494.448L36.15 21.045",fill:"url(#google-play_svg__d)"})),qc||(qc=o.createElement("path",{d:"M15.313 43.811c.42-.024.883-.168 1.371-.445l19.353-10.995-19.353 10.994c-.487.277-.952.42-1.371.445m-1.301-.43l-.004-.004a.038.038 0 01.004.004m-.09-.088l-.009-.008c.004.002.006.006.009.008"})),$c||($c=o.createElement("path",{d:"M36.025 32.378l.126-.071-.126.071",fill:"url(#google-play_svg__e)"})),Jc||(Jc=o.createElement("path",{d:"M15.185 43.819c-.461 0-.864-.15-1.178-.434a.038.038 0 00-.005-.003l-.086-.084-.008-.008.099-.1c.314.284.716.434 1.177.434.451 0 .958-.144 1.494-.448l19.348-10.994.124.124-.126.072L16.677 43.37c-.488.276-.952.42-1.37.444a2.515 2.515 0 01-.123.004",fill:"url(#google-play_svg__f)"})),Yc||(Yc=o.createElement("path",{d:"M13.914 43.285c-.388-.411-.617-1.049-.617-1.874 0 .825.23 1.462.617 1.873"})),Qc||(Qc=o.createElement("path",{d:"M13.908 43.29c-.388-.41-.617-1.047-.617-1.873v-.194c0 .825.23 1.462.617 1.873l.099.095-.099.099",fill:"url(#google-play_svg__g)"})),Xc||(Xc=o.createElement("path",{d:"M13.908 43.29l.099-.1v.001l-.099.099",fill:"url(#google-play_svg__h)"})),ed||(ed=o.createElement("path",{d:"M36.151 32.307l-.124-.124 6.646-3.777c.844-.48 1.318-1.098 1.397-1.728 0 .231-.051.463-.154.688-.207.453-.62.882-1.243 1.235l-6.522 3.706",fill:"url(#google-play_svg__i)"})),td||(td=o.createElement("path",{d:"M44.083 26.667c0-.698-.467-1.395-1.398-1.924l-6.523-3.707 6.523 3.706c.932.53 1.399 1.228 1.398 1.925",fill:"#404040"})),id||(id=o.createElement("path",{d:"M44.07 26.675c-.08-.632-.553-1.25-1.397-1.73l-6.647-3.775.124-.124 6.523 3.706c.93.529 1.397 1.226 1.397 1.923",fill:"url(#google-play_svg__j)"})),nd||(nd=o.createElement("path",{d:"M13.297 11.917v-.002.002m.006-.217v-.003.003m0-.006v-.006.006m0-.008c.077-1.37.822-2.16 1.876-2.165a1.715 1.715 0 00-1.166.433l-.004.003c-.033.03-.064.061-.095.093-.35.37-.57.925-.61 1.636",fill:"#404040"})),sd||(sd=o.createElement("path",{d:"M13.291 12.132v-.204c0-.073.002-.145.006-.215V11.7c.04-.71.261-1.265.61-1.635l.098.097c-.447.404-.714 1.077-.714 1.97m.712-2.16l.003-.004-.003.003",fill:"url(#google-play_svg__k)"})),od||(od=o.createElement("path",{d:"M15.178 9.521h.004-.004",fill:"#404040"})),ad||(ad=o.createElement("path",{d:"M36.025 21.17L16.677 10.176c-.536-.304-1.044-.448-1.496-.448-.46 0-.863.15-1.177.432l-.097-.097a1.78 1.78 0 01.095-.094l.003-.003c.312-.28.71-.43 1.166-.433h.01c.452 0 .96.144 1.496.448l19.472 11.064-.125.125",fill:"url(#google-play_svg__l)"})))}var cd=o.forwardRef(ld);var dd,md,hd;function pd(){return pd=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},pd.apply(this,arguments)}function ud(e,t){return o.createElement("svg",pd({viewBox:"0 0 159.55 53.333",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0,ref:t},e),dd||(dd=o.createElement("path",{d:"M146.84.001H12.71c-.489 0-.972 0-1.46.003-.407.002-.812.01-1.224.016-.888.023-1.786.077-2.672.236a8.876 8.876 0 00-2.535.836A8.58 8.58 0 001.09 4.825a8.782 8.782 0 00-.833 2.538c-.16.883-.216 1.776-.24 2.669-.012.409-.013.82-.02 1.228v30.818c.007.414.008.815.02 1.23.024.893.08 1.786.24 2.669.155.893.418 1.73.833 2.539a8.28 8.28 0 001.571 2.152 8.356 8.356 0 002.158 1.571 8.95 8.95 0 002.535.842c.886.158 1.784.21 2.672.235.412.01.817.015 1.225.015.488.002.97.002 1.46.002h134.13c.48 0 .966 0 1.445-.002.408 0 .824-.006 1.23-.015.894-.025 1.79-.077 2.667-.235a9.083 9.083 0 002.544-.842 8.417 8.417 0 002.157-1.57 8.556 8.556 0 001.573-2.153c.41-.809.676-1.646.826-2.54.165-.882.216-1.775.249-2.669.004-.414.004-.815.004-1.229.01-.484.01-.966.01-1.458V12.715c0-.488 0-.972-.01-1.455 0-.409 0-.82-.004-1.228-.033-.893-.084-1.786-.25-2.67a8.763 8.763 0 00-.825-2.537 8.626 8.626 0 00-1.573-2.162 8.641 8.641 0 00-2.157-1.57 9.02 9.02 0 00-2.544-.837c-.877-.159-1.773-.213-2.667-.236-.406-.006-.822-.014-1.23-.016C147.807 0 147.322 0 146.84 0",fill:"#b2b1b1"})),md||(md=o.createElement("path",{d:"M11.267 52.166c-.407 0-.803-.005-1.206-.014-.745-.021-1.63-.062-2.492-.217a7.847 7.847 0 01-2.21-.731 7.214 7.214 0 01-1.862-1.355 7.092 7.092 0 01-1.36-1.862 7.616 7.616 0 01-.724-2.21c-.163-.897-.205-1.807-.222-2.5-.01-.28-.02-1.217-.02-1.217v-30.8s.012-.922.02-1.193c.017-.698.059-1.607.22-2.495.143-.818.38-1.54.725-2.216.354-.7.808-1.325 1.353-1.864a7.423 7.423 0 011.87-1.363 7.762 7.762 0 012.204-.726c.898-.16 1.808-.2 2.5-.219l1.204-.016h137.02l1.217.017c.684.017 1.595.057 2.48.217.802.14 1.53.38 2.227.73.684.35 1.31.808 1.855 1.354a7.38 7.38 0 011.365 1.873c.344.681.577 1.403.715 2.198.153.841.2 1.705.23 2.517.004.377.004.783.004 1.187.012.5.012.975.012 1.455V40.62c0 .485 0 .957-.012 1.434 0 .434 0 .831-.005 1.24-.028.785-.076 1.648-.228 2.47a7.664 7.664 0 01-.72 2.228 7.297 7.297 0 01-1.353 1.847 7.268 7.268 0 01-1.866 1.363 7.855 7.855 0 01-2.225.733c-.853.155-1.737.197-2.492.218-.39.009-.8.014-1.197.014l-1.445.003-135.58-.003",fill:"#040403"})),hd||(hd=o.createElement("path",{d:"M33.032 27.068c-.034-3.668 3.002-5.452 3.141-5.536-1.72-2.507-4.385-2.85-5.321-2.877-2.239-.235-4.41 1.34-5.551 1.34-1.162 0-2.92-1.317-4.81-1.278-2.436.038-4.715 1.448-5.964 3.638-2.579 4.464-.656 11.026 1.814 14.633 1.236 1.769 2.68 3.742 4.57 3.672 1.85-.077 2.54-1.18 4.773-1.18 2.212 0 2.86 1.18 4.788 1.135 1.984-.032 3.235-1.775 4.427-3.559 1.428-2.026 2.002-4.02 2.024-4.123-.046-.016-3.854-1.469-3.891-5.865m-3.643-10.786c.994-1.244 1.675-2.936 1.486-4.654-1.44.064-3.24.995-4.276 2.213-.918 1.072-1.738 2.83-1.526 4.481 1.618.12 3.278-.816 4.316-2.04m21.362 17.839h5.002l-2.466-7.261h-.068zm5.658 2.066h-6.312l-1.515 4.475h-2.673l5.977-16.557h2.778l5.977 16.557h-2.718l-1.514-4.475m14.596-1.56c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061zm2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m10.738.001c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061zm2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m8.78 1.422c.184 1.642 1.78 2.72 3.96 2.72 2.088 0 3.59-1.078 3.59-2.558 0-1.285-.906-2.055-3.052-2.582l-2.146-.517c-3.04-.735-4.451-2.157-4.451-4.463 0-2.857 2.489-4.82 6.024-4.82 3.499 0 5.897 1.963 5.978 4.82h-2.501c-.15-1.653-1.516-2.65-3.512-2.65s-3.362 1.01-3.362 2.477c0 1.171.873 1.86 3.007 2.387l1.824.448c3.397.804 4.808 2.168 4.808 4.59 0 3.097-2.467 5.038-6.392 5.038-3.671 0-6.15-1.895-6.31-4.89h2.536m15.514-10.314v2.857h2.296v1.962h-2.296v6.655c0 1.034.46 1.515 1.469 1.515.253 0 .655-.035.815-.057v1.95c-.274.07-.826.115-1.376.115-2.444 0-3.397-.918-3.397-3.26v-6.918h-1.755V28.59h1.755v-2.857h2.49m12.551 8.894c0-2.605-1.194-4.143-3.202-4.143-2.007 0-3.2 1.55-3.2 4.143 0 2.616 1.193 4.142 3.2 4.142 2.008 0 3.202-1.526 3.202-4.142zm-8.927 0c0-3.798 2.237-6.184 5.725-6.184 3.5 0 5.727 2.386 5.727 6.184 0 3.809-2.215 6.185-5.727 6.185-3.51 0-5.725-2.376-5.725-6.185m13.495-6.036h2.363v2.055h.058c.378-1.367 1.48-2.182 2.903-2.182.356 0 .653.047.85.093v2.318c-.197-.082-.633-.15-1.114-.15-1.595 0-2.582 1.079-2.582 2.777v7.16h-2.478V28.591m9.218 4.922h6.035c-.058-1.847-1.239-3.064-2.96-3.064-1.71 0-2.948 1.24-3.075 3.064zm8.376 3.603c-.333 2.192-2.467 3.696-5.197 3.696-3.512 0-5.692-2.353-5.692-6.128 0-3.786 2.192-6.242 5.588-6.242 3.34 0 5.44 2.294 5.44 5.954v.85h-8.527v.15c0 2.064 1.298 3.418 3.248 3.418 1.376 0 2.456-.654 2.788-1.698h2.352M48.803 18.473h1.5c1.664 0 2.623-1.037 2.623-2.862 0-1.797-.975-2.845-2.623-2.845h-1.5zm1.638-6.831c2.36 0 3.744 1.45 3.744 3.953 0 2.542-1.374 4.003-3.744 4.003h-2.873v-7.956h2.873m9.583 4.951c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067zm-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.832-1.174-2.832-3.12m13.188 3.005H67.54l-1.24-4.422h-.095l-1.235 4.422h-1.218l-1.654-6.004h1.201l1.076 4.581h.088l1.234-4.58h1.138l1.234 4.58h.094l1.07-4.58h1.185l-1.649 6.003m3.042-6.004h1.14v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184v-6.004m6.986-2.344h1.185v8.347h-1.185V11.25m7.276 5.343c0-1.301-.585-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.025 0 1.61-.76 1.61-2.067zm-4.444 0c0-1.936 1.08-3.115 2.833-3.115 1.749 0 2.83 1.18 2.83 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.833-1.174-2.833-3.12m10.769.794v-.501l-1.466.093c-.827.056-1.202.337-1.202.866 0 .54.47.855 1.113.855.894 0 1.555-.569 1.555-1.313zm-3.86.513c0-1.08.805-1.703 2.234-1.792l1.626-.094v-.518c0-.634-.42-.992-1.23-.992-.66 0-1.119.243-1.25.667h-1.147c.12-1.031 1.09-1.693 2.453-1.693 1.505 0 2.354.75 2.354 2.018v4.102h-1.14v-.844h-.095c-.357.601-1.014.943-1.803.943-1.158 0-2.001-.7-2.001-1.797m7.82-1.307c0 1.273.6 2.04 1.604 2.04 1 0 1.617-.778 1.617-2.035 0-1.251-.624-2.04-1.617-2.04-.997 0-1.604.772-1.604 2.035zm-1.224 0c0-1.897.976-3.1 2.492-3.1.822 0 1.516.392 1.842 1.054h.088V11.25h1.185v8.347h-1.135v-.948h-.094c-.358.656-1.058 1.047-1.886 1.047-1.527 0-2.492-1.201-2.492-3.103m14.953 0c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067zm-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.757 0-2.832-1.174-2.832-3.12m7.252-2.999h1.141v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184v-6.004m11.793-1.494v1.521h1.3v.999h-1.3v3.087c0 .629.258.904.849.904.182 0 .286-.011.451-.027v.987c-.193.032-.414.06-.644.06-1.318 0-1.843-.464-1.843-1.621v-3.39h-.953v-.999h.953V12.1h1.187m2.919-.85h1.175v3.308h.094c.291-.673.925-1.075 1.83-1.075 1.279 0 2.068.81 2.068 2.238v3.876h-1.186v-3.583c0-.96-.447-1.445-1.284-1.445-.972 0-1.512.612-1.512 1.522v3.506h-1.185V11.25m7.914 4.792h3.033c-.028-.943-.601-1.555-1.479-1.555-.876 0-1.488.617-1.554 1.555zm4.168 1.935c-.27 1.075-1.23 1.737-2.602 1.737-1.72 0-2.773-1.18-2.773-3.1 0-1.918 1.076-3.136 2.768-3.136 1.67 0 2.679 1.142 2.679 3.026v.414h-4.24v.067c.04 1.052.652 1.72 1.598 1.72.719 0 1.21-.26 1.43-.728h1.14",fill:"#fff"})))}var gd=o.forwardRef(ud);var vd=i("../matrix-react-sdk/src/components/views/elements/QRCode.tsx");const _d=({onFinished:e})=>{const t=c.ZP.get("brand"),i=c.ZP.getObject("desktop_builds"),n=c.ZP.getObject("mobile_builds"),s=null==n?void 0:n.get("ios"),a=null==n?void 0:n.get("android"),r=null==n?void 0:n.get("fdroid"),d=null!=a?a:r;return o.createElement(q.Z,{title:(0,l._t)("onboarding|download_brand",{brand:t}),className:"mx_AppDownloadDialog",fixedWidth:!0,onFinished:e},(null==i?void 0:i.get("available"))&&o.createElement("div",{className:"mx_AppDownloadDialog_desktop"},o.createElement(ac.Z,{size:"3"},(0,l._t)("onboarding|download_brand_desktop",{brand:t})),o.createElement(ae.Z,{kind:"primary",element:"a",href:null==i?void 0:i.get("url"),target:"_blank",onClick:()=>{}},(0,l._t)("onboarding|download_brand_desktop",{brand:t}))),o.createElement("div",{className:"mx_AppDownloadDialog_mobile"},s&&o.createElement("div",{className:"mx_AppDownloadDialog_app"},o.createElement(ac.Z,{size:"3"},(0,l._t)("common|ios")),o.createElement(vd.Z,{data:s,margin:0,width:172}),o.createElement("div",{className:"mx_AppDownloadDialog_info"},(0,l._t)("onboarding|qr_or_app_links",{appLinks:"",qrCode:""})),o.createElement("div",{className:"mx_AppDownloadDialog_links"},o.createElement(ae.Z,{element:"a",href:s,target:"_blank","aria-label":(0,l._t)("onboarding|download_app_store"),onClick:()=>{}},o.createElement(gd,null)))),d&&o.createElement("div",{className:"mx_AppDownloadDialog_app"},o.createElement(ac.Z,{size:"3"},(0,l._t)("common|android")),o.createElement(vd.Z,{data:d,margin:0,width:172}),o.createElement("div",{className:"mx_AppDownloadDialog_info"},(0,l._t)("onboarding|qr_or_app_links",{appLinks:"",qrCode:""})),o.createElement("div",{className:"mx_AppDownloadDialog_links"},a&&o.createElement(ae.Z,{element:"a",href:a,target:"_blank","aria-label":(0,l._t)("onboarding|download_google_play"),onClick:()=>{}},o.createElement(cd,null)),r&&o.createElement(ae.Z,{element:"a",href:r,target:"_blank","aria-label":(0,l._t)("onboarding|download_f_droid"),onClick:()=>{}},o.createElement(Uc,null))))),o.createElement("div",{className:"mx_AppDownloadDialog_legal"},o.createElement("p",null,(0,l._t)("onboarding|apple_trademarks")),o.createElement("p",null,(0,l._t)("onboarding|google_trademarks"))))};let fd=function(e){return e.PersonalMessaging="PersonalMessaging",e.WorkMessaging="WorkMessaging",e.CommunityMessaging="CommunityMessaging",e.Skip="Skip",e}({});function Ed(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function yd(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ed(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ed(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const bd=e=>{kn.Z.trackInteraction("WebUserOnboardingTaskSendDm",e),x.ZP.dispatch({action:"view_create_chat"})},wd=[{id:"create-account",title:(0,l._t)("auth|create_account_title"),description:(0,l._t)("onboarding|you_made_it"),completed:()=>!0},{id:"find-friends",title:(0,l._t)("onboarding|find_friends"),description:(0,l._t)("onboarding|find_friends_description"),completed:e=>e.hasDmRooms,relevant:[fd.PersonalMessaging,fd.Skip],action:{label:(0,l._t)("onboarding|find_friends_action"),onClick:bd}},{id:"find-coworkers",title:(0,l._t)("onboarding|find_coworkers"),description:(0,l._t)("onboarding|get_stuff_done"),completed:e=>e.hasDmRooms,relevant:[fd.WorkMessaging],action:{label:(0,l._t)("onboarding|find_people"),onClick:bd}},{id:"find-community-members",title:(0,l._t)("onboarding|find_community_members"),description:(0,l._t)("onboarding|get_stuff_done"),completed:e=>e.hasDmRooms,relevant:[fd.CommunityMessaging],action:{label:(0,l._t)("onboarding|find_people"),onClick:bd}},{id:"download-apps",title:()=>(0,l._t)("onboarding|download_app",{brand:c.ZP.get("brand")}),description:()=>(0,l._t)("onboarding|download_app_description",{brand:c.ZP.get("brand")}),completed:e=>e.hasDevices,action:{label:(0,l._t)("onboarding|download_app_action"),onClick:e=>{kn.Z.trackInteraction("WebUserOnboardingTaskDownloadApps",e),T.ZP.createDialog(_d,{},"mx_AppDownloadDialog_wrapper",!1,!0)}},disabled:()=>!(()=>{const e=c.ZP.getObject("desktop_builds"),t=c.ZP.getObject("mobile_builds");return!!(null!=e&&e.get("available")||null!=t&&t.get("ios")||null!=t&&t.get("android")||null!=t&&t.get("fdroid"))})()},{id:"setup-profile",title:(0,l._t)("onboarding|set_up_profile"),description:(0,l._t)("onboarding|set_up_profile_description"),completed:e=>e.hasAvatar,action:{label:(0,l._t)("onboarding|set_up_profile_action"),onClick:e=>{kn.Z.trackInteraction("WebUserOnboardingTaskSetupProfile",e),x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.General})}}},{id:"permission-notifications",title:(0,l._t)("onboarding|enable_notifications"),description:(0,l._t)("onboarding|enable_notifications_description"),completed:e=>e.hasNotificationsEnabled,action:{label:(0,l._t)("onboarding|enable_notifications_action"),onClick:e=>{kn.Z.trackInteraction("WebUserOnboardingTaskEnableNotifications",e),S.Notifier.setEnabled(!0)},hideOnComplete:!0}}];function Sd(e){var t;const i=null!==(t=(0,wt.t)("FTUE.useCaseSelection"))&&void 0!==t?t:fd.Skip;return(0,o.useMemo)((()=>wd.filter((e=>{var t;return(null===(t=e.disabled)||void 0===t||!t.call(e))&&(!e.relevant||e.relevant.includes(i))})).map((t=>yd(yd({},t),{},{completed:t.completed(e)})))),[e,i])}var Cd=i("../matrix-react-sdk/node_modules/sanitize-html/index.js"),kd=i.n(Cd);class xd extends o.PureComponent{constructor(e,t){super(e,t),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"dispatcherRef",null),(0,k.Z)(this,"onAction",(e=>{"client_started"===e.action&&this.forceUpdate()})),this.state={page:""}}translate(e){return kd()((0,l._t)(e))}async fetchEmbed(){let e;try{e=await fetch(this.props.url,{method:"GET"})}catch(e){if(this.unmounted)return;return r.k.warn(`Error loading page: ${e}`),void this.setState({page:(0,l._t)("cant_load_page")})}if(this.unmounted)return;if(!e.ok)return r.k.warn(`Error loading page: ${e.status}`),void this.setState({page:(0,l._t)("cant_load_page")});let t=(await e.text()).replace(/_t\(['"]([\s\S]*?)['"]\)/gm,((e,t)=>this.translate(t)));this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach((e=>{t=t.split(e).join(this.props.replaceMap[e])})),this.setState({page:t})}componentDidMount(){this.unmounted=!1,this.props.url&&(this.fetchEmbed(),this.dispatcherRef=x.ZP.register(this.onAction))}componentWillUnmount(){this.unmounted=!0,null!==this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef)}render(){const e=this.context||E.p.get(),t=!e||e.isGuest(),i=this.props.className,n=yt()(i,{[`${i}_guest`]:t,[`${i}_loggedIn`]:!!e}),s=o.createElement("div",{className:`${i}_body`,dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?o.createElement(Ln.Z,{className:n},s):o.createElement("div",{className:n},s)}}(0,k.Z)(xd,"contextType",pn.ZP);var Rd=i("../matrix-react-sdk/src/hooks/useTimeout.ts"),Id=i("../matrix-react-sdk/src/utils/BrowserWorkarounds.ts");const Pd="52px",Td=({hasAvatar:e,hasAvatarLabel:t,noAvatarLabel:i,setAvatarUrl:s,isUserAvatar:a,children:r,onClick:l})=>{var c;const d=(0,o.useContext)(pn.ZP),[m,h]=(0,o.useState)(!1),[p,u]=(0,o.useState)(!1),[g,v]=(0,o.useState)(!1);(0,Rd.KS)((()=>{v(!0)}),3e3),(0,Rd.KS)((()=>{v(!1)}),13e3);const _=(0,o.useRef)(null),f=e||m?t:i,{room:E}=(0,o.useContext)(qt.ZP);if(!(a||(null==E||null===(c=E.currentState)||void 0===c?void 0:c.maySendStateEvent(n.EventType.RoomAvatar,d.getSafeUserId()))))return o.createElement(o.Fragment,null,r);const y=!!f&&(p||g);return o.createElement(o.Fragment,null,o.createElement("input",{type:"file",ref:_,className:"mx_MiniAvatarUploader_input",onClick:e=>{(0,Id.k)(e),null==l||l(e)},onChange:async e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;h(!0);const i=e.target.files[0],{content_uri:n}=await d.uploadContent(i);await s(n),h(!1)},accept:"image/*"}),o.createElement(ae.Z,{className:yt()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:m,mx_MiniAvatarUploader_hasAvatar:e}),disabled:m,onClick:()=>{var e;null===(e=_.current)||void 0===e||e.click()},onMouseOver:()=>u(!0),onMouseLeave:()=>u(!1)},r,o.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},m?o.createElement(re.Z,{w:20,h:20}):o.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})),o.createElement("div",{className:yt()("mx_Tooltip",{mx_Tooltip_visible:y,mx_Tooltip_invisible:!y})},o.createElement("div",{className:"mx_Tooltip_chevron"}),f)))},Zd=e=>{var t;return{displayName:Ml.p.instance.displayName||e,avatarUrl:null!==(t=Ml.p.instance.getHttpAvatarUrl(parseInt(Pd,10)))&&void 0!==t?t:void 0}},Nd=()=>{const e=(0,o.useContext)(pn.ZP),t=e.getUserId(),[i,n]=(0,o.useState)(Zd(t));return(0,In.x2)(Ml.p.instance,Pa.a,(()=>{n(Zd(t))})),o.createElement("div",null,o.createElement(Td,{hasAvatar:!!i.avatarUrl,hasAvatarLabel:(0,l.i3)("onboarding|has_avatar_label"),noAvatarLabel:(0,l.i3)("onboarding|no_avatar_label"),setAvatarUrl:t=>e.setAvatarUrl(t),isUserAvatar:!0,onClick:e=>kn.Z.trackInteraction("WebHomeMiniAvatarUploadButton",e)},o.createElement(ys.Z,{idName:t,name:i.displayName,url:i.avatarUrl,size:Pd})),o.createElement("h1",null,(0,l.i3)("onboarding|welcome_user",{name:i.displayName})),o.createElement("h2",null,(0,l.i3)("onboarding|welcome_detail")))},Dd=({justRegistered:e=!1})=>{const t=(0,pn.wb)(),i=c.ZP.get(),n=Pl(i,t);if(n)return o.createElement(xd,{className:"mx_HomePage",url:n,scrollbar:!0});let s;if(e||!Ml.p.instance.getHttpAvatarUrl(parseInt(Pd,10)))s=o.createElement(Nd,null);else{var a;const e=c.ZP.getObject("branding"),t=null!==(a=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==a?a:"themes/element/img/logos/element-logo.svg";s=o.createElement(o.Fragment,null,o.createElement("img",{src:t,alt:i.brand}),o.createElement("h1",null,(0,l.i3)("onboarding|intro_welcome",{appName:i.brand})),o.createElement("h2",null,(0,l.i3)("onboarding|intro_byline")))}return o.createElement("div",null)},Md=e=>{kn.Z.trackInteraction("WebUserOnboardingHeaderSendDm",e),x.ZP.dispatch({action:"view_create_chat"})};function Od({useCase:e}){let t,n,s,a=(0,l._t)("onboarding|free_e2ee_messaging_unlimited_voip",{brand:c.ZP.get("brand")});switch(e){case fd.PersonalMessaging:t=(0,l._t)("onboarding|personal_messaging_title"),n=i("../matrix-react-sdk/res/img/user-onboarding/PersonalMessaging.png"),s=(0,l._t)("onboarding|personal_messaging_action");break;case fd.WorkMessaging:t=(0,l._t)("onboarding|work_messaging_title"),a=(0,l._t)("onboarding|free_e2ee_messaging_unlimited_voip",{brand:c.ZP.get("brand")}),n=i("../matrix-react-sdk/res/img/user-onboarding/WorkMessaging.png"),s=(0,l._t)("onboarding|work_messaging_action");break;case fd.CommunityMessaging:t=(0,l._t)("onboarding|community_messaging_title"),a=(0,l._t)("onboarding|community_messaging_description"),n=i("../matrix-react-sdk/res/img/user-onboarding/CommunityMessaging.png"),s=(0,l._t)("onboarding|community_messaging_action");break;default:t=(0,l._t)("onboarding|welcome_to_brand",{brand:c.ZP.get("brand")}),n=i("../matrix-react-sdk/res/img/user-onboarding/PersonalMessaging.png"),s=(0,l._t)("onboarding|personal_messaging_action")}return o.createElement("div",{className:"mx_UserOnboardingHeader"},o.createElement("div",{className:"mx_UserOnboardingHeader_content"},o.createElement(ac.Z,{size:"1"},t,o.createElement("span",{className:"mx_UserOnboardingHeader_dot"},".")),o.createElement("p",null,a),o.createElement(ae.Z,{onClick:Md,kind:"primary"},s)),o.createElement("img",{className:"mx_UserOnboardingHeader_image",src:n,alt:""}))}var Ad=i("../matrix-react-sdk/src/components/views/elements/ProgressBar.tsx");function Ld({task:e,completed:t=!1}){var i;const n="function"==typeof e.title?e.title():e.title,s="function"==typeof e.description?e.description():e.description;return o.createElement("li",{"data-testid":"user-onboarding-task",className:yt()("mx_UserOnboardingTask",{mx_UserOnboardingTask_completed:t})},o.createElement("div",{className:"mx_UserOnboardingTask_number",role:"checkbox","aria-disabled":"true","aria-checked":t,"aria-labelledby":`mx_UserOnboardingTask_${e.id}`}),o.createElement("div",{id:`mx_UserOnboardingTask_${e.id}`,className:"mx_UserOnboardingTask_content"},o.createElement(ac.Z,{size:"4",className:"mx_UserOnboardingTask_title"},n),o.createElement("div",{className:"mx_UserOnboardingTask_description"},s)),e.action&&(!e.action.hideOnComplete||!t)&&o.createElement(ae.Z,{element:"a",className:"mx_UserOnboardingTask_action",kind:"primary_outline",href:e.action.href,target:"_blank",onClick:null!==(i=e.action.onClick)&&void 0!==i?i:null},e.action.label))}const Ud=e=>{const t=e.filter((e=>!0===e.completed)).length,i=e.filter((e=>!1===e.completed)).length;return{completed:t,waiting:i,total:t+i}};function Fd({tasks:e}){const{completed:t,waiting:i,total:n}=Ud(e);return o.createElement("div",{className:"mx_UserOnboardingList","data-testid":"user-onboarding-list"},o.createElement("div",{className:"mx_UserOnboardingList_header"},o.createElement(ac.Z,{size:"3",className:"mx_UserOnboardingList_title"},i>0?(0,l._t)("onboarding|only_n_steps_to_go",{count:i}):(0,l._t)("onboarding|you_did_it")),o.createElement("div",{className:"mx_UserOnboardingList_hint"},(0,l._t)("onboarding|complete_these",{brand:c.ZP.get("brand")}))),o.createElement("div",{className:"mx_UserOnboardingList_progress"},o.createElement(Ad.Z,{value:t,max:n,animated:!0})),o.createElement("ol",{className:"mx_UserOnboardingList_list"},e.map((e=>o.createElement(Ld,{key:e.id,completed:e.completed,task:e})))))}const Bd=new Date(1656633600);function Vd(e){return null!==e||E.p.userRegisteredAfter(Bd)}function jd({justRegistered:e=!1}){const t=(0,pn.wb)(),i=Pl(c.ZP.get(),t),s=(0,wt.t)("FTUE.useCaseSelection"),a=function(){const e=lc(!1,(async e=>{const t=await e.getProfileInfo(e.getUserId());return Boolean(null==t?void 0:t.avatar_url)})),t=lc(!1,(async e=>{const t=e.getDeviceId(),i=await e.getDevices();return Boolean(i.devices.find((e=>e.device_id!==t)))})),i=lc(!1,(async()=>{var e;const t=null!==(e=P.Z.shared().getUniqueRoomsWithIndividuals())&&void 0!==e?e:{};return Boolean(Object.keys(t).length)})),n=lc(!1,(async()=>S.Notifier.isPossible()));return(0,o.useMemo)((()=>({hasAvatar:e,hasDevices:t,hasDmRooms:i,hasNotificationsEnabled:n})),[e,t,i,n])}(),r=Sd(a),l=function(){const e=(0,pn.wb)();return(0,In.kZ)(e,n.ClientEvent.Sync,(()=>e.isInitialSyncComplete()))}(),[d,m]=(0,o.useState)(!1);return(0,o.useEffect)((()=>{if(l){const e=window.setTimeout((()=>{m(!0)}),2800);return()=>{clearTimeout(e)}}m(!1)}),[l,m]),Vd(s)?i?o.createElement(xd,{className:"mx_HomePage",url:i,scrollbar:!0}):o.createElement(Ln.Z,{className:"mx_UserOnboardingPage"},o.createElement(Od,{useCase:s}),d&&o.createElement(Fd,{tasks:r})):o.createElement(Dd,{justRegistered:e})}function zd({selected:e,minimized:t}){const i=(0,wt.t)("FTUE.useCaseSelection");return(0,wt.t)("FTUE.userOnboardingButton")&&!t&&Vd(i)?o.createElement(Wd,{selected:e,minimized:t}):o.createElement(o.Fragment,null)}function Wd({selected:e,minimized:t}){const i=(0,o.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),kn.Z.trackInteraction("WebRoomListUserOnboardingIgnoreButton",e),L.C.setValue("FTUE.userOnboardingButton",null,U.R.ACCOUNT,!1)}),[]),n=(0,o.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),kn.Z.trackInteraction("WebRoomListUserOnboardingButton",e),x.ZP.fire(W.a.ViewHomePage)}),[]);return o.createElement(ae.Z,{className:yt()("mx_UserOnboardingButton",{mx_UserOnboardingButton_selected:e,mx_UserOnboardingButton_minimized:t}),onClick:n},!t&&o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_UserOnboardingButton_content"},o.createElement(ac.Z,{size:"4",className:"mx_Heading_h4"},(0,l._t)("common|welcome")),o.createElement(ae.Z,{className:"mx_UserOnboardingButton_close",onClick:i}))))}var Hd=function(e){return e[e.Disabled=0]="Disabled",e[e.Legacy=1]="Legacy",e}(Hd||{});class Gd extends o.Component{constructor(e){super(e),(0,k.Z)(this,"listContainerRef",(0,o.createRef)()),(0,k.Z)(this,"roomListRef",(0,o.createRef)()),(0,k.Z)(this,"focusedElement",null),(0,k.Z)(this,"isDoingStickyHeaders",!1),(0,k.Z)(this,"updateActiveSpace",(e=>{this.setState({activeSpace:e})})),(0,k.Z)(this,"onDialPad",(()=>{x.ZP.fire(W.a.OpenDialPad)})),(0,k.Z)(this,"onExplore",(e=>{x.ZP.fire(W.a.ViewRoomDirectory),kn.Z.trackInteraction("WebLeftPanelExploreRoomsButton",e)})),(0,k.Z)(this,"refreshStickyHeaders",(()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)})),(0,k.Z)(this,"onBreadcrumbsUpdate",(()=>{const e=Gd.breadcrumbsMode;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}})),(0,k.Z)(this,"onScroll",(e=>{const t=e.target;this.handleStickyHeaders(t)})),(0,k.Z)(this,"onFocus",(e=>{this.focusedElement=e.target})),(0,k.Z)(this,"onBlur",(()=>{this.focusedElement=null})),(0,k.Z)(this,"onKeyDown",((e,t)=>{if(!this.focusedElement)return;var i;(0,dr.zL)().getRoomListAction(e)===tn.vB.NextRoom&&(t||(e.stopPropagation(),e.preventDefault(),null===(i=this.roomListRef.current)||void 0===i||i.focus()))})),this.state={activeSpace:Rs.ZP.instance.activeSpace,showBreadcrumbs:Gd.breadcrumbsMode},tc.$.instance.on(Pa.a,this.onBreadcrumbsUpdate),ic.ZP.instance.on(ic.N,this.onBreadcrumbsUpdate),Rs.ZP.instance.on(cr.p4,this.updateActiveSpace)}static get breadcrumbsMode(){return tc.$.instance.visible?Hd.Legacy:Hd.Disabled}componentDidMount(){this.listContainerRef.current&&(mr.default.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),this.listContainerRef.current.addEventListener("scroll",this.onScroll,{passive:!0})),mr.default.instance.on("ListContainer",this.refreshStickyHeaders)}componentWillUnmount(){var e;tc.$.instance.off(Pa.a,this.onBreadcrumbsUpdate),ic.ZP.instance.off(ic.N,this.onBreadcrumbsUpdate),Rs.ZP.instance.off(cr.p4,this.updateActiveSpace),mr.default.instance.stopTrackingElementDimensions("ListContainer"),mr.default.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame((()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1})))}doStickyHeaders(e){if(!e.parentElement)return;const t=e.scrollTop,i=e.offsetHeight+e.scrollTop,n=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),s=new Map;let o,a;for(const e of n){const r=e.querySelector(".mx_RoomSublist_stickable");if(!r)continue;r.style.removeProperty("display");const l=.4,c=e.offsetTop+l*rr.M<=t,d=e.offsetTop+l*rr.M>=i;c||e===n[0]?(s.set(r,{stickyTop:!0}),o&&(o.style.display="none",s.set(o,{makeInvisible:!0})),o=r):d&&!a?(s.set(r,{stickyBottom:!0}),a=r):s.set(r,{})}for(const t of s.keys()){const i=s.get(t);if(i.makeInvisible)t.style.display="none";else{if(i.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const i=`${e.parentElement.offsetTop}px`;t.style.top!==i&&(t.style.top=i)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(i.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const i=`${mr.default.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)}px`;t.style.bottom!==i&&(t.style.bottom=i)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(i.stickyTop||i.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=mr.default.instance.getElementDimensions("ListContainer");if(e){const i=15,n=`${e.width-i}px`;t.style.width!==n&&(t.style.width=n)}}else i.stickyTop||i.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const r=e.parentElement;r&&(o?r.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),a?r.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom"))}renderBreadcrumbs(){if(this.state.showBreadcrumbs===Hd.Legacy&&!this.props.isMinimized)return o.createElement(Vl,{className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0},o.createElement(oc,null))}renderSearchDialExplore(){let e,t;return lt.ZP.instance.getSupportsPstnProtocol()&&(e=o.createElement(gs.Z,{className:yt()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:(0,l._t)("left_panel|open_dial_pad")})),this.state.activeSpace===cr.TS.Home&&(0,hr.I)(Ye.y.ExploreRooms)&&(t=o.createElement(gs.Z,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:(0,l._t)("action|explore_rooms")})),o.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown},o.createElement(lr,{isMinimized:this.props.isMinimized}),e,t)}render(){const e=o.createElement(ar.Z,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders,ref:this.roomListRef}),t=yt()({mx_LeftPanel:!0,mx_LeftPanel_minimized:this.props.isMinimized}),i=yt()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return o.createElement("div",{className:t},o.createElement("div",{className:"mx_LeftPanel_roomListContainer"},(0,hr.I)(Ye.y.FilterContainer)&&this.renderSearchDialExplore(),this.renderBreadcrumbs(),!this.props.isMinimized&&o.createElement(ec,{onVisibilityChange:this.refreshStickyHeaders}),o.createElement(zd,{selected:this.props.pageType===Ba.Z.HomePage,minimized:this.props.isMinimized}),o.createElement("div",{className:"mx_LeftPanel_roomListWrapper"},o.createElement("div",{className:i,ref:this.listContainerRef,tabIndex:-1},e))))}}var Kd=i("../matrix-react-sdk/src/stores/NonUrgentToastStore.ts");class qd extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"onUpdateToasts",(()=>{this.setState({toasts:Kd.Z.instance.components})})),this.state={toasts:Kd.Z.instance.components},Kd.Z.instance.on(Pa.a,this.onUpdateToasts)}componentWillUnmount(){Kd.Z.instance.off(Pa.a,this.onUpdateToasts)}render(){const e=this.state.toasts.map(((e,t)=>o.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:`toast-${t}`},o.createElement(e,{}))));return o.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}var $d=i("../matrix-js-sdk/src/webrtc/callFeed.ts");class Jd extends o.Component{constructor(e){super(e),(0,k.Z)(this,"element",(0,o.createRef)()),(0,k.Z)(this,"onAudioOutputChanged",(e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){r.k.error("Couldn't set requested audio output device: using default",e),r.k.warn("Couldn't set requested audio output device: using default",e)}})),(0,k.Z)(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted()}),this.playMedia()})),this.state={audioMuted:this.props.feed.isAudioMuted()}}componentDidMount(){Ka.ZP.instance.addListener(Ka.Ug.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener($d.EB.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){Ka.ZP.instance.removeListener(Ka.Ug.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener($d.EB.NewStream,this.onNewStream),this.stopMedia()}async playMedia(){const e=this.element.current;if(e){this.onAudioOutputChanged(Ka.ZP.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.load()}catch(e){r.k.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.removeAttribute("src"))}render(){return this.state.audioMuted?null:o.createElement("audio",{ref:this.element})}}class Yd extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onFeedsChanged",(()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})})),this.state={feeds:this.props.call.getRemoteFeeds()}}componentDidMount(){this.props.call.addListener(xt.nP.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(xt.nP.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map(((e,t)=>o.createElement(Jd,{feed:e,key:t})))}}var Qd=i("../matrix-react-sdk/src/shouldHideEvent.ts"),Xd=i("../matrix-react-sdk/src/ContentMessages.ts"),em=i("../matrix-react-sdk/node_modules/re-resizable/lib/index.es5.js");class tm extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),(0,k.Z)(this,"onResize",(()=>{this.props.resizeNotifier.notifyRightHandleResized()})),(0,k.Z)(this,"onResizeStop",((e,t,i,n)=>{this.props.resizeNotifier.stopResizing(),window.localStorage.setItem(this.sizeSettingStorageKey,(this.loadSidePanelSize().width+n.width).toString())}))}get sizeSettingStorageKey(){let e="mx_rhs_size";return this.props.sizeKey&&(e+=`_${this.props.sizeKey}`),e}loadSidePanelSize(){let e=parseInt(window.localStorage.getItem(this.sizeSettingStorageKey),10);return isNaN(e)&&(e=this.props.defaultSize),{height:"100%",width:e}}render(){const e=o.Children.only(this.props.children),t=this.props.panel;let i;return!this.props.collapsedRhs&&t&&(i=o.createElement(em.e,{key:this.props.sizeKey,defaultSize:this.loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_ResizeHandle--horizontal"}},t)),o.createElement("div",{className:"mx_MainSplit"},e,i)}}(0,k.Z)(tm,"defaultProps",{defaultSize:350});var im=i("../matrix-react-sdk/src/stores/right-panel/RightPanelStorePhases.ts"),nm=i("../matrix-react-sdk/src/stores/right-panel/RightPanelStore.ts"),sm=i("../matrix-react-sdk/node_modules/@vector-im/compound-web/dist/compound-web.js"),om=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/search.svg"),am=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/favourite-off.svg"),rm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/user-add.svg"),lm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/user-profile-solid.svg"),cm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/link.svg"),dm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/settings.svg"),mm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/export-archive.svg"),hm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/leave.svg"),pm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/files.svg"),um=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/polls.svg"),gm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/pin-off.svg"),vm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/lock.svg"),_m=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/lock-off.svg"),fm=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/public.svg"),Em=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/error.svg"),ym=i("../matrix-react-sdk/src/hooks/useIsEncrypted.ts"),bm=i("../matrix-react-sdk/src/components/views/right_panel/BaseCard.tsx"),wm=i("../matrix-react-sdk/src/components/views/dialogs/ShareDialog.tsx"),Sm=i("../matrix-react-sdk/src/utils/WidgetUtils.ts"),Cm=i("../matrix-react-sdk/src/stores/WidgetStore.ts");const km=["app","className","size"],xm=e=>{let{app:t,className:n,size:s="20px"}=e,a=(0,v.Z)(e,km),r=[i("../matrix-react-sdk/res/img/element-icons/room/default_app.svg").Z];return t.type.includes("jitsi")?r=[i("../matrix-react-sdk/res/img/element-icons/room/default_video.svg").Z]:t.type.includes("meeting")||t.type.includes("calendar")?r=[i("../matrix-react-sdk/res/img/element-icons/room/default_cal.svg").Z]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?r=[i("../matrix-react-sdk/res/img/element-icons/room/default_doc.svg").Z]:t.type.includes("clock")&&(r=[i("../matrix-react-sdk/res/img/element-icons/room/default_clock.svg").Z]),o.createElement(ys.Z,(0,kt.Z)({},a,{name:t.id,className:yt()("mx_WidgetAvatar",n),url:(0,Cm.D)(t)&&t.avatar_url?(0,mn.TS)(t.avatar_url).getSquareThumbnailHttp(20):null,urls:r,size:s}))};var Rm=i("../matrix-react-sdk/src/utils/ShieldUtils.ts"),Im=i("./node_modules/matrix-widget-api/lib/index.js"),Pm=i("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WidgetLifecycle.js"),Tm=i("../matrix-react-sdk/src/stores/widgets/WidgetMessagingStore.ts"),Zm=i("../matrix-react-sdk/src/widgets/WidgetType.ts"),Nm=i("../matrix-react-sdk/src/stores/widgets/WidgetLayoutStore.ts"),Dm=i("../matrix-react-sdk/src/stores/widgets/ElementWidgetActions.ts");function Mm(){return c.ZP.get("audio_stream_url")}async function Om(e,t,i){const n=await async function(e,t){const i=await e.getOpenIdToken(),n=Mm()+"/createStream",s=await window.fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:t,openid_token:i})});return(await s.json()).stream_id}(e,i);await t.transport.send(Dm.C.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+n})}var Am=i("../matrix-react-sdk/src/modules/ModuleRunner.ts");var Lm=i("../matrix-react-sdk/src/stores/widgets/WidgetPermissionStore.ts");class Um extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"onAllow",(()=>{this.onPermissionSelection(!0)})),(0,k.Z)(this,"onDeny",(()=>{this.onPermissionSelection(!1)})),(0,k.Z)(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),this.state={rememberSelection:!1}}onPermissionSelection(e){this.state.rememberSelection&&(r.k.log(`Remembering ${this.props.widget.id} as allowed=${e} for OpenID`),ie.m.instance.widgetPermissionStore.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?Lm.o.Allowed:Lm.o.Denied)),this.props.onFinished(e)}render(){return o.createElement(q.Z,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,l._t)("widget|open_id_permissions_dialog|title")},o.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},o.createElement("p",null,(0,l._t)("widget|open_id_permissions_dialog|starting_text")),o.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|continue"),onPrimaryButtonClick:this.onAllow,onCancel:this.onDeny,additive:o.createElement(ho.Z,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,l._t)("widget|open_id_permissions_dialog|remember_selection")})}))}}let Fm=function(e){return e.CanChangeViewedRoom="io.element.view_room",e.RequiresClient="io.element.requires_client",e}({});var Bm=i("../matrix-react-sdk/src/components/views/elements/TextWithTooltip.tsx");const Vm="generic";class jm{static bylineFor(e){return e.kind===Im.EventKind.State?e.keyStr?(0,l._t)("widget|capability|byline_state_key",{stateKey:e.keyStr}):(0,l._t)("widget|capability|byline_empty_state_key"):null}static for(e,t){if(jm.simpleCaps[e]){const i=jm.simpleCaps[e];if(i[t])return{primary:(0,l._t)(i[t])};if(i[Vm])return{primary:(0,l._t)(i[Vm])}}if((0,Im.isTimelineCapability)(e)){if((0,Im.isTimelineCapabilityFor)(e,Im.Symbols.AnyRoom))return{primary:(0,l._t)("widget|capability|any_room")};{const t=(0,Im.getTimelineRoomIDFromCapability)(e),i=E.p.safeGet().getRoom(t);return{primary:(0,l._t)("widget|capability|specific_room",{},{Room:()=>{var e;return i?o.createElement(Bm.Z,{tooltip:null!==(e=i.getCanonicalAlias())&&void 0!==e?e:t},o.createElement("b",null,i.name)):o.createElement("b",null,o.createElement("code",null,t))}})}}}const[i]=Im.WidgetEventCapability.findEventCapabilities([e]);if(i){if(i.kind===Im.EventKind.Event&&i.eventType===n.EventType.RoomMessage)return jm.forRoomMessageCap(i,t);const e=i.kind===Im.EventKind.State?jm.stateSendRecvCaps:jm.nonStateSendRecvCaps;if(e[i.eventType]){const n=e[i.eventType],s=(null==n?void 0:n[t])||(null==n?void 0:n[Vm]);if(null!=s&&s[i.direction])return{primary:(0,l._t)(s[i.direction])}}return t===Im.WidgetKind.Room?i.direction===Im.EventDirection.Send?{primary:(0,l._t)("widget|capability|send_event_type_this_room",{eventType:i.eventType},{b:e=>o.createElement("b",null,e)}),byline:jm.bylineFor(i)}:{primary:(0,l._t)("widget|capability|see_event_type_sent_this_room",{eventType:i.eventType},{b:e=>o.createElement("b",null,e)}),byline:jm.bylineFor(i)}:i.direction===Im.EventDirection.Send?{primary:(0,l._t)("widget|capability|send_event_type_active_room",{eventType:i.eventType},{b:e=>o.createElement("b",null,e)}),byline:jm.bylineFor(i)}:{primary:(0,l._t)("widget|capability|see_event_type_sent_active_room",{eventType:i.eventType},{b:e=>o.createElement("b",null,e)}),byline:jm.bylineFor(i)}}return{primary:(0,l._t)("widget|capability|capability",{capability:e},{b:e=>o.createElement("b",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===Im.EventDirection.Send?{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|send_messages_this_room"):(0,l._t)("widget|capability|send_messages_active_room")}:{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|see_messages_sent_this_room"):(0,l._t)("widget|capability|see_messages_sent_active_room")};switch(e.keyStr){case n.MsgType.Text:return e.direction===Im.EventDirection.Send?{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|send_text_messages_this_room"):(0,l._t)("widget|capability|send_text_messages_active_room")}:{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|see_text_messages_sent_this_room"):(0,l._t)("widget|capability|see_text_messages_sent_active_room")};case n.MsgType.Emote:return e.direction===Im.EventDirection.Send?{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|send_emotes_this_room"):(0,l._t)("widget|capability|send_emotes_active_room")}:{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|see_sent_emotes_this_room"):(0,l._t)("widget|capability|see_sent_emotes_active_room")};case n.MsgType.Image:return e.direction===Im.EventDirection.Send?{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|send_images_this_room"):(0,l._t)("widget|capability|send_images_active_room")}:{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|see_images_sent_this_room"):(0,l._t)("widget|capability|see_images_sent_active_room")};case n.MsgType.Video:return e.direction===Im.EventDirection.Send?{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|send_videos_this_room"):(0,l._t)("widget|capability|send_videos_active_room")}:{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|see_videos_sent_this_room"):(0,l._t)("widget|capability|see_videos_sent_active_room")};case n.MsgType.File:return e.direction===Im.EventDirection.Send?{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|send_files_this_room"):(0,l._t)("widget|capability|send_files_active_room")}:{primary:t===Im.WidgetKind.Room?(0,l._t)("widget|capability|see_sent_files_this_room"):(0,l._t)("widget|capability|see_sent_files_active_room")};default:{let i;return i=e.direction===Im.EventDirection.Send?t===Im.WidgetKind.Room?(0,l._t)("widget|capability|send_msgtype_this_room",{msgtype:e.keyStr},{b:e=>o.createElement("b",null,e)}):(0,l._t)("widget|capability|send_msgtype_active_room",{msgtype:e.keyStr},{b:e=>o.createElement("b",null,e)}):t===Im.WidgetKind.Room?(0,l._t)("widget|capability|see_msgtype_sent_this_room",{msgtype:e.keyStr},{b:e=>o.createElement("b",null,e)}):(0,l._t)("widget|capability|see_msgtype_sent_active_room",{msgtype:e.keyStr},{b:e=>o.createElement("b",null,e)}),{primary:i}}}}}(0,k.Z)(jm,"simpleCaps",{[Im.MatrixCapabilities.AlwaysOnScreen]:{[Im.WidgetKind.Room]:(0,l.I8)("widget|capability|always_on_screen_viewing_another_room"),[Vm]:(0,l.I8)("widget|capability|always_on_screen_generic")},[Im.MatrixCapabilities.StickerSending]:{[Im.WidgetKind.Room]:(0,l.I8)("widget|capability|send_stickers_this_room"),[Vm]:(0,l.I8)("widget|capability|send_stickers_active_room")},[Fm.CanChangeViewedRoom]:{[Vm]:(0,l.I8)("widget|capability|switch_room")},[Im.MatrixCapabilities.MSC2931Navigate]:{[Vm]:(0,l.I8)("widget|capability|switch_room_message_user")}}),(0,k.Z)(jm,"stateSendRecvCaps",{[n.EventType.RoomTopic]:{[Im.WidgetKind.Room]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|change_topic_this_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_topic_change_this_room")},[Vm]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|change_topic_active_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_topic_change_active_room")}},[n.EventType.RoomName]:{[Im.WidgetKind.Room]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|change_name_this_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_name_change_this_room")},[Vm]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|change_name_active_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_name_change_active_room")}},[n.EventType.RoomAvatar]:{[Im.WidgetKind.Room]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|change_avatar_this_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_avatar_change_this_room")},[Vm]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|change_avatar_active_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_avatar_change_active_room")}},[n.EventType.RoomMember]:{[Im.WidgetKind.Room]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|remove_ban_invite_leave_this_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|receive_membership_this_room")},[Vm]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|remove_ban_invite_leave_active_room"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|receive_membership_active_room")}}}),(0,k.Z)(jm,"nonStateSendRecvCaps",{[n.EventType.Sticker]:{[Im.WidgetKind.Room]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|send_stickers_this_room_as_you"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_sticker_posted_this_room")},[Vm]:{[Im.EventDirection.Send]:(0,l.I8)("widget|capability|send_stickers_active_room_as_you"),[Im.EventDirection.Receive]:(0,l.I8)("widget|capability|see_sticker_posted_active_room")}}});class zm extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"eventPermissionsMap",new Map),(0,k.Z)(this,"onToggle",(e=>{const t=(0,ni.al)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})})),(0,k.Z)(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),(0,k.Z)(this,"onSubmit",(async()=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter((([e,t])=>t)).map((([e])=>e)))})),(0,k.Z)(this,"onReject",(async()=>{this.closeAndTryRemember([])}));Im.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach((e=>this.eventPermissionsMap.set(e.raw,e)));const t={};this.props.requestedCapabilities.forEach((e=>t[e]=!0)),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){this.props.onFinished({approved:e,remember:this.state.rememberSelection})}render(){const e=Object.entries(this.state.booleanStates).sort((([e],[t])=>{const i=(0,Im.isTimelineCapability)(e),n=(0,Im.isTimelineCapability)(t);return i||n?i&&!n?1:!i&&n?-1:i&&n?(0,xa.uC)(e,t):0:(0,xa.uC)(e,t)})).map((([e,t],i)=>{const n=jm.for(e,this.props.widgetKind),s=n.byline?o.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},n.byline):null;return o.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:e+i},o.createElement(qs.Z,{checked:t,onChange:()=>this.onToggle(e)},n.primary),s)}));return o.createElement(q.Z,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:(0,l._t)("widget|capabilities_dialog|title")},o.createElement("form",{onSubmit:this.onSubmit},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("div",{className:"text-muted"},(0,l._t)("widget|capabilities_dialog|content_starting_text")),e,o.createElement(gt.Z,{primaryButton:(0,l._t)("action|approve"),cancelButton:(0,l._t)("widget|capabilities_dialog|decline_all_permission"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:o.createElement(ho.Z,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,l._t)("widget|capabilities_dialog|remember_Selection")})}))))}}const Wm={};var Hm=i("../matrix-react-sdk/src/effects/index.ts"),Gm=i("../matrix-react-sdk/src/effects/utils.ts"),Km=i("../matrix-react-sdk/src/utils/permalinks/navigator.ts");const qm=({urls:e,username:t,credential:i})=>({uris:e,username:t,password:i});class $m extends Im.WidgetDriver{constructor(e,t,i,s,o){var a;if(super(),this.forWidget=t,this.forWidgetKind=i,this.inRoomId=o,(0,k.Z)(this,"allowedCapabilities",void 0),this.allowedCapabilities=new Set([...e,Im.MatrixCapabilities.Screenshots,Fm.RequiresClient]),Zm.l.JITSI.matches(this.forWidget.type)&&i===Im.WidgetKind.Room)this.allowedCapabilities.add(Im.MatrixCapabilities.AlwaysOnScreen);else if(Zm.l.STICKERPICKER.matches(this.forWidget.type)&&i===Im.WidgetKind.Account){const e=Im.WidgetEventCapability.forRoomEvent(Im.EventDirection.Send,n.EventType.Sticker).raw;this.allowedCapabilities.add(Im.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}else if(s&&new URL(null!==(a=c.ZP.get("element_call").url)&&void 0!==a?a:c.Of.element_call.url).origin===this.forWidget.origin){this.allowedCapabilities.add(Im.MatrixCapabilities.AlwaysOnScreen),this.allowedCapabilities.add(Im.MatrixCapabilities.MSC3846TurnServers),this.allowedCapabilities.add(`org.matrix.msc2762.timeline:${o}`),this.allowedCapabilities.add(Im.WidgetEventCapability.forRoomEvent(Im.EventDirection.Send,"org.matrix.rageshake_request").raw),this.allowedCapabilities.add(Im.WidgetEventCapability.forRoomEvent(Im.EventDirection.Receive,"org.matrix.rageshake_request").raw),this.allowedCapabilities.add(Im.WidgetEventCapability.forStateEvent(Im.EventDirection.Receive,n.EventType.RoomMember).raw),this.allowedCapabilities.add(Im.WidgetEventCapability.forStateEvent(Im.EventDirection.Receive,"org.matrix.msc3401.call").raw),this.allowedCapabilities.add(Im.WidgetEventCapability.forStateEvent(Im.EventDirection.Send,"org.matrix.msc3401.call.member",E.p.safeGet().getSafeUserId()).raw),this.allowedCapabilities.add(Im.WidgetEventCapability.forStateEvent(Im.EventDirection.Receive,"org.matrix.msc3401.call.member").raw);const e=["io.element.call.encryption_keys"];for(const t of e)this.allowedCapabilities.add(Im.WidgetEventCapability.forRoomEvent(Im.EventDirection.Send,t).raw),this.allowedCapabilities.add(Im.WidgetEventCapability.forRoomEvent(Im.EventDirection.Receive,t).raw);const s=[n.EventType.CallInvite,n.EventType.CallCandidates,n.EventType.CallAnswer,n.EventType.CallHangup,n.EventType.CallReject,n.EventType.CallSelectAnswer,n.EventType.CallNegotiate,n.EventType.CallSDPStreamMetadataChanged,n.EventType.CallSDPStreamMetadataChangedPrefix,n.EventType.CallReplaces];for(const e of s)this.allowedCapabilities.add(Im.WidgetEventCapability.forToDeviceEvent(Im.EventDirection.Send,e).raw),this.allowedCapabilities.add(Im.WidgetEventCapability.forToDeviceEvent(Im.EventDirection.Receive,e).raw);ie.m.instance.widgetPermissionStore.setOIDCState(t,i,o,Lm.o.Allowed)}}async validateCapabilities(e){const t=(i=e,n=this.allowedCapabilities,(0,ne.tX)(Array.from(i),Array.from(n)));var i,n;const s=new Set(t.removed),o=new Set(this.allowedCapabilities);var a;let l;if((a=this.forWidget,JSON.parse(localStorage.getItem(`widget_${a.id}_approved_caps`)||"[]")).forEach((e=>{o.add(e),s.delete(e)})),Wm.preapproveCapabilities)l=await Wm.preapproveCapabilities(this.forWidget,e);else{const t={approvedCapabilities:void 0};Am.E.instance.invoke(Pm.H.CapabilitiesRequest,t,this.forWidget,e),l=t.approvedCapabilities}l&&l.forEach((e=>{o.add(e),s.delete(e)}));let c=!1;if(s.size>0)try{var d;const[e]=await T.ZP.createDialog(zm,{requestedCapabilities:s,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;null==e||null===(d=e.approved)||void 0===d||d.forEach((e=>o.add(e))),c=!(null==e||!e.remember)}catch(e){r.k.error("Non-fatal error getting capabilities: ",e)}const m=new Set(function(e,t){return(0,ne.tN)(Array.from(e),Array.from(t))}(o,e));return c&&function(e,t){localStorage.setItem(`widget_${e.id}_approved_caps`,JSON.stringify(t))}(this.forWidget,Array.from(m)),m}async sendEvent(e,t,i,s){const o=E.p.get(),a=s||ie.m.instance.roomViewStore.getRoomId();if(!o||!a)throw new Error("Not in a room or not attached to a client");let r;return null!==i?r=await o.sendStateEvent(a,e,t,i):e===n.EventType.RoomRedaction?r=await o.redactEvent(a,t.redacts):(r=await o.sendEvent(a,e,t),e===n.EventType.RoomMessage&&Hm.b.forEach((e=>{if((0,Gm.R)(t,e.emojis)){var i;(null===(i=t["m.relates_to"])||void 0===i?void 0:i.rel_type)!==n.THREAD_RELATION_TYPE.name&&x.ZP.dispatch({action:`effects.${e.command}`})}}))),{roomId:a,eventId:r.event_id}}async sendToDevice(e,t,i){const n=E.p.safeGet();if(t){const e=await n.crypto.deviceList.downloadKeys(Object.keys(i),!1);await Promise.all(Object.entries(i).flatMap((([t,i])=>Object.entries(i).map((async([i,s])=>{const o=e.get(t);o&&("*"===i?await n.encryptAndSendToDevices(Array.from(o.values()).map((e=>({userId:t,deviceInfo:e}))),s):o.has(i)&&await n.encryptAndSendToDevices([{userId:t,deviceInfo:o.get(i)}],s))})))))}else await n.queueToDevice({eventType:e,batch:Object.entries(i).flatMap((([e,t])=>Object.entries(t).map((([t,i])=>({userId:e,deviceId:t,payload:i})))))})}pickRooms(e){const t=E.p.get();if(!t)throw new Error("Not attached to a client");return(e?e.includes(Im.Symbols.AnyRoom)?t.getVisibleRooms(L.C.getValue("feature_dynamic_room_predecessors")):e.map((e=>t.getRoom(e))):[t.getRoom(ie.m.instance.roomViewStore.getRoomId())]).filter((e=>!!e))}async readRoomEvents(e,t,i,s){i=i>0?Math.min(i,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const o=this.pickRooms(s),a=[];for(const s of o){const o=[],r=s.getLiveTimeline().getEvents();for(let s=r.length-1;s>0&&!(o.length>=i);s--){const i=r[s];i.getType()!==e||i.isState()||e===n.EventType.RoomMessage&&t&&t!==i.getContent().msgtype||o.push(i)}o.forEach((e=>a.push(e.getEffectiveEvent())))}return a}async readStateEvents(e,t,i,n){i=i>0?Math.min(i,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const s=this.pickRooms(n),o=[];for(const n of s){const s=[],a=n.currentState.events.get(e);if(a)if(""===t||t){const e=a.get(t);e&&s.push(e)}else s.push(...Array.from(a.values()));s.slice(0,i).forEach((e=>o.push(e.getEffectiveEvent())))}return o}async askOpenID(e){const t={approved:void 0};if(Am.E.instance.invoke(Pm.H.IdentityRequest,t,this.forWidget),t.approved)return e.update({state:Im.OpenIDRequestState.Allowed,token:await E.p.safeGet().getOpenIdToken()});const i=ie.m.instance.widgetPermissionStore.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),n=()=>E.p.safeGet().getOpenIdToken();return i===Lm.o.Denied?e.update({state:Im.OpenIDRequestState.Blocked}):i===Lm.o.Allowed?e.update({state:Im.OpenIDRequestState.Allowed,token:await n()}):(e.update({state:Im.OpenIDRequestState.PendingUserConfirmation}),void T.ZP.createDialog(Um,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:Im.OpenIDRequestState.Allowed,token:await n()}):e.update({state:Im.OpenIDRequestState.Blocked})}))}async navigate(e){(0,Km.S)(e)}async*getTurnServers(){const e=E.p.safeGet();if(!e.pollingTurnServers||!e.getTurnServers().length)return;let t,i;const s=([e])=>t(qm(e)),o=(e,t)=>{t&&i(e)};e.on(n.ClientEvent.TurnServers,s),e.on(n.ClientEvent.TurnServersError,o);try{const n=e.getTurnServers()[0];for(yield qm(n);;)yield await new Promise(((e,n)=>{t=e,i=n}))}finally{e.off(n.ClientEvent.TurnServers,s),e.off(n.ClientEvent.TurnServersError,o)}}async readEventRelations(e,t,i,n,s,o,a,r){var l,c;const d=E.p.safeGet(),m=r;if("string"!=typeof(t=null!==(l=null!==(c=t)&&void 0!==c?c:ie.m.instance.roomViewStore.getRoomId())&&void 0!==l?l:void 0))throw new Error("Error while reading the current room");const{events:h,nextBatch:p,prevBatch:u}=await d.relations(t,e,null!=i?i:null,null!=n?n:null,{from:s,to:o,limit:a,dir:m});return{chunk:h.map((e=>e.getEffectiveEvent())),nextBatch:null!=p?p:void 0,prevBatch:null!=u?u:void 0}}async searchUserDirectory(e,t){const i=E.p.safeGet(),{limited:n,results:s}=await i.searchUserDirectory({term:e,limit:t});return{limited:n,results:s.map((e=>({userId:e.user_id,displayName:e.display_name,avatarUrl:e.avatar_url})))}}async getMediaConfig(){const e=E.p.safeGet();return await e.getMediaConfig()}async uploadFile(e){const t=E.p.safeGet();return{contentUri:(await t.uploadContent(e)).content_uri}}}const Jm="io.element.web";function Ym(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Qm(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ym(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ym(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Xm extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"widget",void 0),(0,k.Z)(this,"possibleButtons",void 0),(0,k.Z)(this,"appFrame",o.createRef()),(0,k.Z)(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter((e=>e.disabled)).map((e=>e.id))}),(0,k.Z)(this,"onReady",(()=>{var e;null===(e=this.state.messaging)||void 0===e||e.sendWidgetConfig(this.props.widgetDefinition)})),(0,k.Z)(this,"onLoad",(()=>{this.state.messaging&&(this.state.messaging.once("ready",this.onReady),this.state.messaging.on(`action:${Im.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.on(`action:${Im.WidgetApiFromWidgetAction.SetModalButtonEnabled}`,this.onButtonEnableToggle))})),(0,k.Z)(this,"onWidgetClose",(e=>{this.props.onFinished(!0,e.detail.data)})),(0,k.Z)(this,"onButtonEnableToggle",(e=>{var t;e.preventDefault();var i;if(e.detail.data.button===Im.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return null===(i=this.state.messaging)||void 0===i?void 0:i.transport.reply(e.detail,{error:{message:"Invalid button"}});let n;if(e.detail.data.enabled)n=(0,ne.iP)(this.state.disabledButtonIds).filter((t=>t!==e.detail.data.button));else{const t=new Set(this.state.disabledButtonIds);t.add(e.detail.data.button),n=Array.from(t)}this.setState({disabledButtonIds:n}),null===(t=this.state.messaging)||void 0===t||t.transport.reply(e.detail,{})})),this.widget=new rh(Qm(Qm({},this.props.widgetDefinition),{},{creatorUserId:E.p.safeGet().getSafeUserId(),id:`modal_${this.props.sourceWidgetId}`})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map((e=>e.id))}componentDidMount(){const e=new $m([],this.widget,Im.WidgetKind.Modal,!1),t=new Im.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging&&(this.state.messaging.off("ready",this.onReady),this.state.messaging.off(`action:${Im.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.stop())}render(){var e,t,n;const s=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:E.p.safeGet().getSafeUserId(),userDisplayName:null!==(e=Ml.p.instance.displayName)&&void 0!==e?e:void 0,userHttpAvatarUrl:null!==(t=Ml.p.instance.getHttpAvatarUrl())&&void 0!==t?t:void 0,clientId:Jm,clientTheme:L.C.getValue("theme"),clientLanguage:(0,l.of)(),baseUrl:E.p.safeGet().baseUrl}),a=new URL(s);a.searchParams.set("widgetId",this.widget.id),a.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const r=a.toString().replace(/%24/g,"$");let c;return this.props.widgetDefinition.buttons&&(c=this.props.widgetDefinition.buttons.slice(0,3).reverse().map((e=>{let t="secondary";switch(e.kind){case Im.ModalButtonKind.Primary:t="primary";break;case Im.ModalButtonKind.Secondary:t="primary_outline";break;case Im.ModalButtonKind.Danger:t="danger"}const i=this.state.disabledButtonIds.includes(e.id);return o.createElement(ae.Z,{key:e.id,kind:t,onClick:()=>{var t;null===(t=this.state.messaging)||void 0===t||t.notifyModalWidgetButtonClicked(e.id)},disabled:i},e.label)}))),o.createElement(q.Z,{title:this.props.widgetDefinition.name||(0,l._t)("widget|modal_title_default"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},o.createElement("div",{className:"mx_ModalWidgetDialog_warning"},o.createElement("img",{src:i("../matrix-react-sdk/res/img/element-icons/warning-badge.svg").Z,height:"16",width:"16",alt:""}),(0,l._t)("widget|modal_data_warning",{widgetDomain:a.hostname})),o.createElement("div",null,o.createElement("iframe",{title:null!==(n=this.widget.name)&&void 0!==n?n:void 0,ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:r,onLoad:this.onLoad})),o.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},c))}}var eh;function th(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ih(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?th(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):th(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class nh extends Oa._{constructor(){super(x.ZP,{}),(0,k.Z)(this,"modalInstance",null),(0,k.Z)(this,"openSourceWidgetId",null),(0,k.Z)(this,"openSourceWidgetRoomId",null),(0,k.Z)(this,"canOpenModalWidget",(()=>!this.modalInstance)),(0,k.Z)(this,"openModalWidget",((e,t,i)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.openSourceWidgetRoomId=null!=i?i:null,this.modalInstance=T.ZP.createDialog(Xm,{widgetDefinition:ih({},e),widgetRoomId:i,sourceWidgetId:t.id,onFinished:(e,n)=>{this.closeModalWidget(t,i,e&&n?n:{"m.exited":!0}),this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance=null}},void 0,!1,!0))})),(0,k.Z)(this,"closeModalWidget",((e,t,i)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id&&this.openSourceWidgetRoomId===t){this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance.close(),this.modalInstance=null;const n=Tm.c.instance.getMessaging(e,t);if(!n)return void r.k.error("No source widget messaging for modal widget");n.notifyModalWidgetClose(i)}}))}static get instance(){return nh.internalInstance}async onAction(e){}}eh=nh,(0,k.Z)(nh,"internalInstance",(()=>{const e=new eh;return e.start(),e})()),window.mxModalWidgetStore=nh.instance;const sh={};function oh(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ah(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?oh(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oh(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class rh extends Im.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return Zm.l.JITSI.matches(this.type)?Sm.Z.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return Zm.l.JITSI.matches(this.type)?Sm.Z.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="meet.element.io");let i=(new Wa.Z).getEffectiveTheme();if(i.startsWith("custom-")){const e=(0,il.jp)(i.slice(7));i=e.is_dark?"dark":"light"}return i=i.includes("light")?"light":"dark",ah(ah({},super.rawData),{},{theme:i,conferenceId:e,domain:t})}getCompleteUrl(e,t=!1){return(0,Im.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,ah(ah({},this.rawDefinition),{},{data:this.rawData}),e)}}class lh extends Y.EventEmitter{constructor(e){var t;super(),this.appTileProps=e,(0,k.Z)(this,"client",void 0),(0,k.Z)(this,"messaging",null),(0,k.Z)(this,"mockWidget",void 0),(0,k.Z)(this,"scalarToken",void 0),(0,k.Z)(this,"roomId",void 0),(0,k.Z)(this,"kind",void 0),(0,k.Z)(this,"virtual",void 0),(0,k.Z)(this,"readUpToMap",{}),(0,k.Z)(this,"onOpenModal",(async e=>{var t,i;(e.preventDefault(),nh.instance.canOpenModalWidget())?(nh.instance.openModalWidget(e.detail.data,this.mockWidget,this.roomId),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{})):null===(i=this.messaging)||void 0===i||i.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})})),(0,k.Z)(this,"onEvent",(e=>{this.client.decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()||this.feedEvent(e)})),(0,k.Z)(this,"onEventDecrypted",(e=>{e.isDecryptionFailure()||this.feedEvent(e)})),(0,k.Z)(this,"onToDeviceEvent",(async e=>{var t;await this.client.decryptEventIfNeeded(e),e.isDecryptionFailure()||await(null===(t=this.messaging)||void 0===t?void 0:t.feedToDevice(e.getEffectiveEvent(),e.isEncrypted()))})),this.client=E.p.safeGet();let i=e.app;i.creatorUserId||(i=(0,ni.al)(i),i.creatorUserId=this.client.getUserId()),this.mockWidget=new rh(i),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?Im.WidgetKind.Account:Im.WidgetKind.Room,this.virtual=(0,Cm.D)(i)&&void 0===i.eventId}get eventListenerRoomId(){return this.roomId?this.roomId:ie.m.instance.roomViewStore.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(e={asPopout:!1}){var t,i,n,s,o;const a=null!==(t=null==sh||null===(i=sh.provideVariables)||void 0===i?void 0:i.call(sh))&&void 0!==t?t:{},r={widgetRoomId:this.roomId,currentUserId:this.client.getUserId(),userDisplayName:null!==(n=Ml.p.instance.displayName)&&void 0!==n?n:void 0,userHttpAvatarUrl:null!==(s=Ml.p.instance.getHttpAvatarUrl())&&void 0!==s?s:void 0,clientId:Jm,clientTheme:L.C.getValue("theme"),clientLanguage:(0,l.of)(),deviceId:null!==(o=this.client.getDeviceId())&&void 0!==o?o:void 0,baseUrl:this.client.baseUrl},c=this.mockWidget.getCompleteUrl(Object.assign(r,a),null==e?void 0:e.asPopout),d=new URL(c);return null!=e&&e.asPopout||(d.searchParams.set("widgetId",this.mockWidget.id),d.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&d.searchParams.set("scalar_token",this.scalarToken)),d.toString().replace(/%24/g,"$")}get started(){return!!this.messaging}startMessaging(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],i=new $m(t,this.mockWidget,this.kind,this.virtual,this.roomId);this.messaging=new Im.ClientWidgetApi(this.mockWidget,e,i),this.messaging.on("preparing",(()=>this.emit("preparing"))),this.messaging.on("error:preparing",(e=>this.emit("error:preparing",e))),this.messaging.on("ready",(()=>{Tm.c.instance.storeMessaging(this.mockWidget,this.roomId,this.messaging),this.emit("ready")})),this.messaging.on("capabilitiesNotified",(()=>this.emit("capabilitiesNotified"))),this.messaging.on(`action:${Im.WidgetApiFromWidgetAction.OpenModalWidget}`,this.onOpenModal),this.messaging.on(`action:${Dm.C.JoinCall}`,(()=>{var e;null===(e=ie.m.instance.voiceBroadcastRecordingsStore.getCurrent())||void 0===e||e.pause()})),this.messaging.on(`action:${Dm.C.ViewRoom}`,(e=>{var t;e.preventDefault();const i=(e.detail.data||{}).room_id;var n,s;return i?null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(Fm.CanChangeViewedRoom)?(x.ZP.dispatch({action:W.a.ViewRoom,room_id:i,metricsTrigger:"Widget"}),void this.messaging.transport.reply(e.detail,{})):null===(s=this.messaging)||void 0===s?void 0:s.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):null===(n=this.messaging)||void 0===n?void 0:n.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})}));for(const e of this.client.getRooms()){var s;const t=(null===(s=e.getLiveTimeline())||void 0===s?void 0:s.getEvents())||[],i=t[t.length-1];i&&(this.readUpToMap[e.roomId]=i.getId())}this.client.on(n.ClientEvent.Event,this.onEvent),this.client.on(n.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.on(n.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),this.messaging.on(`action:${Im.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen}`,(e=>{var t,i;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(Im.MatrixCapabilities.AlwaysOnScreen)&&(Z.Z.instance.setWidgetPersistence(this.mockWidget.id,null!==(i=this.roomId)&&void 0!==i?i:null,e.detail.data.value),e.preventDefault(),this.messaging.transport.reply(e.detail,{}))})),this.messaging.on(`action:${Im.WidgetApiFromWidgetAction.SendSticker}`,(e=>{var t;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(Im.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),x.ZP.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))})),Zm.l.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on(`action:${Dm.C.OpenIntegrationManager}`,(e=>{var t,i,n;e.preventDefault(),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{}),x.ZP.dispatch({action:"stickerpicker_close"});const s=e.detail.data,o=null==s?void 0:s.integType,a=null==s?void 0:s.integId,r=ie.m.instance.roomViewStore.getRoomId(),l=r?this.client.getRoom(r):void 0;l&&(null===(i=B.B.sharedInstance())||void 0===i||null===(n=i.getPrimaryManager())||void 0===n||n.open(l,`type_${o}`,a))})),Zm.l.JITSI.matches(this.mockWidget.type)&&this.messaging.on(`action:${Dm.C.HangupCall}`,(e=>{var t,i;e.preventDefault(),null!==(t=e.detail.data)&&void 0!==t&&t.errorMessage&&T.ZP.createDialog(dt.Z,{title:(0,l._t)("widget|error_hangup_title"),description:(0,l._t)("widget|error_hangup_description",{message:e.detail.data.errorMessage})}),null===(i=this.messaging)||void 0===i||i.transport.reply(e.detail,{})}))}async prepare(){var e,t;if(await(null!==(e=null==sh||null===(t=sh.isReady)||void 0===t?void 0:t.call(sh))&&void 0!==e?e:Promise.resolve()),this.scalarToken)return;const i=Tm.c.instance.getMessaging(this.mockWidget,this.roomId);i&&(this.messaging=i);try{if(Sm.Z.isScalarUrl(this.mockWidget.templateUrl)){const e=B.B.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(t&&Sm.Z.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){r.k.error("Error preparing widget communications: ",e)}}stopMessaging(e={forceDestroy:!1}){var t;null!=e&&e.forceDestroy||!Z.Z.instance.getWidgetPersistence(this.mockWidget.id,null!==(t=this.roomId)&&void 0!==t?t:null)?this.started&&(Tm.c.instance.stopMessaging(this.mockWidget,this.roomId),this.messaging=null,this.client.off(n.ClientEvent.Event,this.onEvent),this.client.off(n.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.off(n.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)):r.k.log("Skipping destroy - persistent widget")}feedEvent(e){if(!this.messaging)return;const t=this.readUpToMap[e.getRoomId()];if(t){if(t===e.getId())return;let i=!0;const n=this.client.getRoom(e.getRoomId());if(!n)return;const s=n.getLiveTimeline(),o=(0,ne.iP)(s.getEvents()).reverse().slice(0,100);for(const n of o){if(n.getId()===t)break;if(n.getId()===e.getId()){i=!1;break}}if(i)return}const i=e.getRoomId(),n=e.getId();if(i&&n){const e=this.client.getRoom(i);e&&"join"===e.getMyMembership()&&(this.readUpToMap[i]=n)}const s=e.getEffectiveEvent();this.messaging.feedEvent(s,this.eventListenerRoomId).catch((e=>{r.k.error("Error sending event to widget: ",e)}))}}const ch=["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"],dh=e=>!!Mm()&&Zm.l.JITSI.matches(e.type),mh=(e,t)=>t&&Sm.Z.isManagedByManager(e),hh=(e,t,i,n)=>{var s;const o=(0,Cm.D)(i)&&void 0!==i.eventId&&null!==(s=L.C.getValue("allowedWidgets",t)[i.eventId])&&void 0!==s&&s||i.creatorUserId===(null==e?void 0:e.getUserId()),a=Zm.l.JITSI.matches(i.type);return!n&&!a&&o},ph=(e,t)=>!!t||e,uh=e=>L.C.getValue("enableWidgetScreenshots")&&!(null==e||!e.hasCapability(Im.MatrixCapabilities.Screenshots)),gh=(e,t,i)=>{if(!i)return[!1,!1];const n=t?Nm.z3.instance.getContainerWidgets(t,Nm.W2.Top):[],s=n.findIndex((t=>t.id===e.id));return[s>0,s<n.length-1]},vh=(e,t,i,n,s,o)=>{const a=n||Sm.Z.canUserModifyWidgets(e,null==t?void 0:t.roomId),r=Tm.c.instance.getMessagingForUid(Sm.Z.getWidgetUid(i));return dh(i)||mh(i,a)||hh(e,null==t?void 0:t.roomId,i,n)||ph(a,o)||uh(r)||gh(i,t,s).some(Boolean)},_h=e=>{let{onFinished:t,app:i,userWidget:n,onDeleteClick:s,onEditClick:a,showUnpin:c}=e,d=(0,v.Z)(e,ch);const m=(0,o.useContext)(pn.ZP),{room:h,roomId:p}=(0,o.useContext)(qt.ZP),u=Tm.c.instance.getMessagingForUid(Sm.Z.getWidgetUid(i)),g=n||Sm.Z.canUserModifyWidgets(m,p);let _,f,E,y,b;if(p&&dh(i)){const e=async()=>{try{await Om(m,u,p)}catch(e){r.k.error("Failed to start livestream",e);const t=e instanceof Error?e.message:(0,l._t)("widget|error_unable_start_audio_stream_description");T.ZP.createDialog(dt.Z,{title:(0,l._t)("widget|error_unable_start_audio_stream_title"),description:t})}t()};_=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("widget|context_menu|start_audio_stream")})}if(mh(i,g)){const e=()=>{a?a():h&&Sm.Z.editWidget(h,i),t()};f=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("action|edit")})}if(uh(u)){const e=()=>{null==u||u.takeScreenshot().then((e=>{x.ZP.dispatch({action:"picture_snapshot",file:e.screenshot})})).catch((e=>{r.k.error("Failed to take screenshot: ",e)})),t()};E=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("widget|context_menu|screenshot")})}if(ph(g,s)){const e=()=>{s?s():p&&T.ZP.createDialog(mt.Z,{title:(0,l._t)("widget|context_menu|delete"),description:(0,l._t)("widget|context_menu|delete_warning"),button:(0,l._t)("widget|context_menu|delete"),onFinished:e=>{e&&Sm.Z.setRoomWidget(m,p,i.id)}}),t()};y=o.createElement(ur.$k,{onClick:e,label:n?(0,l._t)("action|remove"):(0,l._t)("widget|context_menu|remove")})}if(hh(m,p,i,n)){const e={approved:void 0};if(Am.E.instance.invoke(Pm.H.PreLoadRequest,e,new rh(i)),!e.approved){const e=()=>{const e=(0,Cm.D)(i)?i.eventId:void 0;r.k.info("Revoking permission for widget to load: "+e);const n=L.C.getValue("allowedWidgets",p);void 0!==e&&(n[e]=!1);const s=L.C.firstSupportedLevel("allowedWidgets");if(!s)throw new Error("level must be defined");L.C.setValue("allowedWidgets",null!=p?p:null,s,n).catch((e=>{r.k.error(e)})),t()};b=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("widget|context_menu|revoke")})}}const[w,S]=gh(i,h,c);let C,k;if(w){const e=()=>{if(!h)throw new Error("room must be defined");Nm.z3.instance.moveWithinContainer(h,Nm.W2.Top,i,-1),t()};C=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("widget|context_menu|move_left")})}if(S){const e=()=>{if(!h)throw new Error("room must be defined");Nm.z3.instance.moveWithinContainer(h,Nm.W2.Top,i,1),t()};k=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("widget|context_menu|move_right")})}return o.createElement(ur.ZP,(0,kt.Z)({},d,{chevronFace:ii.N7.None,onFinished:t}),o.createElement(ur.I2,null,_,f,b,y,E,C,k))};class fh{static isPinnable(e){return!!e&&(!!this.pinnableEventTypes.includes(e.getType())&&!e.isRedacted())}}(0,k.Z)(fh,"pinnableEventTypes",[n.EventType.RoomMessage,n.M_POLL_START.name,n.M_POLL_START.altName]);var Eh=i("../matrix-react-sdk/src/components/views/messages/MessageEvent.tsx");class yh extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"onTileClicked",(()=>{x.ZP.dispatch({action:W.a.ViewRoom,event_id:this.props.event.getId(),highlighted:!0,room_id:this.props.event.getRoomId(),metricsTrigger:void 0})})),(0,k.Z)(this,"relations",new Map),(0,k.Z)(this,"getRelationsForEvent",((e,t,i)=>{var n;if(e===this.props.event.getId())return null===(n=this.relations.get(t))||void 0===n?void 0:n.get(i)}))}render(){var e;const t=this.props.event.getSender();if(!t)throw new Error("Pinned event unexpectedly has no sender");let i;return this.props.onUnpinClicked&&(i=o.createElement(gs.Z,{onClick:this.props.onUnpinClicked,className:"mx_PinnedEventTile_unpinButton",title:(0,l._t)("action|unpin")})),o.createElement("div",{className:"mx_PinnedEventTile"},o.createElement(Vt.Z,{className:"mx_PinnedEventTile_senderAvatar",member:this.props.event.sender,size:"24px",fallbackUserId:t}),o.createElement("span",{className:"mx_PinnedEventTile_sender "+(0,It.kG)(t)},(null===(e=this.props.event.sender)||void 0===e?void 0:e.name)||t),i,o.createElement("div",{className:"mx_PinnedEventTile_message"},o.createElement(Eh.Z,{mxEvent:this.props.event,getRelationsForEvent:this.getRelationsForEvent,className:"mx_PinnedEventTile_body",maxImageHeight:150,onHeightChanged:()=>{},permalinkCreator:this.props.permalinkCreator,replacingEventId:this.props.event.replacingEventId()})),o.createElement("div",{className:"mx_PinnedEventTile_footer"},o.createElement("span",{className:"mx_MessageTimestamp mx_PinnedEventTile_timestamp"},(0,Oe.p6)(new Date(this.props.event.getTs()))),o.createElement(ae.Z,{onClick:this.onTileClicked,kind:"link"},(0,l._t)("common|view_message"))))}}(0,k.Z)(yh,"contextType",pn.ZP);var bh=i("../matrix-react-sdk/src/components/views/right_panel/types.ts");function wh(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Sh(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?wh(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):wh(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Ch(e){var t,i,s;return null!==(t=null==e||null===(i=e.currentState.getStateEvents(n.EventType.RoomPinnedEvents,""))||void 0===i||null===(s=i.getContent())||void 0===s?void 0:s.pinned)&&void 0!==t?t:[]}const kh=e=>{const[t,i]=(0,o.useState)(Ch(e)),s=(0,o.useCallback)((t=>{t&&t.getType()!==n.EventType.RoomPinnedEvents||i(Ch(e))}),[e]);return(0,In.V4)(null==e?void 0:e.currentState,n.RoomStateEvent.Events,s),(0,o.useEffect)((()=>(i(Ch(e)),()=>{i([])})),[e]),t};function xh(e){var t,i,n;return new Set(null!==(t=null==e||null===(i=e.getAccountData(bh.y))||void 0===i||null===(n=i.getContent())||void 0===n?void 0:n.event_ids)&&void 0!==t?t:[])}const Rh=e=>{const[t,i]=(0,o.useState)(new Set),s=(0,o.useCallback)((t=>{t&&t.getType()!==bh.y||i(xh(e))}),[e]);return(0,In.V4)(e,n.RoomEvent.AccountData,s),(0,o.useEffect)((()=>(i(xh(e)),()=>{i(new Set)})),[e]),t},Ih=({room:e,onClose:t,permalinkCreator:i})=>{const s=(0,o.useContext)(pn.ZP),a=(0,o.useContext)(qt.ZP),c=(0,go.c)(e,(e=>e.mayClientSendStateEvent(n.EventType.RoomPinnedEvents,s))),d=kh(e),m=Rh(e);(0,o.useEffect)((()=>{if(!s||s.isGuest())return;d.filter((e=>!m.has(e))).length>0&&s.setRoomAccountData(e.roomId,bh.y,{event_ids:d})}),[s,e.roomId,d,m]);const h=(0,Pn.G)((()=>{const t=d.map((async t=>{var i;const o=e.getUnfilteredTimelineSet(),a=null==o||null===(i=o.getTimelineForEvent(t))||void 0===i?void 0:i.getEvents().find((e=>e.getId()===t));if(a)return fh.isPinnable(a)?a:null;try{const[i,{events:[o]}]=await Promise.all([s.fetchRoomEvent(e.roomId,t),s.relations(e.roomId,t,n.RelationType.Replace,null,{limit:1})]),a=new n.MatrixEvent(i);a.isEncrypted()&&await s.decryptEventIfNeeded(a),await e.processPollEvents([a]);const r=a.getSender();if(r&&fh.isPinnable(a))return a.sender=e.getMember(r),o&&a.makeReplaced(o),a}catch(i){r.k.error("Error looking up pinned event "+t+" in room "+e.roomId),r.k.error(i)}return null}));return Promise.all(t)}),[s,e,d],null);let p;if(d.length)if(null!=h&&h.length){const t=async t=>{var i;const o=e.currentState.getStateEvents(n.EventType.RoomPinnedEvents,"");if(null!=o&&null!==(i=o.getContent())&&void 0!==i&&i.pinned){const i=o.getContent().pinned,a=i.indexOf(t.getId());-1!==a&&(i.splice(a,1),await s.sendStateEvent(e.roomId,n.EventType.RoomPinnedEvents,{pinned:i},""))}};p=(0,ne.gP)(h).reverse().map((e=>o.createElement(yh,{key:e.getId(),event:e,onUnpinClicked:c?()=>t(e):void 0,permalinkCreator:i})))}else p=o.createElement(re.Z,null);else p=o.createElement("div",{className:"mx_PinnedMessagesCard_empty_wrapper"},o.createElement("div",{className:"mx_PinnedMessagesCard_empty"},o.createElement("div",{className:"mx_MessageActionBar mx_PinnedMessagesCard_MessageActionBar"},o.createElement("div",{className:"mx_MessageActionBar_iconButton"},o.createElement(fi,null)),o.createElement("div",{className:"mx_MessageActionBar_iconButton"},o.createElement(Ai,null)),o.createElement("div",{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_optionsButton"},o.createElement(di,null))),o.createElement(ac.Z,{size:"4",className:"mx_PinnedMessagesCard_empty_header"},(0,l._t)("right_panel|pinned_messages|empty")),(0,l._t)("right_panel|pinned_messages|explainer",{},{b:e=>o.createElement("b",null,e)})));return o.createElement(bm.C,{header:o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(ac.Z,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,l._t)("right_panel|pinned_messages|title"))),className:"mx_PinnedMessagesCard",onClose:t},o.createElement(qt.ZP.Provider,{value:Sh(Sh({},a),{},{timelineRenderingType:qt.SB.Pinned})},p))};let Ph=function(e){return e.Html="Html",e.PlainText="PlainText",e.Json="Json",e}({}),Th=function(e){return e.Timeline="Timeline",e.Beginning="Beginning",e.LastNMessages="LastNMessages",e}({});const Zh=e=>{switch(e){case Ph.Html:return(0,l._t)("export_chat|html");case Ph.Json:return(0,l._t)("export_chat|json");case Ph.PlainText:return(0,l._t)("export_chat|text");default:throw new Error("Unknown format")}};var Nh=i("../matrix-react-sdk/src/components/views/elements/Validation.tsx"),Dh=i("./node_modules/react-dom/server.browser.js"),Mh=i("../matrix-react-sdk/node_modules/escape-html/index.js"),Oh=i.n(Mh),Ah=i("../matrix-react-sdk/node_modules/file-saver/dist/FileSaver.min.js"),Lh=i("../matrix-react-sdk/node_modules/sanitize-filename/index.js"),Uh=i.n(Lh),Fh=i("../matrix-react-sdk/src/utils/DecryptFile.ts");class Bh{constructor(e,t,i,n){if(this.room=e,this.exportType=t,this.exportOptions=i,this.setProgressText=n,(0,k.Z)(this,"files",[]),(0,k.Z)(this,"cancelled",!1),i.maxSize<1048576||i.maxSize>8388608e3||i.numberOfMessages&&i.numberOfMessages>10**8||t===Th.LastNMessages&&!i.numberOfMessages)throw new Error("Invalid export options");window.addEventListener("beforeunload",this.onBeforeUnload)}get destinationFileName(){return this.makeFileNameNoExtension(c.ZP.get().brand)+".zip"}onBeforeUnload(e){return e.preventDefault(),e.returnValue=(0,l._t)("export_chat|unload_confirm")}updateProgress(e,t=!0,i=!0){t&&r.k.log(e),i&&this.setProgressText(e)}addFile(e,t){const i={name:e,blob:t};this.files.push(i)}makeFileNameNoExtension(e="matrix"){var t;const i=Uh()(null!==(t=this.room.name)&&void 0!==t?t:(0,l._t)("common|unnamed_room")).trim()||"Unnamed Room",n=(0,Oe.VG)(new Date).replace(/:/g,"-");return`${Uh()(e)} - ${i} - Chat Export - ${n}`}async downloadZIP(){const e=this.destinationFileName,t=e.substring(0,e.lastIndexOf(".")),{default:n}=await i.e(2639).then(i.t.bind(i,"../matrix-react-sdk/node_modules/jszip/dist/jszip.min.js",23)),s=new n;if(this.cancelled)return this.cleanUp();this.updateProgress((0,l._t)("export_chat|generating_zip"));for(const e of this.files)s.file(t+"/"+e.name,e.blob);const o=await s.generateAsync({type:"blob"});(0,Ah.saveAs)(o,t+".zip")}cleanUp(){return r.k.log("Cleaning up..."),window.removeEventListener("beforeunload",this.onBeforeUnload),""}async cancelExport(){r.k.log("Cancelling export..."),this.cancelled=!0}downloadPlainText(e,t){const i=new Blob([t],{type:"text/plain"});(0,Ah.saveAs)(i,e)}setEventMetadata(e){const t=this.room.currentState,i=e.getSender();var n;(e.sender=!!i&&(null==t?void 0:t.getSentinelMember(i))||null,"m.room.member"===e.getType())&&(e.target=null!==(n=null==t?void 0:t.getSentinelMember(e.getStateKey()))&&void 0!==n?n:null);return e}getLimit(){let e;if(this.exportType===Th.LastNMessages)e=this.exportOptions.numberOfMessages;else e=10**8;return e}async getRequiredEvents(){const e=this.room.client.getEventMapper();let t=null,i=[];if(this.exportType===Th.Timeline)i=this.room.getLiveTimeline().getEvents();else{let o=this.getLimit();for(;o;){var s;const a=Math.min(o,1e3),r=await this.room.client.createMessagesRequest(this.room.roomId,t,a,n.Direction.Backward);if(this.cancelled)return this.cleanUp(),[];if(0===r.chunk.length)break;o-=r.chunk.length;const c=r.chunk.map(e);for(const e of c)i.push(e);this.exportType===Th.LastNMessages?this.updateProgress((0,l._t)("export_chat|fetched_n_events_with_total",{count:i.length,total:this.exportOptions.numberOfMessages})):this.updateProgress((0,l._t)("export_chat|fetched_n_events",{count:i.length})),t=null!==(s=r.end)&&void 0!==s?s:null}i.reverse()}const o=i.filter((e=>e.isEncrypted())).map((e=>this.room.client.decryptEventIfNeeded(e,{emit:!1})));await Promise.all(o);for(let e=0;e<i.length;e++)this.setEventMetadata(i[e]);return i}async getMediaBlob(e){let t;try{const i=e.isEncrypted(),n=e.getContent();if(i&&n.hasOwnProperty("file")&&"m.sticker"!==e.getType())t=await(0,Fh.np)(n.file);else{const e=(0,mn.z3)(n);if(!e.srcHttp)throw new Error("Cannot fetch without srcHttp");const i=await fetch(e.srcHttp);t=await i.blob()}}catch(e){r.k.log("Error decrypting media")}if(!t)throw new Error("Unable to fetch file");return t}splitFileName(e){const t=e.lastIndexOf(".");if(-1===t)return[e,""];return[e.slice(0,t),"."+e.slice(t+1)]}getFilePath(e){let t;switch(e.getContent().msgtype){case"m.image":t="images";break;case"m.video":t="videos";break;case"m.audio":t="audio";break;default:t="m.sticker"===e.getType()?"stickers":"files"}const i=(0,Oe.FB)(new Date(e.getTs()));let[n,s]=this.splitFileName(e.getContent().body);return"m.sticker"===e.getType()&&(s=".png"),(0,Ot.CZ)(e)&&(s=".ogg"),t+"/"+n+"-"+i+s}isReply(e){const t=(e.isEncrypted()?e.event.content:e.getContent())["m.relates_to"];return!(!t||!t["m.in_reply_to"])}isAttachment(e){const t=["m.sticker","m.image","m.file","m.video","m.audio"];return e.getType()===t[0]||t.includes(e.getContent().msgtype)}}class Vh extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onMouseDown",(e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)})),(0,k.Z)(this,"onMouseUp",(e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)})),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return o.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown})}}class jh extends o.Component{constructor(e){super(e),(0,k.Z)(this,"dragFunc",((e,t)=>{const i=t.clientX-e.currentX,n=this.state.width+i;return n<this.props.minWidth||n>this.props.maxWidth?e:(this.setState({width:n}),this.updateCSSWidth.bind(this)(n),{currentX:t.clientX,currentY:e.currentY})})),(0,k.Z)(this,"onMoueUp",(()=>{this.props.roomId&&L.C.setValue("ircDisplayNameWidth",this.props.roomId,U.R.ROOM_DEVICE,this.state.width)})),this.state={width:L.C.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},(()=>this.updateCSSWidth(this.state.width)))}updateCSSWidth(e){var t;null===(t=this.state.IRCLayoutRoot)||void 0===t||t.style.setProperty("--name-width",e+"px")}render(){return o.createElement(Vh,{className:"mx_ProfileResizer",dragFunc:this.dragFunc,onMouseUp:this.onMoueUp})}}function zh(e){return Wh(e,[e.client.getSafeUserId()].concat(e.client.getIgnoredUsers()))}function Wh(e,t=[]){const i=[],n=Object.keys(e.currentState.members);for(const s of n)e.currentState.members[s].typing&&-1===t.indexOf(s)&&i.push(e.currentState.members[s]);return i}class Hh extends o.Component{constructor(...e){var t;super(...e),(0,k.Z)(this,"state",{usersTyping:(t=this.props.room,Wh(t,[t.client.getSafeUserId()])),delayedStopTypingTimers:{}}),(0,k.Z)(this,"isVisible",(()=>Hh.isVisible(this.state))),(0,k.Z)(this,"onRoomTimeline",((e,t)=>{if((null==t?void 0:t.roomId)===this.props.room.roomId){const t=e.getSender(),i=this.state.usersTyping.filter((e=>e.userId!==t));i.length!==this.state.usersTyping.length&&this.setState({usersTyping:i}),this.abortUserTimer(t)}})),(0,k.Z)(this,"onRoomMemberTyping",(()=>{const e=zh(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})}))}componentDidMount(){E.p.safeGet().on(n.RoomMemberEvent.Typing,this.onRoomMemberTyping),E.p.safeGet().on(n.RoomEvent.Timeline,this.onRoomTimeline)}componentDidUpdate(e,t){const i=Hh.isVisible(t),n=Hh.isVisible(this.state);this.props.onShown&&!i&&n?this.props.onShown():this.props.onHidden&&i&&!n&&this.props.onHidden()}componentWillUnmount(){const e=E.p.get();e&&(e.removeListener(n.RoomMemberEvent.Typing,this.onRoomMemberTyping),e.removeListener(n.RoomEvent.Timeline,this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach((e=>e.abort()))}static isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter((t=>!e.some((e=>t.userId===e.userId)))),i=e.filter((e=>!this.state.usersTyping.some((t=>e.userId===t.userId))));i.forEach((e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()}));let n=Object.assign({},this.state.delayedStopTypingTimers);return n=i.reduce(((e,t)=>(delete e[t.userId],e)),n),n=t.reduce(((e,t)=>{if(!e[t.userId]){const i=new R.Z(5e3);e[t.userId]=i,i.start(),i.finished().then((()=>this.removeUserTimer(t.userId)),(()=>{}))}return e}),n),n}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let i=0;e.length>t&&(i=e.length-t+1,e=e.slice(0,t-1));const n=e.map((e=>o.createElement(Vt.Z,{key:e.userId,member:e,size:"24px",resizeMethod:"crop",viewUserOnClick:!0,"aria-live":"off"})));return i>0&&n.push(o.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",i)),n}render(){const e=[...this.state.usersTyping];for(const t in this.state.delayedStopTypingTimers){const i=this.props.room.getMember(t);i&&e.push(i)}e.sort(((e,t)=>(0,xa.qu)(e.name,t.name)));const t=function(e,t){let i=0;if(e.length>t&&(i=e.length-t+1),0===e.length)return"";if(1===e.length)return(0,l._t)("timeline|typing_indicator|one_user",{displayName:e[0].name});const n=e.map((e=>e.name));if(i>=1)return(0,l._t)("timeline|typing_indicator|more_users",{names:n.slice(0,t-1).join(", "),count:i});{const e=n.pop();return(0,l._t)("timeline|typing_indicator|two_users",{names:n.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return t?o.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},o.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),o.createElement("div",{className:"mx_WhoIsTypingTile_label"},t)):null}}(0,k.Z)(Hh,"defaultProps",{whoIsTypingLimit:3});var Gh=i("../matrix-react-sdk/src/components/structures/ScrollPanel.tsx"),Kh=i("../matrix-react-sdk/src/components/views/messages/DateSeparator.tsx"),qh=i("../matrix-react-sdk/src/components/views/messages/TimelineSeparator.tsx"),$h=i("../matrix-react-sdk/src/components/views/elements/ErrorBoundary.tsx"),Jh=i("../matrix-react-sdk/src/Editing.ts");class Yh{constructor(e,t,i,n,s,o){this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=i,this.lastShownEvent=n,this.nextEvent=s,this.nextEventTile=o,(0,k.Z)(this,"events",[]),(0,k.Z)(this,"ejectedEvents",[]),(0,k.Z)(this,"readMarker",void 0),this.readMarker=e.readMarkerForEvent(t.event.getId(),t.event===n)}}(0,k.Z)(Yh,"canStartGroup",((e,t)=>!0));var Qh=i("../matrix-react-sdk/src/TextForEvent.tsx"),Xh=i("../matrix-react-sdk/src/components/views/messages/EventTileBubble.tsx");const ep=()=>{var e;const{room:t}=(0,o.useContext)(qt.ZP),i=null==t?void 0:t.getLiveTimeline().getState(n.EventTimeline.BACKWARDS),s=null==i?void 0:i.getStateEvents("m.room.encryption")[0],a=null==i||null===(e=i.getStateEvents("m.room.history_visibility")[0])||void 0===e?void 0:e.getContent().history_visibility;let r;return"invited"==a?r=(0,l._t)("timeline|no_permission_messages_before_invite"):"joined"==a?r=(0,l._t)("timeline|no_permission_messages_before_join"):s&&(r=(0,l._t)("timeline|encrypted_historical_messages_unavailable")),o.createElement(Xh.Z,{className:"mx_HistoryTile",title:(0,l._t)("timeline|historical_messages_unavailable"),subtitle:r})},tp=({events:e,children:t,threshold:i=3,onToggle:n,startExpanded:s=!1,summaryMembers:a=[],summaryText:c,layout:d=St.A.Group,"data-testid":m})=>{const[h,p]=(0,mo.R)(s);(0,o.useEffect)((()=>{n&&n()}),[h]);const u=e.map((e=>e.getId())).join(",");if(e.length<i)return o.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":u,"data-expanded":!0,"data-layout":d},o.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));let g;if(h)g=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_GenericEventListSummary_spacer"},"Â "),o.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));else{const e=(0,ln.uniqBy)(a.filter((e=>!(null==e||!e.getMxcAvatarUrl)||(r.k.error("EventListSummary given null summaryMember, termites may be afoot eating event senders",a),!1))),(e=>e.getMxcAvatarUrl())).map((e=>o.createElement(Vt.Z,{key:e.userId,member:e,size:"14px"})));g=o.createElement("div",{className:"mx_EventTile_line"},o.createElement("div",{className:"mx_EventTile_info"},o.createElement("span",{className:"mx_GenericEventListSummary_avatars",onClick:p},e),o.createElement("span",{className:"mx_TextualEvent mx_GenericEventListSummary_summary"},c)))}return o.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":u,"data-expanded":h+"","data-layout":d,"data-testid":m},o.createElement(ae.Z,{kind:"link_inline",className:"mx_GenericEventListSummary_toggle",onClick:p,"aria-expanded":h},h?(0,l._t)("action|collapse"):(0,l._t)("action|expand")),g)};var ip=i("../matrix-react-sdk/src/utils/ReactUtils.tsx");const np=()=>{nm.Z.instance.setCard({phase:im.q.PinnedMessages},!1)},sp=[n.EventType.RoomMember];var op=function(e){return e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl",e.ChangedPins="pinned_messages",e.MessageRemoved="message_removed",e.HiddenEvent="hidden_event",e}(op||{});class ap extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"context",void 0)}shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold||e.layout!==this.props.layout}generateSummary(e,t){const i=t.map((t=>{const i=e[t],n=this.renderNameList(i),s=t.split(","),o=ap.getCanonicalTransitions(s),a=ap.coalesceRepeatedTransitions(o).map((e=>ap.getDescriptionForTransition(e.transitionType,i.length,e.repeats))),r=(0,It.If)(a);return(0,l._t)("timeline|summary|format",{nameList:n,transitionList:r})}));return i?(0,ip.e)(i,", "):null}renderNameList(e){return(0,It.If)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[op.Joined]:{after:op.Left,newTransition:op.JoinedAndLeft},[op.Left]:{after:op.Joined,newTransition:op.LeftAndJoined}},i=[];for(let n=0;n<e.length;n++){const s=e[n],o=e[n+1];let a=s;n<e.length-1&&t[s]&&t[s].after===o&&(a=t[s].newTransition,n++),i.push(a)}return i}static coalesceRepeatedTransitions(e){const t=[];for(const i of e)t.length>0&&t[t.length-1].transitionType===i?t[t.length-1].repeats+=1:t.push({transitionType:i,repeats:1});return t}static getDescriptionForTransition(e,t,i){var n;let s;switch(e){case op.Joined:s=t>1?(0,l._t)("timeline|summary|joined_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|joined",{oneUser:"",count:i});break;case op.Left:s=t>1?(0,l._t)("timeline|summary|left_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|left",{oneUser:"",count:i});break;case op.JoinedAndLeft:s=t>1?(0,l._t)("timeline|summary|joined_and_left_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|joined_and_left",{oneUser:"",count:i});break;case op.LeftAndJoined:s=t>1?(0,l._t)("timeline|summary|rejoined_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|rejoined",{oneUser:"",count:i});break;case op.InviteReject:s=t>1?(0,l._t)("timeline|summary|rejected_invite_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|rejected_invite",{oneUser:"",count:i});break;case op.InviteWithdrawal:s=t>1?(0,l._t)("timeline|summary|invite_withdrawn_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|invite_withdrawn",{oneUser:"",count:i});break;case op.Invited:s=t>1?(0,l._t)("timeline|summary|invited_multiple",{count:i}):(0,l._t)("timeline|summary|invited",{count:i});break;case op.Banned:s=t>1?(0,l._t)("timeline|summary|banned_multiple",{count:i}):(0,l._t)("timeline|summary|banned",{count:i});break;case op.Unbanned:s=t>1?(0,l._t)("timeline|summary|unbanned_multiple",{count:i}):(0,l._t)("timeline|summary|unbanned",{count:i});break;case op.Kicked:s=t>1?(0,l._t)("timeline|summary|kicked_multiple",{count:i}):(0,l._t)("timeline|summary|kicked",{count:i});break;case op.ChangedName:s=t>1?(0,l._t)("timeline|summary|changed_name_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|changed_name",{oneUser:"",count:i});break;case op.ChangedAvatar:s=t>1?(0,l._t)("timeline|summary|changed_avatar_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|changed_avatar",{oneUser:"",count:i});break;case op.NoChange:s=t>1?(0,l._t)("timeline|summary|no_change_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|no_change",{oneUser:"",count:i});break;case op.ServerAcl:s=t>1?(0,l._t)("timeline|summary|server_acls_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|server_acls",{oneUser:"",count:i});break;case op.ChangedPins:s=t>1?(0,l._t)("timeline|summary|pinned_events_multiple",{severalUsers:"",count:i},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:np},e)}):(0,l._t)("timeline|summary|pinned_events",{oneUser:"",count:i},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:np},e)});break;case op.MessageRemoved:s=t>1?(0,l._t)("timeline|summary|redacted_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|redacted",{oneUser:"",count:i});break;case op.HiddenEvent:s=t>1?(0,l._t)("timeline|summary|hidden_event_multiple",{severalUsers:"",count:i}):(0,l._t)("timeline|summary|hidden_event",{oneUser:"",count:i})}return null!==(n=s)&&void 0!==n?n:null}static getTransitionSequence(e){return e.map(ap.getTransition)}static getTransition(e){if(e.mxEvent.isRedacted())return op.MessageRemoved;switch(e.mxEvent.getType()){case n.EventType.RoomThirdPartyInvite:return(0,Ra.ih)(e.mxEvent)?op.Invited:op.InviteWithdrawal;case n.EventType.RoomServerAcl:return op.ServerAcl;case n.EventType.RoomPinnedEvents:return op.ChangedPins;case n.EventType.RoomMember:switch(e.mxEvent.getContent().membership){case"invite":return op.Invited;case"ban":return op.Banned;case"join":return"join"===e.mxEvent.getPrevContent().membership?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?op.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?op.ChangedAvatar:op.NoChange:op.Joined;case"leave":if(e.mxEvent.getSender()===e.mxEvent.getStateKey())return"invite"===e.mxEvent.getPrevContent().membership?op.InviteReject:op.Left;switch(e.mxEvent.getPrevContent().membership){case"invite":return op.InviteWithdrawal;case"ban":return op.Unbanned;default:return op.Kicked}default:return null}default:return op.HiddenEvent}}getAggregate(e){const t={},i={};return Object.keys(e).forEach((n=>{const s=e[n][0],o=s.displayName,a=ap.getTransitionSequence(e[n]).join(",");t[a]||(t[a]=[],i[a]=-1),t[a].push(o),(-1===i[a]||s.index<i[a])&&(i[a]=s.index)})),{names:t,indices:i}}render(){const e=this.props.events,t=new Map,i={};e.forEach(((e,s)=>{var o;const a=e.getType();let r=e.getSender();e.isState()&&a===n.EventType.RoomThirdPartyInvite?r=e.getContent().display_name:e.isState()&&a===n.EventType.RoomMember?r=e.getStateKey():e.isRedacted()&&null!==(o=e.getUnsigned())&&void 0!==o&&o.redacted_because&&(r=e.getUnsigned().redacted_because.sender),i[r]||(i[r]=[]);let l=r;if(e.isRedacted()){var c,d;const e=null===(c=this.context)||void 0===c||null===(d=c.room)||void 0===d?void 0:d.getMember(r);e&&(l=e.name,t.set(r,e))}else e.target&&sp.includes(a)?(l=e.target.name,t.set(r,e.target)):e.sender&&a!==n.EventType.RoomThirdPartyInvite&&(l=e.sender.name,t.set(r,e.sender));i[r].push({mxEvent:e,displayName:l,index:s})}));const s=this.getAggregate(i),a=Object.keys(s.names).sort(((e,t)=>s.indices[e]-s.indices[t]));return o.createElement(tp,{"data-testid":this.props["data-testid"],events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],layout:this.props.layout,summaryText:this.generateSummary(s.names,a)})}}(0,k.Z)(ap,"contextType",qt.ZP),(0,k.Z)(ap,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5,layout:St.A.Group});const rp=[n.EventType.RoomMember,n.EventType.RoomThirdPartyInvite,n.EventType.RoomServerAcl,n.EventType.RoomPinnedEvents];class lp extends Yh{constructor(e,t,i,n,s,o){super(e,t,i,n,s,o),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=i,this.lastShownEvent=n,this.events=[t]}shouldGroup({event:e,shouldShow:t}){return!t||this.panel.wantsSeparator(this.events[0].event,e)!==qh.K.Date&&(!(!e.isState()||!rp.includes(e.getType()))||(!!e.isRedacted()||!(!this.panel.showHiddenEvents||this.panel.shouldShowEvent(e,!0))))}add(e){const{event:t,shouldShow:i}=e;(t.getType()!==n.EventType.RoomMember||(0,Qh.bZ)(t,E.p.safeGet(),this.panel.showHiddenEvents))&&(this.readMarker=this.readMarker||this.panel.readMarkerForEvent(t.getId(),t===this.lastShownEvent),(this.panel.showHiddenEvents||i)&&this.events.push(e))}generateKey(){return"eventlistsummary-"+this.events[0].event.getId()}getTiles(){var e;if(null===(e=this.events)||void 0===e||!e.length)return[];const t=this.panel,i=this.lastShownEvent,n=[];if(t.wantsSeparator(this.prevEvent,this.events[0].event)===qh.K.Date){const e=this.events[0].event.getTs();n.push(o.createElement("li",{key:e+"~"},o.createElement(Kh.Z,{roomId:this.events[0].event.getRoomId(),ts:e})))}const s=this.events.find((e=>this.panel.grouperKeyMap.get(e.event))),a=s&&this.panel.grouperKeyMap.has(s.event)?this.panel.grouperKeyMap.get(s.event):this.generateKey();s||this.panel.grouperKeyMap.set(this.events[0].event,a);let r=!1,l=this.events.map(((e,n)=>(e.event.getId()===t.props.highlightedEventId&&(r=!0),t.getTilesForEvent(0===n?this.prevEvent:this.events[n-1].event,e,e.event===i,true,this.nextEvent,this.nextEventTile)))).reduce(((e,t)=>e.concat(t)),[]);return 0===l.length&&(l=null),this.panel.props.canBackPaginate||this.prevEvent||n.push(o.createElement(ep,{key:"historytile"})),n.push(o.createElement(ap,{key:a,"data-testid":a,events:this.events.map((e=>e.event)),onToggle:t.onHeightChanged,startExpanded:r,layout:this.panel.props.layout},l)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.events[this.events.length-1].event}}(0,k.Z)(lp,"canStartGroup",(function(e,{event:t,shouldShow:i}){return!!i&&(!(!t.isState()||!rp.includes(t.getType()))||(!!t.isRedacted()||!(!e.showHiddenEvents||e.shouldShowEvent(t,!0))))}));var cp=i("../matrix-react-sdk/src/utils/rooms.ts"),dp=i("../matrix-react-sdk/src/models/LocalRoom.ts");const mp=e=>{if(!(0,cp.G)(e.client))return{shouldEncrypt:!1};if(!P.Z.shared().getRoomIds().has(e.roomId))return{shouldEncrypt:!1};if(1!==e.getInvitedAndJoinedMemberCount())return{shouldEncrypt:!1};const t=e.currentState.getStateEvents("m.room.third_party_invite")||[];return 1===t.length?{shouldEncrypt:!0,inviteEvent:t[0]}:{shouldEncrypt:!1}};const hp=()=>{var e;const t=(0,o.useContext)(pn.ZP),{room:i,roomId:s}=(0,o.useContext)(qt.ZP);if(!i||!s)throw new Error("Unable to create a NewRoomIntro without room and roomId");const a=i instanceof dp.pP,r=a?null===(e=i.targets[0])||void 0===e?void 0:e.userId:P.Z.shared().getUserIdForRoomId(s);let c;if(r){const{shouldEncrypt:e}=mp(i),t=((e,t)=>e instanceof dp.pP?(0,l.I8)("room|intro|send_message_start_dm"):t?(0,l.I8)("room|intro|encrypted_3pid_dm_pending_join"):(0,l.I8)("room|intro|start_of_dm_history"))(i,e);let n;i instanceof dp.pP||e||i.getJoinedMemberCount()+i.getInvitedMemberCount()!==2||(n=(0,l._t)("room|intro|dm_caption"));const s=null==i?void 0:i.getMember(r),a=(null==i?void 0:i.name)||(null==s?void 0:s.rawDisplayName)||r;c=o.createElement(o.Fragment,null,o.createElement(ei.Z,{room:i,size:Pd,onClick:()=>{x.ZP.dispatch({action:W.a.ViewUser,member:s||{userId:r}})}}),o.createElement("h2",null,i.name),o.createElement("p",null,(0,l._t)(t,{},{displayName:()=>o.createElement("b",null,a)})),n&&o.createElement("p",null,n))}else{var d,m,h,p,u,g,v;const e=i&&"join"===i.getMyMembership(),a=null===(d=i.currentState.getStateEvents(n.EventType.RoomTopic,""))||void 0===d||null===(m=d.getContent())||void 0===m?void 0:m.topic,r=e&&i.currentState.maySendStateEvent(n.EventType.RoomTopic,t.getSafeUserId()),_=()=>{x.ZP.dispatch({action:"open_room_settings",room_id:s},!0),setImmediate((()=>{var e;null===(e=window.document.getElementById("profileTopic"))||void 0===e||e.focus()}))};let f;r&&a?f=(0,l._t)("room|intro|topic_edit",{topic:a},{a:e=>o.createElement(ae.Z,{element:"a",kind:"link_inline",onClick:_},e)}):a?f=(0,l._t)("room|intro|topic",{topic:a}):r&&(f=(0,l._t)("room|intro|no_topic",{},{a:e=>o.createElement(ae.Z,{element:"a",kind:"link_inline",onClick:_},e)}));const E=null===(h=i.currentState.getStateEvents(n.EventType.RoomCreate,""))||void 0===h?void 0:h.getSender(),y=E&&(null==i||null===(p=i.getMember(E))||void 0===p?void 0:p.rawDisplayName)||E;let b,w,S;b=E===t.getUserId()?(0,l._t)("room|intro|you_created"):(0,l._t)("room|intro|user_created",{displayName:y}),null!==(u=Rs.ZP.instance.activeSpaceRoom)&&void 0!==u&&u.canInvite(t.getSafeUserId())&&Rs.ZP.instance.isRoomInSpace(Rs.ZP.instance.activeSpace,i.roomId)&&(w=Rs.ZP.instance.activeSpaceRoom),w&&(0,hr.I)(Ye.y.InviteUsers)?S=o.createElement("div",{className:"mx_NewRoomIntro_buttons"},o.createElement(ae.Z,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{(0,ko.N2)(w)}},(0,l._t)("invite|to_space",{spaceName:w.name})),i.canInvite(t.getSafeUserId())&&o.createElement(ae.Z,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{x.ZP.dispatch({action:"view_invite",roomId:s})}},(0,l._t)("room|intro|room_invite"))):i.canInvite(t.getSafeUserId())&&(0,hr.I)(Ye.y.InviteUsers)&&(S=o.createElement("div",{className:"mx_NewRoomIntro_buttons"},o.createElement(ae.Z,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{x.ZP.dispatch({action:"view_invite",roomId:s})}},(0,l._t)("room|invite_this_room"))));const C=null===(g=i.currentState.getStateEvents(n.EventType.RoomAvatar,""))||void 0===g||null===(v=g.getContent())||void 0===v?void 0:v.url;let k=o.createElement(ei.Z,{room:i,size:Pd,viewAvatarOnClick:!!C});C||(k=o.createElement(Td,{hasAvatar:!1,noAvatarLabel:(0,l._t)("room|intro|no_avatar_label"),setAvatarUrl:e=>t.sendStateEvent(s,n.EventType.RoomAvatar,{url:e},"")},k)),c=o.createElement(o.Fragment,null,k,o.createElement("h2",null,i.name),o.createElement("p",null,b," ",(0,l._t)("room|intro|start_of_room",{},{roomName:()=>o.createElement("b",null,i.name)})),o.createElement("p",null,f),S)}const _=(0,l._t)("room|intro|private_unencrypted_warning");let f;i.currentState.mayClientSendStateEvent(n.EventType.RoomEncryption,E.p.safeGet())&&!a&&(f=o.createElement(ae.Z,{kind:"link_inline",onClick:function(e){e.preventDefault(),x.ZP.dispatch({action:"open_room_settings",initial_tab_id:bt.a.Security})}},(0,l._t)("room|intro|enable_encryption_prompt")));const y=o.createElement("span",null," ",_," ",f," ");return o.createElement("li",{className:"mx_NewRoomIntro"},!function(e,t){const i=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!(0,cp.G)(e)||i}(t,i)&&o.createElement(Xh.Z,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:(0,l._t)("room|intro|unencrypted_warning"),subtitle:y}),c)};class pp extends Yh{shouldGroup({event:e,shouldShow:t}){const i=this.panel,s=this.firstEventAndShouldShow.event;if(!t)return!0;if(i.wantsSeparator(this.firstEventAndShouldShow.event,e)===qh.K.Date)return!1;const o=e.getType();return(o!==n.EventType.RoomMember||e.getStateKey()===s.getSender()&&"join"===e.getContent().membership)&&(!n.M_BEACON_INFO.matches(o)&&(Ut.Q6!==o&&!(!e.isState()||e.getSender()!==s.getSender())))}add(e){const{event:t,shouldShow:i}=e,s=this.panel;this.readMarker=this.readMarker||s.readMarkerForEvent(t.getId(),t===this.lastShownEvent),i&&(t.getType()===n.EventType.RoomEncryption?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){var e,t;if(!this.events||!this.events.length)return[];const i=this.panel,n=[],s=this.firstEventAndShouldShow,a=this.lastShownEvent;if(i.wantsSeparator(this.prevEvent,s.event)===qh.K.Date){const e=s.event.getTs();n.push(o.createElement("li",{key:e+"~"},o.createElement(Kh.Z,{roomId:s.event.getRoomId(),ts:e})))}s.shouldShow&&n.push(...i.getTilesForEvent(s.event,s));for(const e of this.ejectedEvents)n.push(...i.getTilesForEvent(s.event,e,s.event===a,true));const r=this.events.map((e=>i.getTilesForEvent(e.event,e,e.event===a,true))).reduce(((e,t)=>e.concat(t)),[]),c=this.events[this.events.length-1].event;let d;const m=c.getRoomId(),h=null!==(e=null===(t=c.sender)||void 0===t?void 0:t.name)&&void 0!==e?e:c.getSender();return d=m&&P.Z.shared().getUserIdForRoomId(m)?(0,l._t)("timeline|creation_summary_dm",{creator:h}):(0,l._t)("timeline|creation_summary_room",{creator:h}),n.push(o.createElement(hp,{key:"newroomintro"})),n.push(o.createElement(tp,{key:"roomcreationsummary",events:this.events.map((e=>e.event)),onToggle:i.onHeightChanged,summaryMembers:c.sender?[c.sender]:void 0,summaryText:d,layout:this.panel.props.layout},r)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.firstEventAndShouldShow.event}}(0,k.Z)(pp,"canStartGroup",(function(e,{event:t}){return t.getType()===n.EventType.RoomCreate}));const up=[n.EventType.Sticker,n.EventType.RoomMessage];function gp(e,t,i,n,s){return s!==qt.SB.ThreadsList&&(!(null==e||!e.sender||!t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||up.includes(t.getType())&&up.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&((!(0,Ot.XA)(t)&&!(0,Ot.XA)(e)||s===qt.SB.Thread)&&!!(0,At.eD)(e,i,n)))))))}class vp extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"readReceiptMap",{}),(0,k.Z)(this,"readReceiptsByEvent",new Map),(0,k.Z)(this,"readReceiptsByUserId",new Map),(0,k.Z)(this,"_showHiddenEvents",void 0),(0,k.Z)(this,"isMounted",!1),(0,k.Z)(this,"readMarkerNode",(0,o.createRef)()),(0,k.Z)(this,"whoIsTyping",(0,o.createRef)()),(0,k.Z)(this,"scrollPanel",(0,o.createRef)()),(0,k.Z)(this,"showTypingNotificationsWatcherRef",void 0),(0,k.Z)(this,"eventTiles",{}),(0,k.Z)(this,"grouperKeyMap",new WeakMap),(0,k.Z)(this,"calculateRoomMembersCount",(()=>{this.setState({hideSender:this.shouldHideSender()})})),(0,k.Z)(this,"onShowTypingNotificationsChange",(()=>{this.setState({showTypingNotifications:L.C.getValue("showTypingNotifications")})})),(0,k.Z)(this,"isUnmounting",(()=>!this.isMounted)),(0,k.Z)(this,"collectGhostReadMarker",(e=>{e&&requestAnimationFrame((()=>{e.style.width="10%",e.style.opacity="0"}))})),(0,k.Z)(this,"onGhostTransitionEnd",(e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter((e=>e!==t))})})),(0,k.Z)(this,"collectEventTile",((e,t)=>{this.eventTiles[e]=t})),(0,k.Z)(this,"onHeightChanged",(()=>{const e=this.scrollPanel.current;e&&e.checkScroll()})),(0,k.Z)(this,"onTypingShown",(()=>{const e=this.scrollPanel.current;null==e||e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()})),(0,k.Z)(this,"onTypingHidden",(()=>{const e=this.scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())})),this.state={ghostReadMarkers:[],showTypingNotifications:L.C.getValue("showTypingNotifications"),hideSender:this.shouldHideSender()},this._showHiddenEvents=L.C.getValue("showHiddenEventsInTimeline"),this.showTypingNotificationsWatcherRef=L.C.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange)}componentDidMount(){var e;this.calculateRoomMembersCount(),null===(e=this.props.room)||void 0===e||e.currentState.on(n.RoomStateEvent.Update,this.calculateRoomMembersCount),this.isMounted=!0}componentWillUnmount(){var e;this.isMounted=!1,null===(e=this.props.room)||void 0===e||e.currentState.off(n.RoomStateEvent.Update,this.calculateRoomMembersCount),L.C.unwatchSetting(this.showTypingNotificationsWatcherRef),this.readReceiptMap={}}componentDidUpdate(e,t){if(e.layout!==this.props.layout&&this.calculateRoomMembersCount(),e.readMarkerVisible&&e.readMarkerEventId&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}const i=this.pendingEditItem;if(!this.props.editState&&this.props.room&&i){const e=this.props.room.findEventById(i);x.ZP.dispatch({action:W.a.EditEvent,event:null!=e&&e.isRedacted()?null:e,timelineRenderingType:this.context.timelineRenderingType})}}shouldHideSender(){return!!this.props.room&&this.props.room.getInvitedAndJoinedMemberCount()<=2&&this.props.layout===St.A.Bubble}getNodeForEventId(e){var t,i,n;if(this.eventTiles)return null!==(t=null===(i=this.eventTiles[e])||void 0===i||null===(n=i.ref)||void 0===n?void 0:n.current)&&void 0!==t?t:void 0}getTileForEventId(e){if(this.eventTiles&&e)return this.eventTiles[e]}isAtBottom(){var e;return null===(e=this.scrollPanel.current)||void 0===e?void 0:e.isAtBottom()}getScrollState(){var e,t;return null!==(e=null===(t=this.scrollPanel.current)||void 0===t?void 0:t.getScrollState())&&void 0!==e?e:null}getReadMarkerPosition(){const e=this.readMarkerNode.current,t=this.scrollPanel.current;if(!e||!t)return null;const i=Dn.findDOMNode(t).getBoundingClientRect(),n=e.getBoundingClientRect();return n.bottom+2<i.top?-1:n.top<i.bottom?0:1}scrollToTop(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToTop()}scrollToBottom(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToBottom()}handleScrollKey(e){var t;null===(t=this.scrollPanel.current)||void 0===t||t.handleScrollKey(e)}scrollToEvent(e,t,i){var n;null===(n=this.scrollPanel.current)||void 0===n||n.scrollToToken(e,t,i)}scrollToEventIfNeeded(e){const t=this.getNodeForEventId(e);t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}get showHiddenEvents(){var e,t;return null!==(e=null===(t=this.context)||void 0===t?void 0:t.showHiddenEvents)&&void 0!==e?e:this._showHiddenEvents}shouldShowEvent(e,t=!1){if(this.props.hideThreadedMessages&&this.props.room){const{shouldLiveInRoom:t}=this.props.room.eventShouldLiveIn(e,this.props.events);if(!t)return!1}return!E.p.safeGet().isUserIgnored(e.getSender())&&(!(!this.showHiddenEvents||t)||!!(0,At.eD)(e,E.p.safeGet(),this.showHiddenEvents)&&(this.props.highlightedEventId===e.getId()||!(0,Qd.Z)(e,this.context)))}readMarkerForEvent(e,t){const i=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return i&&(t=o.createElement("hr",{style:{opacity:1,width:"99%"}})),o.createElement("li",{key:"readMarker_"+e,ref:this.readMarkerNode,className:"mx_MessagePanel_myReadMarker","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=o.createElement("hr",{ref:this.collectGhostReadMarker,onTransitionEnd:this.onGhostTransitionEnd,"data-eventid":e});return o.createElement("li",{key:"_readuptoghost_"+e,className:"mx_MessagePanel_myReadMarker"},t)}return null}getNextEventInfo(e,t){const i=t<e.length-1?e[t+1]:null,n=function(e,t){for(let i=e+1;i<t.length;i++){const{event:e,shouldShow:n}=t[i];if(n)return e}return null}(t,e);return{nextEventAndShouldShow:i,nextTile:n}}get pendingEditItem(){if(!this.props.room)return null;try{return localStorage.getItem((0,Jh.s)(this.props.room.roomId,this.context.timelineRenderingType))}catch(e){return r.k.error(e),null}}isSentState(e){const t=e.getAssociatedStatus();return!t||t===n.EventStatus.SENT}getEventTiles(){let e;const t=this.props.events.map((e=>({event:e,shouldShow:this.shouldShowEvent(e)}))),i=E.p.safeGet().getSafeUserId();let n=!1,s=-1;for(let o=t.length-1;o>=0;o--){const{event:a,shouldShow:r}=t[o];if(r&&(void 0===e&&(e=a),!n&&this.isSentState(a)&&os(a)&&(n=!0,a.getSender()===i&&(t[o].lastSuccessfulWeSent=!0)),s<0&&!a.status&&(s=o),s>=0&&n))break}const o=[];let a=null;this.readReceiptsByEvent=new Map,this.props.showReadReceipts&&(this.readReceiptsByEvent=this.getReadReceiptsByShownEvent(t));let r=null;for(let i=0;i<t.length;i++){const n=t[i],{event:l,shouldShow:c}=n,d=l.getId(),m=l===e,{nextEventAndShouldShow:h,nextTile:p}=this.getNextEventInfo(t,i);if(r){if(r.shouldGroup(n)){r.add(n);continue}o.push(...r.getTiles()),a=r.getNewPrevEvent(),r=null}for(const t of _p)if(t.canStartGroup(this,n)&&!this.props.disableGrouping){r=new t(this,n,a,e,h,p);break}if(!r){c&&(o.push(...this.getTilesForEvent(a,n,m,!1,h,p)),a=l);const e=this.readMarkerForEvent(d,i>=s);e&&o.push(e)}}return r&&o.push(...r.getTiles()),o}getTilesForEvent(e,t,i=!1,n=!1,s=null,a=null){var r,c,d;const m=t.event,h=[],p=(null===(r=this.props.editState)||void 0===r?void 0:r.getEvent().getId())===m.getId(),u=null!==(c=m.getTs())&&void 0!==c?c:Date.now(),g=this.wantsSeparator(e,m);if(!n&&this.props.room)if(g===qh.K.Date)h.push(o.createElement("li",{key:u},o.createElement(Kh.Z,{key:u,roomId:this.props.room.roomId,ts:u})));else if(g===qh.K.LateEvent){var v;const e=(0,l._t)("timeline|late_event_separator",{dateTime:(0,Oe.p6)(null!==(v=m.getDate())&&void 0!==v?v:new Date)});h.push(o.createElement("li",{key:u},o.createElement(qh.Z,{key:u,label:e},e)))}const _=E.p.safeGet();let f=!0;if(a){const e=a;f=this.wantsSeparator(m,e)===qh.K.Date||m.getSender()!==e.getSender()||Ft(_,e,this.showHiddenEvents).isInfoMessage||!gp(m,e,_,this.showHiddenEvents,this.context.timelineRenderingType)}const y=g===qh.K.None&&gp(e,m,_,this.showHiddenEvents,this.context.timelineRenderingType),b=m.getId(),w=b===this.props.highlightedEventId,S=this.readReceiptsByEvent.get(b),C=this.props.callEventGroupers.get(m.getContent().call_id);return h.push(o.createElement(rs,{key:m.getTxnId()||b,as:"li",ref:this.collectEventTile.bind(this,b),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:m,continuation:y,isRedacted:m.isRedacted(),replacingEventId:m.replacingEventId(),editState:p?this.props.editState:void 0,onHeightChanged:this.onHeightChanged,readReceipts:S,readReceiptMap:this.readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this.isUnmounting,eventSendStatus:null!==(d=m.getAssociatedStatus())&&void 0!==d?d:void 0,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:i,lastInSection:f,lastSuccessful:t.lastSuccessfulWeSent,isSelectedEvent:w,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,showReadReceipts:this.props.showReadReceipts,callEventGrouper:C,hideSender:this.state.hideSender})),h}wantsSeparator(e,t){var i;if(this.context.timelineRenderingType===qt.SB.ThreadsList)return qh.K.None;if(null!==e){var n;const i=is(t);if((null==i?void 0:i.group_id)!==(null===(n=is(e))||void 0===n?void 0:n.group_id))return void 0!==i?qh.K.LateEvent:qh.K.Date}if(null===e&&!this.props.canBackPaginate)return qh.K.Date;const s=null!==(i=t.getDate())&&void 0!==i?i:new Date;return null!==e&&(0,Oe.JC)(e.getDate()||void 0,s)?qh.K.Date:qh.K.None}getReadReceiptsForEvent(e){const t=E.p.safeGet().credentials.userId,{room:i}=this.props;if(!i)return null;const n=this.context.threadId?i.getThread(this.context.threadId):i,s=[];return n?(n.getReceiptsForEvent(e).forEach((e=>{if(!e.userId||!(0,xa.cS)(e.type)||e.userId===t)return;if(E.p.safeGet().isUserIgnored(e.userId))return;const n=i.getMember(e.userId);s.push({userId:e.userId,roomMember:n,ts:e.data?e.data.ts:0})})),s):(r.k.debug("Discarding request, could not find the receiptDestination for event: "+this.context.threadId),s)}getReadReceiptsByShownEvent(e){const t=new Map,i=new Map;let n;for(const e of this.props.events){if(this.shouldShowEvent(e)&&(n=e.getId()),!n)continue;const s=t.get(n)||[],o=this.getReadReceiptsForEvent(e);if(o){t.set(n,s.concat(o));for(const e of o)i.set(e.userId,{lastShownEventId:n,receipt:e})}}for(const e of this.readReceiptsByUserId.keys()){if(i.get(e))continue;const{lastShownEventId:n,receipt:s}=this.readReceiptsByUserId.get(e),o=t.get(n)||[];t.set(n,o.concat(s)),i.set(e,{lastShownEventId:n,receipt:s})}this.readReceiptsByUserId=i;for(const e of t.values())e.sort(((e,t)=>t.ts-e.ts));return t}updateTimelineMinHeight(){const e=this.scrollPanel.current;if(e){const t=e.isAtBottom(),i=this.whoIsTyping.current,n=i&&i.isVisible();t&&n&&e.preventShrinking()}}onTimelineReset(){const e=this.scrollPanel.current;e&&e.clearPreventShrinking()}render(){let e,t;this.props.backPaginating&&(e=o.createElement("li",{key:"_topSpinner"},o.createElement(re.Z,null))),this.props.forwardPaginating&&(t=o.createElement("li",{key:"_bottomSpinner"},o.createElement(re.Z,null)));const i=this.props.hidden?{display:"none"}:{};let n,s;var a,r;(this.props.room&&this.state.showTypingNotifications&&this.context.timelineRenderingType===qt.SB.Room&&(n=o.createElement(Hh,{room:this.props.room,onShown:this.onTypingShown,onHidden:this.onTypingHidden,ref:this.whoIsTyping})),this.props.layout==St.A.IRC)&&(s=o.createElement(jh,{minWidth:20,maxWidth:600,roomId:null!==(a=null===(r=this.props.room)||void 0===r?void 0:r.roomId)&&void 0!==a?a:null}));const l=yt()(this.props.className,{mx_MessagePanel_narrow:this.context.narrow});return o.createElement($h.Z,null,o.createElement(Gh.Z,{ref:this.scrollPanel,className:l,onScroll:this.props.onScroll,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:i,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:s},e,this.getEventTiles(),n,t))}}(0,k.Z)(vp,"contextType",qt.ZP),(0,k.Z)(vp,"defaultProps",{disableGrouping:!1});const _p=[pp,lp];var fp=i("../matrix-react-sdk/node_modules/raw-loader/dist/cjs.js!../matrix-react-sdk/src/utils/exportUtils/exportCustomCSS.css");const Ep=/\.[\w-]+/g;function yp(e){return e.replace(/font-family: ?(Inter|'Inter'|"Inter")/g,"font-family: -apple-system, BlinkMacSystemFont, avenir next,\n            avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif").replace(/font-family: ?Inconsolata/g,"font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace")}function bp(e){var t;return"light"===(null===(t=e.ownerNode.dataset.mxTheme)||void 0===t?void 0:t.toLowerCase())}const wp=async e=>{const t=Array.from(document.styleSheets).filter((e=>{var t;return(null===(t=e.href)||void 0===t?void 0:t.endsWith("bundle.css"))||bp(e)}));if(!t.some(bp)){var i;const e=null===(i=document.querySelector('link[rel="stylesheet"][href$="theme-light.css"]'))||void 0===i?void 0:i.href;e&&t.push(await async function(e){const t=document.implementation.createHTMLDocument(""),i=document.createElement("style"),n=await fetch(e);return i.textContent=await n.text(),t.body.appendChild(i),i.sheet}(e))}let n="";for(const i of t)for(const t of i.cssRules){if(t instanceof CSSFontFaceRule)continue;const i=t.selectorText;null!=i&&i.split(",").every((t=>{const i=t.match(Ep);if(i&&!i.every((t=>e.has(t.substring(1)))))return!0}))||(n+=yp(t.cssText)+"\n")}return n+fp.Z};var Sp=i("../matrix-react-sdk/node_modules/buffer/index.js").lW;class Cp extends Bh{constructor(e,t,i,n){super(e,t,i,n),(0,k.Z)(this,"avatars",void 0),(0,k.Z)(this,"permalinkCreator",void 0),(0,k.Z)(this,"totalSize",void 0),(0,k.Z)(this,"mediaOmitText",void 0),this.avatars=new Map,this.permalinkCreator=new Rt.w6(this.room),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,l._t)("export_chat|media_omitted_file_size"):(0,l._t)("export_chat|media_omitted")}async getRoomAvatar(){let e;const t=Ct.Eh(this.room,32,32,"crop"),i="room.png";if(t)try{const n=await fetch(t);e=await n.blob(),this.totalSize+=e.size,this.addFile(i,e)}catch(e){r.k.log("Failed to fetch room's avatar"+e)}const n=o.createElement(ys.Z,{size:"32px",name:this.room.name,title:this.room.name,url:e?i:""});return(0,Dh.renderToStaticMarkup)(n)}async wrapHTML(e,t,i){var s,a,r,c,d;const m=await this.getRoomAvatar(),h=(0,Oe.fg)(new Date),p=null===(s=this.room.currentState.getStateEvents(n.EventType.RoomCreate,""))||void 0===s?void 0:s.getSender(),u=(p?null===(a=this.room.getMember(p))||void 0===a?void 0:a.rawDisplayName:p)||p,g=this.room.client.getSafeUserId(),v=null===(r=this.room.getMember(g))||void 0===r?void 0:r.rawDisplayName,_=(null===(c=this.room.currentState.getStateEvents(n.EventType.RoomTopic,""))||void 0===c||null===(d=c.getContent())||void 0===d?void 0:d.topic)||"",f=Oh()((0,l._t)("export_chat|creator_summary",{creatorName:u})),E=Oh()(g),y=Oh()(this.room.name),b=Oh()(_),w=(0,Dh.renderToStaticMarkup)(o.createElement("p",null,(0,l._t)("export_chat|export_info",{exportDate:h},{roomName:()=>o.createElement("b",null,y),exporterDetails:()=>o.createElement("a",{href:`https://matrix.to/#/${encodeURIComponent(g)}`,target:"_blank",rel:"noopener noreferrer"},v?o.createElement(o.Fragment,null,o.createElement("b",null,Oh()(v)),"I "," ("+E+")"):o.createElement("b",null,E))}))),S=_?(0,l._t)("export_chat|topic",{topic:b}):"",C=(0,Dh.renderToStaticMarkup)(0!==t?o.createElement("div",{style:{textAlign:"center"}},o.createElement("a",{href:`./messages${1===t?"":t}.html`,style:{fontWeight:"bold"}},(0,l._t)("export_chat|previous_page"))):o.createElement(o.Fragment,null)),k=(0,Dh.renderToStaticMarkup)(t<i-1?o.createElement("div",{style:{textAlign:"center",margin:"10px"}},o.createElement("a",{href:"./messages"+(t+2)+".html",style:{fontWeight:"bold"}},(0,l._t)("export_chat|next_page"))):o.createElement(o.Fragment,null));return`\n          <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8" />\n                <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n                <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n                <link href="css/style.css" rel="stylesheet" />\n                <script src="js/script.js"><\/script>\n                <title>${(0,l._t)("export_chat|html_title")}</title>\n            </head>\n            <body style="height: 100vh;">\n                <section\n                id="matrixchat"\n                style="height: 100%; overflow: auto"\n                class="notranslate"\n                >\n                <div class="mx_MatrixChat_wrapper" aria-hidden="false">\n                    <div class="mx_MatrixChat">\n                    <main class="mx_RoomView">\n                        <div class="mx_LegacyRoomHeader light-panel">\n                        <div class="mx_LegacyRoomHeader_wrapper" aria-owns="mx_RightPanel">\n                            <div class="mx_LegacyRoomHeader_avatar">\n                            <div class="mx_DecoratedRoomAvatar">\n                               ${m}\n                            </div>\n                            </div>\n                            <div class="mx_LegacyRoomHeader_name">\n                            <div\n                                dir="auto"\n                                class="mx_LegacyRoomHeader_nametext"\n                                title="${y}"\n                            >\n                                ${y}\n                            </div>\n                            </div>\n                            <div class="mx_LegacyRoomHeader_topic" dir="auto"> ${b} </div>\n                        </div>\n                        </div>\n                        ${C}\n                        <div class="mx_MainSplit">\n                        <div class="mx_RoomView_body">\n                            <div\n                            class="mx_RoomView_timeline mx_RoomView_timeline_rr_enabled"\n                            >\n                            <div\n                                class="\n                                mx_AutoHideScrollbar\n                                mx_ScrollPanel\n                                mx_RoomView_messagePanel\n                                "\n                            >\n                                <div class="mx_RoomView_messageListWrapper">\n                                <ol\n                                    class="mx_RoomView_MessageList"\n                                    aria-live="polite"\n                                    role="list"\n                                >\n                                ${0==t?`<div class="mx_NewRoomIntro">\n                                        ${m}\n                                        <h2> ${y} </h2>\n                                        <p> ${f} <br/><br/> ${w} </p>\n                                        <br/>\n                                        <p> ${S} </p>\n                                    </div>`:""}\n                                ${e}\n                                </ol>\n                                </div>\n                            </div>\n                            </div>\n                            <div class="mx_RoomView_statusArea">\n                            <div class="mx_RoomView_statusAreaBox">\n                                <div class="mx_RoomView_statusAreaBox_line"></div>\n                            </div>\n                            </div>\n                        </div>\n                        </div>\n                        ${k}\n                    </main>\n                    </div>\n                </div>\n                </section>\n                <div id="snackbar"/>\n            </body>\n        </html>`}getAvatarURL(e){const t=e.sender,i=null==t?void 0:t.getMxcAvatarUrl();return i?(0,mn.TS)(i).getThumbnailOfSourceHttp(30,30,"crop"):null}async saveAvatarIfNeeded(e){const t=e.sender;if(!this.avatars.has(t.userId))try{const i=this.getAvatarURL(e);this.avatars.set(t.userId,!0);const n=await fetch(i),s=await n.blob();this.addFile(`users/${t.userId.replace(/:/g,"-")}.png`,s)}catch(e){r.k.log("Failed to fetch user's avatar"+e)}}getDateSeparator(e){const t=e.getTs(),i=o.createElement("li",{key:t},o.createElement(Kh.Z,{forExport:!0,key:t,roomId:e.getRoomId(),ts:t}));return(0,Dh.renderToStaticMarkup)(i)}needsDateSeparator(e,t){return!t||(0,Oe.JC)(t.getDate()||void 0,e.getDate()||void 0)}getEventTile(e,t){return o.createElement("div",{className:"mx_Export_EventWrapper",id:e.getId()},o.createElement(pn.ZP.Provider,{value:this.room.client},o.createElement(rs,{mxEvent:e,continuation:t,isRedacted:e.isRedacted(),replacingEventId:e.replacingEventId(),forExport:!0,alwaysShowTimestamps:!0,showUrlPreview:!1,checkUnmounting:()=>!1,isTwelveHour:!1,last:!1,lastInSection:!1,permalinkCreator:this.permalinkCreator,lastSuccessful:!1,isSelectedEvent:!1,showReactions:!1,layout:St.A.Group,showReadReceipts:!1})))}async getEventTileMarkup(e,t,i){const s=this.getAvatarURL(e),o=!!s;o&&await this.saveAvatarIfNeeded(e);const a=this.getEventTile(e,t);let r;if(e.getContent().msgtype==n.MsgType.Emote||e.getContent().msgtype==n.MsgType.Notice||e.getContent().msgtype===n.MsgType.Text){const e=document.createElement("div");Dn.render(a,e),r=e.innerHTML}else r=(0,Dh.renderToStaticMarkup)(a);if(i){var l,c;const t=null!==(l=e.getContent().url)&&void 0!==l?l:null===(c=e.getContent().file)||void 0===c?void 0:c.url;r=r.split(t).join(i)}return r=r.replace(/<span class="mx_MFileBody_info_icon".*?>.*?<\/span>/,""),o&&(r=r.replace(encodeURI(s).replace(/&/g,"&amp;"),`users/${e.sender.userId.replace(/:/g,"-")}.png`)),r}createModifiedEvent(e,t,i=!0){const s={msgtype:n.MsgType.Text,body:`${e}`,format:"org.matrix.custom.html",formatted_body:`${e}`};i&&(s.formatted_body="<em>"+s.formatted_body+"</em>",s.body="*"+s.body+"*");const o=new n.MatrixEvent;return o.event=t.event,o.sender=t.sender,o.event.type="m.room.message",o.event.content=s,o}async createMessageBody(e,t=!1){let i;try{if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const n=await this.getMediaBlob(e);if(this.totalSize+n.size>this.exportOptions.maxSize)i=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else{this.totalSize+=n.size;const s=this.getFilePath(e);i=await this.getEventTileMarkup(e,t,s),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(s,n)}}catch(n){r.k.log("Error while fetching file"+n),i=await this.getEventTileMarkup(this.createModifiedEvent((0,l._t)("export_chat|error_fetching_file"),e),t)}else i=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else i=await this.getEventTileMarkup(e,t)}catch(n){r.k.error(n),i=await this.getEventTileMarkup(this.createModifiedEvent((0,Qh.MW)(e,this.room.client),e,!1),t)}return i}async createHTML(e,t,i,n){let s="",o=null;for(let i=t;i<Math.min(t+1e3,e.length);i++){const t=e[i];if(this.updateProgress((0,l._t)("export_chat|processing_event_n",{number:i+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,At.eD)(t,this.room.client,!1))continue;s+=this.needsDateSeparator(t,o)?this.getDateSeparator(t):"";const n=!this.needsDateSeparator(t,o)&&gp(o,t,this.room.client,!1),a=await this.createMessageBody(t,n);this.totalSize+=Sp.byteLength(a),s+=a,o=t}return this.wrapHTML(s,i,n)}async export(){this.updateProgress((0,l._t)("export_chat|starting_export"));const e=performance.now(),t=await this.getRequiredEvents(),i=performance.now();this.updateProgress((0,l._t)("export_chat|fetched_n_events_in_time",{count:t.length,seconds:(i-e)/1e3}),!0,!1),this.updateProgress((0,l._t)("export_chat|creating_html"));const n=new Set;for(let e=0;e<t.length/1e3;e++){const i=await this.createHTML(t,1e3*e,e,t.length/1e3);(new DOMParser).parseFromString(i,"text/html").querySelectorAll("*").forEach((e=>{e.classList.forEach((e=>n.add(e)))})),this.addFile(`messages${e?e+1:""}.html`,new Blob([i]))}const s=await wp(n);this.addFile("css/style.css",new Blob([s])),this.addFile("js/script.js",new Blob(['/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the "License");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\nhttp://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n// This file is raw-imported (imported as plain text) for the export bundle, which is why this is in JS\nfunction showToastIfNeeded(replyId) {\n    const el = document.getElementById(replyId);\n    if (!el) {\n        showToast("The message you\'re looking for wasn\'t exported");\n        return;\n    }\n}\n\nfunction showToast(text) {\n    const el = document.getElementById("snackbar");\n    el.innerHTML = text;\n    el.className = "mx_show";\n    window.setTimeout(() => {\n        el.className = el.className.replace("mx_show", "");\n    }, 2000);\n}\n\nwindow.onload = () => {\n    document.querySelectorAll(".mx_reply_anchor").forEach((element) => {\n        element.addEventListener("click", (event) => {\n            showToastIfNeeded(event.target.dataset.scrollTo);\n        });\n    });\n};\n'])),await this.downloadZIP();const o=performance.now();this.cancelled?r.k.info("Export cancelled successfully"):(this.updateProgress((0,l._t)("export_chat|export_successful")),this.updateProgress((0,l._t)("export_chat|exported_n_events_in_time",{count:t.length,seconds:(o-e)/1e3}))),this.cleanUp()}}class kp extends Bh{constructor(e,t,i,n){super(e,t,i,n),(0,k.Z)(this,"totalSize",0),(0,k.Z)(this,"messages",[])}get destinationFileName(){return this.makeFileNameNoExtension()+".json"}createJSONString(){var e,t,i,s,o,a,r;const l=(0,Oe.fg)(new Date),c=null===(e=this.room.currentState.getStateEvents(n.EventType.RoomCreate,""))||void 0===e?void 0:e.getSender(),d=c&&(null===(t=this.room)||void 0===t||null===(i=t.getMember(c))||void 0===i?void 0:i.rawDisplayName)||c,m=(null===(s=this.room.currentState.getStateEvents(n.EventType.RoomTopic,""))||void 0===s||null===(o=s.getContent())||void 0===o?void 0:o.topic)||"",h=this.room.client.getUserId(),p=(null===(a=this.room)||void 0===a||null===(r=a.getMember(h))||void 0===r?void 0:r.rawDisplayName)||h,u={room_name:this.room.name,room_creator:d,topic:m,export_date:l,exported_by:p,messages:this.messages};return JSON.stringify(u,null,2)}async getJSONString(e){if(this.exportOptions.attachmentsIncluded&&this.isAttachment(e))try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size<this.exportOptions.maxSize){this.totalSize+=t.size;const i=this.getFilePath(e);this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(i,t)}}catch(e){r.k.log("Error fetching file: "+e)}const t=e.toJSON();return e.isEncrypted()?t.decrypted:t}async createOutput(e){for(let t=0;t<e.length;t++){const i=e[t];if(this.updateProgress((0,l._t)("export_chat|processing_event_n",{number:t+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();(0,At.eD)(i,this.room.client,!1)&&this.messages.push(await this.getJSONString(i))}return this.createJSONString()}async export(){r.k.info("Starting export process..."),r.k.info("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),i=performance.now();r.k.log(`Fetched ${t.length} events in ${(i-e)/1e3}s`),r.k.info("Creating output...");const n=await this.createOutput(t);if(this.files.length)this.addFile("export.json",new Blob([n])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,n)}const s=performance.now();this.cancelled?r.k.info("Export cancelled successfully"):(r.k.info("Export successful!"),r.k.log(`Exported ${t.length} events in ${(s-e)/1e3} seconds`)),this.cleanUp()}}class xp extends Bh{constructor(e,t,i,n){super(e,t,i,n),(0,k.Z)(this,"totalSize",void 0),(0,k.Z)(this,"mediaOmitText",void 0),(0,k.Z)(this,"textForReplyEvent",(e=>{const t=/> <(.*?)>(.*?)\n\n(.*)/s.exec(e.body);if(!t)return e.body;let i;const n=t[1],s=t[3];i=t[2].substring(1);const o=i.split("\n").filter((e=>!/^\s*$/.test(e)));return o.length>0?(i=o[0].substring(0,32),o[0].length>32&&(i+="..."),i=` "${i}"`):i="",`<${n}${i}> ${s}`})),(0,k.Z)(this,"plainTextForEvent",(async e=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let i="";if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size>this.exportOptions.maxSize)i=` (${this.mediaOmitText})`;else{this.totalSize+=t.size;const n=this.getFilePath(e);i=" ("+(0,l._t)("export_chat|file_attached")+")",this.addFile(n,t),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1)}}catch(e){i=" ("+(0,l._t)("export_chat|error_fetching_file")+")",r.k.log("Error fetching file "+e)}else i=` (${this.mediaOmitText})`;return this.isReply(e)?t+": "+this.textForReplyEvent(e.getContent())+i:(0,Qh.MW)(e,this.room.client)+i})),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,l._t)("export_chat|media_omitted_file_size"):(0,l._t)("export_chat|media_omitted")}get destinationFileName(){return this.makeFileNameNoExtension()+".txt"}async createOutput(e){let t="";for(let i=0;i<e.length;i++){const n=e[i];if(this.updateProgress((0,l._t)("export_chat|processing_event_n",{number:i+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,At.eD)(n,this.room.client,!1))continue;const s=await this.plainTextForEvent(n);t+=s&&`${(0,Oe.Tu)(new Date(n.getTs()),L.C.getValue("showTwelveHourTimestamps"))} - ${s}\n`}return t}async export(){this.updateProgress((0,l._t)("export_chat|starting_export")),this.updateProgress((0,l._t)("export_chat|fetching_events"));const e=performance.now(),t=await this.getRequiredEvents(),i=performance.now();r.k.log(`Fetched ${t.length} events in ${(i-e)/1e3}s`),this.updateProgress((0,l._t)("export_chat|creating_output"));const n=await this.createOutput(t);if(this.files.length)this.addFile("export.txt",new Blob([n])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,n)}const s=performance.now();this.cancelled?r.k.info("Export cancelled successfully"):(r.k.info("Export successful!"),r.k.log(`Exported ${t.length} events in ${(s-e)/1e3} seconds`)),this.cleanUp()}}const Rp=()=>({}),Ip=(e,t)=>i=>"number"==typeof i&&!(isNaN(i)||e>i||i>t),Pp=({room:e,onFinished:t})=>{const{exportFormat:i,exportType:n,includeAttachments:s,numberOfMessages:a,sizeLimit:c,setExportFormat:d,setExportType:m,setNumberOfMessages:h,setSizeLimit:p,setAttachments:u}=(()=>{var e,t,i,n,s;const a=Rp(),[r,l]=(0,o.useState)(null!==(e=a.format)&&void 0!==e?e:Ph.Html),[c,d]=(0,o.useState)(null!==(t=a.range)&&void 0!==t?t:Th.Timeline),[m,h]=(0,o.useState)(null!==(i=a.includeAttachments)&&void 0!==i&&i),[p,u]=(0,o.useState)(null!==(n=a.numberOfMessages)&&void 0!==n?n:100),[g,v]=(0,o.useState)(null!==(s=a.sizeMb)&&void 0!==s?s:8);return{exportFormat:r,exportType:c,includeAttachments:m,numberOfMessages:p,sizeLimit:g,setExportFormat:a.format?void 0:l,setExportType:a.range?void 0:d,setNumberOfMessages:a.numberOfMessages?void 0:u,setSizeLimit:a.sizeMb?void 0:v,setAttachments:void 0===a.includeAttachments?h:void 0}})(),[g,v]=(0,o.useState)(!1),_=(0,o.useRef)(null),f=(0,o.useRef)(null),[E,y]=(0,o.useState)((0,l._t)("export_chat|processing")),[b,w]=(0,o.useState)(!1),[S,C]=(0,o.useState)(!1),[k,x]=(0,o.useState)(!1),[R,I]=((e,t)=>{const[i,n]=(0,o.useState)(e);return[i,e=>{n(e),t(e)}]})(null,(async e=>{await(null==e?void 0:e.export().then((()=>{S||x(!0)})))})),P=async()=>{var t;if(!p||await(null===(t=_.current)||void 0===t?void 0:t.validate({focused:!1}))){if(n===Th.LastNMessages){var o;var l;if(!await(null===(o=f.current)||void 0===o?void 0:o.validate({focused:!1})))return void(null===(l=f.current)||void 0===l||l.validate({focused:!0}))}v(!0),await(async()=>{const t={numberOfMessages:a,attachmentsIncluded:s,maxSize:1024*c*1024};switch(i){case Ph.Html:I(new Cp(e,Th[n],t,y));break;case Ph.Json:I(new kp(e,Th[n],t,y));break;case Ph.PlainText:I(new xp(e,Th[n],t,y));break;default:return void r.k.error("Unknown export format")}})()}else{var d;null===(d=_.current)||void 0===d||d.validate({focused:!0})}},T=(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("export_chat|enter_number_between_min_max",{min:1,max:2e3})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return Ip(1,2e3)(t)},invalid:()=>(0,l._t)("export_chat|size_limit_min_max",{min:1,max:2e3})}]}),Z=async e=>await T(e),N=(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("export_chat|enter_number_between_min_max",{min:1,max:10**8})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return Ip(1,10**8)(t)},invalid:()=>(0,l._t)("export_chat|num_messages_min_max",{min:1,max:10**8})}]}),D=async e=>await N(e),M=async()=>{g?w(!0):t(!1)},O=async()=>{await(null==R?void 0:R.cancelExport()),C(!0),v(!1),I(null)},A=Object.values(Ph).map((e=>({value:e,label:Zh(e)}))),L=Object.values(Th).map((e=>o.createElement("option",{key:Th[e],value:e},(e=>{switch(e){case Th.Beginning:return(0,l._t)("export_chat|from_the_beginning");case Th.LastNMessages:return(0,l._t)("export_chat|number_of_messages");case Th.Timeline:return(0,l._t)("export_chat|current_timeline");default:throw new Error("Unknown type: "+e)}})(e))));let U;n===Th.LastNMessages&&h&&(U=o.createElement(Vs.Z,{id:"message-count",element:"input",type:"number",value:a.toString(),ref:f,onValidate:D,label:(0,l._t)("export_chat|num_messages"),onChange:e=>{h(parseInt(e.target.value))}}));const F=o.createElement("span",null,(0,l._t)("export_chat|size_limit_postfix"));return S?o.createElement(Sl.Z,{title:(0,l._t)("export_chat|cancelled"),description:(0,l._t)("export_chat|cancelled_detail"),hasCloseButton:!0,onFinished:t}):k?o.createElement(Sl.Z,{title:(0,l._t)("export_chat|successful"),description:(0,l._t)("export_chat|successful_detail"),hasCloseButton:!0,onFinished:t}):b?o.createElement(q.Z,{title:(0,l._t)("common|warning"),className:"mx_ExportDialog",contentId:"mx_Dialog_content",onFinished:t,fixedWidth:!0},o.createElement("p",null,(0,l._t)("export_chat|confirm_stop")),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|stop"),primaryButtonClass:"danger",hasCancel:!0,cancelButton:(0,l._t)("action|continue"),onCancel:()=>w(!1),onPrimaryButtonClick:O})):o.createElement(q.Z,{title:g?(0,l._t)("export_chat|exporting_your_data"):(0,l._t)("export_chat|title"),className:`mx_ExportDialog ${g&&"mx_ExportDialog_Exporting"}`,contentId:"mx_Dialog_content",hasCancel:!0,onFinished:t,fixedWidth:!0},g?null:o.createElement("p",null,(0,l._t)("export_chat|select_option")),o.createElement("div",{className:"mx_ExportDialog_options"},!!d&&o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_ExportDialog_subheading"},(0,l._t)("export_chat|format")),o.createElement(sl.Z,{name:"exportFormat",value:i,onChange:e=>d(Ph[e]),definitions:A})),!!m&&o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_ExportDialog_subheading"},(0,l._t)("export_chat|messages")),o.createElement(Vs.Z,{id:"export-type",element:"select",value:n,onChange:e=>{m(Th[e.target.value])}},L),U),p&&o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_ExportDialog_subheading"},(0,l._t)("export_chat|size_limit")),o.createElement(Vs.Z,{id:"size-limit",type:"number",autoComplete:"off",onValidate:Z,element:"input",ref:_,value:c.toString(),postfixComponent:F,onChange:e=>p(parseInt(e.target.value))})),u&&o.createElement(o.Fragment,null,o.createElement(qs.Z,{className:"mx_ExportDialog_attachments-checkbox",id:"include-attachments",checked:s,onChange:e=>u(e.target.checked)},(0,l._t)("export_chat|include_attachments")))),g?o.createElement("div",{"data-testid":"export-progress",className:"mx_ExportDialog_progress"},o.createElement(re.Z,{w:24,h:24}),o.createElement("p",null,E),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|cancel"),primaryButtonClass:"danger",hasCancel:!1,onPrimaryButtonClick:M})):o.createElement(gt.Z,{primaryButton:(0,l._t)("action|export"),onPrimaryButtonClick:P,onCancel:()=>t(!1)}))};var Tp=i("../matrix-react-sdk/src/components/views/polls/pollHistory/PollHistory.tsx");const Zp=({room:e,matrixClient:t,permalinkCreator:i,onFinished:n})=>o.createElement(q.Z,{onFinished:n},o.createElement(Tp.W,{room:e,matrixClient:t,permalinkCreator:i,onFinished:n})),Np=["as","display","direction","align","justify","gap","className","children"];function Dp(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Mp(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Dp(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Dp(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Op(e){let{as:t="div",display:i="flex",direction:n="row",align:s="start",justify:a="start",gap:r="0",className:l,children:c}=e,d=(0,v.Z)(e,Np);const m=(0,o.useRef)();return(0,o.useEffect)((()=>{m.current.style.setProperty("--mx-flex-display",i),m.current.style.setProperty("--mx-flex-direction",n),m.current.style.setProperty("--mx-flex-align",s),m.current.style.setProperty("--mx-flex-justify",a),m.current.style.setProperty("--mx-flex-gap",r)}),[s,n,i,r,a]),o.createElement(t,Mp(Mp({},d),{},{className:yt()("mx_Flex",l),ref:m}),c)}var Ap=i("../matrix-react-sdk/src/actions/RoomListActions.ts");function Lp(e,t){if(t===nr.lL.Favourite||t===nr.lL.LowPriority){const i=t===nr.lL.Favourite?nr.lL.LowPriority:nr.lL.Favourite,n=ic.ZP.instance.getTagsForRoom(e).includes(t),s=n?t:i,o=n?null:t;x.ZP.dispatch(Ap.Z.tagRoom(e.client,e,s,o,0))}else r.k.warn(`Unexpected tag ${t} applied to ${e.roomId}`)}function Up(e){const t=e.client;return(!!e.canInvite(t.getSafeUserId())||!(!e.isSpaceRoom()||e.getJoinRule()!==n.JoinRule.Public))&&"join"===e.getMyMembership()&&(0,hr.I)(Ye.y.InviteUsers)}function Fp(e){e.client.isGuest()?x.ZP.dispatch({action:"require_registration"}):x.ZP.dispatch({action:"view_invite",roomId:e.roomId})}const Bp=(e,t)=>{const[i,s]=(0,o.useState)((()=>{return null==(i=e.getAccountData(t))?void 0:i.getContent();var i})),a=(0,o.useCallback)((e=>{e.getType()===t&&s(e.getContent())}),[t]);return(0,In.V4)(e,n.ClientEvent.AccountData,a),i||{}},Vp=e=>{const[t,i]=(0,o.useState)((()=>Cm.Z.instance.getApps(e.roomId))),n=(0,o.useCallback)((()=>{i([...Cm.Z.instance.getApps(e.roomId)])}),[e]);return(0,o.useEffect)(n,[e,n]),(0,In.x2)(Cm.Z.instance,e.roomId,n),(0,In.x2)(Nm.z3.instance,Nm.z3.emissionForRoom(e),n),t},jp=({app:e,room:t})=>{const i=Sm.Z.getWidgetName(e),n=Sm.Z.getWidgetDataTitle(e),s=n&&" - "+n,[a,r]=(0,o.useState)();(0,o.useEffect)((()=>{r(Sm.Z.canUserModifyWidgets(t.client,t.roomId))}),[t.client,t.roomId]);const c=Nm.z3.instance.isInContainer(t,e,Nm.W2.Top),d=c?()=>{Nm.z3.instance.moveToContainer(t,e,Nm.W2.Right)}:()=>{Nm.z3.instance.moveToContainer(t,e,Nm.W2.Top)},[m,h,p,u]=(0,ii.av)();let g;if(m){var v,_,f;const t=null===(v=h.current)||void 0===v?void 0:v.getBoundingClientRect(),i=null!==(_=null==t?void 0:t.right)&&void 0!==_?_:0,n=null!==(f=null==t?void 0:t.top)&&void 0!==f?f:0;g=o.createElement(_h,{chevronFace:ii.N7.None,right:mr.default.instance.windowWidth-i,bottom:mr.default.instance.windowHeight-n,onFinished:u,app:e})}const E=!c&&!Nm.z3.instance.canAddToContainer(t,Nm.W2.Top);let y;y=E?(0,l._t)("right_panel|pinned_messages|limits",{count:Nm.xN}):c?(0,l._t)("action|unpin"):(0,l._t)("action|pin");const b=Nm.z3.instance.isInContainer(t,e,Nm.W2.Center),w=b?()=>{Nm.z3.instance.moveToContainer(t,e,Nm.W2.Right)}:()=>{Nm.z3.instance.moveToContainer(t,e,Nm.W2.Center)},S=b?(0,l._t)("action|close"):(0,l._t)("action|maximise");let C="";c?C=(0,l._t)("widget|unpin_to_view_right_panel"):b&&(C=(0,l._t)("widget|close_to_view_right_panel"));const k=yt()("mx_BaseCard_Button mx_RoomSummaryCard_Button",{mx_RoomSummaryCard_Button_pinned:c,mx_RoomSummaryCard_Button_maximised:b});return o.createElement("div",{className:k,ref:h},o.createElement(gs.Z,{className:"mx_RoomSummaryCard_icon_app",onClick:()=>{nm.Z.instance.pushCard({phase:im.q.Widget,state:{widgetId:e.id}})},title:C,forceHide:!(c||b),disabled:c||b},o.createElement(xm,{app:e,size:"20px"}),o.createElement("span",null,i),s),a&&o.createElement(ii.JY,{className:"mx_RoomSummaryCard_app_options",isExpanded:m,onClick:p,title:(0,l._t)("common|options")}),o.createElement(gs.Z,{className:"mx_RoomSummaryCard_app_pinToggle",onClick:d,title:y,disabled:E}),o.createElement(gs.Z,{className:"mx_RoomSummaryCard_app_maximiseToggle",onClick:w,title:S}),g)},zp=({room:e})=>{const t=Vp(e),i=(0,o.useMemo)((()=>t.filter((e=>void 0!==e.eventId))),[t]);let n=null;return i.length>0&&Nm.z3.instance.canCopyLayoutToRoom(e)&&(n=o.createElement(ae.Z,{kind:"link",onClick:()=>Nm.z3.instance.copyLayoutToRoom(e)},(0,l._t)("widget|set_room_layout"))),o.createElement(bm.Z,{className:"mx_RoomSummaryCard_appsGroup",title:(0,l._t)("right_panel|widgets_section")},i.map((t=>o.createElement(jp,{key:t.id,app:t,room:e}))),n,o.createElement(ae.Z,{kind:"link",onClick:()=>{const t=B.B.sharedInstance();var i;t.hasManager()?null===(i=t.getPrimaryManager())||void 0===i||i.open(e):t.openNoManagerDialog()}},i.length>0?(0,l._t)("right_panel|edit_integrations"):(0,l._t)("right_panel|add_integrations")))},Wp=()=>{nm.Z.instance.pushCard({phase:im.q.FilePanel},!0)},Hp=()=>{nm.Z.instance.pushCard({phase:im.q.PinnedMessages},!0)},Gp=e=>{x.ZP.dispatch({action:"open_room_settings"}),kn.Z.trackInteraction("WebRightPanelRoomInfoSettingsButton",e)},Kp=({room:e,permalinkCreator:t,onClose:i,onSearchClick:s})=>{var a;const r=(0,o.useContext)(pn.ZP),c=(0,ym.H)(r,e),d=(0,o.useContext)(qt.ZP).e2eStatus,m=(0,wt.n)("feature_video_rooms"),h=(0,wt.n)("feature_element_call_video_rooms"),p=m&&(e.isElementVideoRoom()||h&&e.isCallRoom()),u=(0,go.c)(e),g=Bp(e.client,n.EventType.Direct),[v,_]=(0,o.useState)(!1);(0,o.useEffect)((()=>{for(const[,i]of Object.entries(g)){var t;if(i.includes(null!==(t=null==e?void 0:e.roomId)&&void 0!==t?t:"")){_(!0);break}}}),[e,g]);const f=e.getCanonicalAlias()||e.getAltAliases()[0]||"",E=o.createElement("header",{className:"mx_RoomSummaryCard_container"},o.createElement(ei.Z,{room:e,size:"80px",viewAvatarOnClick:!0}),o.createElement($s,{room:e},(e=>o.createElement(sm.X6,{as:"h1",size:"md",weight:"semibold",className:"mx_RoomSummaryCard_roomName text-primary",title:e},e))),o.createElement(sm.xv,{as:"div",size:"sm",weight:"semibold",className:"mx_RoomSummaryCard_alias text-secondary",title:f},f),o.createElement(Op,{as:"section",justify:"center",gap:"var(--cpd-space-2x)",className:"mx_RoomSummaryCard_badges"},!v&&u.getJoinRule()===n.JoinRule.Public&&o.createElement(sm.Ct,{kind:"default"},o.createElement(fm.J,{width:"1em"}),(0,l._t)("common|public_room")),c&&d!==Rm._.Warning&&o.createElement(sm.Ct,{kind:"success"},o.createElement(vm.J,{width:"1em"}),(0,l._t)("common|encrypted")),!d&&o.createElement(sm.Ct,{kind:"default"},o.createElement(_m.J,{width:"1em"}),(0,l._t)("common|unencrypted")),d===Rm._.Warning&&o.createElement(sm.Ct,{kind:"critical"},o.createElement(Em.J,{width:"1em"}),(0,l._t)("common|not_trusted")))),y=(0,wt.n)("feature_pinning"),b=null===(a=kh(y?e:void 0))||void 0===a?void 0:a.length,w=(0,In.kZ)(ic.ZP.instance,ic.N,(()=>ic.ZP.instance.getTagsForRoom(e))).includes(nr.lL.Favourite);return o.createElement(bm.C,{header:null,className:"mx_RoomSummaryCard",onClose:i},o.createElement(Op,{as:"header",className:"mx_RoomSummaryCard_header",gap:"var(--cpd-space-3x)",align:"center",justify:"space-between"},o.createElement(sm.u,{label:(0,l._t)("action|search"),side:"right"},o.createElement("button",{className:"mx_RoomSummaryCard_searchBtn","data-testid":"summary-search",onClick:()=>{null==s||s()},"aria-label":(0,l._t)("action|search")},o.createElement(om.J,{width:"100%",height:"100%"}))),o.createElement(ae.Z,{"data-testid":"base-card-close-button",className:"mx_BaseCard_close",onClick:i,title:(0,l._t)("action|close")})),E,o.createElement(sm.Z0,null),o.createElement(sm.JI,{Icon:am.J,label:(0,l._t)("room|context_menu|favourite"),checked:w,onChange:()=>Lp(e,nr.lL.Favourite)}),o.createElement(sm.sN,{Icon:rm.J,label:(0,l._t)("action|invite"),disabled:!Up(e),onClick:()=>Fp(e)}),o.createElement(sm.sN,{Icon:cm.J,label:(0,l._t)("action|copy_link"),onClick:()=>{T.ZP.createDialog(wm.Z,{target:e})}}),o.createElement(sm.sN,{Icon:dm.J,label:(0,l._t)("common|settings"),onClick:Gp}),o.createElement(sm.Z0,null),o.createElement(sm.sN,{Icon:lm.J,label:(0,l._t)("common|people"),onClick:e=>{nm.Z.instance.pushCard({phase:im.q.RoomMemberList},!0),kn.Z.trackInteraction("WebRightPanelRoomInfoPeopleButton",e)}}),!p&&o.createElement(o.Fragment,null,o.createElement(sm.sN,{Icon:pm.J,label:(0,l._t)("right_panel|files_button"),onClick:Wp}),o.createElement(sm.sN,{Icon:um.J,label:(0,l._t)("right_panel|polls_button"),onClick:()=>{T.ZP.createDialog(Zp,{room:e,matrixClient:r,permalinkCreator:t})}}),y&&o.createElement(sm.sN,{Icon:gm.J,label:(0,l._t)("right_panel|pinned_messages_button"),onClick:Hp},o.createElement(sm.xv,{as:"span",size:"sm"},b)),o.createElement(sm.sN,{Icon:mm.J,label:(0,l._t)("export_chat|title"),onClick:async()=>{T.ZP.createDialog(Pp,{room:e})}})),o.createElement(sm.Z0,null),o.createElement(sm.sN,{Icon:hm.J,kind:"critical",label:(0,l._t)("action|leave_room"),onClick:()=>{x.ZP.dispatch({action:"leave_room",room_id:e.roomId})}}),L.C.getValue(Ye.H.Widgets)&&!p&&(0,hr.I)(Ye.y.AddIntegrations)&&o.createElement(zp,{room:e}))};var qp,$p=i("../matrix-react-sdk/src/utils/UrlUtils.ts");function Jp(){return Jp=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Jp.apply(this,arguments)}function Yp(e,t){return o.createElement("svg",Jp({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 14 14",role:"presentation","aria-hidden":!0,ref:t},e),qp||(qp=o.createElement("g",{fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",transform:"translate(1 1)"},o.createElement("circle",{cx:6,cy:6,r:6}),o.createElement("path",{d:"M4.254 4.2a1.8 1.8 0 013.498.6c0 1.2-1.8 1.8-1.8 1.8M6 8.991"}))))}var Qp=o.forwardRef(Yp);function Xp(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class eu extends o.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),i=E.p.safeGet().getRoom(this.props.roomId);let n=null;i&&(n=i.getMember(this.props.creatorUserId)),this.state=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Xp(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Xp(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({roomMember:n},t)}parseWidgetUrl(){const e=(0,$p.en)(this.props.url);if(Sm.Z.isScalarUrl(this.props.url)&&e.searchParams.has("url")){const t=(0,$p.en)(e.searchParams.get("url"));return{widgetDomain:t.host||t.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=c.ZP.get().brand,t=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,i=t===this.props.creatorUserId?null:this.props.creatorUserId,n=this.state.roomMember?o.createElement(Vt.Z,{member:this.state.roomMember,size:"38px"}):o.createElement(ys.Z,{name:this.props.creatorUserId,size:"38px"}),s=o.createElement("div",null,(0,l._t)("analytics|shared_data_heading"),o.createElement("ul",null,o.createElement("li",null,(0,l._t)("widget|shared_data_name")),o.createElement("li",null,(0,l._t)("widget|shared_data_avatar")),o.createElement("li",null,(0,l._t)("widget|shared_data_mxid")),o.createElement("li",null,(0,l._t)("widget|shared_data_device_id")),o.createElement("li",null,(0,l._t)("widget|shared_data_theme")),o.createElement("li",null,(0,l._t)("widget|shared_data_lang")),o.createElement("li",null,(0,l._t)("widget|shared_data_url",{brand:e})),o.createElement("li",null,(0,l._t)("widget|shared_data_room_id")),o.createElement("li",null,(0,l._t)("widget|shared_data_widget_id")))),a=o.createElement(Bm.Z,{tooltip:s,tooltipClass:"mx_Tooltip--appPermission mx_Tooltip--appPermission--dark",class:"mx_TextWithTooltip_target--helpIcon"},o.createElement(Qp,{className:"mx_Icon mx_Icon_12"})),r=this.state.isWrapped?(0,l._t)("widget|shared_data_warning_im",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>a}):(0,l._t)("widget|shared_data_warning",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>a}),d=this.props.isRoomEncrypted?(0,l._t)("widget|unencrypted_warning"):null;return o.createElement("div",{className:"mx_AppPermission"},o.createElement("div",{className:"mx_AppPermission_content"},o.createElement("div",{className:"mx_AppPermission_content_bolder"},(0,l._t)("widget|added_by")),o.createElement("div",null,n,o.createElement(ac.Z,{size:"4"},t),o.createElement("div",null,i)),o.createElement("div",null,r),o.createElement("div",null,(0,l._t)("widget|cookie_warning"),"Â ",d),o.createElement("div",null,o.createElement(ae.Z,{kind:"primary_sm",onClick:this.props.onPermissionGranted},(0,l._t)("action|continue")))))}}(0,k.Z)(eu,"defaultProps",{onPermissionGranted:()=>{}});const tu=e=>o.createElement("div",{className:"mx_AppWarning"},o.createElement("div",null,o.createElement("img",{src:i("../matrix-react-sdk/res/img/warning.svg").Z,alt:""})),o.createElement("div",null,o.createElement("span",null,e.errorMsg||"Error")));function iu(e){return document.getElementById(e)}class nu extends o.Component{constructor(e){super(e),(0,k.Z)(this,"resizeObserver",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"childContainer",void 0),(0,k.Z)(this,"child",void 0),(0,k.Z)(this,"collectChildContainer",(e=>{this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)})),(0,k.Z)(this,"collectChild",(e=>{this.child=e,this.updateChild()})),(0,k.Z)(this,"onAction",(e=>{"timeline_resize"===e.action?this.repositionChild():"logout"===e.action&&nu.destroyElement(this.props.persistKey)})),(0,k.Z)(this,"repositionChild",(()=>{this.updateChildPosition(this.child,this.childContainer)})),this.resizeObserver=new ResizeObserver(this.repositionChild),window.addEventListener("resize",this.repositionChild),this.dispatcherRef=x.ZP.register(this.onAction),this.props.moveRef&&(this.props.moveRef.current=this.repositionChild)}static destroyElement(e){const t=iu("mx_persistedElement_"+e);t&&t.remove()}static isMounted(e){return Boolean(iu("mx_persistedElement_"+e))}componentDidMount(){this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this.repositionChild),x.ZP.unregister(this.dispatcherRef)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=o.createElement(pn.ZP.Provider,{value:E.p.safeGet()},o.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children));Dn.render(e,function(e){let t=iu(e);return t||(t=document.createElement("div"),t.id=e,document.body.appendChild(t)),t}("mx_persistedElement_"+this.props.persistKey))}updateChildVisibility(e,t=!1){e&&(e.style.display=t?"block":"none")}updateChildPosition(e,t){if(!e||!t)return;const i=t.getBoundingClientRect();Object.assign(e.style,{zIndex:(0,xa.le)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:"0",left:"0",transform:`translateX(${i.left}px) translateY(${i.top}px)`,width:i.width+"px",height:i.height+"px"})}render(){return o.createElement("div",{ref:this.collectChildContainer})}}var su;function ou(){return ou=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},ou.apply(this,arguments)}function au(e,t){return o.createElement("svg",ou({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 14 14",role:"presentation","aria-hidden":!0,ref:t},e),su||(su=o.createElement("path",{d:"M13.786 1.25l-3.351 3.351 1.16 1.161c.46.46.132 1.248-.518 1.248H7.733a.732.732 0 01-.73-.73V2.922c0-.65.789-.978 1.249-.518l1.16 1.16 3.351-3.35a.727.727 0 011.03 0 .743.743 0 01-.007 1.036zM1.25 13.786l3.351-3.351 1.161 1.16c.46.46 1.248.132 1.248-.518V7.733a.732.732 0 00-.73-.73H2.922c-.65 0-.978.789-.518 1.249l1.16 1.16-3.35 3.351a.727.727 0 000 1.03.743.743 0 001.036-.007z",fill:"currentColor"})))}var ru=o.forwardRef(au);var lu;function cu(){return cu=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},cu.apply(this,arguments)}function du(e,t){return o.createElement("svg",cu({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 14 14",role:"presentation","aria-hidden":!0,ref:t},e),lu||(lu=o.createElement("path",{d:"M14 4.348V.778A.78.78 0 0013.222 0h-3.57C8.96 0 8.61.84 9.1 1.33l1.237 1.237-7.778 7.777-1.237-1.236C.84 8.618 0 8.96 0 9.652v3.57c0 .428.35.778.778.778h3.57c.692 0 1.042-.84.552-1.33l-1.237-1.237 7.778-7.777 1.237 1.236c.482.49 1.322.148 1.322-.544z",fill:"currentColor"})))}var mu=o.forwardRef(du);var hu,pu=i("../matrix-react-sdk/res/img/element-icons/minus-button.svg");function uu(){return uu=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},uu.apply(this,arguments)}function gu(e,t){return o.createElement("svg",uu({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 11 11",role:"presentation","aria-hidden":!0,ref:t},e),hu||(hu=o.createElement("path",{d:"M8.5 6v3a1 1 0 01-1 1H2a1 1 0 01-1-1V3.5a1 1 0 011-1h3M7 1h3v3M4.5 6.5L10 1",fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})))}var vu=o.forwardRef(gu);function _u(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function fu(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?_u(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):_u(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Eu extends o.Component{constructor(e,t){super(e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"contextMenuButton",(0,o.createRef)()),(0,k.Z)(this,"iframe",void 0),(0,k.Z)(this,"allowedWidgetsWatchRef",void 0),(0,k.Z)(this,"persistKey",void 0),(0,k.Z)(this,"sgWidget",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"watchUserReady",(()=>{Ml.p.instance.isProfileInfoFetched||Ml.p.instance.once(Pa.a,this.onUserReady)})),(0,k.Z)(this,"onUserReady",(()=>{this.setState({isUserProfileReady:!0})})),(0,k.Z)(this,"hasPermissionToLoad",(e=>{var t;if(this.usingLocalWidget())return!0;if(!e.room)return!0;const i={approved:void 0};if(Am.E.instance.invoke(Pm.H.PreLoadRequest,i,new rh(this.props.app)),i.approved)return!0;const n=L.C.getValue("allowedWidgets",e.room.roomId);return(0,Cm.D)(e.app)&&void 0!==e.app.eventId&&null!==(t=n[e.app.eventId])&&void 0!==t&&t||e.userId===e.creatorUserId})),(0,k.Z)(this,"onMyMembership",((e,t)=>{var i;"leave"!==t&&"ban"!==t||e.roomId!==(null===(i=this.props.room)||void 0===i?void 0:i.roomId)||this.onUserLeftRoom()})),(0,k.Z)(this,"onAllowedWidgetsChange",(()=>{const e=this.hasPermissionToLoad(this.props);var t;this.state.hasPermissionToLoad&&!e&&(Z.Z.instance.destroyPersistentWidget(this.props.app.id,(0,Cm.D)(this.props.app)?this.props.app.roomId:null),nu.destroyElement(this.persistKey),null===(t=this.sgWidget)||void 0===t||t.stopMessaging());this.setState({hasPermissionToLoad:e})})),(0,k.Z)(this,"iframeRefChange",(e=>{this.iframe=e,this.unmounted||(e?this.startMessaging():this.resetWidget(this.props))})),(0,k.Z)(this,"onWidgetPreparing",(()=>{this.setState({loading:!1})})),(0,k.Z)(this,"updateRequiresClient",(()=>{var e,t;this.setState({requiresClient:!(null===(e=this.sgWidget)||void 0===e||null===(t=e.widgetApi)||void 0===t||!t.hasCapability(Fm.RequiresClient))})})),(0,k.Z)(this,"onAction",(e=>{var t,i,n;switch(e.action){case"m.sticker":e.widgetId===this.props.app.id&&null!==(t=this.sgWidget)&&void 0!==t&&null!==(i=t.widgetApi)&&void 0!==i&&i.hasCapability(Im.MatrixCapabilities.StickerSending)?(x.ZP.dispatch({action:"post_sticker_message",data:fu(fu({},e.data),{},{threadId:this.props.threadId})}),x.ZP.dispatch({action:"stickerpicker_close"})):r.k.warn("Ignoring sticker message. Invalid capability");break;case W.a.AfterLeaveRoom:e.room_id===(null===(n=this.props.room)||void 0===n?void 0:n.roomId)&&this.onUserLeftRoom()}})),(0,k.Z)(this,"grantWidgetPermission",(()=>{var e;const t=null===(e=this.props.room)||void 0===e?void 0:e.roomId,i=(0,Cm.D)(this.props.app)?this.props.app.eventId:void 0;r.k.info("Granting permission for widget to load: "+i);const n=L.C.getValue("allowedWidgets",t);void 0!==i&&(n[i]=!0);const s=L.C.firstSupportedLevel("allowedWidgets");L.C.setValue("allowedWidgets",null!=t?t:null,s,n).then((()=>{this.setState({hasPermissionToLoad:!0}),this.startWidget()})).catch((e=>{r.k.error(e)}))})),(0,k.Z)(this,"onPopoutWidgetClick",(()=>{var e;Zm.l.JITSI.matches(this.props.app.type)&&this.reload(),Object.assign(document.createElement("a"),{target:"_blank",href:null===(e=this.sgWidget)||void 0===e?void 0:e.popoutUrl,rel:"noreferrer noopener"}).click()})),(0,k.Z)(this,"onToggleMaximisedClick",(()=>{if(!this.props.room)return;const e=Nm.z3.instance.isInContainer(this.props.room,this.props.app,Nm.W2.Center)?Nm.W2.Top:Nm.W2.Center;Nm.z3.instance.moveToContainer(this.props.room,this.props.app,e)})),(0,k.Z)(this,"onMinimiseClicked",(()=>{this.props.room&&Nm.z3.instance.moveToContainer(this.props.room,this.props.app,Nm.W2.Right)})),(0,k.Z)(this,"onContextMenuClick",(()=>{this.setState({menuDisplayed:!0})})),(0,k.Z)(this,"closeContextMenu",(()=>{this.setState({menuDisplayed:!1})})),this.context=t,this.props.miniMode||Z.Z.instance.dockWidget(this.props.app.id,(0,Cm.D)(this.props.app)?this.props.app.roomId:null),this.persistKey="widget_"+Sm.Z.getWidgetUid(this.props.app);try{this.sgWidget=new lh(this.props),this.setupSgListeners()}catch(e){r.k.log("Failed to construct widget",e),this.sgWidget=null}this.state=this.getNewState(e)}onUserLeftRoom(){Z.Z.instance.getWidgetPersistence(this.props.app.id,(0,Cm.D)(this.props.app)?this.props.app.roomId:null)&&(this.props.room&&ie.m.instance.roomViewStore.getRoomId()!==this.props.room.roomId?this.endWidgetActions():Zm.l.JITSI.matches(this.props.app.type)?this.reload():Z.Z.instance.destroyPersistentWidget(this.props.app.id,(0,Cm.D)(this.props.app)?this.props.app.roomId:null))}determineInitialRequiresClientState(){try{var e;const t=new rh(this.props.app),i=Tm.c.instance.getMessaging(t,null===(e=this.props.room)||void 0===e?void 0:e.roomId);if(i)return i.hasCapability(Fm.RequiresClient)}catch{}return!0}getNewState(e){return{initialising:!0,loading:this.props.waitForIframeLoad&&!nu.isMounted(this.persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),isUserProfileReady:Ml.p.instance.isProfileInfoFetched,error:null,menuDisplayed:!1,requiresClient:this.determineInitialRequiresClientState(),hasContextMenuOptions:vh(this.context,this.props.room,e.app,e.userWidget,!e.userWidget,e.onDeleteClick)}}isMixedContent(){const e=window.location.protocol,t=(0,$p.en)(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(r.k.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.sgWidget&&this.state.hasPermissionToLoad&&this.startWidget(),this.watchUserReady(),this.props.room&&this.context.on(n.RoomEvent.MyMembership,this.onMyMembership),this.allowedWidgetsWatchRef=L.C.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange),this.dispatcherRef=x.ZP.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,this.props.miniMode||Z.Z.instance.undockWidget(this.props.app.id,(0,Cm.D)(this.props.app)?this.props.app.roomId:null),Z.Z.instance.isLive(this.props.app.id,(0,Cm.D)(this.props.app)?this.props.app.roomId:null)||this.endWidgetActions(),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef),this.props.room&&this.context.off(n.RoomEvent.MyMembership,this.onMyMembership),this.allowedWidgetsWatchRef&&L.C.unwatchSetting(this.allowedWidgetsWatchRef),Ml.p.instance.removeListener(Pa.a,this.onUserReady)}setupSgListeners(){var e,t,i;null===(e=this.sgWidget)||void 0===e||e.on("preparing",this.onWidgetPreparing),null===(t=this.sgWidget)||void 0===t||t.on("error:preparing",this.updateRequiresClient),null===(i=this.sgWidget)||void 0===i||i.on("capabilitiesNotified",this.updateRequiresClient)}stopSgListeners(){this.sgWidget&&(this.sgWidget.off("preparing",this.onWidgetPreparing),this.sgWidget.off("error:preparing",this.updateRequiresClient),this.sgWidget.off("capabilitiesNotified",this.updateRequiresClient))}resetWidget(e){var t;null===(t=this.sgWidget)||void 0===t||t.stopMessaging(),this.stopSgListeners();try{this.sgWidget=new lh(e),this.setupSgListeners(),this.startWidget()}catch(e){r.k.error("Failed to construct widget",e),this.sgWidget=null}}startWidget(){var e;null===(e=this.sgWidget)||void 0===e||e.prepare().then((()=>{this.unmounted||this.setState({initialising:!1})}))}startMessaging(){try{var e;null===(e=this.sgWidget)||void 0===e||e.startMessaging(this.iframe)}catch(e){r.k.error("Failed to start widget",e)}}componentDidUpdate(e){e.app.url!==this.props.app.url&&(this.getNewState(this.props),this.state.hasPermissionToLoad&&this.resetWidget(this.props))}async endWidgetActions(){var e;this.iframe&&(this.iframe.src="about:blank"),Zm.l.JITSI.matches(this.props.app.type)&&this.props.room&&lt.ZP.instance.hangupCallApp(this.props.room.roomId),nu.destroyElement(this.persistKey),Z.Z.instance.destroyPersistentWidget(this.props.app.id,(0,Cm.D)(this.props.app)?this.props.app.roomId:null),null===(e=this.sgWidget)||void 0===e||e.stopMessaging({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}usingLocalWidget(){return Zm.l.JITSI.matches(this.props.app.type)}getTileTitle(){const e=this.formatAppTileName(),t=o.createElement("span",null,"Â -Â ");let i="";return this.props.widgetPageTitle&&this.props.widgetPageTitle!==this.formatAppTileName()&&(i=this.props.widgetPageTitle),o.createElement("span",null,o.createElement(xm,{app:this.props.app,size:"20px"}),o.createElement("b",null,e),o.createElement("span",null,i?t:"",i))}reload(){this.endWidgetActions().then((()=>{this.resetWidget(this.props),this.startMessaging(),this.iframe&&this.sgWidget&&(this.iframe.src=this.sgWidget.embedUrl)}))}render(){let e;const t=yt()({mx_AppTileBody:!0,"mx_AppTileBody--large":!this.props.miniMode,"mx_AppTileBody--mini":this.props.miniMode,"mx_AppTileBody--loading":this.state.loading}),i={};this.props.pointerEvents&&(i.pointerEvents=this.props.pointerEvents);const n=o.createElement("div",{className:"mx_AppTileBody_fadeInSpinner"},o.createElement(re.Z,{message:(0,l._t)("common|loading")})),s=Sm.Z.getWidgetName(this.props.app);if(null===this.sgWidget)e=o.createElement("div",{className:t,style:i},o.createElement(tu,{errorMsg:(0,l._t)("widget|error_loading")}));else if(!this.state.hasPermissionToLoad&&this.props.room){const n=this.context.isRoomEncrypted(this.props.room.roomId);e=o.createElement("div",{className:t,style:i},o.createElement(eu,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.sgWidget.embedUrl,isRoomEncrypted:n,onPermissionGranted:this.grantWidgetPermission}))}else if(this.state.initialising||!this.state.isUserProfileReady)e=o.createElement("div",{className:t,style:i},n);else if(this.isMixedContent())e=o.createElement("div",{className:t,style:i},o.createElement(tu,{errorMsg:(0,l._t)("widget|error_mixed_content")}));else if(e=o.createElement("div",{className:t,style:i},this.state.loading&&n,o.createElement("iframe",{title:s,allow:"microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write; clipboard-read;",ref:this.iframeRefChange,src:this.sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation allow-downloads"})),!this.props.userWidget){const t=101;e=o.createElement("div",{className:"mx_AppTile_persistedWrapper"},o.createElement(nu,{zIndex:this.props.miniMode?t:9,persistKey:this.persistKey,moveRef:this.props.movePersistedElement},e))}let a,r;a=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},a=yt()(a),this.state.menuDisplayed&&(r=o.createElement(_h,(0,kt.Z)({},(0,ii.LS)(this.contextMenuButton.current.getBoundingClientRect()),{app:this.props.app,onFinished:this.closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick})));const c=[];if(this.props.showLayoutButtons){const e=this.props.room&&Nm.z3.instance.isInContainer(this.props.room,this.props.app,Nm.W2.Center);c.push(o.createElement(ae.Z,{key:"toggleMaximised",className:"mx_AppTileMenuBar_widgets_button",title:e?(0,l._t)("widget|unmaximise"):(0,l._t)("action|maximise"),onClick:this.onToggleMaximisedClick},e?o.createElement(ru,{className:"mx_Icon mx_Icon_12"}):o.createElement(mu,{className:"mx_Icon mx_Icon_12"}))),c.push(o.createElement(ae.Z,{key:"minimise",className:"mx_AppTileMenuBar_widgets_button",title:(0,l._t)("action|minimise"),onClick:this.onMinimiseClicked},o.createElement(pu.J,{className:"mx_Icon mx_Icon_12"})))}return o.createElement(o.Fragment,null,o.createElement("div",{className:a,id:this.props.app.id},this.props.showMenubar&&o.createElement("div",{className:"mx_AppTileMenuBar"},o.createElement("span",{className:"mx_AppTileMenuBar_title",style:{pointerEvents:this.props.handleMinimisePointerEvents?"all":"none"}},this.props.showTitle&&this.getTileTitle()),o.createElement("span",{className:"mx_AppTileMenuBar_widgets"},c,this.props.showPopout&&!this.state.requiresClient&&o.createElement(ae.Z,{className:"mx_AppTileMenuBar_widgets_button",title:(0,l._t)("widget|popout"),onClick:this.onPopoutWidgetClick},o.createElement(vu,{className:"mx_Icon mx_Icon_12 mx_Icon--stroke"})),this.state.hasContextMenuOptions&&o.createElement(ii.lX,{className:"mx_AppTileMenuBar_widgets_button",label:(0,l._t)("common|options"),isExpanded:this.state.menuDisplayed,inputRef:this.contextMenuButton,onClick:this.onContextMenuClick},o.createElement(yl,{className:"mx_Icon mx_Icon_12"})))),e),r)}}(0,k.Z)(Eu,"contextType",pn.ZP),(0,k.Z)(Eu,"defaultProps",{waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1,threadId:null,showLayoutButtons:!0});const yu=({room:e,widgetId:t,onClose:i})=>{const n=(0,o.useContext)(pn.ZP),s=Vp(e).find((e=>e.id===t)),a=s&&Nm.z3.instance.isInContainer(e,s,Nm.W2.Right),[r,c,d,m]=(0,ii.av)();if((0,o.useEffect)((()=>{s&&a||nm.Z.instance.popCard()}),[s,a]),!s||!a)return null;let h;if(r){var p;const e=null===(p=c.current)||void 0===p?void 0:p.getBoundingClientRect(),t=e?e.right:0,i=e?e.bottom:0;h=o.createElement(_h,{chevronFace:ii.N7.None,right:mr.default.instance.windowWidth-t-12,top:i+12,onFinished:m,app:s})}const u=o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(ac.Z,{size:"4",className:"mx_BaseCard_header_title_heading"},Sm.Z.getWidgetName(s)),o.createElement(ii.lX,{className:"mx_BaseCard_header_title_button--option",inputRef:c,onClick:d,isExpanded:r,label:(0,l._t)("common|options")}),h);return o.createElement(bm.C,{header:u,className:"mx_WidgetCard",onClose:i,withoutScrollContainer:!0},o.createElement(Eu,{app:s,fullWidth:!0,showMenubar:!1,room:e,userId:n.getSafeUserId(),creatorUserId:s.creatorUserId,widgetPageTitle:Sm.Z.getWidgetDataTitle(s),waitForIframeLoad:s.waitForIframeLoad}))};var bu=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/user-add-solid.svg");class wu extends o.Component{constructor(e){super(e),(0,k.Z)(this,"userLastModifiedTime",void 0),(0,k.Z)(this,"memberLastModifiedTime",void 0),(0,k.Z)(this,"onRoomStateEvents",(e=>{if(e.getType()!==n.EventType.RoomEncryption)return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;E.p.safeGet().removeListener(n.RoomStateEvent.Events,this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()})),(0,k.Z)(this,"onUserTrustStatusChanged",((e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()})),(0,k.Z)(this,"onDeviceVerificationChanged",((e,t,i)=>{e===this.props.member.userId&&this.updateE2EStatus()})),(0,k.Z)(this,"onClick",(()=>{x.ZP.dispatch({action:W.a.ViewUser,member:this.props.member,push:!0})})),this.state={isRoomEncrypted:!1}}componentDidMount(){const e=E.p.safeGet(),{roomId:t}=this.props.member;if(t){const i=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:i}),i?(e.on(j.qG.UserTrustStatusChanged,this.onUserTrustStatusChanged),e.on(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.updateE2EStatus()):e.on(n.RoomStateEvent.Events,this.onRoomStateEvents)}}componentWillUnmount(){const e=E.p.get();e&&(e.removeListener(n.RoomStateEvent.Events,this.onRoomStateEvents),e.removeListener(j.qG.UserTrustStatusChanged,this.onUserTrustStatusChanged),e.removeListener(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged))}async updateE2EStatus(){var e;const t=E.p.safeGet(),{userId:i}=this.props.member,n=i===t.getUserId(),s=await(null===(e=t.getCrypto())||void 0===e?void 0:e.getUserVerificationStatus(i));if(null==s||!s.isCrossSigningVerified())return void this.setState({e2eStatus:null!=s&&s.wasCrossSigningVerified()?Es.G.Warning:Es.G.Normal});const o=await(0,Qe.Z)(t,i),a=await(0,ne.De)(o,(async e=>{var s;const o=await(null===(s=t.getCrypto())||void 0===s?void 0:s.getDeviceVerificationStatus(i,e));return!o||(n?!o.crossSigningVerified:!o.isVerified())}));this.setState({e2eStatus:a?Es.G.Warning:Es.G.Verified})}shouldComponentUpdate(e,t){return void 0===this.memberLastModifiedTime||this.memberLastModifiedTime<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.userLastModifiedTime||this.userLastModifiedTime<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}getDisplayName(){return this.props.member.name}getPowerLabel(){return(0,l._t)("member_list|power_label",{userName:Pt.Z.getDisplayUserIdentifier(this.props.member.userId,{roomId:this.props.member.roomId}),powerLevelNumber:this.props.member.powerLevel}).trim()}render(){var e;const t=this.props.member,i=this.getDisplayName(),n=null===(e=t.user)||void 0===e?void 0:e.presence,s=o.createElement(Vt.Z,{member:t,size:"36px","aria-hidden":"true"});t.user&&(this.userLastModifiedTime=t.user.getLastModifiedTime()),this.memberLastModifiedTime=t.getLastModifiedTime();const a=new Map([[100,ws.Admin],[50,ws.Moderator]]);let r=this.props.member.powerLevel;for(const[e]of a)if(this.props.member.powerLevel>=e){r=e;break}const l=a.get(r);let c;this.state.isRoomEncrypted&&(c=this.state.e2eStatus);const d=o.createElement(Tt,{member:t,fallbackName:i||""});return o.createElement(ks,(0,kt.Z)({},this.props,{presenceState:n,presenceLastActiveAgo:t.user?t.user.lastActiveAgo:0,presenceLastTs:t.user?t.user.lastPresenceTs:0,presenceCurrentlyActive:!!t.user&&t.user.currentlyActive,avatarJsx:s,title:this.getPowerLabel(),name:i,nameJSX:d,powerStatus:l,showPresence:this.props.showPresence,e2eStatus:c,onClick:this.onClick}))}}(0,k.Z)(wu,"defaultProps",{showPresence:!0});var Su=i("../matrix-react-sdk/src/components/views/rooms/SpaceScopeHeader.tsx");class Cu extends o.Component{constructor(e,t){var s;super(e),(0,k.Z)(this,"showPresence",void 0),(0,k.Z)(this,"mounted",!1),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"tiles",new Map),(0,k.Z)(this,"onUserPresenceChange",((e,t)=>{this.tiles.get(t.userId)&&this.updateList()})),(0,k.Z)(this,"onRoom",(e=>{e.roomId===this.props.roomId&&this.updateListNow(!0)})),(0,k.Z)(this,"onMyMembership",((e,t,i)=>{e.roomId===this.props.roomId&&"join"===t&&"join"!==i&&this.updateListNow(!0)})),(0,k.Z)(this,"onRoomStateUpdate",(e=>{e.roomId===this.props.roomId&&this.updateList()})),(0,k.Z)(this,"onRoomMemberName",((e,t)=>{t.roomId===this.props.roomId&&this.updateList()})),(0,k.Z)(this,"onRoomStateEvent",(e=>{e.getRoomId()===this.props.roomId&&e.getType()===n.EventType.RoomThirdPartyInvite&&this.updateList(),this.canInvite!==this.state.canInvite&&this.setState({canInvite:this.canInvite})})),(0,k.Z)(this,"updateList",(0,ln.throttle)((()=>{this.updateListNow(!1)}),500,{leading:!0,trailing:!0})),(0,k.Z)(this,"createOverflowTileJoined",((e,t)=>this.createOverflowTile(e,t,this.showMoreJoinedMemberList))),(0,k.Z)(this,"createOverflowTileInvited",((e,t)=>this.createOverflowTile(e,t,this.showMoreInvitedMemberList))),(0,k.Z)(this,"createOverflowTile",((e,t,n)=>{const s=(0,l._t)("common|and_n_others",{count:e});return o.createElement(ks,{className:"mx_EntityTile_ellipsis",avatarJsx:o.createElement(ys.Z,{url:i("../matrix-react-sdk/res/img/ellipsis.svg").Z,name:"...",size:"36px"}),name:s,showPresence:!1,onClick:n})})),(0,k.Z)(this,"showMoreJoinedMemberList",(()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})})),(0,k.Z)(this,"showMoreInvitedMemberList",(()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})})),(0,k.Z)(this,"onSearchQueryChanged",(e=>{this.props.onSearchQueryChanged(e)})),(0,k.Z)(this,"onPending3pidInviteClick",(e=>{x.ZP.dispatch({action:W.a.View3pidInvite,event:e})})),(0,k.Z)(this,"getChildrenJoined",((e,t)=>this.makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t)))),(0,k.Z)(this,"getChildCountJoined",(()=>this.state.filteredJoinedMembers.length)),(0,k.Z)(this,"getChildrenInvited",((e,t)=>{let i=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(i=i.concat(this.getPending3PidInvites())),this.makeMemberTiles(i.slice(e,t))})),(0,k.Z)(this,"getChildCountInvited",(()=>this.state.filteredInvitedMembers.length+(this.getPending3PidInvites()||[]).length)),(0,k.Z)(this,"onInviteButtonClick",(e=>{kn.Z.trackInteraction("WebRightPanelMemberListInviteButton",e);Fp(E.p.safeGet().getRoom(this.props.roomId))})),this.state=this.getMembersState([],[]),this.showPresence=null===(s=null==t?void 0:t.memberListStore.isPresenceEnabled())||void 0===s||s,this.mounted=!0,this.listenForMembersChanges()}listenForMembersChanges(){const e=E.p.safeGet();e.on(n.RoomStateEvent.Update,this.onRoomStateUpdate),e.on(n.RoomMemberEvent.Name,this.onRoomMemberName),e.on(n.RoomStateEvent.Events,this.onRoomStateEvent),e.on(n.UserEvent.LastPresenceTs,this.onUserPresenceChange),e.on(n.UserEvent.Presence,this.onUserPresenceChange),e.on(n.UserEvent.CurrentlyActive,this.onUserPresenceChange),e.on(n.ClientEvent.Room,this.onRoom),e.on(n.RoomEvent.MyMembership,this.onMyMembership)}componentDidMount(){this.updateListNow(!0)}componentWillUnmount(){this.mounted=!1;const e=E.p.get();e&&(e.removeListener(n.RoomStateEvent.Update,this.onRoomStateUpdate),e.removeListener(n.RoomMemberEvent.Name,this.onRoomMemberName),e.removeListener(n.RoomEvent.MyMembership,this.onMyMembership),e.removeListener(n.RoomStateEvent.Events,this.onRoomStateEvent),e.removeListener(n.ClientEvent.Room,this.onRoom),e.removeListener(n.UserEvent.LastPresenceTs,this.onUserPresenceChange),e.removeListener(n.UserEvent.Presence,this.onUserPresenceChange),e.removeListener(n.UserEvent.CurrentlyActive,this.onUserPresenceChange)),this.updateList.cancel()}get canInvite(){const e=E.p.safeGet().getRoom(this.props.roomId);return!!e&&Up(e)}getMembersState(e,t){return{loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:e,canInvite:this.canInvite,truncateAtJoined:30,truncateAtInvited:5}}async updateListNow(e){if(!this.mounted)return;e&&this.setState({loading:!0});const{joined:t,invited:i}=await this.context.memberListStore.loadMemberList(this.props.roomId,this.props.searchQuery);this.mounted&&this.setState({loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:i})}componentDidUpdate(e,t,i){e.searchQuery!==this.props.searchQuery&&this.updateListNow(!1)}getPending3PidInvites(){const e=E.p.safeGet().getRoom(this.props.roomId);return e?e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!(0,Ra.ih)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())})):[]}makeMemberTiles(e){return e.map((e=>e instanceof n.RoomMember?o.createElement(wu,{key:e.userId,member:e,ref:t=>{t?this.tiles.set(e.userId,t):this.tiles.delete(e.userId)},showPresence:this.showPresence}):o.createElement(ks,{key:e.getStateKey(),name:e.getContent().display_name,showPresence:!1,onClick:()=>this.onPending3pidInviteClick(e)})))}render(){if(this.state.loading)return o.createElement(bm.C,{className:"mx_MemberList",onClose:this.props.onClose},o.createElement(re.Z,null));const e=E.p.safeGet().getRoom(this.props.roomId);let t,i,n;if("join"===(null==e?void 0:e.getMyMembership())&&(0,hr.I)(Ye.y.InviteUsers)){const i=e.isSpaceRoom()?(0,l._t)("space|invite_this_space"):(0,l._t)("room|invite_this_room"),n=o.createElement(sm.zx,{size:"sm",kind:"secondary",className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!this.state.canInvite},o.createElement(bu.J,{width:"1em",height:"1em"}),i);t=this.state.canInvite?n:o.createElement(sm.u,{label:(0,l._t)("member_list|invite_button_no_perms_tooltip")},n)}this.getChildCountInvited()>0&&(i=o.createElement("h2",null,(0,l._t)("member_list|invited_list_heading")),n=o.createElement(fs.Z,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this.createOverflowTileInvited,getChildren:this.getChildrenInvited,getChildCount:this.getChildCountInvited}));const s=o.createElement(ps.Z,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:(0,l._t)("member_list|filter_placeholder"),onSearch:this.onSearchQueryChanged,initialValue:this.props.searchQuery}),a=e?o.createElement(Su.$,{room:e}):void 0;return o.createElement(bm.C,{className:"mx_MemberList",header:o.createElement(o.Fragment,null,a),footer:s,onClose:this.props.onClose},t,o.createElement("div",{className:"mx_MemberList_wrapper"},o.createElement(fs.Z,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this.createOverflowTileJoined,getChildren:this.getChildrenJoined,getChildCount:this.getChildCountJoined}),i,n))}}(0,k.Z)(Cu,"contextType",ie.f);var ku=i("../matrix-react-sdk/src/components/views/right_panel/UserInfo.tsx");class xu extends o.Component{constructor(e){var t,i,s,o;super(e),(0,k.Z)(this,"room",void 0),(0,k.Z)(this,"onRoomStateEvents",(e=>{if(e.getType()===n.EventType.RoomThirdPartyInvite&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,i={invited:(0,Ra.ih)(e)};t&&(i.displayName=t),this.setState(i)}})),(0,k.Z)(this,"onCancel",(()=>{x.ZP.dispatch({action:W.a.View3pidInvite,event:null})})),(0,k.Z)(this,"onKickClick",(()=>{E.p.safeGet().sendStateEvent(this.state.roomId,"m.room.third_party_invite",{},this.state.stateKey).catch((e=>{r.k.error(e),this.setState({invited:!0}),T.ZP.createDialog(dt.Z,{title:(0,l._t)("user_info|error_revoke_3pid_invite_title"),description:(0,l._t)("user_info|error_revoke_3pid_invite_description")})})),this.setState({invited:!1})})),this.room=E.p.safeGet().getRoom(this.props.event.getRoomId());const a=null===(t=this.room)||void 0===t?void 0:t.getMember(E.p.safeGet().getSafeUserId()),c=null===(i=this.room)||void 0===i?void 0:i.currentState.getStateEvents("m.room.power_levels",""),d=this.props.event.getSender();let m=c?c.getContent().kick:50;"number"!=typeof m&&(m=50);const h=null===(s=this.room)||void 0===s?void 0:s.getMember(d);this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!a&&a.powerLevel>m,senderName:null!==(o=null==h?void 0:h.name)&&void 0!==o?o:d}}componentDidMount(){E.p.safeGet().on(n.RoomStateEvent.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=E.p.get();e&&e.removeListener(n.RoomStateEvent.Events,this.onRoomStateEvents)}render(){let e;this.state.canKick&&this.state.invited&&(e=o.createElement(Op,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},o.createElement(sm.xv,{as:"span",role:"heading",size:"lg",weight:"semibold"},(0,l._t)("user_info|admin_tools_section")),o.createElement(sm.zx,{size:"sm",kind:"destructive",className:"mx_MemberInfo_field",onClick:this.onKickClick},(0,l._t)("user_info|revoke_invite"))));const t=this.room?o.createElement(Su.$,{room:this.room}):void 0;return o.createElement(bm.C,{header:t,onClose:this.props.onClose},o.createElement(Op,{className:"mx_ThirdPartyMemberInfo",direction:"column",gap:"var(--cpd-space-4x)"},o.createElement(Op,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},o.createElement(sm.xv,{as:"span",role:"heading",size:"lg",weight:"semibold"},this.state.displayName),o.createElement(sm.xv,{as:"span"},(0,l._t)("user_info|invited_by",{sender:this.state.senderName}))),e))}}let Ru=function(e){return e[e.Files=0]="Files",e[e.Search=1]="Search",e}({});function Iu({isRoomEncrypted:e,kind:t}){if(!e)return o.createElement(o.Fragment,null);if(b.Z.get())return o.createElement(o.Fragment,null);if(b.Z.error)return o.createElement("div",{className:"mx_SearchWarning"},(0,l._t)("seshat|error_initialising",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:e=>{e.preventDefault(),x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.Security})}},e)}));const i=c.ZP.get("brand"),n=c.ZP.getObject("desktop_builds");let s,a;if(null!=n&&n.get("available")){a=o.createElement("img",{alt:"",src:n.get("logo"),width:"32px"});const e=n.get("url");switch(t){case Ru.Files:s=(0,l._t)("seshat|warning_kind_files_app",{},{a:t=>o.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)});break;case Ru.Search:s=(0,l._t)("seshat|warning_kind_search_app",{},{a:t=>o.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)})}}else switch(t){case Ru.Files:s=(0,l._t)("seshat|warning_kind_files",{brand:i});break;case Ru.Search:s=(0,l._t)("seshat|warning_kind_search",{brand:i})}return s?o.createElement("div",{className:"mx_SearchWarning"},a,o.createElement("span",null,s)):(r.k.warn("Unknown desktop builds warning kind: ",t),o.createElement(o.Fragment,null))}var Pu=i("../matrix-react-sdk/src/components/structures/LegacyCallEventGrouper.ts");const Tu=(...e)=>{L.C.getValue("debug_timeline_panel")&&r.k.log.call(console,"TimelinePanel debuglog:",...e)},Zu=(e,t)=>e.localTimestamp<t.localTimestamp,Nu=(e,t)=>e.localTimestamp>=t.localTimestamp;class Du extends o.Component{constructor(e,t){var i;if(super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"lastRRSentEventId",void 0),(0,k.Z)(this,"lastRMSentEventId",void 0),(0,k.Z)(this,"messagePanel",(0,o.createRef)()),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"timelineWindow",void 0),(0,k.Z)(this,"overlayTimelineWindow",void 0),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"readReceiptActivityTimer",null),(0,k.Z)(this,"readMarkerActivityTimer",null),(0,k.Z)(this,"callEventGroupers",new Map),(0,k.Z)(this,"initialReadMarkerId",null),(0,k.Z)(this,"onDumpDebugLogs",(()=>{var e,t,i,s,o,a,l;const c=null===(e=this.props.timelineSet)||void 0===e?void 0:e.room,d=null===(t=this.state)||void 0===t||null===(i=t.events)||void 0===i?void 0:i.map((e=>e.getId()));let m,h,p;try{const e=this.messagePanel.current;if(e){const t=Dn.findDOMNode(e);if(t){m=[...t.querySelectorAll("[data-event-id]")].map((e=>e.getAttribute("data-event-id")))}}}catch(e){r.k.error("onDumpDebugLogs: Failed to get the actual event ID's in the DOM",e)}const u={};if(c){const e=c.getTimelineSets(),t=c.threadsTimelineSets;try{h=Mu(e),p=Mu(t)}catch(e){r.k.error("onDumpDebugLogs: Failed to serialize event IDs from timelinesets",e)}try{c.getThreads().forEach((e=>{var t,i;u[e.id]={events:e.events.map((e=>e.getId())),numTimelines:e.timelineSet.getTimelines().length,liveTimeline:e.timelineSet.getLiveTimeline().getEvents().length,prevTimeline:null===(t=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(n.Direction.Backward))||void 0===t?void 0:t.getEvents().length,nextTimeline:null===(i=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(n.Direction.Forward))||void 0===i?void 0:i.getEvents().length}}))}catch(e){r.k.error("onDumpDebugLogs: Failed to serialize event IDs from the threads",e)}}let g,v;try{var _;g=null===(_=this.timelineWindow)||void 0===_?void 0:_.getEvents().map((e=>e.getId()))}catch(e){r.k.error("onDumpDebugLogs: Failed to get event IDs from the timelineWindow",e)}try{v=this.props.timelineSet.getPendingEvents().map((e=>e.getId()))}catch(e){r.k.error("onDumpDebugLogs: Failed to get pending event IDs",e)}r.k.debug(`TimelinePanel(${this.context.timelineRenderingType}): Debugging info for ${null==c?void 0:c.roomId}\n\tevents(${d.length})=${JSON.stringify(d)}\n\trenderedEventIds(${null!==(s=null===(o=m)||void 0===o?void 0:o.length)&&void 0!==s?s:0})=${JSON.stringify(m)}\n\tserializedEventIdsFromTimelineSets=${JSON.stringify(h)}\n\tserializedEventIdsFromThreadsTimelineSets=${JSON.stringify(p)}\n\tserializedThreadsMap=${JSON.stringify(u)}\n\ttimelineWindowEventIds(${null===(a=g)||void 0===a?void 0:a.length})=${JSON.stringify(g)}\n\tpendingEventIds(${null===(l=v)||void 0===l?void 0:l.length})=${JSON.stringify(v)}`)})),(0,k.Z)(this,"onMessageListUnfillRequest",((e,t)=>{var i,s;const o=e?n.EventTimeline.BACKWARDS:n.EventTimeline.FORWARDS;Tu("unpaginating events in direction",o);const a=t,r=this.timelineWindow.getEvents(),l=null!==(i=null===(s=this.overlayTimelineWindow)||void 0===s?void 0:s.getEvents())&&void 0!==i?i:[];let c,d,m,h=r.findIndex((e=>e.getId()===a));-1===h?(c=l.findIndex((e=>e.getId()===a)),h=e?(0,ln.findLastIndex)(r,(e=>Nu(l[c],e))):r.findIndex((e=>Zu(l[c],e)))):c=e?(0,ln.findLastIndex)(l,(e=>Zu(e,r[h]))):l.findIndex((e=>Nu(e,r[h]))),d=-1===h?0:e?h+1:r.length-h,m=-1===c?0:e?c+1:l.length-c,d>0&&(Tu("Unpaginating",d,"in direction",o),this.timelineWindow.unpaginate(d,e)),m>0&&(Tu("Unpaginating",d,"from overlay timeline in direction",o),this.overlayTimelineWindow.unpaginate(m,e));const{events:p,liveEvents:u,firstVisibleEventIndex:g}=this.getEvents();this.buildLegacyCallEventGroupers(p),this.setState({events:p,liveEvents:u,firstVisibleEventIndex:g}),e?this.setState({canBackPaginate:!0}):this.setState({canForwardPaginate:!0})})),(0,k.Z)(this,"onPaginationRequest",((e,t,i)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,i):e.paginate(t,i))),(0,k.Z)(this,"onMessageListFillRequest",(e=>{var t;if(!this.shouldPaginate())return Promise.resolve(!1);const i=e?n.EventTimeline.BACKWARDS:n.EventTimeline.FORWARDS,s=e?"canBackPaginate":"canForwardPaginate",o=e?"backPaginating":"forwardPaginating";return this.state[s]?null!==(t=this.timelineWindow)&&void 0!==t&&t.canPaginate(i)?e&&0!==this.state.firstVisibleEventIndex?(Tu("won't",i,"paginate past first visible event"),Promise.resolve(!1)):(Tu("Initiating paginate; backwards:"+e),this.setState({[o]:!0}),this.onPaginationRequest(this.timelineWindow,i,50).then((async t=>{var i;if(this.unmounted)return!1;this.overlayTimelineWindow&&await this.extendOverlayWindowToCoverMainWindow(),Tu("paginate complete backwards:"+e+"; success:"+t);const{events:a,liveEvents:r,firstVisibleEventIndex:l}=this.getEvents();this.buildLegacyCallEventGroupers(a);const c={[o]:!1,[s]:t,events:a,liveEvents:r,firstVisibleEventIndex:l},d=e?n.EventTimeline.FORWARDS:n.EventTimeline.BACKWARDS,m=e?"canForwardPaginate":"canBackPaginate";return!this.state[m]&&null!==(i=this.timelineWindow)&&void 0!==i&&i.canPaginate(d)&&(Tu("can now",d,"paginate again"),c[m]=!0),new Promise((i=>{this.setState(c,(()=>{i(t&&(!e||0===l))}))}))}))):(Tu("can't",i,"paginate any further"),this.setState({[s]:!1}),Promise.resolve(!1)):(Tu("have given up",i,"paginating this timeline"),Promise.resolve(!1))})),(0,k.Z)(this,"onMessageListScroll",(e=>{var t,i;null===(t=(i=this.props).onScroll)||void 0===t||t.call(i,e),this.props.manageReadMarkers&&this.doManageReadMarkers()})),(0,k.Z)(this,"doManageReadMarkers",(0,ln.debounce)((()=>{var e;const t=this.getReadMarkerPosition();if(null===t)return;t<0&&this.setState({readMarkerVisible:!0});const i=this.readMarkerTimeout(t);null===(e=this.readMarkerActivityTimer)||void 0===e||e.changeTimeout(i)}),100,{leading:!1,trailing:!0})),(0,k.Z)(this,"onAction",(e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate();break;case W.a.DumpDebugLogs:this.onDumpDebugLogs()}})),(0,k.Z)(this,"onRoomTimeline",((e,t,i,s,o)=>{var a,r;o.timeline.getTimelineSet()!==this.props.timelineSet&&o.timeline.getTimelineSet()!==this.props.overlayTimelineSet||(n.Thread.hasServerSideSupport||this.context.timelineRenderingType!==qt.SB.Thread||(i&&!this.state.canBackPaginate&&this.setState({canBackPaginate:!0}),i||this.state.canForwardPaginate||this.setState({canForwardPaginate:!0})),!i&&o&&o.liveEvent&&null!==(a=this.messagePanel.current)&&void 0!==a&&a.getScrollState()&&(null!==(r=this.messagePanel.current.getScrollState())&&void 0!==r&&r.stuckAtBottom?this.timelineWindow.paginate(n.EventTimeline.FORWARDS,1,!1).then((()=>{if(this.overlayTimelineWindow)return this.overlayTimelineWindow.paginate(n.EventTimeline.FORWARDS,1,!1)})).then((()=>{if(this.unmounted)return;const{events:t,liveEvents:i,firstVisibleEventIndex:n}=this.getEvents();this.buildLegacyCallEventGroupers(t);const s=i[i.length-1],o={events:t,liveEvents:i,firstVisibleEventIndex:n};let a=!1;if(this.props.manageReadMarkers){const t=E.p.safeGet().credentials.userId;if(a=!1,e.getSender()===t||C.Z.sharedInstance().userActiveRecently()){if(s&&0===this.getReadMarkerPosition()){var r;this.setReadMarker(null!==(r=s.getId())&&void 0!==r?r:null,s.getTs(),!0),o.readMarkerVisible=!1,o.readMarkerEventId=s.getId(),a=!0}}else o.readMarkerVisible=!0}this.setState(o,(()=>{var e,t,i;(null===(e=this.messagePanel.current)||void 0===e||e.updateTimelineMinHeight(),a)&&(null===(t=(i=this.props).onReadMarkerUpdated)||void 0===t||t.call(i))}))})):this.setState({canForwardPaginate:!0})))})),(0,k.Z)(this,"onRoomTimelineReset",((e,t)=>{t!==this.props.timelineSet&&t!==this.props.overlayTimelineSet||this.canResetTimeline()&&this.loadTimeline()})),(0,k.Z)(this,"canResetTimeline",(()=>{var e,t;return!0===(null===(e=this.messagePanel)||void 0===e||null===(t=e.current)||void 0===t?void 0:t.isAtBottom())})),(0,k.Z)(this,"onRoomRedaction",((e,t)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.forceUpdate()})),(0,k.Z)(this,"onThreadUpdate",(e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.roomId))return;const i=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.id);i&&i.forceUpdate()})),(0,k.Z)(this,"onEventVisibilityChange",(e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.getRoomId()))return;const i=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.getId());i&&i.forceUpdate()})),(0,k.Z)(this,"onVisibilityPowerLevelChange",((e,t)=>{var i;if(!this.unmounted&&this.hasTimelineSetFor(t.roomId)&&t.userId==(null===(i=E.p.safeGet().credentials)||void 0===i?void 0:i.userId)){for(const e of this.state.events){var n;const t=null===(n=this.messagePanel.current)||void 0===n?void 0:n.getTileForEventId(e.getId());t&&t.forceUpdate()}this.forceUpdate()}})),(0,k.Z)(this,"onEventReplaced",(e=>{this.unmounted||this.hasTimelineSetFor(e.getRoomId())&&this.forceUpdate()})),(0,k.Z)(this,"onRoomReceipt",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()})),(0,k.Z)(this,"onLocalEchoUpdated",((e,t,i)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.reloadEvents()})),(0,k.Z)(this,"onAccountData",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&e.getType()===n.EventType.FullyRead&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)})),(0,k.Z)(this,"onEventDecrypted",(e=>{this.props.timelineSet.room&&this.hasTimelineSetFor(e.getRoomId())&&this.state.events.includes(e)&&(this.recheckFirstVisibleEventIndex(),this.buildLegacyCallEventGroupers(this.state.events),this.forceUpdate())})),(0,k.Z)(this,"onSync",((e,t,i)=>{this.unmounted||this.setState({clientSyncState:e})})),(0,k.Z)(this,"recheckFirstVisibleEventIndex",(0,ln.throttle)((()=>{const e=this.checkForPreJoinUISI(this.state.events);e!==this.state.firstVisibleEventIndex&&this.setState({firstVisibleEventIndex:e})}),500,{leading:!0,trailing:!0})),(0,k.Z)(this,"sendReadReceipts",(async()=>{var e,t;if(L.C.getValue("lowBandwidth"))return;if(!this.messagePanel.current)return;if(!this.props.manageReadReceipts)return;const i=E.p.get();if(!i||i.isGuest())return;const n=this.getCurrentReadReceipt(!0),s=this.indexForEventId(n),o=this.getLastDisplayedEventIndex({ignoreOwn:!0}),a=null!==(e=this.state.events[null!=o?o:this.state.events.length-1])&&void 0!==e?e:null,r=this.shouldSendReadReceipt(n,s,a,o),l=this.state.readMarkerEventId,c=this.shouldSendFullyReadMarker(l),d=null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId;Tu(`Sending Read Markers for ${d}: `,{shouldSendReadReceipt:r,shouldSendFullyReadMarker:c,currentReadReceiptEventId:n,currentReadReceiptEventIndex:s,lastReadEventId:null==a?void 0:a.getId(),lastReadEventIndex:o,readMarkerEventId:this.state.readMarkerEventId});const m=[];if(r&&m.push(this.sendReadReceipt(i,a)),c){this.props.timelineSet.findEventById(l)&&m.push(this.sendFullyReadMarker(i,null!=d?d:"",l))}await Promise.all(m)})),(0,k.Z)(this,"updateReadMarker",(async()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this.getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];this.setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),await this.sendReadReceipts()})),(0,k.Z)(this,"jumpToLiveTimeline",(()=>{var e,t;null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(n.EventTimeline.FORWARDS)?this.loadTimeline():null===(t=this.messagePanel.current)||void 0===t||t.scrollToBottom()})),(0,k.Z)(this,"scrollToEventIfNeeded",(e=>{var t;null===(t=this.messagePanel.current)||void 0===t||t.scrollToEventIfNeeded(e)})),(0,k.Z)(this,"jumpToReadMarker",(()=>{if(!this.props.manageReadMarkers)return;if(!this.messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this.messagePanel.current.getReadMarkerPosition()?this.loadTimeline(this.state.readMarkerEventId,0,1/3):this.messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)})),(0,k.Z)(this,"forgetReadMarker",(async()=>{if(!this.props.manageReadMarkers)return;const e=this.getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(null!=e?e:"");let i;if(t){const n=t.getEvents().find((t=>t.getId()==e));n&&(i=n.getTs())}this.setReadMarker(e,i),await this.sendReadReceipts()})),(0,k.Z)(this,"isAtEndOfLiveTimeline",(()=>{var e;return(null===(e=this.messagePanel.current)||void 0===e?void 0:e.isAtBottom())&&this.timelineWindow&&!this.timelineWindow.canPaginate(n.EventTimeline.FORWARDS)})),(0,k.Z)(this,"getScrollState",(()=>this.messagePanel.current?this.messagePanel.current.getScrollState():null)),(0,k.Z)(this,"getReadMarkerPosition",(()=>{if(!this.props.manageReadMarkers)return null;if(!this.messagePanel.current)return null;if(!this.props.timelineSet.room)return null;const e=this.messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=Du.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null})),(0,k.Z)(this,"canJumpToReadMarker",(()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(null===e||e<0)})),(0,k.Z)(this,"handleScrollKey",(e=>{if(!this.messagePanel.current)return;(0,dr.zL)().getRoomAction(e)===tn.vB.JumpToLatestMessage?this.jumpToLiveTimeline():this.messagePanel.current.handleScrollKey(e)})),(0,k.Z)(this,"getRelationsForEvent",((e,t,i)=>{var n;return null===(n=this.props.timelineSet.relations)||void 0===n?void 0:n.getChildEventsForEvent(e,t,i)})),this.context=t,Tu("mounting"),this.props.manageReadMarkers){var s;const e=null===(s=this.props.timelineSet.room)||void 0===s?void 0:s.getAccountData("m.fully_read");this.initialReadMarkerId=e?e.getContent().event_id:this.getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,firstVisibleEventIndex:0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:this.initialReadMarkerId,backPaginating:!1,forwardPaginating:!1,clientSyncState:E.p.safeGet().getSyncState(),isTwelveHour:L.C.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:L.C.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:L.C.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:L.C.getValue("readMarkerOutOfViewThresholdMs")},this.dispatcherRef=x.ZP.register(this.onAction);const a=E.p.safeGet();a.on(n.RoomEvent.Timeline,this.onRoomTimeline),a.on(n.RoomEvent.TimelineReset,this.onRoomTimelineReset),a.on(n.RoomEvent.Redaction,this.onRoomRedaction),L.C.getValue("feature_msc3531_hide_messages_pending_moderation")&&(a.on(n.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),a.on(n.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange)),a.on(n.RoomEvent.RedactionCancelled,this.onRoomRedaction),a.on(n.RoomEvent.Receipt,this.onRoomReceipt),a.on(n.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),a.on(n.RoomEvent.AccountData,this.onAccountData),a.on(n.MatrixEventEvent.Decrypted,this.onEventDecrypted),a.on(n.MatrixEventEvent.Replaced,this.onEventReplaced),a.on(n.ClientEvent.Sync,this.onSync),null===(i=this.props.timelineSet.room)||void 0===i||i.on(n.ThreadEvent.Update,this.onThreadUpdate)}componentDidMount(){this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this.initTimeline(this.props)}componentDidUpdate(e){var t,i;e.timelineSet!==this.props.timelineSet&&r.k.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue"),null===(t=this.props.timelineSet.room)||void 0===t||t.off(n.ThreadEvent.Update,this.onThreadUpdate),null===(i=this.props.timelineSet.room)||void 0===i||i.on(n.ThreadEvent.Update,this.onThreadUpdate);const s=e.eventId!=this.props.eventId,o=e.highlightedEventId!=this.props.highlightedEventId,a=e.eventScrollIntoView&&!this.props.eventScrollIntoView,l=e.overlayTimelineSet!==this.props.overlayTimelineSet;s||o||a?(r.k.log(`TimelinePanel switching to eventId ${this.props.eventId} (was ${e.eventId}), scrollIntoView: ${this.props.eventScrollIntoView} (was ${e.eventScrollIntoView})`),this.initTimeline(this.props)):l&&(r.k.log("TimelinePanel updating overlay timeline."),this.initTimeline(this.props))}componentWillUnmount(){this.unmounted=!0,this.readReceiptActivityTimer&&(this.readReceiptActivityTimer.abort(),this.readReceiptActivityTimer=null),this.readMarkerActivityTimer&&(this.readMarkerActivityTimer.abort(),this.readMarkerActivityTimer=null),x.ZP.unregister(this.dispatcherRef);const e=E.p.get();var t;e&&(e.removeListener(n.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(n.RoomEvent.TimelineReset,this.onRoomTimelineReset),e.removeListener(n.RoomEvent.Redaction,this.onRoomRedaction),e.removeListener(n.RoomEvent.RedactionCancelled,this.onRoomRedaction),e.removeListener(n.RoomEvent.Receipt,this.onRoomReceipt),e.removeListener(n.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),e.removeListener(n.RoomEvent.AccountData,this.onAccountData),e.removeListener(n.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange),e.removeListener(n.MatrixEventEvent.Decrypted,this.onEventDecrypted),e.removeListener(n.MatrixEventEvent.Replaced,this.onEventReplaced),e.removeListener(n.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),e.removeListener(n.ClientEvent.Sync,this.onSync),null===(t=this.props.timelineSet.room)||void 0===t||t.removeListener(n.ThreadEvent.Update,this.onThreadUpdate))}hasTimelineSetFor(e){var t,i,n;return void 0!==e&&e===(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId)||e===(null===(i=this.props.overlayTimelineSet)||void 0===i||null===(n=i.room)||void 0===n?void 0:n.roomId)}readMarkerTimeout(e){var t,i,n,s;return 0===e?null!==(t=null===(i=this.context)||void 0===i?void 0:i.readMarkerInViewThresholdMs)&&void 0!==t?t:this.state.readMarkerInViewThresholdMs:null!==(n=null===(s=this.context)||void 0===s?void 0:s.readMarkerOutOfViewThresholdMs)&&void 0!==n?n:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this.readMarkerTimeout(this.getReadMarkerPosition());for(this.readMarkerActivityTimer=new R.Z(e);this.readMarkerActivityTimer;){C.Z.sharedInstance().timeWhileActiveRecently(this.readMarkerActivityTimer);try{await this.readMarkerActivityTimer.finished()}catch(e){continue}await this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this.readReceiptActivityTimer=new R.Z(500);this.readReceiptActivityTimer;){C.Z.sharedInstance().timeWhileActiveNow(this.readReceiptActivityTimer);try{await this.readReceiptActivityTimer.finished()}catch(e){continue}await this.sendReadReceipts()}}async determineReceiptType(e){var t,i;const s=null!==(t=null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId)&&void 0!==t?t:null;return L.C.getValue("sendReadReceipts",s)?n.ReceiptType.Read:await e.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")&&await e.isVersionSupported("v1.4")?n.ReceiptType.ReadPrivate:(r.k.warn("Falling back to public instead of private receipts because the homeserver does not support them"),n.ReceiptType.Read)}shouldSendFullyReadMarker(e){return!!this.state.readMarkerEventId&&((!this.lastRMSentEventId||this.lastRMSentEventId!==this.state.readMarkerEventId)&&((!this.state.readMarkerEventId||this.state.readMarkerEventId!==this.initialReadMarkerId)&&!this.props.timelineSet.thread))}shouldSendReadReceipt(e,t,i,s){var o;return!!i&&((!e||null!==t||null===(o=this.timelineWindow)||void 0===o||!o.canPaginate(n.EventTimeline.FORWARDS))&&((null===s||null===t||s>t)&&(!this.lastRRSentEventId||this.lastRRSentEventId!==(null==i?void 0:i.getId()))))}async sendReadReceipt(e,t){this.lastRRSentEventId=t.getId();const i=await this.determineReceiptType(e);try{await e.sendReadReceipt(t,i)}catch(e){var n;this.lastRRSentEventId=void 0,r.k.error("Error sending receipt",{room:null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId,error:e})}}async sendFullyReadMarker(e,t,i){this.lastRMSentEventId=this.state.readMarkerEventId;try{await e.setRoomReadMarkers(t,i)}catch(e){this.lastRMSentEventId=void 0,r.k.error("Error sending fully_read",{roomId:t,error:e})}}advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers||!this.timelineWindow)return;const e=this.timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const i=E.p.safeGet().credentials.userId;for(t++;t<e.length;t++){if(e[t].getSender()!==i)break}t--;const n=e[t];this.setReadMarker(n.getId(),n.getTs())}initTimeline(e){const t=e.eventId,i=e.eventPixelOffset;let n=1;return null==i&&(n=.5),this.loadTimeline(t,i,n,e.eventScrollIntoView)}scrollIntoView(e,t,i){var n,s;const o=()=>{this.messagePanel.current&&(e?(Tu("TimelinePanel scrolling to eventId "+e+" at position "+100*i+"% + "+t),this.messagePanel.current.scrollToEvent(e,t,i)):(Tu("TimelinePanel scrolling to bottom"),this.messagePanel.current.scrollToBottom()))};Tu("TimelinePanel scheduling scroll to event"),null===(n=(s=this.props).onEventScrolledIntoView)||void 0===n||n.call(s,e),o(),window.requestAnimationFrame((()=>{o()}))}async extendOverlayWindowToCoverMainWindow(){const e=this.timelineWindow,t=this.overlayTimelineWindow,i=e.getEvents();if(i.length>0){let s;do{s=[];const o=t.getEvents();!t.canPaginate(n.EventTimeline.BACKWARDS)||0!==o.length&&!Nu(o[0],i[0])&&e.canPaginate(n.EventTimeline.BACKWARDS)||s.push(this.onPaginationRequest(t,n.EventTimeline.BACKWARDS,50)),!t.canPaginate(n.EventTimeline.FORWARDS)||0!==o.length&&!Zu(o.at(-1),i.at(-1))&&e.canPaginate(n.EventTimeline.FORWARDS)||s.push(this.onPaginationRequest(t,n.EventTimeline.FORWARDS,50)),await Promise.all(s)}while(s.length>0)}}loadTimeline(e,t,i,s=!0){const o=E.p.safeGet();this.timelineWindow=new n.TimelineWindow(o,this.props.timelineSet,{windowLimit:this.props.timelineCap}),this.overlayTimelineWindow=this.props.overlayTimelineSet?new n.TimelineWindow(o,this.props.overlayTimelineSet,{windowLimit:this.props.timelineCap}):void 0;const a=()=>{var o,a,l,c,d,m,h;this.unmounted||(null===(o=this.messagePanel.current)||void 0===o||o.onTimelineReset(),this.reloadEvents(),this.advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:null!==(a=(null===(l=this.timelineWindow)||void 0===l?void 0:l.canPaginate(n.EventTimeline.BACKWARDS))||(null===(c=this.overlayTimelineWindow)||void 0===c?void 0:c.canPaginate(n.EventTimeline.BACKWARDS)))&&void 0!==a&&a,canForwardPaginate:null!==(d=(null===(m=this.timelineWindow)||void 0===m?void 0:m.canPaginate(n.EventTimeline.FORWARDS))||(null===(h=this.overlayTimelineWindow)||void 0===h?void 0:h.canPaginate(n.EventTimeline.FORWARDS)))&&void 0!==d&&d,timelineLoading:!1},(()=>{this.messagePanel.current?(s&&this.scrollIntoView(e,t,i),this.props.sendReadReceiptOnLoad&&this.sendReadReceipts().catch((e=>{r.k.warn("Error sending receipts on load",e)}))):r.k.log("can't initialise scroll state because messagePanel didn't load")})))};if(this.props.timelineSet.getTimelineForEvent(e)&&!this.overlayTimelineWindow)return this.timelineWindow.load(e,30),void a();const c=this.timelineWindow.load(e,30).then((async()=>{this.overlayTimelineWindow&&(await this.overlayTimelineWindow.load(void 0,30),await this.extendOverlayWindowToCoverMainWindow())}));this.buildLegacyCallEventGroupers(),this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),c.then(a,(t=>{var i;if(this.unmounted)return;let n,s;this.setState({timelineLoading:!1}),r.k.error(`Error loading timeline panel at ${null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId}/${e}`,t),e&&this.props.timelineSet.room&&(n=()=>{x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.props.timelineSet.room.roomId,metricsTrigger:void 0})}),s="M_FORBIDDEN"==t.errcode?(0,l._t)("timeline|load_error|no_permission"):(0,l._t)("timeline|load_error|unable_to_find"),T.ZP.createDialog(dt.Z,{title:(0,l._t)("timeline|load_error|title"),description:s,onFinished:n})}))}reloadEvents(){if(this.unmounted)return;const e=this.getEvents();this.buildLegacyCallEventGroupers(e.events),this.setState(e)}refreshTimeline(e){this.loadTimeline(e,void 0,void 0,!1),this.reloadEvents()}getEvents(){var e,t;const i=this.timelineWindow.getEvents();let s=null!==(e=null===(t=this.overlayTimelineWindow)||void 0===t?void 0:t.getEvents())&&void 0!==e?e:[];void 0!==this.props.overlayTimelineSetFilter&&(s=s.filter(this.props.overlayTimelineSetFilter));const o=s.reduce(((e,t)=>{const i=e.findIndex((e=>Zu(t,e)));return-1===i?this.timelineWindow.canPaginate(n.EventTimeline.FORWARDS)||e.push(t):0===i?this.timelineWindow.canPaginate(n.EventTimeline.BACKWARDS)||e.unshift(t):e.splice(i,0,t),e}),[...i]);(0,ne.iP)(o).reverse().forEach((e=>{E.p.safeGet().decryptEventIfNeeded(e)}));const a=this.checkForPreJoinUISI(o),r=[...o];if(!this.timelineWindow.canPaginate(n.EventTimeline.FORWARDS)){const e=this.props.timelineSet.getPendingEvents();o.push(...e.filter((t=>{const{shouldLiveInRoom:i,threadId:n}=this.props.timelineSet.room.eventShouldLiveIn(t,e);return this.context.timelineRenderingType===qt.SB.Thread?n===this.context.threadId:i})))}return{events:o,liveEvents:r,firstVisibleEventIndex:a}}checkForPreJoinUISI(e){const t=E.p.safeGet(),i=this.props.timelineSet.room,s=[qt.SB.Thread,qt.SB.ThreadsList].includes(this.context.timelineRenderingType);if(0===e.length||!i||!t.isRoomEncrypted(i.roomId)||s)return r.k.debug("checkForPreJoinUISI: showing all messages, skipping check"),0;const o=t.getSafeUserId();let a=e.length-1,l="leave";for(;a>=0;a--){var c,d,m;const t=this.props.timelineSet.getTimelineForEvent(e[a].getId());if(!t){r.k.warn(`Event ${e[a].getId()} in room ${i.roomId} is live, but it does not have a timeline`);continue}l=null!==(c=null===(d=t.getState(n.EventTimeline.FORWARDS))||void 0===d||null===(m=d.getMember(o))||void 0===m?void 0:m.membership)&&void 0!==c?c:"leave";const s=t.getEvents();for(let t=s.length-1;t>=0;t--){const i=s[t];if(i.getId()===e[a].getId())break;i.getStateKey()===o&&i.getType()===n.EventType.RoomMember&&(l=i.getPrevContent().membership||"leave")}break}for(;a>=0;a--){const t=e[a];if(t.getStateKey()===o&&t.getType()===n.EventType.RoomMember)l=t.getPrevContent().membership||"leave";else if("leave"===l&&(t.isDecryptionFailure()||t.isBeingDecrypted()))return r.k.debug("checkForPreJoinUISI: reached a pre-join UISI at index ",a),a+1}return r.k.debug("checkForPreJoinUISI: did not find pre-join UISI"),0}indexForEventId(e){if(null===e)return null;if(this.context.timelineRenderingType===qt.SB.Thread)return 0;const t=this.state.events.findIndex((t=>t.getId()===e));return t>-1?t:null}getVisibleDecryptionFailures(e){const t=this.messagePanel.current;if(!t)return null;const i=Dn.findDOMNode(t);if(!i)return null;const n=i.getBoundingClientRect(),s=e?100:0,o=n.top-s,a=n.bottom+s,r=[];for(const e of this.state.liveEvents){const i=e.getId();if(!i)continue;const n=t.getNodeForEventId(i);if(!n)continue;const s=n.getBoundingClientRect();if(s.top>a)break;s.bottom>=o&&e.isDecryptionFailure()&&r.push(e)}return r}getLastDisplayedEventIndex(e={}){const t=e.ignoreOwn||!1,i=e.allowPartial||!1,n=this.messagePanel.current;if(!n)return null;const s=Dn.findDOMNode(n);if(!s)return null;const o=s.getBoundingClientRect(),a=E.p.safeGet().credentials.userId,r=e=>{if(e){const t=e.getBoundingClientRect();if(i&&t.top<=o.bottom||!i&&t.bottom<=o.bottom)return!0}return!1};let l=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){var c;const i=this.state.liveEvents[e],s=n.getNodeForEventId(i.getId()),o=r(s);if(o&&0!==l)return e+l;s&&!o&&(l=0);const d=!!i.status||t&&i.getSender()===a;if(!(!(0,At.eD)(i,E.p.safeGet(),null===(c=this.context)||void 0===c?void 0:c.showHiddenEvents)||(0,Qd.Z)(i,this.context))&&s){if(!d&&o)return e}else(!d||d&&0!==l)&&++l}return null}getCurrentReadReceipt(e=!1){var t,i;const n=E.p.get();if(null==n)return null;const s=n.getSafeUserId(),o=null!==(t=this.props.timelineSet.thread)&&void 0!==t?t:this.props.timelineSet.room;return null!==(i=null==o?void 0:o.getEventReadUpTo(s,e))&&void 0!==i?i:null}setReadMarker(e,t,i=!1){var n;const s=null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId;e!==this.state.readMarkerEventId&&null!==e&&(void 0!==t?Du.roomReadMarkerTsMap[null!=s?s:""]=t:delete Du.roomReadMarkerTsMap[null!=s?s:""],i||this.setState({readMarkerEventId:e},this.props.onReadMarkerUpdated))}shouldPaginate(){return!this.state.events.some((e=>e.isBeingDecrypted()))}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,Pu.YJ)(this.callEventGroupers,e)}render(){var e,t,i,s,a,r;if(this.state.timelineLoading)return o.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.createElement(re.Z,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return o.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},o.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const l=!(null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(n.EventTimeline.FORWARDS)),c=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),d=this.state.firstVisibleEventIndex?this.state.events.slice(this.state.firstVisibleEventIndex):this.state.events;return o.createElement(vp,{ref:this.messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:c,events:d,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,canBackPaginate:this.state.canBackPaginate&&0===this.state.firstVisibleEventIndex,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:E.p.safeGet().getSafeUserId(),stickyBottom:l,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:null!==(t=null===(i=this.context)||void 0===i?void 0:i.showTwelveHourTimestamps)&&void 0!==t?t:this.state.isTwelveHour,alwaysShowTimestamps:null!==(s=null!==(a=this.props.alwaysShowTimestamps)&&void 0!==a?a:null===(r=this.context)||void 0===r?void 0:r.alwaysShowTimestamps)&&void 0!==s?s:this.state.alwaysShowTimestamps,className:this.props.className,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,hideThreadedMessages:this.props.hideThreadedMessages,disableGrouping:this.props.disableGrouping,callEventGroupers:this.callEventGroupers})}}function Mu(e){return e.map((e=>{const t={},i=e.getTimelines(),n=e.getLiveTimeline();return i.forEach(((e,i)=>{t[e===n?"liveTimeline":`${i}`]=e.getEvents().map((e=>e.getId()))})),t}))}(0,k.Z)(Du,"contextType",qt.ZP),(0,k.Z)(Du,"roomReadMarkerTsMap",{}),(0,k.Z)(Du,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0,hideThreadedMessages:!0,disableGrouping:!1});const Ou=Du;class Au extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"instanceId",void 0),(0,k.Z)(this,"onResize",((e,t)=>{e===mr.Q.Resize&&this.props.onMeasurement(t.contentRect.width<=this.props.breakpoint)})),this.instanceId=Au.instanceCount++}componentDidMount(){mr.default.instance.on(`Measured${this.instanceId}`,this.onResize)}componentDidUpdate(e){const t=e.sensor,i=this.props.sensor;t!==i&&(t&&mr.default.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`),i&&mr.default.instance.trackElementDimensions(`Measured${this.instanceId}`,this.props.sensor))}componentWillUnmount(){mr.default.instance.off(`Measured${this.instanceId}`,this.onResize),mr.default.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`)}render(){return null}}function Lu(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Uu(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Lu(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Lu(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}(0,k.Z)(Au,"instanceCount",0),(0,k.Z)(Au,"defaultProps",{breakpoint:500});class Fu extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"decryptingEvents",new Set),(0,k.Z)(this,"noRoom",!1),(0,k.Z)(this,"card",(0,o.createRef)()),(0,k.Z)(this,"state",{timelineSet:null,narrow:!1}),(0,k.Z)(this,"onRoomTimeline",((e,t,i,n,s)=>{if((null==t?void 0:t.roomId)!==this.props.roomId)return;if(i||!s||!s.liveEvent||e.isRedacted())return;E.p.safeGet().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)})),(0,k.Z)(this,"onEventDecrypted",((e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const i=e.getId();this.decryptingEvents.delete(i)&&(t||this.addEncryptedLiveEvent(e))})),(0,k.Z)(this,"onPaginationRequest",((e,t,i)=>{const n=E.p.safeGet(),s=b.Z.get(),o=this.props.roomId,a=n.getRoom(o);return a&&n.isRoomEncrypted(o)&&null!==s?s.paginateTimelineWindow(a,e,t,i):e.paginate(t,i)})),(0,k.Z)(this,"onMeasurement",(e=>{this.setState({narrow:e})}))}addEncryptedLiveEvent(e){if(!this.state.timelineSet)return;const t=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&["m.file","m.image","m.video","m.audio"].includes(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,t,!1))}async componentDidMount(){const e=E.p.safeGet();await this.updateTimelineSet(this.props.roomId),e.isRoomEncrypted(this.props.roomId)&&null!==b.Z.get()&&(e.on(n.RoomEvent.Timeline,this.onRoomTimeline),e.on(n.MatrixEventEvent.Decrypted,this.onEventDecrypted))}componentWillUnmount(){const e=E.p.get();null!==e&&e.isRoomEncrypted(this.props.roomId)&&null!==b.Z.get()&&(e.removeListener(n.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(n.MatrixEventEvent.Decrypted,this.onEventDecrypted))}async fetchFileEventsServer(e){const t=E.p.safeGet(),i=new n.Filter(t.getSafeUserId());return i.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}}),i.filterId=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,i),e.getOrCreateFilteredTimelineSet(i)}async updateTimelineSet(e){const t=E.p.safeGet(),i=t.getRoom(e),n=b.Z.get();if(this.noRoom=!i,i){let s;try{if(s=await this.fetchFileEventsServer(i),t.isRoomEncrypted(e)&&null!==n){const e=s.getLiveTimeline();await n.populateFileTimeline(s,e,i,10)}this.setState({timelineSet:s})}catch(e){r.k.error("Failed to get or create file panel filter",e)}}else r.k.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(E.p.safeGet().isGuest())return o.createElement(bm.C,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose},o.createElement("div",{className:"mx_RoomView_empty"},(0,l._t)("file_panel|guest_note",{},{a:e=>o.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return o.createElement(bm.C,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose},o.createElement("div",{className:"mx_RoomView_empty"},(0,l._t)("file_panel|peek_note")));const e=o.createElement("div",{className:"mx_RightPanel_empty mx_FilePanel_empty"},o.createElement("h2",null,(0,l._t)("file_panel|empty_heading")),o.createElement("p",null,(0,l._t)("file_panel|empty_description"))),t=!this.noRoom&&E.p.safeGet().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?o.createElement(qt.ZP.Provider,{value:Uu(Uu({},this.context),{},{timelineRenderingType:qt.SB.File,narrow:this.state.narrow})},o.createElement(bm.C,{className:"mx_FilePanel",onClose:this.props.onClose,withoutScrollContainer:!0,ref:this.card},this.card.current&&o.createElement(Au,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.createElement(Iu,{isRoomEncrypted:t,kind:Ru.Files}),o.createElement(Ou,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,resizeNotifier:this.props.resizeNotifier,empty:e,layout:St.A.Group}))):o.createElement(qt.ZP.Provider,{value:Uu(Uu({},this.context),{},{timelineRenderingType:qt.SB.File})},o.createElement(bm.C,{className:"mx_FilePanel",onClose:this.props.onClose},o.createElement(re.Z,null)))}}(0,k.Z)(Fu,"contextType",qt.ZP);const Bu=Fu;class Vu extends o.Component{constructor(e){super(e),(0,k.Z)(this,"resize",(()=>{this.props.onResize&&this.props.onResize()}))}componentDidMount(){window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}render(){return o.createElement("div",null,this.props.element)}}const ju="stickerPicker";class zu extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"prevSentVisibility",void 0),(0,k.Z)(this,"popoverWidth",300),(0,k.Z)(this,"popoverHeight",300),(0,k.Z)(this,"scalarClient",null),(0,k.Z)(this,"removeStickerpickerWidgets",(async()=>{const e=await this.acquireScalarClient();r.k.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(Zm.l.STICKERPICKER,this.state.widgetId).then((()=>{r.k.log("Assets disabled")})).catch((()=>{r.k.error("Failed to disable assets")})):r.k.error("Cannot disable assets: no scalar client"):r.k.warn("No widget ID specified, not disabling assets"),this.props.setStickerPickerOpen(!1),Sm.Z.removeStickerpickerWidgets(this.props.room.client).then((()=>{this.forceUpdate()})).catch((e=>{r.k.error("Failed to remove sticker picker widget",e)}))})),(0,k.Z)(this,"updateWidget",(()=>{var e,t,i,n;const s=Sm.Z.getStickerpickerWidgets(this.props.room.client)[0];if(!s)return zu.currentWidget=void 0,void this.setState({stickerpickerWidget:null,widgetId:null});const o=zu.currentWidget,a=null!==(e=null==o||null===(t=o.content)||void 0===t?void 0:t.url)&&void 0!==e?e:null;(null!==(i=null==s||null===(n=s.content)||void 0===n?void 0:n.url)&&void 0!==i?i:null)!==a&&nu.destroyElement(ju),zu.currentWidget=s,this.setState({stickerpickerWidget:s,widgetId:s?s.id:null})})),(0,k.Z)(this,"onAction",(e=>{switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":case"show_left_panel":case"hide_left_panel":this.props.setStickerPickerOpen(!1)}})),(0,k.Z)(this,"onRightPanelStoreUpdate",(()=>{this.props.setStickerPickerOpen(!1)})),(0,k.Z)(this,"onResize",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),(0,k.Z)(this,"onFinished",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),(0,k.Z)(this,"launchManageIntegrations",(()=>{var e,t,i;null===(e=B.B.sharedInstance())||void 0===e||null===(t=e.getPrimaryManager())||void 0===t||t.open(this.props.room,`type_${Zm.l.STICKERPICKER.preferred}`,null!==(i=this.state.widgetId)&&void 0!==i?i:void 0)})),this.state={imError:null,stickerpickerWidget:null,widgetId:null}}async acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):B.B.sharedInstance().hasManager()?(this.scalarClient=null!==(e=null===(t=B.B.sharedInstance().getPrimaryManager())||void 0===t?void 0:t.getScalarClient())&&void 0!==e?e:null,null===(i=this.scalarClient)||void 0===i?void 0:i.connect().then((()=>(this.forceUpdate(),this.scalarClient))).catch((e=>{this.imError((0,l.I8)("integration_manager|error_connecting_heading"),e)}))):void B.B.sharedInstance().openNoManagerDialog();var e,t,i}componentDidMount(){window.addEventListener("resize",this.onResize),this.dispatcherRef=x.ZP.register(this.onAction),E.p.safeGet().on(n.ClientEvent.AccountData,this.updateWidget),nm.Z.instance.on(Pa.a,this.onRightPanelStoreUpdate),this.updateWidget()}componentWillUnmount(){const e=E.p.get();e&&e.removeListener(n.ClientEvent.AccountData,this.updateWidget),nm.Z.instance.off(Pa.a,this.onRightPanelStoreUpdate),window.removeEventListener("resize",this.onResize),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef)}componentDidUpdate(){this.sendVisibilityToWidget(this.props.isStickerPickerOpen)}imError(e,t){r.k.error(e,t),this.setState({imError:(0,l._t)(e)}),this.props.setStickerPickerOpen(!1)}defaultStickerpickerContent(){return o.createElement(ae.Z,{onClick:this.launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},o.createElement("p",null,(0,l._t)("stickers|empty")),o.createElement("p",{className:"mx_Stickers_addLink"},(0,l._t)("stickers|empty_add_prompt")),o.createElement("img",{src:i("../matrix-react-sdk/res/img/stickerpack-placeholder.png"),alt:""}))}errorStickerpickerContent(){return o.createElement("div",{style:{textAlign:"center"},className:"error"},o.createElement("p",null," ",this.state.imError," "))}sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=Tm.c.instance.getMessagingForUid(Sm.Z.calcWidgetUid(this.state.stickerpickerWidget.id));t&&e!==this.prevSentVisibility&&(t.updateVisibility(e).catch((e=>{r.k.error("Error updating widget visibility: ",e)})),this.prevSentVisibility=e)}getStickerpickerContent(){var e;if(this.state.imError)return this.errorStickerpickerContent();const t=this.state.stickerpickerWidget;let i;if(null!=t&&null!==(e=t.content)&&void 0!==e&&e.url){t.content.name=t.content.name||(0,l._t)("common|stickerpack");const e={id:t.id,url:t.content.url,name:t.content.name,type:t.content.type,data:t.content.data,creatorUserId:t.content.creatorUserId||t.sender};i=o.createElement("div",{className:"mx_Stickers_content_container"},o.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},o.createElement(nu,{persistKey:ju,zIndex:3500},o.createElement(Eu,{app:e,room:this.props.room,threadId:this.props.threadId,fullWidth:!0,userId:E.p.safeGet().credentials.userId,creatorUserId:t.sender||E.p.safeGet().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this.launchManageIntegrations,onDeleteClick:this.removeStickerpickerWidgets,showTitle:!1,showPopout:!1,handleMinimisePointerEvents:!0,userWidget:!0,showLayoutButtons:!1}))))}else i=this.defaultStickerpickerContent();return i}render(){return this.props.isStickerPickerOpen?o.createElement(ii.ZP,(0,kt.Z)({chevronFace:ii.N7.Bottom,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this.onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500},this.props.menuPosition),o.createElement(Vu,{element:this.getStickerpickerContent(),onResize:this.onFinished})):null}}(0,k.Z)(zu,"defaultProps",{threadId:null}),(0,k.Z)(zu,"currentWidget",void 0);class Wu extends o.Component{render(){return this.props.replyToEvent?o.createElement("div",{className:"mx_ReplyPreview"},o.createElement("div",{className:"mx_ReplyPreview_section"},o.createElement("div",{className:"mx_ReplyPreview_header"},o.createElement("span",null,(0,l._t)("composer|replying_title")),o.createElement(ae.Z,{className:"mx_ReplyPreview_header_cancel",onClick:()=>{return e=this.context.timelineRenderingType,void x.ZP.dispatch({action:"reply_to_event",event:null,context:e});var e}})),o.createElement(Ht,{mxEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}))):null}}(0,k.Z)(Wu,"contextType",qt.ZP);var Hu=i("../matrix-react-sdk/src/audio/VoiceRecording.ts"),Gu=i("../matrix-react-sdk/src/components/views/audio_messages/Waveform.tsx"),Ku=i("../matrix-react-sdk/src/utils/MarkedExecution.ts");class qu extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"waveform",[]),(0,k.Z)(this,"scheduledUpdate",new Ku.x((()=>this.updateWaveform()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={waveform:(0,ne.Hf)(0,Hu.K8)}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.waveform=(0,ne.MO)(Array.from(e.waveform),Hu.K8),this.scheduledUpdate.mark()}))}updateWaveform(){this.setState({waveform:this.waveform})}render(){return o.createElement(Gu.Z,{relHeights:this.state.waveform})}}(0,k.Z)(qu,"defaultProps",{progress:1});var $u=i("../matrix-react-sdk/src/components/views/audio_messages/Clock.tsx");class Ju extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"seconds",0),(0,k.Z)(this,"scheduledUpdate",new Ku.x((()=>this.updateClock()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()}))}updateClock(){this.setState({seconds:this.seconds})}render(){return o.createElement($u.Z,{seconds:this.state.seconds,"aria-live":"off"})}}var Yu=i("../matrix-react-sdk/src/utils/Singleflight.ts"),Qu=i("../matrix-react-sdk/src/audio/Playback.ts");class Xu{constructor(e,t){this.matrixClient=e,this.voiceRecording=t,(0,k.Z)(this,"lastUpload",void 0),(0,k.Z)(this,"buffer",new Uint8Array(0)),(0,k.Z)(this,"playback",void 0),(0,k.Z)(this,"onDataAvailable",(e=>{const t=new Uint8Array(e);this.buffer=(0,ne.zo)(this.buffer,t)})),this.voiceRecording.onDataAvailable=this.onDataAvailable}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");return this.voiceRecording.start()}async stop(){return await this.voiceRecording.stop(),this.audioBuffer}on(e,t){return this.voiceRecording.on(e,t),this}off(e,t){return this.voiceRecording.off(e,t),this}emit(e,...t){return this.voiceRecording.emit(e,...t)}get hasRecording(){return this.buffer.length>0}get isRecording(){return this.voiceRecording.isRecording}getPlayback(){return this.playback=Yu.u.for(this,"playback").do((()=>new Qu.B(this.audioBuffer.buffer,this.voiceRecording.amplitudes))),this.playback}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;try{this.emit(Hu.SR.Uploading);const{url:t,file:i}=await(0,Xd.cT)(this.matrixClient,e,new Blob([this.audioBuffer],{type:this.contentType}));this.lastUpload={mxc:t,encrypted:i},this.emit(Hu.SR.Uploaded)}catch(e){throw this.emit(Hu.SR.Ended),e}return this.lastUpload}get durationSeconds(){return this.voiceRecording.durationSeconds}get contentType(){return this.voiceRecording.contentType}get contentLength(){return this.buffer.length}get liveData(){return this.voiceRecording.liveData}get isSupported(){return this.voiceRecording.isSupported}destroy(){var e;null===(e=this.playback)||void 0===e||e.destroy(),this.voiceRecording.destroy()}get audioBuffer(){return this.buffer.slice(0)}}function eg(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function tg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ig(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?tg(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):tg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class ng extends Oa._{constructor(){super(x.ZP,{})}static get instance(){return this.internalInstance||(this.internalInstance=new ng,this.internalInstance.start()),this.internalInstance}async onAction(e){}static getVoiceRecordingId(e,t){return"io.element.thread"===(null==t?void 0:t.rel_type)||(null==t?void 0:t.rel_type)===n.RelationType.Thread?e.roomId+"|"+t.event_id:e.roomId}getActiveRecording(e){return this.state[e]}startRecording(e){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(!e)throw new Error("Recording must be associated with a room");if(this.state[e])throw new Error("A recording is already in progress");const t=(i=this.matrixClient,new Xu(i,new Hu.Yi));var i;return this.updateState(ig(ig({},this.state),{},{[e]:t})),t}disposeRecording(e){var t;null===(t=this.state[e])||void 0===t||t.destroy();const i=this.state,{[e]:n}=i,s=(0,v.Z)(i,[e].map(eg));return this.reset(s)}}(0,k.Z)(ng,"internalInstance",void 0),window.mxVoiceRecordingStore=ng.instance;var sg=i("../matrix-react-sdk/src/components/views/audio_messages/RecordingPlayback.tsx"),og=i("../matrix-react-sdk/src/audio/PlaybackManager.ts"),ag=i("../matrix-react-sdk/src/utils/local-room.ts"),rg=i("../matrix-react-sdk/src/components/views/rooms/SendMessageComposer.tsx"),lg=i("../matrix-react-sdk/src/utils/createVoiceMessageContent.ts");class cg extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"voiceRecordingId",void 0),(0,k.Z)(this,"onCancel",(async()=>{await this.disposeRecording()})),(0,k.Z)(this,"onRecordStartEndClick",(async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{T.ZP.createDialog(dt.Z,{title:(0,l._t)("voip|unable_to_access_audio_input_title"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("voip|unable_to_access_audio_input_description")))})};try{var t;const e=await Ka.ZP.getDevices();if(null==e||null===(t=e[Ka.C.AudioInput])||void 0===t||!t.length)return void T.ZP.createDialog(dt.Z,{title:(0,l._t)("voip|no_audio_input_title"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("voip|no_audio_input_description")))})}catch(t){return r.k.error("Error getting devices: ",t),void e()}try{og.r.instance.pauseAllExcept();const e=ng.instance.startRecording(this.voiceRecordingId);await e.start(),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:Hu.SR.Started})}catch(t){r.k.error("Error starting recording: ",t),e(),ng.instance.disposeRecording(this.voiceRecordingId)}})),(0,k.Z)(this,"onRecordingUpdate",(e=>{e!==Hu.SR.EndingSoon&&this.setState({recordingPhase:e})})),this.state={},this.voiceRecordingId=ng.getVoiceRecordingId(this.props.room,this.props.relation)}componentDidMount(){const e=ng.instance.getActiveRecording(this.voiceRecordingId);e&&(!e.isRecording&&e.hasRecording||r.k.warn("Cached recording hasn't ended yet and might cause issues"),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:Hu.SR.Ended}))}async componentWillUnmount(){const e=ng.instance.getActiveRecording(this.voiceRecordingId);await(null==e?void 0:e.stop()),this.bindNewRecorder(null)}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");const{replyToEvent:e,relation:t,permalinkCreator:i}=this.props;let n;await this.state.recorder.stop();try{n=await this.state.recorder.upload(this.voiceRecordingId)}catch(e){return r.k.error("Error uploading voice message:",e),void this.setState({didUploadFail:!0})}try{const s=(0,lg.G)(n.mxc,this.state.recorder.contentType,Math.round(1e3*this.state.recorder.durationSeconds),this.state.recorder.contentLength,n.encrypted,this.state.recorder.getPlayback().thumbnailWaveform.map((e=>Math.round(1024*e))));(0,rg.eg)(E.p.safeGet().getSafeUserId(),s,null,e),(0,rg.lZ)(s,t),e&&((0,Kt.YL)(s,e,{permalinkCreator:i,includeLegacyFallback:!0}),x.ZP.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType})),(0,ag.L)(this.props.room.roomId,(e=>E.p.safeGet().sendMessage(e,s)),this.props.room.client)}catch(e){r.k.error("Error sending voice message:",e)}await this.disposeRecording()}async disposeRecording(){await ng.instance.disposeRecording(this.voiceRecordingId),this.setState({recorder:void 0,recordingPhase:void 0,didUploadFail:!1})}bindNewRecorder(e){this.state.recorder&&this.state.recorder.off(Pa.a,this.onRecordingUpdate),e&&e.on(Pa.a,this.onRecordingUpdate)}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==Hu.SR.Started?o.createElement(sg.Z,{playback:this.state.recorder.getPlayback(),layout:sg.T.Composer}):o.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},o.createElement(Ju,{recorder:this.state.recorder}),o.createElement(qu,{recorder:this.state.recorder})):null}render(){if(!this.state.recordingPhase)return null;let e,t,i;if(this.state.recordingPhase===Hu.SR.Started){var n;let t=(0,l._t)("composer|send_voice_message");this.state.recorder&&(t=(0,l._t)("composer|stop_voice_message")),e=o.createElement(gs.Z,{className:"mx_VoiceRecordComposerTile_stop",onClick:this.onRecordStartEndClick,title:t}),!this.state.recorder||null!==(n=this.state.recorder)&&void 0!==n&&n.isRecording||(e=null)}return this.state.recorder&&this.state.recordingPhase!==Hu.SR.Uploading&&(t=o.createElement(gs.Z,{className:"mx_VoiceRecordComposerTile_delete",title:(0,l._t)("action|delete"),onClick:this.onCancel})),this.state.recordingPhase===Hu.SR.Uploading?i=o.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadingState"},o.createElement(_r.Z,{w:16,h:16})):this.state.didUploadFail&&this.state.recordingPhase===Hu.SR.Ended&&(i=o.createElement("span",{className:"mx_VoiceRecordComposerTile_failedState"},o.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadState_badge"},o.createElement(ai.Z,{notification:oi.Z.forSymbol("!",Sr.v.Red)})),o.createElement("span",{className:"text-warning"},(0,l._t)("timeline|send_state_failed")))),o.createElement(o.Fragment,null,i,t,e,this.renderWaveformArea())}}(0,k.Z)(cg,"contextType",qt.ZP);var dg=i("../matrix-react-sdk/src/components/views/rooms/MessageComposerButtons.tsx"),mg=i("../matrix-react-sdk/src/settings/Settings.tsx"),hg=i("../matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/index.ts");let pg=0;function ug(e){var t;return o.createElement(gs.Z,{className:"mx_MessageComposer_sendMessage",onClick:e.onClick,title:null!==(t=e.title)&&void 0!==t?t:(0,l._t)("composer|send_button_title"),"data-testid":"sendmessagebtn"})}class gg extends o.Component{constructor(e){super(e),(0,k.Z)(this,"tooltipId",`mx_MessageComposer_${Math.random()}`),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"messageComposerInput",(0,o.createRef)()),(0,k.Z)(this,"voiceRecordingButton",(0,o.createRef)()),(0,k.Z)(this,"ref",(0,o.createRef)()),(0,k.Z)(this,"instanceId",void 0),(0,k.Z)(this,"_voiceRecording",void 0),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"onResize",((e,t)=>{if(e===mr.Q.Resize){const{narrow:e}=this.context;this.setState({isMenuOpen:!!e&&this.state.isMenuOpen,isStickerPickerOpen:!1})}})),(0,k.Z)(this,"onAction",(e=>{switch(e.action){case"reply_to_event":e.context===this.context.timelineRenderingType&&window.setTimeout((()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),100);break;case W.a.SettingUpdated:{const t=e;switch(t.settingName){case"MessageComposerInput.showStickersButton":{const e=L.C.getValue("MessageComposerInput.showStickersButton");this.state.showStickersButton!==e&&this.setState({showStickersButton:e});break}case"MessageComposerInput.showPollsButton":{const e=L.C.getValue("MessageComposerInput.showPollsButton");this.state.showPollsButton!==e&&this.setState({showPollsButton:e});break}case mg.AN.VoiceBroadcast:this.state.showVoiceBroadcastButton!==t.newValue&&this.setState({showVoiceBroadcastButton:!!t.newValue});break;case"feature_wysiwyg_composer":this.state.isWysiwygLabEnabled!==t.newValue&&this.setState({isWysiwygLabEnabled:Boolean(t.newValue)})}}}})),(0,k.Z)(this,"onTombstoneClick",(e=>{var t,i;e.preventDefault();const s=null===(t=this.context.tombstone)||void 0===t?void 0:t.getContent().replacement_room,o=E.p.safeGet().getRoom(s);let a;if(o){const e=o.currentState.getStateEvents(n.EventType.RoomCreate,"");null!=e&&e.getId()&&(a=e.getId())}const r=null===(i=this.context.tombstone)||void 0===i?void 0:i.getSender(),l=r?[r.split(":").slice(1).join(":")]:void 0;x.ZP.dispatch({action:W.a.ViewRoom,highlighted:!0,event_id:a,room_id:s,auto_join:!0,via_servers:l,metricsTrigger:"Tombstone",metricsViaKeyboard:"click"!==e.type})})),(0,k.Z)(this,"renderPlaceholderText",(()=>{if(this.props.replyToEvent){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===n.THREAD_RELATION_TYPE.name;return t&&this.props.e2eStatus?(0,l._t)("composer|placeholder_thread_encrypted"):t?(0,l._t)("composer|placeholder_thread"):this.props.e2eStatus?(0,l._t)("composer|placeholder_reply_encrypted"):(0,l._t)("composer|placeholder_reply")}return this.props.e2eStatus?(0,l._t)("composer|placeholder_encrypted"):(0,l._t)("composer|placeholder")})),(0,k.Z)(this,"addEmoji",(e=>(x.ZP.dispatch({action:W.a.ComposerInsert,text:e,timelineRenderingType:this.context.timelineRenderingType}),!0))),(0,k.Z)(this,"sendMessage",(async()=>{var e,t;if(this.state.haveRecording&&this.voiceRecordingButton.current)await(null===(t=this.voiceRecordingButton.current)||void 0===t?void 0:t.send());else if(null===(e=this.messageComposerInput.current)||void 0===e||e.sendMessage(),this.state.isWysiwygLabEnabled){const{permalinkCreator:e,relation:t,replyToEvent:i}=this.props,n=this.state.composerContent;this.setState({composerContent:"",initialComposerContent:""}),x.ZP.dispatch({action:W.a.ClearAndFocusSendMessageComposer,timelineRenderingType:this.context.timelineRenderingType}),await(0,hg.bG)(n,this.state.isRichTextEnabled,{mxClient:this.props.mxClient,roomContext:this.context,permalinkCreator:e,relation:t,replyToEvent:i})}})),(0,k.Z)(this,"onChange",(e=>{this.setState({isComposerEmpty:e.isEmpty})})),(0,k.Z)(this,"onWysiwygChange",(e=>{this.setState({composerContent:e,isComposerEmpty:0===(null==e?void 0:e.length)})})),(0,k.Z)(this,"onRichTextToggle",(async()=>{const{richToPlain:e,plainToRich:t}=await(0,hg.k_)(),{isRichTextEnabled:i,composerContent:n}=this.state,s=i?await e(n,!1):await t(n,!1);this.setState({isRichTextEnabled:!i,composerContent:s,initialComposerContent:s})})),(0,k.Z)(this,"onVoiceStoreUpdate",(()=>{this.updateRecordingState()})),(0,k.Z)(this,"onRecordingStarted",(()=>{const e=ng.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=ng.instance.getActiveRecording(e),this.setState({haveRecording:!!this.voiceRecording})})),(0,k.Z)(this,"onRecordingEndingSoon",(({secondsLeft:e})=>{this.setState({recordingTimeLeftSeconds:e}),window.setTimeout((()=>this.setState({recordingTimeLeftSeconds:void 0})),3e3)})),(0,k.Z)(this,"setStickerPickerOpen",(e=>{this.setState({isStickerPickerOpen:e,isMenuOpen:!1})})),(0,k.Z)(this,"toggleStickerPickerOpen",(()=>{this.setStickerPickerOpen(!this.state.isStickerPickerOpen)})),(0,k.Z)(this,"toggleButtonMenu",(()=>{this.setState({isMenuOpen:!this.state.isMenuOpen})})),(0,k.Z)(this,"onRecordStartEndClick",(()=>{const e=ie.m.instance.voiceBroadcastRecordingsStore.getCurrent();var t;e&&e.getState()!==Ut.nE.Stopped?T.ZP.createDialog(Sl.Z,{title:(0,l._t)("voice_message|cant_start_broadcast_title"),description:o.createElement("p",null,(0,l._t)("voice_message|cant_start_broadcast_description")),hasCloseButton:!0}):null===(t=this.voiceRecordingButton.current)||void 0===t||t.onRecordStartEndClick();this.context.narrow&&this.toggleButtonMenu()})),ng.instance.on(Pa.a,this.onVoiceStoreUpdate),this.state={isComposerEmpty:!0,composerContent:"",haveRecording:!1,recordingTimeLeftSeconds:void 0,isMenuOpen:!1,isStickerPickerOpen:!1,showStickersButton:L.C.getValue("MessageComposerInput.showStickersButton"),showPollsButton:L.C.getValue("MessageComposerInput.showPollsButton"),showVoiceBroadcastButton:L.C.getValue(mg.AN.VoiceBroadcast),isWysiwygLabEnabled:L.C.getValue("feature_wysiwyg_composer"),isRichTextEnabled:!0,initialComposerContent:""},this.instanceId=pg++,L.C.monitorSetting("MessageComposerInput.showStickersButton",null),L.C.monitorSetting("MessageComposerInput.showPollsButton",null),L.C.monitorSetting(mg.AN.VoiceBroadcast,null),L.C.monitorSetting("feature_wysiwyg_composer",null)}get voiceRecording(){return this._voiceRecording}set voiceRecording(e){this._voiceRecording&&(this._voiceRecording.off(Hu.SR.Started,this.onRecordingStarted),this._voiceRecording.off(Hu.SR.EndingSoon,this.onRecordingEndingSoon)),this._voiceRecording=e,e&&(e.on(Hu.SR.Started,this.onRecordingStarted),e.on(Hu.SR.EndingSoon,this.onRecordingEndingSoon))}componentDidMount(){this.dispatcherRef=x.ZP.register(this.onAction),this.waitForOwnMember(),mr.default.instance.trackElementDimensions(`MessageComposer${this.instanceId}`,this.ref.current),mr.default.instance.on(`MessageComposer${this.instanceId}`,this.onResize),this.updateRecordingState()}waitForOwnMember(){const e=this.props.room.getMember(E.p.safeGet().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then((()=>{var e;const t=null!==(e=this.props.room.getMember(E.p.safeGet().getSafeUserId()))&&void 0!==e?e:void 0;this.setState({me:t})}))}componentWillUnmount(){ng.instance.off(Pa.a,this.onVoiceStoreUpdate),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef),mr.default.instance.stopTrackingElementDimensions(`MessageComposer${this.instanceId}`),mr.default.instance.removeListener(`MessageComposer${this.instanceId}`,this.onResize),this.voiceRecording=null}updateRecordingState(){const e=ng.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=ng.instance.getActiveRecording(e),this.voiceRecording?this.voiceRecording.hasRecording&&!this.voiceRecording.isRecording&&this.setState({haveRecording:!0}):this.setState({haveRecording:!1})}get showStickersButton(){return this.state.showStickersButton&&!(0,Wn.S)(this.props.room)}getMenuPosition(){if(this.ref.current){const e=this.state.isWysiwygLabEnabled&&this.state.isRichTextEnabled,t=this.ref.current.getBoundingClientRect(),i=e?36:0,n=new DOMRect(t.x,t.y+i,t.width,t.height-i);return(0,ii.LS)(n)}}render(){var e;const t=Boolean(!this.state.isWysiwygLabEnabled&&this.props.e2eStatus),s=t&&o.createElement(Es.Z,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"}),a=[],r=this.getMenuPosition(),c=this.context.canSendMessages&&!this.context.tombstone;let d,m;if(c)d=this.state.isWysiwygLabEnabled&&r?o.createElement(hg.X5,{key:"controls_input",disabled:this.state.haveRecording,onChange:this.onWysiwygChange,onSend:this.sendMessage,isRichTextEnabled:this.state.isRichTextEnabled,initialContent:this.state.initialComposerContent,e2eStatus:this.props.e2eStatus,menuPosition:r,placeholder:this.renderPlaceholderText(),eventRelation:this.props.relation}):o.createElement(rg.ZP,{ref:this.messageComposerInput,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),permalinkCreator:this.props.permalinkCreator,relation:this.props.relation,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording,toggleStickerPickerOpen:this.toggleStickerPickerOpen}),a.push(o.createElement(cg,{key:"controls_voice_record",ref:this.voiceRecordingButton,room:this.props.room,permalinkCreator:this.props.permalinkCreator,relation:this.props.relation,replyToEvent:this.props.replyToEvent}));else if(this.context.tombstone){const e=this.context.tombstone.getContent().replacement_room,t=e?o.createElement("a",{href:(0,Rt.dl)(E.p.safeGet(),e),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},(0,l._t)("composer|room_upgraded_link")):"";a.push(o.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},o.createElement("div",{className:"mx_MessageComposer_replaced_valign"},o.createElement("img",{"aria-hidden":!0,alt:"",className:"mx_MessageComposer_roomReplaced_icon",src:i("../matrix-react-sdk/res/img/room_replaced.svg").Z}),o.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},(0,l._t)("composer|room_upgraded_notice")),o.createElement("br",null),t)))}else a.push(o.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},(0,l._t)("composer|no_perms_notice")));if(this.state.recordingTimeLeftSeconds){const e=Math.round(this.state.recordingTimeLeftSeconds);m=o.createElement(si.Z,{id:this.tooltipId,label:(0,Oe.kT)(e),alignment:si.v.Top})}const h=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===n.THREAD_RELATION_TYPE.name?this.props.relation.event_id:null;a.push(o.createElement(zu,{room:this.props.room,threadId:h,isStickerPickerOpen:this.state.isStickerPickerOpen,setStickerPickerOpen:this.setStickerPickerOpen,menuPosition:r,key:"stickers"}));const p=c&&(!this.state.isComposerEmpty||this.state.haveRecording),u=yt()({mx_MessageComposer:!0,"mx_MessageComposer--compact":this.props.compact,mx_MessageComposer_e2eStatus:t,mx_MessageComposer_wysiwyg:this.state.isWysiwygLabEnabled});return o.createElement("div",{className:u,ref:this.ref,"aria-describedby":this.state.recordingTimeLeftSeconds?this.tooltipId:void 0},m,o.createElement("div",{className:"mx_MessageComposer_wrapper"},o.createElement(Wu,{replyToEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}),o.createElement("div",{className:"mx_MessageComposer_row"},s,d,o.createElement("div",{className:"mx_MessageComposer_actions"},a,c&&o.createElement(dg.ZP,{addEmoji:this.addEmoji,haveRecording:this.state.haveRecording,isMenuOpen:this.state.isMenuOpen,isStickerPickerOpen:this.state.isStickerPickerOpen,menuPosition:r,relation:this.props.relation,onRecordStartEndClick:this.onRecordStartEndClick,setStickerPickerOpen:this.setStickerPickerOpen,showLocationButton:!window.electron&&L.C.getValue(Ye.H.LocationSharing),showPollsButton:this.state.showPollsButton,showStickersButton:this.showStickersButton,isRichTextEnabled:this.state.isRichTextEnabled,onComposerModeClick:this.onRichTextToggle,toggleButtonMenu:this.toggleButtonMenu,showVoiceBroadcastButton:this.state.showVoiceBroadcastButton,onStartVoiceBroadcastClick:()=>{(async(e,t,i,n,s)=>{var o;if(!await(0,Ut.Tu)(e,t,n))return null;const a=t.getUserId();if(!a)return null;const r=e.getMember(a);if(!r)return null;null===(o=i.getCurrent())||void 0===o||o.pause(),i.clearCurrent();const l=new Ut.rl(e,r,t,i,n);s.setCurrent(l)})(this.props.room,E.p.safeGet(),ie.m.instance.voiceBroadcastPlaybacksStore,ie.m.instance.voiceBroadcastRecordingsStore,ie.m.instance.voiceBroadcastPreRecordingStore),this.toggleButtonMenu()}}),p&&o.createElement(ug,{key:"controls_send",onClick:this.sendMessage,title:this.state.haveRecording?(0,l._t)("composer|send_button_voice_message"):void 0})))))}}(0,k.Z)(gg,"contextType",qt.ZP),(0,k.Z)(gg,"defaultProps",{compact:!1,showVoiceBroadcastButton:!1,isRichTextEnabled:!0});const vg=(0,pn.YD)(gg);class _g{constructor(e){this.event=e,(0,k.Z)(this,"serializedParts",null),(0,k.Z)(this,"caret",null)}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}var fg=i("../matrix-react-sdk/src/utils/FileUtils.ts");class Eg extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"mounted",!1),(0,k.Z)(this,"onAction",(e=>{this.mounted&&function(e){return[W.a.UploadStarted,W.a.UploadProgress,W.a.UploadFailed,W.a.UploadFinished,W.a.UploadCanceled].includes(e.action)}(e)&&this.setState(this.calculateState())})),(0,k.Z)(this,"onCancelClick",(e=>{e.preventDefault(),Xd.ZP.sharedInstance().cancelUpload(this.state.currentUpload)})),this.state=this.calculateState()}componentDidMount(){this.dispatcherRef=x.ZP.register(this.onAction),this.mounted=!0}componentWillUnmount(){this.mounted=!1,x.ZP.unregister(this.dispatcherRef)}getUploadsInRoom(){return Xd.ZP.sharedInstance().getCurrentUploads(this.props.relation).filter((e=>e.roomId===this.props.room.roomId))}calculateState(){const[e,...t]=this.getUploadsInRoom();return{currentUpload:e,currentFile:null==e?void 0:e.fileName,currentLoaded:null==e?void 0:e.loaded,currentTotal:null==e?void 0:e.total,countFiles:t.length+1}}render(){if(!this.state.currentFile)return null;let e;e=this.state.countFiles>1?(0,l._t)("room|upload|uploading_multiple_file",{filename:this.state.currentFile,count:this.state.countFiles-1}):(0,l._t)("room|upload|uploading_single_file",{filename:this.state.currentFile});const t=(0,fg.j)(this.state.currentTotal);return o.createElement("div",{className:"mx_UploadBar"},o.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),o.createElement(ae.Z,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),o.createElement(Ad.Z,{value:this.state.currentLoaded,max:this.state.currentTotal}))}}const yg=["mxEvent","permalinkCreator","onMenuToggle"],bg=e=>{let{mxEvent:t,permalinkCreator:i,onMenuToggle:n}=e,s=(0,v.Z)(e,yg);const[a,r,c,d]=(0,ii.av)(),m=(0,o.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:W.a.ViewRoom,event_id:t.getId(),highlighted:!0,room_id:t.getRoomId(),metricsTrigger:void 0}),d()}),[t,d]),h=(0,o.useCallback)((async e=>{if(i){null==e||e.preventDefault(),null==e||e.stopPropagation();const n=i.forEvent(t.getId());await(0,bn.RO)(n),d()}}),[t,d,i]);(0,o.useEffect)((()=>{null==n||n(a)}),[a,n]);const p=E.p.safeGet().getRoom(t.getRoomId()),u=!!p&&!Nm.z3.instance.hasMaximisedWidget(p);return o.createElement(o.Fragment,null,o.createElement(ii.JY,(0,kt.Z)({},s,{className:"mx_BaseCard_header_title_button--option",onClick:c,title:(0,l._t)("right_panel|thread_list|context_menu_label"),isExpanded:a,inputRef:r,"data-testid":"threadlist-dropdown-button"})),a&&o.createElement(ur.ZP,(0,kt.Z)({onFinished:d,className:"mx_RoomTile_contextMenu",compact:!0,rightAligned:!0},{left:(g=r.current.getBoundingClientRect()).left+window.scrollX+g.width,top:g.bottom+window.scrollY,chevronFace:ii.N7.None}),o.createElement(ur.I2,null,u&&o.createElement(ur.$k,{onClick:e=>m(e),label:(0,l._t)("timeline|mab|view_in_room"),iconClassName:"mx_ThreadPanel_viewInRoom"}),i&&o.createElement(ur.$k,{"data-testid":"copy-thread-link",onClick:e=>h(e),label:(0,l._t)("timeline|mab|copy_link_thread"),iconClassName:"mx_ThreadPanel_copyLinkToThread"}))));var g},wg=({parent:e,onFileDrop:t})=>{const[n,s]=(0,o.useState)({dragging:!1,counter:0});return(0,o.useEffect)((()=>{if(!e||e.ondrop)return;const i=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&s((t=>({counter:t.counter+1,dragging:!(!e.dataTransfer.types.includes("Files")&&!e.dataTransfer.types.includes("application/x-moz-file"))||t.dragging})))},n=e=>{e.stopPropagation(),e.preventDefault(),s((e=>({counter:e.counter-1,dragging:!(e.counter<=1)&&e.dragging})))},o=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy"))},a=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(t(e.dataTransfer),s((e=>({dragging:!1,counter:e.counter-1}))))};return null==e||e.addEventListener("drop",a),null==e||e.addEventListener("dragover",o),null==e||e.addEventListener("dragenter",i),null==e||e.addEventListener("dragleave",n),()=>{null==e||e.removeEventListener("drop",a),null==e||e.removeEventListener("dragover",o),null==e||e.removeEventListener("dragenter",i),null==e||e.removeEventListener("dragleave",n)}}),[e,t]),n.dragging?o.createElement("div",{className:"mx_FileDropTarget"},o.createElement("img",{src:i("../matrix-react-sdk/res/img/upload-big.svg").Z,className:"mx_FileDropTarget_image",alt:""}),(0,l._t)("room|drop_file_prompt")):null};var Sg=i("../matrix-react-sdk/src/dispatcher/payloads/ComposerInsertPayload.ts");function Cg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function kg(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Cg(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Cg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class xg extends o.Component{constructor(e){var t;super(e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"dispatcherRef",null),(0,k.Z)(this,"layoutWatcherRef",void 0),(0,k.Z)(this,"timelinePanel",(0,o.createRef)()),(0,k.Z)(this,"card",(0,o.createRef)()),(0,k.Z)(this,"eventId",void 0),(0,k.Z)(this,"onAction",(e=>{switch(e.phase==im.q.ThreadView&&e.event&&this.setupThread(e.event),e.action){case W.a.ComposerInsert:if(e.composerType)break;if(e.timelineRenderingType!==qt.SB.Thread)break;x.ZP.dispatch(kg(kg({},e),{},{composerType:this.state.editState?Sg.P.Edit:Sg.P.Send}));break;case W.a.EditEvent:if(e.timelineRenderingType!==qt.SB.Thread)return;if(e.event&&!e.event.getThread())return;this.setState({editState:e.event?new _g(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break;case"reply_to_event":e.context===qt.SB.Thread&&this.setState({replyToEvent:e.event})}})),(0,k.Z)(this,"setupThread",(e=>{const t=e.getId();let i=this.props.room.getThread(t);if(!i){const n=[];null===e.status&&n.push(e),i=this.props.room.createThread(t,e,n,!0)}this.updateThread(i)})),(0,k.Z)(this,"onNewThread",(e=>{e.id===this.props.mxEvent.getId()&&this.setupThread(this.props.mxEvent)})),(0,k.Z)(this,"updateThreadRelation",(()=>{this.setState({lastReply:this.threadLastReply})})),(0,k.Z)(this,"updateThread",(e=>{this.state.thread!==e&&(this.setupThreadListeners(e,this.state.thread),e&&this.setState({thread:e,lastReply:this.threadLastReply},(async()=>this.postThreadUpdate(e))))})),(0,k.Z)(this,"resetJumpToEvent",(e=>{var t,i;this.props.initialEvent&&this.props.initialEventScrollIntoView&&e===(null===(t=this.props.initialEvent)||void 0===t?void 0:t.getId())&&x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.props.room.roomId,event_id:null===(i=this.props.initialEvent)||void 0===i?void 0:i.getId(),highlighted:this.props.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0})})),(0,k.Z)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,k.Z)(this,"onKeyDown",(e=>{let t=!1;if((0,dr.zL)().getRoomAction(e)===tn.vB.UploadFile)x.ZP.dispatch({action:"upload_file",context:qt.SB.Thread},!0),t=!0;t&&(e.stopPropagation(),e.preventDefault())})),(0,k.Z)(this,"onFileDrop",(e=>{const t=this.props.mxEvent.getRoomId();t?Xd.ZP.sharedInstance().sendContentListToRoom(Array.from(e.files),t,this.threadRelation,E.p.safeGet(),qt.SB.Thread):console.warn("Unknwon roomId for event",this.props.mxEvent)})),(0,k.Z)(this,"renderThreadViewHeader",(()=>o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(ac.Z,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,l._t)("common|thread")),o.createElement(bg,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator})))),this.setEventId(this.props.mxEvent);const i=null!==(t=this.props.room.getThread(this.eventId))&&void 0!==t?t:void 0;this.setupThreadListeners(i),this.state={layout:L.C.getValue("layout"),narrow:!1,thread:i,lastReply:null==i?void 0:i.lastReply((e=>e.isRelation(n.THREAD_RELATION_TYPE.name)&&!e.status))},this.layoutWatcherRef=L.C.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e})))}componentDidMount(){this.state.thread&&this.postThreadUpdate(this.state.thread),this.setupThread(this.props.mxEvent),this.dispatcherRef=x.ZP.register(this.onAction),this.props.room.on(n.ThreadEvent.New,this.onNewThread)}componentWillUnmount(){var e;this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef);const t=this.props.mxEvent.getRoomId();L.C.unwatchSetting(this.layoutWatcherRef);const i=ie.m.instance.roomViewStore.getRoomId()!==t;this.props.initialEvent&&!i&&x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.props.room.roomId,metricsTrigger:void 0}),x.ZP.dispatch({action:W.a.ViewThread,thread_id:null}),null===(e=this.state.thread)||void 0===e||e.off(n.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(n.RoomEvent.LocalEchoUpdated,this.updateThreadRelation),this.props.room.removeListener(n.ThreadEvent.New,this.onNewThread)}componentDidUpdate(e){e.mxEvent!==this.props.mxEvent&&(this.setEventId(this.props.mxEvent),this.setupThread(this.props.mxEvent)),e.room!==this.props.room&&nm.Z.instance.setCard({phase:im.q.RoomSummary})}setEventId(e){if(!e.getId())throw new Error("Got thread event without id");this.eventId=e.getId()}get threadLastReply(){var e,t;return null!==(e=null===(t=this.state.thread)||void 0===t?void 0:t.lastReply((e=>e.isRelation(n.THREAD_RELATION_TYPE.name)&&!e.status)))&&void 0!==e?e:void 0}async postThreadUpdate(e){var t,i;x.ZP.dispatch({action:W.a.ViewThread,thread_id:e.id}),e.emit(n.ThreadEvent.ViewThread),this.updateThreadRelation(),null===(t=this.timelinePanel.current)||void 0===t||t.refreshTimeline(null===(i=this.props.initialEvent)||void 0===i?void 0:i.getId())}setupThreadListeners(e,t){var i;t&&(null===(i=this.state.thread)||void 0===i||i.off(n.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(n.RoomEvent.LocalEchoUpdated,this.updateThreadRelation));e&&(e.on(n.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.on(n.RoomEvent.LocalEchoUpdated,this.updateThreadRelation))}get threadRelation(){var e,t,i,s;const o={rel_type:n.THREAD_RELATION_TYPE.name,event_id:null===(e=this.state.thread)||void 0===e?void 0:e.id,is_falling_back:!0},a=null!==(t=null===(i=this.state.lastReply)||void 0===i?void 0:i.getId())&&void 0!==t?t:null===(s=this.state.thread)||void 0===s?void 0:s.id;return a&&(o["m.in_reply_to"]={event_id:a}),o}render(){var e,t,i,n,s,a;const l=this.props.isInitialEventHighlighted?null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId():void 0,c=this.threadRelation;let d;var m;this.state.thread?(this.props.initialEvent&&this.props.initialEvent.getRoomId()!==this.state.thread.roomId&&r.k.warn("ThreadView attempting to render TimelinePanel with mismatched initialEvent",this.state.thread.roomId,this.props.initialEvent.getRoomId(),this.props.initialEvent.getId()),d=o.createElement(o.Fragment,null,o.createElement(wg,{parent:this.card.current,onFileDrop:this.onFileDrop}),o.createElement(Ou,{key:this.state.thread.id,ref:this.timelinePanel,showReadReceipts:this.context.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!0,sendReadReceiptOnLoad:!0,timelineSet:this.state.thread.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===St.A.Bubble?St.A.Bubble:St.A.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(m=this.props.initialEvent)||void 0===m?void 0:m.getId(),highlightedEventId:l,eventScrollIntoView:this.props.initialEventScrollIntoView,onEventScrolledIntoView:this.resetJumpToEvent}))):d=o.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.createElement(re.Z,null));return o.createElement(qt.ZP.Provider,{value:kg(kg({},this.context),{},{timelineRenderingType:qt.SB.Thread,threadId:null===(t=this.state.thread)||void 0===t?void 0:t.id,liveTimeline:null===(i=this.state)||void 0===i||null===(n=i.thread)||void 0===n||null===(s=n.timelineSet)||void 0===s?void 0:s.getLiveTimeline(),narrow:this.state.narrow})},o.createElement(bm.C,{className:yt()("mx_ThreadView mx_ThreadPanel",{mx_ThreadView_narrow:this.state.narrow}),onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderThreadViewHeader(),ref:this.card,onKeyDown:this.onKeyDown,onBack:e=>{kn.Z.trackInteraction("WebThreadViewBackButton",e)}},this.card.current&&o.createElement(Au,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.createElement("div",{className:"mx_ThreadView_timelinePanelWrapper"},d),Xd.ZP.sharedInstance().getCurrentUploads(c).length>0&&o.createElement(Eg,{room:this.props.room,relation:c}),(null===(a=this.state.thread)||void 0===a?void 0:a.timelineSet)&&o.createElement(vg,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,relation:c,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}(0,k.Z)(xg,"contextType",qt.ZP);var Rg=i("../matrix-react-sdk/src/accessibility/context_menu/ContextMenuButton.tsx");function Ig(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Pg(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ig(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ig(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let Tg=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});const Zg=({label:e,description:t,onClick:i,isSelected:n})=>o.createElement(ii.tO,{active:n,className:"mx_ThreadPanel_Header_FilterOptionItem",onClick:i},o.createElement("span",null,e),o.createElement("span",null,t)),Ng=({filterOption:e,setFilterOption:t,empty:i})=>{const[n,s,a,r]=(0,ii.av)(),c=[{label:(0,l._t)("threads|all_threads"),description:(0,l._t)("threads|all_threads_description"),key:Tg.All},{label:(0,l._t)("threads|my_threads"),description:(0,l._t)("threads|my_threads_description"),key:Tg.My}],d=c.find((t=>t.key===e)),m=c.map((e=>o.createElement(Zg,{key:e.key,label:e.label,description:e.description,onClick:()=>{t(e.key),r()},isSelected:e===d}))),h=n?o.createElement(ii.ZP,{top:108,right:33,onFinished:r,chevronFace:ii.N7.Top,wrapperClassName:"mx_BaseCard_header_title"},m):null;return o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(ac.Z,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,l._t)("common|threads")),!i&&o.createElement(o.Fragment,null,o.createElement(Rg.l,{className:"mx_ThreadPanel_dropdown",inputRef:s,isExpanded:n,onClick:e=>{a(),kn.Z.trackInteraction("WebRightPanelThreadPanelFilterDropdown",e)}},`${(0,l._t)("threads|show_thread_filter")} ${null==d?void 0:d.label}`),h))},Dg=({hasThreads:e,filterOption:t,showAllThreadsCallback:i})=>{let n;return n=e?o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("threads|empty_has_threads_tip",{replyInThread:(0,l._t)("action|reply_in_thread")})),o.createElement("p",null,t===Tg.My?o.createElement("button",{onClick:i},(0,l._t)("threads|show_all_threads")):o.createElement(o.Fragment,null,"Â "))):o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("threads|empty_explainer")),o.createElement("p",{className:"mx_ThreadPanel_empty_tip"},(0,l._t)("threads|empty_tip",{replyInThread:(0,l._t)("action|reply_in_thread")},{b:e=>o.createElement("b",null,e)}))),o.createElement("aside",{className:"mx_ThreadPanel_empty"},o.createElement("div",{className:"mx_ThreadPanel_largeIcon"}),o.createElement("h2",null,(0,l._t)("threads|empty_heading")),n)},Mg=({roomId:e,onClose:t,permalinkCreator:i})=>{var s,a,r,l,c,d;const m=(0,o.useContext)(pn.ZP),h=(0,o.useContext)(qt.ZP),p=(0,o.useRef)(null),u=(0,o.useRef)(null),[g,v]=(0,o.useState)(Tg.All),[_,f]=(0,o.useState)(null),[E,y]=(0,o.useState)(!1),b=g===Tg.My?null==_?void 0:_.threadsTimelineSets[1]:null==_?void 0:_.threadsTimelineSets[0],w=Boolean(null==_||null===(s=_.threadsTimelineSets)||void 0===s||null===(a=s[0])||void 0===a||null===(r=a.getLiveTimeline())||void 0===r||null===(l=r.getEvents())||void 0===l?void 0:l.length);return(0,o.useEffect)((()=>{const t=m.getRoom(e);null==t||t.createThreadsTimelineSets().then((()=>t.fetchRoomThreads())).then((()=>{v(Tg.All),f(t)}))}),[m,e]),(0,o.useEffect)((()=>{var e;b&&!n.Thread.hasServerSideSupport&&(null===(e=p.current)||void 0===e||e.refreshTimeline())}),[b,p]),o.createElement(qt.ZP.Provider,{value:Pg(Pg({},h),{},{timelineRenderingType:qt.SB.ThreadsList,showHiddenEvents:!0,narrow:E})},o.createElement(bm.C,{header:o.createElement(Ng,{filterOption:g,setFilterOption:v,empty:!w}),className:"mx_ThreadPanel",onClose:t,withoutScrollContainer:!0,ref:u},u.current&&o.createElement(Au,{sensor:u.current,onMeasurement:y}),b?o.createElement(Ou,{key:g+":"+(null!==(c=null===(d=b.getFilter())||void 0===d?void 0:d.filterId)&&void 0!==c?c:e),ref:p,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:b,showUrlPreview:!1,empty:o.createElement(Dg,{hasThreads:w,filterOption:g,showAllThreadsCallback:()=>v(Tg.All)}),alwaysShowTimestamps:!0,layout:St.A.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!1,className:"mx_RoomView_messagePanel",membersLoaded:!0,permalinkCreator:i,disableGrouping:!0}):o.createElement("div",{className:"mx_AutoHideScrollbar"},o.createElement(re.Z,null))))};function Og(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Ag(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Og(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Og(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Lg extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"card",o.createRef()),(0,k.Z)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),this.state={narrow:!1}}render(){const e=o.createElement("div",{className:"mx_RightPanel_empty mx_NotificationPanel_empty"},o.createElement("h2",null,(0,l._t)("notif_panel|empty_heading")),o.createElement("p",null,(0,l._t)("notif_panel|empty_description")));let t;const i=E.p.safeGet().getNotifTimelineSet();return i?t=o.createElement(Ou,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:i,showUrlPreview:!1,empty:e,alwaysShowTimestamps:!0,layout:St.A.Group}):(r.k.error("No notifTimelineSet available!"),t=o.createElement(re.Z,null)),o.createElement(qt.ZP.Provider,{value:Ag(Ag({},this.context),{},{timelineRenderingType:qt.SB.Notification,narrow:this.state.narrow})},o.createElement(bm.C,{header:o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(ac.Z,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,l._t)("notifications|enable_prompt_toast_title"))),className:"mx_ThreadPanel",onClose:this.props.onClose,withoutScrollContainer:!0},this.card.current&&o.createElement(Au,{sensor:this.card.current,onMeasurement:this.onMeasurement}),t))}}(0,k.Z)(Lg,"contextType",qt.ZP);const Ug=e=>{const t=yt()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let i;return e.numUnreadMessages&&(i=o.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),o.createElement("div",{className:t},o.createElement(ae.Z,{className:"mx_JumpToBottomButton_scrollDown",title:(0,l._t)("room|jump_to_bottom_button"),onClick:e.onScrollToBottomClick}),i)};function Fg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Bg(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Fg(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Fg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Vg extends o.Component{constructor(e){super(e),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"layoutWatcherRef",void 0),(0,k.Z)(this,"timelinePanel",o.createRef()),(0,k.Z)(this,"card",o.createRef()),(0,k.Z)(this,"readReceiptsSettingWatcher",void 0),(0,k.Z)(this,"onRoomViewStoreUpdate",(async e=>{const t={initialEventId:ie.m.instance.roomViewStore.getInitialEventId(),isInitialEventHighlighted:ie.m.instance.roomViewStore.isInitialEventHighlighted(),replyToEvent:ie.m.instance.roomViewStore.getQuotingEvent()};this.setState(t)})),(0,k.Z)(this,"onAction",(e=>{if(e.action===W.a.EditEvent)this.setState({editState:e.event?new _g(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}))})),(0,k.Z)(this,"onScroll",(()=>{const e=this.timelinePanel.current;e&&(e.isAtEndOfLiveTimeline()?this.setState({atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.state.initialEventId&&this.state.isInitialEventHighlighted&&x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.props.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),(0,k.Z)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,k.Z)(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.props.room.roomId}):(null===(e=this.timelinePanel.current)||void 0===e||e.jumpToLiveTimeline(),x.ZP.fire(W.a.FocusSendMessageComposer))})),(0,k.Z)(this,"renderTimelineCardHeader",(()=>o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(ac.Z,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,l._t)("right_panel|video_room_chat|title"))))),this.state={showReadReceipts:L.C.getValue("showReadReceipts",e.room.roomId),layout:L.C.getValue("layout"),atEndOfLiveTimeline:!0,narrow:!1}}componentDidMount(){ie.m.instance.roomViewStore.addListener(Pa.a,this.onRoomViewStoreUpdate),this.dispatcherRef=x.ZP.register(this.onAction),this.readReceiptsSettingWatcher=L.C.watchSetting("showReadReceipts",null,((...[,,,e])=>this.setState({showReadReceipts:e}))),this.layoutWatcherRef=L.C.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e})))}componentWillUnmount(){ie.m.instance.roomViewStore.removeListener(Pa.a,this.onRoomViewStoreUpdate),this.readReceiptsSettingWatcher&&L.C.unwatchSetting(this.readReceiptsSettingWatcher),this.layoutWatcherRef&&L.C.unwatchSetting(this.layoutWatcherRef),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef)}render(){var e,t;const i=this.state.isInitialEventHighlighted?this.state.initialEventId:void 0;let s;this.state.atEndOfLiveTimeline||(s=o.createElement(Ug,{highlight:this.props.room.getUnreadNotificationCount(n.NotificationCountType.Highlight)>0,onScrollToBottomClick:this.jumpToLiveTimeline}));const a=Xd.ZP.sharedInstance().getCurrentUploads(this.props.composerRelation).length>0,r="join"===this.props.room.getMyMembership();return o.createElement(qt.ZP.Provider,{value:Bg(Bg({},this.context),{},{timelineRenderingType:null!==(e=this.props.timelineRenderingType)&&void 0!==e?e:this.context.timelineRenderingType,liveTimeline:null===(t=this.props.timelineSet)||void 0===t?void 0:t.getLiveTimeline(),narrow:this.state.narrow})},o.createElement(bm.C,{className:this.props.classNames,onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderTimelineCardHeader(),ref:this.card},this.card.current&&o.createElement(Au,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.createElement("div",{className:"mx_TimelineCard_timeline"},s,o.createElement(Ou,{ref:this.timelinePanel,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!1,sendReadReceiptOnLoad:!0,timelineSet:this.props.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===St.A.Bubble?St.A.Bubble:St.A.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:this.state.initialEventId,resizeNotifier:this.props.resizeNotifier,highlightedEventId:i,onScroll:this.onScroll})),a&&o.createElement(Eg,{room:this.props.room,relation:this.props.composerRelation}),r&&o.createElement(vg,{room:this.props.room,relation:this.props.composerRelation,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}function jg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}(0,k.Z)(Vg,"contextType",qt.ZP);class zg extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"delayedUpdate",(0,ln.throttle)((()=>{this.forceUpdate()}),500,{leading:!0,trailing:!0})),(0,k.Z)(this,"onRoomStateMember",((e,t,i)=>{var n,s;this.props.room&&i.roomId===this.props.room.roomId&&(this.state.phase===im.q.RoomMemberList||this.state.phase===im.q.RoomMemberInfo&&i.userId===(null===(n=this.state.cardState)||void 0===n||null===(s=n.member)||void 0===s?void 0:s.userId))&&this.delayedUpdate()})),(0,k.Z)(this,"onRightPanelStoreUpdate",(()=>{this.setState(function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?jg(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},zg.getDerivedStateFromProps(this.props)))})),(0,k.Z)(this,"onClose",(()=>{var e,t,i,n;if(null!==(e=this.props.overwriteCard)&&void 0!==e&&null!==(t=e.state)&&void 0!==t&&t.member)x.ZP.dispatch({action:W.a.ViewHomePage});else if(this.state.phase===im.q.EncryptionPanel&&null!==(i=this.state.cardState)&&void 0!==i&&null!==(n=i.verificationRequest)&&void 0!==n&&n.pending)this.state.cardState.verificationRequest.cancel();else{var s,o;nm.Z.instance.togglePanel(null!==(s=null===(o=this.props.room)||void 0===o?void 0:o.roomId)&&void 0!==s?s:null)}})),(0,k.Z)(this,"onSearchQueryChanged",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:""}}componentDidMount(){this.context.on(n.RoomStateEvent.Members,this.onRoomStateMember),nm.Z.instance.on(Pa.a,this.onRightPanelStoreUpdate)}componentWillUnmount(){var e;null===(e=this.context)||void 0===e||e.removeListener(n.RoomStateEvent.Members,this.onRoomStateMember),nm.Z.instance.off(Pa.a,this.onRightPanelStoreUpdate)}static getDerivedStateFromProps(e){var t,i,n;let s;return e.room&&(s=nm.Z.instance.currentCardForRoom(e.room.roomId)),{cardState:null===(t=s)||void 0===t?void 0:t.state,phase:null!==(i=null===(n=s)||void 0===n?void 0:n.phase)&&void 0!==i?i:void 0}}render(){var e,t,i,s,a;let r=o.createElement("div",null);const l=null===(e=this.props.room)||void 0===e?void 0:e.roomId,c=null!==(t=null===(i=this.props.overwriteCard)||void 0===i?void 0:i.phase)&&void 0!==t?t:this.state.phase,d=null!==(s=null===(a=this.props.overwriteCard)||void 0===a?void 0:a.state)&&void 0!==s?s:this.state.cardState;switch(c){case im.q.RoomMemberList:l&&(r=o.createElement(Cu,{roomId:l,key:l,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged}));break;case im.q.SpaceMemberList:var m,h;if(null!=d&&d.spaceId||l)r=o.createElement(Cu,{roomId:null!==(m=null==d?void 0:d.spaceId)&&void 0!==m?m:l,key:null!==(h=null==d?void 0:d.spaceId)&&void 0!==h?h:l,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged});break;case im.q.RoomMemberInfo:case im.q.SpaceMemberInfo:case im.q.EncryptionPanel:if(null!=d&&d.member){var p;const e=d.member instanceof n.RoomMember?d.member:void 0;r=o.createElement(ku.ZP,{user:d.member,room:null!==(p=this.context.getRoom(null==e?void 0:e.roomId))&&void 0!==p?p:this.props.room,key:null!=l?l:d.member.userId,onClose:this.onClose,phase:c,verificationRequest:d.verificationRequest,verificationRequestPromise:d.verificationRequestPromise})}break;case im.q.Room3pidMemberInfo:case im.q.Space3pidMemberInfo:null!=d&&d.memberInfoEvent&&(r=o.createElement(xu,{event:d.memberInfoEvent,key:l,onClose:this.onClose}));break;case im.q.NotificationPanel:r=o.createElement(Lg,{onClose:this.onClose});break;case im.q.PinnedMessages:this.props.room&&L.C.getValue("feature_pinning")&&(r=o.createElement(Ih,{room:this.props.room,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case im.q.Timeline:this.props.room&&(r=o.createElement(Vg,{classNames:"mx_ThreadPanel mx_TimelineCard",room:this.props.room,timelineSet:this.props.room.getUnfilteredTimelineSet(),resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case im.q.FilePanel:l&&(r=o.createElement(Bu,{roomId:l,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose}));break;case im.q.ThreadView:this.props.room&&null!=d&&d.threadHeadEvent&&(r=o.createElement(xg,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,mxEvent:d.threadHeadEvent,initialEvent:d.initialEvent,isInitialEventHighlighted:d.isInitialEventHighlighted,initialEventScrollIntoView:d.initialEventScrollIntoView,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case im.q.ThreadPanel:this.props.room&&(r=o.createElement(Mg,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case im.q.RoomSummary:this.props.room&&(r=o.createElement(Kp,{room:this.props.room,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator,onSearchClick:this.props.onSearchClick}));break;case im.q.Widget:this.props.room&&null!=d&&d.widgetId&&(r=o.createElement(yu,{room:this.props.room,widgetId:d.widgetId,onClose:this.onClose}))}return o.createElement("aside",{className:"mx_RightPanel",id:"mx_RightPanel"},r)}}(0,k.Z)(zg,"contextType",pn.ZP);class Wg{constructor(){(0,k.Z)(this,"scrollStateMap",new Map)}getScrollState(e){return this.scrollStateMap.get(e)}setScrollState(e,t){null===t?this.scrollStateMap.delete(e):this.scrollStateMap.set(e,t)}}void 0===window.mxRoomScrollStateStore&&(window.mxRoomScrollStateStore=new Wg);const Hg=window.mxRoomScrollStateStore;var Gg=i("../matrix-react-sdk/src/stores/WidgetEchoStore.ts"),Kg=i("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/RoomViewLifecycle.js"),qg=i("../matrix-react-sdk/src/IdentityAuthClient.tsx");class $g extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"onViewClick",(()=>{this.setState({hidden:!1})})),this.state={hidden:!0}}render(){const e=yt()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return o.createElement("div",{className:e},o.createElement("div",{className:"mx_InviteReason_reason"},this.props.htmlReason?(0,hn.mJ)(this.props.htmlReason):this.props.reason),o.createElement(ae.Z,{kind:"link_inline",className:"mx_InviteReason_view",onClick:this.onViewClick},(0,l._t)("common|view_message")))}}var Jg=i("../matrix-react-sdk/res/img/element-icons/ask-to-join.svg");var Yg=function(e){return e.NotLoggedIn="NotLoggedIn",e.Joining="Joining",e.Loading="Loading",e.Rejecting="Rejecting",e.Kicked="Kicked",e.Banned="Banned",e.OtherThreePIDError="OtherThreePIDError",e.InvitedEmailNotFoundInAccount="InvitedEmailNotFoundInAccount",e.InvitedEmailNoIdentityServer="InvitedEmailNoIdentityServer",e.InvitedEmailMismatch="InvitedEmailMismatch",e.Invite="Invite",e.ViewingRoom="ViewingRoom",e.RoomNotFound="RoomNotFound",e.OtherError="OtherError",e.PromptAskToJoin="PromptAskToJoin",e.Knocked="Knocked",e.RequestDenied="requestDenied",e}(Yg||{});class Qg extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onLoginClick",(()=>{x.ZP.dispatch({action:"start_login",screenAfterLogin:this.makeScreenAfterLogin()})})),(0,k.Z)(this,"onRegisterClick",(()=>{x.ZP.dispatch({action:"start_registration",screenAfterLogin:this.makeScreenAfterLogin()})})),(0,k.Z)(this,"onChangeReason",(e=>{this.setState({reason:e.target.value})})),this.state={busy:!1}}componentDidMount(){this.checkInvitedEmail()}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this.checkInvitedEmail()}async checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await E.p.safeGet().getThreePids();if(this.setState({accountEmails:e.threepids.filter((e=>"email"===e.medium)).map((e=>e.address))}),!E.p.safeGet().getIdentityServerUrl())return void this.setState({busy:!1});const t=new qg.Z,i=await t.getAccessToken(),n=await E.p.safeGet().lookupThreePid("email",this.props.invitedEmail,i);if(!("mxid"in n))throw new l.yh("room|error_3pid_invite_email_lookup");this.setState({invitedEmailMxid:n.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}getMessageCase(){if(E.p.safeGet().isGuest())return Yg.NotLoggedIn;const e=this.getMyMember();if(e){var t;const i=null===(t=e.events.member)||void 0===t?void 0:t.getPrevContent().membership;if(e.isKicked())return"knock"===i?Yg.RequestDenied:this.props.promptAskToJoin?Yg.PromptAskToJoin:Yg.Kicked;if("ban"===e.membership)return Yg.Banned}if(this.props.joining)return Yg.Joining;if(this.props.rejecting)return Yg.Rejecting;if(this.props.loading||this.state.busy)return Yg.Loading;if(this.props.knocked)return Yg.Knocked;if(this.props.canAskToJoinAndMembershipIsLeave||this.props.promptAskToJoin)return Yg.PromptAskToJoin;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return Yg.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return Yg.InvitedEmailNotFoundInAccount;if(!E.p.safeGet().getIdentityServerUrl())return Yg.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=E.p.safeGet().getUserId())return Yg.InvitedEmailMismatch}return Yg.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?Yg.RoomNotFound:Yg.OtherError:Yg.ViewingRoom}getKickOrBanInfo(){var e,t,i,n;const s=this.getMyMember();if(!s)return{};const o=null===(e=s.events.member)||void 0===e?void 0:e.getSender(),a=o?null===(t=this.props.room)||void 0===t?void 0:t.currentState.getMember(o):void 0;return{memberName:null!==(i=null==a?void 0:a.name)&&void 0!==i?i:o,reason:null===(n=s.events.member)||void 0===n?void 0:n.getContent().reason}}joinRule(){var e,t,i;return null!==(e=null===(t=this.props.room)||void 0===t||null===(i=t.currentState.getStateEvents(n.EventType.RoomJoinRules,""))||void 0===i?void 0:i.getContent().join_rule)&&void 0!==e?e:null}getMyMember(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t?void 0:t.getMember(E.p.safeGet().getSafeUserId()))&&void 0!==e?e:null}getInviteMember(){var e;const{room:t}=this.props;if(!t)return null;const i=E.p.safeGet().getSafeUserId(),n=t.currentState.getMember(i);if(!n)return null;const s=null===(e=n.events.member)||void 0===e?void 0:e.getSender();return s?t.currentState.getMember(s):null}isDMInvite(){var e;const t=this.getMyMember();if(!t)return!1;const i=null===(e=t.events.member)||void 0===e?void 0:e.getContent();return"invite"===(null==i?void 0:i.membership)&&i.is_direct}makeScreenAfterLogin(){var e,t,i,n,s,o;return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:null!==(e=null===(t=this.props.oobData)||void 0===t?void 0:t.name)&&void 0!==e?e:null,room_avatar_url:null!==(i=null===(n=this.props.oobData)||void 0===n?void 0:n.avatarUrl)&&void 0!==i?i:null,inviter_name:null!==(s=null===(o=this.props.oobData)||void 0===o?void 0:o.inviterName)&&void 0!==s?s:null}}}render(){var e,t,i,s,a,r;const d=c.ZP.get().brand,m=null!==(e=null!==(t=null===(i=this.props.room)||void 0===i?void 0:i.name)&&void 0!==t?t:this.props.roomAlias)&&void 0!==e?e:"",h=null!==(s=null===(a=this.props.room)||void 0===a?void 0:a.isSpaceRoom())&&void 0!==s?s:(null===(r=this.props.oobData)||void 0===r?void 0:r.roomType)===n.RoomType.Space;let p,u,g,v,_,f,y,b,w=!1;const S=[],C=this.getMessageCase();switch(C){case Yg.Joining:var k;p=null!==(k=this.props.oobData)&&void 0!==k&&k.roomType||h?h?(0,l._t)("room|joining_space"):(0,l._t)("room|joining_room"):(0,l._t)("room|joining"),w=!0;break;case Yg.Loading:p=(0,l._t)("common|loading"),w=!0;break;case Yg.Rejecting:p=(0,l._t)("room|rejecting"),w=!0;break;case Yg.NotLoggedIn:{const e={canJoin:!1};this.props.roomId&&Am.E.instance.invoke(Kg.s.PreviewRoomNotLoggedIn,e,this.props.roomId),e.canJoin?(p=(0,l._t)("room|join_title"),_=(0,l._t)("action|join"),v=()=>{Am.E.instance.invoke(Kg.s.JoinFromRoomPreview,this.props.roomId)}):(p=(0,l._t)("room|join_title_account"),L.C.getValue(Ye.H.Registration)&&(_=(0,l._t)("room|join_button_account"),v=this.onRegisterClick),y=(0,l._t)("action|sign_in"),f=this.onLoginClick),this.props.previewLoading&&(b=o.createElement("div",null,o.createElement(re.Z,{w:20,h:20}),(0,l._t)("room|loading_preview")));break}case Yg.Kicked:{const{memberName:e,reason:t}=this.getKickOrBanInfo();p=m?(0,l._t)("room|kicked_from_room_by",{memberName:e,roomName:m}):(0,l._t)("room|kicked_by",{memberName:e}),u=t?(0,l._t)("room|kick_reason",{reason:t}):void 0,_=h?(0,l._t)("room|forget_space"):(0,l._t)("room|forget_room"),v=this.props.onForgetClick,this.joinRule()!==n.JoinRule.Invite&&(y=_,f=v,_=(0,l._t)("room|rejoin_button"),v=this.props.onJoinClick);break}case Yg.RequestDenied:p=(0,l._t)("room|knock_denied_title"),u=(0,l._t)("room|knock_denied_subtitle"),_=h?(0,l._t)("room|forget_space"):(0,l._t)("room|forget_room"),v=this.props.onForgetClick;break;case Yg.Banned:{const{memberName:e,reason:t}=this.getKickOrBanInfo();p=m?(0,l._t)("room|banned_from_room_by",{memberName:e,roomName:m}):(0,l._t)("room|banned_by",{memberName:e}),u=t?(0,l._t)("room|kick_reason",{reason:t}):void 0,_=h?(0,l._t)("room|forget_space"):(0,l._t)("room|forget_room"),v=this.props.onForgetClick;break}case Yg.OtherThreePIDError:{var x;p=m?(0,l._t)("room|3pid_invite_error_title_room",{roomName:m}):(0,l._t)("room|3pid_invite_error_title");const e=this.joinRule(),t=(0,l._t)("room|3pid_invite_error_description",{errcode:(null===(x=this.state.threePidFetchError)||void 0===x?void 0:x.errcode)||(0,l._t)("error|unknown_error_code")});switch(e){case"invite":u=[(0,l._t)("room|3pid_invite_error_invite_subtitle"),t],_=(0,l._t)("room|3pid_invite_error_invite_action"),v=this.props.onJoinClick;break;case"public":u=(0,l._t)("room|3pid_invite_error_public_subtitle"),_=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;default:u=t,_=(0,l._t)("room|3pid_invite_error_invite_action"),v=this.props.onJoinClick}break}case Yg.InvitedEmailNotFoundInAccount:p=m?(0,l._t)("room|3pid_invite_email_not_found_account_room",{roomName:m,email:this.props.invitedEmail}):(0,l._t)("room|3pid_invite_email_not_found_account",{email:this.props.invitedEmail}),u=(0,l._t)("room|link_email_to_receive_3pid_invite",{brand:d}),_=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case Yg.InvitedEmailNoIdentityServer:p=m?(0,l._t)("room|invite_sent_to_email_room",{roomName:m,email:this.props.invitedEmail}):(0,l._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),u=(0,l._t)("room|3pid_invite_no_is_subtitle",{brand:d}),_=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case Yg.InvitedEmailMismatch:p=m?(0,l._t)("room|invite_sent_to_email_room",{roomName:m,email:this.props.invitedEmail}):(0,l._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),u=(0,l._t)("room|invite_email_mismatch_suggestion",{brand:d}),_=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case Yg.Invite:{var R,I;const e=o.createElement(ei.Z,{room:this.props.room,oobData:this.props.oobData}),t=this.getInviteMember();let i;i=t?o.createElement("span",null,o.createElement("span",{className:"mx_RoomPreviewBar_inviter"},t.rawDisplayName)," (",t.userId,")"):o.createElement("span",{className:"mx_RoomPreviewBar_inviter"},this.props.inviterName);var P;if(this.isDMInvite())p=(0,l._t)("room|dm_invite_title",{user:null!==(P=null==t?void 0:t.name)&&void 0!==P?P:this.props.inviterName}),u=[e,(0,l._t)("room|dm_invite_subtitle",{},{userName:()=>i})],_=(0,l._t)("room|dm_invite_action");else p=(0,l._t)("room|invite_title",{roomName:m}),u=[e,(0,l._t)("room|invite_subtitle",{},{userName:()=>i})],_=(0,l._t)("action|accept");const n=E.p.safeGet().getSafeUserId(),s=null===(R=this.props.room)||void 0===R?void 0:R.currentState.getMember(n),a=null==s||null===(I=s.events.member)||void 0===I?void 0:I.getContent();null!=a&&a.reason&&(g=o.createElement($g,{reason:a.reason,htmlReason:a["io.element.html_reason"]})),v=this.props.onJoinClick,y=(0,l._t)("action|reject"),f=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&S.push(o.createElement(ae.Z,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},(0,l._t)("room|invite_reject_ignore")));break}case Yg.ViewingRoom:p=this.props.canPreview?(0,l._t)("room|peek_join_prompt",{roomName:m}):m?(0,l._t)("room|no_peek_join_prompt",{roomName:m}):(0,l._t)("room|no_peek_no_name_join_prompt"),_=(0,l._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case Yg.RoomNotFound:p=m?(0,l._t)("room|not_found_title_name",{roomName:m}):(0,l._t)("room|not_found_title"),u=(0,l._t)("room|not_found_subtitle");break;case Yg.OtherError:var T;p=m?(0,l._t)("room|inaccessible_name",{roomName:m}):(0,l._t)("room|inaccessible"),u=[(0,l._t)("room|inaccessible_subtitle_1"),(0,l._t)("room|inaccessible_subtitle_2",{errcode:String(null===(T=this.props.error)||void 0===T?void 0:T.errcode)},{issueLink:e=>o.createElement("a",{href:c.ZP.get().feedback.new_issue_url,target:"_blank",rel:"noreferrer noopener"},e)})];break;case Yg.PromptAskToJoin:var Z;p=m?(0,l._t)("room|knock_prompt_name",{roomName:m}):(0,l._t)("room|knock_prompt");u=[o.createElement(ei.Z,{room:this.props.room,oobData:this.props.oobData}),(0,l._t)("room|knock_subtitle")],g=o.createElement(Vs.Z,{autoFocus:!0,className:"mx_RoomPreviewBar_fullWidth",element:"textarea",onChange:this.onChangeReason,placeholder:(0,l._t)("room|knock_message_field_placeholder"),type:"text",value:null!==(Z=this.state.reason)&&void 0!==Z?Z:""}),v=()=>this.props.onSubmitAskToJoin&&this.props.onSubmitAskToJoin(this.state.reason),_=(0,l._t)("room|knock_send_action");break;case Yg.Knocked:p=(0,l._t)("room|knock_sent"),u=[o.createElement(o.Fragment,null,o.createElement(Jg.J,{className:"mx_Icon mx_Icon_16 mx_RoomPreviewBar_icon"}),(0,l._t)("room|knock_sent_subtitle"))],f=this.props.onCancelAskToJoin,y=(0,l._t)("room|knock_cancel_action")}let N,D,M,O;u&&(Array.isArray(u)||(u=[u]),N=u.map(((e,t)=>o.createElement("p",{key:`subTitle${t}`},e)))),D=w?o.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},o.createElement(re.Z,null),p):o.createElement("h3",null,p),v&&(M=o.createElement(ae.Z,{kind:"primary",onClick:v},_)),f&&(O=o.createElement(ae.Z,{kind:"secondary",onClick:f},y));const A=this.props.canPreview,U=yt()("mx_RoomPreviewBar",`mx_RoomPreviewBar_${C}`,{mx_RoomPreviewBar_panel:A,mx_RoomPreviewBar_dialog:!A}),F=A?o.createElement(o.Fragment,null,O,S,M):o.createElement(o.Fragment,null,M,S,O);return o.createElement("div",{className:U},o.createElement("div",{className:"mx_RoomPreviewBar_message"},D,N),g,o.createElement("div",{className:yt()("mx_RoomPreviewBar_actions",{mx_RoomPreviewBar_fullWidth:C===Yg.PromptAskToJoin})},F),o.createElement("div",{className:"mx_RoomPreviewBar_footer"},b))}}(0,k.Z)(Qg,"defaultProps",{onJoinClick(){}});var Xg=i("../matrix-react-sdk/src/utils/membership.ts");const ev=(e,t=250)=>{const[i,s]=(0,o.useState)(e.getJoinedMembers()),a=(0,o.useMemo)((()=>(0,ln.throttle)((()=>{s(e.getJoinedMembers())}),t,{leading:!0,trailing:!0})),[e,t]);return(0,In.V4)(e.currentState,n.RoomStateEvent.Members,a),i},tv=(e,{throttleWait:t}={throttleWait:250})=>{const[i,s]=(0,o.useState)(e.getJoinedMemberCount()),a=(0,o.useMemo)((()=>(0,ln.throttle)((()=>{s(e.getJoinedMemberCount())}),t,{leading:!0,trailing:!0})),[e,t]);return(0,In.V4)(e.currentState,n.RoomStateEvent.Members,a),(0,In.V4)(e,n.RoomEvent.Summary,a),i},iv=e=>{const[t,i]=(0,o.useState)(e.getMyMembership());return(0,In.V4)(e,n.RoomEvent.MyMembership,(()=>{i(e.getMyMembership())})),t},nv=["room"];function sv(e){let{room:t}=e,i=(0,v.Z)(e,nv);const s=(0,o.useContext)(pn.ZP),a=(0,o.useRef)(null),r=ro(t),c=(0,hn.E_)(null==r?void 0:r.text,null==r?void 0:r.html,a),d=(0,o.useCallback)((e=>{var t;null===(t=i.onClick)||void 0===t||t.call(i,e);if("A"!==e.target.tagName.toUpperCase())return void x.ZP.fire(W.a.ShowRoomTopic);const n=e.target,s=(0,Rt.$D)(n.href);s!==n.href&&(e.preventDefault(),window.location.hash=s)}),[i]);(0,io.P)(x.ZP,(e=>{if(e.action===W.a.ShowRoomTopic){const e=t.currentState.maySendStateEvent(n.EventType.RoomTopic,s.getSafeUserId()),i=(0,hn.E_)(null==r?void 0:r.text,null==r?void 0:r.html,a,!0),c=T.ZP.createDialog(Sl.Z,{title:t.name,description:o.createElement("div",null,o.createElement(hn.zR,{options:{attributes:{onClick(){c.close()}}},as:"p"},i),e&&o.createElement(ae.Z,{kind:"primary_outline",onClick:()=>{c.close(),x.ZP.dispatch({action:"open_room_settings"})}},(0,l._t)("room|edit_topic"))),hasCloseButton:!0,button:!1})}}));const m=yt()(i.className,"mx_RoomTopic");return o.createElement(fr.Z,(0,kt.Z)({},i,{ref:a,onClick:d,dir:"auto",tooltipTargetClassName:m,label:(0,l._t)("room|read_topic"),alignment:si.v.Bottom,ignoreHover:e=>"A"===e.target.tagName.toUpperCase()}),o.createElement(hn.zR,null,c))}var ov=i("../matrix-react-sdk/src/components/views/elements/FacePile.tsx");const av=["room","onlyKnownUsers","numShown"],rv=5,lv=e=>{var t;return!(null===(t=P.Z.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)},cv=e=>{let{room:t,onlyKnownUsers:i=!0,numShown:n=rv}=e,s=(0,v.Z)(e,av);const a=(0,o.useContext)(pn.ZP),r="join"===t.getMyMembership();let c=ev(t);const d=c.length,m=[e=>e.getMxcAvatarUrl()?0:1];i?c=c.filter(lv):m.unshift((e=>lv(e)?0:1));const h=(0,ln.sortBy)(c.filter((e=>e.userId!==a.getUserId())),m).slice(0,n);if(h.length<1)return null;const p=h.map((e=>e.name)).reverse().join(", ");return o.createElement(ov.Z,(0,kt.Z)({members:h,size:"28px",overflow:c.length>n,tooltipLabel:s.onClick?(0,l._t)("room|face_pile_tooltip_label",{count:d}):(0,l._t)("common|n_members",{count:d}),tooltipShortcut:r?(0,l._t)("room|face_pile_tooltip_shortcut_joined",{commaSeparatedMembers:p}):(0,l._t)("room|face_pile_tooltip_shortcut",{commaSeparatedMembers:p})},s),i&&o.createElement("span",{className:"mx_FacePile_summary"},(0,l._t)("room|face_pile_summary",{count:c.length})))},dv=({room:e})=>{const t=(0,Pn.G)((async()=>{if("invite"!==e.getMyMembership())return null;try{return await e.client.getRoomSummary(e.roomId)}catch(e){return null}}),[e]),i=(0,go.c)(e,(e=>e.getJoinRule())),s=iv(e),a=tv(e),r=(0,wt.n)("feature_element_call_video_rooms");let c,d,m;if(e.isElementVideoRoom()||r&&e.isCallRoom()?(c="mx_RoomInfoLine_video",d=(0,l._t)("common|video_room")):i===n.JoinRule.Public?(c="mx_RoomInfoLine_public",d=e.isSpaceRoom()?(0,l._t)("common|public_space"):(0,l._t)("common|public_room")):(c="mx_RoomInfoLine_private",d=e.isSpaceRoom()?(0,l._t)("common|private_space"):(0,l._t)("common|private_room")),"invite"===s&&t)m=o.createElement("span",{className:"mx_RoomInfoLine_members"},(0,l._t)("common|n_members",{count:t.num_joined_members}));else if(a&&void 0!==t){const t=()=>nm.Z.instance.setCard({phase:e.isSpaceRoom()?im.q.SpaceMemberList:im.q.RoomMemberList});m=o.createElement(ae.Z,{kind:"link",className:"mx_RoomInfoLine_members",onClick:t},(0,l._t)("common|n_members",{count:a}))}return o.createElement("div",{className:`mx_RoomInfoLine ${c}`},d,m)},mv=({room:e,onJoinButtonClicked:t,onRejectButtonClicked:i})=>{const s=(0,o.useContext)(pn.ZP),a=(0,wt.n)("feature_video_rooms"),r=(0,wt.n)("feature_element_call_video_rooms"),c=e.isElementVideoRoom()||r&&e.isCallRoom(),d=iv(e);(0,io.P)(x.ZP,(t=>{t.action===W.a.JoinRoomError&&t.roomId===e.roomId&&h(!1)}));const[m,h]=(0,o.useState)(!1),p=(0,go.c)(e,(e=>e.getJoinRule())),u=(0,Xg.rK)(d)===Xg.mK.Leave&&p!==n.JoinRule.Public,g=()=>x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.Labs});let v,_,f=null;if("join"===d)v=o.createElement(ae.Z,{kind:"danger_outline",onClick:()=>{x.ZP.dispatch({action:"leave_room",room_id:e.roomId})}},(0,l._t)("action|leave"));else if("invite"===d){var E,y;const n=null===(E=e.getMember(s.getUserId()))||void 0===E||null===(y=E.events.member)||void 0===y?void 0:y.getSender();if(n){const t=e.getMember(n);f=o.createElement("div",{className:"mx_RoomPreviewCard_inviter"},o.createElement(Vt.Z,{member:t,fallbackUserId:n,size:"32px"}),o.createElement("div",null,o.createElement("div",{className:"mx_RoomPreviewCard_inviter_name"},(0,l._t)("room|invites_you_text",{},{inviter:()=>o.createElement("b",null,(null==t?void 0:t.name)||n)})),t?o.createElement("div",{className:"mx_RoomPreviewCard_inviter_mxid"},n):null))}v=o.createElement(o.Fragment,null,o.createElement(ae.Z,{kind:"primary_outline",onClick:()=>{h(!0),i()}},(0,l._t)("action|reject")),o.createElement(ae.Z,{kind:"primary",onClick:()=>{h(!0),t()}},(0,l._t)("action|accept")))}else v=o.createElement(ae.Z,{kind:"primary",onClick:()=>{t(),s.isGuest()||h(!0)},disabled:u},(0,l._t)("action|join"));m&&(v=o.createElement(_r.Z,null)),_=c?o.createElement(o.Fragment,null,o.createElement(ei.Z,{room:e,size:"50px",viewAvatarOnClick:!0}),o.createElement("div",{className:"mx_RoomPreviewCard_video"}),o.createElement(pr.r,{onClick:g,tooltipTitle:(0,l._t)("labs|video_rooms_beta")})):e.isSpaceRoom()?o.createElement(ei.Z,{room:e,size:"80px",viewAvatarOnClick:!0}):o.createElement(ei.Z,{room:e,size:"50px",viewAvatarOnClick:!0});let b=null;return u?b=(0,l._t)("room|join_failed_needs_invite",{roomName:e.name}):c&&!a&&(b="join"===d?(0,l._t)("room|view_failed_enable_video_rooms"):(0,l._t)("room|join_failed_enable_video_rooms"),v=o.createElement(ae.Z,{kind:"primary",onClick:g},(0,l._t)("room|show_labs_settings"))),o.createElement("div",{className:"mx_RoomPreviewCard"},f,o.createElement("div",{className:"mx_RoomPreviewCard_avatar"},_),o.createElement("h1",{className:"mx_RoomPreviewCard_name"},o.createElement($s,{room:e})),o.createElement(dv,{room:e}),o.createElement(sv,{room:e,className:"mx_RoomPreviewCard_topic"}),"public"===e.getJoinRule()&&o.createElement(cv,{room:e}),b?o.createElement("div",{className:"mx_RoomPreviewCard_notice"},b):null,o.createElement("div",{className:"mx_RoomPreviewCard_joinButtons"},v))};let hv=function(e){return e.Room="Room",e.All="All",e}({});class pv extends o.Component{constructor(e){super(e),(0,k.Z)(this,"searchTerm",(0,o.createRef)()),(0,k.Z)(this,"onThisRoomClick",(()=>{this.setState({scope:hv.Room},(()=>this.searchIfQuery()))})),(0,k.Z)(this,"onAllRoomsClick",(()=>{this.setState({scope:hv.All},(()=>this.searchIfQuery()))})),(0,k.Z)(this,"onSearchChange",(e=>{switch((0,dr.zL)().getAccessibilityAction(e)){case tn.vB.Enter:this.onSearch();break;case tn.vB.Escape:this.props.onCancelClick()}})),(0,k.Z)(this,"onSearch",(()=>{var e;null!==(e=this.searchTerm.current)&&void 0!==e&&e.value.trim()&&this.props.onSearch(this.searchTerm.current.value,this.state.scope)})),this.state={scope:hv.Room}}searchIfQuery(){var e;null!==(e=this.searchTerm.current)&&void 0!==e&&e.value&&this.onSearch()}render(){const e=yt()("mx_SearchBar_searchButton",{mx_SearchBar_searching:this.props.searchInProgress}),t=yt()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==hv.Room}),i=yt()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==hv.All});return o.createElement(o.Fragment,null,o.createElement(kn.S,{screenName:"RoomSearch"}),o.createElement("div",{className:"mx_SearchBar"},o.createElement("div",{className:"mx_SearchBar_buttons",role:"radiogroup"},o.createElement(ae.Z,{className:t,onClick:this.onThisRoomClick,"aria-checked":this.state.scope===hv.Room,role:"radio"},(0,l._t)("room|search|this_room")),o.createElement(ae.Z,{className:i,onClick:this.onAllRoomsClick,"aria-checked":this.state.scope===hv.All,role:"radio"},(0,l._t)("room|search|all_rooms"))),o.createElement("div",{className:"mx_SearchBar_input mx_textinput"},o.createElement("input",{ref:this.searchTerm,type:"text",autoFocus:!0,placeholder:(0,l._t)("room|search|field_placeholder"),"aria-label":this.state.scope===hv.Room?(0,l._t)("room|search|this_room_button"):(0,l._t)("room|search|all_rooms_button"),onKeyDown:this.onSearchChange}),o.createElement(ae.Z,{className:e,onClick:this.onSearch,"aria-label":(0,l._t)("action|search")})),o.createElement(ae.Z,{className:"mx_SearchBar_cancel",onClick:this.props.onCancelClick,"aria-label":(0,l._t)("action|cancel")})),o.createElement(Iu,{isRoomEncrypted:this.props.isRoomEncrypted,kind:Ru.Search}))}}var uv=i("../matrix-react-sdk/src/components/views/dialogs/RoomUpgradeDialog.tsx");class gv extends o.PureComponent{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"onStateEvents",(e=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const t=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:t&&t.getContent().replacement_room})})),(0,k.Z)(this,"onUpgradeClick",(()=>{T.ZP.createDialog(uv.Z,{room:this.props.room})}));const i=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.state={upgraded:null==i?void 0:i.getContent().replacement_room}}componentDidMount(){this.context.on(n.RoomStateEvent.Events,this.onStateEvents)}componentWillUnmount(){this.context.removeListener(n.RoomStateEvent.Events,this.onStateEvents)}render(){let e=o.createElement("div",null,o.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.createElement("p",null,(0,l._t)("room|upgrade_warning_bar")),o.createElement("p",null,(0,l._t)("room_settings|advanced|room_upgrade_warning",{},{b:e=>o.createElement("b",null,e),i:e=>o.createElement("i",null,e)}))),o.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},o.createElement(ae.Z,{onClick:this.onUpgradeClick},(0,l._t)("room_settings|advanced|room_upgrade_button"))));return this.state.upgraded&&(e=o.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.createElement("p",null,(0,l._t)("room|upgrade_warning_bar_upgraded")))),o.createElement("div",{className:"mx_RoomUpgradeWarningBar"},o.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},o.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},(0,l._t)("room|upgrade_warning_bar_unstable",{},{roomVersion:()=>o.createElement("code",null,this.props.room.getVersion()),i:e=>o.createElement("i",null,e)})),e,o.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},(0,l._t)("room|upgrade_warning_bar_admins"))))}}(0,k.Z)(gv,"contextType",pn.ZP);var vv=function(e){return e.CloseScalar="close_scalar",e.GetWidgets="get_widgets",e.SetWidget="set_widget",e.JoinRulesState="join_rules_state",e.SetPlumbingState="set_plumbing_state",e.GetMembershipCount="get_membership_count",e.GetRoomEncryptionState="get_room_enc_state",e.CanSendEvent="can_send_event",e.MembershipState="membership_state",e.invite="invite",e.Kick="kick",e.BotOptions="bot_options",e.SetBotOptions="set_bot_options",e.SetBotPower="set_bot_power",e.GetOpenIdToken="get_open_id_token",e.SendEvent="send_event",e.ReadEvents="read_events",e}(vv||{});function _v(e,t){const i=(0,ni.zs)(e.data);i.response=t,e.source.postMessage(i,e.origin)}function fv(e,t,i){r.k.error("Action:"+e.data.action+" failed with message: "+t);const n=(0,ni.zs)(e.data);n.response={error:{message:t}},i&&(n.response.error._error=i),e.source.postMessage(n,e.origin)}function Ev(e,t){const i=E.p.safeGet(),n=e.data.widget_id;let s=e.data.type;const o=e.data.url,a=e.data.name,r=e.data.data,c=e.data.avatar_url,d=e.data.userWidget;if(n&&void 0!==o){if(null!==o){if(void 0!==a&&"string"!=typeof a)return void fv(e,(0,l._t)("scalar|error_create"),new Error("Optional field 'name' must be a string."));if(void 0!==r&&!(r instanceof Object))return void fv(e,(0,l._t)("scalar|error_create"),new Error("Optional field 'data' must be an Object."));if(void 0!==c&&"string"!=typeof c)return void fv(e,(0,l._t)("scalar|error_create"),new Error("Optional field 'avatar_url' must be a string."));if("string"!=typeof s)return void fv(e,(0,l._t)("scalar|error_create"),new Error("Field 'type' must be a string."));if("string"!=typeof o)return void fv(e,(0,l._t)("scalar|error_create"),new Error("Field 'url' must be a string or null."))}if(s=Zm.l.fromString(s),d)Sm.Z.setUserWidget(i,n,s,o,a,r).then((()=>{_v(e,{success:!0}),x.ZP.dispatch({action:"user_widget_updated"})})).catch((t=>{fv(e,(0,l._t)("scalar|error_create"),t)}));else{if(!t)return void fv(e,(0,l._t)("scalar|error_missing_room_id"));Sm.Z.setRoomWidget(i,t,n,s,o,a,r,c).then((()=>{_v(e,{success:!0})}),(t=>{fv(e,(0,l._t)("scalar|error_send_request"),t)}))}}else fv(e,(0,l._t)("scalar|error_create"),new Error("Missing required widget fields."))}function yv(e,t){const i=E.p.get();if(!i)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));let n=[];if(t){const s=i.getRoom(t);if(!s)return void fv(e,(0,l._t)("scalar|error_room_unknown"));n=Sm.Z.getRoomWidgets(s).map((e=>e.event))}const s=Sm.Z.getUserWidgetsArray(i);n=n.concat(s),_v(e,n)}function bv(e,t,i,n){const s=E.p.get();if(!s)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const o=s.getRoom(t);if(!o)return void fv(e,(0,l._t)("scalar|error_room_unknown"));const a=o.currentState.getStateEvents(i,n);_v(e,a?a.getContent():null)}const wv=function(e){let t,i;e.origin||(e.origin=e.originalEvent.origin);try{var s;Sv||(Sv=null===(s=B.B.sharedInstance().getPrimaryManager())||void 0===s?void 0:s.uiUrl),t=new URL(Sv)}catch(e){return}try{i=new URL(e.origin)}catch(e){return}if(t.origin!==i.origin||!e.data.action||e.data.api)return;if(e.data.action===vv.CloseScalar)return x.ZP.dispatch({action:vv.CloseScalar}),void _v(e,null);const o=e.data.room_id,a=e.data.user_id;if(!o)return e.data.action===vv.GetWidgets?void yv(e,null):e.data.action===vv.SetWidget?void Ev(e,null):e.data.action===vv.GetOpenIdToken?void async function(e){try{_v(e,await E.p.safeGet().getOpenIdToken())}catch(t){r.k.warn("Unable to fetch openId token.",t),fv(e,"Unable to fetch openId token.")}}(e):void fv(e,(0,l._t)("scalar|error_missing_room_id_request"));if(o===ie.m.instance.roomViewStore.getRoomId())if(e.data.action!==vv.GetWidgets)if(e.data.action!==vv.SetWidget)if(e.data.action!==vv.JoinRulesState)if(e.data.action!==vv.SetPlumbingState)if(e.data.action!==vv.GetMembershipCount)if(e.data.action!==vv.GetRoomEncryptionState)if(e.data.action!==vv.CanSendEvent)if(e.data.action!==vv.SendEvent)if(e.data.action!==vv.ReadEvents)if(a)switch(e.data.action){case vv.MembershipState:!function(e,t,i){r.k.log(`membership_state of ${i} in room ${t} requested.`),bv(e,t,"m.room.member",i)}(e,o,a);break;case vv.invite:!function(e,t,i){r.k.log(`Received request to invite ${i} into room ${t}`);const n=E.p.get();if(!n)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const s=n.getRoom(t);if(s){const t=s.getMember(i);if(t&&["join","invite"].includes(t.membership))return void _v(e,{success:!0})}n.invite(t,i).then((function(){_v(e,{success:!0})}),(function(t){fv(e,(0,l._t)("widget|error_need_invite_permission"),t)}))}(e,o,a);break;case vv.Kick:!function(e,t,i){r.k.log(`Received request to kick ${i} from room ${t}`);const n=E.p.get();if(!n)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const s=n.getRoom(t);if(s){const t=s.getMember(i);if(!t||(0,Xg.rK)(t.membership)===Xg.mK.Leave)return void _v(e,{success:!0})}const o=e.data.reason;n.kick(t,i,o).then((()=>{_v(e,{success:!0})})).catch((t=>{fv(e,(0,l._t)("widget|error_need_kick_permission"),t)}))}(e,o,a);break;case vv.BotOptions:!function(e,t,i){r.k.log(`bot_options of ${i} in room ${t} requested.`),bv(e,t,"m.room.bot.options","_"+i)}(e,o,a);break;case vv.SetBotOptions:!function(e,t,i){r.k.log(`Received request to set options for bot ${i} in room ${t}`);const n=E.p.get();n?n.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+i).then((()=>{_v(e,{success:!0})}),(t=>{fv(e,t.message?t.message:(0,l._t)("scalar|error_send_request"),t)})):fv(e,(0,l._t)("widget|error_need_to_be_logged_in"))}(e,o,a);break;case vv.SetBotPower:!async function(e,t,i,s,o){if(!(Number.isInteger(s)&&s>=0))return void fv(e,(0,l._t)("scalar|error_power_level_invalid"));r.k.log(`Received request to set power level to ${s} for bot ${i} in room ${t}.`);const a=E.p.get();if(a)try{const r=await a.getStateEvent(t,"m.room.power_levels","");var c,d,m;if(!0===o)if((null!==(c=null!==(d=null===(m=r.users)||void 0===m?void 0:m[i])&&void 0!==d?d:r.users_default)&&void 0!==c?c:0)>=s)return _v(e,{success:!0});return await a.setPowerLevel(t,i,s,new n.MatrixEvent({type:"m.room.power_levels",content:r})),_v(e,{success:!0})}catch(t){var h;const i=t instanceof Error?t:void 0;fv(e,null!==(h=null==i?void 0:i.message)&&void 0!==h?h:(0,l._t)("scalar|error_send_request"),i)}else fv(e,(0,l._t)("widget|error_need_to_be_logged_in"))}(e,o,a,e.data.level,e.data.ignoreIfGreater);break;default:r.k.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else fv(e,(0,l._t)("scalar|error_missing_user_id_request"));else!async function(e,t){const i=e.data.type,n=e.data.state_key,s=e.data.limit;if("string"!=typeof i)return void fv(e,(0,l._t)("scalar|failed_read_event"),new Error("Invalid 'type' in request"));if(!["m.room.power_levels","m.room.encryption","m.room.member","m.room.name","m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(i))return void fv(e,(0,l._t)("scalar|failed_read_event"),new Error("Disallowed 'type' in request"));let o;if(void 0!==s){if("number"!=typeof s||s<0)return void fv(e,(0,l._t)("scalar|failed_read_event"),new Error("Invalid 'limit' in request"));o=Math.min(s,Number.MAX_SAFE_INTEGER)}else o=Number.MAX_SAFE_INTEGER;const a=E.p.get();if(!a)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const r=a.getRoom(t);if(r){if(void 0!==n){if("string"!=typeof n&&!0!==n)return void fv(e,(0,l._t)("scalar|failed_read_event"),new Error("Invalid 'state_key' in request"));const t=!0===n?void 0:n;let s=[];return s=s.concat(r.currentState.getStateEvents(i,t)||[]),s=s.slice(0,o),void _v(e,{events:s.map((e=>e.getEffectiveEvent()))})}fv(e,(0,l._t)("scalar|failed_read_event"),new Error("Reading message events is not implemented"))}else fv(e,(0,l._t)("scalar|error_room_unknown"))}(e,o);else!async function(e,t){const i=e.data.type,n=e.data.state_key,s=e.data.content;if("string"!=typeof i)return void fv(e,(0,l._t)("scalar|failed_send_event"),new Error("Invalid 'type' in request"));if(!["m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(i))return void fv(e,(0,l._t)("scalar|failed_send_event"),new Error("Disallowed 'type' in request"));if(!s||"object"!=typeof s)return void fv(e,(0,l._t)("scalar|failed_send_event"),new Error("Invalid 'content' in request"));const o=E.p.get();if(!o)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));if(o.getRoom(t))if(void 0!==n)try{_v(e,{room_id:t,event_id:(await o.sendStateEvent(t,i,s,n)).event_id})}catch(t){return void fv(e,(0,l._t)("scalar|failed_send_event"),t)}else fv(e,(0,l._t)("scalar|failed_send_event"),new Error("Sending message events is not implemented"));else fv(e,(0,l._t)("scalar|error_room_unknown"))}(e,o);else!function(e,t){const i=""+e.data.event_type,n=Boolean(e.data.is_state),s=E.p.get();if(!s)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const o=s.getRoom(t);if(!o)return void fv(e,(0,l._t)("scalar|error_room_unknown"));if("join"!==o.getMyMembership())return void fv(e,(0,l._t)("scalar|error_membership"));const a=s.credentials.userId;let r;r=n?o.currentState.maySendStateEvent(i,a):o.currentState.maySendEvent(i,a),r?_v(e,!0):fv(e,(0,l._t)("scalar|error_permission"))}(e,o);else!function(e,t){const i=E.p.get();if(!i)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));if(!i.getRoom(t))return void fv(e,(0,l._t)("scalar|error_room_unknown"));_v(e,E.p.safeGet().isRoomEncrypted(t))}(e,o);else!function(e,t){const i=E.p.get();if(!i)return void fv(e,(0,l._t)("widget|error_need_to_be_logged_in"));const n=i.getRoom(t);if(!n)return void fv(e,(0,l._t)("scalar|error_room_unknown"));_v(e,n.getJoinedMemberCount())}(e,o);else!function(e,t,i){if("string"!=typeof i)throw new Error("Plumbing state status should be a string");r.k.log(`Received request to set plumbing state to status "${i}" in room ${t}`);const n=E.p.get();n?n.sendStateEvent(t,"m.room.plumbing",{status:i}).then((()=>{_v(e,{success:!0})}),(t=>{fv(e,t.message?t.message:(0,l._t)("scalar|error_send_request"),t)})):fv(e,(0,l._t)("widget|error_need_to_be_logged_in"))}(e,o,e.data.status);else!function(e,t){r.k.log(`join_rules of ${t} requested.`),bv(e,t,"m.room.join_rules","")}(e,o);else Ev(e,o);else yv(e,o);else fv(e,(0,l._t)("scalar|error_room_not_visible",{roomId:o}))};let Sv,Cv=0;class kv extends Ya{start(e){this.vertical?e.style.minHeight="":e.style.minWidth=""}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const i=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=i,e.style.height=i}else{const i=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=i,e.style.width=i}}}class xv extends Xa{static createSizer(e,t,i){return new kv(e,t,i)}}var Rv=i("../matrix-react-sdk/src/utils/numbers.ts");class Iv extends o.Component{constructor(e){super(e),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"resizeContainer",void 0),(0,k.Z)(this,"resizer",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"onIsResizing",(e=>{this.setState({resizingVertical:e}),e||this.relaxResizer()})),(0,k.Z)(this,"collectResizer",(e=>{this.resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this.resizeContainer=e,this.loadResizerPreferences()})),(0,k.Z)(this,"getAppsHash",(e=>e.map((e=>e.id)).join("~"))),(0,k.Z)(this,"relaxResizer",(()=>{const e=this.resizer.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))})),(0,k.Z)(this,"loadResizerPreferences",(()=>{const e=Nm.z3.instance.getResizerDistributions(this.props.room,Nm.W2.Top);if(this.state.apps&&this.topApps().length-1===e.length)e.forEach(((e,t)=>{const i=this.resizer.forHandleAt(t);i&&(i.size=e,i.finish())}));else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach((e=>e.item.clearSize())),e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}})),(0,k.Z)(this,"onAction",(e=>{const t=this.props.room.roomId+"_hide_widget_drawer";if("appsDrawer"===e.action)e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")})),(0,k.Z)(this,"getApps",(()=>({[Nm.W2.Top]:Nm.z3.instance.getContainerWidgets(this.props.room,Nm.W2.Top),[Nm.W2.Center]:Nm.z3.instance.getContainerWidgets(this.props.room,Nm.W2.Center)}))),(0,k.Z)(this,"topApps",(()=>this.state.apps[Nm.W2.Top])),(0,k.Z)(this,"centerApps",(()=>this.state.apps[Nm.W2.Center])),(0,k.Z)(this,"updateApps",(()=>{this.unmounted||this.setState({apps:this.getApps()})})),this.state={apps:this.getApps(),resizingVertical:!1,resizingHorizontal:!1,resizing:!1},this.resizer=this.createResizer(),this.props.resizeNotifier.on("isResizing",this.onIsResizing)}componentDidMount(){0===Cv&&window.addEventListener("message",wv,!1),Cv+=1,Nm.z3.instance.on(Nm.z3.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef=x.ZP.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,function(){if(Cv-=1,0===Cv&&window.removeEventListener("message",wv),Cv<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");r.k.error(e)}}(),Nm.z3.instance.off(Nm.z3.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef),this.resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}createResizer(){const e={onResizeStart:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.add("mx_AppsDrawer--resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.remove("mx_AppsDrawer--resizing"),Nm.z3.instance.setResizerDistributions(this.props.room,Nm.W2.Top,this.topApps().slice(1).map(((e,t)=>this.resizer.forHandleAt(t).size))),this.setState({resizingHorizontal:!1})}},t=new ir(null,xv,e);return t.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),t}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this.updateApps():this.getAppsHash(this.topApps())!==this.getAppsHash(t.apps[Nm.W2.Top])&&this.loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}render(){if(!this.props.showApps)return o.createElement("div",null);const e=this.centerApps().length>0,t=(e?this.centerApps():this.topApps()).map(((e,t,i)=>o.createElement(Eu,{key:e.id,app:e,fullWidth:i.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:Sm.Z.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0})));if(0===t.length)return o.createElement("div",null);let i;0===t.length&&Gg.Z.roomHasPendingWidgets(this.props.room.roomId,Sm.Z.getRoomWidgets(this.props.room))&&(i=o.createElement(re.Z,null));const n=yt()({mx_AppsDrawer:!0,"mx_AppsDrawer--maximised":e,"mx_AppsDrawer--resizing":this.state.resizing,"mx_AppsDrawer--2apps":2===t.length,"mx_AppsDrawer--3apps":3===t.length}),s=o.createElement("div",{className:"mx_AppsContainer",ref:this.collectResizer},t.map(((e,i)=>i<1?e:o.createElement(o.Fragment,{key:e.key},o.createElement($a,{reverse:i>t.length/2}),e))));let a;return a=e?s:o.createElement(Pv,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight-50,className:"mx_AppsDrawer_resizer",handleWrapperClass:"mx_AppsDrawer_resizer_container",handleClass:"mx_AppsDrawer_resizer_container_handle",resizeNotifier:this.props.resizeNotifier},s),o.createElement("div",{className:n},a,i)}}(0,k.Z)(Iv,"defaultProps",{showApps:!0});const Pv=({room:e,minHeight:t,maxHeight:i,className:n,handleWrapperClass:s,handleClass:a,resizeNotifier:r,children:l})=>{let c=Nm.z3.instance.getContainerHeight(e,Nm.W2.Top);return t||(t=100),i||(i=mr.default.instance.windowHeight/4*3),c?(c=(0,Rv.uZ)(c,0,100),c=(0,Rv.no)(c/100,t,i)):c=280,o.createElement(em.e,{size:{height:Math.min(c,i),width:void 0},minHeight:t,maxHeight:i,onResizeStart:()=>{r.startResizing()},onResize:()=>{r.notifyTimelineHeightChanged()},onResizeStop:(n,s,o,a)=>{let l=c+a.height;l=100*(0,Rv.Gc)(l,t,i),Nm.z3.instance.setContainerHeight(e,Nm.W2.Top,l),r.stopResizing()},className:n,handleWrapperClass:s,handleClasses:{bottom:a},enable:{bottom:!0}},l)};var Tv=i("../matrix-js-sdk/src/webrtc/callEventTypes.ts");class Zv extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"element",void 0),(0,k.Z)(this,"setElementRef",(e=>{var t;e?(this.element=e,e.addEventListener("resize",this.onResize)):null===(t=this.element)||void 0===t||t.removeEventListener("resize",this.onResize)})),(0,k.Z)(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}),this.playMedia()})),(0,k.Z)(this,"onMuteStateChanged",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})})),(0,k.Z)(this,"onResize",(e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)})),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.updateFeed(null,this.props.feed),this.playMedia()}componentWillUnmount(){this.updateFeed(this.props.feed,null)}componentDidUpdate(e,t){this.updateFeed(e.feed,this.props.feed),t.videoMuted===this.state.videoMuted&&e.feed.stream===this.props.feed.stream||this.playMedia()}static getDerivedStateFromProps(e){return{audioMuted:e.feed.isAudioMuted(),videoMuted:e.feed.isVideoMuted()}}updateFeed(e,t){e!==t&&(e&&(this.props.feed.removeListener($d.EB.NewStream,this.onNewStream),this.props.feed.removeListener($d.EB.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===Tv.K.Usermedia&&this.props.feed.measureVolumeActivity(!1),this.stopMedia()),t&&(this.props.feed.addListener($d.EB.NewStream,this.onNewStream),this.props.feed.addListener($d.EB.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===Tv.K.Usermedia&&this.props.feed.measureVolumeActivity(!0),this.playMedia()))}async playMedia(){const e=this.element;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.play()}catch(e){r.k.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element;e&&(e.pause(),e.removeAttribute("src"))}render(){const{pipMode:e,primary:t,secondary:i,feed:n}=this.props,s=yt()("mx_VideoFeed",{mx_VideoFeed_primary:t,mx_VideoFeed_secondary:i,mx_VideoFeed_voice:this.state.videoMuted}),a=yt()("mx_VideoFeed_mic",{mx_VideoFeed_mic_muted:this.state.audioMuted,mx_VideoFeed_mic_unmuted:!this.state.audioMuted});let r,l;if(n.purpose===Tv.K.Screenshare||t||e||(r=o.createElement("div",{className:a})),this.state.videoMuted){var c;const i=lt.ZP.instance.roomIdForCall(this.props.call),n=null!==(c=i?E.p.safeGet().getRoom(i):void 0)&&void 0!==c?c:void 0;let s;e&&t?s="76px":e&&!t?s="16px":!e&&t&&(s="160px"),l=o.createElement(ei.Z,{room:n,size:s})}else{const e=yt()("mx_VideoFeed_video",{mx_VideoFeed_video_mirror:this.props.feed.isLocal()&&this.props.feed.purpose===Tv.K.Usermedia&&L.C.getValue("VideoView.flipVideoHorizontally")});l=o.createElement("video",{className:e,ref:this.setElementRef})}return o.createElement("div",{className:s},r,l)}}class Nv extends o.Component{render(){const e=this.props.feeds.map((e=>o.createElement(Zv,{key:e.stream.id,feed:e,call:this.props.call,primary:!1,pipMode:this.props.pipMode}))),t=yt()("mx_LegacyCallViewSidebar",{mx_LegacyCallViewSidebar_pipMode:this.props.pipMode});return o.createElement("div",{className:t},e)}}const Dv=({onExpand:e,onPin:t,onMaximize:i})=>o.createElement("div",{className:"mx_LegacyCallViewHeader_controls"},i&&o.createElement(gs.Z,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_fullscreen",onClick:i,title:(0,l._t)("voip|maximise")}),t&&o.createElement(gs.Z,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_pin",onClick:t,title:(0,l._t)("action|pin")}),e&&o.createElement(gs.Z,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_expand",onClick:e,title:(0,l._t)("voip|expand")})),Mv=({callRoom:e})=>o.createElement("span",{className:"mx_LegacyCallViewHeader_secondaryCallInfo"},o.createElement(ei.Z,{room:e,size:"16px"}),o.createElement("span",{className:"mx_LegacyCallView_secondaryCall_roomName"},(0,l._t)("voip|on_hold",{name:e.name}))),Ov=({pipMode:e=!1,callRooms:t,onPipMouseDown:i,onExpand:n,onPin:s,onMaximize:a})=>{const[r,c]=t,d=r.name;return e?o.createElement("div",{className:"mx_LegacyCallViewHeader mx_LegacyCallViewHeader_pip",onMouseDown:i},o.createElement(ei.Z,{room:r,size:"32px"}),o.createElement("div",{className:"mx_LegacyCallViewHeader_callInfo"},o.createElement("div",{className:"mx_LegacyCallViewHeader_roomName"},d),c&&o.createElement(Mv,{callRoom:c})),o.createElement(Dv,{onExpand:n,onPin:s,onMaximize:a})):o.createElement("div",{className:"mx_LegacyCallViewHeader"},o.createElement("div",{className:"mx_LegacyCallViewHeader_icon"}),o.createElement("span",{className:"mx_LegacyCallViewHeader_text"},(0,l._t)("action|call")),o.createElement(Dv,{onMaximize:a}))};class Av extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onHoldClick",(()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()})),(0,k.Z)(this,"onUnholdClick",(()=>{lt.ZP.instance.setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()})),(0,k.Z)(this,"onTransferClick",(()=>{lt.ZP.instance.showTransferDialog(this.props.call),this.props.onFinished()}))}render(){const e=this.props.call.isRemoteOnHold()?(0,l._t)("action|resume"):(0,l._t)("action|hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let i;return this.props.call.opponentCanBeTransferred()&&(i=o.createElement(ii.sN,{className:"mx_LegacyCallContextMenu_item",onClick:this.onTransferClick},(0,l._t)("action|transfer"))),o.createElement(ii.ZP,this.props,o.createElement(ii.sN,{className:"mx_LegacyCallContextMenu_item",onClick:t},e),i)}}var Lv=i("../matrix-react-sdk/src/components/views/voip/DialPad.tsx");class Uv extends o.Component{constructor(e){super(e),(0,k.Z)(this,"numberEntryFieldRef",(0,o.createRef)()),(0,k.Z)(this,"onDigitPress",((e,t)=>{var i;(this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(i=this.numberEntryFieldRef.current)||void 0===i||i.focus())})),(0,k.Z)(this,"onCancelClick",(()=>{this.props.onFinished()})),(0,k.Z)(this,"onKeyDown",(e=>{"Backspace"!==e.code&&"Delete"!==e.code||e.preventDefault()})),(0,k.Z)(this,"onChange",(e=>{this.setState({value:e.target.value})})),this.state={value:""}}render(){return o.createElement(ii.ZP,this.props,o.createElement("div",{className:"mx_DialPadContextMenuWrapper"},o.createElement("div",null,o.createElement(ae.Z,{className:"mx_DialPadContextMenu_cancel",onClick:this.onCancelClick})),o.createElement("div",{className:"mx_DialPadContextMenu_header"},o.createElement(Vs.Z,{ref:this.numberEntryFieldRef,className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onKeyDown:this.onKeyDown,onChange:this.onChange})),o.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},o.createElement(Lv.ZP,{onDigitPress:this.onDigitPress,hasDial:!1}))))}}const Fv=["deviceKinds"],Bv={[Ka.C.AudioInput]:(0,l.I8)("voip|input_devices"),[Ka.C.AudioOutput]:(0,l.I8)("voip|output_devices"),[Ka.C.VideoInput]:(0,l.I8)("common|cameras")},Vv=({label:e,selected:t,onClick:i})=>o.createElement(ur.fL,{iconClassName:"mx_DeviceContextMenu_device_icon",label:e,active:t,onClick:i}),jv=({deviceKind:e})=>{const[t,i]=(0,o.useState)([]),[n,s]=(0,o.useState)(Ka.ZP.getDevice(e));(0,o.useEffect)((()=>{(async()=>{var t,n;i(null!==(t=null===(n=await Ka.ZP.getDevices())||void 0===n?void 0:n[e])&&void 0!==t?t:[])})()}),[e]);return o.createElement(ur.I2,{label:(0,l._t)(Bv[e])},t.map((({label:t,deviceId:i})=>o.createElement(Vv,{key:i,label:t,selected:n===i,onClick:()=>(t=>{Ka.ZP.instance.setDevice(t,e),s(t)})(i)}))))},zv=e=>{let{deviceKinds:t}=e,i=(0,v.Z)(e,Fv);return o.createElement(ur.ZP,(0,kt.Z)({compact:!0,className:"mx_DeviceContextMenu"},i),t.map((e=>o.createElement(jv,{key:e,deviceKind:e}))))},Wv=["children","state","className","onLabel","offLabel"],Hv=["state","deviceKinds"],Gv=e=>{let{children:t,state:i,className:n,onLabel:s,offLabel:a}=e,r=(0,v.Z)(e,Wv);const l=yt()("mx_LegacyCallViewButtons_button",n,{mx_LegacyCallViewButtons_button_on:i,mx_LegacyCallViewButtons_button_off:!i});return o.createElement(gs.Z,(0,kt.Z)({className:l,title:i?s:a,alignment:si.v.Top},r),t)},Kv=e=>{let{state:t,deviceKinds:i}=e,n=(0,v.Z)(e,Hv);const[s,a,r,l]=(0,ii.av)(),[c,d]=(0,o.useState)(!1),m=yt()("mx_LegacyCallViewButtons_button","mx_LegacyCallViewButtons_dropdownButton",{mx_LegacyCallViewButtons_dropdownButton_collapsed:!s});return o.createElement(Gv,(0,kt.Z)({inputRef:a,forceHide:s||c,state:t},n),o.createElement(Gv,{className:m,onClick:e=>{e.stopPropagation(),r()},onHover:e=>d(e),state:t}),s&&a.current&&o.createElement(zv,(0,kt.Z)({},(0,ii.xT)(a.current.getBoundingClientRect()),{onFinished:l,deviceKinds:i})))};class qv extends o.Component{constructor(e){super(e),(0,k.Z)(this,"dialpadButton",(0,o.createRef)()),(0,k.Z)(this,"contextMenuButton",(0,o.createRef)()),(0,k.Z)(this,"controlsHideTimer",null),(0,k.Z)(this,"onControlsHideTimer",(()=>{this.state.hoveringControls||this.state.showDialpad||this.state.showMoreMenu||(this.controlsHideTimer=null,this.setState({visible:!1}))})),(0,k.Z)(this,"onMouseEnter",(()=>{this.setState({hoveringControls:!0})})),(0,k.Z)(this,"onMouseLeave",(()=>{this.setState({hoveringControls:!1})})),(0,k.Z)(this,"onDialpadClick",(()=>{this.state.showDialpad?this.setState({showDialpad:!1}):(this.setState({showDialpad:!0}),this.showControls())})),(0,k.Z)(this,"onMoreClick",(()=>{this.setState({showMoreMenu:!0}),this.showControls()})),(0,k.Z)(this,"closeDialpad",(()=>{this.setState({showDialpad:!1})})),(0,k.Z)(this,"closeContextMenu",(()=>{this.setState({showMoreMenu:!1})})),this.state={showDialpad:!1,hoveringControls:!1,showMoreMenu:!1,visible:!0}}componentDidMount(){this.showControls()}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.visible||this.setState({visible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,2e3))}render(){const e=yt()("mx_LegacyCallViewButtons",{mx_LegacyCallViewButtons_hidden:!this.state.visible});let t,i;return this.state.showDialpad&&this.dialpadButton.current&&(t=o.createElement(Uv,(0,kt.Z)({},(0,ii.kG)(this.dialpadButton.current.getBoundingClientRect(),ii.N7.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&this.contextMenuButton.current&&(i=o.createElement(Av,(0,kt.Z)({},(0,ii.kG)(this.contextMenuButton.current.getBoundingClientRect(),ii.N7.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeContextMenu,call:this.props.call}))),o.createElement("div",{className:e,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},t,i,this.props.buttonsVisibility.dialpad&&o.createElement(ii.JY,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_dialpad",inputRef:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad,title:(0,l._t)("voip|dialpad"),alignment:si.v.Top}),o.createElement(Kv,{state:!this.props.buttonsState.micMuted,className:"mx_LegacyCallViewButtons_button_mic",onLabel:(0,l._t)("voip|disable_microphone"),offLabel:(0,l._t)("voip|enable_microphone"),onClick:this.props.handlers.onMicMuteClick,deviceKinds:[Ka.C.AudioInput,Ka.C.AudioOutput]}),this.props.buttonsVisibility.vidMute&&o.createElement(Kv,{state:!this.props.buttonsState.vidMuted,className:"mx_LegacyCallViewButtons_button_vid",onLabel:(0,l._t)("voip|disable_camera"),offLabel:(0,l._t)("voip|enable_camera"),onClick:this.props.handlers.onVidMuteClick,deviceKinds:[Ka.C.VideoInput]}),this.props.buttonsVisibility.screensharing&&o.createElement(Gv,{state:this.props.buttonsState.screensharing,className:"mx_LegacyCallViewButtons_button_screensharing",onLabel:(0,l._t)("voip|stop_screenshare"),offLabel:(0,l._t)("voip|start_screenshare"),onClick:this.props.handlers.onScreenshareClick}),this.props.buttonsVisibility.sidebar&&o.createElement(Gv,{state:this.props.buttonsState.sidebarShown,className:"mx_LegacyCallViewButtons_button_sidebar",onLabel:(0,l._t)("voip|hide_sidebar_button"),offLabel:(0,l._t)("voip|show_sidebar_button"),onClick:this.props.handlers.onToggleSidebarClick}),this.props.buttonsVisibility.contextMenu&&o.createElement(ii.JY,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_more",onClick:this.onMoreClick,inputRef:this.contextMenuButton,isExpanded:this.state.showMoreMenu,title:(0,l._t)("voip|more_button"),alignment:si.v.Top}),o.createElement(gs.Z,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_hangup",onClick:this.props.handlers.onHangupClick,title:(0,l._t)("voip|hangup"),alignment:si.v.Top}))}}function $v(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function Jv(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}class Yv extends o.Component{constructor(e){super(e),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"contentWrapperRef",(0,o.createRef)()),(0,k.Z)(this,"buttonsRef",(0,o.createRef)()),(0,k.Z)(this,"onAction",(e=>{if("video_fullscreen"===e.action){if(!this.contentWrapperRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentWrapperRef.current):$v()&&Jv()}})),(0,k.Z)(this,"onCallState",(e=>{this.setState({callState:e})})),(0,k.Z)(this,"onFeedsChanged",(e=>{const{primary:t,secondary:i,sidebar:n}=Yv.getOrderedFeeds(e);this.setState({primaryFeed:t,secondaryFeed:i,sidebarFeeds:n,micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted()})})),(0,k.Z)(this,"onCallLocalHoldUnhold",(()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})})),(0,k.Z)(this,"onCallRemoteHoldUnhold",(()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})})),(0,k.Z)(this,"onMouseMove",(()=>{var e;null===(e=this.buttonsRef.current)||void 0===e||e.showControls()})),(0,k.Z)(this,"onMaximizeClick",(()=>{x.ZP.dispatch({action:"video_fullscreen",fullscreen:!0})})),(0,k.Z)(this,"onMicMuteClick",(async()=>{const e=!this.state.micMuted;this.setState({micMuted:await this.props.call.setMicrophoneMuted(e)})})),(0,k.Z)(this,"onVidMuteClick",(async()=>{const e=!this.state.vidMuted;this.setState({vidMuted:await this.props.call.setLocalVideoMuted(e)})})),(0,k.Z)(this,"onScreenshareClick",(async()=>{let e;e=this.state.screensharing?await this.props.call.setScreensharingEnabled(!1):await this.props.call.setScreensharingEnabled(!0),this.setState({sidebarShown:!0,screensharing:e})})),(0,k.Z)(this,"onNativeKeyDown",(e=>{var t,i;let n=!1;switch((0,dr.zL)().getCallAction(e)){case tn.vB.ToggleMicInCall:this.onMicMuteClick(),null===(t=this.buttonsRef.current)||void 0===t||t.showControls(),n=!0;break;case tn.vB.ToggleWebcamInCall:this.onVidMuteClick(),null===(i=this.buttonsRef.current)||void 0===i||i.showControls(),n=!0}n&&(e.stopPropagation(),e.preventDefault())})),(0,k.Z)(this,"onCallResumeClick",(()=>{const e=lt.ZP.instance.roomIdForCall(this.props.call);e&&lt.ZP.instance.setActiveCallRoomId(e)})),(0,k.Z)(this,"onTransferClick",(()=>{const e=lt.ZP.instance.getTransfereeForCallId(this.props.call.callId);e&&this.props.call.transferToCall(e)})),(0,k.Z)(this,"onHangupClick",(()=>{const e=lt.ZP.instance.roomIdForCall(this.props.call);e&&lt.ZP.instance.hangupOrReject(e)})),(0,k.Z)(this,"onToggleSidebar",(()=>{this.setState({sidebarShown:!this.state.sidebarShown})}));const{primary:t,secondary:i,sidebar:n}=Yv.getOrderedFeeds(this.props.call.getFeeds());this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),screensharing:this.props.call.isScreensharing(),callState:this.props.call.state,primaryFeed:t,secondaryFeed:i,sidebarFeeds:n,sidebarShown:!0},this.updateCallListeners(null,this.props.call)}componentDidMount(){this.dispatcherRef=x.ZP.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){$v()&&Jv(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef)}static getDerivedStateFromProps(e){const{primary:t,secondary:i,sidebar:n}=Yv.getOrderedFeeds(e.call.getFeeds());return{primaryFeed:t,secondaryFeed:i,sidebarFeeds:n}}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(xt.nP.State,this.onCallState),e.removeListener(xt.nP.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(xt.nP.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(xt.nP.FeedsChanged,this.onFeedsChanged)),t&&(t.on(xt.nP.State,this.onCallState),t.on(xt.nP.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(xt.nP.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(xt.nP.FeedsChanged,this.onFeedsChanged)))}static getOrderedFeeds(e){if(e.length<=2)return{primary:e.find((e=>!e.isLocal())),secondary:e.find((e=>e.isLocal())),sidebar:[]};let t;const i=e.filter((e=>e.purpose===Tv.K.Screenshare));t=i.find((e=>!e.isLocal()))||i[0],t||(t=e.find((e=>!e.isLocal())));const n=[...e];return t&&n.splice(n.indexOf(t),1),n.sort(((e,t)=>e.isLocal()&&!t.isLocal()?-1:!e.isLocal()&&t.isLocal()?1:0)),{primary:t,sidebar:n}}renderCallControls(){const{call:e,pipMode:t}=this.props,{callState:i,micMuted:n,vidMuted:s,screensharing:a,sidebarShown:r,secondaryFeed:l,sidebarFeeds:c}=this.state,d=e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack,m=(e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack)&&e.state===xt.OX.Connected,h=l&&!l.isVideoMuted()||c.length>0,p=i===xt.OX.Connected,u=i===xt.OX.Connected&&e.opponentSupportsDTMF();return o.createElement(qv,{ref:this.buttonsRef,call:e,pipMode:t,handlers:{onToggleSidebarClick:this.onToggleSidebar,onScreenshareClick:this.onScreenshareClick,onHangupClick:this.onHangupClick,onMicMuteClick:this.onMicMuteClick,onVidMuteClick:this.onVidMuteClick},buttonsState:{micMuted:n,vidMuted:s,sidebarShown:r,screensharing:a},buttonsVisibility:{vidMute:d,screensharing:m,sidebar:h,contextMenu:p,dialpad:u}})}renderToast(){var e;const{call:t}=this.props;if(!t.getFeeds().some((e=>e.purpose===Tv.K.Screenshare)))return null;const i=t.isScreensharing(),{primaryFeed:n,sidebarShown:s}=this.state,a=null==n||null===(e=n.getMember())||void 0===e?void 0:e.name;if(!a)return null;let r=i?(0,l._t)("voip|you_are_presenting"):(0,l._t)("voip|user_is_presenting",{sharerName:a});return s||(r+=" â¢ "+(t.isLocalVideoMuted()?(0,l._t)("voip|camera_disabled"):(0,l._t)("voip|camera_enabled"))),o.createElement("div",{className:"mx_LegacyCallView_toast"},r)}renderContent(){var e;const{pipMode:t,call:i,onResize:n}=this.props,{isLocalOnHold:s,isRemoteOnHold:a,sidebarShown:r,primaryFeed:c,secondaryFeed:d,sidebarFeeds:m}=this.state,h=lt.ZP.instance.roomIdForCall(i),p=null!==(e=h?E.p.safeGet().getRoom(h):void 0)&&void 0!==e?e:void 0,u=t?"76px":"160px",g=lt.ZP.instance.getTransfereeForCallId(i.callId),v=s||a;let _;if(r&&d&&!d.isVideoMuted()&&(_=o.createElement(Zv,{feed:d,call:i,pipMode:t,onResize:n,secondary:!0})),g||v){const e=yt()("mx_LegacyCallView_content",{mx_LegacyCallView_content_hold:v}),t=(0,Ct.xj)(i.getOpponentMember(),1024,1024,"crop");let n;if(g){const e=E.p.safeGet(),t=lt.ZP.instance.roomIdForCall(i),s=t?e.getRoom(t):null,a=s?s.name:(0,l._t)("voip|unknown_person"),r=lt.ZP.instance.roomIdForCall(g),c=r?e.getRoom(r):null,d=c?c.name:(0,l._t)("voip|unknown_person");n=o.createElement("div",{className:"mx_LegacyCallView_status"},(0,l._t)("voip|consulting",{transferTarget:a,transferee:d},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.onTransferClick},e)}))}else{let e;if(a)e=(0,l._t)(lt.ZP.instance.hasAnyUnheldCall()?(0,l.I8)("voip|call_held_switch"):(0,l.I8)("voip|call_held_resume"),{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.onCallResumeClick},e)});else if(s){var f;e=(0,l._t)("voip|call_held",{peerName:null===(f=i.getOpponentMember())||void 0===f?void 0:f.name})}n=o.createElement("div",{className:"mx_LegacyCallView_status"},e)}return o.createElement("div",{className:e,onMouseMove:this.onMouseMove},o.createElement("div",{className:"mx_LegacyCallView_holdBackground",style:{backgroundImage:"url("+t+")"}}),n)}return i.noIncomingFeeds()?o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement("div",{className:"mx_LegacyCallView_avatarsContainer"},o.createElement("div",{className:"mx_LegacyCallView_avatarContainer",style:{width:u,height:u}},o.createElement(ei.Z,{room:p,size:u}))),o.createElement("div",{className:"mx_LegacyCallView_status"},(0,l._t)("voip|connecting")),_):t?o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement(Zv,{feed:c,call:i,pipMode:t,onResize:n,primary:!0})):d?o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement(Zv,{feed:c,call:i,pipMode:t,onResize:n,primary:!0}),_):o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement(Zv,{feed:c,call:i,pipMode:t,onResize:n,primary:!0}),r&&o.createElement(Nv,{feeds:m,call:i,pipMode:Boolean(t)}))}render(){const{call:e,secondaryCall:t,pipMode:i,showApps:n,onMouseDownOnHeader:s}=this.props,{sidebarShown:a,sidebarFeeds:r}=this.state,l=E.p.safeGet(),c=lt.ZP.instance.roomIdForCall(e),d=lt.ZP.instance.roomIdForCall(t),m=c?l.getRoom(c):null;if(!m)return null;const h=d?l.getRoom(d):null,p=yt()({mx_LegacyCallView:!0,mx_LegacyCallView_pip:i,mx_LegacyCallView_large:!i,mx_LegacyCallView_sidebar:a&&0!==r.length&&!i,mx_LegacyCallView_belowWidget:n});return o.createElement("div",{className:p},o.createElement(Ov,{onPipMouseDown:s,pipMode:i,callRooms:[m,h],onMaximize:this.onMaximizeClick}),o.createElement("div",{className:"mx_LegacyCallView_content_wrapper",ref:this.contentWrapperRef},this.renderToast(),this.renderContent(),this.renderCallControls()))}}class Qv extends o.Component{constructor(e){super(e),(0,k.Z)(this,"updateCall",(()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})})),(0,k.Z)(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),(0,k.Z)(this,"onResize",(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()})),(0,k.Z)(this,"onResizeStop",(()=>{this.props.resizeNotifier.stopResizing()})),this.state={call:this.getCall()}}componentDidMount(){lt.ZP.instance.addListener(lt.QC.CallState,this.updateCall),lt.ZP.instance.addListener(lt.QC.CallChangeRoom,this.updateCall)}componentWillUnmount(){lt.ZP.instance.removeListener(lt.QC.CallState,this.updateCall),lt.ZP.instance.removeListener(lt.QC.CallChangeRoom,this.updateCall)}getCall(){const e=lt.ZP.instance.getCallForRoom(this.props.roomId);return e&&[xt.OX.Ended,xt.OX.Ringing].includes(e.state)?null:e}render(){return this.state.call?o.createElement("div",{className:"mx_LegacyCallViewForRoom"},o.createElement(em.e,{minHeight:380,maxHeight:"80vh",enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_LegacyCallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_LegacyCallViewForRoom_ResizeHandle"}},o.createElement(Yv,{call:this.state.call,pipMode:!1,showApps:this.props.showApps}))):null}}class Xv extends o.Component{shouldComponentUpdate(e){return(0,ni.U0)(this.props,e)}render(){const e=o.createElement(Qv,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,showApps:this.props.showApps});let t;return L.C.getValue(Ye.H.Widgets)&&(t=o.createElement(Iv,{room:this.props.room,userId:this.props.userId,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier})),o.createElement(Ln.Z,{className:"mx_AuxPanel"},this.props.children,t,e)}}(0,k.Z)(Xv,"defaultProps",{showApps:!0});const e_=["isHighlighted","isUnread","onClick","name","title"];class t_ extends o.Component{render(){const e=this.props,{isHighlighted:t,isUnread:i=!1,onClick:n,name:s,title:a}=e,r=(0,v.Z)(e,e_),l=yt()({mx_LegacyRoomHeader_button:!0,"mx_LegacyRoomHeader_button--highlight":t,"mx_LegacyRoomHeader_button--unread":i,[`mx_RightPanel_${s}`]:!0});return o.createElement(gs.Z,(0,kt.Z)({},r,{"aria-current":t?"true":"false",title:a,alignment:si.v.Bottom,className:l,onClick:n}))}}let i_=function(e){return e.Room="room",e}({});class n_ extends o.Component{constructor(e,t){super(e),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"watcherRef",void 0),(0,k.Z)(this,"onRightPanelStoreUpdate",(()=>{this.unmounted||this.setState({phase:nm.Z.instance.currentCard.phase})}));const i=nm.Z.instance;this.state={headerKind:t,phase:i.currentCard.phase,threadNotificationColor:Sr.v.None,globalNotificationColor:Sr.v.None,notificationsEnabled:L.C.getValue("feature_notifications")},this.watcherRef=L.C.watchSetting("feature_notifications",null,((...[,,,e])=>this.setState({notificationsEnabled:e})))}componentDidMount(){nm.Z.instance.on(Pa.a,this.onRightPanelStoreUpdate)}componentWillUnmount(){this.unmounted=!0,nm.Z.instance.off(Pa.a,this.onRightPanelStoreUpdate),this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef),this.watcherRef&&L.C.unwatchSetting(this.watcherRef)}isPhase(e){return!!nm.Z.instance.isOpen&&(Array.isArray(e)?!!this.state.phase&&e.includes(this.state.phase):e===this.state.phase)}render(){return this.renderButtons()}}var s_=i("../matrix-react-sdk/src/Unread.ts");const o_=[im.q.RoomSummary,im.q.Widget,im.q.FilePanel,im.q.RoomMemberList,im.q.RoomMemberInfo,im.q.EncryptionPanel,im.q.Room3pidMemberInfo],a_=({color:e})=>{if(e===Sr.v.None)return null;const t=yt()({mx_Indicator:!0,mx_LegacyRoomHeader_button_unreadIndicator:!0,mx_Indicator_bold:e===Sr.v.Bold,mx_Indicator_gray:e===Sr.v.Grey,mx_Indicator_red:e===Sr.v.Red});return o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_LegacyRoomHeader_button_unreadIndicator_bg"}),o.createElement("div",{className:t}))},r_=({room:e,isHighlighted:t,onClick:i})=>{const n=kh(e),s=Rh(e);if(null==n||!n.length)return null;let a;return n.some((e=>!s.has(e)))&&(a=o.createElement(a_,null)),o.createElement(t_,{name:"pinnedMessagesButton",title:(0,l._t)("right_panel|pinned_messages|title"),isHighlighted:t,isUnread:!!a,onClick:i},a)},l_=({room:e,isHighlighted:t,onClick:i})=>{let n;const s=Zr.v.instance.getRoomState(e).color;switch(s){case Sr.v.Bold:case Sr.v.Grey:case Sr.v.Red:n=o.createElement(a_,{color:s})}return o.createElement(t_,{name:"timelineCardButton",title:(0,l._t)("right_panel|video_room_chat|title"),isHighlighted:t,onClick:i},n)};class c_ extends n_{constructor(e){super(e,i_.Room),(0,k.Z)(this,"globalNotificationState",void 0),(0,k.Z)(this,"onNotificationUpdate",(()=>{this.setState({threadNotificationColor:this.notificationColor})})),(0,k.Z)(this,"onUpdateStatus",(e=>{this.globalNotificationState=e,this.setState({globalNotificationColor:e.color})})),(0,k.Z)(this,"onRoomSummaryClicked",(()=>{const e=nm.Z.instance.currentCard.phase;e&&o_.includes(e)?this.state.phase===e?nm.Z.instance.showOrHidePanel(e):nm.Z.instance.showOrHidePanel(e,nm.Z.instance.currentCard.state):nm.Z.instance.showOrHidePanel(im.q.RoomSummary)})),(0,k.Z)(this,"onNotificationsClicked",(()=>{nm.Z.instance.showOrHidePanel(im.q.NotificationPanel)})),(0,k.Z)(this,"onPinnedMessagesClicked",(()=>{nm.Z.instance.showOrHidePanel(im.q.PinnedMessages)})),(0,k.Z)(this,"onTimelineCardClicked",(()=>{nm.Z.instance.showOrHidePanel(im.q.Timeline)})),(0,k.Z)(this,"onThreadsPanelClicked",(e=>{var t,i;this.state.phase&&c_.THREAD_PHASES.includes(this.state.phase)?nm.Z.instance.togglePanel(null!==(t=null===(i=this.props.room)||void 0===i?void 0:i.roomId)&&void 0!==t?t:null):(nm.Z.instance.setCard({phase:im.q.ThreadPanel}),kn.Z.trackInteraction("WebRoomHeaderButtonsThreadsButton",e))})),this.globalNotificationState=Zr.v.instance.globalState}componentDidMount(){var e,t,i,s,o,a,r,l;super.componentDidMount(),null===(e=this.props.room)||void 0===e||e.on(n.RoomEvent.UnreadNotifications,this.onNotificationUpdate),null===(t=this.props.room)||void 0===t||t.on(n.RoomEvent.Receipt,this.onNotificationUpdate),null===(i=this.props.room)||void 0===i||i.on(n.RoomEvent.Timeline,this.onNotificationUpdate),null===(s=this.props.room)||void 0===s||s.on(n.RoomEvent.Redaction,this.onNotificationUpdate),null===(o=this.props.room)||void 0===o||o.on(n.RoomEvent.LocalEchoUpdated,this.onNotificationUpdate),null===(a=this.props.room)||void 0===a||a.on(n.RoomEvent.MyMembership,this.onNotificationUpdate),null===(r=this.props.room)||void 0===r||r.on(n.ThreadEvent.New,this.onNotificationUpdate),null===(l=this.props.room)||void 0===l||l.on(n.ThreadEvent.Update,this.onNotificationUpdate),this.onNotificationUpdate(),Zr.v.instance.on(Zr.w,this.onUpdateStatus)}componentWillUnmount(){var e,t,i,s,o,a,r,l;super.componentWillUnmount(),null===(e=this.props.room)||void 0===e||e.off(n.RoomEvent.UnreadNotifications,this.onNotificationUpdate),null===(t=this.props.room)||void 0===t||t.off(n.RoomEvent.Receipt,this.onNotificationUpdate),null===(i=this.props.room)||void 0===i||i.off(n.RoomEvent.Timeline,this.onNotificationUpdate),null===(s=this.props.room)||void 0===s||s.off(n.RoomEvent.Redaction,this.onNotificationUpdate),null===(o=this.props.room)||void 0===o||o.off(n.RoomEvent.LocalEchoUpdated,this.onNotificationUpdate),null===(a=this.props.room)||void 0===a||a.off(n.RoomEvent.MyMembership,this.onNotificationUpdate),null===(r=this.props.room)||void 0===r||r.off(n.ThreadEvent.New,this.onNotificationUpdate),null===(l=this.props.room)||void 0===l||l.off(n.ThreadEvent.Update,this.onNotificationUpdate),Zr.v.instance.off(Zr.w,this.onUpdateStatus)}get notificationColor(){var e;switch(null===(e=this.props.room)||void 0===e?void 0:e.threadsAggregateNotificationType){case n.NotificationCountType.Highlight:return Sr.v.Red;case n.NotificationCountType.Total:return Sr.v.Grey}for(const e of this.props.room.getThreads())if((0,s_.h5)(e))return Sr.v.Bold;return Sr.v.None}onAction(e){}renderButtons(){if(!this.props.room)return o.createElement(o.Fragment,null);const e=new Map;return L.C.getValue("feature_pinning")&&e.set(im.q.PinnedMessages,o.createElement(r_,{key:"pinnedMessagesButton",room:this.props.room,isHighlighted:this.isPhase(im.q.PinnedMessages),onClick:this.onPinnedMessagesClicked})),e.set(im.q.Timeline,o.createElement(l_,{key:"timelineButton",room:this.props.room,isHighlighted:this.isPhase(im.q.Timeline),onClick:this.onTimelineCardClicked})),e.set(im.q.ThreadPanel,o.createElement(t_,{key:im.q.ThreadPanel,name:"threadsButton","data-testid":"threadsButton",title:(0,l._t)("common|threads"),onClick:this.onThreadsPanelClicked,isHighlighted:this.isPhase(c_.THREAD_PHASES),isUnread:this.state.threadNotificationColor>Sr.v.None},o.createElement(a_,{color:this.state.threadNotificationColor}))),this.state.notificationsEnabled&&e.set(im.q.NotificationPanel,o.createElement(t_,{key:"notifsButton",name:"notifsButton",title:(0,l._t)("notifications|enable_prompt_toast_title"),isHighlighted:this.isPhase(im.q.NotificationPanel),onClick:this.onNotificationsClicked,isUnread:this.globalNotificationState.color===Sr.v.Red},this.globalNotificationState.color===Sr.v.Red?o.createElement(a_,{color:this.globalNotificationState.color}):null)),e.set(im.q.RoomSummary,o.createElement(t_,{key:"roomSummaryButton",name:"roomSummaryButton",title:(0,l._t)("right_panel|room_summary_card|title"),isHighlighted:this.isPhase(o_),onClick:this.onRoomSummaryClicked})),o.createElement(o.Fragment,null,Array.from(e.keys()).map((t=>{var i;return null!==(i=this.props.excludedRightPanelPhaseButtons)&&void 0!==i&&i.includes(t)?null:e.get(t)})))}}(0,k.Z)(c_,"THREAD_PHASES",[im.q.ThreadPanel,im.q.ThreadView]);var d_=i("../matrix-react-sdk/res/img/feather-customised/check.svg"),m_=i("../matrix-react-sdk/res/img/feather-customised/x.svg");const h_=({room:e})=>{const[t,i]=(0,o.useState)(!1),s=(0,In.A_)(e,n.RoomStateEvent.Update,(0,o.useCallback)((()=>e.getMembersWithMembership("knock")),[e])),a=s.length;if(e.getJoinRule()!==n.JoinRule.Knock||0===a)return null;const r=e.client,c=r.getUserId()||"",d=e.canInvite(c),m=e.getMember(c),h=e.getLiveTimeline().getState(n.EventTimeline.FORWARDS),p=!(!m||!h)&&h.hasSufficientPowerLevelFor("kick",m.powerLevel);if(!d&&!p)return null;const u=e=>{T.ZP.createDialog(dt.Z,{title:e.name,description:e.message})},g=()=>x.ZP.dispatch({action:"open_room_settings",room_id:e.roomId,initial_tab_id:bt.a.People});let v=o.createElement(ae.Z,{className:"mx_RoomKnocksBar_action",kind:"primary",onClick:g,title:(0,l._t)("action|view")},(0,l._t)("action|view")),_=(0,It.If)(s.map((e=>e.name)),3,!0),f=null;var E;1===a&&(v=o.createElement(o.Fragment,null,o.createElement(ae.Z,{className:"mx_RoomKnocksBar_action",disabled:!p||t,kind:"icon_primary_outline",onClick:()=>(t=>{i(!0),r.kick(e.roomId,t).catch(u).finally((()=>i(!1)))})(s[0].userId),title:(0,l._t)("action|deny")},o.createElement(m_.J,{width:18,height:18})),o.createElement(ae.Z,{className:"mx_RoomKnocksBar_action",disabled:!d||t,kind:"icon_primary",onClick:()=>(t=>{i(!0),r.invite(e.roomId,t).catch(u).finally((()=>i(!1)))})(s[0].userId),title:(0,l._t)("action|approve")},o.createElement(d_.J,{width:18,height:18}))),_=`${s[0].name} (${s[0].userId})`,f=(null===(E=s[0].events.member)||void 0===E?void 0:E.getContent().reason)&&o.createElement(ae.Z,{className:"mx_RoomKnocksBar_link",element:"a",kind:"link_inline",onClick:g},(0,l._t)("action|view_message")));return o.createElement("div",{className:"mx_RoomKnocksBar"},s.slice(0,2).map((e=>o.createElement(Vt.Z,{className:"mx_RoomKnocksBar_avatar",key:e.userId,member:e,size:"32px"}))),o.createElement("div",{className:"mx_RoomKnocksBar_content"},o.createElement(ac.Z,{size:"4"},(0,l._t)("room|header|n_people_asking_to_join",{count:a})),o.createElement("p",{className:"mx_RoomKnocksBar_paragraph"},_,f)),v)};var p_=i("../matrix-react-sdk/src/stores/local-echo/EchoChamber.ts"),u_=i("../matrix-react-sdk/src/RoomNotifs.ts"),g_=i("../matrix-react-sdk/src/components/views/context_menus/DeveloperToolsOption.tsx");const v_=["room","onFinished"],__=e=>{var t;let{room:i,onFinished:n}=e,s=(0,v.Z)(e,v_);const a=(0,o.useContext)(pn.ZP),r=(0,In.kZ)(ic.ZP.instance,ic.N,(()=>ic.ZP.instance.getTagsForRoom(i)));let c;if(r.includes(nr.lL.Archived)){const e=e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"forget_room",room_id:i.roomId}),n()};c=o.createElement(ur.$k,{iconClassName:"mx_RoomTile_iconSignOut",label:(0,l._t)("room|context_menu|forget"),className:"mx_IconizedContextMenu_option_red",onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"leave_room",room_id:i.roomId}),n(),kn.Z.trackInteraction("WebRoomHeaderContextMenuLeaveItem",e)};c=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("action|leave"),className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_RoomTile_iconSignOut"})}const d=P.Z.shared().getUserIdForRoomId(i.roomId),m=(0,wt.n)("feature_video_rooms"),h=(0,wt.n)("feature_element_call_video_rooms"),p=m&&(i.isElementVideoRoom()||h&&i.isCallRoom());let u,g,_,f,E,y,b;if(i.canInvite(a.getUserId())&&!d&&(0,hr.I)(Ye.y.InviteUsers)){const e=e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"view_invite",roomId:i.roomId}),n(),kn.Z.trackInteraction("WebRoomHeaderContextMenuInviteItem",e)};u=o.createElement(ur.$k,{onClick:e,label:(0,l._t)("action|invite"),iconClassName:"mx_RoomTile_iconInvite"})}if("join"===i.getMyMembership()){const e=r.includes(nr.lL.Favourite);g=o.createElement(ur.gW,{onClick:e=>{I(e,nr.lL.Favourite),kn.Z.trackInteraction("WebRoomHeaderContextMenuFavouriteToggle",e)},active:e,label:e?(0,l._t)("room|context_menu|unfavourite"):(0,l._t)("room|context_menu|favourite"),iconClassName:"mx_RoomTile_iconStar"});const t=r.includes(nr.lL.LowPriority);_=o.createElement(ur.gW,{onClick:e=>I(e,nr.lL.LowPriority),active:t,label:(0,l._t)("common|low_priority"),iconClassName:"mx_RoomTile_iconArrowDown"});let s,a;switch(p_.P.forRoom(i).notificationVolume){case u_.OV.AllMessages:s=(0,l._t)("notifications|default"),a="mx_RoomTile_iconNotificationsDefault";break;case u_.OV.AllMessagesLoud:s=(0,l._t)("notifications|all_messages"),a="mx_RoomTile_iconNotificationsAllMessages";break;case u_.OV.MentionsOnly:s=(0,l._t)("room|context_menu|mentions_only"),a="mx_RoomTile_iconNotificationsMentionsKeywords";break;case u_.OV.Mute:s=(0,l._t)("common|mute"),a="mx_RoomTile_iconNotificationsNone"}f=o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"open_room_settings",room_id:i.roomId,initial_tab_id:bt.a.Notifications}),n(),kn.Z.trackInteraction("WebRoomHeaderContextMenuNotificationsItem",e)},label:(0,l._t)("notifications|enable_prompt_toast_title"),iconClassName:a},o.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},s))}d||(E=o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),Z(e),nm.Z.instance.pushCard({phase:im.q.RoomMemberList},!1),n(),kn.Z.trackInteraction("WebRoomHeaderContextMenuPeopleItem",e)},label:(0,l._t)("common|people"),iconClassName:"mx_RoomTile_iconPeople"},o.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},i.getJoinedMemberCount())),y=o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"copy_room",room_id:i.roomId}),n()},label:(0,l._t)("room|context_menu|copy_link"),iconClassName:"mx_RoomTile_iconCopyLink"})),p||(b=o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),Z(e),nm.Z.instance.pushCard({phase:im.q.FilePanel},!1),n()},label:(0,l._t)("right_panel|files_button"),iconClassName:"mx_RoomTile_iconFiles"}));const w=(0,wt.n)("feature_pinning"),S=null===(t=kh(w?i:void 0))||void 0===t?void 0:t.length;let C,k,R;w&&!p&&(C=o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),Z(e),nm.Z.instance.pushCard({phase:im.q.PinnedMessages},!1),n()},label:(0,l._t)("right_panel|pinned_messages_button"),iconClassName:"mx_RoomTile_iconPins"},S>0&&o.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},S))),p||(k=o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),Z(e),nm.Z.instance.setCard({phase:im.q.RoomSummary},!1),n()},label:(0,l._t)("right_panel|widgets_section"),iconClassName:"mx_RoomTile_iconWidgets"})),p||(R=o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),T.ZP.createDialog(Pp,{room:i}),n()},label:(0,l._t)("right_panel|export_chat_button"),iconClassName:"mx_RoomTile_iconExport"}));const I=(e,t)=>{e.preventDefault(),e.stopPropagation(),Lp(i,t);if((0,dr.zL)().getAccessibilityAction(e)===tn.vB.Enter)n()},Z=e=>{ie.m.instance.roomViewStore.getRoomId()!==i.roomId&&x.ZP.dispatch({action:W.a.ViewRoom,room_id:i.roomId,metricsTrigger:"RoomList",metricsViaKeyboard:"click"!==e.type},!0)};return o.createElement(ur.ZP,(0,kt.Z)({},s,{onFinished:n,className:"mx_RoomTile_contextMenu",compact:!0}),o.createElement(ur.I2,null,u,f,g,E,b,C,k,_,y,o.createElement(ur.$k,{onClick:e=>{e.preventDefault(),e.stopPropagation(),x.ZP.dispatch({action:"open_room_settings",room_id:i.roomId}),n(),kn.Z.trackInteraction("WebRoomHeaderContextMenuSettingsItem",e)},label:(0,l._t)("common|settings"),iconClassName:"mx_RoomTile_iconSettings"}),R,L.C.getValue("developerMode")&&o.createElement(g_.k,{onFinished:n,roomId:i.roomId}),c))};var f_=i("../matrix-react-sdk/src/components/views/rooms/RoomTile.tsx"),E_=i("../matrix-react-sdk/src/stores/notifications/NotificationState.ts"),y_=i("../matrix-react-sdk/src/stores/OwnBeaconStore.ts"),b_=i("../matrix-react-sdk/src/utils/beacon/index.ts"),w_=i("../matrix-react-sdk/src/components/views/beacon/StyledLiveBeaconIcon.tsx"),S_=i("../matrix-react-sdk/res/img/image-view/close.svg"),C_=i("../matrix-react-sdk/src/components/views/beacon/LiveTimeRemaining.tsx");const k_=({liveBeaconIds:e,roomId:t})=>{const{onStopSharing:i,onResetLocationPublishError:n,beacon:s,stoppingInProgress:a,hasStopSharingError:r,hasLocationPublishError:c}=(0,b_.IH)(e);if(!s)return null;const d=r||c,m=e=>t=>{null==t||t.stopPropagation(),e()};return o.createElement("div",{className:"mx_RoomLiveShareWarning",onClick:()=>{x.ZP.dispatch({action:W.a.ViewRoom,room_id:s.roomId,metricsTrigger:void 0,event_id:s.beaconInfoId,scroll_into_view:!0,highlighted:!0})}},o.createElement(w_.Z,{className:"mx_RoomLiveShareWarning_icon",withError:d}),o.createElement("span",{className:"mx_RoomLiveShareWarning_label"},((e,t)=>e?(0,l._t)("location_sharing|error_sharing_live_location_try_again"):t?(0,l._t)("location_sharing|error_stopping_live_location_try_again"):(0,l._t)("location_sharing|live_location_active"))(c,r)),a&&o.createElement("span",{className:"mx_RoomLiveShareWarning_spinner"},o.createElement(re.Z,{h:16,w:16})),!a&&!d&&o.createElement(C_.Z,{beacon:s}),o.createElement(ae.Z,{className:"mx_RoomLiveShareWarning_stopButton","data-testid":"room-live-share-primary-button",onClick:m((()=>{c?n():i()})),kind:"danger",element:"button",disabled:a},d?(0,l._t)("action|retry"):(0,l._t)("action|stop")),c&&o.createElement(ae.Z,{"data-testid":"room-live-share-wire-error-close-button",title:(0,l._t)("location_sharing|stop_and_close"),element:"button",className:"mx_RoomLiveShareWarning_closeButton",onClick:m(i)},o.createElement(S_.J,{className:"mx_RoomLiveShareWarning_closeButtonIcon"})))},x_=({roomId:e})=>{const t=(0,In.kZ)(y_.d.instance,y_.N.MonitoringLivePosition,(()=>y_.d.instance.isMonitoringLiveLocation)),i=(0,In.kZ)(y_.d.instance,y_.N.LivenessChange,(()=>y_.d.instance.getLiveBeaconIds(e)));return t&&i.length?o.createElement(k_,{liveBeaconIds:i,roomId:e}):null},R_=e=>e.isElementVideoRoom()||L.C.getValue("feature_element_call_video_rooms")&&e.isCallRoom();var I_=i("../matrix-react-sdk/src/hooks/useCall.ts"),P_=i("../matrix-react-sdk/src/utils/room/getJoinedNonFunctionalMembers.ts"),T_=i("../matrix-react-sdk/src/components/views/voip/CallDuration.tsx");const Z_=({roomId:e,call:t})=>{const i=(0,o.useCallback)((t=>{t.preventDefault(),x.ec.dispatch({action:W.a.ViewRoom,room_id:e,view_call:!0,metricsTrigger:void 0})}),[e]),n=(0,o.useCallback)((()=>{r.k.log("clicking on the call banner is not supported anymore - there are no timeline events anymore."),r.k.error("Couldn't find a group call event to jump to")}),[e]);return o.createElement("div",{className:"mx_RoomCallBanner",onClick:n},o.createElement("div",{className:"mx_RoomCallBanner_text"},o.createElement("span",{className:"mx_RoomCallBanner_label"},(0,l._t)("voip|video_call")),o.createElement(T_.f,{session:t.session})),o.createElement(ae.Z,{onClick:i,kind:"primary",element:"button",disabled:!1},(0,l._t)("action|join")))},N_=({roomId:e})=>{const t=(0,I_.W7)(e),i=(0,In.kZ)(y_.d.instance,y_.N.MonitoringLivePosition,(()=>y_.d.instance.isMonitoringLiveLocation)),n=(0,In.kZ)(y_.d.instance,y_.N.LivenessChange,(()=>y_.d.instance.getLiveBeaconIds(e)));return i&&n.length||ie.m.instance.roomViewStore.isViewingCall()?null:null!==t&&t.connectionState===Lt.em.Disconnected?o.createElement(Z_,{call:t,roomId:e}):null};class D_{constructor(e){this.reason=e}}const M_=({room:e,busy:t,setBusy:i,behavior:n})=>{const{onClick:s,tooltip:a,disabled:r}=(0,o.useMemo)((()=>n instanceof D_?{onClick:()=>{},tooltip:n.reason,disabled:!0}:{onClick:async t=>{t.preventDefault(),i(!0),await lt.ZP.instance.placeCall(e.roomId,xt.rf.Voice),i(!1)},disabled:!1}),[n,e,i]);return o.createElement(gs.Z,{className:"mx_LegacyRoomHeader_button mx_LegacyRoomHeader_voiceCallButton",onClick:s,title:(0,l._t)("voip|voice_call"),tooltip:null!=a?a:(0,l._t)("voip|voice_call"),alignment:si.v.Bottom,disabled:r||t})},O_=({room:e,busy:t,setBusy:i,behavior:n})=>{const[s,a,r,d]=(0,ii.av)(),m=(0,o.useCallback)((async()=>{i(!0),await lt.ZP.instance.placeCall(e.roomId,xt.rf.Video),i(!1)}),[i,e]),h=(0,o.useCallback)((()=>{i(!0),x.ZP.dispatch({action:W.a.ViewRoom,room_id:e.roomId,view_call:!0,metricsTrigger:void 0}),i(!1)}),[i,e]),{onClick:p,tooltip:u,disabled:g}=(0,o.useMemo)((()=>n instanceof D_?{onClick:()=>{},tooltip:n.reason,disabled:!0}:"legacy_or_jitsi"===n?{onClick:async e=>{e.preventDefault(),await m()},disabled:!1}:"element"===n?{onClick:async e=>{e.preventDefault(),h()},disabled:!1}:{onClick:async e=>{e.preventDefault(),r()},disabled:!1}),[n,m,h,r]),v=(0,o.useCallback)((async e=>{e.preventDefault(),d(),await m()}),[d,m]),_=(0,o.useCallback)((e=>{e.preventDefault(),d(),h()}),[d,h]);let f=null;if(s){const e=a.current.getBoundingClientRect(),t=c.ZP.get("element_call").brand;f=o.createElement(ur.ZP,(0,kt.Z)({},(0,ii.LS)(e),{onFinished:d}),o.createElement(ur.I2,null,o.createElement(ur.$k,{label:"legacy_or_element"==n?(0,l._t)("room|header|video_call_button_legacy"):(0,l._t)("room|header|video_call_button_jitsi"),onClick:v}),o.createElement(ur.$k,{label:(0,l._t)("room|header|video_call_button_ec",{brand:t}),onClick:_})))}return o.createElement(o.Fragment,null,o.createElement(gs.Z,{inputRef:a,className:"mx_LegacyRoomHeader_button mx_LegacyRoomHeader_videoCallButton",onClick:p,title:(0,l._t)("voip|video_call"),tooltip:null!=u?u:(0,l._t)("voip|video_call"),alignment:si.v.Bottom,disabled:g||t}),f)},A_=({room:e})=>{const[t,i]=(0,o.useState)(!1),s=(0,wt.t)("showCallButtonsInComposer"),a=(0,wt.n)("feature_group_calls"),r=(0,wt.n)("feature_video_rooms"),d=(0,o.useMemo)((()=>r&&R_(e)),[r,e]),m=(0,o.useMemo)((()=>c.ZP.get("element_call").use_exclusively),[]),h=(0,In.kZ)(lt.ZP.instance,lt.QC.CallsChanged,(0,o.useCallback)((()=>null!==lt.ZP.instance.getCallForRoom(e.roomId)),[e])),p=Vp(e),u=(0,o.useMemo)((()=>p.some((e=>Zm.l.JITSI.matches(e.type)))),[p]),g=null!==(0,I_.W7)(e.roomId),[v,_,f]=(0,In.A_)(e,n.RoomStateEvent.Update,(0,o.useCallback)((()=>[(0,P_.$)(e),e.currentState.mayClientSendStateEvent("im.vector.modular.widgets",e.client),e.currentState.mayClientSendStateEvent(Lt.gk.CALL_EVENT_TYPE.name,e.client)]),[e])),E=n=>o.createElement(M_,{room:e,busy:t,setBusy:i,behavior:n}),y=n=>o.createElement(O_,{room:e,busy:t,setBusy:i,behavior:n});if(d||!s)return null;if(a){if(m)return y(g?new D_((0,l._t)("voip|disabled_ongoing_call")):f?"element":new D_((0,l._t)("voip|disabled_no_perms_start_video_call")));if(h||u||g)return o.createElement(o.Fragment,null,E(new D_((0,l._t)("voip|disabled_ongoing_call"))),y(new D_((0,l._t)("voip|disabled_ongoing_call"))));if(v.length<=1)return o.createElement(o.Fragment,null,E(new D_((0,l._t)("voip|disabled_no_one_here"))),y(new D_((0,l._t)("voip|disabled_no_one_here"))));if(2===v.length)return o.createElement(o.Fragment,null,E("legacy_or_jitsi"),y("legacy_or_element"));if(_)return o.createElement(o.Fragment,null,E("legacy_or_jitsi"),y(f?"jitsi_or_element":"legacy_or_jitsi"));{const e=f?"element":new D_((0,l._t)("voip|disabled_no_perms_start_video_call"));return o.createElement(o.Fragment,null,E(new D_((0,l._t)("voip|disabled_no_perms_start_voice_call"))),y(e))}}return h||u?o.createElement(o.Fragment,null,E(new D_((0,l._t)("voip|disabled_ongoing_call"))),y(new D_((0,l._t)("voip|disabled_ongoing_call")))):v.length<=1?o.createElement(o.Fragment,null,E(new D_((0,l._t)("voip|disabled_no_one_here"))),y(new D_((0,l._t)("voip|disabled_no_one_here")))):2===v.length||_?o.createElement(o.Fragment,null,E("legacy_or_jitsi"),y("legacy_or_jitsi")):o.createElement(o.Fragment,null,E(new D_((0,l._t)("voip|disabled_no_perms_start_voice_call"))),y(new D_((0,l._t)("voip|disabled_no_perms_start_video_call"))))},L_=({call:e})=>{const t=(0,I_.$Y)(e),[i,n,s,a]=(0,ii.av)(),r=(0,o.useCallback)((e=>{e.preventDefault(),s()}),[s]),c=(0,o.useCallback)((t=>{t.preventDefault(),a(),e.setLayout(Lt.Ar.Tile)}),[a,e]),d=(0,o.useCallback)((t=>{t.preventDefault(),a(),e.setLayout(Lt.Ar.Spotlight)}),[a,e]);let m=null;if(i){const e=n.current.getBoundingClientRect();m=o.createElement(ur.ZP,(0,kt.Z)({className:"mx_LegacyRoomHeader_layoutMenu"},(0,ii.LS)(e),{onFinished:a}),o.createElement(ur.I2,null,o.createElement(ur.fL,{iconClassName:"mx_LegacyRoomHeader_freedomIcon",label:(0,l._t)("room|header|video_call_ec_layout_freedom"),active:t===Lt.Ar.Tile,onClick:c}),o.createElement(ur.fL,{iconClassName:"mx_LegacyRoomHeader_spotlightIcon",label:(0,l._t)("room|header|video_call_ec_layout_spotlight"),active:t===Lt.Ar.Spotlight,onClick:d})))}return o.createElement(o.Fragment,null,o.createElement(gs.Z,{inputRef:n,className:yt()("mx_LegacyRoomHeader_button",{"mx_LegacyRoomHeader_layoutButton--freedom":t===Lt.Ar.Tile,"mx_LegacyRoomHeader_layoutButton--spotlight":t===Lt.Ar.Spotlight}),onClick:r,title:(0,l._t)("room|header|video_call_ec_change_layout"),alignment:si.v.Bottom,key:"layout"}),m)};class U_ extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"client",this.props.room.client),(0,k.Z)(this,"featureAskToJoinWatcher",void 0),(0,k.Z)(this,"onRightPanelStoreUpdate",(()=>{this.setState({rightPanelOpen:nm.Z.instance.isOpen})})),(0,k.Z)(this,"onRoomStateEvents",(e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&this.rateLimitedUpdate()})),(0,k.Z)(this,"onNotificationUpdate",(()=>{this.forceUpdate()})),(0,k.Z)(this,"rateLimitedUpdate",(0,ln.throttle)((()=>{this.forceUpdate()}),500,{leading:!0,trailing:!0})),(0,k.Z)(this,"onContextMenuOpenClick",(e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})})),(0,k.Z)(this,"onContextMenuCloseClick",(()=>{this.setState({contextMenuPosition:void 0})})),(0,k.Z)(this,"onHideCallClick",(e=>{e.preventDefault(),x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.props.room.roomId,view_call:!1,metricsTrigger:void 0})}));Zr.v.instance.getRoomState(e.room).on(E_.$p.Update,this.onNotificationUpdate),this.state={rightPanelOpen:nm.Z.instance.isOpen,featureAskToJoin:L.C.getValue("feature_ask_to_join")},this.featureAskToJoinWatcher=L.C.watchSetting("feature_ask_to_join",null,((e,t,i,n,s)=>{this.setState({featureAskToJoin:s})}))}componentDidMount(){this.client.on(n.RoomStateEvent.Events,this.onRoomStateEvents),nm.Z.instance.on(Pa.a,this.onRightPanelStoreUpdate)}componentWillUnmount(){this.client.removeListener(n.RoomStateEvent.Events,this.onRoomStateEvents);Zr.v.instance.getRoomState(this.props.room).removeListener(E_.$p.Update,this.onNotificationUpdate),nm.Z.instance.off(Pa.a,this.onRightPanelStoreUpdate),L.C.unwatchSetting(this.featureAskToJoinWatcher)}renderButtons(e){var t;const i=[];this.props.viewingCall||!this.props.inRoom||this.context.tombstone||i.push(o.createElement(A_,{key:"calls",room:this.props.room})),this.props.viewingCall&&this.props.activeCall instanceof Lt.gk&&i.push(o.createElement(L_,{key:"layout",call:this.props.activeCall})),!this.props.viewingCall&&this.props.onForgetClick&&i.push(o.createElement(gs.Z,{className:"mx_LegacyRoomHeader_button mx_LegacyRoomHeader_forgetButton",onClick:this.props.onForgetClick,title:(0,l._t)("room|header|forget_room_button"),alignment:si.v.Bottom,key:"forget"})),!this.props.viewingCall&&this.props.onAppsClick&&i.push(o.createElement(gs.Z,{className:yt()("mx_LegacyRoomHeader_button mx_LegacyRoomHeader_appsButton",{mx_LegacyRoomHeader_appsButton_highlight:this.props.appsShown}),onClick:this.props.onAppsClick,title:this.props.appsShown?(0,l._t)("room|header|hide_widgets_button"):(0,l._t)("room|header|show_widgets_button"),"aria-checked":this.props.appsShown,alignment:si.v.Bottom,key:"apps"})),!this.props.viewingCall&&this.props.onSearchClick&&this.props.inRoom&&i.push(o.createElement(gs.Z,{className:"mx_LegacyRoomHeader_button mx_LegacyRoomHeader_searchButton",onClick:this.props.onSearchClick,title:(0,l._t)("action|search"),alignment:si.v.Bottom,key:"search"})),this.props.onInviteClick&&(!this.props.viewingCall||e)&&this.props.inRoom&&i.push(o.createElement(gs.Z,{className:"mx_LegacyRoomHeader_button mx_LegacyRoomHeader_inviteButton",onClick:this.props.onInviteClick,title:(0,l._t)("action|invite"),alignment:si.v.Bottom,key:"invite"}));const n=[];return this.props.viewingCall&&!e&&(null===this.props.activeCall?n.push(o.createElement(ae.Z,{className:"mx_LegacyRoomHeader_button mx_LegacyRoomHeader_closeButton",onClick:this.onHideCallClick,title:(0,l._t)("room|header|close_call_button"),key:"close"})):n.push(o.createElement(gs.Z,{className:"mx_LegacyRoomHeader_button mx_LegacyRoomHeader_minimiseButton",onClick:this.onHideCallClick,title:(0,l._t)("room|header|video_room_view_chat_button"),alignment:si.v.Bottom,key:"minimise"}))),o.createElement(o.Fragment,null,null===(t=this.props.additionalButtons)||void 0===t?void 0:t.map((e=>{const t=e.label();return o.createElement(sm.u,{label:t,key:e.id},o.createElement(sm.hU,{onClick:()=>{e.onClick(),this.forceUpdate()},title:t},"function"==typeof e.icon?e.icon():e.icon))})),i,o.createElement(c_,{room:this.props.room,excludedRightPanelPhaseButtons:this.props.excludedRightPanelPhaseButtons}),n)}renderName(e){let t=null;this.state.contextMenuPosition&&this.props.room&&(t=o.createElement(__,(0,kt.Z)({},(0,f_.xR)(this.state.contextMenuPosition),{room:this.props.room,onFinished:this.onContextMenuCloseClick})));let i=!1;const n=this.props.room?this.props.room.getJoinedMembers():void 0;if(n&&1===n.length&&n[0].userId===this.client.credentials.userId){const e=this.props.room.currentState.getStateEvents("m.room.name","");e&&e.getContent().name||(i=!0)}const s=yt()("mx_LegacyRoomHeader_nametext",{mx_LegacyRoomHeader_settingsHint:i}),a=o.createElement($s,{room:this.props.room},(t=>{const i=t||e;return o.createElement("div",{dir:"auto",className:s,title:i,role:"heading","aria-level":1},i)}));return this.props.enableRoomOptionsMenu&&(0,hr.I)(Ye.y.RoomOptionsMenu)?o.createElement(ii.JY,{className:"mx_LegacyRoomHeader_name",onClick:this.onContextMenuOpenClick,isExpanded:!!this.state.contextMenuPosition,title:(0,l._t)("room|context_menu|title"),alignment:si.v.Bottom},a,this.props.room&&o.createElement("div",{className:"mx_LegacyRoomHeader_chevron"}),t):o.createElement("div",{className:"mx_LegacyRoomHeader_name mx_LegacyRoomHeader_name--textonly"},a)}render(){var e;const t=L.C.getValue("feature_video_rooms")&&R_(this.props.room);let i=null;this.props.room&&(i=o.createElement(us.Z,{room:this.props.room,size:"24px",oobData:this.props.oobData,viewAvatarOnClick:!0}));const n=this.props.viewingCall?o.createElement("div",{className:"mx_LegacyRoomHeader_icon mx_LegacyRoomHeader_icon_video"}):this.props.e2eStatus?o.createElement(Es.Z,{className:"mx_LegacyRoomHeader_icon",status:this.props.e2eStatus,tooltipAlignment:si.v.Bottom}):this.client.isRoomEncrypted(this.props.room.roomId)&&this.client.isCryptoEnabled()?o.createElement("div",{className:"mx_LegacyRoomHeader_icon"}):null,s=this.props.showButtons?this.renderButtons(t):null;let a=(0,l._t)("common|unnamed_room");this.props.oobData&&this.props.oobData.name&&(a=this.props.oobData.name);const r=this.renderName(a);var c;if(this.props.viewingCall&&!t)return o.createElement("header",{className:"mx_LegacyRoomHeader light-panel"},o.createElement("div",{className:"mx_LegacyRoomHeader_wrapper","aria-owns":this.state.rightPanelOpen?"mx_RightPanel":void 0},o.createElement("div",{className:"mx_LegacyRoomHeader_avatar"},i),n,r,this.props.activeCall instanceof Lt.gk&&o.createElement(T_.f,{session:null===(c=this.props.activeCall)||void 0===c?void 0:c.session}),o.createElement("div",{className:"mx_LegacyRoomHeader_topic"}),s));let d=null;"number"==typeof(null===(e=this.props.searchInfo)||void 0===e?void 0:e.count)&&(d=o.createElement("div",{className:"mx_LegacyRoomHeader_searchStatus"},"Â ",(0,l._t)("room|search|result_count",{count:this.props.searchInfo.count})));const m=o.createElement(sv,{room:this.props.room,className:"mx_LegacyRoomHeader_topic"}),h=t?o.createElement(pr.r,{onClick:()=>x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.Labs}),tooltipTitle:(0,l._t)("labs|video_rooms_beta")}):null;return o.createElement("header",{className:"mx_LegacyRoomHeader light-panel"},o.createElement("div",{className:"mx_LegacyRoomHeader_wrapper","aria-owns":this.state.rightPanelOpen?"mx_RightPanel":void 0},o.createElement(ae.Z,{className:"mx_LegacyRoomHeader_button mx_BaseCard_back",onClick:()=>{document.getElementsByClassName("mx_LeftPanel_outerWrapper")[0].style.display="",x.ZP.dispatch({action:W.a.ViewHomePage})}}),o.createElement("div",{className:"mx_LegacyRoomHeader_avatar"},i),n,r,d,m,h,s),!t&&o.createElement(N_,{roomId:this.props.room.roomId}),o.createElement(x_,{roomId:this.props.room.roomId}),this.state.featureAskToJoin&&o.createElement(h_,{room:this.props.room}))}}(0,k.Z)(U_,"defaultProps",{inRoom:!1,excludedRightPanelPhaseButtons:[],showButtons:!0,enableRoomOptionsMenu:!0}),(0,k.Z)(U_,"contextType",qt.ZP);var F_=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/video-call-solid.svg"),B_=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/voice-call.svg"),V_=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/threads-solid.svg"),j_=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/notifications-solid.svg"),z_=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/verified.svg"),W_=i("../matrix-react-sdk/src/hooks/useRoomName.ts");const H_=["as","flex","shrink","grow","className","children"];function G_(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function K_(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?G_(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):G_(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function q_(e,t,i){const n=e.current.style;i?n.setProperty(t,i):n.removeProperty(t)}function $_(e){let{as:t="div",flex:i=null,shrink:n=null,grow:s=null,className:a,children:r}=e,l=(0,v.Z)(e,H_);const c=(0,o.useRef)();return(0,o.useEffect)((()=>{q_(c,"--mx-box-flex",i),q_(c,"--mx-box-shrink",n),q_(c,"--mx-box-grow",s)}),[i,s,n]),o.createElement(t,K_(K_({},l),{},{className:yt()("mx_Box",a,{"mx_Box--flex":!!i,"mx_Box--shrink":!!n,"mx_Box--grow":!!s}),ref:c}),r)}const J_=async(e,t,i)=>{switch(i){case"legacy_or_jitsi":await lt.ZP.instance.placeCall(e.roomId,t);break;case"element_call":case"jitsi_or_element_call":x.ZP.dispatch({action:W.a.ViewRoom,room_id:e.roomId,view_call:!0,metricsTrigger:void 0})}};var Y_=i("../matrix-react-sdk/src/widgets/ManagedHybrid.ts"),Q_=function(e){return e[e.NoCall=0]="NoCall",e[e.NoOneHere=1]="NoOneHere",e[e.NoPermission=2]="NoPermission",e[e.Unpinned=3]="Unpinned",e[e.Ongoing=4]="Ongoing",e}(Q_||{});const X_=e=>{const t=(0,wt.n)("feature_group_calls"),i=(0,o.useMemo)((()=>c.ZP.get("element_call").use_exclusively),[]),n=(0,In.kZ)(lt.ZP.instance,lt.QC.CallsChanged,(()=>null!==lt.ZP.instance.getCallForRoom(e.roomId))),s=Vp(e),a=(0,o.useMemo)((()=>s.find((e=>Zm.l.JITSI.matches(e.type)))),[s]),r=!!a,d=(0,o.useMemo)((()=>s.find(Y_.$K)),[s]),m=!!d,h=(0,I_.W7)(e.roomId),p=null!==h,u=tv(e),[g,v]=(0,go.c)(e,(()=>[e.currentState.mayClientSendStateEvent("im.vector.modular.widgets",e.client),e.currentState.mayClientSendStateEvent(Lt.gk.CALL_EVENT_TYPE.name,e.client)])),_=(0,o.useMemo)((()=>{if(t){if(p)return"jitsi_or_element_call";if(v&&r)return"jitsi_or_element_call";if(i)return"element_call";if(u<=2)return"legacy_or_jitsi";if(v)return"element_call"}return"legacy_or_jitsi"}),[t,p,v,r,i,u]);let f;if("legacy_or_jitsi"===_)f=null!=a?a:d;else if("element_call"===_)f=null==h?void 0:h.widget;else{var E;f=null!==(E=null==h?void 0:h.widget)&&void 0!==E?E:a}const[y,b]=(0,o.useState)(!1),[w,S]=(0,o.useState)(!1),C=y&&!w,k=(0,o.useCallback)((()=>{b(Nm.z3.instance.canAddToContainer(e,Nm.W2.Top)),S(!!f&&Nm.z3.instance.isInContainer(e,f,Nm.W2.Top))}),[e,f]);(0,In.x2)(Nm.z3.instance,Nm.z3.emissionForRoom(e),k),(0,o.useEffect)((()=>{k()}),[e,a,h,k]);const x=(0,o.useMemo)((()=>p||r||m?C?Q_.Unpinned:Q_.Ongoing:n?Q_.Ongoing:u<=1?Q_.NoOneHere:v||g?Q_.NoCall:Q_.NoPermission),[p,r,n,m,v,g,u,C]),R=(0,o.useCallback)((t=>{t.stopPropagation(),f&&C?Nm.z3.instance.moveToContainer(e,f,Nm.W2.Top):J_(e,xt.rf.Voice,_)}),[C,e,f,_]),I=(0,o.useCallback)((t=>{t.stopPropagation(),f&&C?Nm.z3.instance.moveToContainer(e,f,Nm.W2.Top):J_(e,xt.rf.Video,_)}),[f,C,e,_]);let P,T;switch(x){case Q_.NoPermission:P=(0,l._t)("voip|disabled_no_perms_start_voice_call"),T=(0,l._t)("voip|disabled_no_perms_start_video_call");break;case Q_.Ongoing:P=(0,l._t)("voip|disabled_ongoing_call"),T=(0,l._t)("voip|disabled_ongoing_call");break;case Q_.NoOneHere:P=(0,l._t)("voip|disabled_no_one_here"),T=(0,l._t)("voip|disabled_no_one_here");break;case Q_.Unpinned:case Q_.NoCall:P=null,T=null}return{voiceCallDisabledReason:P,voiceCallClick:R,videoCallDisabledReason:T,videoCallClick:I}},ef=e=>{const[t,i]=(0,o.useState)(Sr.v.None),s=(0,o.useCallback)((()=>{switch(null==e?void 0:e.threadsAggregateNotificationType){case n.NotificationCountType.Highlight:i(Sr.v.Red);break;case n.NotificationCountType.Total:i(Sr.v.Grey)}for(const t of e.getThreads())if((0,s_.h5)(t)){i(Sr.v.Bold);break}}),[e]);return(0,In.x2)(e,n.RoomEvent.UnreadNotifications,s),(0,In.x2)(e,n.RoomEvent.Receipt,s),(0,In.x2)(e,n.RoomEvent.Timeline,s),(0,In.x2)(e,n.RoomEvent.Redaction,s),(0,In.x2)(e,n.RoomEvent.LocalEchoUpdated,s),(0,In.x2)(e,n.RoomEvent.MyMembership,s),(0,In.x2)(e,n.ThreadEvent.New,s),(0,In.x2)(e,n.ThreadEvent.Update,s),(0,o.useEffect)((()=>{s()}),[s]),t},tf=()=>{const[e,t]=(0,o.useState)(Zr.v.instance.globalState);return(0,In.x2)(Zr.v.instance,Zr.w,(e=>{t(e)})),e};var nf=i("../matrix-react-sdk/node_modules/@vector-im/compound-design-tokens/icons/chat-solid.svg");const sf=({room:e})=>{const t=(0,o.useContext)(ie.f),i=R_(e),n=i?t.roomNotificationStateStore.getRoomState(e):void 0,s=(0,In.kZ)(n,E_.$p.Update,(()=>null==n?void 0:n.color));if(!i)return null;const a=!!s&&[Sr.v.Bold,Sr.v.Grey,Sr.v.Red].includes(s);return o.createElement(sm.u,{label:(0,l._t)("right_panel|video_room_chat|title")},o.createElement(sm.hU,{"aria-label":(0,l._t)("right_panel|video_room_chat|title"),onClick:e=>{e.stopPropagation(),t.rightPanelStore.showOrHidePanel(im.q.Timeline)},indicator:a?"default":void 0},o.createElement(nf.J,null)))};function of(e){return e<=Sr.v.None?void 0:e<=Sr.v.Grey?"default":"highlight"}function af({room:e,additionalButtons:t}){const i=(0,pn.wb)(),s=(0,W_.w)(e),a=ro(e),r=(0,go.c)(e),d=ev(e,2500),m=tv(e,{throttleWait:2500}),{voiceCallDisabledReason:h,voiceCallClick:p,videoCallDisabledReason:u,videoCallClick:g}=X_(e),v=(0,wt.n)("feature_group_calls"),_=(0,o.useMemo)((()=>c.ZP.get("element_call").use_exclusively&&v),[v]),f=ef(e),E=tf(),y=Bp(i,n.EventType.Direct),[b,w]=(0,o.useState)(!1);(0,o.useEffect)((()=>{for(const[,i]of Object.entries(y)){var t;if(i.includes(null!==(t=null==e?void 0:e.roomId)&&void 0!==t?t:"")){w(!0);break}}}),[e,y]);const S=function(e,t){const[i,n]=(0,o.useState)(null);return(0,o.useEffect)((()=>{e.isCryptoEnabled()&&(0,Rm.b)(e,t).then((e=>{n(e)}))}),[e,t]),i}(i,e),C=(0,wt.n)("feature_notifications"),k=(0,o.useMemo)((()=>(0,hn.E_)(null==a?void 0:a.text,null==a?void 0:a.html)),[null==a?void 0:a.html,null==a?void 0:a.text]);return o.createElement(Op,{as:"header",align:"center",gap:"var(--cpd-space-3x)",className:"mx_RoomHeader light-panel"},o.createElement("button",{"aria-label":(0,l._t)("right_panel|room_summary_card|title"),tabIndex:0,onClick:()=>{nm.Z.instance.showOrHidePanel(im.q.RoomSummary)},className:"mx_RoomHeader_infoWrapper"},o.createElement(ei.Z,{room:e,size:"40px"}),o.createElement($_,{flex:"1",className:"mx_RoomHeader_info"},o.createElement(sm.uT,{as:"div",size:"lg",weight:"semibold",dir:"auto",role:"heading","aria-level":1,className:"mx_RoomHeader_heading"},o.createElement("span",{className:"mx_RoomHeader_truncated mx_lineClamp"},s),!b&&r.getJoinRule()===n.JoinRule.Public&&o.createElement(sm.u,{label:(0,l._t)("common|public_room"),side:"right"},o.createElement(fm.J,{width:"16px",height:"16px",className:"mx_RoomHeader_icon text-secondary","aria-label":(0,l._t)("common|public_room")})),b&&S===Rm._.Verified&&o.createElement(sm.u,{label:(0,l._t)("common|verified"),side:"right"},o.createElement(z_.J,{width:"16px",height:"16px",className:"mx_RoomHeader_icon mx_Verified","aria-label":(0,l._t)("common|verified")})),b&&S===Rm._.Warning&&o.createElement(sm.u,{label:(0,l._t)("room|header_untrusted_label"),side:"right"},o.createElement(Em.J,{width:"16px",height:"16px",className:"mx_RoomHeader_icon mx_Untrusted","aria-label":(0,l._t)("room|header_untrusted_label")}))),a&&o.createElement(sm.uT,{as:"div",size:"sm",className:"mx_RoomHeader_topic mx_RoomHeader_truncated mx_lineClamp"},o.createElement(hn.zR,null,k)))),o.createElement(Op,{as:"nav",align:"center",gap:"var(--cpd-space-2x)"},null==t?void 0:t.map((e=>{const t=e.label();return o.createElement(sm.u,{label:t,key:e.id},o.createElement(sm.hU,{"aria-label":t,onClick:t=>{t.stopPropagation(),e.onClick()}},"function"==typeof e.icon?e.icon():e.icon))})),o.createElement(sm.u,{label:u||(0,l._t)("voip|video_call")},o.createElement(sm.hU,{disabled:!!u,"aria-label":u||(0,l._t)("voip|video_call"),onClick:g},o.createElement(F_.J,null))),!_&&o.createElement(sm.u,{label:h||(0,l._t)("voip|voice_call")},o.createElement(sm.hU,{disabled:!!h,"aria-label":h||(0,l._t)("voip|voice_call"),onClick:p},o.createElement(B_.J,null))),o.createElement(sf,{room:e}),o.createElement(sm.u,{label:(0,l._t)("common|threads")},o.createElement(sm.hU,{indicator:of(f),onClick:e=>{e.stopPropagation(),nm.Z.instance.showOrHidePanel(im.q.ThreadPanel),kn.Z.trackInteraction("WebRoomHeaderButtonsThreadsButton",e)},"aria-label":(0,l._t)("common|threads")},o.createElement(V_.J,null))),C&&o.createElement(sm.u,{label:(0,l._t)("notifications|enable_prompt_toast_title")},o.createElement(sm.hU,{indicator:of(E.color),onClick:e=>{e.stopPropagation(),nm.Z.instance.showOrHidePanel(im.q.NotificationPanel)},"aria-label":(0,l._t)("notifications|enable_prompt_toast_title")},o.createElement(j_.J,null)))),!b&&o.createElement(sm.uT,{as:"div",size:"sm",weight:"medium","aria-label":(0,l._t)("common|n_members",{count:m}),onClick:e=>{nm.Z.instance.showOrHidePanel(im.q.RoomMemberList),e.stopPropagation()}},o.createElement(ov.Z,{className:"mx_RoomHeader_members",members:d.slice(0,3),size:"20px",overflow:!1,viewUserOnClick:!1},(0,It.CZ)(m))))}const rf=({roomWidth:e})=>{const t=(0,o.useRef)(null),n=(0,o.useRef)(new Map);return(0,o.useEffect)((()=>{const e=()=>{var e;t.current&&(null===(e=t.current)||void 0===e?void 0:e.height)!==mr.default.instance.windowHeight&&(t.current.height=mr.default.instance.windowHeight)},s=x.ZP.register((e=>{const s="effects.";if(t.current&&e.action.startsWith(s)){(async e=>{if(!e)return null;let t=n.current.get(e)||null;if(null===t){var s;const o=null===(s=Hm.b.find((t=>t.command===e)))||void 0===s?void 0:s.options;try{const{default:s}=await i("../matrix-react-sdk/src/effects lazy recursive ^\\.\\/.*$ referencedExports: default")(`./${e}`);t=new s(o),n.current.set(e,t)}catch(t){r.k.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.slice(8)).then((e=>null==e?void 0:e.start(t.current)))}})),o=t.current;return o&&(o.height=mr.default.instance.windowHeight),mr.default.instance.on(mr.Q.Resize,e),()=>{x.ZP.unregister(s),mr.default.instance.off(mr.Q.Resize,e);const t=n.current;for(const e in t){const i=t.get(e);i&&i.isRunning&&i.stop()}}}),[]),o.createElement("canvas",{ref:t,width:e,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0},"aria-hidden":!0})};var lf=i("../matrix-react-sdk/src/stores/CallStore.ts");const cf=({kind:e,devices:t,setDevice:i,deviceListLabel:n,muted:s,disabled:a,toggle:r,unmutedTitle:l,mutedTitle:c})=>{const[d,m,h,p]=(0,ii.av)(),u=(0,o.useCallback)((e=>{i(e),p()}),[i,p]);let g=null;if(d){const e=m.current.getBoundingClientRect();g=o.createElement(ur.ZP,(0,kt.Z)({},(0,ii.vT)(e,void 0,10),{onFinished:p}),o.createElement(ur.I2,null,t.map((e=>o.createElement(ur.$k,{key:e.deviceId,label:e.label,onClick:()=>u(e)})))))}return t.length?o.createElement("div",{className:yt()("mx_CallView_deviceButtonWrapper",{mx_CallView_deviceButtonWrapper_muted:s})},o.createElement(gs.Z,{className:`mx_CallView_deviceButton mx_CallView_deviceButton_${e}`,inputRef:m,title:s?c:l,alignment:si.v.Top,onClick:r,disabled:a}),t.length>1?o.createElement(ii.lX,{className:"mx_CallView_deviceListButton",onClick:h,isExpanded:d,label:n,disabled:a}):null,g):null},df=({room:e,joinCallButtonDisabledTooltip:t,connect:i,children:n})=>{const[s,a]=(0,o.useState)(!1),c=(0,o.useMemo)((()=>e.getMember(e.myUserId)),[e]),d=(0,o.useRef)(null),[m,h]=(0,o.useState)((()=>Ka.ZP.getVideoInput())),[p,u]=(0,o.useState)((()=>Ka.ZP.startWithAudioMuted)),[g,v]=(0,o.useState)((()=>Ka.ZP.startWithVideoMuted)),_=(0,o.useCallback)((()=>{Ka.ZP.startWithAudioMuted=!p,u(!p)}),[p,u]),f=(0,o.useCallback)((()=>{Ka.ZP.startWithVideoMuted=!g,v(!g)}),[g,v]),E=e=>{Ka.ZP.startWithAudioMuted=!0,Ka.ZP.startWithVideoMuted=!0,r.k.warn(e)},[y,b,w]=(0,Pn.G)((async()=>{var e,t,i,n;let s;try{if(s=await Ka.ZP.getDevices(),void 0===s)return E("Could not access devices!"),[null,[],[]]}catch(e){return E(`Unable to get Media Devices: ${e}`),[null,[],[]]}let o=null;try{s.audioinput.length>0?o=await navigator.mediaDevices.getUserMedia({audio:!0,video:!g&&s.videoinput.length>0&&{deviceId:m}}):s.videoinput.length>0&&(o=await navigator.mediaDevices.getUserMedia({video:{deviceId:m}}))}catch(e){r.k.warn(`Failed to get stream for device ${m}`,e),E("Have access to Device list but unable to read from Media Devices")}var a;(null!==o&&(s=await Ka.ZP.getDevices()),g)&&(null===(a=o)||void 0===a||a.getTracks().forEach((e=>e.stop())),o=null);return[o,null!==(e=null===(t=s)||void 0===t?void 0:t.audioinput)&&void 0!==e?e:[],null!==(i=null===(n=s)||void 0===n?void 0:n.videoinput)&&void 0!==i?i:[]]}),[m,g],[null,[],[]]),S=(0,o.useCallback)((e=>{Ka.ZP.instance.setAudioInput(e.deviceId)}),[]),C=(0,o.useCallback)((e=>{Ka.ZP.instance.setVideoInput(e.deviceId),h(e.deviceId)}),[]);(0,o.useEffect)((()=>{if(y){const e=d.current;return e.srcObject=y,e.play(),()=>{y.getTracks().forEach((e=>e.stop())),e.srcObject=null}}}),[y]);const k=(0,o.useCallback)((async e=>{e.preventDefault(),a(!0);try{await i()}catch(e){r.k.error(e),a(!1)}}),[i,a]);return o.createElement("div",{className:"mx_CallView_lobby"},n,o.createElement("div",{className:"mx_CallView_preview"},o.createElement(Vt.Z,{key:c.userId,member:c,size:"200px",resizeMethod:"scale"}),o.createElement("video",{ref:d,style:{visibility:g?"hidden":void 0},muted:!0,playsInline:!0,disablePictureInPicture:!0}),o.createElement("div",{className:"mx_CallView_controls"},o.createElement(cf,{kind:"audio",devices:b,setDevice:S,deviceListLabel:(0,l._t)("voip|audio_devices"),muted:p,disabled:s,toggle:_,unmutedTitle:(0,l._t)("voip|disable_microphone"),mutedTitle:(0,l._t)("voip|enable_microphone")}),o.createElement(cf,{kind:"video",devices:w,setDevice:C,deviceListLabel:(0,l._t)("voip|video_devices"),muted:g,disabled:s,toggle:f,unmutedTitle:(0,l._t)("voip|disable_camera"),mutedTitle:(0,l._t)("voip|enable_camera")}))),o.createElement(gs.Z,{className:"mx_CallView_connectButton",kind:"primary",disabled:s||void 0!==t,onClick:k,label:(0,l._t)("action|join"),tooltip:s?(0,l._t)("voip|connecting"):t,alignment:si.v.Bottom}))},mf=({room:e,resizing:t,call:i,setStartingCall:n})=>{const s=(0,o.useContext)(pn.ZP),a=(0,o.useRef)();void 0===a.current&&(a.current=(0,xa.PQ)());const r=a.current,[l,c]=(0,o.useState)((()=>null!==i&&(0,Lt.Mb)(i.connectionState)));(0,o.useEffect)((()=>{if(null!==i){const e=e=>c((0,Lt.Mb)(e));return i.on(Lt.nP.ConnectionState,e),()=>{i.off(Lt.nP.ConnectionState,e)}}}),[i]);const d=(0,o.useCallback)((async()=>{n(!0),await Lt.gk.create(e),await r.promise}),[e,n,r]);return(0,o.useEffect)((()=>{(async()=>{if(null!==i)try{await Promise.all([...lf.c.instance.activeCalls].map((e=>e.disconnect()))),await i.connect(),r.resolve()}catch(e){r.reject(e)}})()}),[i,r]),o.createElement("div",{className:"mx_CallView"},l?null:o.createElement(df,{room:e,connect:d}),null!==i&&o.createElement(Eu,{app:i.widget,room:e,userId:s.credentials.userId,creatorUserId:i.widget.creatorUserId,waitForIframeLoad:i.widget.waitForIframeLoad,showMenubar:!1,pointerEvents:t?"none":void 0}))},hf=({room:e,resizing:t,call:i})=>{const n=(0,o.useContext)(pn.ZP),s=(0,Lt.Mb)((0,I_.z1)(i)),a=(0,I_.O_)(i),r=(0,I_.$6)(i),c=(0,o.useCallback)((async()=>{await Promise.all([...lf.c.instance.activeCalls].map((e=>e.disconnect()))),await i.connect()}),[i]);(0,o.useEffect)((()=>{i.clean()}),[i]);let d=null;if(!s){let t=null;if(a.length){const e=a.slice(0,8),i=a.length>e.length;t=o.createElement("div",{className:"mx_CallView_participants"},(0,l._t)("voip|n_people_joined",{count:a.length}),o.createElement(ov.Z,{members:e,size:"24px",overflow:i}))}d=o.createElement(df,{room:e,connect:c,joinCallButtonDisabledTooltip:null!=r?r:void 0},t)}return o.createElement("div",{className:"mx_CallView"},d,o.createElement(Eu,{app:i.widget,room:e,userId:n.credentials.userId,creatorUserId:i.widget.creatorUserId,waitForIframeLoad:i.widget.waitForIframeLoad,showMenubar:!1,pointerEvents:t?"none":void 0}))},pf=({room:e,resizing:t,waitForCall:i})=>{const n=(0,I_.W7)(e.roomId),[s,a]=(0,o.useState)(!1);return null===n||s?i?null:o.createElement(mf,{room:e,resizing:t,call:n,setStartingCall:a}):o.createElement(hf,{room:e,resizing:t,call:n})};var uf=i("../matrix-react-sdk/src/toasts/DesktopNotificationsToast.ts"),gf=i("../matrix-react-sdk/src/email.ts");const vf=(e,t)=>{const[i,n]=(0,o.useState)((()=>Array.isArray(t)?t:new Array(e).fill(t)));return[i,(e,t)=>n((i=>{const n=[...i];return n[e]=t,n}))]};var _f=i("../matrix-react-sdk/src/components/views/spaces/SpacePublicShare.tsx"),ff=i("../matrix-js-sdk/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),Ef=i("../matrix-js-sdk/src/@types/event.ts");class yf{constructor(e,t,i,n=!1){this.root=e,this.pageSize=t,this.maxDepth=i,this.suggestedOnly=n,(0,ff.Z)(this,"viaMap",new Map),(0,ff.Z)(this,"backRefs",new Map),(0,ff.Z)(this,"roomMap",new Map),(0,ff.Z)(this,"loadRequest",void 0),(0,ff.Z)(this,"nextBatch",void 0),(0,ff.Z)(this,"_rooms",void 0),(0,ff.Z)(this,"serverSupportError",void 0)}get noSupport(){return!!this.serverSupportError}get canLoadMore(){return!!this.serverSupportError||!!this.nextBatch||!this._rooms}get loading(){return!!this.loadRequest}get rooms(){return this._rooms}async load(e=this.pageSize){if(this.loadRequest)return this.loadRequest.then((e=>e.rooms));let t;this.loadRequest=this.root.client.getRoomHierarchy(this.root.roomId,e,this.maxDepth,this.suggestedOnly,this.nextBatch);try{({rooms:t,next_batch:this.nextBatch}=await this.loadRequest)}catch(e){if("M_UNRECOGNIZED"!==e.errcode)throw e;return this.serverSupportError=e,[]}finally{this.loadRequest=void 0}return this._rooms?this._rooms=this._rooms.concat(t):this._rooms=t,t.forEach((e=>{this.roomMap.set(e.room_id,e),e.children_state.forEach((t=>{if(t.type!==Ef.tw.SpaceChild)return;const i=t.state_key;if(this.backRefs.has(i)||this.backRefs.set(i,[]),this.backRefs.get(i).push(e.room_id),Array.isArray(t.content.via)){this.viaMap.has(i)||this.viaMap.set(i,new Set);const e=this.viaMap.get(i);t.content.via.forEach((t=>e.add(t)))}}))})),t}getRelation(e,t){var i;return null===(i=this.roomMap.get(e))||void 0===i?void 0:i.children_state.find((e=>e.state_key===t))}isSuggested(e,t){var i;return null===(i=this.getRelation(e,t))||void 0===i?void 0:i.content.suggested}removeRelation(e,t){const i=this.backRefs.get(t);1===(null==i?void 0:i.length)?this.backRefs.delete(t):null!=i&&i.length&&this.backRefs.set(t,i.filter((t=>t!==e)));const n=this.roomMap.get(e);n&&(n.children_state=n.children_state.filter((e=>e.state_key!==t)))}}var bf=i("../matrix-react-sdk/src/components/views/elements/InfoTooltip.tsx"),wf=i("../matrix-react-sdk/src/utils/RoomUpgrade.ts");function Sf(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Cf(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Sf(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Sf(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const kf=({room:e,suggested:t,selected:i,hasPermissions:s,onToggleClick:a,onViewRoomClick:r,onJoinRoomClick:c,numChildRooms:d,children:m})=>{var h,p;const u=(0,o.useContext)(pn.ZP),g=(0,In.A_)(u,n.ClientEvent.Room,(()=>{const t=null==u?void 0:u.getRoom(e.room_id);return"join"===(null==t?void 0:t.getMyMembership())?t:void 0})),v=(0,In.A_)(g,n.RoomEvent.Name,(e=>null==e?void 0:e.name)),_=v||e.name||e.canonical_alias||(null===(h=e.aliases)||void 0===h?void 0:h[0])||(e.room_type===n.RoomType.Space?(0,l._t)("common|unnamed_space"):(0,l._t)("common|unnamed_room")),[f,E]=(0,mo.R)(!0),[y,b,w]=(0,Gi.XZ)(),[S,C]=(0,o.useState)(!1),k=e=>{e.preventDefault(),e.stopPropagation(),r()},x=async t=>{C(!0),t.preventDefault(),t.stopPropagation(),c().then((()=>(0,wf.n)(u,e.room_id))).finally((()=>{C(!1)}))};let R,I,P;R=S?o.createElement(gs.Z,{disabled:!0,onClick:x,kind:"primary_outline",onFocus:y,tabIndex:b?0:-1,title:(0,l._t)("space|joining_space")},o.createElement(re.Z,{w:24,h:24})):g?o.createElement(ae.Z,{onClick:k,kind:"primary_outline",onFocus:y,tabIndex:b?0:-1},(0,l._t)("action|view")):o.createElement(ae.Z,{onClick:x,kind:"primary",onFocus:y,tabIndex:b?0:-1},(0,l._t)("action|join")),a&&(I=s?o.createElement(qs.Z,{checked:!!i,onChange:a,tabIndex:b?0:-1}):o.createElement(Bm.Z,{tooltip:(0,l._t)("space|user_lacks_permission"),onClick:e=>{e.stopPropagation()}},o.createElement(qs.Z,{disabled:!0,tabIndex:b?0:-1}))),P=g?o.createElement(ei.Z,{room:g,size:"20px"}):o.createElement(ys.Z,{name:_,idName:e.room_id,url:e.avatar_url?(0,mn.TS)(e.avatar_url).getSquareThumbnailHttp(20):null,size:"20px"});let T,Z,N,D,M=(0,l._t)("common|n_members",{count:null!==(p=e.num_joined_members)&&void 0!==p?p:0});if(void 0!==d&&(M+=" Â· "+(0,l._t)("common|n_rooms",{count:d})),g){const e=ao(g);T=(0,hn.E_)(null==e?void 0:e.text,null==e?void 0:e.html)}else T=e.topic;T&&(Z=o.createElement(hn.zR,{options:{attributes:{onClick(e){e.stopPropagation()}}}}," Â· ",T)),g&&(N=o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_joined"},(0,l._t)("common|joined"))),!t||g&&!s||(D=o.createElement(bf.Z,{tooltip:(0,l._t)("space|suggested_tooltip")},(0,l._t)("space|suggested")));const O=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_item"},o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_avatar"},P),o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_name"},_,N,D),o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_info"},M,Z)),o.createElement("div",{className:"mx_SpaceHierarchy_actions"},R,I));let A,L,U;if(m){if(A=o.createElement("div",{className:yt()("mx_SpaceHierarchy_subspace_toggle",{mx_SpaceHierarchy_subspace_toggle_shown:f}),onClick:e=>{e.stopPropagation(),E()}}),f){const e=e=>{var t;if((0,dr.zL)().getAccessibilityAction(e)===tn.vB.ArrowLeft)e.preventDefault(),e.stopPropagation(),null===(t=w.current)||void 0===t||t.focus()};L=o.createElement("div",{className:"mx_SpaceHierarchy_subspace_children",onKeyDown:e,role:"group"},m)}U=e=>{let t=!1;switch((0,dr.zL)().getAccessibilityAction(e)){case tn.vB.ArrowLeft:f&&(t=!0,E());break;case tn.vB.ArrowRight:if(t=!0,f){var i,n;const e=null===(i=w.current)||void 0===i?void 0:i.nextElementSibling;null==e||null===(n=e.querySelector(".mx_SpaceHierarchy_roomTile"))||void 0===n||n.focus()}else E()}t&&(e.preventDefault(),e.stopPropagation())}}return o.createElement("li",{className:"mx_SpaceHierarchy_roomTileWrapper",role:"treeitem","aria-selected":i,"aria-expanded":m?f:void 0},o.createElement(ae.Z,{className:yt()("mx_SpaceHierarchy_roomTile",{mx_SpaceHierarchy_subspace:e.room_type===n.RoomType.Space,mx_SpaceHierarchy_joining:S}),onClick:s&&a?a:k,onKeyDown:U,inputRef:w,onFocus:y,tabIndex:b?0:-1},O,A),L)},xf=(e,t,i,n)=>{var s,o;const a=t.roomMap.get(i);if(e.isGuest()&&!(null!=a&&a.world_readable||null!=a&&a.guest_can_join))return void x.ZP.dispatch({action:"require_registration"});const r=(0,Ia.AH)(null!==(s=null==a?void 0:a.canonical_alias)&&void 0!==s?s:"",null!==(o=null==a?void 0:a.aliases)&&void 0!==o?o:[])||void 0;x.ZP.dispatch({action:W.a.ViewRoom,should_peek:!0,room_alias:r,room_id:i,via_servers:Array.from(t.viaMap.get(i)||[]),oob_data:{avatarUrl:null==a?void 0:a.avatar_url,name:(null==a?void 0:a.name)||r||(0,l._t)("common|unnamed_room"),roomType:n},metricsTrigger:"RoomDirectory"})},Rf=async(e,t,i)=>{if(e.isGuest())x.ZP.dispatch({action:"require_registration"});else{try{await e.joinRoom(i,{viaServers:Array.from(t.viaMap.get(i)||[])})}catch(e){return void(e instanceof n.MatrixError?ie.m.instance.roomViewStore.showJoinRoomError(e,i):(r.k.warn("Got a non-MatrixError while joining room",e),ie.m.instance.roomViewStore.showJoinRoomError(new n.MatrixError({error:(0,l._t)("error|unknown")}),i)))}x.ZP.dispatch({action:W.a.JoinRoomReady,roomId:i,metricsTrigger:"SpaceHierarchy"})}},If=({root:e,roomSet:t,hierarchy:i,parents:s,selectedMap:a,onViewRoomClick:r,onJoinRoomClick:l,onToggleClick:c})=>{const d=(0,o.useContext)(pn.ZP),m=d.getRoom(e.room_id),h=null==m?void 0:m.currentState.maySendStateEvent(n.EventType.SpaceChild,d.getSafeUserId()),p=(0,ln.sortBy)(e.children_state,(e=>(0,Rs.S_)(e.content.order,e.origin_server_ts,e.state_key))),[u,g]=p.reduce(((e,s)=>{const o=i.roomMap.get(s.state_key);return o&&t.has(o)&&e[o.room_type===n.RoomType.Space?0:1].push(((e,t,i)=>{const s=e.getRoomUpgradeHistory(t.room_id,!0,L.C.getValue("feature_dynamic_room_predecessors"));let o=null;for(let e=s.length-1;e>=0;--e)if(i.roomMap.get(s[e].roomId)){o=s[e];break}var a,r,l,c,d;return o?Cf(Cf({},t),{},{room_id:o.roomId,room_type:o.getType(),name:o.name,topic:null===(a=o.currentState.getStateEvents(n.EventType.RoomTopic,""))||void 0===a?void 0:a.getContent().topic,avatar_url:null!==(r=o.getMxcAvatarUrl())&&void 0!==r?r:void 0,canonical_alias:null!==(l=o.getCanonicalAlias())&&void 0!==l?l:void 0,aliases:o.getAltAliases(),world_readable:(null===(c=o.currentState.getStateEvents(n.EventType.RoomHistoryVisibility,""))||void 0===c?void 0:c.getContent().history_visibility)===n.HistoryVisibility.WorldReadable,guest_can_join:(null===(d=o.currentState.getStateEvents(n.EventType.RoomGuestAccess,""))||void 0===d?void 0:d.getContent().guest_access)===n.GuestAccess.CanJoin,num_joined_members:o.getJoinedMemberCount()}):t})(d,o,i)),e}),[[],[]]),v=new Set(s).add(e.room_id);return o.createElement(o.Fragment,null,(0,ln.uniqBy)(g,"room_id").map((t=>{var n;return o.createElement(kf,{key:t.room_id,room:t,suggested:i.isSuggested(e.room_id,t.room_id),selected:null==a||null===(n=a.get(e.room_id))||void 0===n?void 0:n.has(t.room_id),onViewRoomClick:()=>r(t.room_id,t.room_type),onJoinRoomClick:()=>l(t.room_id,v),hasPermissions:h,onToggleClick:c?()=>c(e.room_id,t.room_id):void 0})})),u.filter((e=>!v.has(e.room_id))).map((s=>{var d;return o.createElement(kf,{key:s.room_id,room:s,numChildRooms:s.children_state.filter((e=>{const n=i.roomMap.get(e.state_key);return n&&t.has(n)&&!n.room_type})).length,suggested:i.isSuggested(e.room_id,s.room_id),selected:null==a||null===(d=a.get(e.room_id))||void 0===d?void 0:d.has(s.room_id),onViewRoomClick:()=>r(s.room_id,n.RoomType.Space),onJoinRoomClick:()=>l(s.room_id,v),hasPermissions:h,onToggleClick:c?()=>c(e.room_id,s.room_id):void 0},o.createElement(If,{root:s,roomSet:t,hierarchy:i,parents:v,selectedMap:a,onViewRoomClick:r,onJoinRoomClick:l,onToggleClick:c}))})))},Pf=({hierarchy:e,selected:t,setSelected:i,setError:s})=>{const a=(0,o.useContext)(pn.ZP),[r,c]=(0,o.useState)(!1),[d,m]=(0,o.useState)(!1),h=Array.from(t.keys()).flatMap((e=>[...t.get(e).values()].map((t=>[e,t])))),p=h.every((([t,i])=>e.isSuggested(t,i))),u=!h.length||r||d;let g=ae.Z,v={};h.length||(g=gs.Z,v={tooltip:(0,l._t)("space|select_room_below"),alignment:si.v.Top});let _=(0,l._t)("common|saving");return d||(_=p?(0,l._t)("space|unmark_suggested"):(0,l._t)("space|mark_suggested")),o.createElement(o.Fragment,null,o.createElement(g,(0,kt.Z)({},v,{onClick:async()=>{c(!0);try{const t=a.getSafeUserId();for(const[i,s]of h){await a.sendStateEvent(i,n.EventType.SpaceChild,{},s);const o=a.getRoom(s),r=null==o?void 0:o.currentState.getStateEvents(n.EventType.SpaceParent,i);null!=o&&o.currentState.maySendStateEvent(n.EventType.SpaceParent,t)&&Array.isArray(null==r?void 0:r.getContent().via)&&await a.sendStateEvent(s,n.EventType.SpaceParent,{},i),e.removeRelation(i,s)}}catch(e){s((0,l._t)("space|failed_remove_rooms"))}c(!1),i(new Map)},kind:"danger_outline",disabled:u}),r?(0,l._t)("redact|ongoing"):(0,l._t)("action|remove")),o.createElement(g,(0,kt.Z)({},v,{onClick:async()=>{m(!0);try{for(const[i,s]of h){var t;const o=!p,r=null===(t=e.getRelation(i,s))||void 0===t?void 0:t.content;if(!r||r.suggested===o)continue;const l=Cf(Cf({},r),{},{suggested:!p});await a.sendStateEvent(i,n.EventType.SpaceChild,l,s),r.suggested=l.suggested}}catch(e){s("Failed to update some suggestions. Try again later")}m(!1),i(new Map)},kind:"primary_outline",disabled:u}),_))},Tf=({space:e,initialText:t="",showRoom:i,additionalButtons:s})=>{const a=(0,o.useContext)(pn.ZP),[r,c]=(0,o.useState)(t),[d,m]=(0,o.useState)(new Map),{loading:h,rooms:p,hierarchy:u,loadMore:g,error:v}=(e=>{const[t,i]=(0,o.useState)([]),[n,s]=(0,o.useState)(),[a,r]=(0,o.useState)(),l=(0,o.useCallback)((()=>{r(void 0);const t=new yf(e,20);t.load().then((()=>{var n;e===t.root&&i(null!==(n=t.rooms)&&void 0!==n?n:[])}),r),s(t)}),[e]);(0,o.useEffect)(l,[l]),(0,io.P)(x.ZP,(e=>{e.action===W.a.UpdateSpaceHierarchy&&(i([]),l())}));const c=(0,o.useCallback)((async e=>{var t;!n||n.loading||!n.canLoadMore||n.noSupport||a||(await n.load(e).catch(r),i(null!==(t=n.rooms)&&void 0!==t?t:[]))}),[a,n]);return(null==n?void 0:n.root)!==e?{loading:!0,loadMore:c}:{loading:n.loading,rooms:t,hierarchy:n,loadMore:c,error:a}})(e),_=(0,o.useMemo)((()=>{if(null==p||!p.length||!u)return new Set;const e=r.toLowerCase().trim();if(!e)return new Set(p);const t=p.filter((t=>{var i,n;return(null===(i=t.name)||void 0===i?void 0:i.toLowerCase().includes(e))||(null===(n=t.topic)||void 0===n?void 0:n.toLowerCase().includes(e))})),i=new Set,n=[...t.map((e=>e.room_id))];for(;n.length;){var s;const e=n.pop();i.add(e),null===(s=u.backRefs.get(e))||void 0===s||s.forEach((e=>{i.has(e)||n.push(e)}))}return new Set(p.filter((e=>i.has(e.room_id))))}),[p,u,r]),[f,E]=(0,o.useState)("");let y=f;!f&&v&&(y=(0,l._t)("space|failed_load_rooms"));const b=(e=>{const t=t=>{t[0].isIntersecting&&e()},i=(0,o.useRef)();return e=>{i.current?i.current.disconnect():e&&(i.current=new IntersectionObserver(t,{root:e.parentElement,rootMargin:"0px 0px 600px 0px"})),i.current&&e&&i.current.observe(e)}})(g);if(!h&&u.noSupport)return o.createElement("p",null,(0,l._t)("space|incompatible_server_hierarchy"));const w=(e,t)=>{if(E(""),!d.has(e))return void m(new Map(d.set(e,new Set([t]))));const i=d.get(e);i.has(t)?(i.delete(t),m(new Map(d.set(e,new Set(i))))):m(new Map(d.set(e,new Set([...i,t]))))};return o.createElement(Gi.uP,{onKeyDown:(e,t)=>{var i,n;(0,dr.zL)().getAccessibilityAction(e)===tn.vB.ArrowDown&&e.currentTarget.classList.contains("mx_SpaceHierarchy_search")&&(null===(i=t.refs[0])||void 0===i||null===(n=i.current)||void 0===n||n.focus())},handleHomeEnd:!0,handleUpDown:!0},(({onKeyDownHandler:g})=>{let v;if(u&&(!h||null!=p&&p.length)){const t="join"===(null==e?void 0:e.getMyMembership())&&e.currentState.maySendStateEvent(n.EventType.SpaceChild,a.getSafeUserId()),c=u.roomMap.get(e.roomId);let h,p;_.size&&c?h=o.createElement(o.Fragment,null,o.createElement(If,{root:c,roomSet:_,hierarchy:u,parents:new Set,selectedMap:d,onToggleClick:t?w:void 0,onViewRoomClick:(e,t)=>i(a,u,e,t),onJoinRoomClick:async(e,t)=>{for(const e of t){var i;"join"!==(null===(i=a.getRoom(e))||void 0===i?void 0:i.getMyMembership())&&await Rf(a,u,e)}await Rf(a,u,e)}})):u.canLoadMore||(h=o.createElement("div",{className:"mx_SpaceHierarchy_noResults"},o.createElement("h3",null,(0,l._t)("common|no_results_found")),o.createElement("div",null,(0,l._t)("space|no_search_result_hint")))),u.canLoadMore&&(p=o.createElement("div",{ref:b},o.createElement(re.Z,null))),v=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_SpaceHierarchy_listHeader"},o.createElement("h4",{className:"mx_SpaceHierarchy_listHeader_header"},r.trim()?(0,l._t)("space|title_when_query_available"):(0,l._t)("space|title_when_query_unavailable")),o.createElement("div",{className:"mx_SpaceHierarchy_listHeader_buttons"},s,t&&o.createElement(Pf,{hierarchy:u,selected:d,setSelected:m,setError:E}))),y&&o.createElement("div",{className:"mx_SpaceHierarchy_error"},y),o.createElement("ul",{className:"mx_SpaceHierarchy_list",onKeyDown:g,role:"tree","aria-label":(0,l._t)("common|space")},h),p)}else v=o.createElement(re.Z,null);return o.createElement(o.Fragment,null,o.createElement(ps.Z,{className:"mx_SpaceHierarchy_search mx_textinput_icon mx_textinput_search",placeholder:(0,l._t)("space|search_placeholder"),onSearch:c,autoFocus:!0,initialValue:t,onKeyDown:g}),v)}))};var Zf=function(e){return e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms",e}(Zf||{});const Nf=({space:e})=>{const[t,i,s,a]=(0,ii.av)(),r=(0,hr.I)(Ye.y.CreateRooms),c=(0,hr.I)(Ye.y.CreateSpaces),d=(0,wt.n)("feature_video_rooms"),m=(0,wt.n)("feature_element_call_video_rooms");let h=null;if(t){const t=i.current.getBoundingClientRect();h=o.createElement(ur.ZP,{left:t.left+window.scrollX+0,top:t.bottom+window.scrollY+8,chevronFace:ii.N7.None,onFinished:a,className:"mx_RoomTile_contextMenu",compact:!0},o.createElement(ur.I2,{first:!0},r&&o.createElement(o.Fragment,null,o.createElement(ur.$k,{label:(0,l._t)("action|new_room"),iconClassName:"mx_RoomList_iconNewRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),a(),kn.Z.trackInteraction("WebSpaceHomeCreateRoomButton",t),await(0,ko.gS)(e)&&x.ZP.fire(W.a.UpdateSpaceHierarchy)}}),d&&o.createElement(ur.$k,{label:(0,l._t)("action|new_video_room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),a(),await(0,ko.gS)(e,m?n.RoomType.UnstableCall:n.RoomType.ElementVideo)&&x.ZP.fire(W.a.UpdateSpaceHierarchy)}},o.createElement(pr.r,null))),o.createElement(ur.$k,{label:(0,l._t)("action|add_existing_room"),iconClassName:"mx_RoomList_iconAddExistingRoom",onClick:t=>{t.preventDefault(),t.stopPropagation(),a(),(0,ko.aI)(e)}}),c&&o.createElement(ur.$k,{label:(0,l._t)("room_list|add_space_label"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),a(),(0,ko.xR)(e)}},o.createElement(pr.r,null))))}return o.createElement(o.Fragment,null,o.createElement(ii.lX,{kind:"primary",inputRef:i,onClick:s,isExpanded:t,label:(0,l._t)("action|add")},(0,l._t)("action|add")),h)},Df=({space:e})=>{const t=(0,o.useContext)(pn.ZP),i=iv(e),s=t.getSafeUserId(),a=(0,o.useCallback)((()=>{var t;return nm.Z.instance.isOpenForRoom(e.roomId)&&(null===(t=nm.Z.instance.currentCardForRoom(e.roomId))||void 0===t?void 0:t.phase)===im.q.SpaceMemberList}),[e.roomId]),r=(0,In.kZ)(nm.Z.instance,Pa.a,a);let c;(0,ko.dp)(e)&&(0,hr.I)(Ye.y.InviteUsers)&&(c=o.createElement(ae.Z,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{(0,ko.N2)(e)}},(0,l._t)("action|invite")));let d,m;"join"===i&&e.currentState.maySendStateEvent(n.EventType.SpaceChild,s)&&(d=o.createElement(Nf,{space:e})),(0,ko.PS)(e)&&(m=o.createElement(gs.Z,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{(0,ko.qS)(e)},title:(0,l._t)("common|settings")}));return o.createElement("div",{className:"mx_SpaceRoomView_landing"},o.createElement("div",{className:"mx_SpaceRoomView_landing_header"},o.createElement(ei.Z,{room:e,size:"80px",viewAvatarOnClick:!0,type:"square"})),o.createElement("div",{className:"mx_SpaceRoomView_landing_name"},o.createElement($s,{room:e},(e=>{const t={name:()=>o.createElement("h1",null,e)};return(0,l._t)("space|landing_welcome",{},t)}))),o.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar"},o.createElement(dv,{room:e}),o.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar_interactive"},o.createElement(cv,{room:e,onlyKnownUsers:!1,numShown:7,onClick:r?void 0:()=>{nm.Z.instance.setCard({phase:im.q.SpaceMemberList})}}),c,m)),o.createElement(sv,{room:e,className:"mx_SpaceRoomView_landing_topic"}),o.createElement(Tf,{space:e,showRoom:xf,additionalButtons:d}))},Mf=({space:e,title:t,description:i,onFinished:s})=>{const[a,c]=(0,o.useState)(!1),[d,m]=(0,o.useState)(""),h=[(0,l._t)("common|general"),(0,l._t)("common|random"),(0,l._t)("common|support")],[p,u]=vf(3,[(0,l._t)("common|general"),(0,l._t)("common|random"),""]),g=new Array(3).fill(0).map(((e,t)=>{const i="roomName"+t;return o.createElement(Vs.Z,{key:i,name:i,type:"text",label:(0,l._t)("common|room_name"),placeholder:h[t],value:p[t],onChange:e=>u(t,e.target.value),autoFocus:2===t,disabled:a,autoComplete:"off"})})),v=async t=>{if(t.preventDefault(),!a){m(""),c(!0);try{var i;const t=e.getJoinRule()===n.JoinRule.Public,o=p.map((e=>e.trim())).filter(Boolean),a=await Promise.all(o.map((i=>(0,Us.ZP)(e.client,{createOpts:{preset:t?n.Preset.PublicChat:n.Preset.PrivateChat,name:i},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:e,joinRule:t?void 0:n.JoinRule.Restricted,suggested:!0}))));s(null!==(i=a[0])&&void 0!==i?i:void 0)}catch(e){r.k.error("Failed to create initial space rooms",e),m((0,l._t)("create_space|failed_create_initial_rooms"))}c(!1)}};let _=e=>{e.preventDefault(),s()},f=(0,l._t)("create_space|skip_action");return p.some((e=>e.trim()))&&(_=v,f=a?(0,l._t)("create_space|creating_rooms"):(0,l._t)("action|continue")),o.createElement("div",null,o.createElement("h1",null,t),o.createElement("div",{className:"mx_SpaceRoomView_description"},i),d&&o.createElement("div",{className:"mx_SpaceRoomView_errorText"},d),o.createElement("form",{onSubmit:_,id:"mx_SpaceSetupFirstRooms"},g),o.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.createElement(ae.Z,{kind:"primary",disabled:a,onClick:_,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:f})))},Of=({space:e,onFinished:t})=>o.createElement("div",null,o.createElement("h1",null,(0,l._t)("create_space|add_existing_rooms_heading")),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|add_existing_rooms_description")),o.createElement(Co.o8,{space:e,emptySelectionButton:o.createElement(ae.Z,{kind:"primary",onClick:t},(0,l._t)("create_space|skip_action")),filterPlaceholder:(0,l._t)("space|room_filter_placeholder"),onFinished:t,roomsRenderer:Co.tS,dmsRenderer:Co.hD})),Af=({justCreatedOpts:e,space:t,onFinished:i,firstRoomId:n})=>{var s;return o.createElement("div",{className:"mx_SpaceRoomView_publicShare"},o.createElement("h1",null,(0,l._t)("create_space|share_heading",{name:(null==e||null===(s=e.createOpts)||void 0===s?void 0:s.name)||t.name})),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|share_description")),o.createElement(_f.Z,{space:t}),o.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.createElement(ae.Z,{kind:"primary",onClick:i},n?(0,l._t)("create_space|done_action_first_room"):(0,l._t)("create_space|done_action"))))},Lf=({space:e,justCreatedOpts:t,onFinished:i})=>{var n;return o.createElement("div",{className:"mx_SpaceRoomView_privateScope"},o.createElement("h1",null,(0,l._t)("create_space|private_personal_heading")),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|private_personal_description",{name:(null==t||null===(n=t.createOpts)||void 0===n?void 0:n.name)||e.name})),o.createElement(ae.Z,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{i(!1)}},(0,l._t)("create_space|personal_space"),o.createElement("div",null,(0,l._t)("create_space|personal_space_description"))),o.createElement(ae.Z,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{i(!0)}},(0,l._t)("create_space|private_space"),o.createElement("div",null,(0,l._t)("create_space|private_space_description"))))},Uf=(0,Nh.Z)({rules:[{key:"email",test:({value:e})=>!e||gf.s(e),invalid:()=>(0,l._t)("auth|email_field_label_invalid")}]}),Ff=({space:e,onFinished:t})=>{const[i,n]=(0,o.useState)(!1),[s,a]=(0,o.useState)(""),c=[(0,o.useRef)(),(0,o.useRef)(),(0,o.useRef)()],[d,m]=vf(3,""),h=new Array(3).fill(0).map(((e,t)=>{const n="emailAddress"+t;return o.createElement(Vs.Z,{key:n,name:n,type:"text",label:(0,l._t)("common|email_address"),placeholder:(0,l._t)("auth|email_field_label"),value:d[t],onChange:e=>m(t,e.target.value),ref:c[t],onValidate:Uf,autoFocus:0===t,disabled:i})})),p=async s=>{if(s.preventDefault(),i)return;a("");for(const e of c){var o;if(!1===await(null===(o=e.current)||void 0===o?void 0:o.validate({allowEmpty:!0})))return e.current.focus(),void e.current.validate({allowEmpty:!0,focused:!0})}n(!0);const m=d.map((e=>e.trim())).filter(Boolean);try{const i=await(0,Ra.I9)(e.client,e.roomId,m),n=Object.keys(i.states).filter((e=>"error"===i.states[e]));n.length>0?(r.k.log("Failed to invite users to space: ",i),a((0,l._t)("create_space|failed_invite_users",{csvUsers:n.join(", ")}))):t()}catch(e){r.k.error("Failed to invite users to space: ",e),a((0,l._t)("invite|error_invite"))}n(!1)};let u=e=>{e.preventDefault(),t()},g=(0,l._t)("create_space|skip_action");return d.some((e=>e.trim()))&&(u=p,g=i?(0,l._t)("create_space|inviting_users"):(0,l._t)("action|continue")),o.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},o.createElement("h1",null,(0,l._t)("create_space|invite_teammates_heading")),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,l._t)("create_space|invite_teammates_description")),s&&o.createElement("div",{className:"mx_SpaceRoomView_errorText"},s),o.createElement("form",{onSubmit:u,id:"mx_SpaceSetupPrivateInvite"},h),o.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},o.createElement(ae.Z,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>(0,Ra.DE)(e.roomId)},(0,l._t)("create_space|invite_teammates_by_username"))),o.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.createElement(ae.Z,{kind:"primary",disabled:i,onClick:u,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:g})))};class Bf extends o.PureComponent{constructor(e,t){var i;super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"onMyMembership",((e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})})),(0,k.Z)(this,"onRightPanelStoreUpdate",(()=>{this.setState({showRightPanel:nm.Z.instance.isOpenForRoom(this.props.space.roomId)})})),(0,k.Z)(this,"onAction",(e=>{e.action!==W.a.ViewRoom||e.room_id!==this.props.space.roomId||this.setState({phase:Zf.Landing})})),(0,k.Z)(this,"goToFirstRoom",(async()=>{this.state.firstRoomId?x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.state.firstRoomId,metricsTrigger:void 0}):this.setState({phase:Zf.Landing})}));let s=Zf.Landing;const o=null===(i=this.props.space.currentState.getStateEvents(n.EventType.RoomCreate,""))||void 0===i?void 0:i.getSender();var a;this.props.justCreatedOpts&&t.getSafeUserId()===o&&(s=(null===(a=this.props.justCreatedOpts.createOpts)||void 0===a?void 0:a.preset)===n.Preset.PublicChat?Zf.PublicCreateRooms:Zf.PrivateScope);this.state={phase:s,showRightPanel:nm.Z.instance.isOpenForRoom(this.props.space.roomId),myMembership:this.props.space.getMyMembership()},this.dispatcherRef=x.ZP.register(this.onAction),nm.Z.instance.on(Pa.a,this.onRightPanelStoreUpdate)}componentDidMount(){this.context.on(n.RoomEvent.MyMembership,this.onMyMembership)}componentWillUnmount(){x.ZP.unregister(this.dispatcherRef),nm.Z.instance.off(Pa.a,this.onRightPanelStoreUpdate),this.context.off(n.RoomEvent.MyMembership,this.onMyMembership)}renderBody(){var e,t;switch(this.state.phase){case Zf.Landing:return"join"===this.state.myMembership?o.createElement(Df,{space:this.props.space}):o.createElement(mv,{room:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case Zf.PublicCreateRooms:return o.createElement(Mf,{space:this.props.space,title:(0,l._t)("create_space|setup_rooms_community_heading",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(t=e.createOpts)||void 0===t?void 0:t.name)||this.props.space.name}),description:o.createElement(o.Fragment,null,(0,l._t)("create_space|setup_rooms_community_description"),o.createElement("br",null),(0,l._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:Zf.PublicShare,firstRoomId:e})});case Zf.PublicShare:return o.createElement(Af,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,firstRoomId:this.state.firstRoomId});case Zf.PrivateScope:return o.createElement(Lf,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?Zf.PrivateCreateRooms:Zf.PrivateExistingRooms})}});case Zf.PrivateInvite:return o.createElement(Ff,{space:this.props.space,onFinished:()=>this.setState({phase:Zf.Landing})});case Zf.PrivateCreateRooms:return o.createElement(Mf,{space:this.props.space,title:(0,l._t)("create_space|setup_rooms_private_heading"),description:o.createElement(o.Fragment,null,(0,l._t)("create_space|setup_rooms_private_description"),o.createElement("br",null),(0,l._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:Zf.PrivateInvite,firstRoomId:e})});case Zf.PrivateExistingRooms:return o.createElement(Of,{space:this.props.space,onFinished:()=>this.setState({phase:Zf.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===Zf.Landing?o.createElement(zg,{room:this.props.space,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator}):void 0;return o.createElement("main",{className:"mx_SpaceRoomView"},o.createElement($h.Z,null,o.createElement(tm,{panel:e,resizeNotifier:this.props.resizeNotifier},this.renderBody())))}}(0,k.Z)(Bf,"contextType",pn.ZP);var Vf=i("../matrix-react-sdk/src/components/structures/RoomStatusBar.tsx");class jf extends o.PureComponent{render(){return o.createElement("div",{className:"mx_TopUnreadMessagesBar"},o.createElement(ae.Z,{className:"mx_TopUnreadMessagesBar_scrollUp",title:(0,l._t)("room|jump_read_marker"),onClick:this.props.onScrollUpClick}),o.createElement(ae.Z,{className:"mx_TopUnreadMessagesBar_markAsRead",title:(0,l._t)("notifications|mark_all_read"),onClick:this.props.onCloseClick}))}}var zf=i("../matrix-react-sdk/src/utils/direct-messages.ts"),Wf=i("../matrix-react-sdk/src/components/views/messages/EncryptionEvent.tsx"),Hf=i("../matrix-react-sdk/src/components/structures/RoomStatusBarUnsentMessages.tsx");const Gf=({text:e})=>o.createElement("div",{className:"mx_LargeLoader"},o.createElement(re.Z,{w:45,h:45}),o.createElement("div",{className:"mx_LargeLoader_text"},e));class Kf extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"callEventGroupers",new Map),this.buildLegacyCallEventGroupers(this.props.timeline)}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,Pu.YJ)(this.callEventGroupers,e)}render(){const e=this.props.timeline,t=e[this.props.ourEventsIndexes[0]],i=t.getId(),n=t.getTs(),s=[o.createElement(Kh.Z,{key:n+"-search",roomId:t.getRoomId(),ts:n})],a=L.C.getValue("layout"),r=L.C.getValue("showTwelveHourTimestamps"),l=L.C.getValue("alwaysShowTimestamps"),c=E.p.safeGet();for(let t=0;t<e.length;t++){var d;const n=e[t];let p;const u=!this.props.ourEventsIndexes.includes(t);if(u||(p=this.props.searchHighlights),(0,At.eD)(n,c,null===(d=this.context)||void 0===d?void 0:d.showHiddenEvents)){var m;const d=e[t-1],g=d&&!(0,Oe.JC)(d.getDate()||void 0,n.getDate()||void 0)&&gp(d,n,c,null===(m=this.context)||void 0===m?void 0:m.showHiddenEvents,qt.SB.Search);let v=!0;const _=e[t+1];if(_){var h;v=(0,Oe.JC)(n.getDate()||void 0,_.getDate()||void 0)||n.getSender()!==_.getSender()||!gp(n,_,c,null===(h=this.context)||void 0===h?void 0:h.showHiddenEvents,qt.SB.Search)}s.push(o.createElement(rs,{key:`${i}+${t}`,mxEvent:n,layout:a,contextual:u,highlights:p,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:r,alwaysShowTimestamps:l,lastInSection:v,continuation:g,callEventGrouper:this.callEventGroupers.get(n.getContent().call_id)}))}}return o.createElement("li",{"data-scroll-tokens":i},o.createElement("ol",null,s))}}(0,k.Z)(Kf,"contextType",qt.ZP);var qf=i("../matrix-react-sdk/src/Typeguards.ts");const $f=10;async function Jf(e,t,i,s){const o={limit:$f};void 0!==i&&(o.rooms=[i]);const a={search_categories:{room_events:{search_term:t,filter:o,order_by:n.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await e.search({body:a},s),query:a}}async function Yf(e,t,i,n){const s=await Jf(e,t,i,n),o={abortSignal:n,_query:s.query,results:[],highlights:[]};return e.processRoomEventsSearch(o,s.response)}function Qf(e,t){const i=e.result,n=t.result;return i.origin_server_ts>n.origin_server_ts?-1:i.origin_server_ts<n.origin_server_ts?1:0}async function Xf(e,t,i=!0){const n=b.Z.get(),s={search_term:e,before_limit:1,after_limit:1,limit:$f,order_by_recency:!0,room_id:void 0};void 0!==t&&(s.room_id=t);const o=await n.search(s);if(!o)throw new Error("Local search failed");s.next_batch=o.next_batch;return{response:o,query:s}}function eE(e,t){try{const i=e[e.length-1].result,n=t[t.length-1].result;return i.origin_server_ts<=n.origin_server_ts?-1:1}catch{return 0}}function tE(e,t,i,n){const s=i.concat(n).sort(Qf);t.results=s.slice(0,$f),e.cachedEvents=s.slice($f)}function iE(e,t,i){var n;const s=function(e,t,i){var n;const s={},o=null!==(n=e.cachedEvents)&&void 0!==n?n:[];let a=e.oldestEventFrom;return s.highlights=e.highlights,t&&i&&i.results?(eE(t.results,i.results)<0&&(a="local"),tE(e,s,t.results,i.results),s.highlights=t.highlights.concat(i.highlights)):t?(eE(t.results,o)<0&&(a="local"),tE(e,s,t.results,o)):i&&i.results?(eE(i.results,o)<0&&(a="server"),tE(e,s,i.results,o)):(s.results=o,e.cachedEvents=[]),e.oldestEventFrom=a,s}(e,t,i);if(e.count)s.count=e.count;else{var o,a;const e=null!==(o=null==t?void 0:t.count)&&void 0!==o?o:0,n=null!==(a=null==i?void 0:i.count)&&void 0!==a?a:0;s.count=e+n}return t&&(0,qf.p)(e.seshatQuery)&&(e.seshatQuery.next_batch=t.next_batch),i&&(e.serverSideNextBatch=i.next_batch),null!==(n=e.seshatQuery)&&void 0!==n&&n.next_batch?s.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(s.next_batch=e.serverSideNextBatch),!s.next_batch&&(0,qf.p)(e.cachedEvents)&&e.cachedEvents.length>0&&(s.next_batch="cached"),s}function nE(e=[]){for(const t of e){const e=t.context.getTimeline();for(const t of e){const e=t.event;e.curve25519Key&&(t.makeEncrypted(n.EventType.RoomMessageEncrypted,{algorithm:e.algorithm},e.curve25519Key,e.ed25519Key),t.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain,delete e.curve25519Key,delete e.ed25519Key,delete e.algorithm,delete e.forwardingCurve25519KeyChain)}}}function sE(e,t,i,n){let s;return s=void 0!==i?e.isRoomEncrypted(i)?async function(e,t,i){const n={results:[],highlights:[]};if(""===t)return n;const s=await Xf(t,i);n.seshatQuery=s.query;const o={search_categories:{room_events:s.response}},a=e.processRoomEventsSearch(n,o);return nE(a.results),a}(e,t,i):Yf(e,t,i,n):async function(e,t,i){const n=Jf(e,t,void 0,i),s=Xf(t);await Promise.all([n,s]);const o=await s,a=await n,r=a.query,l=a.response,c=o.query,d=o.response,m={seshatQuery:c,_query:r,serverSideNextBatch:l.search_categories.room_events.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},h={search_categories:{room_events:iE(m,d,l.search_categories.room_events)}},p=e.processRoomEventsSearch(m,h);return nE(p.results),p}(e,t,n),s}function oE(e,t){const i=t.seshatQuery,n=t._query;if(i){if(n){const i=async function(e,t){var i;const n=b.Z.get(),s=t.seshatQuery,o=t.oldestEventFrom;let a,r;if(null==s||!s.next_batch||t.serverSideNextBatch&&"server"!==o||(a=await n.search(s)),t.serverSideNextBatch&&("local"===o||null==s||!s.next_batch)){const i={body:t._query,next_batch:t.serverSideNextBatch};r=await e.search(i)}const l={search_categories:{room_events:iE(t,a,null===(i=r)||void 0===i?void 0:i.search_categories.room_events)}},c=t.results?t.results.length:0,d=e.processRoomEventsSearch(t,l),m=d.results.length-c;return nE(d.results.slice(Math.max(d.results.length-m,0))),t.pendingRequest=void 0,d}(e,t);return t.pendingRequest=i,i}{const i=async function(e,t){const i=b.Z.get();if(!t.seshatQuery)throw new Error("localSearchProcess must be called first");const n=await i.search(t.seshatQuery);if(!n)throw new Error("Local search pagination failed");t.seshatQuery.next_batch=n.next_batch;const s=n.results.length,o={search_categories:{room_events:n}},a=e.processRoomEventsSearch(t,o);return nE(a.results.slice(Math.max(a.results.length-s,0))),t.pendingRequest=void 0,a}(e,t);return t.pendingRequest=i,i}}return e.backPaginateRoomEventsSearch(t)}function aE(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}let rE=function(e){};const lE=(0,o.forwardRef)((({term:e,scope:t,promise:i,abortController:s,resizeNotifier:a,className:c,onUpdate:d},m)=>{const h=(0,o.useContext)(pn.ZP),p=(0,o.useContext)(qt.ZP),[u,g]=(0,o.useState)(!0),[v,_]=(0,o.useState)(null),[f,E]=(0,o.useState)(null),y=(0,o.useRef)(!1),w=(0,o.useRef)(new Map).current,S=(0,o.useRef)();(0,o.useEffect)((()=>()=>{w.forEach((e=>e.stop())),w.clear()}),[w]);const C=(0,o.useCallback)((t=>(g(!0),t.then((async t=>{if(rE("search complete"),y.current)return r.k.error("Discarding stale search results"),!1;let i=t.highlights;i.includes(e)||(i=i.concat(e)),i=i.sort((function(e,t){return t.length-e.length}));for(const e of t.results)for(const t of e.context.getTimeline()){if(!t.getServerAggregatedRelation(n.THREAD_RELATION_TYPE.name)||t.getThread())continue;const e=h.getRoom(t.getRoomId()),i=null==e?void 0:e.findThreadForEvent(t);i?t.setThread(i):null==e||e.createThread(t.getId(),t,[],!0)}return _(i),E(function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?aE(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):aE(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t)),!1}),(e=>{var t;return y.current?(r.k.error("Discarding stale search results"),!1):(r.k.error("Search failed",e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("error_dialog|search_failed|title"),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:(0,l._t)("error_dialog|search_failed|server_unavailable")}),!1)})).finally((()=>{g(!1)})))),[h,e]);if((0,o.useEffect)((()=>(y.current=!1,C(i),()=>{y.current=!0,null==s||s.abort()})),[]),void 0===(null==f?void 0:f.count))return o.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner","data-testid":"messagePanelSearchSpinner"});const x=[];var R;(u&&x.push(o.createElement("li",{key:"search-spinner"},o.createElement(re.Z,null))),f.next_batch)||(null!=f&&null!==(R=f.results)&&void 0!==R&&R.length?x.push(o.createElement("li",{key:"search-top-marker"},o.createElement("h2",{className:"mx_RoomView_topMarker"},(0,l._t)("no_more_results")))):x.push(o.createElement("li",{key:"search-top-marker"},o.createElement("h2",{className:"mx_RoomView_topMarker"},(0,l._t)("common|no_results")))));const I=()=>{var e;null===(e=S.current)||void 0===e||e.checkScroll()};let P,Z=[],N=[];for(let e=((null==f||null===(D=f.results)||void 0===D?void 0:D.length)||0)-1;e>=0;e--){var D;const i=f.results[e],n=i.context.getEvent(),s=n.getRoomId(),a=h.getRoom(s);if(!a){r.k.log("Hiding search result from an unknown room",s);continue}if(!(0,At.eD)(n,h,p.showHiddenEvents))continue;t===hv.All&&s!==P&&(x.push(o.createElement("li",{key:n.getId()+"-room"},o.createElement("h2",null,(0,l._t)("common|room"),": ",a.name))),P=s);const c="#/room/"+s+"/"+n.getId(),d=i.context.getTimeline(),m=e>0?f.results[e-1].context.getTimeline():[];if(e>0&&d[d.length-1].getId()==m[0].getId()){if(0==Z.length){for(let e=0==Z.length?0:1;e<i.context.getTimeline().length;e++)Z.push(d[e]);N.push(i.context.getOurEventIndex())}for(let e=1;e<m.length;e++)Z.push(m[e]);N.push(N[N.length-1]+f.results[e-1].context.getOurEventIndex()+1);continue}0==Z.length&&(Z=i.context.getTimeline(),N=[],N.push(i.context.getOurEventIndex()));let u=w.get(s);u||(u=new Rt.w6(a),u.start(),w.set(s,u)),x.push(o.createElement(Kf,{key:n.getId(),timeline:Z,ourEventsIndexes:N,searchHighlights:null!=v?v:[],resultLink:c,permalinkCreator:u,onHeightChanged:I})),N=[],Z=[]}return o.createElement(Gh.Z,{ref:e=>{"function"==typeof m?m(e):m&&(m.current=e),S.current=e},className:"mx_RoomView_searchResultsPanel "+c,onFillRequest:async e=>{if(!e)return!1;if(!f.next_batch)return rE("no more search results"),!1;rE("requesting more search results");const t=function(e,t){const i=b.Z.get();return t.pendingRequest?t.pendingRequest:null===i?e.backPaginateRoomEventsSearch(t):oE(e,t)}(h,f);return C(t)},resizeNotifier:a},o.createElement("li",{className:"mx_RoomView_scrollheader"}),x)}));var cE=i("../matrix-react-sdk/src/VoipUserMapper.ts");const dE=({roomView:e,resizeNotifier:t,inviteEvent:i})=>{const n=(0,qt.fZ)(),s=c.ZP.get().brand;return o.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.createElement($h.Z,null,L.C.getValue("feature_new_room_decoration_ui")?o.createElement(af,{room:n.room}):o.createElement(U_,{room:n.room,inRoom:!0,onSearchClick:null,onInviteClick:null,onForgetClick:null,e2eStatus:Rm._.Normal,onAppsClick:null,appsShown:!1,excludedRightPanelPhaseButtons:[],showButtons:!1,enableRoomOptionsMenu:!1,viewingCall:!1,activeCall:null}),o.createElement("main",{className:"mx_RoomView_body",ref:e},o.createElement("div",{className:"mx_RoomView_timeline"},o.createElement(Gh.Z,{className:"mx_RoomView_messagePanel",resizeNotifier:t},o.createElement(Xh.Z,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:(0,l._t)("room|waiting_for_join_title",{brand:s}),subtitle:(0,l._t)("room|waiting_for_join_subtitle",{brand:s})}),o.createElement(hp,null),o.createElement(as,{mxEvent:i}))))))},mE=["upgradeRecommendation"],hE=["upgradeRecommendation"];function pE(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function uE(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?pE(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):pE(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let gE=function(e){};const vE="sandbox"in document.createElement("iframe");var _E=function(e){return e[e.Timeline=0]="Timeline",e[e.MaximisedWidget=1]="MaximisedWidget",e[e.Call=2]="Call",e}(_E||{});function fE(e){const t=(0,o.useContext)(qt.ZP),i=t.room,s=e.localRoom.currentState.getStateEvents(n.EventType.RoomEncryption)[0];let a;s&&(a=o.createElement(Wf.Z,{mxEvent:s}));const r=()=>{i.state=dp.sD.NEW,x.ec.dispatch({action:"local_room_event",roomId:i.roomId})};let c=null,d=null;if(i.isError){const e=o.createElement(ae.Z,{onClick:r,className:"mx_RoomStatusBar_unsentRetry"},(0,l._t)("action|retry"));c=o.createElement(Hf.G,{title:(0,l._t)("room|status_bar|some_messages_not_sent"),notificationState:oi.Z.RED_EXCLAMATION,buttons:e})}else d=o.createElement(vg,{room:e.localRoom,resizeNotifier:e.resizeNotifier,permalinkCreator:e.permalinkCreator});return o.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.createElement($h.Z,null,L.C.getValue("feature_new_room_decoration_ui")?o.createElement(af,{room:i}):o.createElement(U_,{room:t.room,searchInfo:void 0,inRoom:!0,onSearchClick:null,onInviteClick:null,onForgetClick:null,e2eStatus:i.encrypted?Rm._.Normal:void 0,onAppsClick:null,appsShown:!1,excludedRightPanelPhaseButtons:[],showButtons:!1,enableRoomOptionsMenu:!1,viewingCall:!1,activeCall:null}),o.createElement("main",{className:"mx_RoomView_body",ref:e.roomView},o.createElement(wg,{parent:e.roomView.current,onFileDrop:e.onFileDrop}),o.createElement("div",{className:"mx_RoomView_timeline"},o.createElement(Gh.Z,{className:"mx_RoomView_messagePanel",resizeNotifier:e.resizeNotifier},a,o.createElement(hp,null))),c,d)))}function EE(e){const t=(0,l._t)("room|creating_room_text",{names:e.names});return o.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.createElement($h.Z,null,L.C.getValue("feature_new_room_decoration_ui")?o.createElement(af,{room:e.localRoom}):o.createElement(U_,{room:e.localRoom,searchInfo:void 0,inRoom:!0,onSearchClick:null,onInviteClick:null,onForgetClick:null,e2eStatus:e.localRoom.encrypted?Rm._.Normal:void 0,onAppsClick:null,appsShown:!1,excludedRightPanelPhaseButtons:[],showButtons:!1,enableRoomOptionsMenu:!1,viewingCall:!1,activeCall:null}),o.createElement("div",{className:"mx_RoomView_body"},o.createElement(Gf,{text:t}))))}class yE extends o.Component{constructor(e,t){var i;if(super(e,t),(0,k.Z)(this,"askToJoinEnabled",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"settingWatchers",void 0),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"permalinkCreators",{}),(0,k.Z)(this,"roomView",(0,o.createRef)()),(0,k.Z)(this,"searchResultsPanel",(0,o.createRef)()),(0,k.Z)(this,"messagePanel",null),(0,k.Z)(this,"roomViewBody",(0,o.createRef)()),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"onIsResizing",(e=>{this.setState({resizing:e})})),(0,k.Z)(this,"onWidgetStoreUpdate",(()=>{this.state.room&&(this.checkWidgets(this.state.room),this.doMaybeRemoveOwnJitsiWidget())})),(0,k.Z)(this,"onWidgetEchoStoreUpdate",(()=>{this.state.room&&this.checkWidgets(this.state.room)})),(0,k.Z)(this,"onWidgetLayoutChange",(()=>{this.state.room&&(x.ZP.dispatch({action:"appsDrawer",show:!0}),this.context.widgetLayoutStore.hasMaximisedWidget(this.state.room)&&this.context.rightPanelStore.setCard({phase:im.q.Timeline}),this.checkWidgets(this.state.room))})),(0,k.Z)(this,"checkWidgets",(e=>{this.setState({hasPinnedWidgets:this.context.widgetLayoutStore.hasPinnedWidgets(e),mainSplitContentType:this.getMainSplitContentType(e),showApps:this.shouldShowApps(e)})})),(0,k.Z)(this,"getMainSplitContentType",(e=>L.C.getValue("feature_group_calls")&&this.context.roomViewStore.isViewingCall()||R_(e)?_E.Call:this.context.widgetLayoutStore.hasMaximisedWidget(e)?_E.MaximisedWidget:_E.Timeline)),(0,k.Z)(this,"onRoomViewStoreUpdate",(async e=>{var t,i,n,s,o,a;if(this.unmounted)return;const l=null!==(t=this.context.roomViewStore.getRoomLoadError())&&void 0!==t?t:void 0;if(!e&&!l&&this.state.roomId!==this.context.roomViewStore.getRoomId())return;const c=null!==(i=this.context.roomViewStore.getRoomId())&&void 0!==i?i:null,d=null!==(n=null===(s=this.context.client)||void 0===s?void 0:s.getRoom(null!=c?c:void 0))&&void 0!==n?n:void 0,m={roomId:null!=c?c:void 0,roomAlias:null!==(o=this.context.roomViewStore.getRoomAlias())&&void 0!==o?o:void 0,roomLoading:this.context.roomViewStore.isRoomLoading(),roomLoadError:l,joining:this.context.roomViewStore.isJoining(),replyToEvent:null!==(a=this.context.roomViewStore.getQuotingEvent())&&void 0!==a?a:void 0,shouldPeek:this.state.matrixClientIsReady&&this.context.roomViewStore.shouldPeek(),showReadReceipts:L.C.getValue("showReadReceipts",c),showRedactions:L.C.getValue("showRedactions",c),showJoinLeaves:L.C.getValue("showJoinLeaves",c),showAvatarChanges:L.C.getValue("showAvatarChanges",c),showDisplaynameChanges:L.C.getValue("showDisplaynameChanges",c),wasContextSwitch:this.context.roomViewStore.getWasContextSwitch(),mainSplitContentType:d?this.getMainSplitContentType(d):void 0,initialEventId:void 0,showRightPanel:!!c&&this.context.rightPanelStore.isOpenForRoom(c),threadRightPanel:!!c&&[im.q.ThreadView,im.q.ThreadPanel].includes(this.context.rightPanelStore.currentCardForRoom(c).phase),activeCall:c?lf.c.instance.getActiveCall(c):null,promptAskToJoin:this.context.roomViewStore.promptAskToJoin(),viewRoomOpts:this.context.roomViewStore.getViewRoomOpts()};var h;this.state.mainSplitContentType!==_E.Timeline&&m.mainSplitContentType===_E.Timeline&&this.context.rightPanelStore.isOpen&&this.context.rightPanelStore.currentCard.phase===im.q.Timeline&&this.context.rightPanelStore.roomPhaseHistory.some((e=>e.phase===im.q.Timeline))&&(this.context.rightPanelStore.setCard({phase:im.q.RoomSummary}),this.context.rightPanelStore.togglePanel(null!==(h=this.state.roomId)&&void 0!==h?h:null),m.showRightPanel=!1);const p=this.context.roomViewStore.getInitialEventId();if(p){var u,g;let e=null==d?void 0:d.findEventById(p);var v;if(!e&&this.context.client&&c)e=null!==(v=await(0,Ot.W7)(this.context.client,c,p))&&void 0!==v?v:void 0;m.initialEventPixelOffset=void 0;const t=null===(u=e)||void 0===u?void 0:u.getThread();var _;if(null==t||!t.rootEvent||null!==(g=e)&&void 0!==g&&g.isThreadRoot)m.initialEventId=p,m.isInitialEventHighlighted=this.context.roomViewStore.isInitialEventHighlighted(),m.initialEventScrollIntoView=this.context.roomViewStore.initialEventScrollIntoView(),null!=t&&t.rootEvent&&null!==(_=e)&&void 0!==_&&_.isThreadRoot&&x.ZP.dispatch({action:W.a.ShowThread,rootEvent:t.rootEvent,initialEvent:e,highlighted:this.context.roomViewStore.isInitialEventHighlighted(),scroll_into_view:this.context.roomViewStore.initialEventScrollIntoView()});else x.ZP.dispatch({action:W.a.ShowThread,rootEvent:t.rootEvent,initialEvent:e,highlighted:this.context.roomViewStore.isInitialEventHighlighted(),scroll_into_view:this.context.roomViewStore.initialEventScrollIntoView()})}var f,E,y;(this.settingWatchers=this.settingWatchers.concat([L.C.watchSetting("showReadReceipts",c,((...[,,,e])=>this.setState({showReadReceipts:e}))),L.C.watchSetting("showRedactions",c,((...[,,,e])=>this.setState({showRedactions:e}))),L.C.watchSetting("showJoinLeaves",c,((...[,,,e])=>this.setState({showJoinLeaves:e}))),L.C.watchSetting("showAvatarChanges",c,((...[,,,e])=>this.setState({showAvatarChanges:e}))),L.C.watchSetting("showDisplaynameChanges",c,((...[,,,e])=>this.setState({showDisplaynameChanges:e})))]),e||!this.state.shouldPeek||m.shouldPeek)||(null===(f=this.context.client)||void 0===f||f.stopPeeking());if(r.k.log("RVS update:",m.roomId,m.roomAlias,"loading?",m.roomLoading,"joining?",m.joining,"initial?",e,"shouldPeek?",m.shouldPeek),e&&(m.room=this.context.client.getRoom(m.roomId)||void 0,m.room&&(m.showApps=this.shouldShowApps(m.room),this.onRoomLoaded(m.room))),void 0===this.state.roomId&&void 0!==m.roomId&&!m.initialEventId&&m.roomId){const e=Hg.getScrollState(m.roomId);e&&(m.initialEventId=e.focussedEvent,m.initialEventPixelOffset=e.pixelOffset)}this.state.timelineRenderingType===qt.SB.Search&&this.state.initialEventId!==m.initialEventId&&(m.timelineRenderingType=qt.SB.Room,null===(E=this.state.search)||void 0===E||null===(y=E.abortController)||void 0===y||y.abort(),m.search=void 0);this.setState(m),e&&this.setupRoom(m.room,m.roomId,!!m.joining,!!m.shouldPeek)})),(0,k.Z)(this,"onActiveCalls",(()=>{if(void 0===this.state.roomId)return;const e=lf.c.instance.getActiveCall(this.state.roomId);null===e&&x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.state.roomId,view_call:!1,metricsTrigger:void 0},!0),this.setState({activeCall:e})})),(0,k.Z)(this,"getRoomId",(()=>{var e,t;return null!==(e=null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&void 0!==e?e:this.state.roomId})),(0,k.Z)(this,"onRightPanelStoreUpdate",(()=>{const{roomId:e}=this.state;this.setState({showRightPanel:!!e&&this.context.rightPanelStore.isOpenForRoom(e),threadRightPanel:!!e&&[im.q.ThreadView,im.q.ThreadPanel].includes(this.context.rightPanelStore.currentCardForRoom(e).phase)})})),(0,k.Z)(this,"onPageUnload",(e=>Xd.ZP.sharedInstance().getCurrentUploads().length>0?e.returnValue=(0,l._t)("quit_warning|file_upload_in_progress"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=(0,l._t)("quit_warning|call_in_progress"):void 0)),(0,k.Z)(this,"onReactKeyDown",(e=>{var t;let i=!1;switch((0,dr.zL)().getRoomAction(e)){case tn.vB.DismissReadMarker:null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker(),this.jumpToLiveTimeline(),i=!0;break;case tn.vB.JumpToOldestUnread:this.jumpToReadMarker(),i=!0;break;case tn.vB.UploadFile:x.ZP.dispatch({action:"upload_file",context:qt.SB.Room},!0),i=!0}i&&(e.stopPropagation(),e.preventDefault())})),(0,k.Z)(this,"onCallState",(e=>{if(!e)return;const t=this.getCallForRoom();this.setState({callState:null==t?void 0:t.state})})),(0,k.Z)(this,"onAction",(async e=>{var t;if(this.context.client)switch(e.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(e.data.content.url,e.data.content.info,e.data.description||e.data.name,e.data.threadId);break;case"picture_snapshot":{const t=this.getRoomId();(0,qf.p)(t)&&Xd.ZP.sharedInstance().sendContentListToRoom([e.file],t,void 0,this.context.client);break}case"notifier_enabled":case W.a.UploadStarted:case W.a.UploadFinished:case W.a.UploadCanceled:this.forceUpdate();break;case"appsDrawer":this.setState({showApps:e.show});break;case"reply_to_event":!this.unmounted&&this.state.search&&(null===(t=e.event)||void 0===t?void 0:t.getRoomId())===this.state.roomId&&e.context===qt.SB.Search&&this.onCancelSearchClick();break;case"MatrixActions.sync":var i;if(!this.state.matrixClientIsReady)this.setState({matrixClientIsReady:!(null===(i=this.context.client)||void 0===i||!i.isInitialSyncComplete())},(()=>{this.onRoomViewStoreUpdate(!0)}));break;case"focus_search":this.onSearchClick();break;case"local_room_event":this.onLocalRoomEvent(e.roomId);break;case W.a.EditEvent:{if(e.timelineRenderingType!==this.state.timelineRenderingType)return;const t=e.event?new _g(e.event):void 0;this.setState({editState:t},(()=>{var t;e.event&&(null===(t=this.messagePanel)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break}case W.a.ComposerInsert:{if(e.composerType)break;let t=e.timelineRenderingType;if(t===qt.SB.Thread)break;this.state.timelineRenderingType===qt.SB.Search&&e.timelineRenderingType===qt.SB.Search&&(await this.onCancelSearchClick(),t=qt.SB.Room),x.ZP.dispatch(uE(uE({},e),{},{timelineRenderingType:t,composerType:this.state.editState?Sg.P.Edit:Sg.P.Send}));break}case W.a.FocusAComposer:x.ZP.dispatch(uE(uE({},e),{},{action:this.state.editState?W.a.FocusEditMessageComposer:W.a.FocusSendMessageComposer}));break;case"scroll_to_bottom":var n;if(e.timelineRenderingType===qt.SB.Room)null===(n=this.messagePanel)||void 0===n||n.jumpToLiveTimeline();break;case W.a.ViewUser:e.member?e.push?nm.Z.instance.pushCard({phase:im.q.RoomMemberInfo,state:{member:e.member}}):nm.Z.instance.setCards([{phase:im.q.RoomSummary},{phase:im.q.RoomMemberList},{phase:im.q.RoomMemberInfo,state:{member:e.member}}]):nm.Z.instance.showOrHidePanel(im.q.RoomMemberList);break;case W.a.View3pidInvite:((e,t)=>{e.event?t.pushCard({phase:im.q.Room3pidMemberInfo,state:{memberInfoEvent:e.event}}):t.showOrHidePanel(im.q.RoomMemberList)})(e,nm.Z.instance)}})),(0,k.Z)(this,"onRoomTimeline",((e,t,i,n,s)=>{var o;this.unmounted||t&&t.roomId===(null===(o=this.state.room)||void 0===o?void 0:o.roomId)&&s.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&(this.updateE2EStatus(t),this.updatePreviewUrlVisibility(t)),!i&&null!=s&&s.liveEvent&&(this.state.joining||(e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e),this.context.client&&e.getSender()!==this.context.client.getSafeUserId()&&(!this.state.search&&this.state.atEndOfLiveTimeline||(0,Qd.Z)(e,this.state)||this.setState((e=>({numUnreadMessages:e.numUnreadMessages+1})))))))})),(0,k.Z)(this,"onEventDecrypted",(e=>{this.state.room&&this.state.matrixClientIsReady&&e.getRoomId()===this.state.room.roomId&&(e.isDecryptionFailure()||this.handleEffects(e))})),(0,k.Z)(this,"handleEffects",(e=>{if(!this.state.room)return;this.context.roomNotificationStateStore.getRoomState(this.state.room).isUnread&&Hm.b.forEach((t=>{((0,Gm.R)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&(e.isRelation(n.THREAD_RELATION_TYPE.name)||x.ZP.dispatch({action:`effects.${t.command}`}))}))})),(0,k.Z)(this,"onRoomName",(e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()})),(0,k.Z)(this,"onKeyBackupStatus",(()=>{this.forceUpdate()})),(0,k.Z)(this,"canResetTimeline",(()=>!this.messagePanel||this.messagePanel.canResetTimeline())),(0,k.Z)(this,"loadVirtualRoom",(async e=>{const t=(null==e?void 0:e.roomId)&&await cE.Z.sharedInstance().getVirtualRoomForRoom(null==e?void 0:e.roomId);this.setState({virtualRoom:t||void 0})})),(0,k.Z)(this,"onRoomLoaded",(e=>{this.unmounted||(this.context.widgetLayoutStore.on(Nm.z3.emissionForRoom(e),this.onWidgetLayoutChange),this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e),this.checkWidgets(e),this.loadVirtualRoom(e),this.getMainSplitContentType(e)!==_E.Timeline&&this.context.roomNotificationStateStore.getRoomState(e).isUnread&&this.context.rightPanelStore.setCard({phase:im.q.Timeline},!0,e.roomId),this.setState({tombstone:this.getRoomTombstone(e),liveTimeline:e.getLiveTimeline()}),x.ZP.dispatch({action:W.a.RoomLoaded}))})),(0,k.Z)(this,"onRoomTimelineReset",(e=>{var t;e&&e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&e.getLiveTimeline()!==this.state.liveTimeline&&(r.k.log(`Live timeline of ${e.roomId} was reset`),this.setState({liveTimeline:e.getLiveTimeline()}))})),(0,k.Z)(this,"onRoom",(e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&this.context.widgetLayoutStore.off(Nm.z3.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},(()=>{this.onRoomLoaded(e)})))})),(0,k.Z)(this,"onDeviceVerificationChanged",(e=>{const t=this.state.room;null!=t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)})),(0,k.Z)(this,"onUserVerificationChanged",(e=>{const t=this.state.room;t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)})),(0,k.Z)(this,"onCrossSigningKeysChanged",(()=>{const e=this.state.room;e&&this.updateE2EStatus(e)})),(0,k.Z)(this,"onUrlPreviewsEnabledChange",(()=>{this.state.room&&this.updatePreviewUrlVisibility(this.state.room)})),(0,k.Z)(this,"onRoomStateEvents",((e,t)=>{if(this.state.room&&this.state.room.roomId===t.roomId)if(e.getType()===n.EventType.RoomTombstone)this.setState({tombstone:this.getRoomTombstone()});else this.updatePermissions(this.state.room)})),(0,k.Z)(this,"onRoomStateUpdate",(e=>{var t;e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&this.updateRoomMembers()})),(0,k.Z)(this,"onMyMembership",(e=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))})),(0,k.Z)(this,"updateRoomMembers",(0,ln.throttle)((()=>{this.state.room&&(this.updateDMState(),this.updateE2EStatus(this.state.room))}),500,{leading:!0,trailing:!0})),(0,k.Z)(this,"onInviteClick",(()=>{x.ZP.dispatch({action:"view_invite",roomId:this.getRoomId()})})),(0,k.Z)(this,"onJoinButtonClicked",(()=>{var e;null!==(e=this.context.client)&&void 0!==e&&e.isGuest()?(x.ZP.dispatch({action:W.a.DoAfterSyncPrepared,deferred_action:{action:W.a.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}}),x.ZP.dispatch({action:"require_registration"})):Promise.resolve().then((()=>{var e;const t=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl,i=this.getRoomId();var n;(0,qf.p)(i)&&x.ZP.dispatch({action:W.a.JoinRoom,roomId:i,opts:{inviteSignUrl:t},metricsTrigger:"invite"===(null===(n=this.state.room)||void 0===n?void 0:n.getMyMembership())?"Invite":"RoomPreview",canAskToJoin:this.state.canAskToJoin});return Promise.resolve()}))})),(0,k.Z)(this,"onMessageListScroll",(()=>{var e;null!==(e=this.messagePanel)&&void 0!==e&&e.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()})),(0,k.Z)(this,"resetJumpToEvent",(e=>{this.state.initialEventId&&this.state.initialEventScrollIntoView&&this.state.initialEventId===e&&(gE("Removing scroll_into_view flag from initial event"),x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.getRoomId(),event_id:this.state.initialEventId,highlighted:this.state.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),(0,k.Z)(this,"onSearch",((e,t)=>{const i=t===hv.Room?this.getRoomId():void 0;gE("sending search request");const n=new AbortController,s=function(e,t,i,n){return null===b.Z.get()?Yf(e,t,i,n):sE(e,t,i,n)}(this.context.client,e,i,n.signal);this.setState({search:{searchId:(new Date).getTime(),roomId:i,term:e,scope:t,promise:s,abortController:n}})})),(0,k.Z)(this,"onSearchUpdate",((e,t)=>{this.setState({search:uE(uE({},this.state.search),{},{count:null==t?void 0:t.count,inProgress:e})})})),(0,k.Z)(this,"onAppsClick",(()=>{x.ZP.dispatch({action:"appsDrawer",show:!this.state.showApps})})),(0,k.Z)(this,"onForgetClick",(()=>{x.ZP.dispatch({action:"forget_room",room_id:this.getRoomId()})})),(0,k.Z)(this,"onRejectButtonClicked",(()=>{var e;const t=this.getRoomId();t&&(this.setState({rejecting:!0}),null===(e=this.context.client)||void 0===e||e.leave(t).then((()=>{x.ZP.dispatch({action:W.a.ViewHomePage}),this.setState({rejecting:!1})}),(e=>{r.k.error(`Failed to reject invite: ${e}`);const t=e.message?e.message:JSON.stringify(e);T.ZP.createDialog(dt.Z,{title:(0,l._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})})))})),(0,k.Z)(this,"onRejectAndIgnoreClick",(async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.client.getSafeUserId()).events.member,t=this.context.client.getIgnoredUsers();t.push(e.getSender()),await this.context.client.setIgnoredUsers(t),await this.context.client.leave(this.state.roomId),x.ZP.dispatch({action:W.a.ViewHomePage}),this.setState({rejecting:!1})}catch(e){r.k.error(`Failed to reject invite: ${e}`);const t=e instanceof Error?e.message:JSON.stringify(e);T.ZP.createDialog(dt.Z,{title:(0,l._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})}})),(0,k.Z)(this,"onRejectThreepidInviteButtonClicked",(()=>{x.ZP.fire(W.a.ViewRoomDirectory)})),(0,k.Z)(this,"onSearchClick",(()=>{this.state.timelineRenderingType===qt.SB.Search?this.onCancelSearchClick():this.setState({timelineRenderingType:qt.SB.Search})})),(0,k.Z)(this,"onCancelSearchClick",(()=>new Promise((e=>{this.setState({timelineRenderingType:qt.SB.Room,search:void 0},e)})))),(0,k.Z)(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?x.ZP.dispatch({action:W.a.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}):(null===(e=this.messagePanel)||void 0===e||e.jumpToLiveTimeline(),x.ZP.fire(W.a.FocusSendMessageComposer))})),(0,k.Z)(this,"jumpToReadMarker",(()=>{var e;null===(e=this.messagePanel)||void 0===e||e.jumpToReadMarker()})),(0,k.Z)(this,"forgetReadMarker",(e=>{var t;e.stopPropagation(),null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker()})),(0,k.Z)(this,"updateTopUnreadMessagesBar",(()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})})),(0,k.Z)(this,"onStatusBarVisible",(()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})})),(0,k.Z)(this,"onStatusBarHidden",(()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})})),(0,k.Z)(this,"handleScrollKey",(e=>{var t;let i;this.searchResultsPanel.current?i=this.searchResultsPanel.current:this.messagePanel&&(i=this.messagePanel),null===(t=i)||void 0===t||t.handleScrollKey(e)})),(0,k.Z)(this,"gatherTimelinePanelRef",(e=>{this.messagePanel=e})),(0,k.Z)(this,"onHiddenHighlightsClick",(()=>{const e=this.getOldRoom();e&&x.ZP.dispatch({action:W.a.ViewRoom,room_id:e.roomId,metricsTrigger:"Predecessor"})})),(0,k.Z)(this,"onFileDrop",(async e=>{const t=this.getRoomId();t&&this.context.client&&await Xd.ZP.sharedInstance().sendContentListToRoom(Array.from(e.files),t,void 0,this.context.client,qt.SB.Room)})),(0,k.Z)(this,"onMeasurement",(e=>{this.setState({narrow:e})})),(0,k.Z)(this,"onSubmitAskToJoin",(e=>{const t=this.getRoomId();(0,qf.p)(t)&&x.ZP.dispatch({action:W.a.SubmitAskToJoin,roomId:t,opts:{reason:e}})})),(0,k.Z)(this,"onCancelAskToJoin",(()=>{const e=this.getRoomId();(0,qf.p)(e)&&x.ZP.dispatch({action:W.a.CancelAskToJoin,roomId:e})})),this.askToJoinEnabled=L.C.getValue("feature_ask_to_join"),!t.client)throw new Error("Unable to create RoomView without MatrixClient");const s=t.client.hasLazyLoadMembersEnabled();this.state={roomId:void 0,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!s,numUnreadMessages:0,callState:void 0,activeCall:null,canPeek:!1,canSelfRedact:!1,showApps:!1,isPeeking:!1,showRightPanel:!1,threadRightPanel:!1,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSendMessages:!1,resizing:!1,layout:L.C.getValue("layout"),lowBandwidth:L.C.getValue("lowBandwidth"),alwaysShowTimestamps:L.C.getValue("alwaysShowTimestamps"),showTwelveHourTimestamps:L.C.getValue("showTwelveHourTimestamps"),readMarkerInViewThresholdMs:L.C.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:L.C.getValue("readMarkerOutOfViewThresholdMs"),showHiddenEvents:L.C.getValue("showHiddenEventsInTimeline"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:null===(i=t.client)||void 0===i?void 0:i.isInitialSyncComplete(),mainSplitContentType:_E.Timeline,timelineRenderingType:qt.SB.Room,liveTimeline:void 0,narrow:!1,msc3946ProcessDynamicPredecessor:L.C.getValue("feature_dynamic_room_predecessors"),canAskToJoin:this.askToJoinEnabled,promptAskToJoin:!1,viewRoomOpts:{buttons:[]}},this.dispatcherRef=x.ZP.register(this.onAction),t.client.on(n.ClientEvent.Room,this.onRoom),t.client.on(n.RoomEvent.Timeline,this.onRoomTimeline),t.client.on(n.RoomEvent.TimelineReset,this.onRoomTimelineReset),t.client.on(n.RoomEvent.Name,this.onRoomName),t.client.on(n.RoomStateEvent.Events,this.onRoomStateEvents),t.client.on(n.RoomStateEvent.Update,this.onRoomStateUpdate),t.client.on(n.RoomEvent.MyMembership,this.onMyMembership),t.client.on(j.qG.KeyBackupStatus,this.onKeyBackupStatus),t.client.on(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged),t.client.on(j.qG.UserTrustStatusChanged,this.onUserVerificationChanged),t.client.on(j.qG.KeysChanged,this.onCrossSigningKeysChanged),t.client.on(n.MatrixEventEvent.Decrypted,this.onEventDecrypted),t.roomViewStore.on(Pa.a,this.onRoomViewStoreUpdate),t.rightPanelStore.on(Pa.a,this.onRightPanelStoreUpdate),Gg.Z.on(Pa.a,this.onWidgetEchoStoreUpdate),t.widgetStore.on(Pa.a,this.onWidgetStoreUpdate),lf.c.instance.on(lf.h.ActiveCalls,this.onActiveCalls),this.props.resizeNotifier.on("isResizing",this.onIsResizing),this.settingWatchers=[L.C.watchSetting("layout",null,((...[,,,e])=>this.setState({layout:e}))),L.C.watchSetting("lowBandwidth",null,((...[,,,e])=>this.setState({lowBandwidth:e}))),L.C.watchSetting("alwaysShowTimestamps",null,((...[,,,e])=>this.setState({alwaysShowTimestamps:e}))),L.C.watchSetting("showTwelveHourTimestamps",null,((...[,,,e])=>this.setState({showTwelveHourTimestamps:e}))),L.C.watchSetting("readMarkerInViewThresholdMs",null,((...[,,,e])=>this.setState({readMarkerInViewThresholdMs:e}))),L.C.watchSetting("readMarkerOutOfViewThresholdMs",null,((...[,,,e])=>this.setState({readMarkerOutOfViewThresholdMs:e}))),L.C.watchSetting("showHiddenEventsInTimeline",null,((...[,,,e])=>this.setState({showHiddenEvents:e}))),L.C.watchSetting("urlPreviewsEnabled",null,this.onUrlPreviewsEnabledChange),L.C.watchSetting("urlPreviewsEnabled_e2ee",null,this.onUrlPreviewsEnabledChange),L.C.watchSetting("feature_dynamic_room_predecessors",null,((...[,,,e])=>this.setState({msc3946ProcessDynamicPredecessor:e})))]}doMaybeRemoveOwnJitsiWidget(){if(!this.state.roomId||!this.state.room||!this.context.client)return;const e=this.context.widgetStore.getApps(this.state.roomId).filter((e=>e.eventId&&Zm.l.JITSI.matches(e.type)));if(e.length<2)return;const t=this.context.client.getSafeUserId(),i=e.find((e=>e.creatorUserId===t));if(!i)return;const n=this.state.room.findEventById(i.eventId);if(!n)return;const s=n.getTs();if(!s)return;const o=e.reduce(((e,t)=>{var n;if(t.eventId===i.eventId)return e;const s=(null===(n=this.state.room.findEventById(t.eventId))||void 0===n?void 0:n.getTs())||0;return Math.max(e,s)}),0);o&&s>o&&s-o<3e4&&Sm.Z.setRoomWidget(this.context.client,this.state.roomId,i.id)}getPermalinkCreatorForRoom(){const{room:e,roomId:t}=this.state;if(void 0===e){if((0,qf.p)(t)){const e=new Rt.w6(null,t);return this.permalinkCreators[t]=e,e}throw new Error("Cannot get a permalink creator without a roomId")}return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new Rt.w6(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,i,s){var o;if(!i&&t)if(!e&&s)r.k.info(`Attempting to peek into room ${t}`),this.setState({peekLoading:!0,isPeeking:!0}),null===(o=this.context.client)||void 0===o||o.peekInRoom(t).then((e=>{this.unmounted||(this.setState({room:e,peekLoading:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===n.JoinRule.Knock}),this.onRoomLoaded(e))})).catch((e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}}));else if(e){var a;null===(a=this.context.client)||void 0===a||a.stopPeeking(),this.setState({isPeeking:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===n.JoinRule.Knock})}}shouldShowApps(e){if(!vE||!e)return!1;const t=e.roomId+"_hide_widget_drawer",i=localStorage.getItem(t),n=!i||"false"===i,s=this.context.widgetLayoutStore.getContainerWidgets(e,Nm.W2.Top);return n&&s.length>0}componentDidMount(){this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=null==e?void 0:e.state;this.setState({callState:t}),this.context.legacyCallHandler.on(lt.QC.CallState,this.onCallState),window.addEventListener("beforeunload",this.onPageUnload)}shouldComponentUpdate(e,t){const i=(0,ni.U0)(this.props,e),n=this.state,{upgradeRecommendation:s}=n,o=(0,v.Z)(n,mE),{upgradeRecommendation:a}=t,r=(0,v.Z)(t,hE),l=(null==a?void 0:a.needsUpgrade)!==(null==s?void 0:s.needsUpgrade)||(0,ni.U0)(o,r);return i||l}componentDidUpdate(){this.messagePanel&&void 0===this.state.atEndOfLiveTimeline&&this.setState({atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()})}componentWillUnmount(){var e,t;(this.unmounted=!0,this.context.legacyCallHandler.removeListener(lt.QC.CallState,this.onCallState),this.state.roomId&&Hg.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek)&&(null===(e=this.context.client)||void 0===e||e.stopPeeking());this.stopAllPermalinkCreators(),x.ZP.unregister(this.dispatcherRef),this.context.client&&(this.context.client.removeListener(n.ClientEvent.Room,this.onRoom),this.context.client.removeListener(n.RoomEvent.Timeline,this.onRoomTimeline),this.context.client.removeListener(n.RoomEvent.TimelineReset,this.onRoomTimelineReset),this.context.client.removeListener(n.RoomEvent.Name,this.onRoomName),this.context.client.removeListener(n.RoomStateEvent.Events,this.onRoomStateEvents),this.context.client.removeListener(n.RoomEvent.MyMembership,this.onMyMembership),this.context.client.removeListener(n.RoomStateEvent.Update,this.onRoomStateUpdate),this.context.client.removeListener(j.qG.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.removeListener(j.qG.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.context.client.removeListener(j.qG.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.removeListener(j.qG.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.removeListener(n.MatrixEventEvent.Decrypted,this.onEventDecrypted)),window.removeEventListener("beforeunload",this.onPageUnload),this.context.roomViewStore.off(Pa.a,this.onRoomViewStoreUpdate),this.context.rightPanelStore.off(Pa.a,this.onRightPanelStoreUpdate),Gg.Z.removeListener(Pa.a,this.onWidgetEchoStoreUpdate),this.context.widgetStore.removeListener(Pa.a,this.onWidgetStoreUpdate),this.props.resizeNotifier.off("isResizing",this.onIsResizing),this.state.room&&this.context.widgetLayoutStore.off(Nm.z3.emissionForRoom(this.state.room),this.onWidgetLayoutChange),lf.c.instance.off(lf.h.ActiveCalls,this.onActiveCalls),this.context.legacyCallHandler.off(lt.QC.CallState,this.onCallState),this.updateRoomMembers.cancel();for(const e of this.settingWatchers)L.C.unwatchSetting(e);this.viewsLocalRoom&&this.state.room&&(null===(t=this.context.client)||void 0===t||t.store.removeRoom(this.state.room.roomId))}onLocalRoomEvent(e){this.context.client&&this.state.room&&e===this.state.room.roomId&&(0,zf.pW)(this.context.client,this.state.room)}getRoomTombstone(e=this.state.room){var t;return null!==(t=null==e?void 0:e.currentState.getStateEvents(n.EventType.RoomTombstone,""))&&void 0!==t?t:void 0}async calculateRecommendedVersion(e){const t=await e.getRecommendedVersion();this.unmounted||this.setState({upgradeRecommendation:t})}async loadMembersIfJoined(e){var t;if(null!==(t=this.context.client)&&void 0!==t&&t.hasLazyLoadMembersEnabled()&&e&&"join"===e.getMyMembership())try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const i=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;r.k.error(i),r.k.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents(n.EventType.RoomHistoryVisibility,"");this.setState({canPeek:(null==t?void 0:t.getContent().history_visibility)===n.HistoryVisibility.WorldReadable})}updatePreviewUrlVisibility({roomId:e}){var t;const i=null!==(t=this.context.client)&&void 0!==t&&t.isRoomEncrypted(e)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:L.C.getValue(i,e)})}async updateE2EStatus(e){var t;if(null===(t=this.context.client)||void 0===t||!t.isRoomEncrypted(e.roomId))return;let i=Rm._.Warning;this.context.client.isCryptoEnabled()&&(i=await(0,Rm.b)(this.context.client,e)),this.unmounted||this.setState({e2eStatus:i})}updatePermissions(e){if(e&&this.context.client){const t=this.context.client.getSafeUserId(),i="join"===e.getMyMembership()&&e.currentState.maySendEvent(n.EventType.Reaction,t),s=e.maySendMessage(),o=e.currentState.maySendEvent(n.EventType.RoomRedaction,t);this.setState({canReact:i,canSendMessages:s,canSelfRedact:o})}}checkDesktopNotifications(){if(!this.state.room)return;this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&S.default.shouldShowPrompt()&&(0,uf.C)(!0)}updateDMState(){const e=this.state.room;if("join"!==(null==e?void 0:e.getMyMembership()))return;const t=e.getDMInviter();t&&Ia.T8(e.client,e.roomId,t)}injectSticker(e,t,i,n){const s=this.getRoomId();this.context.client&&s&&(this.context.client.isGuest()?x.ZP.dispatch({action:"require_registration"}):Xd.ZP.sharedInstance().sendStickerContentToRoom(e,s,n,t,i,this.context.client).then(void 0,(e=>{e.name})))}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?this.context.legacyCallHandler.getCallForRoom(this.state.room.roomId):null}getOldRoom(){var e,t;const{roomId:i}=(null===(e=this.state.room)||void 0===e?void 0:e.findPredecessor(this.state.msc3946ProcessDynamicPredecessor))||{};return(null===(t=this.context.client)||void 0===t?void 0:t.getRoom(i))||null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount(n.NotificationCountType.Highlight):0}get messagePanelClassNames(){return yt()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.layout===St.A.IRC})}get viewsLocalRoom(){return(0,Wn.S)(this.state.room)}get permalinkCreator(){return this.getPermalinkCreatorForRoom()}renderLocalRoomCreateLoader(e){var t;if(!this.state.room||null===(t=this.context)||void 0===t||!t.client)return null;const i=this.state.room.getDefaultRoomName(this.context.client.getSafeUserId());return o.createElement(qt.ZP.Provider,{value:this.state},o.createElement(EE,{localRoom:e,names:i,resizeNotifier:this.props.resizeNotifier}))}renderLocalRoomView(e){return o.createElement(qt.ZP.Provider,{value:this.state},o.createElement(fE,{localRoom:e,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,roomView:this.roomView,onFileDrop:this.onFileDrop}))}renderWaitingForThirdPartyRoomView(e){return o.createElement(qt.ZP.Provider,{value:this.state},o.createElement(dE,{resizeNotifier:this.props.resizeNotifier,roomView:this.roomView,inviteEvent:e}))}render(){var e,t;if(!this.context.client)return null;if(this.state.room instanceof dp.pP)return this.state.room.state===dp.sD.CREATING?this.renderLocalRoomCreateLoader(this.state.room):this.renderLocalRoomView(this.state.room);if(this.state.room){const{shouldEncrypt:e,inviteEvent:t}=mp(this.state.room);if(e)return this.renderWaitingForThirdPartyRoomView(t)}const i=L.C.getValue("feature_new_room_decoration_ui")?"new":"legacy";if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return o.createElement("div",{className:"mx_RoomView","data-room-header":i},o.createElement($h.Z,null,o.createElement(Qg,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData,roomId:this.state.roomId})))}{var s,a;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(s=this.props.threepidInvite)||void 0===s?void 0:s.toEmail,n=this.state.roomAlias;return o.createElement("div",{className:"mx_RoomView","data-room-header":i},o.createElement($h.Z,null,o.createElement(Qg,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:n,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,signUrl:null===(a=this.props.threepidInvite)||void 0===a?void 0:a.signUrl,roomId:this.state.roomId,promptAskToJoin:this.state.promptAskToJoin,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin})))}}const r=this.state.room.getMyMembership();if(R_(this.state.room)&&(!L.C.getValue("feature_video_rooms")||"join"!==r))return o.createElement($h.Z,null,o.createElement("div",{className:"mx_MainSplit"},o.createElement(mv,{room:this.state.room,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.onRejectButtonClicked})),";");if("invite"===r&&!this.state.room.isSpaceRoom()){if(this.state.joining||this.state.rejecting)return o.createElement($h.Z,null,o.createElement(Qg,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting,roomId:this.state.roomId}));{const e=this.context.client.getSafeUserId(),t=this.state.room.getMember(e),n=t?t.events.member:null;let s=(0,l._t)("room|inviter_unknown");var c,d;if(n)s=null!==(c=null===(d=n.sender)||void 0===d?void 0:d.name)&&void 0!==c?c:n.getSender();return o.createElement("div",{className:"mx_RoomView","data-room-header":i},o.createElement($h.Z,null,o.createElement(Qg,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:s,canPreview:!1,joining:this.state.joining,room:this.state.room,roomId:this.state.roomId})))}}if(this.state.canAskToJoin&&["knock","leave"].includes(r))return o.createElement("div",{className:"mx_RoomView","data-room-header":i},o.createElement($h.Z,null,o.createElement(Qg,{onJoinClick:this.onJoinButtonClicked,room:this.state.room,canAskToJoinAndMembershipIsLeave:"leave"===r,promptAskToJoin:this.state.promptAskToJoin,knocked:"knock"===r,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin,onForgetClick:this.onForgetClick})));let m,h=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(h=e)}let p=!0;Xd.ZP.sharedInstance().getCurrentUploads().length>0?m=o.createElement(Eg,{room:this.state.room}):this.state.search||(p=this.state.statusBarVisible,m=o.createElement(Vf.Z,{room:this.state.room,isPeeking:"join"!==r,onInviteClick:this.onInviteClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden}));const u=yt()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:p}),g=m&&o.createElement("div",{className:u},o.createElement("div",{className:"mx_RoomView_statusAreaBox"},o.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),m)),v=this.state.upgradeRecommendation,_=v&&v.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.client.getSafeUserId()),f=this.getHiddenHighlightCount();let E,y;var b;if(this.state.timelineRenderingType===qt.SB.Search)E=o.createElement(pv,{searchInProgress:null===(b=this.state.search)||void 0===b?void 0:b.inProgress,onCancelClick:this.onCancelSearchClick,onSearch:this.onSearch,isRoomEncrypted:this.context.client.isRoomEncrypted(this.state.room.roomId)});else if(_)E=o.createElement(gv,{room:this.state.room});else if("join"!==r){var w,S;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(w=this.props.threepidInvite)||void 0===w?void 0:w.toEmail;if(y=o.createElement(Qg,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room,roomId:this.state.roomId}),!(this.state.canPeek||null!==(S=this.state.room)&&void 0!==S&&S.isSpaceRoom()))return o.createElement("div",{className:"mx_RoomView","data-room-header":i},y)}else f>0&&(E=o.createElement(ae.Z,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},(0,l._t)("room|unread_notifications_predecessor",{count:f})));if(null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom()&&!this.props.forceTimeline)return o.createElement(Bf,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onRejectButtonClicked});const C=o.createElement(Xv,{room:this.state.room,userId:this.context.client.getSafeUserId(),showApps:this.state.showApps,resizeNotifier:this.props.resizeNotifier},E);let k;let x;"join"===r&&!this.state.search&&(k=o.createElement(vg,{room:this.state.room,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.permalinkCreator}));let R,I=!1;this.state.search&&(x=o.createElement(lE,{key:this.state.search.searchId,ref:this.searchResultsPanel,term:this.state.search.term,scope:this.state.search.scope,promise:this.state.search.promise,abortController:this.state.search.abortController,resizeNotifier:this.props.resizeNotifier,className:this.messagePanelClassNames,onUpdate:this.onSearchUpdate}),I=!0),this.state.isInitialEventHighlighted&&(R=this.state.initialEventId);const P=o.createElement(Ou,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),overlayTimelineSet:null===(t=this.state.virtualRoom)||void 0===t?void 0:t.getUnfilteredTimelineSet(),overlayTimelineSetFilter:Pu.xw,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:I,highlightedEventId:R,eventId:this.state.initialEventId,eventScrollIntoView:this.state.initialEventScrollIntoView,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onEventScrolledIntoView:this.resetJumpToEvent,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:this.messagePanelClassNames,membersLoaded:this.state.membersLoaded,permalinkCreator:this.permalinkCreator,resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,editState:this.state.editState});let T,Z;this.state.showTopUnreadMessagesBar&&!this.state.search&&(T=o.createElement(jf,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})),!1!==this.state.atEndOfLiveTimeline||this.state.search||(Z=o.createElement(Ug,{highlight:this.state.room.getUnreadNotificationCount(n.NotificationCountType.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline}));const N=this.state.room&&this.state.showRightPanel?o.createElement(zg,{room:this.state.room,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,e2eStatus:this.state.e2eStatus,onSearchClick:this.onSearchClick}):void 0,D=yt()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts}),M=yt()("mx_RoomView",{mx_RoomView_inCall:Boolean(h),mx_RoomView_immersive:this.state.mainSplitContentType!==_E.Timeline}),O=L.C.getValue("showChatEffects");let A,U;switch(this.state.mainSplitContentType){case _E.Timeline:U="mx_MainSplit_timeline",A=o.createElement(o.Fragment,null,this.roomViewBody.current&&o.createElement(Au,{sensor:this.roomViewBody.current,onMeasurement:this.onMeasurement}),C,o.createElement("div",{className:D},o.createElement(wg,{parent:this.roomView.current,onFileDrop:this.onFileDrop}),T,Z,P,x),g,y,k);break;case _E.MaximisedWidget:U="mx_MainSplit_maximisedWidget",A=o.createElement(o.Fragment,null,o.createElement(Iv,{room:this.state.room,userId:this.context.client.getSafeUserId(),resizeNotifier:this.props.resizeNotifier,showApps:!0}),y);break;case _E.Call:U="mx_MainSplit_call",A=o.createElement(o.Fragment,null,o.createElement(pf,{room:this.state.room,resizing:this.state.resizing,waitForCall:R_(this.state.room)}),y)}const F=yt()("mx_RoomView_body",U);let B=[im.q.Timeline],V=this.onAppsClick,j=this.onForgetClick,z=this.onSearchClick,W=null,H=!1;switch(this.state.mainSplitContentType){case _E.MaximisedWidget:B=[],V=null,j=null,z=null;break;case _E.Call:B=[],V=null,j=null,z=null,this.state.room.canInvite(this.context.client.getSafeUserId())&&(W=this.onInviteClick),H=!0}const G=this.state.room.getMember(this.context.client.getSafeUserId()),K=!this.context.client.isGuest()&&(["leave","ban"].includes(r)||(null==G?void 0:G.isKicked()));return o.createElement(qt.ZP.Provider,{value:this.state},o.createElement("main",{className:M,ref:this.roomView,onKeyDown:this.onReactKeyDown,"data-room-header":i},O&&this.roomView.current&&o.createElement(rf,{roomWidth:this.roomView.current.offsetWidth}),o.createElement($h.Z,null,o.createElement(tm,{panel:N,resizeNotifier:this.props.resizeNotifier,sizeKey:this.state.threadRightPanel?"thread":void 0,defaultSize:this.state.threadRightPanel?500:void 0},o.createElement("div",{className:F,ref:this.roomViewBody,"data-layout":this.state.layout},L.C.getValue("feature_new_room_decoration_ui")?o.createElement(af,{room:this.state.room,additionalButtons:this.state.viewRoomOpts.buttons}):o.createElement(U_,{room:this.state.room,searchInfo:this.state.search,oobData:this.props.oobData,inRoom:"join"===r,onSearchClick:z,onInviteClick:W,onForgetClick:K?j:null,e2eStatus:this.state.e2eStatus,onAppsClick:this.state.hasPinnedWidgets?V:null,appsShown:this.state.showApps,excludedRightPanelPhaseButtons:B,showButtons:!this.viewsLocalRoom,enableRoomOptionsMenu:!this.viewsLocalRoom,viewingCall:H,activeCall:this.state.activeCall,additionalButtons:this.state.viewRoomOpts.buttons}),A)))))}}(0,k.Z)(yE,"contextType",ie.f);const bE=yE;class wE extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onToastStoreUpdate",(()=>{this.setState({toasts:F.Z.sharedInstance().getToasts(),countSeen:F.Z.sharedInstance().getCountSeen()})})),this.state={toasts:F.Z.sharedInstance().getToasts(),countSeen:F.Z.sharedInstance().getCountSeen()},F.Z.sharedInstance().on("update",this.onToastStoreUpdate)}componentWillUnmount(){F.Z.sharedInstance().removeListener("update",this.onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let i,n;if(0!==e){const s=this.state.toasts[0],{title:a,icon:r,key:l,component:c,className:d,bodyClassName:m,props:h}=s,p=yt()("mx_Toast_body",m),u=yt()("mx_Toast_toast",d,{mx_Toast_hasIcon:r,[`mx_Toast_icon_${r}`]:r}),g=Object.assign({},h,{key:l,toastKey:l}),v=o.createElement(c,g);let _,f;(a&&t||this.state.countSeen>0)&&(_=` (${this.state.countSeen+1}/${this.state.countSeen+e})`),a&&(f=o.createElement("div",{className:"mx_Toast_title"},o.createElement("h2",null,a),o.createElement("span",{className:"mx_Toast_title_countIndicator"},_))),i=o.createElement("div",{className:u},f,o.createElement("div",{className:p},v)),n=yt()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return i?o.createElement("div",{className:n,role:"alert"},i):null}}class SE extends o.Component{constructor(e){super(e),(0,k.Z)(this,"context",void 0),this.state={loading:!0}}componentDidMount(){this.props.userId&&this.loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this.loadProfileInfo()}async loadProfileInfo(){let e;this.setState({loading:!0});try{e=await this.context.getProfileInfo(this.props.userId)}catch(e){return T.ZP.createDialog(dt.Z,{title:(0,l._t)("error_dialog|error_loading_user_profile"),description:e instanceof Error?e.message:(0,l._t)("invite|failed_generic")}),void this.setState({loading:!1})}const t=new n.MatrixEvent({type:"m.room.member",content:e}),i=new n.RoomMember("",this.props.userId);i.setMembershipEvent(t),this.setState({member:i,loading:!1})}render(){if(this.state.loading)return o.createElement(re.Z,null);if(this.state.member){const e=o.createElement(zg,{overwriteCard:{phase:im.q.RoomMemberInfo,state:{member:this.state.member}},resizeNotifier:this.props.resizeNotifier});return o.createElement(tm,{panel:e,resizeNotifier:this.props.resizeNotifier},o.createElement(jd,null))}return o.createElement("div",null)}}(0,k.Z)(SE,"contextType",pn.ZP);const CE=({backgroundImage:e,blurMultiplier:t})=>{if(!e)return null;const i={};if(t){const e=getComputedStyle(document.documentElement).getPropertyValue("--lp-background-blur").replace("px",""),n=parseInt(e,10);isNaN(n)||(i.filter=`blur(${n*t}px)`)}return o.createElement("div",{className:"mx_BackdropPanel"},o.createElement("img",{role:"presentation",alt:"",style:i,className:"mx_BackdropPanel--image",src:e}))};var kE=i("../matrix-react-sdk/res/img/location/live-location.svg");const xE=({isMinimized:e})=>{const t=(0,In.kZ)(y_.d.instance,y_.N.MonitoringLivePosition,(()=>y_.d.instance.isMonitoringLiveLocation)),i=(0,In.kZ)(y_.d.instance,y_.N.LocationPublishError,(()=>y_.d.instance.getLiveBeaconIdsWithLocationPublishError())),n=(0,In.kZ)(y_.d.instance,y_.N.BeaconUpdateError,(()=>y_.d.instance.getLiveBeaconIds().filter((e=>y_.d.instance.beaconUpdateErrors.has(e))))),s=(0,In.kZ)(y_.d.instance,y_.N.LivenessChange,(()=>y_.d.instance.getLiveBeaconIds())),a=!!i.length,r=!!n.length;if(((e,t)=>{(0,o.useEffect)((()=>{const i=()=>{"visible"===document.visibilityState&&e.forEach((e=>{var i;return null===(i=t.get(e))||void 0===i?void 0:i.monitorLiveness()}))};return e.length&&document.addEventListener("visibilitychange",i),()=>{document.removeEventListener("visibilitychange",i)}}),[e,t])})(s,y_.d.instance.beacons),!t)return null;const c=((e,t,i)=>{var n,s;const o=null!==(n=null!==(s=null==t?void 0:t[0])&&void 0!==s?s:null==i?void 0:i[0])&&void 0!==n?n:null==e?void 0:e[0];if(!o)return;return y_.d.instance.getBeaconById(o)})(s,n,i),d=c?e=>{x.ZP.dispatch({action:W.a.ViewRoom,room_id:c.roomId,metricsTrigger:void 0,event_id:c.beaconInfoId,scroll_into_view:!0,highlighted:!0})}:null,m=((e,t)=>e?(0,l._t)("location_sharing|error_stopping_live_location"):t?(0,l._t)("location_sharing|error_sharing_live_location"):(0,l._t)("location_sharing|live_location_active"))(r,a);return o.createElement(ae.Z,{className:yt()("mx_LeftPanelLiveShareWarning",{mx_LeftPanelLiveShareWarning__minimized:e,mx_LeftPanelLiveShareWarning__error:a||r}),title:e?m:void 0,onClick:d},e?o.createElement(kE.J,{height:10}):m)};function RE(e,t,i){return(1-(i=(0,ln.clamp)(i,0,1)))*e+i*t}const IE=58,PE=58,TE=76,ZE=8;class NE extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"callViewWrapper",(0,o.createRef)()),(0,k.Z)(this,"initX",0),(0,k.Z)(this,"initY",0),(0,k.Z)(this,"desiredTranslationX",mr.default.instance.windowWidth-ZE-336),(0,k.Z)(this,"desiredTranslationY",mr.default.instance.windowHeight-PE-232),(0,k.Z)(this,"translationX",this.desiredTranslationX),(0,k.Z)(this,"translationY",this.desiredTranslationY),(0,k.Z)(this,"mouseHeld",!1),(0,k.Z)(this,"scheduledUpdate",new Ku.x((()=>this.animationCallback()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),(0,k.Z)(this,"startingPositionX",0),(0,k.Z)(this,"startingPositionY",0),(0,k.Z)(this,"_moving",!1),(0,k.Z)(this,"animationCallback",(()=>{var e,t;if(!this.moving&&Math.abs(this.translationX-this.desiredTranslationX)<=1&&Math.abs(this.translationY-this.desiredTranslationY)<=1)this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY,this.setStyle();else{const e=this.moving?.2:.1;this.translationX=RE(this.translationX,this.desiredTranslationX,e),this.translationY=RE(this.translationY,this.desiredTranslationY,e),this.setStyle(),this.scheduledUpdate.mark()}null===(e=(t=this.props).onMove)||void 0===e||e.call(t)})),(0,k.Z)(this,"setStyle",(()=>{this.callViewWrapper.current&&(this.callViewWrapper.current.style.transform=`translateX(${this.translationX}px) translateY(${this.translationY}px)`)})),(0,k.Z)(this,"onResize",(()=>{this.snap(!1)})),(0,k.Z)(this,"snap",((e=!1)=>{var t,i;const n=this.desiredTranslationX,s=this.desiredTranslationY,o=mr.default.instance.windowWidth-((null===(t=this.callViewWrapper.current)||void 0===t?void 0:t.clientWidth)||336),a=mr.default.instance.windowHeight-((null===(i=this.callViewWrapper.current)||void 0===i?void 0:i.clientHeight)||232);n>=o/2&&s>=a/2?(this.desiredTranslationX=o-ZE,this.desiredTranslationY=a-PE):n>=o/2&&s<=a/2?(this.desiredTranslationX=o-ZE,this.desiredTranslationY=IE):n<=o/2&&s>=a/2?(this.desiredTranslationX=TE,this.desiredTranslationY=a-PE):(this.desiredTranslationX=TE,this.desiredTranslationY=IE),e||(this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY),this.scheduledUpdate.mark()})),(0,k.Z)(this,"onStartMoving",(e=>{e.preventDefault(),e.stopPropagation(),this.mouseHeld=!0,this.startingPositionX=e.clientX,this.startingPositionY=e.clientY})),(0,k.Z)(this,"onMoving",(e=>{this.mouseHeld&&(Math.abs(this.startingPositionX-e.clientX)<5&&Math.abs(this.startingPositionY-e.clientY)<5||(e.preventDefault(),e.stopPropagation(),this.moving||(this.moving=!0,this.initX=e.pageX-this.desiredTranslationX,this.initY=e.pageY-this.desiredTranslationY,this.scheduledUpdate.mark()),this.setTranslation(e.pageX-this.initX,e.pageY-this.initY)))})),(0,k.Z)(this,"onEndMoving",(e=>{this.mouseHeld&&(e.preventDefault(),e.stopPropagation(),this.mouseHeld=!1,setImmediate((()=>this.moving=!1)),this.snap(!0))})),(0,k.Z)(this,"onClickCapture",(e=>{this.moving&&(e.preventDefault(),e.stopPropagation())}))}get moving(){return this._moving}set moving(e){this._moving=e}componentDidMount(){document.addEventListener("mousemove",this.onMoving),document.addEventListener("mouseup",this.onEndMoving),mr.default.instance.on(mr.Q.Resize,this.onResize),this.snap()}componentWillUnmount(){document.removeEventListener("mousemove",this.onMoving),document.removeEventListener("mouseup",this.onEndMoving),mr.default.instance.off(mr.Q.Resize,this.onResize)}componentDidUpdate(e){e.children!==this.props.children&&this.snap(!0)}setTranslation(e,t){var i,n;const s=(null===(i=this.callViewWrapper.current)||void 0===i?void 0:i.clientWidth)||336,o=(null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientHeight)||232;e+s>=mr.default.instance.windowWidth?this.desiredTranslationX=mr.default.instance.windowWidth-s:this.desiredTranslationX=e<=0?0:e,t+o>=mr.default.instance.windowHeight?this.desiredTranslationY=mr.default.instance.windowHeight-o:this.desiredTranslationY=t<=0?0:t}render(){const e={transform:`translateX(${this.translationX}px) translateY(${this.translationY}px)`},t=this.props.children.map((e=>e({onStartMoving:this.onStartMoving,onResize:this.onResize})));return o.createElement("aside",{className:this.props.className,style:e,ref:this.callViewWrapper,onClickCapture:this.onClickCapture,onDoubleClick:this.props.onDoubleClick},t)}}var DE=i("../matrix-react-sdk/src/voice-broadcast/stores/VoiceBroadcastPlaybacksStore.ts");class ME extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"room",void 0),this.room=t.getRoom(this.props.persistentRoomId)}render(){const e=Cm.Z.instance.get(this.props.persistentWidgetId,this.props.persistentRoomId);return e?o.createElement(Eu,{key:e.id,app:e,fullWidth:!0,room:this.room,userId:this.context.getSafeUserId(),creatorUserId:e.creatorUserId,widgetPageTitle:Sm.Z.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,miniMode:!0,showMenubar:!1,pointerEvents:this.props.pointerEvents,movePersistedElement:this.props.movePersistedElement}):null}}var OE;function AE(){return AE=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},AE.apply(this,arguments)}function LE(e,t){return o.createElement("svg",AE({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 14",role:"presentation","aria-hidden":!0,ref:t},e),OE||(OE=o.createElement("path",{d:"M17 7H1m0 0l6 6M1 7l6-6",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"})))}(0,k.Z)(ME,"contextType",pn.ZP);var UE=o.forwardRef(LE);var FE,BE;function VE(){return VE=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},VE.apply(this,arguments)}function jE(e,t){return o.createElement("svg",VE({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),FE||(FE=o.createElement("path",{d:"M8.027 15.961c1.141 1.232 3.888 3.365 4.637 3.803l.151.09c1.143.679 4.722 2.807 7.33.815 2.021-1.542 1.364-3.278.684-3.794-.466-.362-1.838-1.36-3.128-2.26-1.268-.883-1.974-.175-2.452.303l-.026.026-.96.961c-.246.245-.618.156-.974-.125a26.02 26.02 0 01-2.692-2.385l-.004-.004c-.47-.47-1.4-1.4-2.373-2.68-.28-.356-.37-.728-.125-.973l.96-.961.027-.026c.478-.478 1.186-1.184.303-2.452-.9-1.29-1.898-2.662-2.26-3.128-.516-.68-2.252-1.337-3.794.684-1.992 2.608.136 6.187.815 7.33l.09.151c.438.75 2.56 3.484 3.791 4.625z",fill:"currentColor"})),BE||(BE=o.createElement("path",{d:"M20.697 3.078a.638.638 0 000-.893.615.615 0 00-.88 0L17 5.045l-2.817-2.86a.615.615 0 00-.88 0 .638.638 0 000 .893l2.817 2.86-2.938 2.984a.638.638 0 000 .893.615.615 0 00.88 0L17 6.832l2.938 2.983a.615.615 0 00.88 0 .638.638 0 000-.893L17.88 5.939l2.817-2.86z",fill:"currentColor"})))}var zE=o.forwardRef(jE);const WE=({widgetId:e,room:t,viewingRoom:i,onStartMoving:s,movePersistedElement:a})=>{const r=(0,o.useMemo)((()=>Cm.Z.instance.getApps(t.roomId).find((t=>t.id===e))),[t,e]),c=(0,In.A_)(t,n.RoomEvent.Name,(0,o.useCallback)((()=>t.name),[t])),d=(0,I_.Y5)(e,t.roomId),m=(0,o.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),null!==d?x.ZP.dispatch({action:W.a.ViewRoom,room_id:t.roomId,view_call:!0,metricsTrigger:"WebFloatingCallWindow"}):i?Nm.z3.instance.moveToContainer(t,r,Nm.W2.Center):x.ZP.dispatch({action:W.a.ViewRoom,room_id:t.roomId,metricsTrigger:"WebFloatingCallWindow"})}),[t,d,r,i]),h=(0,o.useCallback)((e=>{var t;(e.preventDefault(),e.stopPropagation(),null!==d)?d.disconnect().catch((e=>console.error("Failed to leave call",e))):null===(t=Tm.c.instance.getMessagingForUid(Sm.Z.getWidgetUid(r)))||void 0===t||t.transport.send(Dm.C.HangupCall,{}).catch((e=>console.error("Failed to leave Jitsi",e)))}),[d,r]);return o.createElement("div",{className:"mx_WidgetPip",onMouseDown:s,onClick:m},o.createElement(Hi.Z,{className:"mx_WidgetPip_header"},o.createElement(Gi.g$,{onClick:m,className:"mx_WidgetPip_backButton","aria-label":(0,l._t)("action|back")},o.createElement(UE,{className:"mx_Icon mx_Icon_16"}),c)),o.createElement(ME,{persistentWidgetId:e,persistentRoomId:t.roomId,pointerEvents:"none",movePersistedElement:a}),(null!==d||Zm.l.JITSI.matches(null==r?void 0:r.type))&&o.createElement(Hi.Z,{className:"mx_WidgetPip_footer"},o.createElement(Gi.yy,{onClick:h,tooltip:(0,l._t)("action|leave"),"aria-label":(0,l._t)("action|leave"),alignment:si.v.Top},o.createElement(zE,{className:"mx_Icon mx_Icon_24"}))))},HE=[xt.OX.Connected,xt.OX.InviteSent,xt.OX.Connecting,xt.OX.CreateAnswer,xt.OX.CreateOffer,xt.OX.WaitLocalMedia];function GE(e){if(!e)return[null,[]];const t=lt.ZP.instance.getAllActiveCallsForPip(e);let i=null,n=[];for(const e of t)HE.includes(e.state)&&(e.isRemoteOnHold()||null!==i?n.push(e):i=e);return null===i&&n.length>0&&(i=n[0],n=n.slice(1)),n.length>1&&r.k.log("Found more than 1 secondary call! Other calls will not be shown."),[i,n]}class KE extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onMove",(()=>{var e,t;return null===(e=(t=this.props.movePersistedElement).current)||void 0===e?void 0:e.call(t)})),(0,k.Z)(this,"onRoomViewStoreUpdate",(()=>{var e,t;const i=ie.m.instance.roomViewStore.getRoomId(),n=this.state.viewedRoomId;if(i===n)return;const s=null===(e=E.p.get())||void 0===e?void 0:e.getRoom(n);s&&Nm.z3.instance.off(Nm.z3.emissionForRoom(s),this.updateCalls);const o=null===(t=E.p.get())||void 0===t?void 0:t.getRoom(i||void 0);if(o&&Nm.z3.instance.on(Nm.z3.emissionForRoom(o),this.updateCalls),!i)return;const[a,r]=GE(i);this.setState({viewedRoomId:i,primaryCall:a,secondaryCall:r[0]}),this.updateShowWidgetInPip()})),(0,k.Z)(this,"onWidgetPersistence",(()=>{this.updateShowWidgetInPip()})),(0,k.Z)(this,"onWidgetDockChanges",(()=>{this.updateShowWidgetInPip()})),(0,k.Z)(this,"updateCalls",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=GE(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]}),this.updateShowWidgetInPip()})),(0,k.Z)(this,"onCallRemoteHold",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=GE(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]})})),(0,k.Z)(this,"onDoubleClick",(()=>{var e;const t=null===(e=this.state.primaryCall)||void 0===e?void 0:e.roomId;var i;(null!=t?t:this.state.persistentRoomId)&&x.ZP.dispatch({action:W.a.ViewRoom,room_id:null!==(i=null!=t?t:this.state.persistentRoomId)&&void 0!==i?i:void 0,metricsTrigger:"WebFloatingCallWindow"})}));const t=ie.m.instance.roomViewStore.getRoomId(),[i,n]=GE(t);this.state={viewedRoomId:t||void 0,primaryCall:i||null,secondaryCall:n[0],persistentWidgetId:Z.Z.instance.getPersistentWidgetId(),persistentRoomId:Z.Z.instance.getPersistentRoomId(),showWidgetInPip:!1}}componentDidMount(){lt.ZP.instance.addListener(lt.QC.CallChangeRoom,this.updateCalls),lt.ZP.instance.addListener(lt.QC.CallState,this.updateCalls),ie.m.instance.roomViewStore.addListener(Pa.a,this.onRoomViewStoreUpdate),E.p.safeGet().on(xt.nP.RemoteHoldUnhold,this.onCallRemoteHold);const e=E.p.safeGet().getRoom(this.state.viewedRoomId);e&&Nm.z3.instance.on(Nm.z3.emissionForRoom(e),this.updateCalls),Z.Z.instance.on(Z.G.Persistence,this.onWidgetPersistence),Z.Z.instance.on(Z.G.Dock,this.onWidgetDockChanges),Z.Z.instance.on(Z.G.Undock,this.onWidgetDockChanges)}componentWillUnmount(){lt.ZP.instance.removeListener(lt.QC.CallChangeRoom,this.updateCalls),lt.ZP.instance.removeListener(lt.QC.CallState,this.updateCalls);const e=E.p.get();null==e||e.removeListener(xt.nP.RemoteHoldUnhold,this.onCallRemoteHold),ie.m.instance.roomViewStore.removeListener(Pa.a,this.onRoomViewStoreUpdate);const t=null==e?void 0:e.getRoom(this.state.viewedRoomId);t&&Nm.z3.instance.off(Nm.z3.emissionForRoom(t),this.updateCalls),Z.Z.instance.off(Z.G.Persistence,this.onWidgetPersistence),Z.Z.instance.off(Z.G.Dock,this.onWidgetDockChanges),Z.Z.instance.off(Z.G.Undock,this.onWidgetDockChanges)}updateShowWidgetInPip(){const e=Z.Z.instance.getPersistentWidgetId(),t=Z.Z.instance.getPersistentRoomId();let i=!1,n=!1;e&&t&&E.p.safeGet().getRoom(t)&&(n=!Z.Z.instance.isDocked(e,t),i=this.state.viewedRoomId!==t);const s=i||n;this.setState({showWidgetInPip:s,persistentWidgetId:e,persistentRoomId:t})}createVoiceBroadcastPlaybackPipContent(e){const t=this.state.viewedRoomId===e.infoEvent.getRoomId()?o.createElement(Ut.Mm,{playback:e,pip:!0}):o.createElement(Ut._k,{playback:e});return({onStartMoving:i})=>o.createElement("div",{key:`vb-playback-${e.infoEvent.getId()}`,onMouseDown:i},t)}createVoiceBroadcastPreRecordingPipContent(e){return({onStartMoving:t})=>o.createElement("div",{key:"vb-pre-recording",onMouseDown:t},o.createElement(Ut.K4,{voiceBroadcastPreRecording:e}))}createVoiceBroadcastRecordingPipContent(e){return({onStartMoving:t})=>o.createElement("div",{key:`vb-recording-${e.infoEvent.getId()}`,onMouseDown:t},o.createElement(Ut.jZ,{recording:e}))}render(){let e=[];if(this.props.voiceBroadcastRecording?e=[this.createVoiceBroadcastRecordingPipContent(this.props.voiceBroadcastRecording)]:this.props.voiceBroadcastPreRecording?e=[this.createVoiceBroadcastPreRecordingPipContent(this.props.voiceBroadcastPreRecording)]:this.props.voiceBroadcastPlayback&&(e=[this.createVoiceBroadcastPlaybackPipContent(this.props.voiceBroadcastPlayback)]),this.state.primaryCall){const t=this.state.primaryCall;e.push((({onStartMoving:e,onResize:i})=>o.createElement(Yv,{onMouseDownOnHeader:e,call:t,secondaryCall:this.state.secondaryCall,pipMode:true,onResize:i})))}return this.state.showWidgetInPip&&this.state.persistentWidgetId&&e.push((({onStartMoving:e})=>{var t;return o.createElement(WE,{widgetId:this.state.persistentWidgetId,room:E.p.safeGet().getRoom(null!==(t=this.state.persistentRoomId)&&void 0!==t?t:void 0),viewingRoom:this.state.viewedRoomId===this.state.persistentRoomId,onStartMoving:e,movePersistedElement:this.props.movePersistedElement})})),e.length?o.createElement(NE,{className:"mx_LegacyCallPreview",draggable:true,onDoubleClick:this.onDoubleClick,onMove:this.onMove},e):null}}const qE=()=>{const e=(0,o.useContext)(ie.f),t=e.voiceBroadcastPreRecordingStore,{currentVoiceBroadcastPreRecording:i}=(0,Ut.D6)(t),n=e.voiceBroadcastRecordingsStore,{currentVoiceBroadcastRecording:s}=(0,Ut.LP)(n),a=e.voiceBroadcastPlaybacksStore,{currentVoiceBroadcastPlayback:r}=(l=a,{currentVoiceBroadcastPlayback:(0,In.A_)(l,DE.Z.CurrentChanged,(e=>null!=e?e:l.getCurrent()))});var l;const c=(0,o.useRef)();return o.createElement(KE,{voiceBroadcastPlayback:r,voiceBroadcastPreRecording:i,voiceBroadcastRecording:s,movePersistedElement:c})};var $E=i("../matrix-js-sdk/src/pushprocessor.ts");class JE{static encodeActions(e){const t=e.notify,i=e.sound,s=e.highlight;if(t){const e=[n.PushRuleActionName.Notify];return i&&e.push({set_tweak:"sound",value:i}),s?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[n.PushRuleActionName.DontNotify]}static decodeActions(e){let t,i=!1,s=!1;for(const o of e)if(o===n.PushRuleActionName.Notify)i=!0;else if(o===n.PushRuleActionName.DontNotify)i=!1;else{if("object"!=typeof o)return null;if("sound"===o.set_tweak)t=o.value;else{if("highlight"!==o.set_tweak)return null;s=o.value}}void 0===s&&(s=!0);const o={notify:i,highlight:s};return void 0!==t&&(o.sound=t),o}}const YE=JE.encodeActions;class QE{}(0,k.Z)(QE,"ACTION_NOTIFY",YE({notify:!0})),(0,k.Z)(QE,"ACTION_NOTIFY_DEFAULT_SOUND",YE({notify:!0,sound:"default"})),(0,k.Z)(QE,"ACTION_NOTIFY_RING_SOUND",YE({notify:!0,sound:"ring"})),(0,k.Z)(QE,"ACTION_HIGHLIGHT",YE({notify:!0,highlight:!0})),(0,k.Z)(QE,"ACTION_HIGHLIGHT_DEFAULT_SOUND",YE({notify:!0,sound:"default",highlight:!0})),(0,k.Z)(QE,"ACTION_DONT_NOTIFY",YE({notify:!1})),(0,k.Z)(QE,"ACTION_DISABLED",void 0);let XE=function(e){return e.Off="off",e.On="on",e.Loud="loud",e}({});class ey{static actionsFor(e){return e===XE.On?QE.ACTION_NOTIFY:e===XE.Loud?QE.ACTION_HIGHLIGHT_DEFAULT_SOUND:[]}static contentRuleVectorStateKind(e){const t=JE.decodeActions(e.actions);if(!t)return null;let i=0;t.sound&&i++,t.highlight&&i++;let n=null;switch(i){case 0:n=XE.On;break;case 2:n=XE.Loud}return n}}(0,k.Z)(ey,"OFF",XE.Off),(0,k.Z)(ey,"ON",XE.On),(0,k.Z)(ey,"LOUD",XE.Loud),(0,k.Z)(ey,"states",XE);class ty{constructor(e){(0,k.Z)(this,"description",void 0),(0,k.Z)(this,"vectorStateToActions",void 0),(0,k.Z)(this,"syncedRuleIds",void 0),this.description=e.description,this.vectorStateToActions=e.vectorStateToActions,this.syncedRuleIds=e.syncedRuleIds}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const i of Object.values(ey.states)){const n=this.vectorStateToActions[i];if(n){if(t&&JSON.stringify(JE.decodeActions(e.actions))===JSON.stringify(JE.decodeActions(n)))return i}else if(!t)return i}r.k.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: ${JSON.stringify(this.vectorStateToActions)}`)}}const iy={".m.rule.contains_display_name":new ty({description:(0,l.I8)("settings|notifications|rule_contains_display_name"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_HIGHLIGHT_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DISABLED}}),".m.rule.contains_user_name":new ty({description:(0,l.I8)("settings|notifications|rule_contains_user_name"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_HIGHLIGHT_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DISABLED},syncedRuleIds:[n.RuleId.IsUserMention]}),".m.rule.roomnotif":new ty({description:(0,l.I8)("settings|notifications|rule_roomnotif"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_HIGHLIGHT,[XE.Off]:QE.ACTION_DISABLED},syncedRuleIds:[n.RuleId.IsRoomMention]}),".m.rule.room_one_to_one":new ty({description:(0,l.I8)("settings|notifications|rule_room_one_to_one"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_NOTIFY_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DONT_NOTIFY},syncedRuleIds:[n.RuleId.PollStartOneToOne,n.RuleId.PollStartOneToOneUnstable,n.RuleId.PollEndOneToOne,n.RuleId.PollEndOneToOneUnstable]}),".m.rule.encrypted_room_one_to_one":new ty({description:(0,l.I8)("settings|notifications|rule_encrypted_room_one_to_one"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_NOTIFY_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DONT_NOTIFY}}),".m.rule.message":new ty({description:(0,l.I8)("settings|notifications|rule_message"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_NOTIFY_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DONT_NOTIFY},syncedRuleIds:[n.RuleId.PollStart,n.RuleId.PollStartUnstable,n.RuleId.PollEnd,n.RuleId.PollEndUnstable]}),".m.rule.encrypted":new ty({description:(0,l.I8)("settings|notifications|rule_encrypted"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_NOTIFY_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new ty({description:(0,l.I8)("settings|notifications|rule_invite_for_me"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_NOTIFY_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DISABLED}}),".m.rule.call":new ty({description:(0,l.I8)("settings|notifications|rule_call"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_NOTIFY_RING_SOUND,[XE.Off]:QE.ACTION_DISABLED}}),".m.rule.suppress_notices":new ty({description:(0,l.I8)("settings|notifications|rule_suppress_notices"),vectorStateToActions:{[XE.On]:QE.ACTION_DISABLED,[XE.Loud]:QE.ACTION_NOTIFY_DEFAULT_SOUND,[XE.Off]:QE.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new ty({description:(0,l.I8)("settings|notifications|rule_tombstone"),vectorStateToActions:{[XE.On]:QE.ACTION_NOTIFY,[XE.Loud]:QE.ACTION_HIGHLIGHT,[XE.Off]:QE.ACTION_DISABLED}})};class ny{static parseContentRules(e){const t=ny.categoriseContentRules(e);return t.loud.length?{vectorState:XE.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:XE.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:XE.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:XE.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:XE.On,rules:[],externalRules:t.other}}static categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const i in e.global)for(let s=0;s<Object.keys(e.global[i]).length;++s){const o=e.global[i][s];if("."!==o.rule_id[0]&&i===n.PushRuleKind.ContentSpecific)switch(o.kind=i,ey.contentRuleVectorStateKind(o)){case XE.On:o.enabled?t.on.push(o):t.on_but_disabled.push(o);break;case XE.Loud:o.enabled?t.loud.push(o):t.loud_but_disabled.push(o);break;default:t.other.push(o)}}return t}}const sy=async(e,t,i,n)=>{n?(await e.setPushRuleActions("global",i,t,n),await e.setPushRuleEnabled("global",i,t,!0)):await e.setPushRuleEnabled("global",i,t,!1)},oy=async(e,t,i)=>{const n=new $E.J(e),s=null==t?void 0:t.map((e=>n.getPushRuleAndKindById(e))).filter((e=>Boolean(e)));if(null!=s&&s.length)for(const{kind:t,rule:n}of s)await sy(e,n.rule_id,t,i)};function ay(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ry(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ay(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ay(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const ly=e=>e?ry(ry({},e.rule),{},{kind:e.kind}):void 0,cy=async(e,t)=>{if((null==e?void 0:e.getType())!==n.EventType.PushRules)return;const i=new $E.J(t);Object.entries(iy).forEach((async([e,n])=>{try{await(async(e,t,i,n)=>{var s;const o=ly(t.getPushRuleAndKindById(i));if(!o)return;const a=null===(s=n.syncedRuleIds)||void 0===s?void 0:s.map((e=>ly(t.getPushRuleAndKindById(e)))).filter((e=>Boolean(e)));if(null==a||!a.length)return;const r=n.ruleToVectorState(o),l=a.filter((e=>e.enabled!==o.enabled||n.ruleToVectorState(e)!==r));l.length&&await oy(e,l.map((({rule_id:e})=>e)),o.enabled?o.actions:void 0)})(t,i,e,n)}catch(t){r.k.error(`Failed to fully synchronise push rules for ${e}`,t)}}))};function dy(e){return e.closest("input, textarea, select, [contenteditable=true]")}class my extends o.Component{constructor(e){super(e),(0,k.Z)(this,"_matrixClient",void 0),(0,k.Z)(this,"_roomView",void 0),(0,k.Z)(this,"_resizeContainer",void 0),(0,k.Z)(this,"resizeHandler",void 0),(0,k.Z)(this,"layoutWatcherRef",void 0),(0,k.Z)(this,"compactLayoutWatcherRef",void 0),(0,k.Z)(this,"backgroundImageWatcherRef",void 0),(0,k.Z)(this,"resizer",void 0),(0,k.Z)(this,"onCallState",(()=>{const e=lt.ZP.instance.getAllActiveCalls();e!==this.state.activeCalls&&this.setState({activeCalls:e})})),(0,k.Z)(this,"refreshBackgroundImage",(async()=>{let e=L.C.getValue("RoomList.backgroundImage");e=e?(0,mn.TS)(e).srcHttp:Ml.p.instance.getHttpAvatarUrl(),this.setState({backgroundImage:e})})),(0,k.Z)(this,"canResetTimelineInRoom",(e=>!this._roomView.current||this._roomView.current.canResetTimeline())),(0,k.Z)(this,"onAccountData",(e=>{"m.ignored_user_list"===e.getType()&&x.ZP.dispatch({action:"ignore_state_changed"}),cy(e,this._matrixClient)})),(0,k.Z)(this,"onCompactLayoutChanged",(()=>{this.setState({useCompactLayout:L.C.getValue("useCompactLayout")})})),(0,k.Z)(this,"onSync",((e,t,i)=>{var s,o,a;const r=null===(s=this.state.syncErrorData)||void 0===s||null===(o=s.error)||void 0===o?void 0:o.errcode,l=null==i||null===(a=i.error)||void 0===a?void 0:a.errcode;e===t&&r===l||(this.setState({syncErrorData:e===n.SyncState.Error?i:void 0}),t===n.SyncState.Prepared&&e===n.SyncState.Syncing?this.updateServerNoticeEvents():this.calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))})),(0,k.Z)(this,"onRoomStateEvents",(e=>{const t=ic.ZP.instance.orderedLists[nr.lL.ServerNotice];null!=t&&t.some((t=>t.roomId===e.getRoomId()))&&this.updateServerNoticeEvents()})),(0,k.Z)(this,"onUsageLimitDismissed",(()=>{this.setState({usageLimitDismissed:!0})})),(0,k.Z)(this,"updateServerNoticeEvents",(async()=>{const e=ic.ZP.instance.orderedLists[nr.lL.ServerNotice];if(!e)return;const t=[];let i=0;for(const n of e){const e=n.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;i=e.getTs();const s=e.getContent().pinned.slice(0,2);for(const e of s){const i=await this._matrixClient.getEventTimeline(n.getUnfilteredTimelineSet(),e),s=null==i?void 0:i.getEvents().find((t=>t.getId()===e));s&&t.push(s)}}if(i&&this.state.usageLimitEventTs&&this.state.usageLimitEventTs>i)return;const n=t.find((e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type)),s=null==n?void 0:n.getContent();this.calculateServerLimitToast(this.state.syncErrorData,s),this.setState({usageLimitEventContent:s,usageLimitEventTs:i,usageLimitDismissed:!1})})),(0,k.Z)(this,"onPaste",(e=>{const t=dy(e.target);if(t!==document.activeElement)if(null!=t&&t.focus)t.focus();else{var i;const e=!(null===(i=document.activeElement)||void 0===i||!i.closest(".mx_ThreadView"));x.ZP.dispatch({action:W.a.FocusSendMessageComposer,context:e?qt.SB.Thread:qt.SB.Room},!0)}})),(0,k.Z)(this,"onReactKeyDown",(e=>{this.onKeyDown(e)})),(0,k.Z)(this,"onNativeKeyDown",(e=>{e.target===document.body&&this.onKeyDown(e)})),(0,k.Z)(this,"onKeyDown",(e=>{var t,i,n;let s=!1;switch((0,dr.zL)().getRoomAction(e)){case tn.vB.ScrollUp:case tn.vB.ScrollDown:case tn.vB.JumpToFirstMessage:case tn.vB.JumpToLatestMessage:this.onScrollKeyPressed(e),s=!0;break;case tn.vB.SearchInRoom:x.ZP.dispatch({action:"focus_search"}),s=!0}if(s)return e.stopPropagation(),void e.preventDefault();switch((0,dr.zL)().getNavigationAction(e)){case tn.vB.FilterRooms:x.ZP.dispatch({action:"focus_room_filter"}),s=!0;break;case tn.vB.ToggleUserMenu:x.ZP.fire(W.a.ToggleUserMenu),s=!0;break;case tn.vB.ShowKeyboardSettings:x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.Keyboard}),s=!0;break;case tn.vB.GoToHome:x.ZP.dispatch({action:W.a.ViewHomePage}),T.ZP.closeCurrentModal("homeKeyboardShortcut"),s=!0;break;case tn.vB.ToggleSpacePanel:x.ZP.fire(W.a.ToggleSpacePanel),s=!0;break;case tn.vB.ToggleRoomSidePanel:"room_view"===this.props.page_type&&(nm.Z.instance.togglePanel(null),s=!0);break;case tn.vB.SelectPrevRoom:x.ZP.dispatch({action:W.a.ViewRoomDelta,delta:-1,unread:!1}),s=!0;break;case tn.vB.SelectNextRoom:x.ZP.dispatch({action:W.a.ViewRoomDelta,delta:1,unread:!1}),s=!0;break;case tn.vB.SelectPrevUnreadRoom:x.ZP.dispatch({action:W.a.ViewRoomDelta,delta:-1,unread:!0});break;case tn.vB.SelectNextUnreadRoom:x.ZP.dispatch({action:W.a.ViewRoomDelta,delta:1,unread:!0});break;case tn.vB.PreviousVisitedRoomOrSpace:null===(t=a.Z.get())||void 0===t||t.navigateForwardBack(!0),s=!0;break;case tn.vB.NextVisitedRoomOrSpace:null===(i=a.Z.get())||void 0===i||i.navigateForwardBack(!1),s=!0}if(!s){switch((0,dr.zL)().getLabsAction(e)){case tn.vB.ToggleHiddenEventVisibility:{const e=L.C.getValueAt(U.R.DEVICE,"showHiddenEventsInTimeline",void 0,!1);L.C.setValue("showHiddenEventsInTimeline",null,U.R.DEVICE,!e),s=!0;break}}}if(!s&&null!==(n=a.Z.get())&&void 0!==n&&n.overrideBrowserShortcuts()&&e.code.startsWith("Digit")&&"Digit0"!==e.code&&(0,en.Hy)(e)&&(x.ZP.dispatch({action:W.a.SwitchSpace,num:parseInt(e.code.slice(5),10)}),s=!0),s)return e.stopPropagation(),void e.preventDefault();if(!(e.key===en.sr.ALT||e.key===en.sr.CONTROL||e.key===en.sr.META||e.key===en.sr.SHIFT)&&!e.ctrlKey&&!e.metaKey){const t=e.target!==document.body&&(e.key===en.sr.SPACE||e.key===en.sr.ENTER),i=1===e.key.length||"Dead"===e.key;if(!t&&i&&!dy(e.target)){var o;const t=!(null===(o=document.activeElement)||void 0===o||!o.closest(".mx_ThreadView"));x.ZP.dispatch({action:W.a.FocusSendMessageComposer,context:t?qt.SB.Thread:qt.SB.Room},!0),e.stopPropagation()}}})),(0,k.Z)(this,"onScrollKeyPressed",(e=>{var t;null===(t=this._roomView.current)||void 0===t||t.handleScrollKey(e)})),this.state={syncErrorData:void 0,useCompactLayout:L.C.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:lt.ZP.instance.getAllActiveCalls()},this._matrixClient=this.props.matrixClient,Ka.ZP.loadDevices(),(0,qa.T)(),this._roomView=o.createRef(),this._resizeContainer=o.createRef(),this.resizeHandler=o.createRef()}componentDidMount(){var e;document.addEventListener("keydown",this.onNativeKeyDown,!1),lt.ZP.instance.addListener(lt.QC.CallState,this.onCallState),this.updateServerNoticeEvents(),this._matrixClient.on(n.ClientEvent.AccountData,this.onAccountData),cy(this._matrixClient.getAccountData("m.push_rules"),this._matrixClient),this._matrixClient.on(n.ClientEvent.Sync,this.onSync),this.onSync(this._matrixClient.getSyncState(),null,null!==(e=this._matrixClient.getSyncStateData())&&void 0!==e?e:void 0),this._matrixClient.on(n.RoomStateEvent.Events,this.onRoomStateEvents),this.layoutWatcherRef=L.C.watchSetting("layout",null,this.onCompactLayoutChanged),this.compactLayoutWatcherRef=L.C.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.backgroundImageWatcherRef=L.C.watchSetting("RoomList.backgroundImage",null,this.refreshBackgroundImage),this.resizer=this.createResizer(),this.resizer.attach(),Ml.p.instance.on(Pa.a,this.refreshBackgroundImage),this.loadResizerPreferences(),this.refreshBackgroundImage()}componentWillUnmount(){var e;document.removeEventListener("keydown",this.onNativeKeyDown,!1),lt.ZP.instance.removeListener(lt.QC.CallState,this.onCallState),this._matrixClient.removeListener(n.ClientEvent.AccountData,this.onAccountData),this._matrixClient.removeListener(n.ClientEvent.Sync,this.onSync),this._matrixClient.removeListener(n.RoomStateEvent.Events,this.onRoomStateEvents),Ml.p.instance.off(Pa.a,this.refreshBackgroundImage),this.layoutWatcherRef&&L.C.unwatchSetting(this.layoutWatcherRef),this.compactLayoutWatcherRef&&L.C.unwatchSetting(this.compactLayoutWatcherRef),this.backgroundImageWatcherRef&&L.C.unwatchSetting(this.backgroundImageWatcherRef),null===(e=this.resizer)||void 0===e||e.detach()}createResizer(){var e;let t,i;const n={toggleSize:156,onCollapsed:e=>{i=e,e?(x.ZP.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):x.ZP.dispatch({action:"show_left_panel"})},onResized:e=>{t=e,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{i||window.localStorage.setItem("mx_lhs_size",""+t),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>e.classList.contains("mx_LeftPanel_minimized"),handler:null!==(e=this.resizeHandler.current)&&void 0!==e?e:void 0},s=new ir(this._resizeContainer.current,tr,n);return s.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),s}loadResizerPreferences(){var e,t;let i=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(i)&&(i=350),null===(e=this.resizer)||void 0===e||null===(t=e.forHandleWithId("lp-resizer"))||void 0===t||t.resize(i)}calculateServerLimitToast(e,t){var i;const n="M_RESOURCE_LIMIT_EXCEEDED"===(null==e||null===(i=e.error)||void 0===i?void 0:i.errcode);n&&(t=(null==e?void 0:e.error).data),t&&this.state.usageLimitDismissed?((e,t,i,n)=>{const s=(0,Io.Lv)(e,i,{monthly_active_user:(0,l.I8)("error|mau"),hs_blocked:(0,l.I8)("error|hs_blocked"),"":(0,l.I8)("error|resource_limits")}),a=(0,Io.Lv)(e,i,{"":(0,l.I8)("error|admin_contact_short")});F.Z.sharedInstance().addOrReplaceToast({key:sr,title:(0,l._t)("common|warning"),props:{description:o.createElement(o.Fragment,null,s," ",a),acceptLabel:(0,l._t)("action|ok"),onAccept:()=>{or(),t&&t()}},component:z.Z,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):or()}render(){let e;switch(this.props.page_type){case Ba.Z.RoomView:e=o.createElement(bE,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts,forceTimeline:this.props.forceTimeline});break;case Ba.Z.HomePage:e=o.createElement(jd,{justRegistered:this.props.justRegistered});break;case Ba.Z.UserView:this.props.currentUserId&&(e=o.createElement(SE,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier}))}const t=yt()({mx_MatrixChat_wrapper:!0,mx_MatrixChat_useCompactLayout:this.state.useCompactLayout}),i=yt()({mx_MatrixChat:!0,"mx_MatrixChat--with-avatar":this.state.backgroundImage}),n=this.state.activeCalls.map((e=>o.createElement(Yd,{call:e,key:e.callId})));return o.createElement(pn.ZP.Provider,{value:this._matrixClient},o.createElement("div",{onPaste:this.onPaste,onKeyDown:this.onReactKeyDown,className:t,"aria-hidden":this.props.hideToSRUsers},o.createElement(wE,null),o.createElement("div",{className:i},o.createElement("div",{className:"mx_LeftPanel_outerWrapper"},o.createElement(xE,{isMinimized:this.props.collapseLhs||!1}),o.createElement("nav",{className:"mx_LeftPanel_wrapper"},o.createElement(CE,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),o.createElement(Yl,null),o.createElement(CE,{backgroundImage:this.state.backgroundImage}),o.createElement("div",{className:"mx_LeftPanel_wrapper--user",ref:this._resizeContainer,"data-collapsed":!!this.props.collapseLhs||void 0},o.createElement(Gd,{pageType:this.props.page_type,isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier})))),o.createElement($a,{passRef:this.resizeHandler,id:"lp-resizer"}),o.createElement("div",{className:"mx_RoomView_wrapper"},e))),o.createElement(qE,null),o.createElement(qd,null),n)}}(0,k.Z)(my,"displayName","LoggedInView");const hy=my;function py(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}let uy=function(e){return e[e.Primary=0]="Primary",e[e.Cancel=1]="Cancel",e}({});const gy=({onFinished:e,analyticsOwner:t,privacyPolicyUrl:i,primaryButton:n,cancelButton:s,hasCancel:a})=>{const r=i?o.createElement("span",null,(0,l._t)("analytics|privacy_policy",{},{PrivacyPolicyUrl:e=>o.createElement(Cl.Z,{href:i,rel:"norefferer noopener",target:"_blank"},e)})):"";return o.createElement(q.Z,{className:"mx_AnalyticsLearnMoreDialog",contentId:"mx_AnalyticsLearnMore",title:(0,l._t)("analytics|enable_prompt",{analyticsOwner:t}),onFinished:e},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("div",{className:"mx_AnalyticsLearnMore_image_holder"}),o.createElement("div",{className:"mx_AnalyticsLearnMore_copy"},(0,l._t)("analytics|pseudonymous_usage_data",{analyticsOwner:t})),o.createElement("ul",{className:"mx_AnalyticsLearnMore_bullets"},o.createElement("li",null,(0,l._t)("analytics|bullet_1",{},{Bold:e=>o.createElement("b",null,e)})),o.createElement("li",null,(0,l._t)("analytics|bullet_2",{},{Bold:e=>o.createElement("b",null,e)})),o.createElement("li",null,(0,l._t)("analytics|disable_prompt"))),r),o.createElement(gt.Z,{primaryButton:n,cancelButton:s,onPrimaryButtonClick:()=>e(uy.Primary),onCancel:()=>e(uy.Cancel),hasCancel:a}))},vy=e=>{var t;const i=c.ZP.get("privacy_policy_url"),n=null!==(t=c.ZP.get("analytics_owner"))&&void 0!==t?t:c.ZP.get("brand");T.ZP.createDialog(gy,function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?py(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):py(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({privacyPolicyUrl:i,analyticsOwner:n},e),"mx_AnalyticsLearnMoreDialog_wrapper")},_y=()=>{x.ZP.dispatch({action:W.a.PseudonymousAnalyticsAccept})},fy=()=>{x.ZP.dispatch({action:W.a.PseudonymousAnalyticsReject})},Ey=()=>{vy({onFinished:e=>{e===uy.Primary&&_y()},primaryButton:(0,l._t)("action|enable")})},yy=()=>{vy({onFinished:e=>{e===uy.Primary?_y():e===uy.Cancel&&fy()},primaryButton:(0,l._t)("analytics|accept_button"),cancelButton:(0,l._t)("action|stop")})},by="analytics";const wy=()=>{var e;const t=L.C.getValue("analyticsOptIn",null,!0);let i;if(t)i={description:(0,l._t)("analytics|consent_migration"),acceptLabel:(0,l._t)("analytics|accept_button"),onAccept:_y,rejectLabel:(0,l._t)("action|learn_more"),onReject:yy};else{if(null!=t)return;{const e=e=>o.createElement(ae.Z,{kind:"link_inline",onClick:Ey},e);i={description:(0,l._t)("analytics|learn_more",{},{LearnMoreLink:e}),acceptLabel:(0,l._t)("action|yes"),onAccept:_y,rejectLabel:(0,l._t)("action|no"),onReject:fy}}}const n=null!==(e=c.ZP.get("analytics_owner"))&&void 0!==e?e:c.ZP.get().brand;F.Z.sharedInstance().addOrReplaceToast({key:by,title:(0,l._t)("analytics|enable_prompt",{analyticsOwner:n}),props:i,component:z.Z,className:"mx_AnalyticsToast",priority:10})},Sy=()=>{F.Z.sharedInstance().dismissToast(by)};var Cy=i("../matrix-react-sdk/src/components/views/elements/DialPadBackspaceButton.tsx");class ky extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"numberEntryFieldRef",(0,o.createRef)()),(0,k.Z)(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),(0,k.Z)(this,"onChange",(e=>{this.setState({value:e.target.value})})),(0,k.Z)(this,"onFormSubmit",(e=>{e.preventDefault(),this.onDialPress()})),(0,k.Z)(this,"onDigitPress",((e,t)=>{var i;(this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(i=this.numberEntryFieldRef.current)||void 0===i||i.focus())})),(0,k.Z)(this,"onDeletePress",(e=>{var t;0!==this.state.value.length&&(this.setState({value:this.state.value.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))})),(0,k.Z)(this,"onDialPress",(async()=>{lt.ZP.instance.dialNumber(this.state.value),this.props.onFinished(!0)})),this.state={value:""}}render(){const e=o.createElement(Cy.Z,{onBackspacePress:this.onDeletePress});let t;return t=0!==this.state.value.length?o.createElement(Vs.Z,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange,postfixComponent:e}):o.createElement(Vs.Z,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}),o.createElement("div",{className:"mx_DialPadModal"},o.createElement("div",null,o.createElement(ae.Z,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),o.createElement("div",{className:"mx_DialPadModal_header"},o.createElement("form",{onSubmit:this.onFormSubmit},t)),o.createElement("div",{className:"mx_DialPadModal_dialPad"},o.createElement(Lv.ZP,{hasDial:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}}const xy=()=>{window.location.href="mobile_guide/"},Ry=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",Py()},Iy="mobileguide",Py=()=>{F.Z.sharedInstance().dismissToast(Iy)};var Ty=i("../matrix-react-sdk/res/img/feather-customised/warning-triangle.svg"),Zy=i("../matrix-react-sdk/src/components/views/settings/AvatarSetting.tsx"),Ny=i("../matrix-react-sdk/src/components/views/settings/shared/SettingsSubsectionHeading.tsx");class Dy extends o.Component{constructor(e){var t,i,n;super(e),(0,k.Z)(this,"userId",void 0),(0,k.Z)(this,"avatarUpload",(0,o.createRef)()),(0,k.Z)(this,"uploadAvatar",(()=>{var e;null===(e=this.avatarUpload.current)||void 0===e||e.click()})),(0,k.Z)(this,"removeAvatar",(()=>{this.avatarUpload.current&&(this.avatarUpload.current.value=""),this.setState({avatarUrl:void 0,avatarFile:null,enableProfileSave:!0})})),(0,k.Z)(this,"cancelProfileChanges",(async e=>{var t;e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,avatarUrl:null!==(t=this.state.originalAvatarUrl)&&void 0!==t?t:void 0,avatarFile:null})})),(0,k.Z)(this,"saveProfile",(async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t={},i=this.state.displayName.trim();try{const e=E.p.safeGet();if(this.state.originalDisplayName!==this.state.displayName&&(await e.setDisplayName(i),t.originalDisplayName=i,t.displayName=i),this.state.avatarFile){var n;r.k.log(`Uploading new avatar, ${this.state.avatarFile.name} of type ${this.state.avatarFile.type}, (${this.state.avatarFile.size}) bytes`);const{content_uri:i}=await e.uploadContent(this.state.avatarFile);await e.setAvatarUrl(i),t.avatarUrl=null!==(n=(0,mn.TS)(i).getSquareThumbnailHttp(96))&&void 0!==n?n:void 0,t.originalAvatarUrl=t.avatarUrl,t.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await e.setAvatarUrl("")}catch(e){r.k.log("Failed to save profile",e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_saving_profile_title"),description:e instanceof Error?e.message:(0,l._t)("settings|general|error_saving_profile")})}this.setState(t)})),(0,k.Z)(this,"onDisplayNameChanged",(e=>{this.setState({displayName:e.target.value,enableProfileSave:!0})})),(0,k.Z)(this,"onAvatarChanged",(e=>{var t;if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:null!==(t=this.state.originalAvatarUrl)&&void 0!==t?t:void 0,avatarFile:null,enableProfileSave:!1});const i=e.target.files[0],n=new FileReader;n.onload=e=>{var t,n;this.setState({avatarUrl:null!==(t=null===(n=e.target)||void 0===n?void 0:n.result)&&void 0!==t?t:void 0,avatarFile:i,enableProfileSave:!0})},n.readAsDataURL(i)})),this.userId=E.p.safeGet().getSafeUserId();let s=Ml.p.instance.avatarMxc;s&&(s=(0,mn.TS)(s).getSquareThumbnailHttp(96)),this.state={originalDisplayName:null!==(t=Ml.p.instance.displayName)&&void 0!==t?t:"",displayName:null!==(i=Ml.p.instance.displayName)&&void 0!==i?i:"",originalAvatarUrl:s,avatarUrl:null!==(n=s)&&void 0!==n?n:void 0,avatarFile:null,enableProfileSave:!1}}render(){var e;const t=Pt.Z.getDisplayUserIdentifier(this.userId,{withDisplayName:!0}),i=null===(e=this.state.avatarUrl)||void 0===e?void 0:e.toString();return o.createElement("form",{onSubmit:this.saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings"},o.createElement("input",{type:"file",ref:this.avatarUpload,className:"mx_ProfileSettings_avatarUpload",onClick:e=>{(0,Id.k)(e),kn.Z.trackInteraction("WebProfileSettingsAvatarUploadButton",e)},onChange:this.onAvatarChanged,accept:"image/*"}),o.createElement("div",{className:"mx_ProfileSettings_profile"},o.createElement("div",{className:"mx_ProfileSettings_profile_controls"},o.createElement(Ny.I,{heading:(0,l._t)("common|profile")}),o.createElement(Vs.Z,{label:(0,l._t)("common|display_name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onDisplayNameChanged}),o.createElement("p",null,t&&o.createElement("span",{className:"mx_ProfileSettings_profile_controls_userId"},t))),o.createElement(Zy.Z,{avatarUrl:i,avatarName:this.state.displayName||this.userId,avatarAltText:(0,l._t)("common|user_avatar"),uploadAvatar:this.uploadAvatar,removeAvatar:this.removeAvatar})),o.createElement("div",{className:"mx_ProfileSettings_buttons"},o.createElement(ae.Z,{onClick:this.cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},(0,l._t)("action|cancel")),o.createElement(ae.Z,{onClick:this.saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},(0,l._t)("action|save"))))}}class My extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:"",langs:null}}componentDidMount(){if(l.ov().then((e=>{e.sort((function(e,t){return e.labelInTargetLanguage<t.labelInTargetLanguage?-1:e.labelInTargetLanguage>t.labelInTargetLanguage?1:0})),this.setState({langs:e})})).catch((()=>{this.setState({langs:[{value:"en",label:"English",labelInTargetLanguage:"English"}]})})),!this.props.value){const e=l.of();this.props.onOptionChange(e)}}render(){if(null===this.state.langs)return o.createElement(re.Z,null);let e;e=this.state.searchQuery?this.state.langs.filter((e=>function(e,t){return!!t.labelInTargetLanguage.toUpperCase().includes(e.toUpperCase())||!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.langs;const t=e.map((e=>o.createElement("div",{key:e.value},e.labelInTargetLanguage)));let i,n=L.C.getValue("language",null,!0);return n||(n=navigator.language||navigator.userLanguage),i=this.props.value||n,o.createElement(nl.Z,{id:"mx_LanguageDropdown",className:yt()("mx_LanguageDropdown",this.props.className),onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:i,label:(0,l._t)("language_dropdown_label"),disabled:this.props.disabled},t)}}class Oy extends o.Component{constructor(e){super(e),this.onSearchChange=this.onSearchChange.bind(this),this.state={searchQuery:""}}componentDidMount(){const e=a.Z.get();if(e){var t;const i=new Intl.DisplayNames([(0,l.of)()],{type:"language",style:"short"});null===(t=e.getAvailableSpellCheckLanguages())||void 0===t||t.then((e=>{e.sort((function(e,t){return e<t?-1:e>t?1:0}));const t=[];e.forEach((e=>{t.push({label:i.of(e),value:e})})),this.setState({languages:t})})).catch((e=>{this.setState({languages:[{value:"en",label:i.of("en")}]})}))}}onSearchChange(e){this.setState({searchQuery:e})}render(){if(!this.state.languages)return o.createElement(re.Z,null);let e;e=this.state.searchQuery?this.state.languages.filter((e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.languages;const t=e.map((e=>o.createElement("div",{key:e.value},e.label)));let i,n=L.C.getValue("language",null,!0);return n||(n=navigator.language||navigator.userLanguage),i=this.props.value||n,o.createElement(nl.Z,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:i,label:(0,l._t)("language_dropdown_label"),placeholder:(0,l._t)("settings|general|spell_check_locale_placeholder")},t)}}class Ay extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"onRemove",(e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language))))}render(){return o.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},o.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},this.props.language),o.createElement(ae.Z,{onClick:this.onRemove,kind:"danger_sm"},(0,l._t)("action|remove")))}}class Ly extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onRemoved",(e=>{const t=this.props.languages.filter((t=>t!==e));this.props.onLanguagesChange(t)})),(0,k.Z)(this,"onAddClick",(e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;this.setState({newLanguage:""}),t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))})),(0,k.Z)(this,"onNewLanguageChange",(e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})})),this.state={newLanguage:""}}render(){const e=this.props.languages.map((e=>o.createElement(Ay,{language:e,onRemoved:this.onRemoved,key:e}))),t=o.createElement(ae.Z,{onClick:this.onAddClick,kind:"primary"},(0,l._t)("action|add"));return o.createElement(o.Fragment,null,e,o.createElement("form",{onSubmit:this.onAddClick,noValidate:!0},o.createElement(Oy,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this.onNewLanguageChange}),t))}}var Uy=i("../matrix-react-sdk/src/components/structures/InteractiveAuth.tsx"),Fy=i("../matrix-react-sdk/src/components/views/auth/InteractiveAuthEntryComponents.tsx");class By extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onStagePhaseChange",((e,t)=>{const i={[Fy.Rt.PHASE_PREAUTH]:{body:(0,l._t)("settings|general|deactivate_confirm_body_sso"),continueText:(0,l._t)("auth|sso"),continueKind:"danger"},[Fy.Rt.PHASE_POSTAUTH]:{body:(0,l._t)("settings|general|deactivate_confirm_body"),continueText:(0,l._t)("settings|general|deactivate_confirm_continue"),continueKind:"danger"}},n={[Fy.Rt.LOGIN_TYPE]:i,[Fy.Rt.UNSTABLE_LOGIN_TYPE]:i,[Fy.th.LOGIN_TYPE]:{[Fy.AK]:{body:(0,l._t)("settings|general|deactivate_confirm_body_password")}}}[e];let s,o,a;if(n){const e=n[t];e&&(e.body&&(s=e.body),e.continueText&&(o=e.continueText),e.continueKind&&(a=e.continueKind))}this.setState({bodyText:s,continueText:o,continueKind:a})})),(0,k.Z)(this,"onUIAuthFinished",(async(e,t)=>{e||(t!==Uy.H?(r.k.error("Error during UI Auth:",{result:t}),this.setState({errStr:(0,l._t)("settings|general|error_deactivate_communication")})):this.onCancel())})),(0,k.Z)(this,"onUIAuthComplete",(e=>{E.p.safeGet().deactivateAccount(null!=e?e:void 0,this.state.shouldErase).then((e=>{x.ZP.fire(W.a.TriggerLogout),this.props.onFinished(!0)})).catch((e=>{r.k.error(e),this.setState({errStr:(0,l._t)("settings|general|error_deactivate_communication")})}))})),(0,k.Z)(this,"onEraseFieldChange",(e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)})),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0},this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){E.p.safeGet().deactivateAccount(void 0,e).then((e=>{r.k.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:(0,l._t)("settings|general|error_deactivate_no_auth")})})).catch((e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:(0,l._t)("settings|general|error_deactivate_invalid_auth")})}))}render(){let e;this.state.errStr&&(e=o.createElement("div",{className:"error"},this.state.errStr));let t=o.createElement("div",null,(0,l._t)("common|loading"));return this.state.authData&&this.state.authEnabled&&(t=o.createElement("div",null,this.state.bodyText,o.createElement(Uy.Z,{matrixClient:E.p.safeGet(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),o.createElement(q.Z,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:(0,l._t)("settings|general|deactivate_section"),screenName:"DeactivateAccount"},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("p",null,(0,l._t)("settings|general|deactivate_confirm_content")),o.createElement("ul",null,o.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_1")),o.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_2")),o.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_3")),o.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_4")),o.createElement("li",null,(0,l._t)("settings|general|deactivate_confirm_content_5"))),o.createElement("p",null,(0,l._t)("settings|general|deactivate_confirm_content_6")),o.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},o.createElement("p",null,o.createElement(qs.Z,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},(0,l._t)("settings|general|deactivate_confirm_erase_label"))),e,t)))}}var Vy=i("../matrix-react-sdk/src/Terms.ts");async function jy(e,t){const i=e.getUserId();let{threepids:s}=await e.getThreePids();if(t&&(s=s.filter((e=>e.medium===t))),s.length>0&&e.getIdentityServerUrl())try{const n=new qg.Z,o=await n.getAccessToken({check:!1});if(!o)throw new Error("No identity access token found");const a=s.map((({medium:e,address:t})=>[e,t])),r=await e.bulkLookupThreePids(a,o);for(const[e,n,o]of r.threepids){if(o!==i)continue;if(t&&e!==t)continue;const a=s.find((t=>t.medium===e&&t.address===n));a&&(a.bound=!0)}}catch(e){if(!(e instanceof n.MatrixError)||"M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return s}function zy(e){const t=e.getIdentityServerUrl(!0);if(!t)throw new l.yh("settings|general|identity_server_not_set");return t}class Wy{constructor(e){this.matrixClient=e,(0,k.Z)(this,"sessionId",void 0),(0,k.Z)(this,"submitUrl",void 0),(0,k.Z)(this,"bind",!1),(0,k.Z)(this,"clientSecret",void 0),(0,k.Z)(this,"makeAddThreepidOnlyRequest",(e=>this.matrixClient.addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:null!=e?e:void 0}))),this.clientSecret=e.generateClientSecret()}async addEmailAddress(e){try{const t=await this.matrixClient.requestAdd3pidEmailToken(e,this.clientSecret,1);return this.sessionId=t.sid,t}catch(e){if(e instanceof n.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.yh("settings|general|email_address_in_use",{cause:e});throw e}}async bindEmailAddress(e){var t;this.bind=!0;const i=new qg.Z,s=null!==(t=await i.getAccessToken())&&void 0!==t?t:void 0;try{const t=await this.matrixClient.requestEmailToken(e,this.clientSecret,1,void 0,s);return this.sessionId=t.sid,t}catch(e){if(e instanceof n.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.yh("settings|general|email_address_in_use",{cause:e});throw e}}async addMsisdn(e,t){try{const i=await this.matrixClient.requestAdd3pidMsisdnToken(e,t,this.clientSecret,1);return this.sessionId=i.sid,this.submitUrl=i.submit_url,i}catch(e){if(e instanceof n.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.yh("settings|general|msisdn_in_use",{cause:e});throw e}}async bindMsisdn(e,t){var i;this.bind=!0;const s=new qg.Z,o=null!==(i=await s.getAccessToken())&&void 0!==i?i:void 0;try{const i=await this.matrixClient.requestMsisdnToken(e,t,this.clientSecret,1,void 0,o);return this.sessionId=i.sid,i}catch(e){if(e instanceof n.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.yh("settings|general|msisdn_in_use",{cause:e});throw e}}async checkEmailLinkClicked(){try{if(this.bind){const e=new qg.Z,t=await e.getAccessToken();if(!t)throw new l.yh("settings|general|identity_server_no_token");await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:zy(this.matrixClient),id_access_token:t})}else try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(e){if(!(e instanceof n.MatrixError&&401===e.httpStatus&&e.data&&e.data.flows))throw e;const t={[Fy.Rt.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("auth|uia|sso_body"),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.Rt.PHASE_POSTAUTH]:{title:(0,l._t)("settings|general|confirm_adding_email_title"),body:(0,l._t)("settings|general|confirm_adding_email_body"),continueText:(0,l._t)("action|confirm"),continueKind:"primary"}},{finished:i}=T.ZP.createDialog(te.Z,{title:(0,l._t)("settings|general|add_email_dialog_title"),matrixClient:this.matrixClient,authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Fy.Rt.LOGIN_TYPE]:t,[Fy.Rt.UNSTABLE_LOGIN_TYPE]:t}});return i}}catch(e){if(e instanceof n.HTTPError&&401===e.httpStatus)throw new l.yh("settings|general|add_email_failed_verification",{cause:e});throw e}return[]}async haveMsisdnToken(e){const t=new qg.Z;if(this.submitUrl)await this.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind)throw new l.yh("settings|general|add_msisdn_misconfigured");await this.matrixClient.submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(this.bind)await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:zy(this.matrixClient),id_access_token:await t.getAccessToken()});else try{return void await this.makeAddThreepidOnlyRequest()}catch(e){if(!(e instanceof n.MatrixError&&401===e.httpStatus&&e.data&&e.data.flows))throw e;const t={[Fy.Rt.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("settings|general|add_msisdn_confirm_sso_button"),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.Rt.PHASE_POSTAUTH]:{title:(0,l._t)("settings|general|add_msisdn_confirm_button"),body:(0,l._t)("settings|general|add_msisdn_confirm_body"),continueText:(0,l._t)("action|confirm"),continueKind:"primary"}},{finished:i}=T.ZP.createDialog(te.Z,{title:(0,l._t)("settings|general|add_msisdn_dialog_title"),matrixClient:this.matrixClient,authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Fy.Rt.LOGIN_TYPE]:t,[Fy.Rt.UNSTABLE_LOGIN_TYPE]:t}});return i}}}const Hy=/^[0-9 -.]+$/;const Gy=127462-"A".charCodeAt(0),Ky=/^[A-Z]{2}$/,qy=[{iso2:"GB",prefix:"44"},{iso2:"US",prefix:"1"},{iso2:"AF",prefix:"93"},{iso2:"AX",prefix:"358"},{iso2:"AL",prefix:"355"},{iso2:"DZ",prefix:"213"},{iso2:"AS",prefix:"1"},{iso2:"AD",prefix:"376"},{iso2:"AO",prefix:"244"},{iso2:"AI",prefix:"1"},{iso2:"AQ",prefix:"672"},{iso2:"AG",prefix:"1"},{iso2:"AR",prefix:"54"},{iso2:"AM",prefix:"374"},{iso2:"AW",prefix:"297"},{iso2:"AU",prefix:"61"},{iso2:"AT",prefix:"43"},{iso2:"AZ",prefix:"994"},{iso2:"BS",prefix:"1"},{iso2:"BH",prefix:"973"},{iso2:"BD",prefix:"880"},{iso2:"BB",prefix:"1"},{iso2:"BY",prefix:"375"},{iso2:"BE",prefix:"32"},{iso2:"BZ",prefix:"501"},{iso2:"BJ",prefix:"229"},{iso2:"BM",prefix:"1"},{iso2:"BT",prefix:"975"},{iso2:"BO",prefix:"591"},{iso2:"BA",prefix:"387"},{iso2:"BW",prefix:"267"},{iso2:"BV",prefix:"47"},{iso2:"BR",prefix:"55"},{iso2:"IO",prefix:"246"},{iso2:"VG",prefix:"1"},{iso2:"BN",prefix:"673"},{iso2:"BG",prefix:"359"},{iso2:"BF",prefix:"226"},{iso2:"BI",prefix:"257"},{iso2:"KH",prefix:"855"},{iso2:"CM",prefix:"237"},{iso2:"CA",prefix:"1"},{iso2:"CV",prefix:"238"},{iso2:"BQ",prefix:"599"},{iso2:"KY",prefix:"1"},{iso2:"CF",prefix:"236"},{iso2:"TD",prefix:"235"},{iso2:"CL",prefix:"56"},{iso2:"CN",prefix:"86"},{iso2:"CX",prefix:"61"},{iso2:"CC",prefix:"61"},{iso2:"CO",prefix:"57"},{iso2:"KM",prefix:"269"},{iso2:"CG",prefix:"242"},{iso2:"CD",prefix:"243"},{iso2:"CK",prefix:"682"},{iso2:"CR",prefix:"506"},{iso2:"HR",prefix:"385"},{iso2:"CU",prefix:"53"},{iso2:"CW",prefix:"599"},{iso2:"CY",prefix:"357"},{iso2:"CZ",prefix:"420"},{iso2:"CI",prefix:"225"},{iso2:"DK",prefix:"45"},{iso2:"DJ",prefix:"253"},{iso2:"DM",prefix:"1"},{iso2:"DO",prefix:"1"},{iso2:"EC",prefix:"593"},{iso2:"EG",prefix:"20"},{iso2:"SV",prefix:"503"},{iso2:"GQ",prefix:"240"},{iso2:"ER",prefix:"291"},{iso2:"EE",prefix:"372"},{iso2:"ET",prefix:"251"},{iso2:"FK",prefix:"500"},{iso2:"FO",prefix:"298"},{iso2:"FJ",prefix:"679"},{iso2:"FI",prefix:"358"},{iso2:"FR",prefix:"33"},{iso2:"GF",prefix:"594"},{iso2:"PF",prefix:"689"},{iso2:"TF",prefix:"262"},{iso2:"GA",prefix:"241"},{iso2:"GM",prefix:"220"},{iso2:"GE",prefix:"995"},{iso2:"DE",prefix:"49"},{iso2:"GH",prefix:"233"},{iso2:"GI",prefix:"350"},{iso2:"GR",prefix:"30"},{iso2:"GL",prefix:"299"},{iso2:"GD",prefix:"1"},{iso2:"GP",prefix:"590"},{iso2:"GU",prefix:"1"},{iso2:"GT",prefix:"502"},{iso2:"GG",prefix:"44"},{iso2:"GN",prefix:"224"},{iso2:"GW",prefix:"245"},{iso2:"GY",prefix:"592"},{iso2:"HT",prefix:"509"},{iso2:"HM",prefix:"672"},{iso2:"HN",prefix:"504"},{iso2:"HK",prefix:"852"},{iso2:"HU",prefix:"36"},{iso2:"IS",prefix:"354"},{iso2:"IN",prefix:"91"},{iso2:"ID",prefix:"62"},{iso2:"IR",prefix:"98"},{iso2:"IQ",prefix:"964"},{iso2:"IE",prefix:"353"},{iso2:"IM",prefix:"44"},{iso2:"IL",prefix:"972"},{iso2:"IT",prefix:"39"},{iso2:"JM",prefix:"1"},{iso2:"JP",prefix:"81"},{iso2:"JE",prefix:"44"},{iso2:"JO",prefix:"962"},{iso2:"KZ",prefix:"7"},{iso2:"KE",prefix:"254"},{iso2:"KI",prefix:"686"},{iso2:"XK",prefix:"383"},{iso2:"KW",prefix:"965"},{iso2:"KG",prefix:"996"},{iso2:"LA",prefix:"856"},{iso2:"LV",prefix:"371"},{iso2:"LB",prefix:"961"},{iso2:"LS",prefix:"266"},{iso2:"LR",prefix:"231"},{iso2:"LY",prefix:"218"},{iso2:"LI",prefix:"423"},{iso2:"LT",prefix:"370"},{iso2:"LU",prefix:"352"},{iso2:"MO",prefix:"853"},{iso2:"MK",prefix:"389"},{iso2:"MG",prefix:"261"},{iso2:"MW",prefix:"265"},{iso2:"MY",prefix:"60"},{iso2:"MV",prefix:"960"},{iso2:"ML",prefix:"223"},{iso2:"MT",prefix:"356"},{iso2:"MH",prefix:"692"},{iso2:"MQ",prefix:"596"},{iso2:"MR",prefix:"222"},{iso2:"MU",prefix:"230"},{iso2:"YT",prefix:"262"},{iso2:"MX",prefix:"52"},{iso2:"FM",prefix:"691"},{iso2:"MD",prefix:"373"},{iso2:"MC",prefix:"377"},{iso2:"MN",prefix:"976"},{iso2:"ME",prefix:"382"},{iso2:"MS",prefix:"1"},{iso2:"MA",prefix:"212"},{iso2:"MZ",prefix:"258"},{iso2:"MM",prefix:"95"},{iso2:"NA",prefix:"264"},{iso2:"NR",prefix:"674"},{iso2:"NP",prefix:"977"},{iso2:"NL",prefix:"31"},{iso2:"NC",prefix:"687"},{iso2:"NZ",prefix:"64"},{iso2:"NI",prefix:"505"},{iso2:"NE",prefix:"227"},{iso2:"NG",prefix:"234"},{iso2:"NU",prefix:"683"},{iso2:"NF",prefix:"672"},{iso2:"KP",prefix:"850"},{iso2:"MP",prefix:"1"},{iso2:"NO",prefix:"47"},{iso2:"OM",prefix:"968"},{iso2:"PK",prefix:"92"},{iso2:"PW",prefix:"680"},{iso2:"PS",prefix:"970"},{iso2:"PA",prefix:"507"},{iso2:"PG",prefix:"675"},{iso2:"PY",prefix:"595"},{iso2:"PE",prefix:"51"},{iso2:"PH",prefix:"63"},{iso2:"PN",prefix:"870"},{iso2:"PL",prefix:"48"},{iso2:"PT",prefix:"351"},{iso2:"PR",prefix:"1"},{iso2:"QA",prefix:"974"},{iso2:"RO",prefix:"40"},{iso2:"RU",prefix:"7"},{iso2:"RW",prefix:"250"},{iso2:"RE",prefix:"262"},{iso2:"WS",prefix:"685"},{iso2:"SM",prefix:"378"},{iso2:"SA",prefix:"966"},{iso2:"SN",prefix:"221"},{iso2:"RS",prefix:"381 p"},{iso2:"SC",prefix:"248"},{iso2:"SL",prefix:"232"},{iso2:"SG",prefix:"65"},{iso2:"SX",prefix:"1"},{iso2:"SK",prefix:"421"},{iso2:"SI",prefix:"386"},{iso2:"SB",prefix:"677"},{iso2:"SO",prefix:"252"},{iso2:"ZA",prefix:"27"},{iso2:"GS",prefix:"500"},{iso2:"KR",prefix:"82"},{iso2:"SS",prefix:"211"},{iso2:"ES",prefix:"34"},{iso2:"LK",prefix:"94"},{iso2:"BL",prefix:"590"},{iso2:"SH",prefix:"290 n"},{iso2:"KN",prefix:"1"},{iso2:"LC",prefix:"1"},{iso2:"MF",prefix:"590"},{iso2:"PM",prefix:"508"},{iso2:"VC",prefix:"1"},{iso2:"SD",prefix:"249"},{iso2:"SR",prefix:"597"},{iso2:"SJ",prefix:"47"},{iso2:"SZ",prefix:"268"},{iso2:"SE",prefix:"46"},{iso2:"CH",prefix:"41"},{iso2:"SY",prefix:"963"},{iso2:"ST",prefix:"239"},{iso2:"TW",prefix:"886"},{iso2:"TJ",prefix:"992"},{iso2:"TZ",prefix:"255"},{iso2:"TH",prefix:"66"},{iso2:"TL",prefix:"670"},{iso2:"TG",prefix:"228"},{iso2:"TK",prefix:"690"},{iso2:"TO",prefix:"676"},{iso2:"TT",prefix:"1"},{iso2:"TN",prefix:"216"},{iso2:"TR",prefix:"90"},{iso2:"TM",prefix:"993"},{iso2:"TC",prefix:"1"},{iso2:"TV",prefix:"688"},{iso2:"VI",prefix:"1"},{iso2:"UG",prefix:"256"},{iso2:"UA",prefix:"380"},{iso2:"AE",prefix:"971"},{iso2:"UY",prefix:"598"},{iso2:"UZ",prefix:"998"},{iso2:"VU",prefix:"678"},{iso2:"VA",prefix:"39"},{iso2:"VE",prefix:"58"},{iso2:"VN",prefix:"84"},{iso2:"WF",prefix:"681"},{iso2:"EH",prefix:"212"},{iso2:"YE",prefix:"967"},{iso2:"ZM",prefix:"260"},{iso2:"ZW",prefix:"263"}];function $y(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class Jy extends o.Component{constructor(e){var t;super(e),(0,k.Z)(this,"defaultCountry",void 0),(0,k.Z)(this,"countries",void 0),(0,k.Z)(this,"countryMap",void 0),(0,k.Z)(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),(0,k.Z)(this,"onOptionChange",(e=>{this.props.onOptionChange(this.countryMap.get(e))})),(0,k.Z)(this,"getShortOption",(e=>{if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+this.countryMap.get(e).prefix),o.createElement("span",{className:"mx_CountryDropdown_shortOption"},this.flagImgForIso2(e),t)}));const i=new Intl.DisplayNames([(0,l.of)()],{type:"region"});let n;this.countries=qy.map((e=>{var t;return function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?$y(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):$y(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({name:null!==(t=i.of(e.iso2))&&void 0!==t?t:e.iso2},e)})),this.countryMap=new Map(this.countries.map((e=>[e.iso2,e])));const s=c.ZP.get("default_country_code");if(s){const e=this.countries.find((e=>e.iso2===s.toUpperCase()));e&&(n=e)}if(!n)try{var a,r,d;const e=new Intl.Locale(null!==(a=navigator.language)&&void 0!==a?a:navigator.languages[0]),t=null!==(r=null!==(d=e.region)&&void 0!==d?d:e.language)&&void 0!==r?r:e.baseName,s=i.of(t).toUpperCase();n=this.countries.find((e=>e.iso2===t.toUpperCase()||e.name.toUpperCase()===s))}catch(e){console.warn("Failed to detect default locale",e)}this.defaultCountry=null!==(t=n)&&void 0!==t?t:this.countries[0],this.state={searchQuery:""}}componentDidMount(){this.props.value||this.props.onOptionChange(this.defaultCountry)}flagImgForIso2(e){return o.createElement("div",{className:"mx_Dropdown_option_emoji"},(t=e,Ky.test(t)?String.fromCodePoint(...t.split("").map((e=>Gy+e.charCodeAt(0)))):""));var t}render(){let e;if(this.state.searchQuery){if(e=this.countries.filter((e=>function(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e)}(this.state.searchQuery,e))),2==this.state.searchQuery.length&&this.countryMap.has(this.state.searchQuery.toUpperCase())){const t=this.countryMap.get(this.state.searchQuery.toUpperCase());e=e.filter((e=>e.iso2!=t.iso2)),e.unshift(t)}}else e=this.countries;const t=e.map((e=>o.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this.flagImgForIso2(e.iso2),e.name," (+",e.prefix,")"))),i=this.props.value||this.defaultCountry.iso2;return o.createElement(nl.Z,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this.onOptionChange,onSearchChange:this.onSearchChange,menuWidth:298,getShortOption:this.getShortOption,value:i,searchEnabled:!0,disabled:this.props.disabled,label:(0,l._t)("auth|country_dropdown"),autoComplete:"tel-country-code"},t)}}class Yy extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})})),(0,k.Z)(this,"onDontRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})})),(0,k.Z)(this,"onActuallyRemove",(e=>{e.stopPropagation(),e.preventDefault(),E.p.safeGet().deleteThreePid(this.props.msisdn.medium,this.props.msisdn.address).then((()=>this.props.onRemoved(this.props.msisdn))).catch((e=>{r.k.error("Unable to remove contact information: "+e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_remove_3pid"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))})}))})),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.createElement("div",{className:"mx_GeneralUserSettingsTab_section--discovery_existing"},o.createElement("span",{className:"mx_GeneralUserSettingsTab_section--discovery_existing_promptText"},(0,l._t)("settings|general|remove_msisdn_prompt",{phone:this.props.msisdn.address})),o.createElement(ae.Z,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_GeneralUserSettingsTab_section--discovery_existing_button"},(0,l._t)("action|remove")),o.createElement(ae.Z,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_GeneralUserSettingsTab_section--discovery_existing_button"},(0,l._t)("action|cancel"))):o.createElement("div",{className:"mx_GeneralUserSettingsTab_section--discovery_existing"},o.createElement("span",{className:"mx_GeneralUserSettingsTab_section--discovery_existing_address"},"+",this.props.msisdn.address),o.createElement(ae.Z,{onClick:this.onRemove,kind:"danger_sm",disabled:this.props.disabled},(0,l._t)("action|remove")))}}class Qy extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onRemoved",(e=>{const t=this.props.msisdns.filter((t=>t!==e));this.props.onMsisdnsChange(t)})),(0,k.Z)(this,"onChangeNewPhoneNumber",(e=>{this.setState({newPhoneNumber:e.target.value})})),(0,k.Z)(this,"onChangeNewPhoneNumberCode",(e=>{this.setState({newPhoneNumberCode:e.target.value})})),(0,k.Z)(this,"onAddClick",(e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newPhoneNumber)return;const t=this.state.newPhoneNumber,i=this.state.phoneCountry,n=new Wy(E.p.safeGet());this.setState({verifying:!0,continueDisabled:!0,addTask:n}),n.addMsisdn(i,t).then((e=>{this.setState({continueDisabled:!1,verifyMsisdn:e.msisdn})})).catch((e=>{r.k.error("Unable to add phone number "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),T.ZP.createDialog(dt.Z,{title:(0,l._t)("common|error"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))})}))})),(0,k.Z)(this,"onContinueClick",(e=>{var t;e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const i=this.state.newPhoneNumberCode,s=this.state.verifyMsisdn;null===(t=this.state.addTask)||void 0===t||t.haveMsisdnToken(i).then((([e]=[])=>{let t=this.state.newPhoneNumber;if(!1!==e){const e=[...this.props.msisdns,{address:s,medium:n.ThreepidMedium.Phone}];this.props.onMsisdnsChange(e),t=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyMsisdn:"",verifyError:null,newPhoneNumber:t,newPhoneNumberCode:""})})).catch((e=>{r.k.error("Unable to verify phone number: "+e),this.setState({continueDisabled:!1});let t=e;e instanceof l.yh&&(t=e.cause),"M_THREEPID_AUTH_FAILED"!==t.errcode?T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_msisdn_verification"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))}):this.setState({verifyError:(0,l._t)("settings|general|incorrect_msisdn_verification")})}))})),(0,k.Z)(this,"onCountryChanged",(e=>{this.setState({phoneCountry:e.iso2})})),this.state={verifying:!1,verifyError:null,verifyMsisdn:"",addTask:null,continueDisabled:!1,phoneCountry:"",newPhoneNumber:"",newPhoneNumberCode:""}}render(){const e=this.props.msisdns.map((e=>o.createElement(Yy,{msisdn:e,onRemoved:this.onRemoved,key:e.address,disabled:this.props.disabled})));let t=o.createElement(ae.Z,{onClick:this.onAddClick,kind:"primary",disabled:this.props.disabled},(0,l._t)("action|add"));if(this.state.verifying){const e=this.state.verifyMsisdn;t=o.createElement("div",null,o.createElement("div",null,(0,l._t)("settings|general|add_msisdn_instructions",{msisdn:e}),o.createElement("br",null),this.state.verifyError),o.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},o.createElement(Vs.Z,{type:"text",label:(0,l._t)("settings|general|msisdn_verification_field_label"),autoComplete:"off",disabled:this.props.disabled||this.state.continueDisabled,value:this.state.newPhoneNumberCode,onChange:this.onChangeNewPhoneNumberCode}),o.createElement(ae.Z,{onClick:this.onContinueClick,kind:"primary",disabled:this.props.disabled||this.state.continueDisabled||0===this.state.newPhoneNumberCode.length},(0,l._t)("action|continue"))))}const i=o.createElement(Jy,{onOptionChange:this.onCountryChanged,className:"mx_PhoneNumbers_country",value:this.state.phoneCountry,disabled:this.state.verifying,isSmall:!0,showPrefix:!0});return o.createElement(o.Fragment,null,e,o.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0,className:"mx_PhoneNumbers_new"},o.createElement("div",{className:"mx_PhoneNumbers_input"},o.createElement(Vs.Z,{type:"text",label:(0,l._t)("settings|general|msisdn_label"),autoComplete:"tel-national",disabled:this.props.disabled||this.state.verifying,prefixComponent:i,value:this.state.newPhoneNumber,onChange:this.onChangeNewPhoneNumber}))),t)}}class Xy extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})})),(0,k.Z)(this,"onDontRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})})),(0,k.Z)(this,"onActuallyRemove",(e=>{e.stopPropagation(),e.preventDefault(),E.p.safeGet().deleteThreePid(this.props.email.medium,this.props.email.address).then((()=>this.props.onRemoved(this.props.email))).catch((e=>{r.k.error("Unable to remove contact information: "+e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_remove_3pid"),description:e&&e.message?e.message:(0,l._t)("invite|failed_generic")})}))})),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.createElement("div",{className:"mx_GeneralUserSettingsTab_section--discovery_existing"},o.createElement("span",{className:"mx_GeneralUserSettingsTab_section--discovery_existing_promptText"},(0,l._t)("settings|general|remove_email_prompt",{email:this.props.email.address})),o.createElement(ae.Z,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_GeneralUserSettingsTab_section--discovery_existing_button"},(0,l._t)("action|remove")),o.createElement(ae.Z,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_GeneralUserSettingsTab_section--discovery_existing_button"},(0,l._t)("action|cancel"))):o.createElement("div",{className:"mx_GeneralUserSettingsTab_section--discovery_existing"},o.createElement("span",{className:"mx_GeneralUserSettingsTab_section--discovery_existing_address"},this.props.email.address),o.createElement(ae.Z,{onClick:this.onRemove,kind:"danger_sm",disabled:this.props.disabled},(0,l._t)("action|remove")))}}class eb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onRemoved",(e=>{const t=this.props.emails.filter((t=>t!==e));this.props.onEmailsChange(t)})),(0,k.Z)(this,"onChangeNewEmailAddress",(e=>{this.setState({newEmailAddress:e.target.value})})),(0,k.Z)(this,"onAddClick",(e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newEmailAddress)return;const t=this.state.newEmailAddress;if(!gf.s(t))return void T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_invalid_email"),description:(0,l._t)("settings|general|error_invalid_email_detail")});const i=new Wy(E.p.safeGet());this.setState({verifying:!0,continueDisabled:!0,addTask:i}),i.addEmailAddress(t).then((()=>{this.setState({continueDisabled:!1})})).catch((e=>{r.k.error("Unable to add email address "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_add_email"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))})}))})),(0,k.Z)(this,"onContinueClick",(e=>{var t;e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0}),null===(t=this.state.addTask)||void 0===t||t.checkEmailLinkClicked().then((([e])=>{let t=this.state.newEmailAddress;if(e){const e=this.state.newEmailAddress,i=[...this.props.emails,{address:e,medium:n.ThreepidMedium.Email}];this.props.onEmailsChange(i),t=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,newEmailAddress:t})})).catch((e=>{r.k.error("Unable to verify email address: ",e),this.setState({continueDisabled:!1});let t=e;e instanceof l.yh&&(t=e.cause),t instanceof n.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode?T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|email_not_verified"),description:(0,l._t)("settings|general|email_verification_instructions")}):T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_email_verification"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))})}))})),this.state={verifying:!1,addTask:null,continueDisabled:!1,newEmailAddress:""}}render(){const e=this.props.emails.map((e=>o.createElement(Xy,{email:e,onRemoved:this.onRemoved,key:e.address,disabled:this.props.disabled})));let t=o.createElement(ae.Z,{onClick:this.onAddClick,kind:"primary",disabled:this.props.disabled},(0,l._t)("action|add"));return this.state.verifying&&(t=o.createElement("div",null,o.createElement("div",null,(0,l._t)("settings|general|add_email_instructions")),o.createElement(ae.Z,{onClick:this.onContinueClick,kind:"primary",disabled:this.state.continueDisabled},(0,l._t)("action|continue")))),o.createElement(o.Fragment,null,e,o.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0},o.createElement(Vs.Z,{type:"text",label:(0,l._t)("settings|general|email_address_label"),autoComplete:"email",disabled:this.props.disabled||this.state.verifying,value:this.state.newEmailAddress,onChange:this.onChangeNewEmailAddress}),t))}}class tb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onRevokeClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:(0,l._t)("settings|general|error_revoke_email_discovery")})})),(0,k.Z)(this,"onShareClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:(0,l._t)("settings|general|error_share_email_discovery")})})),(0,k.Z)(this,"onContinueClick",(async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});try{var t;await(null===(t=this.state.addTask)||void 0===t?void 0:t.checkEmailLinkClicked()),this.setState({addTask:null,verifying:!1})}catch(e){r.k.error("Unable to verify email address:",e);let t=e;e instanceof l.yh&&(t=e.cause),t instanceof n.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode?T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|email_not_verified"),description:(0,l._t)("settings|general|email_verification_instructions")}):(r.k.error("Unable to verify email address: "+e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_email_verification"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))}))}finally{this.setState({continueDisabled:!1})}}));const{bound:t}=e.email;this.state={verifying:!1,addTask:null,continueDisabled:!1,bound:t}}componentDidUpdate(e){if(this.props.email!==e.email){const{bound:e}=this.props.email;this.setState({bound:e})}}async changeBinding({bind:e,label:t,errorTitle:i}){const{medium:n,address:s}=this.props.email;try{if(e){const e=new Wy(E.p.safeGet());this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindEmailAddress(s),this.setState({continueDisabled:!1})}else await E.p.safeGet().unbindThreePid(n,s);this.setState({bound:e})}catch(e){r.k.error(`changeBinding: Unable to ${t} email address ${s}`,e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),T.ZP.createDialog(dt.Z,{title:i,description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))})}}render(){const{address:e}=this.props.email,{verifying:t,bound:i}=this.state;let n;return n=t?o.createElement("span",null,(0,l._t)("settings|general|discovery_email_verification_instructions"),o.createElement(ae.Z,{className:"mx_GeneralUserSettingsTab_section--discovery_existing_button",kind:"primary_sm",onClick:this.onContinueClick,disabled:this.state.continueDisabled},(0,l._t)("action|complete"))):i?o.createElement(ae.Z,{className:"mx_GeneralUserSettingsTab_section--discovery_existing_button",kind:"danger_sm",onClick:this.onRevokeClick,disabled:this.props.disabled},(0,l._t)("action|revoke")):o.createElement(ae.Z,{className:"mx_GeneralUserSettingsTab_section--discovery_existing_button",kind:"primary_sm",onClick:this.onShareClick,disabled:this.props.disabled},(0,l._t)("action|share")),o.createElement("div",{className:"mx_GeneralUserSettingsTab_section--discovery_existing"},o.createElement("span",{className:"mx_GeneralUserSettingsTab_section--discovery_existing_address"},e),n)}}class ib extends o.Component{render(){let e;this.props.isLoading?e=o.createElement(_r.Z,null):this.props.emails.length>0&&(e=this.props.emails.map((e=>o.createElement(tb,{email:e,key:e.address,disabled:this.props.disabled}))));const t=!!this.props.emails.length;return o.createElement(Xs.ZP,{heading:(0,l._t)("settings|general|emails_heading"),description:!t&&(0,l._t)("settings|general|discovery_email_empty")||void 0,stretchContent:!0},e)}}class nb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onRevokeClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:(0,l._t)("settings|general|error_revoke_msisdn_discovery")})})),(0,k.Z)(this,"onShareClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:(0,l._t)("settings|general|error_share_msisdn_discovery")})})),(0,k.Z)(this,"onVerificationCodeChange",(e=>{this.setState({verificationCode:e.target.value})})),(0,k.Z)(this,"onContinueClick",(async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.verificationCode;try{var i;await(null===(i=this.state.addTask)||void 0===i?void 0:i.haveMsisdnToken(t)),this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyError:null,verificationCode:""})}catch(e){r.k.error("Unable to verify phone number:",e);let t=e;e instanceof l.yh&&(t=e.cause),this.setState({continueDisabled:!1}),t instanceof n.MatrixError&&"M_THREEPID_AUTH_FAILED"!==t.errcode?T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_msisdn_verification"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))}):this.setState({verifyError:(0,l._t)("settings|general|incorrect_msisdn_verification")})}}));const{bound:t}=e.msisdn;this.state={verifying:!1,verificationCode:"",addTask:null,continueDisabled:!1,bound:t,verifyError:null}}componentDidUpdate(e){if(this.props.msisdn!==e.msisdn){const{bound:e}=this.props.msisdn;this.setState({bound:e})}}async changeBinding({bind:e,label:t,errorTitle:i}){const{medium:n,address:s}=this.props.msisdn;try{if(e){const e=new Wy(E.p.safeGet());this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindMsisdn(null,`+${s}`),this.setState({continueDisabled:!1})}else await E.p.safeGet().unbindThreePid(n,s);this.setState({bound:e})}catch(e){r.k.error(`changeBinding: Unable to ${t} phone number ${s}`,e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),T.ZP.createDialog(dt.Z,{title:i,description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))})}}render(){const{address:e}=this.props.msisdn,{verifying:t,bound:i}=this.state;let n;return n=t?o.createElement("span",{className:"mx_GeneralUserSettingsTab_section--discovery_existing_verification"},o.createElement("span",null,(0,l._t)("settings|general|msisdn_verification_instructions"),o.createElement("br",null),this.state.verifyError),o.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},o.createElement(Vs.Z,{type:"text",label:(0,l._t)("settings|general|msisdn_verification_field_label"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.verificationCode,onChange:this.onVerificationCodeChange}))):i?o.createElement(ae.Z,{className:"mx_GeneralUserSettingsTab_section--discovery_existing_button",kind:"danger_sm",onClick:this.onRevokeClick,disabled:this.props.disabled},(0,l._t)("action|revoke")):o.createElement(ae.Z,{className:"mx_GeneralUserSettingsTab_section--discovery_existing_button",kind:"primary_sm",onClick:this.onShareClick,disabled:this.props.disabled},(0,l._t)("action|share")),o.createElement("div",{className:"mx_GeneralUserSettingsTab_section--discovery_existing"},o.createElement("span",{className:"mx_GeneralUserSettingsTab_section--discovery_existing_address"},"+",e),n)}}class sb extends o.Component{render(){let e;this.props.isLoading?e=o.createElement(_r.Z,null):this.props.msisdns.length>0&&(e=this.props.msisdns.map((e=>o.createElement(nb,{msisdn:e,key:e.address,disabled:this.props.disabled}))));const t=!e&&(0,l._t)("settings|general|discovery_msisdn_empty")||void 0;return o.createElement(Xs.ZP,{"data-testid":"mx_DiscoveryPhoneNumbers",heading:(0,l._t)("settings|general|msisdns_heading"),description:t,stretchContent:!0},e)}}var ob=i("../matrix-react-sdk/src/components/views/auth/PassphraseField.tsx");class ab extends o.PureComponent{constructor(...e){super(...e),(0,k.Z)(this,"validate",(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)(this.props.labelRequired)},{key:"email",test:({value:e})=>!e||gf.s(e),invalid:()=>(0,l._t)(this.props.labelInvalid)}]})),(0,k.Z)(this,"onValidate",(async e=>{let t=this.validate;this.props.validationRules&&(t=this.props.validationRules);const i=await t(e);return this.props.onValidate&&this.props.onValidate(i),i}))}render(){return o.createElement(Vs.Z,{id:this.props.id,ref:this.props.fieldRef,type:"text",label:(0,l._t)(this.props.label),value:this.props.value,autoFocus:this.props.autoFocus,onChange:this.props.onChange,onValidate:this.onValidate})}}(0,k.Z)(ab,"defaultProps",{label:(0,l.I8)("auth|email_field_label"),labelRequired:(0,l.I8)("auth|email_field_label_required"),labelInvalid:(0,l.I8)("auth|email_field_label_invalid")});const rb=ab,lb=({onFinished:e})=>{const[t,i]=(0,o.useState)(""),n=(0,o.useRef)(null),s=async i=>{if(i.preventDefault(),n.current){if(t){if(!await n.current.validate({}))return n.current.focus(),void n.current.validate({focused:!0})}e(!0,t)}};return o.createElement(q.Z,{title:(0,l._t)("auth|registration|continue_without_email_title"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>e(!1),fixedWidth:!1},o.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},o.createElement("p",null,(0,l._t)("auth|registration|continue_without_email_description",{},{b:e=>o.createElement("b",null,e)})),o.createElement("form",{onSubmit:s},o.createElement(rb,{fieldRef:n,autoFocus:!0,label:(0,l.I8)("auth|registration|continue_without_email_field_label"),value:t,onChange:e=>{const t=e.target;i(t.value)}}))),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|continue"),onPrimaryButtonClick:s,hasCancel:!1}))};var cb=i("../matrix-react-sdk/src/components/views/auth/PassphraseConfirmField.tsx");let db,mb,hb,pb,ub;var gb=function(e){return e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm",e}(gb||{}),vb=function(e){return e[e.Unknown=0]="Unknown",e[e.Available=1]="Available",e[e.Unavailable=2]="Unavailable",e[e.Error=3]="Error",e[e.Invalid=4]="Invalid",e}(vb||{});db=gb.Email,mb=gb.Password,hb=gb.PasswordConfirm,pb=gb.Username,ub=gb.PhoneNumber;class _b extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,db,null),(0,k.Z)(this,mb,null),(0,k.Z)(this,hb,null),(0,k.Z)(this,pb,null),(0,k.Z)(this,ub,null),(0,k.Z)(this,"onSubmit",(async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);T.ZP.createDialog(lb,{onFinished:async(t,i)=>{t&&void 0!==i&&this.setState({email:i},(()=>{this.doSubmit(e)}))}})}else this.doSubmit(e)})),(0,k.Z)(this,"onEmailChange",(e=>{this.setState({email:e.target.value.trim()})})),(0,k.Z)(this,"onEmailValidate",(e=>{this.markFieldValid(gb.Email,!!e.valid)})),(0,k.Z)(this,"validateEmailRules",(0,Nh.Z)({description:()=>(0,l._t)("auth|reset_password_email_field_description"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.email.identity")||!!e},invalid:()=>(0,l._t)("auth|reset_password_email_field_required_invalid")},{key:"email",test:({value:e})=>!e||gf.s(e),invalid:()=>(0,l._t)("auth|email_field_label_invalid")}]})),(0,k.Z)(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),(0,k.Z)(this,"onPasswordValidate",(e=>{this.markFieldValid(gb.Password,!!e.valid)})),(0,k.Z)(this,"onPasswordConfirmChange",(e=>{this.setState({passwordConfirm:e.target.value})})),(0,k.Z)(this,"onPasswordConfirmValidate",(e=>{this.markFieldValid(gb.PasswordConfirm,!!e.valid)})),(0,k.Z)(this,"onPhoneCountryChange",(e=>{this.setState({phoneCountry:e.iso2})})),(0,k.Z)(this,"onPhoneNumberChange",(e=>{this.setState({phoneNumber:e.target.value})})),(0,k.Z)(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(gb.PhoneNumber,!!t.valid),t})),(0,k.Z)(this,"validatePhoneNumberRules",(0,Nh.Z)({description:()=>(0,l._t)("auth|msisdn_field_description"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.msisdn")||!!e},invalid:()=>(0,l._t)("auth|registration_msisdn_field_required_invalid")},{key:"email",test:({value:e})=>{return!e||(t=e,Hy.test(t));var t},invalid:()=>(0,l._t)("auth|msisdn_field_number_invalid")}]})),(0,k.Z)(this,"onUsernameChange",(e=>{this.setState({username:e.target.value})})),(0,k.Z)(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(gb.Username,!!t.valid),t})),(0,k.Z)(this,"validateUsernameRules",(0,Nh.Z)({description:(e,t)=>t.every((({key:e,valid:t})=>"available"===e||t))?null:(0,l._t)("auth|registration_username_validation"),hideDescriptionIfValid:!0,async deriveData({value:e}){if(!e)return vb.Unknown;try{return await this.props.matrixClient.isUsernameAvailable(e)?vb.Available:vb.Unavailable}catch(e){return e instanceof n.MatrixError&&"M_INVALID_USERNAME"===e.errcode?vb.Invalid:vb.Error}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|username_field_required_invalid")},{key:"safeLocalpart",test:({value:e},t)=>(!e||ja.test(e))&&t!==vb.Invalid,invalid:()=>(0,l._t)("room_settings|general|alias_field_safe_localpart_invalid")},{key:"available",final:!0,test:async({value:e},t)=>!e||t===vb.Available,invalid:e=>e===vb.Error?(0,l._t)("auth|registration_username_unable_check"):(0,l._t)("auth|registration_username_in_use")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||""}}doSubmit(e){rt.S.instance.setAuthenticationType("Password");const t=this.state.email.trim(),i=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});i&&(e.target.disabled=!0,i.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[gb.Username,gb.Password,gb.PasswordConfirm,gb.Email,gb.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const i=this.findFirstInvalidField(t);return!i||(i.focus(),i.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:i}=this.state;i[e]=t,this.setState({fieldValid:i})}authStepIsRequired(e){return this.props.flows.every((t=>t.stages.includes(e)))}authStepIsUsed(e){return this.props.flows.some((t=>t.stages.includes(e)))}showEmail(){return!(c.ZP.get().disable_3pid_login||!this.authStepIsUsed("m.login.email.identity"))}showPhoneNumber(){return!(c.ZP.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?(0,l.I8)("auth|email_field_label"):(0,l.I8)("auth|registration|continue_without_email_field_label");return o.createElement(rb,{fieldRef:e=>this[gb.Email]=e,label:e,value:this.state.email,validationRules:this.validateEmailRules.bind(this),onChange:this.onEmailChange,onValidate:this.onEmailValidate})}renderPassword(){return o.createElement(ob.Z,{id:"mx_RegistrationForm_password",fieldRef:e=>this[gb.Password]=e,minScore:3,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate,userInputs:[this.state.username]})}renderPasswordConfirm(){return o.createElement(cb.Z,{id:"mx_RegistrationForm_passwordConfirm",fieldRef:e=>this[gb.PasswordConfirm]=e,autoComplete:"new-password",value:this.state.passwordConfirm,password:this.state.password,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=this.authStepIsRequired("m.login.msisdn")?(0,l._t)("auth|phone_label"):(0,l._t)("auth|phone_optional_label"),t=o.createElement(Jy,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return o.createElement(Vs.Z,{ref:e=>this[gb.PhoneNumber]=e,type:"text",label:e,value:this.state.phoneNumber,prefixComponent:t,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return o.createElement(Vs.Z,{id:"mx_RegistrationForm_username",ref:e=>this[gb.Username]=e,type:"text",autoFocus:!0,label:(0,l._t)("common|username"),placeholder:(0,l._t)("common|username").toLocaleLowerCase(),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate})}render(){const e=o.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,l._t)("action|register"),disabled:!this.props.canSubmit});let t;return this.showEmail()&&(t=this.showPhoneNumber()?o.createElement("div",null,(0,l._t)("auth|email_help_text")," ",(0,l._t)("auth|email_phone_discovery_text")):o.createElement("div",null,(0,l._t)("auth|email_help_text")," ",(0,l._t)("auth|email_discovery_text"))),o.createElement("div",null,o.createElement("form",{onSubmit:this.onSubmit},o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),t,e))}}(0,k.Z)(_b,"defaultProps",{onValidationChange:r.k.error,canSubmit:!0});var fb=function(e){return e.Display="display",e.Edit="edit",e}(fb||{});class Eb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"value",""),(0,k.Z)(this,"placeholder",!1),(0,k.Z)(this,"editableDiv",(0,o.createRef)()),(0,k.Z)(this,"showPlaceholder",(e=>{this.editableDiv.current&&(e?(this.editableDiv.current.textContent=this.props.placeholder,this.editableDiv.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this.editableDiv.current.textContent=this.value,this.editableDiv.current.setAttribute("class",this.props.className),this.placeholder=!1))})),(0,k.Z)(this,"cancelEdit",(()=>{var e;this.setState({phase:fb.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),null===(e=this.editableDiv.current)||void 0===e||e.blur()})),(0,k.Z)(this,"onValueChanged",(e=>{var t,i;null===(t=(i=this.props).onValueChanged)||void 0===t||t.call(i,this.value,e)})),(0,k.Z)(this,"onKeyDown",(e=>{this.placeholder&&this.showPlaceholder(!1);if((0,dr.zL)().getAccessibilityAction(e)===tn.vB.Enter)e.stopPropagation(),e.preventDefault()})),(0,k.Z)(this,"onKeyUp",(e=>{if(e.target.textContent){if(!this.placeholder){var t;this.value=null!==(t=e.target.textContent)&&void 0!==t?t:""}}else this.showPlaceholder(!0);switch((0,dr.zL)().getAccessibilityAction(e)){case tn.vB.Escape:this.cancelEdit();break;case tn.vB.Enter:this.onFinish(e)}})),(0,k.Z)(this,"onClickDiv",(()=>{this.props.editable&&this.setState({phase:fb.Edit})})),(0,k.Z)(this,"onFocus",(e=>{const t=e.target.childNodes[0];if(t){const i=document.createRange();i.setStart(t,0),i.setEnd(t,e.target.childNodes.length);const n=window.getSelection();n.removeAllRanges(),n.addRange(i)}})),(0,k.Z)(this,"onFinish",((e,t=!1)=>{const i=this,n=(0,dr.zL)().getAccessibilityAction(e)===tn.vB.Enter||t;this.setState({phase:fb.Display},(()=>{this.value!==this.props.initialValue&&i.onValueChanged(n)}))})),(0,k.Z)(this,"onBlur",(e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)})),this.state={phase:fb.Display}}componentDidUpdate(e){e.initialValue!==this.props.initialValue&&(this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:i,label:n,labelClassName:s}=this.props;let a;return a=!t||this.state.phase===fb.Display&&(n||s)&&!this.value?o.createElement("div",{className:e+" "+s,onClick:this.onClickDiv},n||i):o.createElement("div",{ref:this.editableDiv,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),a}}(0,k.Z)(Eb,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class yb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"addThreepid",void 0),(0,k.Z)(this,"onEmailAddressChanged",(e=>{this.setState({emailAddress:e})})),(0,k.Z)(this,"onSubmit",(()=>{const e=this.state.emailAddress;gf.s(e)?(this.addThreepid=new Wy(E.p.safeGet()),this.addThreepid.addEmailAddress(e).then((()=>{T.ZP.createDialog(mt.Z,{title:(0,l._t)("auth|set_email|verification_pending_title"),description:(0,l._t)("auth|set_email|verification_pending_description"),button:(0,l._t)("action|continue"),onFinished:this.onEmailDialogFinished})}),(t=>{this.setState({emailBusy:!1}),r.k.error("Unable to add email address "+e+" "+t),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_add_email"),description:(0,dt.A)(t,(0,l._t)("invite|failed_generic"))})})),this.setState({emailBusy:!0})):T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_invalid_email"),description:(0,l._t)("settings|general|error_invalid_email_detail")})})),(0,k.Z)(this,"onCancelled",(()=>{this.props.onFinished(!1)})),(0,k.Z)(this,"onEmailDialogFinished",(e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})})),this.state={emailAddress:"",emailBusy:!1}}verifyEmailAddress(){var e;null===(e=this.addThreepid)||void 0===e||e.checkEmailLinkClicked().then((()=>{this.props.onFinished(!0)}),(e=>{this.setState({emailBusy:!1});let t=e;if(e instanceof l.yh&&(t=e.cause),t instanceof n.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode){const e=(0,l._t)("settings|general|error_email_verification")+" "+(0,l._t)("auth|set_email|verification_pending_description");T.ZP.createDialog(mt.Z,{title:(0,l._t)("auth|set_email|verification_pending_title"),description:e,button:(0,l._t)("action|continue"),onFinished:this.onEmailDialogFinished})}else r.k.error("Unable to verify email address: "+e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_email_verification"),description:(0,dt.A)(e,(0,l._t)("invite|failed_generic"))})}))}render(){const e=this.state.emailBusy?o.createElement(re.Z,null):o.createElement(Eb,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",placeholder:(0,l._t)("common|email_address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return o.createElement(q.Z,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("p",{id:"mx_Dialog_content"},(0,l._t)("auth|set_email|description")),e),o.createElement("div",{className:"mx_Dialog_buttons"},o.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:(0,l._t)("action|continue"),onClick:this.onSubmit}),o.createElement("input",{type:"submit",value:(0,l._t)("action|skip"),onClick:this.onCancelled})))}}const bb="field_old_password",wb="field_new_password",Sb="field_new_password_confirm";var Cb=function(e){return e.Edit="edit",e.Uploading="uploading",e.Error="error",e}(Cb||{});class kb extends o.Component{constructor(e){super(e),(0,k.Z)(this,bb,null),(0,k.Z)(this,wb,null),(0,k.Z)(this,Sb,null),(0,k.Z)(this,"onChangeOldPassword",(e=>{this.setState({oldPassword:e.target.value})})),(0,k.Z)(this,"onOldPasswordValidate",(async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid(bb,t.valid),t})),(0,k.Z)(this,"validateOldPasswordRules",(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|change_password_empty")}]})),(0,k.Z)(this,"onChangeNewPassword",(e=>{this.setState({newPassword:e.target.value})})),(0,k.Z)(this,"onNewPasswordValidate",(e=>{this.markFieldValid(wb,e.valid)})),(0,k.Z)(this,"onChangeNewPasswordConfirm",(e=>{this.setState({newPasswordConfirm:e.target.value})})),(0,k.Z)(this,"onNewPasswordConfirmValidate",(async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid(Sb,t.valid),t})),(0,k.Z)(this,"validatePasswordConfirmRules",(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|change_password_confirm_label")},{key:"match",test({value:e}){return!e||e===this.state.newPassword},invalid:()=>(0,l._t)("auth|change_password_confirm_invalid")}]})),(0,k.Z)(this,"onClickChange",(async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return;const t=this.state.oldPassword,i=this.state.newPassword,n=this.state.newPasswordConfirm;try{return this.checkPassword(t,i,n),this.onChangePassword(t,i)}catch(e){e instanceof Error?this.props.onError(e):this.props.onError(new l.yh("auth|change_password_error",{error:String(e),cause:void 0}))}})),this.state={fieldValid:{},phase:Cb.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}}async onChangePassword(e,t){const i=E.p.safeGet();this.changePassword(i,e,t)}changePassword(e,t,i){var n;const s={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},user:null!==(n=e.credentials.userId)&&void 0!==n?n:void 0,password:t};this.setState({phase:Cb.Uploading}),e.setPassword(s,i,!1).then((()=>{if(this.props.shouldAskForEmail)return this.optionallySetEmail().then((e=>{this.props.onFinished({didSetEmail:e})}));this.props.onFinished({})}),(e=>{e instanceof Error?this.props.onError(e):this.props.onError(new l.yh("auth|change_password_error",{error:String(e),cause:void 0}))})).finally((()=>{this.setState({phase:Cb.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})}))}checkPassword(e,t,i){if(t!==i)throw new l.yh("auth|change_password_mismatch");if(!t||0===t.length)throw new l.yh("auth|change_password_empty")}optionallySetEmail(){return T.ZP.createDialog(yb,{title:(0,l._t)("auth|set_email_prompt")}).finished.then((([e])=>!!e))}markFieldValid(e,t){const{fieldValid:i}=this.state;i[e]=t,this.setState({fieldValid:i})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[bb,wb,Sb];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const i=this.findFirstInvalidField(t);return!i||(i.focus(),i.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case Cb.Edit:return o.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},o.createElement("div",{className:e},o.createElement(Vs.Z,{ref:e=>this[bb]=e,type:"password",label:(0,l._t)("auth|change_password_current_label"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),o.createElement("div",{className:e},o.createElement(ob.Z,{fieldRef:e=>this[wb]=e,type:"password",label:(0,l.I8)("auth|change_password_new_label"),minScore:3,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),o.createElement("div",{className:e},o.createElement(Vs.Z,{ref:e=>this[Sb]=e,type:"password",label:(0,l._t)("auth|change_password_confirm_label"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),o.createElement(ae.Z,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||(0,l._t)("auth|change_password_action")));case Cb.Uploading:return o.createElement("div",{className:"mx_Dialog_content"},o.createElement(re.Z,null))}}}(0,k.Z)(kb,"defaultProps",{onFinished(){},onError(){},confirm:!0});class xb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"togglePolicy",(e=>{const t=(0,ni.zs)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})})),(0,k.Z)(this,"onContinue",(()=>{!!this.state.policies.some((e=>!e.checked))||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map((e=>e.url))))})),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const i=Object.values(t.policies);for(const t of i){const i=(0,l.qK)(Object.keys(t).filter((e=>"version"!==e))),n={checked:!1,url:t[i].url,name:t[i].name};e.push(n)}}this.setState({policies:e})}renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const i=this.state.policies[t],n=(0,l._t)("terms|inline_intro_text",{},{policyLink:()=>o.createElement("a",{href:i.url,rel:"noreferrer noopener",target:"_blank"},i.name,o.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(o.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},o.createElement("div",null,n),o.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},o.createElement(qs.Z,{onChange:()=>this.togglePolicy(t),checked:i.checked},(0,l._t)("action|accept")))))}return e}render(){const e=!!this.state.policies.some((e=>!e.checked));return o.createElement("div",null,this.props.introElement,this.renderCheckboxes(),o.createElement(ae.Z,{onClick:this.onContinue,disabled:e||this.state.busy,kind:"primary_sm"},(0,l._t)("action|continue")))}}var Rb=i("../matrix-react-sdk/src/utils/IdentityServerUtils.ts"),Ib=i("../matrix-react-sdk/src/utils/promise.ts");class Pb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"onAction",(e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:E.p.safeGet().getIdentityServerUrl()})})),(0,k.Z)(this,"onIdentityServerChanged",(e=>{const t=e.target.value;this.setState({idServer:t})})),(0,k.Z)(this,"getTooltip",(()=>this.state.checking?o.createElement("div",null,o.createElement(_r.Z,null),(0,l._t)("identity_server|checking")):this.state.error?o.createElement("span",{className:"warning"},this.state.error):null)),(0,k.Z)(this,"idServerChangeEnabled",(()=>!!this.state.idServer&&!this.state.busy)),(0,k.Z)(this,"saveIdServer",(e=>{E.p.safeGet().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:void 0,currentClientIdServer:e,idServer:""})})),(0,k.Z)(this,"checkIdServer",(async e=>{var t;e.preventDefault();const{idServer:i,currentClientIdServer:n}=this.state;this.setState({busy:!0,checking:!0,error:void 0});const s=(0,$p.EW)(i);let a=await async function(e){if("https:"!==(0,$p.en)(e).protocol)return(0,l._t)("identity_server|url_not_https");try{const t=await fetch(e+"/_matrix/identity/v2");return t.ok?null:t.status<200||t.status>=300?(0,l._t)("identity_server|error_invalid",{code:t.status}):(0,l._t)("identity_server|error_connection")}catch(e){return(0,l._t)("identity_server|error_connection")}}(s);if(!a)try{this.setState({checking:!1});const e=new qg.Z(s);await e.getAccessToken();let t=!0;if(!await(0,Rb.XO)(E.p.safeGet(),s)){const[e]=await this.showNoTermsWarning(s);t=!!e}if(t&&n&&s!==n){const[e]=await this.showServerChangeWarning({title:(0,l._t)("identity_server|change"),unboundMessage:(0,l._t)("identity_server|change_prompt",{},{current:e=>o.createElement("b",null,(0,$p.FB)(n)),new:e=>o.createElement("b",null,(0,$p.FB)(i))}),button:(0,l._t)("action|continue")});t=!!e}t&&this.saveIdServer(s)}catch(e){r.k.error(e),a=(0,l._t)("identity_server|error_invalid_or_terms")}this.setState({busy:!1,checking:!1,error:null!==(t=a)&&void 0!==t?t:void 0,currentClientIdServer:E.p.safeGet().getIdentityServerUrl()})})),(0,k.Z)(this,"onDisconnectClicked",(async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this.showServerChangeWarning({title:(0,l._t)("identity_server|disconnect"),unboundMessage:(0,l._t)("identity_server|disconnect_server",{},{idserver:e=>o.createElement("b",null,(0,$p.FB)(this.state.currentClientIdServer))}),button:(0,l._t)("action|disconnect")});e&&this.disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}})),(0,k.Z)(this,"disconnectIdServer",(()=>{E.p.safeGet().setAccountData("m.identity_server",{base_url:null});let e="";(0,Rb.P_)()&&(e=(0,$p.FB)((0,Rb.P_)())),this.setState({busy:!1,error:void 0,currentClientIdServer:E.p.safeGet().getIdentityServerUrl(),idServer:e})}));let t="";!E.p.safeGet().getIdentityServerUrl()&&(0,Rb.P_)()&&(t=(0,$p.FB)((0,Rb.P_)())),this.state={defaultIdServer:t,currentClientIdServer:E.p.safeGet().getIdentityServerUrl(),idServer:"",busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=x.ZP.register(this.onAction)}componentWillUnmount(){this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef)}showNoTermsWarning(e){const{finished:t}=T.ZP.createDialog(mt.Z,{title:(0,l._t)("terms|identity_server_no_terms_title"),description:o.createElement("div",null,o.createElement("span",{className:"warning"},(0,l._t)("identity_server|no_terms")),o.createElement("span",null,"Â ",(0,l._t)("terms|identity_server_no_terms_description_2"))),button:(0,l._t)("action|continue")});return t}async showServerChangeWarning({title:e,unboundMessage:t,button:i}){const{currentClientIdServer:n}=this.state;let s=[],a=!0;try{s=await(0,Ib.V)(jy(E.p.safeGet()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){a=!1,r.k.warn(`Unable to reach identity server at ${n} to check for 3PIDs during IS change flow`),r.k.warn(e)}const c=s.filter((e=>e.bound));let d,m=!1;const h={idserver:e=>o.createElement("b",null,(0,$p.FB)(n)),b:e=>o.createElement("b",null,e)};a?c.length?(d=o.createElement("div",null,o.createElement("p",null,(0,l._t)("identity_server|disconnect_personal_data_warning_1",{},h)),o.createElement("p",null,(0,l._t)("identity_server|disconnect_personal_data_warning_2"))),m=!0,i=(0,l._t)("identity_server|disconnect_anyway")):d=t:(d=o.createElement("div",null,o.createElement("p",null,(0,l._t)("identity_server|disconnect_offline_warning",{},h)),o.createElement("p",null,(0,l._t)("identity_server|suggestions")),o.createElement("ul",null,o.createElement("li",null,(0,l._t)("identity_server|suggestions_1")),o.createElement("li",null,(0,l._t)("identity_server|suggestions_2",{},{idserver:h.idserver})),o.createElement("li",null,(0,l._t)("identity_server|suggestions_3")))),m=!0,i=(0,l._t)("identity_server|disconnect_anyway"));const{finished:p}=T.ZP.createDialog(mt.Z,{title:e,description:d,button:i,cancelButton:(0,l._t)("action|go_back"),danger:m});return p}render(){const e=this.state.currentClientIdServer;let t,i,n;if(e?(t=(0,l._t)("identity_server|url",{server:(0,$p.FB)(e)}),i=(0,l._t)("identity_server|description_connected",{},{server:t=>o.createElement("b",null,(0,$p.FB)(e))}),this.props.missingTerms&&(i=(0,l._t)("identity_server|change_server_prompt",{},{server:t=>o.createElement("b",null,(0,$p.FB)(e))}))):(t=(0,l._t)("common|identity_server"),i=(0,l._t)("identity_server|description_disconnected")),e){let e=(0,l._t)("action|disconnect"),t=(0,l._t)("identity_server|disconnect_warning");this.props.missingTerms&&(t=(0,l._t)("identity_server|description_optional"),e=(0,l._t)("identity_server|do_not_use")),this.state.disconnectBusy&&(e=o.createElement(_r.Z,null)),n=o.createElement(o.Fragment,null,o.createElement(Xs.po,null,t),o.createElement(ae.Z,{onClick:this.onDisconnectClicked,kind:"danger_sm"},e))}return o.createElement(vo.Z,{legend:t,description:i},o.createElement("form",{className:"mx_SetIdServer",onSubmit:this.checkIdServer},o.createElement(Vs.Z,{label:(0,l._t)("identity_server|url_field_label"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this.onIdentityServerChanged,tooltipContent:this.getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&void 0}),o.createElement(ae.Z,{type:"submit",kind:"primary_sm",onClick:this.checkIdServer,disabled:!this.idServerChangeEnabled()},(0,l._t)("action|change")),n))}}var Tb=i("../matrix-react-sdk/src/components/views/elements/ToggleSwitch.tsx");class Zb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onProvisioningToggled",(()=>{const e=this.state.provisioningEnabled;L.C.setValue("integrationProvisioning",null,U.R.ACCOUNT,!e).catch((t=>{r.k.error("Error changing integration manager provisioning"),r.k.error(t),this.setState({provisioningEnabled:e})})),this.setState({provisioningEnabled:!e})}));const t=B.B.sharedInstance().getPrimaryManager();this.state={currentManager:t,provisioningEnabled:L.C.getValue("integrationProvisioning")}}render(){const e=this.state.currentManager;let t,i;return e?(t=`(${e.name})`,i=(0,l._t)("integration_manager|use_im_default",{serverName:e.name},{b:e=>o.createElement("b",null,e)})):i=(0,l._t)("integration_manager|use_im"),o.createElement("label",{className:"mx_SetIntegrationManager","data-testid":"mx_SetIntegrationManager",htmlFor:"toggle_integration"},o.createElement("div",{className:"mx_SettingsFlag"},o.createElement("div",{className:"mx_SetIntegrationManager_heading_manager"},o.createElement(ac.Z,{size:"2"},(0,l._t)("integration_manager|manage_title")),o.createElement(ac.Z,{size:"3"},t)),o.createElement(Tb.Z,{id:"toggle_integration",checked:this.state.provisioningEnabled,disabled:!1,onChange:this.onProvisioningToggled})),o.createElement(Xs.po,null,i),o.createElement(Xs.po,null,(0,l._t)("integration_manager|explainer")))}}function Nb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Db(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Nb(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Nb(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Mb extends o.Component{constructor(e,t){super(e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"onAction",(e=>{"id_server_changed"===e.action&&(this.setState({haveIdServer:Boolean(this.context.client.getIdentityServerUrl())}),this.getThreepidState())})),(0,k.Z)(this,"onEmailsChange",(e=>{this.setState({emails:e})})),(0,k.Z)(this,"onMsisdnsChange",(e=>{this.setState({msisdns:e})})),(0,k.Z)(this,"onLanguageChange",(e=>{if(this.state.language===e)return;L.C.setValue("language",null,U.R.DEVICE,e),this.setState({language:e});const t=a.Z.get();t&&(t.setLanguage([e]),t.reload())})),(0,k.Z)(this,"onSpellCheckLanguagesChange",(e=>{var t;this.setState({spellCheckLanguages:e}),null===(t=a.Z.get())||void 0===t||t.setSpellCheckLanguages(e)})),(0,k.Z)(this,"onSpellCheckEnabledChange",(e=>{var t;this.setState({spellCheckEnabled:e}),null===(t=a.Z.get())||void 0===t||t.setSpellCheckEnabled(e)})),(0,k.Z)(this,"onPasswordChangeError",(e=>{r.k.error("Failed to change password: "+e);let t=e;e instanceof l.yh&&e.cause instanceof Error&&(t=e.cause);const i=(0,dt.A)(e,(0,l._t)("settings|general|error_password_change_unknown",{stringifiedError:String(e)}));let s=i;t instanceof n.HTTPError&&403===t.httpStatus?s=(0,l._t)("settings|general|error_password_change_403"):t instanceof n.HTTPError&&(s=(0,l._t)("settings|general|error_password_change_http",{errorMessage:i,httpStatus:t.httpStatus})),T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|general|error_password_change_title"),description:s})})),(0,k.Z)(this,"onPasswordChanged",(()=>{const e=(0,l._t)("settings|general|password_change_success");T.ZP.createDialog(dt.Z,{title:(0,l._t)("common|success"),description:e})})),(0,k.Z)(this,"onDeactivateClicked",(()=>{T.ZP.createDialog(By,{onFinished:e=>{e&&this.props.closeSettingsFn()}})})),this.context=t;const i=this.context.client;this.state={language:l.Wx(),spellCheckEnabled:!1,spellCheckLanguages:[],haveIdServer:Boolean(i.getIdentityServerUrl()),idServerHasUnsignedTerms:!1,requiredPolicyInfo:{hasTerms:!1,policiesAndServices:null,agreedUrls:null,resolve:null},emails:[],msisdns:[],loading3pids:!0,canChangePassword:!1,canMake3pidChanges:!1},this.dispatcherRef=x.ZP.register(this.onAction),this.getCapabilities(),this.getThreepidState()}async componentDidMount(){const e=a.Z.get(),[t,i]=await Promise.all([null==e?void 0:e.getSpellCheckEnabled(),null==e?void 0:e.getSpellCheckLanguages()]);i&&this.setState({spellCheckEnabled:t,spellCheckLanguages:i})}componentWillUnmount(){x.ZP.unregister(this.dispatcherRef)}async getCapabilities(){const e=this.context.client,t=await e.getCapabilities(),i=t["m.change_password"],n=!i||!1!==i.enabled,s=this.context.oidcClientStore.accountManagementEndpoint,o=!t["m.3pid_changes"]||!0===t["m.3pid_changes"].enabled;this.setState({canChangePassword:n,externalAccountManagementUrl:s,canMake3pidChanges:o})}async getThreepidState(){const e=this.context.client;this.checkTerms();let t=[];try{t=await jy(e)}catch(t){const i=e.getIdentityServerUrl();r.k.warn(`Unable to reach identity server at ${i} to check for 3PIDs bindings in Settings`),r.k.warn(t)}this.setState({emails:t.filter((e=>e.medium===n.ThreepidMedium.Email)),msisdns:t.filter((e=>e.medium===n.ThreepidMedium.Phone)),loading3pids:!1})}async checkTerms(){const e=this.context.client.getIdentityServerUrl();if(!this.state.haveIdServer||!e)return void this.setState({idServerHasUnsignedTerms:!1});const t=new qg.Z;try{const i=await t.getAccessToken({check:!1});await(0,Vy.GY)(this.context.client,[new Vy.t6(n.SERVICE_TYPES.IS,e,i)],((t,i,n)=>new Promise(((n,s)=>{this.setState({idServerName:(0,$p.FB)(e),requiredPolicyInfo:{hasTerms:!0,policiesAndServices:t,agreedUrls:i,resolve:n}})})))),this.setState({requiredPolicyInfo:Db(Db({},this.state.requiredPolicyInfo),{},{hasTerms:!1})})}catch(t){r.k.warn(`Unable to reach identity server at ${e} to check for terms in Settings`),r.k.warn(t)}}renderAccountSection(){let e=null;if(L.C.getValue(Ye.H.ThirdPartyID)){const t=this.state.loading3pids?o.createElement(_r.Z,null):o.createElement(eb,{emails:this.state.emails,onEmailsChange:this.onEmailsChange,disabled:!this.state.canMake3pidChanges}),i=this.state.loading3pids?o.createElement(_r.Z,null):o.createElement(Qy,{msisdns:this.state.msisdns,onMsisdnsChange:this.onMsisdnsChange,disabled:!this.state.canMake3pidChanges});e=o.createElement(o.Fragment,null,o.createElement(Xs.ZP,{heading:(0,l._t)("settings|general|emails_heading"),stretchContent:!0,"data-testid":"mx_AccountEmailAddresses"},t),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|general|msisdns_heading"),stretchContent:!0,"data-testid":"mx_AccountPhoneNumbers"},i))}let t,i=null;if(this.state.canChangePassword&&(i=o.createElement(o.Fragment,null,o.createElement(Xs.po,null,(0,l._t)("settings|general|password_change_section")),o.createElement(kb,{className:"mx_GeneralUserSettingsTab_section--account_changePassword",rowClassName:"",buttonKind:"primary",onError:this.onPasswordChangeError,onFinished:this.onPasswordChanged}))),this.state.externalAccountManagementUrl){const{hostname:e}=new URL(this.state.externalAccountManagementUrl);t=o.createElement(o.Fragment,null,o.createElement(Xs.po,{"data-testid":"external-account-management-outer"},(0,l._t)("settings|general|external_account_management",{hostname:e},{code:e=>o.createElement("code",null,e)})),o.createElement(ae.Z,{onClick:null,element:"a",kind:"primary",target:"_blank",rel:"noreferrer noopener",href:this.state.externalAccountManagementUrl,"data-testid":"external-account-management-link"},(0,l._t)("settings|general|oidc_manage_button")))}return o.createElement(o.Fragment,null,o.createElement(Xs.ZP,{heading:(0,l._t)("settings|general|account_section"),stretchContent:!0,"data-testid":"accountSection"},t,i),e)}renderLanguageSection(){return o.createElement(Xs.ZP,{heading:(0,l._t)("settings|general|language_section"),stretchContent:!0},o.createElement(My,{className:"mx_GeneralUserSettingsTab_section_languageInput",onOptionChange:this.onLanguageChange,value:this.state.language}))}renderSpellCheckSection(){const e=o.createElement(Ny.I,{heading:(0,l._t)("settings|general|spell_check_section")},o.createElement(Tb.Z,{checked:!!this.state.spellCheckEnabled,onChange:this.onSpellCheckEnabledChange}));return o.createElement(Xs.ZP,{heading:e,stretchContent:!0},this.state.spellCheckEnabled&&!en.Mq&&o.createElement(Ly,{languages:this.state.spellCheckLanguages,onLanguagesChange:this.onSpellCheckLanguagesChange}))}renderDiscoverySection(){if(this.state.requiredPolicyInfo.hasTerms){const e=o.createElement(Xs.po,null,(0,l._t)("settings|general|discovery_needs_terms",{serverName:this.state.idServerName}));return o.createElement(o.Fragment,null,o.createElement(xb,{policiesAndServicePairs:this.state.requiredPolicyInfo.policiesAndServices,agreedUrls:this.state.requiredPolicyInfo.agreedUrls,onFinished:this.state.requiredPolicyInfo.resolve,introElement:e}),o.createElement(Pb,{missingTerms:!0}))}const e=this.state.haveIdServer?o.createElement(o.Fragment,null,o.createElement(ib,{emails:this.state.emails,isLoading:this.state.loading3pids,disabled:!this.state.canMake3pidChanges}),o.createElement(sb,{msisdns:this.state.msisdns,isLoading:this.state.loading3pids,disabled:!this.state.canMake3pidChanges})):null;return o.createElement(o.Fragment,null,e,o.createElement(Pb,{missingTerms:!1}))}renderManagementSection(){return o.createElement(Qs.Q,{heading:(0,l._t)("settings|general|deactivate_section")},o.createElement(Xs.ZP,{heading:(0,l._t)("settings|general|account_management_section"),"data-testid":"account-management-section",description:(0,l._t)("settings|general|deactivate_warning")},o.createElement(ae.Z,{onClick:this.onDeactivateClicked,kind:"danger"},(0,l._t)("settings|general|deactivate_section"))))}renderIntegrationManagerSection(){return L.C.getValue(Ye.H.Widgets)?o.createElement(Zb,null):null}render(){const e=a.Z.get(),t=null==e?void 0:e.supportsSpellCheckSettings();let i;const n=!!this.state.externalAccountManagementUrl;let s;if(L.C.getValue(Ye.H.Deactivate)&&!n&&(i=this.renderManagementSection()),L.C.getValue(Ye.H.IdentityServer)){const e=this.state.requiredPolicyInfo.hasTerms?o.createElement(Ty.J,{className:"mx_GeneralUserSettingsTab_warningIcon",width:"18",height:"18","aria-hidden":!1,"aria-label":(0,l._t)("common|warning")}):null,t=o.createElement(ac.Z,{size:"2"},e,(0,l._t)("settings|general|discovery_section"));s=o.createElement(Qs.Q,{heading:t,"data-testid":"discoverySection"},this.renderDiscoverySection())}return o.createElement(Ys.Z,{"data-testid":"mx_GeneralUserSettingsTab"},o.createElement(Qs.Q,{heading:(0,l._t)("common|general")},o.createElement(Dy,null),this.renderAccountSection(),this.renderLanguageSection(),t?this.renderSpellCheckSection():null),s,this.renderIntegrationManagerSection(),i)}}(0,k.Z)(Mb,"contextType",ie.f);var Ob=i("../matrix-react-sdk/src/components/views/elements/SettingsFlag.tsx"),Ab=i("../matrix-react-sdk/src/utils/maps.ts");const Lb=()=>c.ZP.get("show_labs_settings")||L.C.getValue("developerMode");class Ub extends o.Component{constructor(e){super(e),(0,k.Z)(this,"labs",void 0),(0,k.Z)(this,"betas",void 0);const t=L.C.getFeatureSettingNames(),[i,n]=t.reduce(((e,t)=>(e[L.C.getBetaInfo(t)?1:0].push(t),e)),[[],[]]);this.labs=i,this.betas=n,Lb()||(this.labs=[])}render(){let e,t;if(this.betas.length&&(e=o.createElement(o.Fragment,null,this.betas.map((e=>o.createElement(pr.Z,{key:e,featureId:e}))))),this.labs.length){const e=new Ab.K;this.labs.forEach((t=>{e.getOrCreate(L.C.getLabGroup(t),[]).push(o.createElement(Ob.Z,{level:U.R.DEVICE,name:t,key:t}))})),e.getOrCreate(mg.YH.Experimental,[]).push(o.createElement(Ob.Z,{key:"lowBandwidth",name:"lowBandwidth",level:U.R.DEVICE})),e.getOrCreate(mg.YH.Analytics,[]).push(o.createElement(Ob.Z,{key:"automaticErrorReporting",name:"automaticErrorReporting",level:U.R.DEVICE}),o.createElement(Ob.Z,{key:"automaticDecryptionErrorReporting",name:"automaticDecryptionErrorReporting",level:U.R.DEVICE})),t=o.createElement(o.Fragment,null,(0,ln.sortBy)(Array.from(e.entries()),"0").map((([e,t])=>o.createElement(Xs.ZP,{key:e,"data-testid":`labs-group-${e}`,heading:(0,l._t)(mg.Eu[e])},t))))}return o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("labs|beta_section")},o.createElement(Xs.po,null,(0,l._t)("labs|beta_description",{brand:c.ZP.get("brand")})),e),t&&o.createElement(Qs.Q,{heading:(0,l._t)("labs|experimental_section")},o.createElement(Xs.po,null,(0,l._t)("labs|experimental_description",{},{a:e=>o.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),t))}}class Fb extends o.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent({message:e}){const t={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:n.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:n.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},i=new n.MatrixEvent(t);return i.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:(...e)=>Ct.cL({avatarUrl:this.props.avatarUrl},32,32,"crop"),getMxcAvatarUrl:()=>this.props.avatarUrl},i}render(){const e=yt()(this.props.className,{mx_IRCLayout:this.props.layout==St.A.IRC,mx_EventTilePreview_loader:!this.props.userId});if(!this.props.userId)return o.createElement("div",{className:e},o.createElement(re.Z,null));const t=this.fakeEvent(this.state);return o.createElement("div",{className:e,role:"presentation"},o.createElement(rs,{mxEvent:t,layout:this.props.layout,as:"div",hideTimestamp:!0,inhibitInteraction:!0}))}}class Bb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onLayoutChange",(e=>{const t=e.target.value;this.setState({layout:t}),L.C.setValue("layout",null,U.R.DEVICE,t),this.props.onLayoutChanged(t)})),this.state={layout:L.C.getValue("layout")}}render(){const e=yt()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==St.A.IRC}),t=yt()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==St.A.Group}),i=yt()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout===St.A.Bubble});return o.createElement(Xs.ZP,{heading:(0,l._t)("common|message_layout")},o.createElement("div",{className:"mx_LayoutSwitcher_RadioButtons"},o.createElement("label",{className:e},o.createElement(Fb,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:St.A.IRC,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.createElement(Bs.Z,{name:"layout",value:St.A.IRC,checked:this.state.layout===St.A.IRC,onChange:this.onLayoutChange},(0,l._t)("settings|appearance|layout_irc"))),o.createElement("label",{className:t},o.createElement(Fb,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:St.A.Group,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.createElement(Bs.Z,{name:"layout",value:St.A.Group,checked:this.state.layout==St.A.Group,onChange:this.onLayoutChange},(0,l._t)("common|modern"))),o.createElement("label",{className:i},o.createElement(Fb,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:St.A.Bubble,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.createElement(Bs.Z,{name:"layout",value:St.A.Bubble,checked:this.state.layout==St.A.Bubble,onChange:this.onLayoutChange},(0,l._t)("settings|appearance|layout_bubbles")))))}}class Vb extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"onChange",(e=>{this.props.onChange(parseInt(e.target.value,10))}))}get position(){const{min:e,max:t,value:i}=this.props;return Number(100*(i-e)/(t-e))}render(){let e;if(!this.props.disabled){const t=this.position;e=o.createElement("output",{className:"mx_Slider_selection",style:{left:`calc(2px + ${t}% + 1.2em - ${t/100*2.4}em)`}},o.createElement("span",{className:"mx_Slider_selection_label"},this.props.value))}return o.createElement("div",{className:"mx_Slider"},o.createElement("input",{type:"range",min:this.props.min,max:this.props.max,value:this.props.value,onChange:this.onChange,disabled:this.props.disabled,step:this.props.step,autoComplete:"off","aria-label":this.props.label}),e)}}class jb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"MESSAGE_PREVIEW_TEXT",(0,l._t)("common|preview_message")),(0,k.Z)(this,"layoutWatcherRef",void 0),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"onFontSizeChanged",(e=>{this.setState({fontSize:e.toString()}),L.C.setValue("baseFontSizeV2",null,U.R.DEVICE,e)})),(0,k.Z)(this,"onValidateFontSize",(async({value:e})=>{const t=parseFloat(e),i=Ha.C.MIN_SIZE,n=Ha.C.MAX_SIZE;return isNaN(t)?{valid:!1,feedback:(0,l._t)("settings|appearance|font_size_nan")}:i<=t&&t<=n?(L.C.setValue("baseFontSizeV2",null,U.R.DEVICE,parseInt(e,10)),{valid:!0,feedback:(0,l._t)("settings|appearance|font_size_valid",{min:i,max:n})}):{valid:!1,feedback:(0,l._t)("settings|appearance|font_size_limit",{min:i,max:n})}})),this.state={fontSize:L.C.getValue("baseFontSizeV2",null).toString(),useCustomFontSize:L.C.getValue("useCustomFontSize"),layout:L.C.getValue("layout")}}async componentDidMount(){const e=E.p.safeGet(),t=e.getSafeUserId(),i=await e.getProfileInfo(t);this.layoutWatcherRef=L.C.watchSetting("layout",null,(()=>{const e=L.C.getValue("layout");this.state.layout!==e&&this.setState({layout:e})})),this.unmounted||this.setState({userId:t,displayName:i.displayname,avatarUrl:i.avatar_url})}componentWillUnmount(){this.unmounted=!0,this.layoutWatcherRef&&L.C.unwatchSetting(this.layoutWatcherRef)}render(){return o.createElement(Xs.ZP,{heading:(0,l._t)("settings|appearance|font_size"),stretchContent:!0,"data-testid":"mx_FontScalingPanel"},o.createElement(Fb,{className:"mx_FontScalingPanel_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:this.state.layout,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}),o.createElement("div",{className:"mx_FontScalingPanel_fontSlider"},o.createElement("div",{className:"mx_FontScalingPanel_fontSlider_smallText"},"Aa"),o.createElement(Vb,{min:Ha.C.MIN_SIZE,max:Ha.C.MAX_SIZE,step:1,value:parseInt(this.state.fontSize,10),onChange:this.onFontSizeChanged,displayFunc:e=>"",disabled:this.state.useCustomFontSize,label:(0,l._t)("settings|appearance|font_size")}),o.createElement("div",{className:"mx_FontScalingPanel_fontSlider_largeText"},"Aa")),o.createElement(Ob.Z,{name:"useCustomFontSize",level:U.R.ACCOUNT,onChange:e=>{if(this.setState({useCustomFontSize:e}),!e){const e=parseInt(this.state.fontSize,10),t=(0,Rv.uZ)(e,Ha.C.MIN_SIZE,Ha.C.MAX_SIZE);t!==e&&this.onFontSizeChanged(t)}},useCheckbox:!0}),o.createElement(Vs.Z,{type:"number",label:(0,l._t)("settings|appearance|font_size"),autoComplete:"off",placeholder:this.state.fontSize.toString(),value:this.state.fontSize.toString(),id:"font_size_field",onValidate:this.onValidateFontSize,onChange:e=>this.setState({fontSize:e.target.value}),disabled:!this.state.useCustomFontSize,className:"mx_AppearanceUserSettingsTab_checkboxControlledField"}))}}var zb=i("../matrix-react-sdk/src/settings/enums/ImageSize.ts");class Wb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onSizeChange",(e=>{const t=e.target.value;this.setState({size:t}),L.C.setValue("Images.size",null,U.R.ACCOUNT,t)})),this.state={size:L.C.getValue("Images.size")}}render(){return o.createElement(Xs.ZP,{heading:(0,l._t)("settings|appearance|timeline_image_size")},o.createElement("div",{className:"mx_ImageSizePanel_radios"},o.createElement("label",null,o.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeDefault"}),o.createElement(Bs.Z,{name:"image_size",value:zb.h.Normal,checked:this.state.size===zb.h.Normal,onChange:this.onSizeChange},(0,l._t)("settings|appearance|image_size_default"))),o.createElement("label",null,o.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeLarge"}),o.createElement(Bs.Z,{name:"image_size",value:zb.h.Large,checked:this.state.size===zb.h.Large,onChange:this.onSizeChange},(0,l._t)("settings|appearance|image_size_large")))))}}class Hb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"MESSAGE_PREVIEW_TEXT",(0,l._t)("common|preview_message")),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"onLayoutChanged",(e=>{this.setState({layout:e})})),this.state={useBundledEmojiFont:L.C.getValue("useBundledEmojiFont"),useSystemFont:L.C.getValue("useSystemFont"),systemFont:L.C.getValue("systemFont"),showAdvanced:!1,layout:L.C.getValue("layout")}}async componentDidMount(){const e=this.context,t=e.getUserId(),i=await e.getProfileInfo(t);this.unmounted||this.setState({userId:t,displayName:i.displayname,avatarUrl:i.avatar_url})}componentWillUnmount(){this.unmounted=!0}renderAdvancedSection(){if(!L.C.getValue(Ye.H.AdvancedSettings))return null;const e=c.ZP.get().brand,t=o.createElement(ae.Z,{kind:"link",onClick:()=>this.setState({showAdvanced:!this.state.showAdvanced}),"aria-expanded":this.state.showAdvanced},this.state.showAdvanced?(0,l._t)("action|hide_advanced"):(0,l._t)("action|show_advanced"));let i;if(this.state.showAdvanced){const t=(0,l._t)("settings|appearance|custom_font_description",{brand:e});i=o.createElement(o.Fragment,null,o.createElement(Ob.Z,{name:"useCompactLayout",level:U.R.DEVICE,useCheckbox:!0}),o.createElement(Ob.Z,{name:"useBundledEmojiFont",level:U.R.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useBundledEmojiFont:e})}),o.createElement(Ob.Z,{name:"useSystemFont",level:U.R.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),o.createElement(Vs.Z,{className:"mx_AppearanceUserSettingsTab_checkboxControlledField",label:L.C.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),L.C.setValue("systemFont",null,U.R.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont}))}return o.createElement(Xs.ZP,null,t,i)}render(){const e=c.ZP.get().brand;return o.createElement(Ys.Z,{"data-testid":"mx_AppearanceUserSettingsTab"},o.createElement(Qs.Q,{heading:(0,l._t)("settings|appearance|heading")},o.createElement(Xs.po,null,(0,l._t)("settings|appearance|subheading",{brand:e})),o.createElement(rl,null),o.createElement(Bb,{userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl,messagePreviewText:this.MESSAGE_PREVIEW_TEXT,onLayoutChanged:this.onLayoutChanged}),o.createElement(jb,null),this.renderAdvancedSection(),o.createElement(Wb,null)))}}(0,k.Z)(Hb,"contextType",pn.ZP);class Gb extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"onKeyBackupSessionsRemaining",(e=>{this.setState({sessionsRemaining:e})})),(0,k.Z)(this,"onKeyBackupStatus",(()=>{this.loadBackupStatus()})),(0,k.Z)(this,"startNewBackup",(()=>{T.ZP.createDialogAsync(i.e(4770).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/security/CreateKeyBackupDialog.tsx")),{onFinished:()=>{this.loadBackupStatus()}},void 0,!1,!0)})),(0,k.Z)(this,"deleteBackup",(()=>{T.ZP.createDialog(mt.Z,{title:(0,l._t)("settings|security|delete_backup"),description:(0,l._t)("settings|security|delete_backup_confirm_description"),button:(0,l._t)("settings|security|delete_backup"),danger:!0,onFinished:e=>{var t;if(!e)return;this.setState({loading:!0});const i=this.state.backupInfo.version;null===(t=E.p.safeGet().getCrypto())||void 0===t||t.deleteKeyBackupVersion(i).then((()=>{this.loadBackupStatus()}))}})})),(0,k.Z)(this,"restoreBackup",(async()=>{T.ZP.createDialog(xl.Z,void 0,void 0,!1,!0)})),(0,k.Z)(this,"resetSecretStorage",(async()=>{this.setState({error:!1});try{await(0,ee.zL)((async()=>{}),!0)}catch(e){if(r.k.error("Error resetting secret storage",e),this.unmounted)return;this.setState({error:!0})}this.unmounted||this.loadBackupStatus()})),this.state={loading:!0,error:!1,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupTrustInfo:void 0,activeBackupVersion:null,sessionsRemaining:null}}componentDidMount(){this.loadBackupStatus(),E.p.safeGet().on(j.qG.KeyBackupStatus,this.onKeyBackupStatus),E.p.safeGet().on(j.qG.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining)}componentWillUnmount(){this.unmounted=!0,E.p.get()&&(E.p.get().removeListener(j.qG.KeyBackupStatus,this.onKeyBackupStatus),E.p.get().removeListener(j.qG.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining))}async loadBackupStatus(){this.setState({loading:!0}),this.getUpdatedDiagnostics();try{var e,t,i;const n=E.p.safeGet(),s=await n.getKeyBackupVersion(),o=s?await(null===(e=n.getCrypto())||void 0===e?void 0:e.isKeyBackupTrusted(s)):void 0,a=null!==(t=await(null===(i=n.getCrypto())||void 0===i?void 0:i.getActiveSessionBackupVersion()))&&void 0!==t?t:null;if(this.unmounted)return;this.setState({loading:!1,error:!1,backupInfo:s,backupTrustInfo:o,activeBackupVersion:a})}catch(e){if(r.k.log("Unable to fetch key backup status",e),this.unmounted)return;this.setState({loading:!1,error:!0,backupInfo:null,backupTrustInfo:void 0,activeBackupVersion:null})}}async getUpdatedDiagnostics(){const e=E.p.safeGet(),t=e.getCrypto();if(!t)return;const i=e.secretStorage,n=!!await e.isKeyBackupKeyStored(),s=await t.getSessionBackupPrivateKey(),o=!!s,a=s instanceof Uint8Array,r=await i.hasKey(),l=await t.isSecretStorageReady();this.unmounted||this.setState({backupKeyStored:n,backupKeyCached:o,backupKeyWellFormed:a,secretStorageKeyInAccount:r,secretStorageReady:l})}render(){const{loading:e,error:t,backupKeyStored:i,backupKeyCached:n,backupKeyWellFormed:s,secretStorageKeyInAccount:a,secretStorageReady:r,backupInfo:c,backupTrustInfo:d,sessionsRemaining:m}=this.state;let h,p,u;const g=[];if(t)h=o.createElement(Xs.po,{className:"error"},(0,l._t)("settings|security|error_loading_key_backup_status"));else if(e)h=o.createElement(re.Z,null);else if(c){let e,t,i=(0,l._t)("settings|security|restore_key_backup");null!==this.state.activeBackupVersion?h=o.createElement(Xs.po,null,"â ",(0,l._t)("settings|security|key_backup_active")):(h=o.createElement(o.Fragment,null,o.createElement(Xs.po,null,(0,l._t)("settings|security|key_backup_inactive",{},{b:e=>o.createElement("b",null,e)})),o.createElement(Xs.po,null,(0,l._t)("settings|security|key_backup_connect_prompt"))),i=(0,l._t)("settings|security|key_backup_connect")),e=null===m?"":m>0?o.createElement("div",null,(0,l._t)("settings|security|key_backup_in_progress",{sessionsRemaining:m})," ",o.createElement("br",null)):o.createElement("div",null,(0,l._t)("settings|security|key_backup_complete")," ",o.createElement("br",null)),null!=d&&d.matchesDecryptionKey&&(t=(0,l._t)("settings|security|key_backup_can_be_restored")),p=o.createElement(o.Fragment,null,o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|key_backup_latest_version")),o.createElement("td",null,c.version," (",(0,l._t)("settings|security|key_backup_algorithm")," ",o.createElement("code",null,c.algorithm),")")),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|key_backup_active_version")),o.createElement("td",null,null===this.state.activeBackupVersion?(0,l._t)("settings|security|key_backup_active_version_none"):this.state.activeBackupVersion))),u=o.createElement(o.Fragment,null,e,o.createElement("div",null,t)),g.push(o.createElement(ae.Z,{key:"restore",kind:"primary",onClick:this.restoreBackup},i)),(0,We.jV)(E.p.safeGet())||g.push(o.createElement(ae.Z,{key:"delete",kind:"danger",onClick:this.deleteBackup},(0,l._t)("settings|security|delete_backup")))}else h=o.createElement(o.Fragment,null,o.createElement(Xs.po,null,(0,l._t)("settings|security|key_backup_inactive_warning",{},{b:e=>o.createElement("b",null,e)})),o.createElement(Xs.po,null,(0,l._t)("encryption|setup_secure_backup|explainer"))),g.push(o.createElement(ae.Z,{key:"setup",kind:"primary",onClick:this.startNewBackup},(0,l._t)("encryption|setup_secure_backup|title")));a&&g.push(o.createElement(ae.Z,{key:"reset",kind:"danger",onClick:this.resetSecretStorage},(0,l._t)("action|reset")));let v,_="";return n&&(_=", ",_+=s?(0,l._t)("settings|security|backup_key_well_formed"):(0,l._t)("settings|security|backup_key_unexpected_type")),g.length&&(v=o.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},g)),o.createElement(o.Fragment,null,o.createElement(Xs.po,null,(0,l._t)("settings|security|backup_keys_description")),h,o.createElement("details",null,o.createElement("summary",{className:"mx_SecureBackupPanel_advanced"},(0,l._t)("common|advanced")),o.createElement("table",{className:"mx_SecureBackupPanel_statusList"},o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|backup_key_stored_status")),o.createElement("td",null,!0===i?(0,l._t)("settings|security|cross_signing_in_4s"):(0,l._t)("settings|security|cross_signing_not_stored"))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|backup_key_cached_status")),o.createElement("td",null,n?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"),_)),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|4s_public_key_status")),o.createElement("td",null,a?(0,l._t)("settings|security|4s_public_key_in_account_data"):(0,l._t)("settings|security|cross_signing_not_found"))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|secret_storage_status")),o.createElement("td",null,r?(0,l._t)("settings|security|secret_storage_ready"):(0,l._t)("settings|security|secret_storage_not_ready"))),p),u),v)}}const Kb="e2ee.manuallyVerifyAllSessions",qb=()=>o.createElement(Xs.ZP,{heading:(0,l._t)("settings|security|encryption_section")},o.createElement(Ob.Z,{name:Kb,level:U.R.DEVICE}),o.createElement(Xs.po,null,(0,l._t)("settings|security|encryption_individual_verification_mode")));class $b extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onExportE2eKeysClicked",(()=>{T.ZP.createDialogAsync(i.e(3875).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx")),{matrixClient:E.p.safeGet()})})),(0,k.Z)(this,"onImportE2eKeysClicked",(()=>{T.ZP.createDialogAsync(i.e(5433).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/security/ImportE2eKeysDialog.tsx")),{matrixClient:E.p.safeGet()})})),(0,k.Z)(this,"updateBlacklistDevicesFlag",(e=>{E.p.safeGet().setGlobalBlacklistUnverifiedDevices(e)}))}render(){const e=E.p.safeGet(),t=e.deviceId;let i,n,s=e.getDeviceEd25519Key();return s=s?It.Mw(s):(0,l._t)("encryption|not_supported"),e.isCryptoEnabled()&&(i=o.createElement("div",{className:"mx_CryptographyPanel_importExportButtons"},o.createElement(ae.Z,{kind:"primary",onClick:this.onExportE2eKeysClicked},(0,l._t)("settings|security|export_megolm_keys")),o.createElement(ae.Z,{kind:"primary",onClick:this.onImportE2eKeysClicked},(0,l._t)("settings|security|import_megolm_keys")))),L.C.isEnabled("blacklistUnverifiedDevices")&&(n=o.createElement(Ob.Z,{name:"blacklistUnverifiedDevices",level:U.R.DEVICE,onChange:this.updateBlacklistDevicesFlag})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|security|cryptography_section")},o.createElement(Xs.po,null,o.createElement("table",{className:"mx_CryptographyPanel_sessionInfo"},o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|session_id")),o.createElement("td",null,o.createElement("code",null,t))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|session_key")),o.createElement("td",null,o.createElement("code",null,o.createElement("b",null,s)))))),i,n)}}class Jb extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"onConfirm",(()=>{this.props.onFinished(!0)})),(0,k.Z)(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return o.createElement(q.Z,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,l._t)("encryption|destroy_cross_signing_dialog|title")},o.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},o.createElement("p",null,(0,l._t)("encryption|destroy_cross_signing_dialog|warning"))),o.createElement(gt.Z,{primaryButton:(0,l._t)("encryption|destroy_cross_signing_dialog|primary_button_text"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:(0,l._t)("action|cancel"),onCancel:this.onDecline}))}}class Yb extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"onAccountData",(e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this.getUpdatedStatus()})),(0,k.Z)(this,"onBootstrapClick",(()=>{this.state.crossSigningPrivateKeysInStorage?T.ZP.createDialog(de,{},void 0,!1,!0):(0,ee.zL)()})),(0,k.Z)(this,"onStatusChanged",(()=>{this.getUpdatedStatus()})),(0,k.Z)(this,"bootstrapCrossSigning",(async({forceReset:e=!1})=>{this.setState({error:!1});try{const t=E.p.safeGet();await t.bootstrapCrossSigning({authUploadDeviceSigningKeys:async e=>{const{finished:i}=T.ZP.createDialog(te.Z,{title:(0,l._t)("encryption|bootstrap_title"),matrixClient:t,makeRequest:e}),[n]=await i;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:e})}catch(e){this.setState({error:!0}),r.k.error("Error bootstrapping cross-signing",e)}this.unmounted||this.getUpdatedStatus()})),(0,k.Z)(this,"resetCrossSigning",(()=>{T.ZP.createDialog(Jb,{onFinished:e=>{e&&this.bootstrapCrossSigning({forceReset:!0})}})})),this.state={error:!1}}componentDidMount(){const e=E.p.safeGet();e.on(n.ClientEvent.AccountData,this.onAccountData),e.on(j.qG.UserTrustStatusChanged,this.onStatusChanged),e.on(j.qG.KeysChanged,this.onStatusChanged),this.getUpdatedStatus()}componentWillUnmount(){this.unmounted=!0;const e=E.p.get();e&&(e.removeListener(n.ClientEvent.AccountData,this.onAccountData),e.removeListener(j.qG.UserTrustStatusChanged,this.onStatusChanged),e.removeListener(j.qG.KeysChanged,this.onStatusChanged))}async getUpdatedStatus(){const e=E.p.safeGet(),t=e.getCrypto();if(!t)return;const i=await t.getCrossSigningStatus(),n=i.publicKeysOnDevice,s=i.privateKeysInSecretStorage,o=i.privateKeysCachedLocally.masterKey,a=i.privateKeysCachedLocally.selfSigningKey,r=i.privateKeysCachedLocally.userSigningKey,l=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),c=await t.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:n,crossSigningPrivateKeysInStorage:s,masterPrivateKeyCached:o,selfSigningPrivateKeyCached:a,userSigningPrivateKeyCached:r,homeserverSupportsCrossSigning:l,crossSigningReady:c})}render(){const{error:e,crossSigningPublicKeysOnDevice:t,crossSigningPrivateKeysInStorage:i,masterPrivateKeyCached:n,selfSigningPrivateKeyCached:s,userSigningPrivateKeyCached:a,homeserverSupportsCrossSigning:r,crossSigningReady:c}=this.state;let d,m;e&&(d=o.createElement("div",{className:"error"},e.toString())),m=void 0===r?o.createElement(re.Z,null):r?c&&i?o.createElement(Xs.po,{"data-testid":"summarised-status"},"â ",(0,l._t)("encryption|cross_signing_ready")):c&&!i?o.createElement(Xs.po,{"data-testid":"summarised-status"},"â ï¸ ",(0,l._t)("encryption|cross_signing_ready_no_backup")):i?o.createElement(Xs.po,{"data-testid":"summarised-status"},(0,l._t)("encryption|cross_signing_untrusted")):o.createElement(Xs.po,{"data-testid":"summarised-status"},(0,l._t)("encryption|cross_signing_not_ready")):o.createElement(Xs.po,{"data-testid":"summarised-status"},(0,l._t)("encryption|cross_signing_unsupported"));const h=t||i||n||s||a,p=[];if(!(t&&i&&n&&s&&a)&&r){let e=(0,l._t)("encryption|set_up_toast_title");i&&(e=(0,l._t)("encryption|verify_toast_title")),p.push(o.createElement(ae.Z,{key:"setup",kind:"primary",onClick:this.onBootstrapClick},e))}let u;return h&&p.push(o.createElement(ae.Z,{key:"reset",kind:"danger",onClick:this.resetCrossSigning},(0,l._t)("action|reset"))),p.length&&(u=o.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},p)),o.createElement(o.Fragment,null,m,o.createElement("details",null,o.createElement("summary",{className:"mx_CrossSigningPanel_advanced"},(0,l._t)("common|advanced")),o.createElement("table",{className:"mx_CrossSigningPanel_statusList"},o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_public_keys")),o.createElement("td",null,t?(0,l._t)("settings|security|cross_signing_in_memory"):(0,l._t)("settings|security|cross_signing_not_found"))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_private_keys")),o.createElement("td",null,i?(0,l._t)("settings|security|cross_signing_in_4s"):(0,l._t)("settings|security|cross_signing_not_in_4s"))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_master_private_Key")),o.createElement("td",null,n?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_self_signing_private_key")),o.createElement("td",null,s?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_user_signing_private_key")),o.createElement("td",null,a?(0,l._t)("settings|security|cross_signing_cached"):(0,l._t)("settings|security|cross_signing_not_cached"))),o.createElement("tr",null,o.createElement("th",{scope:"row"},(0,l._t)("settings|security|cross_signing_homeserver_support")),o.createElement("td",null,r?(0,l._t)("settings|security|cross_signing_homeserver_support_exists"):(0,l._t)("settings|security|cross_signing_not_found"))))),d,u)}}class Qb extends o.PureComponent{render(){return o.createElement(q.Z,{hasCancel:!0,onFinished:this.props.onFinished.bind(null,!1),title:(0,l._t)("seshat|reset_title")},o.createElement("div",null,o.createElement("p",null,(0,l._t)("seshat|reset_description"),o.createElement("br",null),(0,l._t)("seshat|reset_explainer"))),o.createElement(gt.Z,{primaryButton:(0,l._t)("seshat|reset_button"),onPrimaryButtonClick:this.props.onFinished.bind(null,!0),primaryButtonClass:"danger",cancelButton:(0,l._t)("action|cancel"),onCancel:this.props.onFinished.bind(null,!1)}))}}class Xb extends o.Component{constructor(e){super(e),(0,k.Z)(this,"updateCurrentRoom",(async()=>{const e=b.Z.get(),t=await(null==e?void 0:e.getStats().catch((()=>{})));t&&this.setState({eventIndexSize:t.size,roomCount:t.roomCount})})),(0,k.Z)(this,"onManage",(async()=>{T.ZP.createDialogAsync(i.e(1939).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/eventindex/ManageEventIndexDialog.tsx")),{onFinished:()=>{}},null,!1,!0)})),(0,k.Z)(this,"onEnable",(async()=>{var e,t;this.setState({enabling:!0}),await b.Z.initEventIndex(),await(null===(e=b.Z.get())||void 0===e?void 0:e.addInitialCheckpoints()),null===(t=b.Z.get())||void 0===t||t.startCrawler(),await L.C.setValue("enableEventIndexing",null,U.R.DEVICE,!0),await this.updateState()})),(0,k.Z)(this,"confirmEventStoreReset",(()=>{const{close:e}=T.ZP.createDialog(Qb,{onFinished:async t=>{t&&(await L.C.setValue("enableEventIndexing",null,U.R.DEVICE,!1),await b.Z.deleteEventIndex(),await this.onEnable(),e())}})})),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:L.C.getValueAt(U.R.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=b.Z.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}componentDidMount(){this.updateState()}async updateState(){const e=b.Z.get(),t=L.C.getValueAt(U.R.DEVICE,"enableEventIndexing");let i=0,n=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);const t=await e.getStats().catch((()=>{}));t&&(i=t.size,n=t.roomCount)}this.setState({enabling:!1,eventIndexSize:i,roomCount:n,eventIndexingEnabled:t})}render(){let e;const t=c.ZP.get().brand;if(null!==b.Z.get())e=o.createElement(o.Fragment,null,o.createElement(Xs.po,null,(0,l._t)("settings|security|message_search_enabled",{size:(0,It.td)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:(0,It.O1)(this.state.roomCount)})),o.createElement(ae.Z,{kind:"primary",onClick:this.onManage},(0,l._t)("action|manage")));else if(!this.state.eventIndexingEnabled&&b.Z.supportIsInstalled())e=o.createElement(o.Fragment,null,o.createElement(Xs.po,null,(0,l._t)("settings|security|message_search_disabled")),o.createElement("div",null,o.createElement(ae.Z,{kind:"primary",disabled:this.state.enabling,onClick:this.onEnable},(0,l._t)("action|enable")),this.state.enabling?o.createElement(_r.Z,null):o.createElement("div",null)));else if(b.Z.platformHasSupport()&&!b.Z.supportIsInstalled()){const i="https://github.com/vector-im/element-desktop/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=o.createElement(Xs.po,null,(0,l._t)("settings|security|message_search_unsupported",{brand:t},{nativeLink:e=>o.createElement(Cl.Z,{href:i,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=b.Z.platformHasSupport()?o.createElement(o.Fragment,null,o.createElement(Xs.po,null,this.state.enabling?o.createElement(_r.Z,null):(0,l._t)("settings|security|message_search_failed")),b.Z.error&&o.createElement(Xs.po,null,o.createElement("details",null,o.createElement("summary",null,(0,l._t)("common|advanced")),o.createElement("code",null,b.Z.error instanceof Error?b.Z.error.message:(0,l._t)("error|unknown")),o.createElement("p",null,o.createElement(ae.Z,{key:"delete",kind:"danger",onClick:this.confirmEventStoreReset},(0,l._t)("action|reset")))))):o.createElement(Xs.po,null,(0,l._t)("settings|security|message_search_unsupported_web",{brand:t},{desktopLink:e=>o.createElement(Cl.Z,{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}}class ew extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"onUnignoreClicked",(()=>{this.props.onUnignored(this.props.userId)}))}render(){const e=`mx_SecurityUserSettingsTab_ignoredUser_${this.props.userId}`;return o.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},o.createElement(ae.Z,{onClick:this.onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},(0,l._t)("action|unignore")),o.createElement("span",{id:e},this.props.userId))}}class tw extends o.Component{constructor(e){super(e),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"onAction",(({action:e})=>{if("ignore_state_changed"===e){const e=E.p.safeGet().getIgnoredUsers(),t=this.state.waitingUnignored.filter((t=>e.includes(t)));this.setState({ignoredUserIds:e,waitingUnignored:t})}})),(0,k.Z)(this,"onMyMembership",((e,t)=>{e.isSpaceRoom()||("invite"===t?this.addInvitedRoom(e):this.state.invitedRoomIds.has(e.roomId)&&this.removeInvitedRoom(e.roomId))})),(0,k.Z)(this,"addInvitedRoom",(e=>{this.setState((({invitedRoomIds:t})=>({invitedRoomIds:new Set(t).add(e.roomId)})))})),(0,k.Z)(this,"removeInvitedRoom",(e=>{this.setState((({invitedRoomIds:t})=>{const i=new Set(t);return i.delete(e),{invitedRoomIds:i}}))})),(0,k.Z)(this,"onUserUnignored",(async e=>{const{ignoredUserIds:t,waitingUnignored:i}=this.state,n=t.filter((e=>!i.includes(e))),s=n.indexOf(e);-1!==s&&(n.splice(s,1),this.setState((({waitingUnignored:t})=>({waitingUnignored:[...t,e]}))),E.p.safeGet().setIgnoredUsers(n))})),(0,k.Z)(this,"getInvitedRooms",(()=>E.p.safeGet().getRooms().filter((e=>e.hasMembershipState(E.p.safeGet().getUserId(),"invite"))))),(0,k.Z)(this,"manageInvites",(async e=>{this.setState({managingInvites:!0});const t=Array.from(this.state.invitedRoomIds),i=E.p.safeGet(),n=e?i.joinRoom.bind(i):i.leave.bind(i);for(let e=0;e<t.length;e++){const i=t[e];await n(i).then((()=>{this.removeInvitedRoom(i)}),(async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await(0,xa._v)(t.retry_after_ms||2500),e--):r.k.warn(t)}))}this.setState({managingInvites:!1})})),(0,k.Z)(this,"onAcceptAllInvitesClicked",(()=>{this.manageInvites(!0)})),(0,k.Z)(this,"onRejectAllInvitesClicked",(()=>{this.manageInvites(!1)}));const t=new Set(this.getInvitedRooms().map((e=>e.roomId)));this.state={ignoredUserIds:E.p.safeGet().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomIds:t}}componentDidMount(){this.dispatcherRef=x.ZP.register(this.onAction),E.p.safeGet().on(n.RoomEvent.MyMembership,this.onMyMembership),E.p.safeGet().getVersions().then((e=>this.setState({versions:e})))}componentWillUnmount(){this.dispatcherRef&&x.ZP.unregister(this.dispatcherRef),E.p.safeGet().removeListener(n.RoomEvent.MyMembership,this.onMyMembership)}renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state,i=null!=t&&t.length?t.map((t=>o.createElement(ew,{userId:t,onUnignored:this.onUserUnignored,key:t,inProgress:e.includes(t)}))):(0,l._t)("settings|security|ignore_users_empty");return o.createElement(Xs.ZP,{heading:(0,l._t)("settings|security|ignore_users_section")},o.createElement(Xs.po,null,i))}renderManageInvites(){const{invitedRoomIds:e}=this.state;return 0===e.size?null:o.createElement(Xs.ZP,{heading:(0,l._t)("settings|security|bulk_options_section")},o.createElement("div",{className:"mx_SecurityUserSettingsTab_bulkOptions"},o.createElement(ae.Z,{onClick:this.onAcceptAllInvitesClicked,kind:"primary",disabled:this.state.managingInvites},(0,l._t)("settings|security|bulk_options_accept_all_invites",{invitedRooms:e.size})),o.createElement(ae.Z,{onClick:this.onRejectAllInvitesClicked,kind:"danger",disabled:this.state.managingInvites},(0,l._t)("settings|security|bulk_options_reject_all_invites",{invitedRooms:e.size})),this.state.managingInvites?o.createElement(_r.Z,null):o.createElement("div",null)))}render(){const e=o.createElement(Xs.ZP,{heading:(0,l._t)("common|secure_backup")},o.createElement(Gb,null)),t=o.createElement(Xs.ZP,{heading:(0,l._t)("settings|security|message_search_section")},o.createElement(Xb,null)),i=o.createElement(Xs.ZP,{heading:(0,l._t)("common|cross_signing")},o.createElement(Yb,null));let n,s,a;if((0,cp.G)(E.p.safeGet())||(n=o.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},(0,l._t)("settings|security|e2ee_default_disabled_warning"))),rt.S.instance.isEnabled()){const e=()=>{vy({primaryButton:(0,l._t)("action|ok"),hasCancel:!1})};s=o.createElement(Qs.Q,{heading:(0,l._t)("common|privacy")},o.createElement(Xs.ZP,{heading:(0,l._t)("common|analytics"),description:(0,l._t)("settings|security|analytics_description")},o.createElement(ae.Z,{kind:"link",onClick:e},(0,l._t)("action|learn_more")),rt.S.instance.isEnabled()&&o.createElement(Ob.Z,{name:"pseudonymousAnalyticsOptIn",level:U.R.ACCOUNT})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|sessions|title")},o.createElement(Ob.Z,{name:"deviceClientInformationOptIn",level:U.R.ACCOUNT})))}if(L.C.getValue(Ye.H.AdvancedSettings)){const e=this.renderIgnoredUsers(),t=this.renderManageInvites(),i=L.C.isEnabled(Kb)?o.createElement(qb,null):null;(e||t||i)&&(a=o.createElement(Qs.Q,{heading:(0,l._t)("common|advanced")},e,t,i))}return o.createElement(Ys.Z,null,n,o.createElement(Qs.Q,{heading:(0,l._t)("settings|security|encryption_section")},e,t,i,o.createElement($b,null)),s,a)}}var iw=i("../matrix-react-sdk/res/img/element-icons/cancel-rounded.svg");const nw=["icon","label","onDeleteClick","disabled"],sw=e=>{let{icon:t,label:i,onDeleteClick:n,disabled:s=!1}=e,a=(0,v.Z)(e,nw);return o.createElement("div",(0,kt.Z)({className:"mx_Tag"},a),null==t?void 0:t(),i,n&&o.createElement(ae.Z,{"aria-label":"Remove",className:"mx_Tag_delete",onClick:n,disabled:s},o.createElement(iw.J,null)))};class ow extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"onInputChange",(e=>{this.setState({newTag:e.target.value})})),(0,k.Z)(this,"onAdd",(e=>{e.preventDefault(),this.state.newTag&&(this.props.onAdd(this.state.newTag),this.setState({newTag:""}))})),this.state={newTag:""}}onRemove(e){this.props.onRemove(e)}render(){return o.createElement("div",{className:yt()("mx_TagComposer",{mx_TagComposer_disabled:this.props.disabled})},o.createElement("form",{className:"mx_TagComposer_input",onSubmit:this.onAdd},o.createElement(Vs.Z,{id:this.props.id?this.props.id+"_field":void 0,value:this.state.newTag,onChange:this.onInputChange,label:this.props.label||(0,l._t)("notifications|keyword"),placeholder:this.props.placeholder||(0,l._t)("notifications|keyword_new"),disabled:this.props.disabled,autoComplete:"off"}),o.createElement(ae.Z,{onClick:this.onAdd,kind:"primary",disabled:this.props.disabled},(0,l._t)("action|add"))),o.createElement("div",{className:"mx_TagComposer_tags",role:"list"},this.props.tags.map(((e,t)=>o.createElement(sw,{label:e,key:e,onDeleteClick:this.onRemove.bind(this,e),disabled:this.props.disabled,role:"listitem"})))))}}var aw=i("../matrix-react-sdk/src/utils/notifications.ts"),rw=i("../matrix-react-sdk/src/components/views/typography/Caption.tsx");function lw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function cw(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?lw(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):lw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var dw=function(e){return e.Loading="loading",e.Ready="ready",e.Persisting="persisting",e.Error="error",e.SavingError="savingError",e}(dw||{}),mw=function(e){return e.Master="master",e.VectorGlobal="vector_global",e.VectorMentions="vector_mentions",e.VectorOther="vector_other",e.Other="other",e}(mw||{});const hw="_keywords",pw=mw.VectorMentions,uw=[n.RuleId.DM,n.RuleId.EncryptedDM,n.RuleId.Message,n.RuleId.EncryptedMessage,n.RuleId.ContainsDisplayName,n.RuleId.ContainsUserName,n.RuleId.AtRoomNotification,n.RuleId.InviteToSelf,n.RuleId.IncomingCall,n.RuleId.SuppressNotices,n.RuleId.Tombstone],gw=[XE.Off,XE.On,XE.Loud],vw=(e,t,i)=>{var n;if(null===(n=i.syncedRuleIds)||void 0===n||!n.length)return;const s=i.syncedRuleIds.reduce(((t,n)=>{if(t===XE.Loud)return t;const s=((e,t)=>{for(const i in t){const n=t[i].find((t=>t.rule_id===e));if(n)return n}})(n,e);if(s){const e=i.ruleToVectorState(s);if(e&&gw.indexOf(e)>gw.indexOf(t))return e}return t}),i.ruleToVectorState(t));return s};class _w extends o.PureComponent{constructor(e){var t;super(e),(0,k.Z)(this,"settingWatchers",void 0),(0,k.Z)(this,"onMasterRuleChanged",(async e=>{this.setState({phase:dw.Persisting});const t=this.state.masterPushRule;try{await E.p.safeGet().setPushRuleEnabled("global",t.kind,t.rule_id,!e),await this.refreshFromServer()}catch(e){this.setState({phase:dw.Error}),r.k.error("Error updating master push rule:",e),this.showSaveError()}})),(0,k.Z)(this,"setSavingError",(e=>{this.setState((({ruleIdsWithError:t})=>({phase:dw.SavingError,ruleIdsWithError:cw(cw({},t),{},{[e]:!0})})))})),(0,k.Z)(this,"updateDeviceNotifications",(async e=>{await L.C.setValue("deviceNotificationsEnabled",null,U.R.DEVICE,e)})),(0,k.Z)(this,"onEmailNotificationsChanged",(async(e,t)=>{this.setState({phase:dw.Persisting});try{if(t)await E.p.safeGet().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:{brand:c.ZP.get().brand},append:!0});else{var i;const t=null===(i=this.state.pushers)||void 0===i?void 0:i.find((t=>"email"===t.kind&&t.pushkey===e));t&&await E.p.safeGet().removePusher(t.pushkey,t.app_id)}await this.refreshFromServer()}catch(e){this.setState({phase:dw.Error}),r.k.error("Error updating email pusher:",e),this.showSaveError()}})),(0,k.Z)(this,"onDesktopNotificationsChanged",(async e=>{await L.C.setValue("notificationsEnabled",null,U.R.DEVICE,e)})),(0,k.Z)(this,"onDesktopShowBodyChanged",(async e=>{await L.C.setValue("notificationBodyEnabled",null,U.R.DEVICE,e)})),(0,k.Z)(this,"onAudioNotificationsChanged",(async e=>{await L.C.setValue("audioNotificationsEnabled",null,U.R.DEVICE,e)})),(0,k.Z)(this,"onRadioChecked",(async(e,t)=>{this.setState((({ruleIdsWithError:t})=>({phase:dw.Persisting,ruleIdsWithError:cw(cw({},t),{},{[e.ruleId]:!1})})));try{const i=E.p.safeGet();if(e.ruleId===hw){if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");for(const e of this.state.vectorKeywordRuleInfo.rules){let n,s;t===XE.On?(1!==e.actions.length&&(s=ey.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===XE.Off&&(n=!0)):t===XE.Loud?(3!==e.actions.length&&(s=ey.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===XE.Off&&(n=!0)):n=!1,s&&await i.setPushRuleActions("global",e.kind,e.rule_id,s),void 0!==n&&await i.setPushRuleEnabled("global",e.kind,e.rule_id,n)}}else{const n=iy[e.ruleId],s=n.vectorStateToActions[t];if(!e.rule)throw new Error("Cannot update rule: push rule data is incomplete.");await sy(i,e.rule.rule_id,e.rule.kind,s),await oy(i,n.syncedRuleIds,s)}await this.refreshFromServer()}catch(t){this.setSavingError(e.ruleId),r.k.error("Error updating push rule:",t)}})),(0,k.Z)(this,"onClearNotificationsClicked",(async()=>{try{this.setState({clearingNotifications:!0});const e=E.p.safeGet();await(0,aw.F6)(e)}finally{this.setState({clearingNotifications:!1})}})),(0,k.Z)(this,"onKeywordAdd",(e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,ni.zs)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:dw.Persisting,vectorKeywordRuleInfo:cw(cw({},this.state.vectorKeywordRuleInfo),{},{rules:[...this.state.vectorKeywordRuleInfo.rules,{pattern:e}]})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),(0,k.Z)(this,"onKeywordRemove",(e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,ni.zs)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:dw.Persisting,vectorKeywordRuleInfo:cw(cw({},this.state.vectorKeywordRuleInfo),{},{rules:this.state.vectorKeywordRuleInfo.rules.filter((t=>t.pattern!==e))})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),this.state={phase:dw.Loading,deviceNotificationsEnabled:null===(t=L.C.getValue("deviceNotificationsEnabled"))||void 0===t||t,desktopNotifications:L.C.getValue("notificationsEnabled"),desktopShowBody:L.C.getValue("notificationBodyEnabled"),audioNotifications:L.C.getValue("audioNotificationsEnabled"),clearingNotifications:!1,ruleIdsWithError:{}},this.settingWatchers=[L.C.watchSetting("notificationsEnabled",null,((...[,,,,e])=>this.setState({desktopNotifications:e}))),L.C.watchSetting("deviceNotificationsEnabled",null,((...[,,,,e])=>{this.setState({deviceNotificationsEnabled:e})})),L.C.watchSetting("notificationBodyEnabled",null,((...[,,,,e])=>this.setState({desktopShowBody:e}))),L.C.watchSetting("audioNotificationsEnabled",null,((...[,,,,e])=>this.setState({audioNotifications:e})))]}get isInhibited(){var e;return!(null===(e=this.state.masterPushRule)||void 0===e||!e.enabled)}componentDidMount(){this.refreshFromServer(),this.refreshFromAccountData()}componentWillUnmount(){this.settingWatchers.forEach((e=>L.C.unwatchSetting(e)))}componentDidUpdate(e,t){this.state.deviceNotificationsEnabled!==t.deviceNotificationsEnabled&&this.persistLocalNotificationSettings(this.state.deviceNotificationsEnabled)}async refreshFromServer(){try{const e=(await Promise.all([this.refreshRules(),this.refreshPushers(),this.refreshThreepids()])).reduce(((e,t)=>Object.assign(t,e)),{});this.setState(cw(cw({},e),{},{phase:dw.Ready}))}catch(e){r.k.error("Error setting up notifications for settings: ",e),this.setState({phase:dw.Error})}}async refreshFromAccountData(){const e=E.p.safeGet(),t=e.getAccountData((0,aw.zr)(e.deviceId));if(t){const e=!t.getContent().is_silenced;await this.updateDeviceNotifications(e)}}persistLocalNotificationSettings(e){const t=E.p.safeGet();return t.setAccountData((0,aw.zr)(t.deviceId),{is_silenced:!e})}async refreshRules(){const e=await E.p.safeGet().getPushRules(),t={[n.RuleId.Master]:mw.Master,[n.RuleId.DM]:mw.VectorGlobal,[n.RuleId.EncryptedDM]:mw.VectorGlobal,[n.RuleId.Message]:mw.VectorGlobal,[n.RuleId.EncryptedMessage]:mw.VectorGlobal,[n.RuleId.ContainsDisplayName]:mw.VectorMentions,[n.RuleId.ContainsUserName]:mw.VectorMentions,[n.RuleId.AtRoomNotification]:mw.VectorMentions,[n.RuleId.InviteToSelf]:mw.VectorOther,[n.RuleId.IncomingCall]:mw.VectorOther,[n.RuleId.SuppressNotices]:mw.VectorOther,[n.RuleId.Tombstone]:mw.VectorOther},i={[mw.Master]:[],[mw.VectorGlobal]:[],[mw.VectorMentions]:[],[mw.VectorOther]:[],[mw.Other]:[]};for(const n in e.global){const o=n;for(const n of e.global[o]){var s;const e=Object.assign(n,{kind:o}),a=null!==(s=t[e.rule_id])&&void 0!==s?s:mw.Other;"."===e.rule_id[0]&&i[a].push(e)}}const o={};if(!(i.master.length>0))throw new Error("Failed to locate a master push rule");o.masterPushRule=i.master[0],o.vectorKeywordRuleInfo=ny.parseContentRules(e),o.vectorPushRules={};const a=[mw.VectorGlobal,mw.VectorMentions,mw.VectorOther];for(const e of a){o.vectorPushRules[e]=[];for(const t of i[e]){const n=iy[t.rule_id],s=n.ruleToVectorState(t);o.vectorPushRules[e].push({ruleId:t.rule_id,rule:t,vectorState:s,syncedVectorState:vw(i,t,n),description:(0,l._t)(n.description)})}o.vectorPushRules[e].sort(((e,t)=>{let i=uw.indexOf(e.ruleId),n=uw.indexOf(t.ruleId);return i<0&&(i=uw.length),n<0&&(n=uw.length),i-n})),e===pw&&o.vectorPushRules[e].push({ruleId:hw,description:(0,l._t)("settings|notifications|messages_containing_keywords"),vectorState:o.vectorKeywordRuleInfo.vectorState})}return o}refreshPushers(){return E.p.safeGet().getPushers()}refreshThreepids(){return E.p.safeGet().getThreePids()}showSaveError(){T.ZP.createDialog(dt.Z,{title:(0,l._t)("settings|notifications|error_saving"),description:(0,l._t)("settings|notifications|error_saving_detail")})}async setKeywords(e,t){try{const i=(0,ne.gP)(Array.from(new Set(e))),s=(0,ne.gP)(Array.from(new Set(t.map((e=>e.pattern))))),o=(0,ne.tX)(s,i);for(const e of o.removed)for(const i of t.filter((t=>t.pattern===e)))await E.p.safeGet().deletePushRule("global",i.kind,i.rule_id);let a=this.state.vectorKeywordRuleInfo.vectorState;if(a===XE.Off){const e=t.length?ey.contentRuleVectorStateKind(t[0]):void 0;a=null!=e?e:XE.On}const r=n.PushRuleKind.ContentSpecific;for(const e of o.added)await E.p.safeGet().addPushRule("global",r,e,{actions:ey.actionsFor(a),pattern:e}),a===XE.Off&&await E.p.safeGet().setPushRuleEnabled("global",r,e,!1);await this.refreshFromServer()}catch(e){this.setState({phase:dw.Error}),r.k.error("Error updating keyword push rules:",e),this.showSaveError()}}renderTopSection(){const e=o.createElement(ho.Z,{"data-testid":"notif-master-switch",value:!this.isInhibited,label:(0,l._t)("settings|notifications|enable_notifications_account"),caption:(0,l._t)("settings|notifications|enable_notifications_account_detail"),onChange:this.onMasterRuleChanged,disabled:this.state.phase===dw.Persisting});if(this.isInhibited)return e;const t=(this.state.threepids||[]).filter((e=>e.medium===n.ThreepidMedium.Email)).map((e=>{var t;return o.createElement(ho.Z,{"data-testid":"notif-email-switch",key:e.address,value:!(null===(t=this.state.pushers)||void 0===t||!t.some((t=>"email"===t.kind&&t.pushkey===e.address))),label:(0,l._t)("settings|notifications|enable_email_notifications",{email:e.address}),onChange:this.onEmailNotificationsChanged.bind(this,e.address),disabled:this.state.phase===dw.Persisting})}));return o.createElement(Xs.ZP,null,e,o.createElement(ho.Z,{"data-testid":"notif-device-switch",value:this.state.deviceNotificationsEnabled,label:(0,l._t)("settings|notifications|enable_notifications_device"),onChange:e=>this.updateDeviceNotifications(e),disabled:this.state.phase===dw.Persisting}),this.state.deviceNotificationsEnabled&&o.createElement(o.Fragment,null,o.createElement(ho.Z,{"data-testid":"notif-setting-notificationsEnabled",value:this.state.desktopNotifications,onChange:this.onDesktopNotificationsChanged,label:(0,l._t)("settings|notifications|enable_desktop_notifications_session"),disabled:this.state.phase===dw.Persisting}),o.createElement(ho.Z,{"data-testid":"notif-setting-notificationBodyEnabled",value:this.state.desktopShowBody,onChange:this.onDesktopShowBodyChanged,label:(0,l._t)("settings|notifications|show_message_desktop_notification"),disabled:this.state.phase===dw.Persisting}),o.createElement(ho.Z,{"data-testid":"notif-setting-audioNotificationsEnabled",value:this.state.audioNotifications,onChange:this.onAudioNotificationsChanged,label:(0,l._t)("settings|notifications|enable_audible_notifications_session"),disabled:this.state.phase===dw.Persisting})),t)}renderCategory(e){var t,i;if(e!==mw.VectorOther&&this.isInhibited)return null;let n,s;if(e===mw.VectorOther&&E.p.safeGet().getRooms().some((e=>e.getUnreadNotificationCount()>0))&&(n=o.createElement(ae.Z,{onClick:this.onClearNotificationsClicked,disabled:this.state.clearingNotifications,kind:"danger",className:"mx_UserNotifSettings_clearNotifsButton","data-testid":"clear-notifications"},(0,l._t)("notifications|mark_all_read"))),e===mw.VectorOther&&this.isInhibited)return n?o.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.createElement("div",null,(0,l._t)("notifications|class_other")),n):null;if(e===mw.VectorMentions){var a;const e=(0,ne.gP)((null===(a=this.state.vectorKeywordRuleInfo)||void 0===a?void 0:a.rules.map((e=>e.pattern)))||[]);s=o.createElement(ow,{tags:e,onAdd:this.onKeywordAdd,onRemove:this.onKeywordRemove,disabled:this.state.phase===dw.Persisting,label:(0,l._t)("notifications|keyword"),placeholder:(0,l._t)("notifications|keyword_new")})}const r={[XE.On]:(0,l._t)("common|on"),[XE.Off]:(0,l._t)("common|off"),[XE.Loud]:(0,l._t)("settings|notifications|noisy")},c=(e,t)=>{var i;return o.createElement(Bs.Z,{key:e.ruleId+t,name:e.ruleId,checked:(null!==(i=e.syncedVectorState)&&void 0!==i?i:e.vectorState)===t,onChange:this.onRadioChecked.bind(this,e,t),disabled:this.state.phase===dw.Persisting,"aria-label":r[t]})},d=null===(t=this.state.vectorPushRules)||void 0===t||null===(i=t[e])||void 0===i?void 0:i.map((t=>o.createElement("fieldset",{key:e+t.ruleId,"data-testid":e+t.ruleId,className:"mx_UserNotifSettings_gridRowContainer"},o.createElement("legend",{className:"mx_UserNotifSettings_gridRowLabel"},t.description),c(t,XE.Off),c(t,XE.On),c(t,XE.Loud),this.state.ruleIdsWithError[t.ruleId]&&o.createElement("div",{className:"mx_UserNotifSettings_gridRowError"},o.createElement(rw.Y,{isError:!0},(0,l._t)("settings|notifications|error_updating"))))));let m;switch(e){case mw.VectorGlobal:m=(0,l._t)("notifications|class_global");break;case mw.VectorMentions:m=(0,l._t)("notifications|mentions_keywords");break;case mw.VectorOther:m=(0,l._t)("notifications|class_other");break;default:throw new Error("Developer error: Unnamed notifications section: "+e)}return o.createElement("div",null,o.createElement("div",{"data-testid":`notif-section-${e}`,className:"mx_UserNotifSettings_grid"},o.createElement(Ny.I,{heading:m}),o.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[XE.Off]),o.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[XE.On]),o.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[XE.Loud]),d),n,s)}renderTargets(){var e;if(this.isInhibited)return null;const t=null===(e=this.state.pushers)||void 0===e?void 0:e.map((e=>o.createElement("tr",{key:e.kind+e.pushkey},o.createElement("td",null,e.app_display_name),o.createElement("td",null,e.device_display_name))));return null!=t&&t.length?o.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.createElement("div",null,(0,l._t)("settings|notifications|push_targets")),o.createElement("table",null,o.createElement("tbody",null,t))):null}render(){return this.state.phase===dw.Loading?o.createElement(re.Z,null):this.state.phase===dw.Error?o.createElement("p",{"data-testid":"error-message"},(0,l._t)("settings|notifications|error_loading")):o.createElement(o.Fragment,null,this.renderTopSection(),this.renderCategory(mw.VectorGlobal),this.renderCategory(mw.VectorMentions),this.renderCategory(mw.VectorOther),this.renderTargets())}}function fw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Ew(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?fw(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function yw(e){const t=new Map;for(const s of Object.values(n.PushRuleKind))for(const n of null!==(i=e.global[s])&&void 0!==i?i:[]){var i;n.rule_id.startsWith(".")&&t.set(n.rule_id,Ew(Ew({},n),{},{kind:s}))}return t}function bw(e,t,i){var s,o;const a={updated:[],added:[],deleted:[]},r=yw(e),l=function(e,t){const i=new Map;i.set(n.RuleId.Master,{rule_id:n.RuleId.Master,kind:n.PushRuleKind.Override,enabled:e.globalMute}),i.set(n.RuleId.EncryptedMessage,{rule_id:n.RuleId.EncryptedMessage,kind:n.PushRuleKind.Underride,enabled:!0,actions:JE.encodeActions({notify:e.defaultLevels.room===u_.OV.AllMessages,highlight:!1})}),i.set(n.RuleId.Message,{rule_id:n.RuleId.Message,kind:n.PushRuleKind.Underride,enabled:!0,actions:JE.encodeActions({notify:e.defaultLevels.room===u_.OV.AllMessages,highlight:!1})}),i.set(n.RuleId.EncryptedDM,{rule_id:n.RuleId.EncryptedDM,kind:n.PushRuleKind.Underride,enabled:!0,actions:JE.encodeActions({notify:e.defaultLevels.dm===u_.OV.AllMessages,highlight:!1,sound:e.sound.people})}),i.set(n.RuleId.DM,{rule_id:n.RuleId.DM,kind:n.PushRuleKind.Underride,enabled:!0,actions:JE.encodeActions({notify:e.defaultLevels.dm===u_.OV.AllMessages,highlight:!1,sound:e.sound.people})}),i.set(n.RuleId.SuppressNotices,{rule_id:n.RuleId.SuppressNotices,kind:n.PushRuleKind.Override,enabled:!e.activity.bot_notices,actions:QE.ACTION_DONT_NOTIFY}),i.set(n.RuleId.InviteToSelf,{rule_id:n.RuleId.InviteToSelf,kind:n.PushRuleKind.Override,enabled:e.activity.invite,actions:JE.encodeActions({notify:!0,highlight:!1,sound:e.sound.people})}),i.set(n.RuleId.MemberEvent,{rule_id:n.RuleId.MemberEvent,kind:n.PushRuleKind.Override,enabled:!0,actions:e.activity.status_event?QE.ACTION_NOTIFY:QE.ACTION_DONT_NOTIFY});const s=JE.encodeActions({notify:!0,sound:e.sound.mentions,highlight:!0}),o=e.mentions.user?s:QE.ACTION_DONT_NOTIFY;t&&i.set(n.RuleId.IsUserMention,{rule_id:n.RuleId.IsUserMention,kind:n.PushRuleKind.ContentSpecific,enabled:!0,actions:o}),i.set(n.RuleId.ContainsDisplayName,{rule_id:n.RuleId.ContainsDisplayName,kind:n.PushRuleKind.Override,enabled:!0,actions:o}),i.set(n.RuleId.ContainsUserName,{rule_id:n.RuleId.ContainsUserName,kind:n.PushRuleKind.ContentSpecific,enabled:!0,actions:o});const a=e.mentions.room?QE.ACTION_NOTIFY:QE.ACTION_DONT_NOTIFY;return t&&i.set(n.RuleId.IsRoomMention,{rule_id:n.RuleId.IsRoomMention,kind:n.PushRuleKind.ContentSpecific,enabled:!0,actions:a}),i.set(n.RuleId.AtRoomNotification,{rule_id:n.RuleId.AtRoomNotification,kind:n.PushRuleKind.Override,enabled:!0,actions:a}),i.set(n.RuleId.Tombstone,{rule_id:n.RuleId.Tombstone,kind:n.PushRuleKind.Override,enabled:e.activity.status_event,actions:QE.ACTION_HIGHLIGHT}),i.set(n.RuleId.IncomingCall,{rule_id:n.RuleId.IncomingCall,kind:n.PushRuleKind.Underride,enabled:!0,actions:JE.encodeActions({notify:!0,sound:e.sound.calls})}),i}(t,i);for(const e of l.values()){const t=r.get(e.rule_id);let i=!1;if(void 0===t)i=!0;else if(void 0!==e.enabled&&e.enabled!==t.enabled)i=!0;else if(void 0!==e.actions){const n=JE.decodeActions(t.actions),s=JE.decodeActions(e.actions);null===n||null===s?i=!0:(0,xa.dm)(s,n)||(i=!0)}i&&a.updated.push(e)}const c=JE.encodeActions({notify:!0,sound:t.sound.mentions,highlight:!0}),d=null!==(s=null===(o=e.global.content)||void 0===o?void 0:o.filter((e=>!e.rule_id.startsWith("."))))&&void 0!==s?s:[],m=new Set(t.keywords);for(const e of d){if(m.has(e.pattern)){let i=!1;if(e.enabled!==t.mentions.keywords)i=!0;else if(void 0!==e.actions){const t=JE.decodeActions(e.actions),n=JE.decodeActions(c);null===t||null===n?i=!0:(0,xa.dm)(n,t)||(i=!0)}i&&a.updated.push({rule_id:e.rule_id,kind:n.PushRuleKind.ContentSpecific,enabled:t.mentions.keywords,actions:c})}else a.deleted.push({rule_id:e.rule_id,kind:n.PushRuleKind.ContentSpecific});m.delete(e.pattern)}for(const e of m)a.added.push({rule_id:e,kind:n.PushRuleKind.ContentSpecific,default:!1,enabled:t.mentions.keywords,pattern:e,actions:c});return a}function ww(e){if(0===e.length)return!0;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=JE.decodeActions(t.actions);if(null!==e&&e.notify)return!0}return!1}function Sw(e){if(0===e.length)return!1;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=JE.decodeActions(t.actions);if(null!==e&&!e.notify&&!0!==e.highlight&&void 0===e.sound)return!0}return!1}function Cw(e){for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=JE.decodeActions(t.actions);if(null!==e&&e.notify&&void 0!==e.sound)return e.sound}}function kw(e){const t=function(){const e=(0,o.useRef)(null);return(0,o.useCallback)((t=>{let i;return i=null===e.current?t():e.current.then(t),e.current=i,i}),[])}(),i=(0,o.useMemo)((()=>e.supportsIntentionalMentions()),[e]),s=(0,o.useRef)(null),[a,r]=(0,o.useState)(null),[l,c]=(0,o.useState)(!1),d=(0,o.useCallback)((async()=>{const t=await e.getPushRules(),o=function(e,t){var i,s,o,a;const r=yw(e),l=null!==(i=null===(s=e.global.content)||void 0===s?void 0:s.filter((e=>!e.rule_id.startsWith("."))))&&void 0!==i?i:[],c=[r.get(n.RuleId.DM),r.get(n.RuleId.EncryptedDM)],d=[r.get(n.RuleId.Message),r.get(n.RuleId.EncryptedMessage)];return{globalMute:null!==(o=null===(a=r.get(n.RuleId.Master))||void 0===a?void 0:a.enabled)&&void 0!==o&&o,defaultLevels:{room:ww(d)?u_.OV.AllMessages:u_.OV.MentionsOnly,dm:ww(c)?u_.OV.AllMessages:u_.OV.MentionsOnly},sound:{calls:Cw([r.get(n.RuleId.IncomingCall)]),mentions:Cw([t&&r.get(n.RuleId.IsUserMention),r.get(n.RuleId.ContainsUserName),r.get(n.RuleId.ContainsDisplayName),...l]),people:Cw(c)},activity:{bot_notices:!Sw([r.get(n.RuleId.SuppressNotices)]),invite:ww([r.get(n.RuleId.InviteToSelf)]),status_event:ww([r.get(n.RuleId.MemberEvent),r.get(n.RuleId.Tombstone)])},mentions:{user:ww([t&&r.get(n.RuleId.IsUserMention),r.get(n.RuleId.ContainsUserName),r.get(n.RuleId.ContainsDisplayName)]),room:ww([t&&r.get(n.RuleId.IsRoomMention),r.get(n.RuleId.AtRoomNotification)]),keywords:ww(l)},keywords:l.map((e=>e.pattern))}}(t,i),a=bw(t,o,i);s.current=t,c(a.updated.length>0||a.added.length>0||a.deleted.length>0),r(o)}),[e,i]);(0,o.useEffect)((()=>{t(d).catch((e=>console.error(e)))}),[e,t,d]);const m=(0,o.useCallback)((n=>{r(n),t((async()=>{if(null!==s.current){const t=bw(s.current,n,i);await async function(e,t){await Promise.all(t.deleted.map((t=>e.deletePushRule("global",t.kind,t.rule_id)))),await Promise.all(t.added.map((t=>e.addPushRule("global",t.kind,t.rule_id,t)))),await Promise.all(t.updated.map((async t=>{void 0!==t.enabled&&await e.setPushRuleEnabled("global",t.kind,t.rule_id,t.enabled),void 0!==t.actions&&await e.setPushRuleActions("global",t.kind,t.rule_id,t.actions)})))}(e,t),await d()}})).catch((e=>console.error(e)))}),[t,i,e,d]);return{model:a,hasPendingChanges:l,reconcile:m}}const xw={globalMute:!1,defaultLevels:{room:u_.OV.AllMessages,dm:u_.OV.AllMessages},sound:{people:"default",mentions:"default",calls:"ring"},activity:{invite:!0,status_event:!1,bot_notices:!0},mentions:{user:!0,room:!0,keywords:!0},keywords:[]};function Rw({children:e,icon:t,action:i,onAction:n}){return o.createElement("div",{className:"mx_SettingsBanner"},t,o.createElement("div",{className:"mx_SettingsBanner_content"},e),i&&o.createElement(ae.Z,{kind:"primary_outline",onClick:null!=n?n:null},i))}function Iw(e,t,i){const[n,s]=(0,o.useState)(i),a=(0,o.useCallback)((()=>{let t=!1;return e().then((e=>{t||s(e)})).catch((e=>console.error(e))),()=>{t=!0}}),t);return(0,o.useEffect)(a,[a]),[n,a]}const Pw=["children"],Tw=e=>{let{children:t}=e,i=(0,v.Z)(e,Pw);return o.createElement("div",(0,kt.Z)({},i,{className:"mx_SettingsIndent"}),t)};function Zw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Nw(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Zw(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Zw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Dw(e){return o.createElement(ae.Z,{kind:"link_inline",onClick:()=>{x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.General})}},e)}function Mw(){const e=(0,o.useMemo)((()=>({kind:"email",app_id:"m.email",app_display_name:(0,l._t)("notifications|email_pusher_app_display_name"),lang:navigator.language,data:{brand:c.ZP.get().brand}})),[]),t=(0,pn.wb)(),[i,s]=function(e){return Iw((()=>e.getPushers().then((e=>e.pushers))),[e],[])}(t),[a,r]=function(e){return Iw((()=>e.getThreePids().then((e=>e.threepids))),[e],[])}(t),d=(0,o.useCallback)(((n,o)=>{if(o)t.setPusher(Nw(Nw({},e),{},{pushkey:n,device_display_name:n,append:!0})).catch((e=>console.error(e)));else{const e=i.find((e=>"email"===e.kind&&e.pushkey===n));e&&t.removePusher(e.pushkey,e.app_id).catch((e=>console.error(e)))}r(),s()}),[e,t,i,s,r]),m=i.filter((e=>"email"!==e.kind));return o.createElement(o.Fragment,null,o.createElement(Xs.ZP,{className:"mx_NotificationPusherSettings",heading:(0,l._t)("settings|notifications|email_section")},o.createElement(Xs.po,{className:"mx_NotificationPusherSettings_description"},(0,l._t)("settings|notifications|email_description")),o.createElement("div",{className:"mx_SettingsSubsection_description mx_NotificationPusherSettings_detail"},o.createElement(Xs.po,null,(0,l._t)("settings|notifications|email_select",{},{button:Dw}))),o.createElement(Tw,null,a.filter((e=>e.medium===n.ThreepidMedium.Email)).map((e=>o.createElement(js.Z,{key:e.address,label:e.address,value:void 0!==i.find((t=>t.pushkey===e.address)),onChange:t=>d(e.address,t)}))))),m.length>0&&o.createElement(Xs.ZP,{heading:(0,l._t)("settings|notifications|push_targets")},o.createElement("ul",null,i.filter((e=>"email"!==e.kind)).map((e=>o.createElement("li",{key:e.pushkey},e.device_display_name||e.app_display_name))))))}function Ow(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Aw(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ow(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ow(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var Lw=function(e){return e.AllMessages="all_messages",e.PeopleMentionsKeywords="people_mentions_keywords",e.MentionsKeywords="mentions_keywords",e}(Lw||{});function Uw(e){return o.createElement("strong",null,e)}function Fw(e){return o.createElement(Cl.Z,{href:"https://element.io/help#settings2"},e)}function Bw(){var e;const t=(0,pn.wb)(),i=(0,wt.t)("notificationsEnabled"),n=(0,wt.t)("notificationBodyEnabled"),s=(0,wt.t)("audioNotificationsEnabled"),{model:a,hasPendingChanges:r,reconcile:c}=kw(t),d=null===a||r,m=null!=a?a:xw,[h,p]=(0,o.useState)(!1),u=(0,pn.wb)().getRooms().some((e=>e.getUnreadNotificationCount()>0)),g=[{value:Lw.AllMessages,label:(0,l._t)("notifications|all_messages")},{value:Lw.PeopleMentionsKeywords,label:(0,l._t)("settings|notifications|people_mentions_keywords")},{value:Lw.MentionsKeywords,label:(0,l._t)("settings|notifications|mentions_keywords_only")}];return o.createElement("div",{className:"mx_NotificationSettings2"},r&&null!==a&&o.createElement(Rw,{icon:o.createElement("img",{src:"img/element-icons/new-and-improved.8a4831c.svg",alt:"",width:12}),action:(0,l._t)("action|proceed"),onAction:()=>c(a)},(0,l._t)("settings|notifications|labs_notice_prompt",{},{strong:Uw,a:Fw})),o.createElement(Qs.Q,{heading:(0,l._t)("notifications|enable_prompt_toast_title")},o.createElement("div",{className:"mx_SettingsSubsection_content mx_NotificationSettings2_flags"},o.createElement(ho.Z,{label:(0,l._t)("settings|notifications|enable_notifications_account"),value:!m.globalMute,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{globalMute:!e}))}}),o.createElement(ho.Z,{label:(0,l._t)("settings|notifications|enable_desktop_notifications_session"),value:i,onChange:e=>L.C.setValue("notificationsEnabled",null,U.R.DEVICE,e)}),o.createElement(ho.Z,{label:(0,l._t)("settings|notifications|desktop_notification_message_preview"),value:n,onChange:e=>L.C.setValue("notificationBodyEnabled",null,U.R.DEVICE,e)}),o.createElement(ho.Z,{label:(0,l._t)("settings|notifications|enable_audible_notifications_session"),value:s,onChange:e=>L.C.setValue("audioNotificationsEnabled",null,U.R.DEVICE,e)})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|notifications|default_setting_section"),description:(0,l._t)("settings|notifications|default_setting_description")},o.createElement(sl.Z,{name:"defaultNotificationLevel",value:(v=m.defaultLevels,v.room===u_.OV.AllMessages?Lw.AllMessages:v.dm===u_.OV.AllMessages?Lw.PeopleMentionsKeywords:Lw.MentionsKeywords),disabled:d,definitions:g,onChange:e=>{c(Aw(Aw({},a),{},{defaultLevels:Aw(Aw({},a.defaultLevels),{},{dm:e!==Lw.MentionsKeywords?u_.OV.AllMessages:u_.OV.MentionsOnly,room:e===Lw.AllMessages?u_.OV.AllMessages:u_.OV.MentionsOnly})}))}})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|notifications|play_sound_for_section"),description:(0,l._t)("settings|notifications|play_sound_for_description")},o.createElement(js.Z,{label:"People",value:void 0!==m.sound.people,disabled:d||m.defaultLevels.dm===u_.OV.MentionsOnly,onChange:e=>{c(Aw(Aw({},a),{},{sound:Aw(Aw({},a.sound),{},{people:e?"default":void 0})}))}}),o.createElement(js.Z,{label:(0,l._t)("settings|notifications|mentions_keywords"),value:void 0!==m.sound.mentions,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{sound:Aw(Aw({},a.sound),{},{mentions:e?"default":void 0})}))}}),o.createElement(js.Z,{label:(0,l._t)("settings|notifications|voip"),value:void 0!==m.sound.calls,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{sound:Aw(Aw({},a.sound),{},{calls:e?"ring":void 0})}))}})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|notifications|other_section")},o.createElement(js.Z,{label:(0,l._t)("settings|notifications|invites"),value:m.activity.invite,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{activity:Aw(Aw({},a.activity),{},{invite:e})}))}}),o.createElement(js.Z,{label:(0,l._t)("settings|notifications|room_activity"),value:m.activity.status_event,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{activity:Aw(Aw({},a.activity),{},{status_event:e})}))}}),o.createElement(js.Z,{label:(0,l._t)("settings|notifications|notices"),value:m.activity.bot_notices,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{activity:Aw(Aw({},a.activity),{},{bot_notices:e})}))}})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|notifications|mentions_keywords"),description:(0,l._t)("settings|notifications|keywords",{},{badge:o.createElement(Gn.N,{symbol:"1",count:1,color:Sr.v.Grey})})},o.createElement(js.Z,{label:(0,l._t)("settings|notifications|notify_at_room"),value:m.mentions.room,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{mentions:Aw(Aw({},a.mentions),{},{room:e})}))}}),o.createElement(js.Z,{label:(0,l._t)("settings|notifications|notify_mention",{mxid:t.getUserId()}),value:m.mentions.user,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{mentions:Aw(Aw({},a.mentions),{},{user:e})}))}}),o.createElement(js.Z,{label:(0,l._t)("settings|notifications|notify_keyword"),byline:(0,l._t)("settings|notifications|keywords_prompt"),value:m.mentions.keywords,disabled:d,onChange:e=>{c(Aw(Aw({},a),{},{mentions:Aw(Aw({},a.mentions),{},{keywords:e})}))}}),o.createElement(ow,{id:"mx_NotificationSettings2_Keywords",tags:null!==(e=null==a?void 0:a.keywords)&&void 0!==e?e:[],disabled:d,onAdd:e=>{c(Aw(Aw({},a),{},{keywords:[e,...a.keywords]}))},onRemove:e=>{c(Aw(Aw({},a),{},{keywords:a.keywords.filter((t=>t!==e))}))},label:(0,l._t)("notifications|keyword"),placeholder:(0,l._t)("notifications|keyword_new")})),o.createElement(Mw,null),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|notifications|quick_actions_section")},u&&o.createElement(ae.Z,{kind:"primary_outline",disabled:h,onClick:async()=>{p(!0),await(0,aw.F6)(t),p(!1)}},(0,l._t)("settings|notifications|quick_actions_mark_all_read")),o.createElement(ae.Z,{kind:"danger_outline",disabled:null===a,onClick:()=>{c(xw)}},(0,l._t)("settings|notifications|quick_actions_reset")))));var v}class Vw extends o.Component{render(){const e=L.C.getValue(mg.AN.NotificationSettings2);return o.createElement(Ys.Z,null,e?o.createElement(Bw,null):o.createElement(Qs.Q,{heading:(0,l._t)("notifications|enable_prompt_toast_title")},o.createElement(_w,null)))}}class jw extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onAutocompleteDelayChange",(e=>{this.setState({autocompleteDelay:e.target.value}),L.C.setValue("autocompleteDelay",null,U.R.DEVICE,e.target.value)})),(0,k.Z)(this,"onReadMarkerInViewThresholdMs",(e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),L.C.setValue("readMarkerInViewThresholdMs",null,U.R.DEVICE,e.target.value)})),(0,k.Z)(this,"onReadMarkerOutOfViewThresholdMs",(e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),L.C.setValue("readMarkerOutOfViewThresholdMs",null,U.R.DEVICE,e.target.value)})),(0,k.Z)(this,"onKeyboardShortcutsClicked",(()=>{x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.Keyboard})})),this.state={autocompleteDelay:L.C.getValueAt(U.R.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:L.C.getValueAt(U.R.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:L.C.getValueAt(U.R.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}renderGroup(e,t=U.R.ACCOUNT){return e.map((e=>o.createElement(Ob.Z,{key:e,name:e,level:t})))}render(){const e=L.C.getValue("FTUE.useCaseSelection"),t=jw.ROOM_LIST_SETTINGS.filter((t=>"FTUE.userOnboardingButton"!==t||Vd(e)));return o.createElement(Ys.Z,{"data-testid":"mx_PreferencesUserSettingsTab"},o.createElement(Qs.Q,{heading:(0,l._t)("common|preferences")},t.length>0&&o.createElement(Xs.ZP,{heading:(0,l._t)("settings|preferences|room_list_heading")},this.renderGroup(t)),o.createElement(Xs.ZP,{heading:(0,l._t)("common|spaces")},this.renderGroup(jw.SPACES_SETTINGS,U.R.ACCOUNT)),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|preferences|keyboard_heading"),description:(0,l._t)("settings|preferences|keyboard_view_shortcuts_button",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.onKeyboardShortcutsClicked},e)})},this.renderGroup(jw.KEYBINDINGS_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|preferences|time_heading")},this.renderGroup(jw.TIME_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("common|presence"),description:(0,l._t)("settings|preferences|presence_description")},this.renderGroup(jw.PRESENCE_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|preferences|composer_heading")},this.renderGroup(jw.COMPOSER_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|preferences|code_blocks_heading")},this.renderGroup(jw.CODE_BLOCKS_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|preferences|media_heading")},this.renderGroup(jw.IMAGES_AND_VIDEOS_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("common|timeline")},this.renderGroup(jw.TIMELINE_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|preferences|room_directory_heading")},this.renderGroup(jw.ROOM_DIRECTORY_SETTINGS)),o.createElement(Xs.ZP,{heading:(0,l._t)("common|general"),stretchContent:!0},this.renderGroup(jw.GENERAL_SETTINGS),o.createElement(Ob.Z,{name:"Electron.showTrayIcon",level:U.R.PLATFORM,hideIfCannotSet:!0}),o.createElement(Ob.Z,{name:"Electron.enableHardwareAcceleration",level:U.R.PLATFORM,hideIfCannotSet:!0,label:(0,l._t)("settings|preferences|Electron.enableHardwareAcceleration",{appName:c.ZP.get().brand})}),o.createElement(Ob.Z,{name:"Electron.alwaysShowMenuBar",level:U.R.PLATFORM,hideIfCannotSet:!0}),o.createElement(Ob.Z,{name:"Electron.autoLaunch",level:U.R.PLATFORM,hideIfCannotSet:!0}),o.createElement(Ob.Z,{name:"Electron.warnBeforeExit",level:U.R.PLATFORM,hideIfCannotSet:!0}),o.createElement(Vs.Z,{label:(0,l._t)("settings|preferences|autocomplete_delay"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),o.createElement(Vs.Z,{label:(0,l._t)("settings|preferences|rm_lifetime"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),o.createElement(Vs.Z,{label:(0,l._t)("settings|preferences|rm_lifetime_offscreen"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs}))))}}(0,k.Z)(jw,"ROOM_LIST_SETTINGS",["breadcrumbs","FTUE.userOnboardingButton"]),(0,k.Z)(jw,"SPACES_SETTINGS",["Spaces.allRoomsInHome"]),(0,k.Z)(jw,"KEYBINDINGS_SETTINGS",["ctrlFForSearch"]),(0,k.Z)(jw,"PRESENCE_SETTINGS",["sendReadReceipts","sendTypingNotifications"]),(0,k.Z)(jw,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.useMarkdown","MessageComposerInput.suggestEmoji","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.surroundWith","MessageComposerInput.showStickersButton","MessageComposerInput.insertTrailingColon"]),(0,k.Z)(jw,"TIME_SETTINGS",["showTwelveHourTimestamps","alwaysShowTimestamps"]),(0,k.Z)(jw,"CODE_BLOCKS_SETTINGS",["enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers"]),(0,k.Z)(jw,"IMAGES_AND_VIDEOS_SETTINGS",["urlPreviewsEnabled","autoplayGifs","autoplayVideo","showImages"]),(0,k.Z)(jw,"TIMELINE_SETTINGS",["showTypingNotifications","showRedactions","showReadReceipts","showJoinLeaves","showDisplaynameChanges","showChatEffects","showAvatarChanges","Pill.shouldShowPillAvatar","TextualBody.enableBigEmoji","scrollToBottomOnMessageSent","useOnlyCurrentProfiles"]),(0,k.Z)(jw,"ROOM_DIRECTORY_SETTINGS",["SpotlightSearch.showNsfwPublicRooms"]),(0,k.Z)(jw,"GENERAL_SETTINGS",["promptBeforeInviteUnknownUsers"]);var zw=i("../matrix-react-sdk/src/utils/media/requestMediaPermissions.tsx");const Ww=e=>{switch(e){case Ka.C.AudioOutput:return Ka.ZP.getAudioOutput();case Ka.C.AudioInput:return Ka.ZP.getAudioInput();case Ka.C.VideoInput:return Ka.ZP.getVideoInput()}};class Hw extends o.Component{constructor(e){super(e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"refreshMediaDevices",(async e=>{var t;this.setState({mediaDevices:null!==(t=await Ka.ZP.getDevices())&&void 0!==t?t:null,[Ka.C.AudioOutput]:Ww(Ka.C.AudioOutput),[Ka.C.AudioInput]:Ww(Ka.C.AudioInput),[Ka.C.VideoInput]:Ww(Ka.C.VideoInput)}),e&&e.getTracks().forEach((e=>e.stop()))})),(0,k.Z)(this,"requestMediaPermissions",(async()=>{const e=await(0,zw.T)();e&&await this.refreshMediaDevices(e)})),(0,k.Z)(this,"setDevice",(async(e,t)=>{this.setState({[t]:e});try{await Ka.ZP.instance.setDevice(e,t)}catch(i){r.k.error(`Failed to set device ${t}: ${e}`),this.setState({[t]:Ww(t)})}})),(0,k.Z)(this,"changeWebRtcMethod",(e=>{this.context.setForceTURN(!e)})),(0,k.Z)(this,"changeFallbackICEServerAllowed",(e=>{this.context.setFallbackICEServerAllowed(e)})),this.state={mediaDevices:null,[Ka.C.AudioOutput]:null,[Ka.C.AudioInput]:null,[Ka.C.VideoInput]:null,audioAutoGainControl:Ka.ZP.getAudioAutoGainControl(),audioEchoCancellation:Ka.ZP.getAudioEchoCancellation(),audioNoiseSuppression:Ka.ZP.getAudioNoiseSuppression()}}async componentDidMount(){await Ka.ZP.hasAnyLabeledDevices()&&await this.refreshMediaDevices()}renderDeviceOptions(e,t){return e.map((e=>o.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label)))}renderDropdown(e,t){var i;const n=null===(i=this.state.mediaDevices)||void 0===i?void 0:i[e].slice(0);if(null==n||!n.length)return null;const s=Ka.ZP.getDefaultDevice(n);return o.createElement(Vs.Z,{element:"select",label:t,value:this.state[e]||s,onChange:t=>this.setDevice(t.target.value,e)},this.renderDeviceOptions(n,e))}render(){let e,t,i,n;return this.state.mediaDevices?this.state.mediaDevices&&(t=this.renderDropdown(Ka.C.AudioOutput,(0,l._t)("settings|voip|audio_output"))||o.createElement("p",null,(0,l._t)("settings|voip|audio_output_empty")),i=this.renderDropdown(Ka.C.AudioInput,(0,l._t)("common|microphone"))||o.createElement("p",null,(0,l._t)("settings|voip|audio_input_empty")),n=this.renderDropdown(Ka.C.VideoInput,(0,l._t)("common|camera"))||o.createElement("p",null,(0,l._t)("settings|voip|video_input_empty"))):e=o.createElement("div",null,o.createElement("p",null,(0,l._t)("settings|voip|missing_permissions_prompt")),o.createElement(ae.Z,{onClick:this.requestMediaPermissions,kind:"primary"},(0,l._t)("settings|voip|request_permissions"))),o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("settings|voip|title")},e,o.createElement(Xs.ZP,{heading:(0,l._t)("settings|voip|voice_section"),stretchContent:!0},t,i,o.createElement(ho.Z,{value:this.state.audioAutoGainControl,onChange:async e=>{await Ka.ZP.setAudioAutoGainControl(e),this.setState({audioAutoGainControl:Ka.ZP.getAudioAutoGainControl()})},label:(0,l._t)("settings|voip|voice_agc"),"data-testid":"voice-auto-gain"})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|voip|video_section"),stretchContent:!0},n,o.createElement(Ob.Z,{name:"VideoView.flipVideoHorizontally",level:U.R.ACCOUNT}))),o.createElement(Qs.Q,{heading:(0,l._t)("common|advanced")},o.createElement(Xs.ZP,{heading:(0,l._t)("settings|voip|voice_processing")},o.createElement(ho.Z,{value:this.state.audioNoiseSuppression,onChange:async e=>{await Ka.ZP.setAudioNoiseSuppression(e),this.setState({audioNoiseSuppression:Ka.ZP.getAudioNoiseSuppression()})},label:(0,l._t)("settings|voip|noise_suppression"),"data-testid":"voice-noise-suppression"}),o.createElement(ho.Z,{value:this.state.audioEchoCancellation,onChange:async e=>{await Ka.ZP.setAudioEchoCancellation(e),this.setState({audioEchoCancellation:Ka.ZP.getAudioEchoCancellation()})},label:(0,l._t)("settings|voip|echo_cancellation"),"data-testid":"voice-echo-cancellation"})),o.createElement(Xs.ZP,{heading:(0,l._t)("settings|voip|connection_section")},o.createElement(Ob.Z,{name:"webRtcAllowPeerToPeer",level:U.R.DEVICE,onChange:this.changeWebRtcMethod}),o.createElement(Ob.Z,{name:"fallbackICEServerAllowed",label:(0,l._t)("settings|voip|enable_fallback_ice_server",{server:new URL(xt.hr).pathname}),level:U.R.DEVICE,onChange:this.changeFallbackICEServerAllowed}))))}}(0,k.Z)(Hw,"contextType",pn.ZP);const Gw=["action"];function Kw(){var e;null===(e=a.Z.get())||void 0===e||e.installUpdate()}const qw=[tt.Cr.Ready,tt.Cr.Error,tt.Cr.NotAvailable],$w=()=>{const[e,t]=(0,o.useState)(null);(0,io.P)(x.ZP,(e=>{let{action:i}=e,n=(0,v.Z)(e,Gw);i===W.a.CheckUpdates&&t(n)}));const i=!!e&&!qw.includes(e.status);let n;return e&&(n=o.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case tt.Cr.Error:return(0,l._t)("update|error_encountered",{errorDetail:t});case tt.Cr.Checking:return(0,l._t)("update|checking");case tt.Cr.NotAvailable:return(0,l._t)("update|no_update");case tt.Cr.Downloading:return(0,l._t)("update|downloading");case tt.Cr.Ready:return(0,l._t)("update|new_version_available",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:Kw},e)})}}(e.status,e.detail),i&&o.createElement(_r.Z,null))),o.createElement(o.Fragment,null,o.createElement(ae.Z,{onClick:()=>{var e;t(null),null===(e=a.Z.get())||void 0===e||e.startUpdateCheck()},kind:"primary",disabled:i},(0,l._t)("update|check_action")),n)};var Jw=i("../matrix-react-sdk/src/components/views/elements/CopyableText.tsx");class Yw extends o.Component{constructor(e){super(e),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"onClearCacheAndReload",(()=>{a.Z.get()&&(r.k.log("Clear cache & reload clicked"),this.context.stopClient(),this.context.store.deleteAllData().then((()=>{var e;null===(e=a.Z.get())||void 0===e||e.reload()})))})),(0,k.Z)(this,"onBugReport",(()=>{T.ZP.createDialog(ut.Z,{})})),(0,k.Z)(this,"onStartBotChat",(()=>{this.props.closeSettingsFn(),(0,Us.ZP)(this.context,{dmUserId:c.ZP.get("welcome_user_id"),andView:!0})})),(0,k.Z)(this,"getVersionTextToCopy",(()=>{const{appVersion:e,cryptoVersion:t}=this.getVersionInfo();return`${e}\n${t}`})),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){var e,t;null===(e=a.Z.get())||void 0===e||e.getAppVersion().then((e=>this.setState({appVersion:e}))).catch((e=>{r.k.error("Error getting vector version: ",e)})),null===(t=a.Z.get())||void 0===t||t.canSelfUpdate().then((e=>this.setState({canUpdate:e}))).catch((e=>{r.k.error("Error getting self updatability: ",e)}))}getVersionInfo(){var e,t;const i=c.ZP.get().brand,n=this.state.appVersion||"unknown",s=null!==(e=null===(t=this.context.getCrypto())||void 0===t?void 0:t.getVersion())&&void 0!==e?e:"<not-enabled>";return{appVersion:`${(0,l._t)("setting|help_about|brand_version",{brand:i})} ${n}`,cryptoVersion:`${(0,l._t)("setting|help_about|crypto_version")} ${s}`}}renderLegal(){const e=c.ZP.get().terms_and_conditions_links;if(!e)return null;const t=[];for(const i of e)t.push(o.createElement("div",{key:i.url},o.createElement(Cl.Z,{href:i.url},i.text)));return o.createElement(Xs.ZP,{heading:(0,l._t)("common|legal")},o.createElement(Xs.po,null,t))}renderCredits(){return o.createElement(Xs.ZP,{heading:(0,l._t)("common|credits")},o.createElement(Xs.po,null,o.createElement("ul",null,o.createElement("li",null,(0,l._t)("credits|default_cover_photo",{},{photo:e=>o.createElement(Cl.Z,{href:"themes/element/img/backgrounds/lake.jpg",rel:"noreferrer noopener",target:"_blank"},e),author:e=>o.createElement(Cl.Z,{href:"https://www.flickr.com/golan"},e),terms:e=>o.createElement(Cl.Z,{href:"https://creativecommons.org/licenses/by-sa/4.0/",rel:"noreferrer noopener",target:"_blank"},e)})),o.createElement("li",null,(0,l._t)("credits|twemoji_colr",{},{colr:e=>o.createElement(Cl.Z,{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},e),author:e=>o.createElement(Cl.Z,{href:"https://mozilla.org"},e),terms:e=>o.createElement(Cl.Z,{href:"https://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},e)})),o.createElement("li",null,(0,l._t)("credits|twemoji",{},{twemoji:e=>o.createElement(Cl.Z,{href:"https://twemoji.twitter.com/"},e),author:e=>o.createElement(Cl.Z,{href:"https://twemoji.twitter.com/"},e),terms:e=>o.createElement(Cl.Z,{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},e)})))))}render(){const e=c.ZP.get().brand;let t,i,n=(0,l._t)("setting|help_about|help_link",{brand:e},{a:e=>o.createElement(Cl.Z,{href:c.ZP.get("help_url")},e)});c.ZP.get("welcome_user_id")&&(0,l.Wx)().startsWith("en")&&(n=o.createElement("div",null,(0,l._t)("setting|help_about|help_link_chat_bot",{brand:e},{a:e=>o.createElement(Cl.Z,{href:c.ZP.get("help_url"),rel:"noreferrer noopener",target:"_blank"},e)}),o.createElement("div",null,o.createElement(ae.Z,{onClick:this.onStartBotChat,kind:"primary"},(0,l._t)("setting|help_about|chat_bot",{brand:e}))))),this.state.canUpdate&&(t=o.createElement($w,null)),c.ZP.get().bug_report_endpoint_url&&(i=o.createElement(Xs.ZP,{heading:(0,l._t)("bug_reporting|title"),description:o.createElement(o.Fragment,null,o.createElement(Xs.po,null,(0,l._t)("bug_reporting|introduction")),(0,l._t)("bug_reporting|description"))},o.createElement(ae.Z,{onClick:this.onBugReport,kind:"primary"},(0,l._t)("bug_reporting|submit_debug_logs")),o.createElement(Xs.po,null,(0,l._t)("bug_reporting|matrix_security_issue",{},{a:e=>o.createElement(Cl.Z,{href:"https://matrix.org/security-disclosure-policy/"},e)}))));const{appVersion:s,cryptoVersion:a}=this.getVersionInfo();return o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("setting|help_about|title")},i,o.createElement(Xs.ZP,{heading:(0,l._t)("common|faq"),description:n}),o.createElement(Xs.ZP,{heading:(0,l._t)("setting|help_about|versions")},o.createElement(Xs.po,null,o.createElement(Jw.Z,{getTextToCopy:this.getVersionTextToCopy},s,o.createElement("br",null),a,o.createElement("br",null)),t)),this.renderLegal(),this.renderCredits(),o.createElement(Xs.ZP,{heading:(0,l._t)("common|advanced")},o.createElement(Xs.po,null,(0,l._t)("setting|help_about|homeserver",{homeserverUrl:this.context.getHomeserverUrl()},{code:e=>o.createElement("code",null,e)})),this.context.getIdentityServerUrl()&&o.createElement(Xs.po,null,(0,l._t)("setting|help_about|identity_server",{identityServerUrl:this.context.getIdentityServerUrl()},{code:e=>o.createElement("code",null,e)})),o.createElement(Xs.po,null,o.createElement("details",null,o.createElement("summary",{className:"mx_HelpUserSettingsTab_accessTokenDetails"},(0,l._t)("common|access_token")),o.createElement("b",null,(0,l._t)("setting|help_about|access_token_detail")),o.createElement(Jw.Z,{getTextToCopy:()=>this.context.getAccessToken()},this.context.getAccessToken()))),o.createElement(ae.Z,{onClick:this.onClearCacheAndReload,kind:"danger"},(0,l._t)("setting|help_about|clear_cache_reload")))))}}(0,k.Z)(Yw,"contextType",pn.ZP);var Qw=i("../matrix-react-sdk/src/mjolnir/BanList.ts");class Xw extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onPersonalRuleChanged",(e=>{this.setState({newPersonalRule:e.target.value})})),(0,k.Z)(this,"onNewListChanged",(e=>{this.setState({newList:e.target.value})})),(0,k.Z)(this,"onAddPersonalRule",(async e=>{e.preventDefault(),e.stopPropagation();let t=Qw.lV;this.state.newPersonalRule.startsWith("@")&&(t=Qw.Os),this.setState({busy:!0});try{const e=await V.x.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,(0,l._t)("labs_mjolnir|ban_reason")),this.setState({newPersonalRule:""})}catch(e){r.k.error(e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("labs_mjolnir|error_adding_ignore"),description:(0,l._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}})),(0,k.Z)(this,"onSubscribeList",(async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await E.p.safeGet().joinRoom(this.state.newList);await V.x.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){r.k.error(e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("labs_mjolnir|error_adding_list_title"),description:(0,l._t)("labs_mjolnir|error_adding_list_description")})}finally{this.setState({busy:!1})}})),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=V.x.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){r.k.error(e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("labs_mjolnir|error_removing_ignore"),description:(0,l._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await V.x.sharedInstance().unsubscribeFromList(e.roomId),await E.p.safeGet().leave(e.roomId)}catch(e){r.k.error(e),T.ZP.createDialog(dt.Z,{title:(0,l._t)("labs_mjolnir|error_removing_list_title"),description:(0,l._t)("labs_mjolnir|error_removing_list_description")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=E.p.safeGet().getRoom(e.roomId),i=t?t.name:e.roomId,n=e=>{if(0===e.length)return o.createElement("i",null,(0,l._t)("labs_mjolnir|rules_empty"));const t=[];for(const i of e)t.push(o.createElement("li",{key:i.kind+i.entity},o.createElement("code",null,i.entity)));return o.createElement("ul",null,t)};T.ZP.createDialog(mt.Z,{title:(0,l._t)("labs_mjolnir|rules_title",{roomName:i}),description:o.createElement("div",null,o.createElement("h3",null,(0,l._t)("labs_mjolnir|rules_server")),n(e.serverRules),o.createElement("h3",null,(0,l._t)("labs_mjolnir|rules_user")),n(e.userRules)),button:(0,l._t)("action|close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=V.x.sharedInstance().getPersonalList(),t=e?[...e.userRules,...e.serverRules]:[];if(!e||t.length<=0)return o.createElement("i",null,(0,l._t)("labs_mjolnir|personal_empty"));const i=[];for(const e of t)i.push(o.createElement("li",{key:e.entity,className:"mx_MjolnirUserSettingsTab_listItem"},o.createElement(ae.Z,{kind:"danger_sm",onClick:()=>this.removePersonalRule(e),disabled:this.state.busy},(0,l._t)("action|remove")),"Â ",o.createElement("code",null,e.entity)));return o.createElement("div",null,o.createElement("p",null,(0,l._t)("labs_mjolnir|personal_section")),o.createElement("ul",null,i))}renderSubscribedBanLists(){const e=V.x.sharedInstance().getPersonalList(),t=V.x.sharedInstance().lists.filter((t=>!e||e.roomId!==t.roomId));if(!t||t.length<=0)return o.createElement("i",null,(0,l._t)("labs_mjolnir|no_lists"));const i=[];for(const e of t){const t=E.p.safeGet().getRoom(e.roomId),n=t?o.createElement("span",null,t.name," (",o.createElement("code",null,e.roomId),")"):o.createElement("code",null,"list.roomId");i.push(o.createElement("li",{key:e.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},o.createElement(ae.Z,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(e),disabled:this.state.busy},(0,l._t)("action|unsubscribe")),"Â ",o.createElement(ae.Z,{kind:"primary_sm",onClick:()=>this.viewListRules(e),disabled:this.state.busy},(0,l._t)("labs_mjolnir|view_rules")),"Â ",n))}return o.createElement("div",null,o.createElement("p",null,(0,l._t)("labs_mjolnir|lists")),o.createElement("ul",null,i))}render(){const e=c.ZP.get().brand;return o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("labs_mjolnir|title")},o.createElement(Xs.po,null,o.createElement("span",{className:"warning"},(0,l._t)("labs_mjolnir|advanced_warning")),o.createElement("p",null,(0,l._t)("labs_mjolnir|explainer_1",{brand:e},{code:e=>o.createElement("code",null,e)})),o.createElement("p",null,(0,l._t)("labs_mjolnir|explainer_2"))),o.createElement(Xs.ZP,{heading:(0,l._t)("labs_mjolnir|personal_heading"),description:(0,l._t)("labs_mjolnir|personal_description",{myBanList:(0,l._t)("labs_mjolnir|room_name")})},this.renderPersonalBanListRules(),o.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},o.createElement(Vs.Z,{type:"text",label:(0,l._t)("labs_mjolnir|personal_new_label"),placeholder:(0,l._t)("labs_mjolnir|personal_new_placeholder"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),o.createElement(ae.Z,{type:"submit",kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},(0,l._t)("action|ignore")))),o.createElement(Xs.ZP,{heading:(0,l._t)("labs_mjolnir|lists_heading"),description:o.createElement(o.Fragment,null,o.createElement("span",{className:"warning"},(0,l._t)("labs_mjolnir|lists_description_1")),"Â ",o.createElement("span",null,(0,l._t)("labs_mjolnir|lists_description_2")))},this.renderSubscribedBanLists(),o.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},o.createElement(Vs.Z,{type:"text",label:(0,l._t)("labs_mjolnir|lists_new_label"),value:this.state.newList,onChange:this.onNewListChanged}),o.createElement(ae.Z,{type:"submit",kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},(0,l._t)("action|subscribe"))))))}}var eS=i("../matrix-react-sdk/src/accessibility/KeyboardShortcutUtils.ts"),tS=i("../matrix-react-sdk/src/components/views/settings/KeyboardShortcut.tsx");const iS=Object.entries(tn.aA).filter((([e])=>e!==tn.bj.LABS||Lb())),nS=({name:e})=>{const t=(0,eS.ic)(e),i=(0,eS.P9)(e);return t&&i?o.createElement("li",{className:"mx_KeyboardShortcut_shortcutRow"},t,o.createElement(tS.e,{value:i})):null},sS=({categoryName:e,category:t})=>t.categoryLabel?o.createElement(Xs.ZP,{heading:(0,l._t)(t.categoryLabel),key:e},o.createElement("ul",{className:"mx_KeyboardShortcut_shortcutList"},t.settingNames.map((e=>o.createElement(nS,{key:e,name:e}))))):null,oS=()=>o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("settings|keyboard|title")},iS.map((([e,t])=>o.createElement(sS,{key:e,categoryName:e,category:t})))));function aS(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function rS(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?aS(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):aS(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const lS=(e,t)=>{const{name:i,version:n,url:s}=Je(e,t.device_id);return{appName:i,appVersion:n,url:s}};let cS=function(e){return e.Unsupported="Unsupported",e.Default="Default",e}({});const dS=()=>{var e;const t=(0,o.useContext)(ie.f).client,i=t.getDeviceId(),s=t.getSafeUserId(),[a,c]=(0,o.useState)({}),[d,m]=(0,o.useState)([]),[h,p]=(0,o.useState)(new Map),[u,g]=(0,o.useState)(!0),[v,_]=(0,o.useState)(!0),[f,E]=(0,o.useState)();(0,o.useEffect)((()=>{t.doesServerSupportUnstableFeature("org.matrix.msc3881").then((e=>{_(e)}))}),[t]);const y=(0,o.useCallback)((async()=>{g(!0);try{const e=await async function(e){const{devices:t}=await e.getDevices(),i={};for(const s of t)i[s.device_id]=rS(rS(rS({},s),{},{isVerified:await ye(e,s.device_id)},lS(e,s)),ke(s[n.UNSTABLE_MSC3852_LAST_SEEN_UA.name]));return i}(t);c(e);const{pushers:i}=await t.getPushers();m(i);const s=new Map;Object.keys(e).forEach((e=>{const i=`${n.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${e}`,o=t.getAccountData(i);o&&s.set(e,o.getContent())})),p(s),g(!1)}catch(e){404==e.httpStatus?E(cS.Unsupported):(r.k.error("Error loading sessions:",e),E(cS.Default)),g(!1)}}),[t]);(0,o.useEffect)((()=>{y()}),[y]),(0,o.useEffect)((()=>{const e=Object.keys(a);e.length&&((e,t)=>{Array.from(t.store.accountData.values()).forEach((i=>{if(!i.getType().startsWith(Ge))return;const[,n]=i.getType().split(Ge);n&&!e.includes(n)&&t.deleteAccountData(i.getType())}))})(e,t)}),[a,t]),(0,In.x2)(t,j.qG.DevicesUpdated,(e=>{e.includes(s)&&y()})),(0,In.x2)(t,n.ClientEvent.AccountData,(e=>{const t=e.getType();if(t.startsWith(n.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name)){const i=new Map(h),n=t.slice(t.lastIndexOf(".")+1);i.set(n,e.getContent()),p(i)}}));const b=!(null===(e=a[i])||void 0===e||!e.isVerified)&&s?async e=>await t.getCrypto().requestDeviceVerification(s,e):void 0,w=(0,o.useCallback)((async(e,i)=>{const n=a[e];if(i!==(null==n?void 0:n.display_name))try{await t.setDeviceDetails(e,{display_name:i}),await y()}catch(e){throw r.k.error("Error setting device name",e),new Error((0,l._t)("settings|sessions|error_set_name"))}}),[t,a,y]),S=(0,o.useCallback)((async(e,i)=>{try{const s=d.find((t=>t[n.PUSHER_DEVICE_ID.name]===e));s?await t.setPusher(rS(rS({},s),{},{[n.PUSHER_ENABLED.name]:i})):h.has(e)&&await t.setLocalNotificationSettings(e,{is_silenced:!i})}catch(e){throw r.k.error("Error setting pusher state",e),new Error((0,l._t)("settings|sessions|error_pusher_state"))}finally{await y()}}),[t,d,h,y]);return{devices:a,pushers:d,localNotificationSettings:h,currentDeviceId:i,isLoadingDeviceList:u,error:f,requestDeviceVerification:b,refreshDevices:y,saveDeviceName:w,setPushNotifications:S,supportsMSC3881:v}};var mS;function hS(){return hS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},hS.apply(this,arguments)}function pS(e,t){return o.createElement("svg",hS({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),mS||(mS=o.createElement("path",{d:"M4 8.818L7.125 12 14 5",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}var uS=o.forwardRef(pS);const gS=["value","options","selectedLabel","className"],vS=(e,t)=>i=>{const n=e.find((({id:e})=>e===i));return n?t?`${t}: ${n.label}`:n.label:null},_S=e=>{let{value:t,options:i,selectedLabel:n,className:s}=e,a=(0,v.Z)(e,gS);return o.createElement(nl.Z,(0,kt.Z)({},a,{value:t,className:yt()("mx_FilterDropdown",s),getShortOption:vS(i,n)}),i.map((({id:e,label:i,description:n})=>o.createElement("div",{className:"mx_FilterDropdown_option","data-testid":`filter-option-${e}`,key:e},e===t&&o.createElement(uS,{className:"mx_FilterDropdown_optionSelectedIcon"}),o.createElement("span",{className:"mx_FilterDropdown_optionLabel"},i),!!n&&o.createElement("span",{className:"mx_FilterDropdown_optionDescription"},n)))))},fS=["title","description"],ES=e=>{let{title:t,description:i}=e,n=(0,v.Z)(e,fS);return o.createElement(ae.Z,(0,kt.Z)({},n,{kind:"link_inline",onClick:()=>{T.ZP.createDialog(Sl.Z,{title:t,description:i,button:(0,l._t)("action|got_it"),hasCloseButton:!0})},className:"mx_LearnMore_button"}),(0,l._t)("action|learn_more"))},yS=({device:e,saveDeviceName:t,stopEditing:i})=>{const[n,s]=(0,o.useState)(e.display_name||""),[a,r]=(0,o.useState)(!1),[c,d]=(0,o.useState)(null);(0,o.useEffect)((()=>{s(e.display_name||"")}),[e.display_name]);const m=async e=>{r(!0),d(null),e.preventDefault();try{await t(n),i()}catch(e){d((0,l._t)("settings|sessions|error_set_name")),r(!1)}},h=`device-rename-${e.device_id}`,p=`device-rename-description-${e.device_id}`;return o.createElement("form",{"aria-disabled":a,className:"mx_DeviceDetailHeading_renameForm",onSubmit:m,method:"post"},o.createElement("p",{id:h,className:"mx_DeviceDetailHeading_renameFormHeading"},(0,l._t)("settings|sessions|rename_form_heading")),o.createElement("div",null,o.createElement(Vs.Z,{"data-testid":"device-rename-input",type:"text",value:n,autoComplete:"off",onChange:e=>s(e.target.value),autoFocus:!0,disabled:a,"aria-labelledby":h,"aria-describedby":p,className:"mx_DeviceDetailHeading_renameFormInput",maxLength:100}),o.createElement(rw.Y,{id:p},(0,l._t)("settings|sessions|rename_form_caption"),o.createElement(ES,{title:(0,l._t)("settings|sessions|rename_form_learn_more"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("settings|sessions|rename_form_learn_more_description_1")),o.createElement("p",null,(0,l._t)("settings|sessions|rename_form_learn_more_description_2")))}),!!c&&o.createElement("span",{"data-testid":"device-rename-error",className:"mx_DeviceDetailHeading_renameFormError"},c))),o.createElement("div",{className:"mx_DeviceDetailHeading_renameFormButtons"},o.createElement(ae.Z,{onClick:m,kind:"primary","data-testid":"device-rename-submit-cta",disabled:a},(0,l._t)("action|save")),o.createElement(ae.Z,{onClick:i,kind:"secondary","data-testid":"device-rename-cancel-cta",disabled:a},(0,l._t)("action|cancel")),a&&o.createElement(re.Z,{w:16,h:16})))},bS=({device:e,saveDeviceName:t})=>{const[i,n]=(0,o.useState)(!1);return i?o.createElement(yS,{device:e,saveDeviceName:t,stopEditing:()=>n(!1)}):o.createElement("div",{className:"mx_DeviceDetailHeading","data-testid":"device-detail-heading"},o.createElement(ac.Z,{size:"4"},e.display_name||e.device_id),o.createElement(ae.Z,{kind:"link_inline",onClick:()=>n(!0),className:"mx_DeviceDetailHeading_renameCta","data-testid":"device-heading-rename-cta"},(0,l._t)("action|rename")))};var wS;function SS(){return SS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},SS.apply(this,arguments)}function CS(e,t){return o.createElement("svg",SS({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),wS||(wS=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 3.05v6.22C2 15.63 9 17 9 17s7-1.37 7-7.73V3.05L9 1 2 3.05zm9.94 2.47c.19-.18.49-.17.67.02.16.18.16.45.02.63l-4.22 5.11-.03.04c-.28.34-.79.39-1.13.11a.29.29 0 01-.077-.067.912.912 0 00-.023-.023L5.34 9.26c-.2-.24-.18-.6.06-.8.2-.18.49-.18.7-.04l1.57 1.1 4.27-4z",fill:"currentColor"})))}var kS=o.forwardRef(CS);var xS=i("../matrix-react-sdk/res/img/e2e/warning.svg");const RS={[Te.Inactive]:Pe,[Te.Verified]:kS,[Te.Unverified]:xS.J,[Te.Unverifiable]:xS.J},IS=({variation:e})=>{const t=RS[e];return o.createElement("div",{className:yt()("mx_DeviceSecurityCard_icon",e)},o.createElement(t,{height:16,width:16}))},PS=({variation:e,heading:t,description:i,children:n})=>o.createElement("div",{className:"mx_DeviceSecurityCard"},o.createElement(IS,{variation:e}),o.createElement("div",{className:"mx_DeviceSecurityCard_content"},o.createElement("p",{className:"mx_DeviceSecurityCard_heading"},t),o.createElement("p",{className:"mx_DeviceSecurityCard_description"},i),!!n&&o.createElement("div",{className:"mx_DeviceSecurityCard_actions"},n))),TS={[Te.Verified]:{title:(0,l._t)("settings|sessions|verified_sessions"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("settings|sessions|verified_sessions_explainer_1")),o.createElement("p",null,(0,l._t)("settings|sessions|verified_sessions_explainer_2")))},[Te.Unverified]:{title:(0,l._t)("settings|sessions|unverified_sessions"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("settings|sessions|unverified_sessions_explainer_1")),o.createElement("p",null,(0,l._t)("settings|sessions|unverified_sessions_explainer_2")))},[Te.Unverifiable]:{title:(0,l._t)("settings|sessions|unverified_session"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("settings|sessions|unverified_session_explainer_1")),o.createElement("p",null,(0,l._t)("settings|sessions|unverified_session_explainer_2")),o.createElement("p",null,(0,l._t)("settings|sessions|unverified_session_explainer_3")))},[Te.Inactive]:{title:(0,l._t)("settings|sessions|inactive_sessions"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("settings|sessions|inactive_sessions_explainer_1")),o.createElement("p",null,(0,l._t)("settings|sessions|inactive_sessions_explainer_2")))}},ZS=({variation:e})=>{const{title:t,description:i}=TS[e];return o.createElement(ES,{title:t,description:i})},NS=({device:e,isCurrentDevice:t,onVerifyDevice:i})=>{const n=((e,t)=>{if(e.isVerified){const e=t?(0,l._t)("settings|sessions|device_verified_description_current"):(0,l._t)("settings|sessions|device_verified_description");return{variation:Te.Verified,heading:(0,l._t)("settings|sessions|verified_session"),description:o.createElement(o.Fragment,null,e,o.createElement(ZS,{variation:Te.Verified}))}}if(null===e.isVerified)return{variation:Te.Unverified,heading:(0,l._t)("settings|sessions|unverified_session"),description:o.createElement(o.Fragment,null,(0,l._t)("settings|sessions|unverified_session_explainer_1"),o.createElement(ZS,{variation:Te.Unverifiable}))};const i=t?(0,l._t)("settings|sessions|device_unverified_description_current"):(0,l._t)("settings|sessions|device_unverified_description");return{variation:Te.Unverified,heading:(0,l._t)("settings|sessions|unverified_session"),description:o.createElement(o.Fragment,null,i,o.createElement(ZS,{variation:Te.Unverified}))}})(e,t);return o.createElement(PS,n,!1===e.isVerified&&!!i&&o.createElement(ae.Z,{kind:"primary",onClick:i,"data-testid":`verification-status-button-${e.device_id}`},(0,l._t)("settings|sessions|verify_session")))};function DS(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function MS(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?DS(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):DS(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const OS=({device:e,pusher:t,localNotificationSettings:i,isSigningOut:s,onVerifyDevice:a,onSignOutDevice:r,saveDeviceName:c,setPushNotifications:d,supportsMSC3881:m,className:h,isCurrentDevice:p})=>{const u=[{id:"session",values:[{label:(0,l._t)("settings|sessions|session_id"),value:e.device_id},{label:(0,l._t)("settings|sessions|last_activity"),value:e.last_seen_ts&&(0,Oe.p6)(new Date(e.last_seen_ts))}]},{id:"application",heading:(0,l._t)("common|application"),values:[{label:(0,l._t)("common|name"),value:e.appName},{label:(0,l._t)("common|version"),value:e.appVersion},{label:(0,l._t)("settings|sessions|url"),value:e.url}]},{id:"device",heading:(0,l._t)("common|device"),values:[{label:(0,l._t)("common|model"),value:e.deviceModel},{label:(0,l._t)("settings|sessions|os"),value:e.deviceOperatingSystem},{label:(0,l._t)("settings|sessions|browser"),value:e.client},{label:(0,l._t)("settings|sessions|ip"),value:e.last_seen_ip}]}].map((e=>MS(MS({},e),{},{values:e.values.filter((e=>!!e.value))}))).filter((e=>e.values.length)),g=!!t||!!i;return o.createElement("div",{className:yt()("mx_DeviceDetails",h),"data-testid":`device-detail-${e.device_id}`},o.createElement("section",{className:"mx_DeviceDetails_section"},o.createElement(bS,{device:e,saveDeviceName:c}),o.createElement(NS,{device:e,onVerifyDevice:a,isCurrentDevice:!0})),o.createElement("section",{className:"mx_DeviceDetails_section"},o.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,l._t)("settings|sessions|details_heading")),u.map((({heading:e,values:t,id:i},n)=>o.createElement("table",{className:"mx_DeviceDetails_metadataTable",key:n,"data-testid":`device-detail-metadata-${i}`},e&&o.createElement("thead",null,o.createElement("tr",null,o.createElement("th",null,e))),o.createElement("tbody",null,t.map((({label:e,value:t})=>o.createElement("tr",{key:e},o.createElement("td",{className:"mxDeviceDetails_metadataLabel"},e),o.createElement("td",{className:"mxDeviceDetails_metadataValue"},t))))))))),g&&o.createElement("section",{className:"mx_DeviceDetails_section mx_DeviceDetails_pushNotifications","data-testid":"device-detail-push-notification"},o.createElement(Tb.Z,{checked:function(e,t){return e?!!e[n.PUSHER_ENABLED.name]:!i||!i.is_silenced}(t),disabled:function(e,t){return!i&&!(!e||m)}(t),onChange:t=>null==d?void 0:d(e.device_id,t),title:(0,l._t)("settings|sessions|push_toggle"),"data-testid":"device-detail-push-notification-checkbox"}),o.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,l._t)("settings|sessions|push_heading"),o.createElement("small",{className:"mx_DeviceDetails_sectionSubheading"},(0,l._t)("settings|sessions|push_subheading")))),o.createElement("section",{className:"mx_DeviceDetails_section"},o.createElement(ae.Z,{onClick:r,kind:"danger_inline",disabled:s,"data-testid":"device-detail-sign-out-cta"},o.createElement("span",{className:"mx_DeviceDetails_signOutButtonContent"},(0,l._t)("settings|sessions|sign_out"),s&&o.createElement(re.Z,{w:16,h:16})))))};var AS;function LS(){return LS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},LS.apply(this,arguments)}function US(e,t){return o.createElement("svg",LS({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 10 6",role:"presentation","aria-hidden":!0,ref:t},e),AS||(AS=o.createElement("g",{fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeWidth:1.3},o.createElement("path",{d:"M1.5 1.5l3.859 3.254M9.132 1.56L5.359 4.754"}))))}var FS=o.forwardRef(US);const BS=["isExpanded","onClick"],VS=e=>{let{isExpanded:t,onClick:i}=e,n=(0,v.Z)(e,BS);const s=t?(0,l._t)("settings|sessions|hide_details"):(0,l._t)("settings|sessions|show_details");return o.createElement(gs.Z,(0,kt.Z)({},n,{"aria-label":s,title:s,kind:"icon",className:yt()("mx_DeviceExpandDetailsButton",{mx_DeviceExpandDetailsButton_expanded:t}),onClick:i}),o.createElement(FS,{className:"mx_DeviceExpandDetailsButton_icon"}))};var jS;function zS(){return zS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},zS.apply(this,arguments)}function WS(e,t){return o.createElement("svg",zS({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 22 23",role:"presentation","aria-hidden":!0,ref:t},e),jS||(jS=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M11 22.5c6.075 0 11-4.925 11-11S17.075.5 11 .5 0 5.425 0 11.5s4.925 11 11 11zm0-4.24a1.375 1.375 0 100-2.75 1.375 1.375 0 000 2.75zM9.09 9.428A1.91 1.91 0 0111 7.518c1.048 0 1.91.862 1.91 1.91 0 .485-.208.659-1.026 1.224-.363.25-.86.598-1.246 1.108-.415.546-.67 1.227-.67 2.093h2.063c0-.424.113-.666.25-.846.164-.217.402-.4.775-.659l.124-.084c.676-.46 1.792-1.219 1.792-2.836A3.98 3.98 0 0011 5.456a3.972 3.972 0 00-3.973 3.972H9.09z",fill:"currentColor"})))}var HS=o.forwardRef(WS);var GS;function KS(){return KS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},KS.apply(this,arguments)}function qS(e,t){return o.createElement("svg",KS({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 22 19",role:"presentation","aria-hidden":!0,ref:t},e),GS||(GS=o.createElement("path",{d:"M3 15.5c-.55 0-1.02-.196-1.412-.587A1.927 1.927 0 011 13.5v-11c0-.55.196-1.021.588-1.413A1.925 1.925 0 013 .5h16c.55 0 1.021.196 1.413.587.391.392.587.863.587 1.413v11c0 .55-.196 1.021-.587 1.413A1.928 1.928 0 0119 15.5H3zm0-2h16v-11H3v11zm-2 5a.965.965 0 01-.712-.288A.965.965 0 010 17.5c0-.283.096-.52.288-.712A.965.965 0 011 16.5h20c.283 0 .52.096.712.288A.965.965 0 0122 17.5c0 .283-.096.52-.288.712A.965.965 0 0121 18.5H1zm2-5v-11 11z",fill:"currentColor"})))}var $S=o.forwardRef(qS);var JS;function YS(){return YS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},YS.apply(this,arguments)}function QS(e,t){return o.createElement("svg",YS({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 17",role:"presentation","aria-hidden":!0,ref:t},e),JS||(JS=o.createElement("path",{d:"M18 16.5H2c-.55 0-1.02-.196-1.412-.587A1.927 1.927 0 010 14.5v-12c0-.55.196-1.02.588-1.412A1.923 1.923 0 012 .5h16c.55 0 1.021.196 1.413.588.391.391.587.862.587 1.412v12c0 .55-.196 1.021-.587 1.413A1.928 1.928 0 0118 16.5zM2 4.5v10h16v-10H2z",fill:"currentColor"})))}var XS=o.forwardRef(QS);var eC;function tC(){return tC=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},tC.apply(this,arguments)}function iC(e,t){return o.createElement("svg",tC({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 14 23",role:"presentation","aria-hidden":!0,ref:t},e),eC||(eC=o.createElement("path",{d:"M12 .51L2 .5c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-18c0-1.1-.9-1.99-2-1.99zm0 17.99H2v-14h10v14z",fill:"currentColor"})))}var nC=o.forwardRef(iC);const sC={[Se.Desktop]:$S,[Se.Mobile]:nC,[Se.Web]:XS,[Se.Unknown]:HS},oC={[Se.Desktop]:(0,l.I8)("settings|sessions|desktop_session"),[Se.Mobile]:(0,l.I8)("settings|sessions|mobile_session"),[Se.Web]:(0,l.I8)("settings|sessions|web_session"),[Se.Unknown]:(0,l.I8)("settings|sessions|unknown_session")},aC=({isVerified:e,isSelected:t,deviceType:i})=>{const n=sC[i]||sC[Se.Unknown],s=(0,l._t)(oC[i]||oC[Se.Unknown]);return o.createElement("div",{className:yt()("mx_DeviceTypeIcon",{mx_DeviceTypeIcon_selected:t})},o.createElement("div",{className:"mx_DeviceTypeIcon_deviceIconWrapper"},o.createElement(n,{className:"mx_DeviceTypeIcon_deviceIcon",role:"img","aria-label":s})),e?o.createElement(kS,{className:yt()("mx_DeviceTypeIcon_verificationIcon","verified"),role:"img","aria-label":(0,l._t)("common|verified")}):o.createElement(xS.J,{className:yt()("mx_DeviceTypeIcon_verificationIcon","unverified"),role:"img","aria-label":(0,l._t)("common|unverified")}))};var rC=i("../matrix-react-sdk/src/utils/NativeEventUtils.ts");const lC=({device:e})=>o.createElement(ac.Z,{size:"4"},e.display_name||e.device_id),cC=({device:e,children:t,isSelected:i,onClick:n})=>o.createElement("div",{className:yt()("mx_DeviceTile",{mx_DeviceTile_interactive:!!n}),"data-testid":`device-tile-${e.device_id}`,onClick:n},o.createElement(aC,{isVerified:e.isVerified,isSelected:i,deviceType:e.deviceType}),o.createElement("div",{className:"mx_DeviceTile_info"},o.createElement(lC,{device:e}),o.createElement("div",{className:"mx_DeviceTile_metadata"},o.createElement(Ue,{device:e}))),o.createElement("div",{className:"mx_DeviceTile_actions",onClick:(0,rC.D)((()=>{}))},t)),dC=({children:e,device:t,isSelected:i,onSelect:n,onClick:s})=>o.createElement("div",{className:"mx_SelectableDeviceTile"},o.createElement(qs.Z,{kind:qs.C.Solid,checked:i,onChange:n,className:"mx_SelectableDeviceTile_checkbox",id:`device-tile-checkbox-${t.device_id}`,"data-testid":`device-tile-checkbox-${t.device_id}`},o.createElement(cC,{device:t,onClick:s,isSelected:i},e))),mC=["selectedDeviceCount","isAllSelected","isSelectDisabled","toggleSelectAll","children"],hC=e=>{let{selectedDeviceCount:t,isAllSelected:i,isSelectDisabled:n,toggleSelectAll:s,children:a}=e,r=(0,v.Z)(e,mC);const c=i?(0,l._t)("common|deselect_all"):(0,l._t)("common|select_all");return o.createElement("div",(0,kt.Z)({className:"mx_FilteredDeviceListHeader"},r),!n&&o.createElement(fr.Z,{label:c,alignment:si.v.Top},o.createElement(qs.Z,{kind:qs.C.Solid,checked:i,onChange:s,id:"device-select-all-checkbox","data-testid":"device-select-all-checkbox","aria-label":c})),o.createElement("span",{className:"mx_FilteredDeviceListHeader_label"},t>0?(0,l._t)("settings|sessions|n_sessions_selected",{count:t}):(0,l._t)("settings|sessions|title")),a)},pC=(e,t)=>t.includes(e),uC=(e,t)=>(t.last_seen_ts||0)-(e.last_seen_ts||0)||(e.display_name||e.device_id).localeCompare(t.display_name||t.device_id),gC="ALL",vC=({filter:e})=>{if((e=>!!e&&[Te.Inactive,Te.Unverified,Te.Verified].includes(e))(e)){const t={[Te.Verified]:{title:(0,l._t)("settings|sessions|verified_sessions"),description:(0,l._t)("settings|sessions|verified_sessions_list_description")},[Te.Unverified]:{title:(0,l._t)("settings|sessions|unverified_sessions"),description:(0,l._t)("settings|sessions|unverified_sessions_list_description")},[Te.Unverifiable]:{title:(0,l._t)("settings|sessions|unverified_session"),description:(0,l._t)("settings|sessions|unverified_session_explainer_1")},[Te.Inactive]:{title:(0,l._t)("settings|sessions|inactive_sessions"),description:(0,l._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:90})}},{title:i,description:n}=t[e];return o.createElement("div",{className:"mx_FilteredDeviceList_securityCard"},o.createElement(PS,{variation:e,heading:i,description:o.createElement("span",null,n,o.createElement(ZS,{variation:e}))}))}return null},_C=({filter:e,clearFilter:t})=>o.createElement("div",{className:"mx_FilteredDeviceList_noResults"},(e=>{switch(e){case Te.Verified:return(0,l._t)("settings|sessions|no_verified_sessions");case Te.Unverified:return(0,l._t)("settings|sessions|no_unverified_sessions");case Te.Inactive:return(0,l._t)("settings|sessions|no_inactive_sessions");default:return(0,l._t)("settings|sessions|no_sessions")}})(e),!!e&&o.createElement(o.Fragment,null,"Â ",o.createElement(ae.Z,{kind:"link_inline",onClick:t,"data-testid":"devices-clear-filter-btn"},(0,l._t)("action|show_all")))),fC=({device:e,pusher:t,localNotificationSettings:i,isExpanded:n,isSigningOut:s,isSelected:a,onDeviceExpandToggle:r,onSignOutDevice:l,saveDeviceName:c,onRequestDeviceVerification:d,setPushNotifications:m,toggleSelected:h,supportsMSC3881:p,isSelectDisabled:u})=>{const g=o.createElement(o.Fragment,null,s&&o.createElement(re.Z,{w:16,h:16}),o.createElement(VS,{isExpanded:n,onClick:r}));return o.createElement("li",{className:"mx_FilteredDeviceList_listItem"},u?o.createElement(cC,{device:e,onClick:r},g):o.createElement(dC,{isSelected:a,onSelect:h,onClick:r,device:e},g),n&&o.createElement(OS,{device:e,pusher:t,localNotificationSettings:i,isSigningOut:s,onVerifyDevice:d,onSignOutDevice:l,saveDeviceName:c,setPushNotifications:m,supportsMSC3881:p,className:"mx_FilteredDeviceList_deviceDetails"}))},EC=(0,o.forwardRef)((({devices:e,pushers:t,localNotificationSettings:i,filter:s,expandedDeviceIds:a,signingOutDeviceIds:r,selectedDeviceIds:c,onFilterChange:d,onDeviceExpandToggle:m,saveDeviceName:h,onSignOutDevices:p,onRequestDeviceVerification:u,setPushNotifications:g,setSelectedDeviceIds:v,supportsMSC3881:_,disableMultipleSignout:f},E)=>{const y=((e,t)=>Me(Object.values(e),t?[t]:[]).sort(uC))(e,s);function b(e){return t.find((t=>t[n.PUSHER_DEVICE_ID.name]===e.device_id))}const w=[{id:gC,label:(0,l._t)("settings|sessions|filter_all")},{id:Te.Verified,label:(0,l._t)("common|verified"),description:(0,l._t)("settings|sessions|filter_verified_description")},{id:Te.Unverified,label:(0,l._t)("common|unverified"),description:(0,l._t)("settings|sessions|filter_unverified_description")},{id:Te.Inactive,label:(0,l._t)("settings|sessions|filter_inactive"),description:(0,l._t)("settings|sessions|filter_inactive_description",{inactiveAgeDays:90})}],S=c.length>=y.length,C=!!r.length;return o.createElement("div",{className:"mx_FilteredDeviceList",ref:E},o.createElement(hC,{selectedDeviceCount:c.length,isAllSelected:S,toggleSelectAll:()=>{v(S?[]:y.map((e=>e.device_id)))},isSelectDisabled:f},c.length?o.createElement(o.Fragment,null,o.createElement(ae.Z,{"data-testid":"sign-out-selection-cta",kind:"danger_inline",disabled:C,onClick:()=>p(c),className:"mx_FilteredDeviceList_headerButton"},C&&o.createElement(re.Z,{w:16,h:16}),(0,l._t)("action|sign_out")),o.createElement(ae.Z,{"data-testid":"cancel-selection-cta",kind:"content_inline",disabled:C,onClick:()=>v([]),className:"mx_FilteredDeviceList_headerButton"},(0,l._t)("action|cancel"))):o.createElement(_S,{id:"device-list-filter",label:(0,l._t)("settings|sessions|filter_label"),value:s||gC,onOptionChange:e=>{d(e===gC?void 0:e)},options:w,selectedLabel:(0,l._t)("action|show")})),y.length?o.createElement(vC,{filter:s}):o.createElement(_C,{filter:s,clearFilter:()=>d(void 0)}),o.createElement("ol",{className:"mx_FilteredDeviceList_list"},y.map((e=>o.createElement(fC,{key:e.device_id,device:e,pusher:b(e),localNotificationSettings:i.get(e.device_id),isExpanded:a.includes(e.device_id),isSigningOut:r.includes(e.device_id),isSelected:pC(e.device_id,c),isSelectDisabled:f,onDeviceExpandToggle:()=>m(e.device_id),onSignOutDevice:()=>p([e.device_id]),saveDeviceName:t=>h(e.device_id,t),onRequestDeviceVerification:u?()=>u(e.device_id):void 0,setPushNotifications:g,toggleSelected:()=>{return t=e.device_id,void(pC(t,c)?v(c.filter((e=>e!==t))):v([...c,t]));var t},supportsMSC3881:_})))))})),yC=["options","title"],bC=e=>{let{options:t,title:i}=e,n=(0,v.Z)(e,yC);const[s,a,r,l]=(0,ii.av)();return o.createElement(o.Fragment,null,o.createElement(ii.lX,(0,kt.Z)({},n,{onClick:r,title:i,isExpanded:s,inputRef:a}),o.createElement(di,{className:"mx_KebabContextMenu_icon"})),s&&o.createElement(ur.ZP,(0,kt.Z)({onFinished:l,compact:!0,rightAligned:!0,closeOnInteraction:!0},{left:(c=a.current.getBoundingClientRect()).left+window.scrollX+c.width,top:c.bottom+window.scrollY,chevronFace:ii.N7.None}),o.createElement(ur.I2,null,t)));var c},wC=({onSignOutCurrentDevice:e,signOutAllOtherSessions:t,otherSessionsCount:i,disabled:n})=>{const s=[o.createElement(ur.$k,{key:"sign-out",label:(0,l._t)("action|sign_out"),onClick:e,isDestructive:!0}),...t?[o.createElement(ur.$k,{key:"sign-out-all-others",label:(0,l._t)("settings|sessions|sign_out_all_other_sessions",{otherSessionsCount:i}),onClick:t,isDestructive:!0})]:[]];return o.createElement(Ny.I,{heading:(0,l._t)("settings|sessions|current_session")},o.createElement(bC,{disabled:n,title:(0,l._t)("common|options"),options:s,"data-testid":"current-session-menu"}))},SC=({device:e,isLoading:t,isSigningOut:i,localNotificationSettings:n,otherSessionsCount:s,setPushNotifications:a,onVerifyCurrentDevice:r,onSignOutCurrentDevice:l,signOutAllOtherSessions:c,saveDeviceName:d})=>{const[m,h]=(0,o.useState)(!1);return o.createElement(Xs.ZP,{"data-testid":"current-session-section",heading:o.createElement(wC,{onSignOutCurrentDevice:l,signOutAllOtherSessions:c,otherSessionsCount:s,disabled:t||!e||i})},t&&!e&&o.createElement(re.Z,null),!!e&&o.createElement(o.Fragment,null,o.createElement(cC,{device:e,onClick:()=>h(!m)},o.createElement(VS,{"data-testid":"current-session-toggle-details",isExpanded:m,onClick:()=>h(!m)})),m?o.createElement(OS,{device:e,localNotificationSettings:n,setPushNotifications:a,isSigningOut:i,onVerifyDevice:r,onSignOutDevice:l,saveDeviceName:d,className:"mx_CurrentDeviceSection_deviceDetails"}):o.createElement(o.Fragment,null,o.createElement("br",null),o.createElement(NS,{device:e,onVerifyDevice:r,isCurrentDevice:!0}))))},CC=({devices:e,currentDeviceId:t,goToFilteredList:i})=>{const n=Object.values(e),s=Me(n,[Te.Unverified]).filter((e=>e.device_id!==t)).length,a=Me(n,[Te.Inactive]).length;if(!(s|a))return null;return o.createElement(Xs.ZP,{heading:(0,l._t)("settings|sessions|security_recommendations"),description:(0,l._t)("settings|sessions|security_recommendations_description"),"data-testid":"security-recommendations-section"},!!s&&o.createElement(PS,{variation:Te.Unverified,heading:(0,l._t)("settings|sessions|unverified_sessions"),description:o.createElement(o.Fragment,null,(0,l._t)("settings|sessions|unverified_sessions_list_description"),o.createElement(ZS,{variation:Te.Unverified}))},o.createElement(ae.Z,{kind:"link_inline",onClick:()=>i(Te.Unverified),"data-testid":"unverified-devices-cta"},(0,l._t)("action|view_all")+` (${s})`)),!!a&&o.createElement(o.Fragment,null,!!s&&o.createElement("div",{className:"mx_SecurityRecommendations_spacing"}),o.createElement(PS,{variation:Te.Inactive,heading:(0,l._t)("settings|sessions|inactive_sessions"),description:o.createElement(o.Fragment,null,(0,l._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:90}),o.createElement(ZS,{variation:Te.Inactive}))},o.createElement(ae.Z,{kind:"link_inline",onClick:()=>i(Te.Inactive),"data-testid":"inactive-devices-cta"},(0,l._t)("action|view_all")+` (${a})`))))},kC=(e,t)=>async i=>e.deleteMultipleDevices(t,null!=i?i:void 0);class xC extends o.Component{constructor(e){super(e)}render(){var e,t,i,s,a,r;const c=n.GET_LOGIN_TOKEN_CAPABILITY.findIn(this.props.capabilities),d=!(null===(e=this.props.versions)||void 0===e||null===(t=e.unstable_features)||void 0===t||!t["org.matrix.msc3882"])||!(null==c||!c.enabled),m=!(null===(i=this.props.versions)||void 0===i||null===(s=i.unstable_features)||void 0===s||!s["org.matrix.msc3886"])||(null===(a=this.props.wellKnown)||void 0===a||null===(r=a["io.element.rendezvous"])||void 0===r?void 0:r.server);return d&&m?o.createElement(Xs.ZP,{heading:(0,l._t)("settings|sessions|sign_in_with_qr")},o.createElement("div",{className:"mx_LoginWithQRSection"},o.createElement("p",{className:"mx_SettingsTab_subsectionText"},(0,l._t)("settings|sessions|sign_in_with_qr_description")),o.createElement(ae.Z,{onClick:this.props.onShowQr,kind:"primary"},(0,l._t)("settings|sessions|sign_in_with_qr_button")))):null}}var RC=i("./node_modules/matrix-events-sdk/lib/index.js"),IC=i("../matrix-js-sdk/src/client.ts"),PC=i("../matrix-js-sdk/src/feature.ts"),TC=function(e){return e.Start="m.login.start",e.Finish="m.login.finish",e.Progress="m.login.progress",e}(TC||{}),ZC=function(e){return e.Success="success",e.Failure="failure",e.Verified="verified",e.Declined="declined",e.Unsupported="unsupported",e}(ZC||{});const NC=new RC.UnstableValue("login_token","org.matrix.msc3906.login_token");class DC{constructor(e,t,i){this.channel=e,this.client=t,this.onFailure=i,(0,ff.Z)(this,"newDeviceId",void 0),(0,ff.Z)(this,"newDeviceKey",void 0),(0,ff.Z)(this,"ourIntent",AC.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE),(0,ff.Z)(this,"_code",void 0)}get code(){return this._code}async generateCode(){this._code||(this._code=JSON.stringify(await this.channel.generateCode(this.ourIntent)))}async startAfterShowingCode(){const e=await this.channel.connect();r.k.info(`Connected to secure channel with checksum: ${e} our intent is ${this.ourIntent}`);const t=await this.client.getCapabilities(),i=await(0,PC.my)(await this.client.getVersions()),n=IC.Ni.findIn(t);if((null==n||!n.enabled)&&i.get(PC.L0.LoginTokenRequest)===PC.k0.Unsupported)return r.k.info("Server doesn't support get_login_token"),await this.send({type:TC.Finish,outcome:ZC.Unsupported}),void await this.cancel(OC.HomeserverLacksSupport);await this.send({type:TC.Progress,protocols:[NC.name]}),r.k.info("Waiting for other device to chose protocol");const{type:s,protocol:o,outcome:a}=await this.receive();if(s!==TC.Finish)if(s===TC.Progress){if(o&&NC.matches(o))return e;await this.cancel(OC.UnsupportedAlgorithm)}else await this.cancel(OC.Unknown);else if("unsupported"===(null!=a?a:""))await this.cancel(OC.UnsupportedAlgorithm);else await this.cancel(OC.Unknown)}async receive(){return await this.channel.receive()}async send(e){await this.channel.send(e)}async declineLoginOnExistingDevice(){r.k.info("User declined sign in"),await this.send({type:TC.Finish,outcome:ZC.Declined})}async approveLoginOnExistingDevice(e){await this.send({type:TC.Progress,login_token:e,homeserver:this.client.baseUrl}),r.k.info("Waiting for outcome");const t=await this.receive();if(!t)return;const{outcome:i,device_id:n,device_key:s}=t;if("success"!==i)throw new Error("Linking failed");return this.newDeviceId=n,this.newDeviceKey=s,n}async verifyAndCrossSignDevice(e){if(!this.client.crypto)throw new Error("Crypto not available on client");if(!this.newDeviceId)throw new Error("No new device ID set");if(e.getFingerprint()!==this.newDeviceKey)throw new Error(`New device has different keys than expected: ${this.newDeviceKey} vs ${e.getFingerprint()}`);const t=this.client.getUserId();if(!t)throw new Error("No user ID set");r.k.info(`Marking device ${this.newDeviceId} as verified`);const i=await this.client.crypto.setDeviceVerification(t,this.newDeviceId,!0,!1,!0),n=this.client.crypto.crossSigningInfo.getId("master");return await this.send({type:TC.Finish,outcome:ZC.Verified,verifying_device_id:this.client.getDeviceId(),verifying_device_key:this.client.getDeviceEd25519Key(),master_key:n}),i}async verifyNewDeviceOnExistingDevice(e=1e4){if(!this.newDeviceId)throw new Error("No new device to sign");if(!this.newDeviceKey)return void r.k.info("No new device key to sign");if(!this.client.crypto)throw new Error("Crypto not available on client");const t=this.client.getUserId();if(!t)throw new Error("No user ID set");let i=this.client.crypto.getStoredDevice(t,this.newDeviceId);if(i||(r.k.info("Going to wait for new device to be online"),await(0,xa._v)(e),i=this.client.crypto.getStoredDevice(t,this.newDeviceId)),i)return await this.verifyAndCrossSignDevice(i);throw new Error("Device not online within timeout")}async cancel(e){var t;null===(t=this.onFailure)||void 0===t||t.call(this,e),await this.channel.cancel(e)}async close(){await this.channel.close()}}class MC extends Error{constructor(e,t){super(e),this.code=t}}let OC=function(e){return e.UserDeclined="user_declined",e.OtherDeviceNotSignedIn="other_device_not_signed_in",e.OtherDeviceAlreadySignedIn="other_device_already_signed_in",e.Unknown="unknown",e.Expired="expired",e.UserCancelled="user_cancelled",e.InvalidCode="invalid_code",e.UnsupportedAlgorithm="unsupported_algorithm",e.DataMismatch="data_mismatch",e.UnsupportedTransport="unsupported_transport",e.HomeserverLacksSupport="homeserver_lacks_support",e}({}),AC=function(e){return e.LOGIN_ON_NEW_DEVICE="login.start",e.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE="login.reciprocate",e}({});var LC=i("../matrix-js-sdk/src/http-api/index.ts");const UC=new RC.UnstableValue("http.v1","org.matrix.msc3886.http.v1");class FC{constructor({onFailure:e,client:t,fallbackRzServer:i,fetchFn:n}){(0,ff.Z)(this,"uri",void 0),(0,ff.Z)(this,"etag",void 0),(0,ff.Z)(this,"expiresAt",void 0),(0,ff.Z)(this,"client",void 0),(0,ff.Z)(this,"fallbackRzServer",void 0),(0,ff.Z)(this,"fetchFn",void 0),(0,ff.Z)(this,"cancelled",!1),(0,ff.Z)(this,"_ready",!1),(0,ff.Z)(this,"onFailure",void 0),this.fetchFn=n,this.onFailure=e,this.client=t,this.fallbackRzServer=i}get ready(){return this._ready}async details(){if(!this.uri)throw new Error("Rendezvous not set up");return{type:UC.name,uri:this.uri}}fetch(e,t){return this.fetchFn?this.fetchFn(e,t):i.g.fetch(e,t)}async getPostEndpoint(){try{if(await this.client.doesServerSupportUnstableFeature("org.matrix.msc3886"))return`${this.client.baseUrl}${LC.wI.Unstable}/org.matrix.msc3886/rendezvous`}catch(e){r.k.warn("Failed to get unstable features",e)}return this.fallbackRzServer}async send(e){var t,i;if(this.cancelled)return;const n=this.uri?"PUT":"POST",s=null!==(t=this.uri)&&void 0!==t?t:await this.getPostEndpoint();if(!s)throw new Error("Invalid rendezvous URI");const o={"content-type":"application/json"};this.etag&&(o["if-match"]=this.etag);const a=await this.fetch(s,{method:n,headers:o,body:JSON.stringify(e)});if(404===a.status)return this.cancel(OC.Unknown);if(this.etag=null!==(i=a.headers.get("etag"))&&void 0!==i?i:void 0,"POST"===n){var r;const e=a.headers.get("location");if(!e)throw new Error("No rendezvous URI given");const t=a.headers.get("expires");t&&(this.expiresAt=new Date(t));const i=null!==(r=a.url)&&void 0!==r?r:s;this.uri=new URL(e,`${i}${i.endsWith("/")?"":"/"}`).href,this._ready=!0}}async receive(){if(!this.uri)throw new Error("Rendezvous not set up");for(;;){if(this.cancelled)return;const i={};this.etag&&(i["if-none-match"]=this.etag);const n=await this.fetch(this.uri,{method:"GET",headers:i});if(404===n.status)return void this.cancel(OC.Unknown);var e;if("application/json"!==n.headers.get("content-type"))this.etag=null!==(e=n.headers.get("etag"))&&void 0!==e?e:void 0;else if(200===n.status){var t;return this.etag=null!==(t=n.headers.get("etag"))&&void 0!==t?t:void 0,n.json()}await(0,xa._v)(1e3)}}async cancel(e){var t;if(e===OC.Unknown&&this.expiresAt&&this.expiresAt.getTime()<Date.now()&&(e=OC.Expired),this.cancelled=!0,this._ready=!1,null===(t=this.onFailure)||void 0===t||t.call(this,e),this.uri&&e===OC.UserDeclined)try{await this.fetch(this.uri,{method:"DELETE"})}catch(e){r.k.warn(e)}}}var BC=i("../matrix-js-sdk/src/base64.ts"),VC=i("../matrix-js-sdk/src/crypto/crypto.ts"),jC=i("../matrix-js-sdk/src/crypto/verification/SASDecimal.ts");const zC=new cn.IY("m.rendezvous.v2.curve25519-aes-sha256","org.matrix.msc3903.rendezvous.v2.curve25519-aes-sha256");class WC{constructor(e,t,n){this.transport=e,this.theirPublicKey=t,this.onFailure=n,(0,ff.Z)(this,"olmSAS",void 0),(0,ff.Z)(this,"ourPublicKey",void 0),(0,ff.Z)(this,"aesKey",void 0),(0,ff.Z)(this,"connected",!1),this.olmSAS=new i.g.Olm.SAS,this.ourPublicKey=(0,BC.NV)(this.olmSAS.get_pubkey())}async generateCode(e){if(this.transport.ready)throw new Error("Code already generated");await this.transport.send({algorithm:zC.name});return{rendezvous:{algorithm:zC.name,key:(0,BC.UP)(this.ourPublicKey),transport:await this.transport.details()},intent:e}}async connect(){if(this.connected)throw new Error("Channel already connected");if(!this.olmSAS)throw new Error("Channel closed");const e=!this.theirPublicKey;if(e){const e=await this.transport.receive();if(!e)throw new Error("No response from other device");const t=e,{key:i,algorithm:n}=t;if(!n||!zC.matches(n)||!i)throw new MC("Unsupported algorithm: "+n,OC.UnsupportedAlgorithm);this.theirPublicKey=(0,BC.NV)(i)}else await this.transport.send({algorithm:zC.name,key:(0,BC.UP)(this.ourPublicKey)});this.connected=!0,this.olmSAS.set_their_key((0,BC.UP)(this.theirPublicKey));const t=e?this.ourPublicKey:this.theirPublicKey,i=e?this.theirPublicKey:this.ourPublicKey;let n=zC.name;n+=`|${(0,BC.UP)(t)}`,n+=`|${(0,BC.UP)(i)}`;const s=this.olmSAS.generate_bytes(n,32);this.aesKey=await async function(e){if(!VC.s1)throw new Error("Web Crypto is not available");return VC.s1.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}(s),s.fill(0);const o=this.olmSAS.generate_bytes(n,5);return(0,jC.g)(Array.from(o)).join("-")}async encrypt(e){if(!VC.s1)throw new Error("Web Crypto is not available");const t=new Uint8Array(32);VC.eL.getRandomValues(t);const i=(new VC.po).encode(JSON.stringify(e)),n=await VC.s1.encrypt({name:"AES-GCM",iv:t,tagLength:128},this.aesKey,i);return{iv:(0,BC.UP)(t),ciphertext:(0,BC.UP)(n)}}async send(e){if(!this.olmSAS)throw new Error("Channel closed");if(!this.aesKey)throw new Error("Shared secret not set up");return this.transport.send(await this.encrypt(e))}async decrypt({iv:e,ciphertext:t}){if(!t||!e)throw new Error("Missing ciphertext and/or iv");const i=(0,BC.NV)(t);if(!VC.s1)throw new Error("Web Crypto is not available");const n=await VC.s1.decrypt({name:"AES-GCM",iv:(0,BC.NV)(e),tagLength:128},this.aesKey,i);return JSON.parse((new TextDecoder).decode(new Uint8Array(n)))}async receive(){if(!this.olmSAS)throw new Error("Channel closed");if(!this.aesKey)throw new Error("Shared secret not set up");const e=await this.transport.receive();if(!e)return;const t=e;if(t.ciphertext&&t.iv)return this.decrypt(t);throw new Error("Data received but no ciphertext")}async close(){this.olmSAS&&(this.olmSAS.free(),this.olmSAS=void 0)}async cancel(e){try{await this.transport.cancel(e)}finally{await this.close()}}}function HC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function GC(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?HC(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):HC(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var KC,qC;function $C(){return $C=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},$C.apply(this,arguments)}function JC(e,t){return o.createElement("svg",$C({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0,ref:t},e),KC||(KC=o.createElement("g",{clipPath:"url(#devices_svg__clip0_721_35674)"},o.createElement("path",{d:"M5.333 9.333C5.333 8.6 5.933 8 6.667 8H28c.733 0 1.333-.6 1.333-1.334 0-.733-.6-1.333-1.333-1.333H5.333A2.675 2.675 0 002.667 8v14.666H2c-1.107 0-2 .894-2 2 0 1.107.893 2 2 2h16.667v-4H5.333V9.333zm25.334 1.333h-8c-.734 0-1.334.6-1.334 1.334v13.333c0 .734.6 1.334 1.334 1.334h8c.733 0 1.333-.6 1.333-1.334V12c0-.733-.6-1.334-1.333-1.334zm-1.334 12H24v-9.333h5.333v9.333z",fill:"currentColor"}))),qC||(qC=o.createElement("defs",null,o.createElement("clipPath",{id:"devices_svg__clip0_721_35674"},o.createElement("path",{fill:"#fff",d:"M0 0h32v32H0z"})))))}var YC=o.forwardRef(JC);var QC,XC=i("../matrix-react-sdk/res/img/element-icons/warning-badge.svg");function ek(){return ek=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},ek.apply(this,arguments)}function tk(e,t){return o.createElement("svg",ek({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),QC||(QC=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12 10a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm-1 3a1 1 0 110-2h1a1 1 0 011 1v3.5h.5a1 1 0 110 2H12a1 1 0 01-1-1V13z",fill:"#000"})))}var ik=o.forwardRef(tk);var nk=i("../matrix-react-sdk/node_modules/buffer/index.js").lW;class sk extends o.Component{constructor(e){super(e),(0,k.Z)(this,"handleClick",(e=>async t=>{t.preventDefault(),await this.props.onClick(e)})),(0,k.Z)(this,"cancelButton",(()=>o.createElement(ae.Z,{"data-testid":"cancel-button",kind:"primary_outline",onClick:this.handleClick(rk.Cancel)},(0,l._t)("action|cancel")))),(0,k.Z)(this,"simpleSpinner",(e=>o.createElement("div",{className:"mx_LoginWithQR_spinner"},o.createElement("div",null,o.createElement(re.Z,null),e&&o.createElement("p",null,e)))))}render(){let e,t,i,n,s="",a=!0,r=!1;switch(this.props.phase){case ak.Error:switch(this.props.failureReason){case OC.Expired:n=(0,l._t)("auth|qr_code_login|error_linking_incomplete");break;case OC.InvalidCode:n=(0,l._t)("auth|qr_code_login|error_invalid_scanned_code");break;case OC.UnsupportedAlgorithm:n=(0,l._t)("auth|qr_code_login|error_device_unsupported");break;case OC.UserDeclined:n=(0,l._t)("auth|qr_code_login|error_request_declined");break;case OC.OtherDeviceAlreadySignedIn:n=(0,l._t)("auth|qr_code_login|error_device_already_signed_in");break;case OC.OtherDeviceNotSignedIn:n=(0,l._t)("auth|qr_code_login|error_device_not_signed_in");break;case OC.UserCancelled:n=(0,l._t)("auth|qr_code_login|error_request_cancelled");break;case OC.Unknown:n=(0,l._t)("auth|qr_code_login|error_unexpected");break;case OC.HomeserverLacksSupport:n=(0,l._t)("auth|qr_code_login|error_homeserver_lacks_support");break;default:n=(0,l._t)("auth|qr_code_login|error_request_cancelled")}s=(0,l._t)("timeline|m.call.invite|failed_connection"),r=!0,e=o.createElement(XC.J,{className:"error"}),a=!1,t=o.createElement("p",{"data-testid":"cancellation-message"},n),i=o.createElement(o.Fragment,null,o.createElement(ae.Z,{"data-testid":"try-again-button",kind:"primary",onClick:this.handleClick(rk.TryAgain)},(0,l._t)("action|try_again")),this.cancelButton());break;case ak.Connected:s=(0,l._t)("auth|qr_code_login|devices_connected"),e=o.createElement(YC,{className:"normal"}),a=!1,t=o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("auth|qr_code_login|confirm_code_match")),o.createElement("div",{className:"mx_LoginWithQR_confirmationDigits"},this.props.confirmationDigits),o.createElement("div",{className:"mx_LoginWithQR_confirmationAlert"},o.createElement("div",null,o.createElement(ik,null)),o.createElement("div",null,(0,l._t)("auth|qr_code_login|approve_access_warning")))),i=o.createElement(o.Fragment,null,o.createElement(ae.Z,{"data-testid":"decline-login-button",kind:"primary_outline",onClick:this.handleClick(rk.Decline)},(0,l._t)("action|cancel")),o.createElement(ae.Z,{"data-testid":"approve-login-button",kind:"primary",onClick:this.handleClick(rk.Approve)},(0,l._t)("action|approve")));break;case ak.ShowingQR:if(s=(0,l._t)("settings|sessions|sign_in_with_qr"),this.props.code){var c;const e=o.createElement("div",{className:"mx_LoginWithQR_qrWrapper"},o.createElement(vd.Z,{data:[{data:nk.from(null!==(c=this.props.code)&&void 0!==c?c:""),mode:"byte"}],className:"mx_QRCode"}));t=o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("auth|qr_code_login|scan_code_instruction")),o.createElement("ol",null,o.createElement("li",null,(0,l._t)("auth|qr_code_login|start_at_sign_in_screen")),o.createElement("li",null,(0,l._t)("auth|qr_code_login|select_qr_code",{scanQRCode:(0,l._t)("auth|qr_code_login|scan_qr_code")})),o.createElement("li",null,(0,l._t)("auth|qr_code_login|review_and_approve"))),e)}else t=this.simpleSpinner(),i=this.cancelButton();break;case ak.Loading:t=this.simpleSpinner();break;case ak.Connecting:t=this.simpleSpinner((0,l._t)("auth|qr_code_login|connecting")),i=this.cancelButton();break;case ak.WaitingForDevice:t=this.simpleSpinner((0,l._t)("auth|qr_code_login|waiting_for_device")),i=this.cancelButton();break;case ak.Verifying:s=(0,l._t)("common|success"),r=!0,t=this.simpleSpinner((0,l._t)("auth|qr_code_login|completing_setup"))}return o.createElement("div",{"data-testid":"login-with-qr",className:"mx_LoginWithQR"},o.createElement("div",{className:r?"mx_LoginWithQR_centreTitle":""},a?o.createElement(ae.Z,{"data-testid":"back-button",className:"mx_LoginWithQR_BackButton",onClick:this.handleClick(rk.Back),title:"Back"},o.createElement(UE,null)):null,o.createElement("h1",null,e,s)),o.createElement("div",{className:"mx_LoginWithQR_main"},t),o.createElement("div",{className:"mx_LoginWithQR_buttons"},i))}}let ok=function(e){return e.Show="show",e}({}),ak=function(e){return e[e.Loading=0]="Loading",e[e.ShowingQR=1]="ShowingQR",e[e.Connecting=2]="Connecting",e[e.Connected=3]="Connected",e[e.WaitingForDevice=4]="WaitingForDevice",e[e.Verifying=5]="Verifying",e[e.Error=6]="Error",e}({}),rk=function(e){return e[e.Cancel=0]="Cancel",e[e.Decline=1]="Decline",e[e.Approve=2]="Approve",e[e.TryAgain=3]="TryAgain",e[e.Back=4]="Back",e}({});class lk extends o.Component{constructor(e){super(e),(0,k.Z)(this,"approveLogin",(async()=>{if(!this.state.rendezvous)throw new Error("Rendezvous not found");this.setState({phase:ak.Loading});try{r.k.info("Requesting login token");const{login_token:i}=await(e=this.props.client.requestLoginToken,t={matrixClient:this.props.client,title:(0,l._t)("auth|qr_code_login|sign_in_new_device")},async function(...i){return new Promise(((n,s)=>{const o=e.bind(t.matrixClient);o(void 0,...i).then((e=>n(e))).catch((e=>{var a;if(401!==e.httpStatus||null===(a=e.data)||void 0===a||!a.flows)return s(e);T.ZP.createDialog(te.Z,GC(GC({},t),{},{authData:e.data,makeRequest:e=>o(e,...i),onFinished:(e,t)=>{e?n(t):s(t)}}))}))}))})();this.setState({phase:ak.WaitingForDevice});if(!await this.state.rendezvous.approveLoginOnExistingDevice(i))return;if(!this.props.client.crypto)return void this.props.onFinished(!0);this.setState({phase:ak.Verifying}),await this.state.rendezvous.verifyNewDeviceOnExistingDevice(),this.props.onFinished(!0)}catch(e){r.k.error("Error whilst approving sign in",e),this.setState({phase:ak.Error,failureReason:OC.Unknown})}var e,t})),(0,k.Z)(this,"generateCode",(async()=>{let e;try{var t,i;const n=null===(t=this.props.client.getClientWellKnown())||void 0===t||null===(i=t["io.element.rendezvous"])||void 0===i?void 0:i.server,s=new FC({onFailure:this.onFailure,client:this.props.client,fallbackRzServer:n}),o=new WC(s,void 0,this.onFailure);e=new DC(o,this.props.client,this.onFailure),await e.generateCode(),this.setState({phase:ak.ShowingQR,rendezvous:e,failureReason:void 0})}catch(e){return r.k.error("Error whilst generating QR code",e),void this.setState({phase:ak.Error,failureReason:OC.HomeserverLacksSupport})}try{const t=await e.startAfterShowingCode();this.setState({phase:ak.Connected,confirmationDigits:t})}catch(e){r.k.error("Error whilst doing QR login",e),this.state.phase!==ak.Error&&this.setState({phase:ak.Error,failureReason:OC.Unknown})}})),(0,k.Z)(this,"onFailure",(e=>{r.k.info(`Rendezvous failed: ${e}`),this.setState({phase:ak.Error,failureReason:e})})),(0,k.Z)(this,"onClick",(async e=>{var t,i,n;switch(e){case rk.Cancel:await(null===(t=this.state.rendezvous)||void 0===t?void 0:t.cancel(OC.UserCancelled)),this.reset(),this.props.onFinished(!1);break;case rk.Approve:await this.approveLogin();break;case rk.Decline:await(null===(i=this.state.rendezvous)||void 0===i?void 0:i.declineLoginOnExistingDevice()),this.reset(),this.props.onFinished(!1);break;case rk.TryAgain:this.reset(),await this.updateMode(this.props.mode);break;case rk.Back:await(null===(n=this.state.rendezvous)||void 0===n?void 0:n.cancel(OC.UserCancelled)),this.props.onFinished(!1)}})),this.state={phase:ak.Loading}}componentDidMount(){this.updateMode(this.props.mode).then((()=>{}))}componentDidUpdate(e){e.mode!==this.props.mode&&this.updateMode(this.props.mode).then((()=>{}))}async updateMode(e){if(this.setState({phase:ak.Loading}),this.state.rendezvous){const e=this.state.rendezvous;e.onFailure=void 0,await e.cancel(OC.UserCancelled),this.setState({rendezvous:void 0})}e===ok.Show&&await this.generateCode()}componentWillUnmount(){this.state.rendezvous&&(this.state.rendezvous.onFailure=void 0,this.state.rendezvous.cancel(OC.UserCancelled).then((()=>{})))}reset(){this.setState({rendezvous:void 0,confirmationDigits:void 0,failureReason:void 0})}render(){var e;return o.createElement(sk,{onClick:this.onClick,phase:this.state.phase,code:this.state.phase===ak.ShowingQR?null===(e=this.state.rendezvous)||void 0===e?void 0:e.code:void 0,confirmationDigits:this.state.phase===ak.Connected?this.state.confirmationDigits:void 0,failureReason:this.state.phase===ak.Error?this.state.failureReason:void 0})}}const ck=({otherSessionsCount:e,disabled:t,signOutAllOtherSessions:i})=>{const n=(0,ne.gP)([i?o.createElement(ur.$k,{key:"sign-out-all-others",label:(0,l._t)("settings|sessions|sign_out_n_sessions",{count:e}),onClick:i,isDestructive:!0}):null]);return o.createElement(Ny.I,{heading:(0,l._t)("settings|sessions|other_sessions_heading")},!!n.length&&o.createElement(bC,{disabled:t,title:(0,l._t)("common|options"),options:n,"data-testid":"other-sessions-menu"}))},dk=({delegatedAuthAccountUrl:e,deviceId:t,onFinished:i})=>{const[n,s]=(0,o.useState)(!1),a=((e,t)=>{const i=new URL(e);return i.searchParams.set("action","session_end"),i.searchParams.set("device_id",t),i.toString()})(e,t);return o.createElement(q.Z,{onFinished:i,title:(0,l._t)("action|sign_out"),contentId:"mx_Dialog_content"},o.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},(0,l._t)("auth|oidc|logout_redirect_warning")),o.createElement("div",{className:"mx_Dialog_buttons"},n?o.createElement(ae.Z,{kind:"primary",onClick:()=>i(!0)},(0,l._t)("action|close")):o.createElement(o.Fragment,null,o.createElement(ae.Z,{kind:"secondary",onClick:()=>i(!1)},(0,l._t)("action|cancel")),o.createElement(ae.Z,{element:"a",onClick:()=>s(!0),kind:"primary",href:a,target:"_blank"},(0,l._t)("action|continue")))))};function mk(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}const hk=(e,t,i)=>{const[s,a]=(0,o.useState)([]);return{onSignOutCurrentDevice:()=>{T.ZP.createDialog(Il,{},void 0,!1,!0)},onSignOutOtherDevices:async c=>{if(c.length)if(i&&1!==c.length)r.k.warn("Unexpectedly tried to sign out multiple OIDC-aware devices.");else{if(!i){if(!await(async e=>{const{finished:t}=T.ZP.createDialog(mt.Z,{title:(0,l._t)("action|sign_out"),description:o.createElement("div",null,o.createElement("p",null,(0,l._t)("settings|sessions|sign_out_confirm_description",{count:e}))),cancelButton:(0,l._t)("action|cancel"),button:(0,l._t)("action|sign_out")}),[i]=await t;return!!i})(c.length))return}try{a([...s,...c]);const o=async e=>{e&&await t(),a(s.filter((e=>!c.includes(e))))};if(i){const[e]=c;try{a([...s,e]);const t=await(async(e,t)=>{const{finished:i}=T.ZP.createDialog(dk,{deviceId:t,delegatedAuthAccountUrl:e}),[n]=await i;return!!n})(i,e);await o(t)}catch(e){r.k.error("Error deleting OIDC-aware sessions",e)}}else await(async(e,t,i)=>{if(t.length)try{await kC(e,t)(null),await i(!0,void 0)}catch(o){var s;if(!(o instanceof n.MatrixError&&401===o.httpStatus&&null!==(s=o.data)&&void 0!==s&&s.flows))throw o;const a=t.length,r={[Fy.Rt.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("settings|sessions|confirm_sign_out_sso",{count:a}),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.Rt.PHASE_POSTAUTH]:{title:(0,l._t)("settings|sessions|confirm_sign_out",{count:a}),body:(0,l._t)("settings|sessions|confirm_sign_out_body",{count:a}),continueText:(0,l._t)("settings|sessions|confirm_sign_out_continue",{count:a}),continueKind:"danger"}};T.ZP.createDialog(te.Z,{title:(0,l._t)("common|authentication"),matrixClient:e,authData:o.data,onFinished:i,makeRequest:kC(e,t),aestheticsForStagePhases:{[Fy.Rt.LOGIN_TYPE]:r,[Fy.Rt.UNSTABLE_LOGIN_TYPE]:r}})}})(e,c,o)}catch(e){r.k.error("Error deleting sessions",e),a(s.filter((e=>!c.includes(e))))}}},signingOutDeviceIds:s}},pk=()=>{const{devices:e,pushers:t,localNotificationSettings:i,currentDeviceId:n,isLoadingDeviceList:s,requestDeviceVerification:a,refreshDevices:r,saveDeviceName:c,setPushNotifications:d,supportsMSC3881:m}=dS(),[h,p]=(0,o.useState)(),[u,g]=(0,o.useState)([]),[_,f]=(0,o.useState)([]),E=(0,o.useRef)(null),y=(0,o.useRef)(),b=(0,o.useContext)(ie.f),w=b.client,S=b.oidcClientStore.accountManagementEndpoint,C=!!S,k=null==w?void 0:w.getUserId(),x=k&&(null==w?void 0:w.getUser(k))||void 0,R=(0,Pn.G)((()=>w.getVersions()),[w]),I=(0,Pn.G)((async()=>null==w?void 0:w.getCapabilities()),[w]),P=(0,o.useMemo)((()=>null==w?void 0:w.getClientWellKnown()),[w]),{[n]:Z}=e,N=(0,v.Z)(e,[n].map(mk)),D=Object.keys(N).length,M=D>0,O=(0,o.useCallback)((e=>{if(!a)return;const t=a(e);T.ZP.createDialog(J,{verificationRequestPromise:t,member:x,onFinished:async()=>{(await t).cancel(),await r()}})}),[a,r,x]),{onSignOutCurrentDevice:A,onSignOutOtherDevices:L,signingOutDeviceIds:U}=hk(w,(async()=>{await r(),f([])}),S);(0,o.useEffect)((()=>()=>{clearTimeout(y.current)}),[y]),(0,o.useEffect)((()=>{f([])}),[h,f]);const F=M&&!C?()=>{L(Object.keys(N))}:void 0,[B,V]=(0,o.useState)(),j=(0,o.useCallback)((()=>{V(null)}),[V]),z=(0,o.useCallback)((()=>{V(ok.Show)}),[V]);return B?o.createElement(lk,{mode:B,onFinished:j,client:w}):o.createElement(Ys.Z,null,o.createElement(Qs.Q,{heading:(0,l._t)("settings|sessions|title")},o.createElement(CC,{devices:e,goToFilteredList:e=>{p(e),clearTimeout(y.current),y.current=window.setTimeout((()=>{var e;return null===(e=E.current)||void 0===e?void 0:e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}))},currentDeviceId:n}),o.createElement(SC,{device:Z,localNotificationSettings:i.get(n),setPushNotifications:d,isSigningOut:U.includes(n),isLoading:s,saveDeviceName:e=>c(n,e),onVerifyCurrentDevice:()=>{T.ZP.createDialog(de,{onFinished:r})},onSignOutCurrentDevice:A,signOutAllOtherSessions:F,otherSessionsCount:D}),M&&o.createElement(Xs.ZP,{heading:o.createElement(ck,{otherSessionsCount:D,signOutAllOtherSessions:F,disabled:!!U.length}),description:(0,l._t)("settings|sessions|best_security_note"),"data-testid":"other-sessions-section",stretchContent:!0},o.createElement(EC,{devices:N,pushers:t,localNotificationSettings:i,filter:h,expandedDeviceIds:u,signingOutDeviceIds:U,selectedDeviceIds:_,setSelectedDeviceIds:f,onFilterChange:p,onDeviceExpandToggle:e=>{u.includes(e)?g(u.filter((t=>t!==e))):g([...u,e])},onRequestDeviceVerification:a?O:void 0,onSignOutDevices:L,saveDeviceName:c,setPushNotifications:d,ref:E,supportsMSC3881:m,disableMultipleSignout:C})),o.createElement(xC,{onShowQr:z,versions:R,capabilities:I,wellKnown:P})))};class uk extends o.Component{constructor(e){super(e),(0,k.Z)(this,"settingsWatchers",[]),(0,k.Z)(this,"mjolnirChanged",((e,t,i,n)=>{this.setState({mjolnirEnabled:n})})),this.state={mjolnirEnabled:L.C.getValue("feature_mjolnir")}}componentDidMount(){this.settingsWatchers=[L.C.watchSetting("feature_mjolnir",null,this.mjolnirChanged)]}componentWillUnmount(){this.settingsWatchers.forEach((e=>L.C.unwatchSetting(e)))}getTabs(){const e=[];return e.push(new Ks.OK(tl.o.General,(0,l.I8)("common|general"),"mx_UserSettingsDialog_settingsIcon",o.createElement(Mb,{closeSettingsFn:this.props.onFinished}),"UserSettingsGeneral")),e.push(new Ks.OK(tl.o.Appearance,(0,l.I8)("common|appearance"),"mx_UserSettingsDialog_appearanceIcon",o.createElement(Hb,null),"UserSettingsAppearance")),e.push(new Ks.OK(tl.o.Notifications,(0,l.I8)("notifications|enable_prompt_toast_title"),"mx_UserSettingsDialog_bellIcon",o.createElement(Vw,null),"UserSettingsNotifications")),e.push(new Ks.OK(tl.o.Preferences,(0,l.I8)("common|preferences"),"mx_UserSettingsDialog_preferencesIcon",o.createElement(jw,{closeSettingsFn:this.props.onFinished}),"UserSettingsPreferences")),e.push(new Ks.OK(tl.o.Keyboard,(0,l.I8)("settings|keyboard|title"),"mx_UserSettingsDialog_keyboardIcon",o.createElement(oS,null),"UserSettingsKeyboard")),e.push(new Ks.OK(tl.o.Sidebar,(0,l.I8)("settings|sidebar|title"),"mx_UserSettingsDialog_sidebarIcon",o.createElement(el,null),"UserSettingsSidebar")),L.C.getValue(Ye.H.Voip)&&e.push(new Ks.OK(tl.o.Voice,(0,l.I8)("settings|voip|title"),"mx_UserSettingsDialog_voiceIcon",o.createElement(Hw,null),"UserSettingsVoiceVideo")),e.push(new Ks.OK(tl.o.Security,(0,l.I8)("room_settings|security|title"),"mx_UserSettingsDialog_securityIcon",o.createElement(tw,{closeSettingsFn:this.props.onFinished}),"UserSettingsSecurityPrivacy")),e.push(new Ks.OK(tl.o.SessionManager,(0,l.I8)("settings|sessions|title"),"mx_UserSettingsDialog_sessionsIcon",o.createElement(pk,null),void 0)),(Lb()||L.C.getFeatureSettingNames().some((e=>L.C.getBetaInfo(e))))&&e.push(new Ks.OK(tl.o.Labs,(0,l.I8)("common|labs"),"mx_UserSettingsDialog_labsIcon",o.createElement(Ub,null),"UserSettingsLabs")),this.state.mjolnirEnabled&&e.push(new Ks.OK(tl.o.Mjolnir,(0,l.I8)("labs_mjolnir|title"),"mx_UserSettingsDialog_mjolnirIcon",o.createElement(Xw,null),"UserSettingMjolnir")),e.push(new Ks.OK(tl.o.Help,(0,l.I8)("setting|help_about|title"),"mx_UserSettingsDialog_helpIcon",o.createElement(Yw,{closeSettingsFn:()=>this.props.onFinished()}),"UserSettingsHelpAbout")),e}render(){return o.createElement(ie.f.Provider,{value:this.props.sdkContext},o.createElement(q.Z,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,l._t)("common|settings")},o.createElement("div",{className:"mx_SettingsDialog_content"},o.createElement(Ks.ZP,{tabs:this.getTabs(),initialTabId:this.props.initialTabId,screenName:"UserSettings"}))))}}var gk=i("../matrix-react-sdk/src/components/views/dialogs/CreateRoomDialog.tsx");const vk=({failures:e,source:t,continuation:i,onFinished:n})=>{const[s,a]=(0,o.useState)(2),[r,d]=(0,o.useState)(!1),[m,h]=(0,o.useState)(!1),[p,u]=(0,o.useState)(!1),g=(0,o.useRef)(n),v=new Map([["_afterCrossSigningLocalKeyChange",(0,l._t)("encryption|key_signature_upload_failed_master_key_signature")],["checkOwnCrossSigningTrust",(0,l._t)("encryption|key_signature_upload_failed_cross_signing_key_signature")],["setDeviceVerification",(0,l._t)("encryption|key_signature_upload_failed_device_cross_signing_key_signature")]]),_=(0,l._t)("encryption|key_signature_upload_failed_key_signature"),f=(0,o.useCallback)((async()=>{try{h(!0);const e=new Promise(((e,t)=>{g.current=t})).finally((()=>{d(!0)}));await Promise.race([i({shouldEmit:!1}),e]),u(!0)}catch(e){a((e=>e-1))}finally{g.current=n,h(!1)}}),[i,n]);let E;if(!p&&!r&&s>0){const i=v.get(t)||_,n=c.ZP.get().brand;E=o.createElement("div",null,o.createElement("p",null,(0,l._t)("encryption|key_signature_upload_failed_body",{brand:n})),o.createElement("p",null,i),m&&o.createElement(re.Z,null),o.createElement("pre",null,JSON.stringify(e,null,2)),o.createElement(gt.Z,{primaryButton:"Retry",hasCancel:!0,onPrimaryButtonClick:f,onCancel:g.current,primaryDisabled:m}))}else{let e=(0,l._t)("encryption|key_signature_upload_completed");p||(e=r?(0,l._t)("encryption|key_signature_upload_cancelled"):(0,l._t)("encryption|key_signature_upload_failed")),E=o.createElement("div",null,o.createElement("span",null,e),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|ok"),hasCancel:!1,onPrimaryButtonClick:n}))}return o.createElement(q.Z,{title:p?(0,l._t)("encryption|key_signature_upload_success_title"):(0,l._t)("encryption|key_signature_upload_failed_title"),fixedWidth:!1,onFinished:()=>{}},E)};var _k=i("../matrix-js-sdk/src/crypto-api/verification.ts");class fk extends o.Component{render(){return o.createElement("div",null,o.createElement("h2",null,(0,l._t)("encryption|verification|complete_title")),o.createElement("p",null,(0,l._t)("encryption|verification|complete_description")),o.createElement("p",null,(0,l._t)("encryption|verification|explainer")),o.createElement(gt.Z,{onPrimaryButtonClick:this.props.onDone,primaryButton:(0,l._t)("encryption|verification|complete_action"),hasCancel:!1}))}}class Ek extends o.Component{render(){return o.createElement("div",null,o.createElement("p",null,(0,l._t)("encryption|verification|other_party_cancelled")),o.createElement(gt.Z,{primaryButton:(0,l._t)("action|ok"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}var yk=i("../matrix-react-sdk/src/components/views/verification/VerificationShowSas.tsx");class bk extends o.Component{constructor(e){super(e),(0,k.Z)(this,"showSasEvent",void 0),(0,k.Z)(this,"onFinished",(()=>{this.props.onFinished(3===this.state.phase)})),(0,k.Z)(this,"onCancelClick",(()=>{this.props.onFinished(3===this.state.phase)})),(0,k.Z)(this,"onContinueClick",(()=>{this.setState({phase:2}),this.props.verifier.verify().then((()=>{this.setState({phase:3})})).catch((e=>{r.k.log("Verification failed",e)}))})),(0,k.Z)(this,"onVerifierShowSas",(e=>{this.showSasEvent=e,this.setState({phase:1,sas:e.sas})})),(0,k.Z)(this,"onVerifierCancel",(()=>{this.setState({phase:4})})),(0,k.Z)(this,"onSasMatchesClick",(()=>{var e;null===(e=this.showSasEvent)||void 0===e||e.confirm(),this.setState({phase:2})})),(0,k.Z)(this,"onVerifiedDoneClick",(()=>{this.props.onFinished(!0)}));let t=0;this.props.verifier.hasBeenCancelled&&(r.k.log("Verifier was cancelled in the background."),t=4),this.showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null,sas:null},this.props.verifier.on(_k.yn.ShowSas,this.onVerifierShowSas),this.props.verifier.on(_k.yn.Cancel,this.onVerifierCancel),this.fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel(new Error("User cancel")),this.props.verifier.removeListener(_k.yn.ShowSas,this.onVerifierShowSas)}async fetchOpponentProfile(){try{const e=await E.p.safeGet().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}renderPhaseStart(){const e=this.props.verifier.userId===E.p.safeGet().getUserId();let t;const i=this.state.opponentProfile;if(i){const e=i.avatar_url?(0,mn.TS)(i.avatar_url).getSquareThumbnailHttp(48):null;t=o.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},o.createElement(ys.Z,{name:i.displayname,idName:this.props.verifier.userId,url:e,size:"48px"}),o.createElement("h2",null,i.displayname))}else t=this.state.opponentProfileError?o.createElement("div",null,o.createElement(ys.Z,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,size:"48px"}),o.createElement("h2",null,this.props.verifier.userId)):o.createElement(re.Z,null);const n=[o.createElement("p",{key:"p1"},(0,l._t)("encryption|verification|incoming_sas_user_dialog_text_1")),o.createElement("p",{key:"p2"},(0,l._t)("encryption|verification|incoming_sas_user_dialog_text_2"))],s=[o.createElement("p",{key:"p1"},(0,l._t)("encryption|verification|incoming_sas_device_dialog_text_1")),o.createElement("p",{key:"p2"},(0,l._t)("encryption|verification|incoming_sas_device_dialog_text_2"))];return o.createElement("div",null,t,e?s:n,o.createElement(gt.Z,{primaryButton:(0,l._t)("action|continue"),hasCancel:!0,onPrimaryButtonClick:this.onContinueClick,onCancel:this.onCancelClick}))}renderPhaseShowSas(){return this.showSasEvent?o.createElement(yk.Z,{sas:this.showSasEvent.sas,onCancel:this.onCancelClick,onDone:this.onSasMatchesClick,isSelf:this.props.verifier.userId===E.p.safeGet().getUserId(),inDialog:!0}):null}renderPhaseWaitForPartnerToConfirm(){return o.createElement("div",null,o.createElement(re.Z,null),o.createElement("p",null,(0,l._t)("encryption|verification|incoming_sas_dialog_waiting")))}renderPhaseVerified(){return o.createElement(fk,{onDone:this.onVerifiedDoneClick})}renderPhaseCancelled(){return o.createElement(Ek,{onDone:this.onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this.renderPhaseStart();break;case 1:e=this.renderPhaseShowSas();break;case 2:e=this.renderPhaseWaitForPartnerToConfirm();break;case 3:e=this.renderPhaseVerified();break;case 4:e=this.renderPhaseCancelled()}return o.createElement(q.Z,{title:(0,l._t)("encryption|verification|incoming_sas_dialog_title"),onFinished:this.onFinished,fixedWidth:!1},e)}}class wk extends o.PureComponent{render(){return o.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}var Sk=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),Ck=i("./src/languageHandler.tsx");const kk=()=>{var e;const t=c.ZP.getObject("branding"),i=null!==(e=null==t?void 0:t.get("auth_footer_links"))&&void 0!==e?e:[{text:"Blog",url:"https://element.io/blog"},{text:"Twitter",url:"https://twitter.com/element_hq"},{text:"GitHub",url:"https://github.com/vector-im/element-web"}],n=[];for(const e of i)n.push(o.createElement("a",{href:e.url,key:e.text,target:"_blank",rel:"noreferrer noopener"},e.text));return o.createElement("footer",{className:"mx_AuthFooter",role:"contentinfo"},n,o.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},(0,Ck._t)("powered_by_matrix")))};class xk extends o.PureComponent{render(){const e={},t={position:"absolute",top:0,right:0,bottom:0,left:0,filter:"blur(40px)",background:e.background};return o.createElement("div",{className:"mx_AuthPage",style:e},o.createElement("div",{className:"mx_AuthPage_modal",style:{position:"relative",background:"initial"}},o.createElement("div",{className:"mx_AuthPage_modalBlur",style:t}),o.createElement("div",{className:"mx_AuthPage_modalContent",style:{display:"flex",zIndex:1,background:"rgba(255, 255, 255, 0.59)",borderRadius:"8px"}},this.props.children)),o.createElement(kk,null))}}(0,Sk.Z)(xk,"welcomeBackgroundUrl",void 0);class Rk extends o.Component{constructor(e){super(e),(0,k.Z)(this,"onStoreUpdate",(()=>{const e=oe.sharedInstance();this.setState({phase:e.phase,lostKeys:e.lostKeys()})})),(0,k.Z)(this,"onSkipClick",(()=>{oe.sharedInstance().skip()}));const t=oe.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=oe.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;let i,n,s;if(e===se.Loading)return null;if(e===se.Intro)t?(i=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=(0,l._t)("encryption|verification|after_new_login|unable_to_verify")):(i=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=(0,l._t)("encryption|verification|after_new_login|verify_this_device"));else if(e===se.Done)i=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),n=(0,l._t)("encryption|verification|after_new_login|device_verified");else if(e===se.ConfirmSkip)i=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=(0,l._t)("common|are_you_sure");else if(e===se.Busy)i=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=(0,l._t)("encryption|verification|after_new_login|verify_this_device");else if(e===se.ConfirmReset)i=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=(0,l._t)("encryption|verification|after_new_login|reset_confirmation");else if(e!==se.Finished)throw new Error(`Unknown phase ${e}`);return e!==se.Intro&&e!==se.ConfirmReset||(s=o.createElement(ae.Z,{onClick:this.onSkipClick,className:"mx_CompleteSecurity_skip","aria-label":(0,l._t)("encryption|verification|after_new_login|skip_verification")})),o.createElement(xk,null,o.createElement(wk,null,o.createElement("h1",{className:"mx_CompleteSecurity_header"},i,n,s),o.createElement("div",{className:"mx_CompleteSecurity_body"},o.createElement(le,{onFinished:this.props.onFinished}))))}}function Ik(e){var t;(0,l.Wx)()!==e&&(L.C.setValue("language",null,U.R.DEVICE,e),null===(t=a.Z.get())||void 0===t||t.reload())}function Pk({disabled:e}){return c.ZP.get("disable_login_language_selector")?o.createElement("div",null):o.createElement(My,{className:"mx_AuthBody_language",onOptionChange:Ik,value:(0,l.Wx)(),disabled:e})}const Tk=`<a href="https://matrix.org" target="_blank" rel="noreferrer noopener">\n    <img width="79" height="34" alt="Matrix" style="padding-left: 1px;vertical-align: middle" src="${i("../matrix-react-sdk/res/img/matrix.svg").Z}"/>\n</a>`;class Zk extends o.PureComponent{render(){const e=c.ZP.getObject("embedded_pages");let t;e&&(t=e.get("welcome_url"));const i={"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas",$matrixLogo:Tk,"[matrix]":Tk};if(!t){var n;const e=c.ZP.getObject("branding"),s=null!==(n=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==n?n:"themes/element/img/logos/element-logo.svg";i.$logoUrl=s,t="welcome.html"}return o.createElement(xk,null,o.createElement("div",{className:yt()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!L.C.getValue(Ye.H.Registration)})},o.createElement(xd,{className:"mx_WelcomePage",url:t,replaceMap:i}),o.createElement(Pk,null)))}}class Nk{constructor(e,t){(0,k.Z)(this,"client",void 0),(0,k.Z)(this,"clientSecret",void 0),(0,k.Z)(this,"password",""),(0,k.Z)(this,"sessionId",""),(0,k.Z)(this,"logoutDevices",!1),(0,k.Z)(this,"sendAttempt",0),this.client=(0,n.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret()}requestResetToken(e){return this.sendAttempt++,this.client.requestPasswordEmailToken(e,this.clientSecret,this.sendAttempt).then((e=>(this.sessionId=e.sid,e)),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=(0,l._t)("auth|reset_password_email_not_found_title"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}setLogoutDevices(e){this.logoutDevices=e}async setNewPassword(e){this.password=e,await this.checkEmailLinkClicked()}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e,threepidCreds:e},this.password,this.logoutDevices)}catch(e){throw 401===e.httpStatus?e.message=(0,l._t)("settings|general|add_email_failed_verification"):404===e.httpStatus?e.message=(0,l._t)("auth|reset_password_email_not_associated"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}class Dk extends o.Component{render(){return o.createElement("div",null)}}function Mk({flex:e,className:t,children:i}){return o.createElement("main",{className:yt()("mx_AuthBody",t,{mx_AuthBody_flex:e})},i)}var Ok;function Ak(){return Ak=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Ak.apply(this,arguments)}function Lk(e,t){return o.createElement("svg",Ak({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0,ref:t},e),Ok||(Ok=o.createElement("path",{d:"M5.092 17.049l6.515 6.709L26.91 8",stroke:"currentColor",strokeWidth:2.5,strokeLinecap:"round",strokeLinejoin:"round"})))}var Uk=o.forwardRef(Lk);var Fk;function Bk(){return Bk=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Bk.apply(this,arguments)}function Vk(e,t){return o.createElement("svg",Bk({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0,ref:t},e),Fk||(Fk=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M13.333 1.852a5.5 5.5 0 00-5.5 5.5v5.822H7a3 3 0 00-3 3v11.493a3 3 0 003 3h18a3 3 0 003-3V16.174a3 3 0 00-3-3h-.833V7.352a5.5 5.5 0 00-5.5-5.5h-5.334zm7.834 11.322V7.352a2.5 2.5 0 00-2.5-2.5h-5.334a2.5 2.5 0 00-2.5 2.5v5.822h10.334z",fill:"currentColor"})))}var jk=o.forwardRef(Vk);var zk;function Wk(){return Wk=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Wk.apply(this,arguments)}function Hk(e,t){return o.createElement("svg",Wk({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 40 29",role:"presentation","aria-hidden":!0,ref:t},e),zk||(zk=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M.261 2.576L18.905 21.16a1.64 1.64 0 002.316 0L39.773 2.668C39.92 3.084 40 3.533 40 4v21a4 4 0 01-4 4H4a4 4 0 01-4-4V4c0-.502.092-.982.261-1.424zM2.582.259C3.022.09 3.501 0 4 0h32c.533 0 1.042.104 1.508.294l-17.445 17.39L2.583.26z",fill:"#737D8C"})))}var Gk=o.forwardRef(Hk);var Kk=i("../matrix-react-sdk/res/img/compound/error-16px.svg");const qk=({message:e})=>{const t=e?o.createElement(Kk.J,{className:"mx_Icon mx_Icon_16"}):null;return o.createElement("div",{className:"mx_ErrorMessage"},t,e)},$k=({email:e,errorText:t,homeserver:i,loading:n,onInputChanged:s,onLoginClick:a,onSubmitForm:r})=>{const c=n?o.createElement(re.Z,{w:16,h:16}):(0,l._t)("auth|forgot_password_send_email"),d=(0,o.useRef)(null);return o.createElement(o.Fragment,null,o.createElement(Gk,{className:"mx_AuthBody_icon"}),o.createElement("h1",null,(0,l._t)("auth|enter_email_heading")),o.createElement("p",{className:"mx_AuthBody_text"},(0,l._t)("auth|enter_email_explainer",{homeserver:i},{b:e=>o.createElement("b",null,e)})),o.createElement("form",{onSubmit:async e=>{var t,i,n;await(null===(t=d.current)||void 0===t?void 0:t.validate({allowEmpty:!1}))?r(e):(null===(i=d.current)||void 0===i||i.focus(),null===(n=d.current)||void 0===n||n.validate({allowEmpty:!1,focused:!0}))}},o.createElement("fieldset",{disabled:n},o.createElement("div",{className:"mx_AuthBody_fieldRow"},o.createElement(rb,{name:"reset_email",label:(0,l.I8)("common|email_address"),labelRequired:(0,l.I8)("auth|forgot_password_email_required"),labelInvalid:(0,l.I8)("auth|forgot_password_email_invalid"),value:e,autoFocus:!0,onChange:e=>s("email",e),fieldRef:d})),t&&o.createElement(qk,{message:t}),o.createElement("button",{type:"submit",className:"mx_Login_submit"},c),o.createElement("div",{className:"mx_AuthBody_button-container"},o.createElement(ae.Z,{className:"mx_AuthBody_sign-in-instead-button",element:"button",kind:"link",onClick:e=>{e.preventDefault(),a()}},(0,l._t)("auth|sign_in_instead"))))))};var Jk,Yk=i("../matrix-react-sdk/res/img/element-icons/email-prompt.svg");function Qk(){return Qk=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Qk.apply(this,arguments)}function Xk(e,t){return o.createElement("svg",Qk({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),Jk||(Jk=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M4.023 2.965a6.418 6.418 0 0110.36 4.369h1.29c.26 0 .416.291.271.509l-2.005 3.011a.327.327 0 01-.544 0l-2.006-3.011a.327.327 0 01.272-.51h1.21a4.918 4.918 0 00-7.918-3.192 3.673 3.673 0 01-.184.136l-.014.01-.004.003-.002.001h-.001v.001l-.415-.625.414.625a.75.75 0 01-.83-1.25l.003-.001.02-.014.083-.062zm-.895 5.702H4.34a.327.327 0 00.272-.51L2.606 5.147a.327.327 0 00-.545 0L.055 8.158c-.144.217.011.509.273.509h1.29a6.417 6.417 0 0010.503 4.251.75.75 0 00-.963-1.149 4.918 4.918 0 01-8.03-3.102z",fill:"currentColor"})))}var ex=o.forwardRef(Xk);const tx=(e,t)=>{const i=(0,o.useRef)(),[n,s]=(0,o.useState)(e);return(0,o.useEffect)((()=>()=>{clearTimeout(i.current)})),{toggle:()=>{s(!e),i.current=window.setTimeout((()=>s(e)),t)},value:n}},ix=({email:e,errorText:t,onReEnterEmailClick:i,onSubmitForm:n,onResendClick:s})=>{const a=(0,o.useRef)(`mx_CheckEmail_${Math.random()}`).current,{toggle:r,value:c}=tx(!1,2500);return o.createElement(o.Fragment,null,o.createElement(Yk.J,{className:"mx_AuthBody_emailPromptIcon--shifted"}),o.createElement("h1",null,(0,l._t)("auth|uia|email_auth_header")),o.createElement("div",{className:"mx_AuthBody_text"},o.createElement("p",null,(0,l._t)("auth|check_email_explainer",{email:e},{b:e=>o.createElement("b",null,e)})),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_wrong_email_prompt")),o.createElement(ae.Z,{className:"mx_AuthBody_resend-button",kind:"link",onClick:i},(0,l._t)("auth|check_email_wrong_email_button")))),t&&o.createElement(qk,{message:t}),o.createElement("input",{onClick:n,type:"button",className:"mx_Login_submit",value:(0,l._t)("action|next")}),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_resend_prompt")),o.createElement(ae.Z,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await s(),r()},"aria-describedby":c?a:void 0},o.createElement(ex,{className:"mx_Icon mx_Icon_16"}),(0,l._t)("action|resend"),o.createElement(si.Z,{id:a,label:(0,l._t)("auth|check_email_resend_tooltip"),alignment:si.v.Top,visible:c}))))},nx=({email:e,errorText:t,onCloseClick:i,onReEnterEmailClick:n,onResendClick:s})=>{const a=(0,o.useRef)(`mx_VerifyEmailModal_${Math.random()}`).current,{toggle:r,value:c}=tx(!1,2500);return o.createElement(o.Fragment,null,o.createElement(Yk.J,{className:"mx_AuthBody_emailPromptIcon"}),o.createElement("h1",null,(0,l._t)("auth|verify_email_heading")),o.createElement("p",null,(0,l._t)("auth|verify_email_explainer",{email:e},{b:e=>o.createElement("b",null,e)})),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_resend_prompt")),o.createElement(ae.Z,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await s(),r()},"aria-describedby":c?a:void 0},o.createElement(ex,{className:"mx_Icon mx_Icon_16"}),(0,l._t)("action|resend"),o.createElement(si.Z,{id:a,label:(0,l._t)("auth|check_email_resend_tooltip"),alignment:si.v.Top,visible:c})),t&&o.createElement(qk,{message:t})),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,l._t)("auth|check_email_wrong_email_prompt")),o.createElement(ae.Z,{className:"mx_AuthBody_resend-button",kind:"link",onClick:n},(0,l._t)("auth|check_email_wrong_email_button"))),o.createElement(ae.Z,{onClick:i,className:"mx_Dialog_cancelButton","aria-label":(0,l._t)("dialog_close_label")}))};var sx=function(e){return e[e.EnterEmail=1]="EnterEmail",e[e.SendingEmail=2]="SendingEmail",e[e.EmailSent=3]="EmailSent",e[e.PasswordInput=4]="PasswordInput",e[e.ResettingPassword=5]="ResettingPassword",e[e.Done=6]="Done",e}(sx||{});class ox extends o.Component{constructor(e){super(e),(0,k.Z)(this,"reset",void 0),(0,k.Z)(this,"fieldPassword",null),(0,k.Z)(this,"fieldPasswordConfirm",null),(0,k.Z)(this,"sendVerificationMail",(async()=>{try{return await this.reset.requestResetToken(this.state.email),!0}catch(e){this.handleError(e)}return!1})),(0,k.Z)(this,"onSubmitForm",(async e=>{if(e.preventDefault(),![sx.SendingEmail,sx.ResettingPassword].includes(this.state.phase)&&(this.setState({errorText:""}),await this.checkServerLiveliness(this.props.serverConfig),this.state.serverIsAlive))switch(this.state.phase){case sx.EnterEmail:this.onPhaseEmailInputSubmit();break;case sx.EmailSent:this.onPhaseEmailSentSubmit();break;case sx.PasswordInput:this.onPhasePasswordInputSubmit()}})),(0,k.Z)(this,"onInputChanged",((e,t)=>{let i=t.currentTarget.value;"email"===e&&(i=i.trim()),this.setState({[e]:i})})),this.state={phase:sx.EnterEmail,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverDeadError:"",logoutDevices:!1},this.reset=new Nk(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.checkServerLiveliness(this.props.serverConfig)}async checkServerLiveliness(e){try{await u.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0})}catch(e){const{serverIsAlive:t,serverDeadError:i}=u.authComponentStateForError(e,"forgot_password");this.setState({serverIsAlive:t,errorText:i})}}async onPhaseEmailInputSubmit(){this.phase=sx.SendingEmail,await this.sendVerificationMail()?this.phase=sx.EmailSent:this.phase=sx.EnterEmail}handleError(e){if(429!==(null==e?void 0:e.httpStatus))"ConnectionError"!==(null==e?void 0:e.name)?this.setState({errorText:e.message}):this.setState({errorText:(0,l._t)("cannot_reach_homeserver")+": "+(0,l._t)("cannot_reach_homeserver_detail")});else{var t;const i=parseInt(null==e||null===(t=e.data)||void 0===t?void 0:t.retry_after_ms,10),n=isNaN(i)?(0,l._t)("auth|reset_password|rate_limit_error"):(0,l._t)("auth|reset_password|rate_limit_error_with_time",{timeout:(0,Oe.ZC)(i/1e3)});this.setState({errorText:n})}}async onPhaseEmailSentSubmit(){this.setState({phase:sx.PasswordInput})}set phase(e){this.setState({phase:e})}async verifyFieldsBeforeSubmit(){const e=[this.fieldPassword,this.fieldPasswordConfirm],t=[];for(const i of e){if(!i)continue;await i.validate({allowEmpty:!1})||t.push(i)}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}async onPhasePasswordInputSubmit(){if(!await this.verifyFieldsBeforeSubmit())return;if(this.state.logoutDevices){if(!await this.renderConfirmLogoutDevicesDialog())return}this.phase=sx.ResettingPassword,this.reset.setLogoutDevices(this.state.logoutDevices);try{return await this.reset.setNewPassword(this.state.password),void this.setState({phase:sx.Done})}catch(e){if(401!==e.httpStatus)return void this.handleError(e)}const e=T.ZP.createDialog(nx,{email:this.state.email,errorText:this.state.errorText,onCloseClick:()=>{e.close(),this.setState({phase:sx.PasswordInput})},onReEnterEmailClick:()=>{e.close(),this.setState({phase:sx.EnterEmail})},onResendClick:this.sendVerificationMail},"mx_VerifyEMailDialog",!1,!1,{onBeforeClose:async e=>("backgroundClick"===e&&this.setState({phase:sx.PasswordInput}),!0)});for(;this.state.phase===sx.ResettingPassword;)try{await this.reset.setNewPassword(this.state.password),this.setState({phase:sx.Done}),e.close()}catch(e){await(0,xa._v)(2e3)}}renderEnterEmail(){return o.createElement($k,{email:this.state.email,errorText:this.state.errorText,homeserver:this.props.serverConfig.hsName,loading:this.state.phase===sx.SendingEmail,onInputChanged:this.onInputChanged,onLoginClick:this.props.onLoginClick,onSubmitForm:this.onSubmitForm})}async renderConfirmLogoutDevicesDialog(){const{finished:e}=T.ZP.createDialog(mt.Z,{title:(0,l._t)("common|warning"),description:o.createElement("div",null,o.createElement("p",null,(0,l._t)("auth|reset_password|other_devices_logout_warning_1")),o.createElement("p",null,(0,l._t)("auth|reset_password|other_devices_logout_warning_2"))),button:(0,l._t)("action|continue")}),[t]=await e;return!!t}renderCheckEmail(){return o.createElement(ix,{email:this.state.email,errorText:this.state.errorText,onReEnterEmailClick:()=>this.setState({phase:sx.EnterEmail}),onResendClick:this.sendVerificationMail,onSubmitForm:this.onSubmitForm})}renderSetPassword(){const e=this.state.phase===sx.ResettingPassword?o.createElement(re.Z,{w:16,h:16}):(0,l._t)("auth|reset_password_action");return o.createElement(o.Fragment,null,o.createElement(jk,{className:"mx_AuthBody_lockIcon"}),o.createElement("h1",null,(0,l._t)("auth|reset_password_title")),o.createElement("form",{onSubmit:this.onSubmitForm},o.createElement("fieldset",{disabled:this.state.phase===sx.ResettingPassword},o.createElement("div",{className:"mx_AuthBody_fieldRow"},o.createElement(ob.Z,{name:"reset_password",type:"password",label:(0,l.I8)("auth|change_password_new_label"),value:this.state.password,minScore:3,fieldRef:e=>this.fieldPassword=e,onChange:this.onInputChanged.bind(this,"password"),autoComplete:"new-password"}),o.createElement(cb.Z,{name:"reset_password_confirm",label:(0,l.I8)("auth|reset_password|confirm_new_password"),labelRequired:(0,l.I8)("auth|reset_password|password_not_entered"),labelInvalid:(0,l.I8)("auth|reset_password|passwords_mismatch"),value:this.state.password2,password:this.state.password,fieldRef:e=>this.fieldPasswordConfirm=e,onChange:this.onInputChanged.bind(this,"password2"),autoComplete:"new-password"})),o.createElement("div",{className:"mx_AuthBody_fieldRow"},o.createElement(qs.Z,{onChange:()=>this.setState({logoutDevices:!this.state.logoutDevices}),checked:this.state.logoutDevices},(0,l._t)("auth|reset_password|sign_out_other_devices"))),this.state.errorText&&o.createElement(qk,{message:this.state.errorText}),o.createElement("button",{type:"submit",className:"mx_Login_submit"},e))))}renderDone(){return o.createElement(o.Fragment,null,o.createElement(Uk,{className:"mx_Icon mx_Icon_32 mx_Icon_accent"}),o.createElement("h1",null,(0,l._t)("auth|reset_password|reset_successful")),this.state.logoutDevices?o.createElement("p",null,(0,l._t)("auth|reset_password|devices_logout_success")):null,o.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:(0,l._t)("auth|reset_password|return_to_login")}))}render(){let e;switch(this.state.phase){case sx.EnterEmail:case sx.SendingEmail:e=this.renderEnterEmail();break;case sx.EmailSent:e=this.renderCheckEmail();break;case sx.PasswordInput:case sx.ResettingPassword:e=this.renderSetPassword();break;case sx.Done:e=this.renderDone();break;default:return r.k.warn(`unknown forgot password phase ${this.state.phase}`),void this.setState({phase:sx.EnterEmail})}return o.createElement(xk,null,o.createElement(Dk,null),o.createElement(Mk,{className:"mx_AuthBody_forgot-password"},e))}}class ax extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"doBootstrapUIAuth",(async e=>{if(this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword)await e({type:"m.login.password",identifier:{type:"m.id.user",user:E.p.safeGet().getUserId()},user:E.p.safeGet().getUserId(),password:this.state.accountPassword});else if(this.props.tokenLogin)await e({});else{const t={[Fy.Rt.PHASE_PREAUTH]:{title:(0,l._t)("auth|uia|sso_title"),body:(0,l._t)("auth|uia|sso_preauth_body"),continueText:(0,l._t)("auth|sso"),continueKind:"primary"},[Fy.Rt.PHASE_POSTAUTH]:{title:(0,l._t)("encryption|confirm_encryption_setup_title"),body:(0,l._t)("encryption|confirm_encryption_setup_body"),continueText:(0,l._t)("action|confirm"),continueKind:"primary"}},{finished:i}=T.ZP.createDialog(te.Z,{title:(0,l._t)("encryption|bootstrap_title"),matrixClient:E.p.safeGet(),makeRequest:e,aestheticsForStagePhases:{[Fy.Rt.LOGIN_TYPE]:t,[Fy.Rt.UNSTABLE_LOGIN_TYPE]:t}}),[n]=await i;if(!n)throw new Error("Cross-signing key upload auth canceled")}})),(0,k.Z)(this,"bootstrapCrossSigning",(async()=>{this.setState({error:!1});try{const e=E.p.safeGet();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:this.doBootstrapUIAuth}),this.props.onFinished(!0)}catch(e){if(this.props.tokenLogin)return void this.props.onFinished(!1);this.setState({error:!0}),r.k.error("Error bootstrapping cross-signing",e)}})),(0,k.Z)(this,"onCancel",(()=>{this.props.onFinished(!1)})),this.state={error:!1,canUploadKeysWithPasswordOnly:!!e.accountPassword||null,accountPassword:e.accountPassword||""},this.state.accountPassword||this.queryKeyUploadAuth()}componentDidMount(){this.bootstrapCrossSigning()}async queryKeyUploadAuth(){try{await E.p.safeGet().uploadDeviceSigningKeys(void 0,{}),r.k.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!")}catch(e){if(!(e instanceof n.MatrixError&&e.data&&e.data.flows))return void r.k.log("uploadDeviceSigningKeys advertised no flows!");const t=e.data.flows.some((e=>1===e.stages.length&&"m.login.password"===e.stages[0]));this.setState({canUploadKeysWithPasswordOnly:t})}}render(){let e;return e=this.state.error?o.createElement("div",null,o.createElement("p",null,(0,l._t)("encryption|unable_to_setup_keys_error")),o.createElement("div",{className:"mx_Dialog_buttons"},o.createElement(gt.Z,{primaryButton:(0,l._t)("action|retry"),onPrimaryButtonClick:this.bootstrapCrossSigning,onCancel:this.onCancel}))):o.createElement("div",null,o.createElement(re.Z,null)),o.createElement(q.Z,{className:"mx_CreateCrossSigningDialog",onFinished:this.props.onFinished,title:(0,l._t)("encryption|bootstrap_title"),hasCancel:!1,fixedWidth:!1},o.createElement("div",null,e))}}class rx extends o.Component{render(){return o.createElement(xk,null,o.createElement(wk,null,o.createElement(ax,{onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}}const lx=["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini","action","flow"],cx=e=>{let t,{matrixClient:s,loginType:r,fragmentAfterLogin:c,idp:d,primary:m,mini:h,action:p,flow:u}=e,g=(0,v.Z)(e,lx);t=d?(0,l._t)("auth|continue_with_idp",{provider:d.name}):n.DELEGATED_OIDC_COMPATIBILITY.findIn(u)?(0,l._t)("action|continue"):(0,l._t)("auth|sign_in_with_sso");const _=()=>{var e,t;const i=(e=>{switch(e){case n.IdentityProviderBrand.Apple:return"Apple";case n.IdentityProviderBrand.Facebook:return"Facebook";case n.IdentityProviderBrand.Github:return"GitHub";case n.IdentityProviderBrand.Gitlab:return"GitLab";case n.IdentityProviderBrand.Google:return"Google";default:return"SSO"}})(null!==(e=null==d?void 0:d.brand)&&void 0!==e?e:"");rt.S.instance.setAuthenticationType(i),null===(t=a.Z.get())||void 0===t||t.startSingleSignOn(s,r,c,null==d?void 0:d.id,p)};let f,E;const y=null!=d&&d.brand?(e=>{switch(e){case n.IdentityProviderBrand.Apple:return i("../matrix-react-sdk/res/img/element-icons/brands/apple.svg").Z;case n.IdentityProviderBrand.Facebook:return i("../matrix-react-sdk/res/img/element-icons/brands/facebook.svg").Z;case n.IdentityProviderBrand.Github:return i("../matrix-react-sdk/res/img/element-icons/brands/github.svg").Z;case n.IdentityProviderBrand.Gitlab:return i("../matrix-react-sdk/res/img/element-icons/brands/gitlab.svg").Z;case n.IdentityProviderBrand.Google:return i("../matrix-react-sdk/res/img/element-icons/brands/google.svg").Z;case n.IdentityProviderBrand.Twitter:return i("../matrix-react-sdk/res/img/element-icons/brands/twitter.svg").Z;default:return null}})(d.brand):null;if(null!=d&&d.brand&&y){const e=d.brand.split(".").pop();E=`mx_SSOButton_brand_${e}`,f=o.createElement("img",{src:y,height:"24",width:"24",alt:e})}else if("string"==typeof(null==d?void 0:d.icon)&&d.icon.startsWith("mxc://")){var b;const e=null!==(b=(0,mn.TS)(d.icon,s).getSquareThumbnailHttp(24))&&void 0!==b?b:void 0;f=o.createElement("img",{src:e,height:"24",width:"24",alt:d.name})}const w=E?{[E]:E}:void 0,S=yt()("mx_SSOButton",{mx_SSOButton_mini:h,mx_SSOButton_default:!d,mx_SSOButton_primary:m},w);return h?o.createElement(gs.Z,(0,kt.Z)({},g,{title:t,className:S,onClick:_}),f):o.createElement(ae.Z,(0,kt.Z)({},g,{className:S,onClick:_}),f,t)},dx=({matrixClient:e,flow:t,loginType:i,fragmentAfterLogin:n,primary:s,action:a})=>{const r=t.identity_providers||[];if(r.length<2)return o.createElement("div",{className:"mx_SSOButtons"},o.createElement(cx,{matrixClient:e,loginType:i,fragmentAfterLogin:n,idp:r[0],primary:s,action:a,flow:t}));const l=Math.ceil(r.length/6),c=Math.ceil(r.length/l);return o.createElement("div",{className:"mx_SSOButtons"},(0,ln.chunk)(r,c).map((r=>o.createElement("div",{key:r[0].id,className:"mx_SSOButtons_row"},r.map((r=>o.createElement(cx,{key:r.id,matrixClient:e,loginType:i,fragmentAfterLogin:n,idp:r,mini:!0,primary:s,action:a,flow:t})))))))};class mx extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"defaultServer",void 0),(0,k.Z)(this,"fieldRef",(0,o.createRef)()),(0,k.Z)(this,"validatedConf",void 0),(0,k.Z)(this,"onDefaultChosen",(()=>{this.setState({defaultChosen:!0})})),(0,k.Z)(this,"onOtherChosen",(()=>{this.setState({defaultChosen:!1})})),(0,k.Z)(this,"onHomeserverChange",(e=>{this.setState({otherHomeserver:e.target.value})})),(0,k.Z)(this,"validate",(0,Nh.Z)({deriveData:async({value:e})=>{let t=(null!=e?e:"").trim();if(!t.includes("://"))try{const e=await n.AutoDiscovery.findClientConfig(t);return this.validatedConf=u.buildValidatedConfigFromDiscovery(t,e),{}}catch(e){r.k.error(`Attempted ${t} as a server_name but it failed`,e)}t.includes("://")||(t="https://"+t);try{return this.validatedConf=await u.validateServerConfigWithStaticUrls(t),{}}catch(e){r.k.error(e);if(u.authComponentStateForError(e).serverErrorIsFatal){let t=(0,l._t)("auth|server_picker_failed_validate_homeserver");return e instanceof l.yh&&e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await u.validateServerConfigWithStaticUrls(t,void 0,!0),{}}catch(e){return r.k.error(e),{error:(0,l._t)("auth|server_picker_invalid_url")}}}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|server_picker_required")},{key:"valid",test:async function({value:e},{error:t}){return!e||!t},invalid:function({error:e}){return null!=e?e:null}}]})),(0,k.Z)(this,"onHomeserverValidate",(e=>this.validate(e))),(0,k.Z)(this,"onSubmit",(async e=>{var t;if(e.preventDefault(),this.state.defaultChosen)return void this.props.onFinished(this.defaultServer);var i,n;if(!await(null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate({allowEmpty:!1})))return null===(i=this.fieldRef.current)||void 0===i||i.focus(),void(null===(n=this.fieldRef.current)||void 0===n||n.validate({allowEmpty:!1,focused:!0}));this.props.onFinished(this.validatedConf)}));const t=c.ZP.get();this.defaultServer=t.validated_server_config;const{serverConfig:i}=this.props;let s="";i.isDefault||(s=i.isNameResolvable&&i.hsName?i.hsName:i.hsUrl),this.state={defaultChosen:i.isDefault,otherHomeserver:s}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=(0,l._t)("auth|server_picker_matrix.org"));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=o.createElement(Bm.Z,{class:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),o.createElement(q.Z,{title:this.props.title||(0,l._t)("auth|server_picker_title"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},o.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},o.createElement("p",null,(0,l._t)("auth|server_picker_intro")," ",e),o.createElement(Bs.Z,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen,"data-testid":"defaultHomeserver"},t),o.createElement(Bs.Z,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen,childrenInLabel:!1,"aria-label":(0,l._t)("auth|server_picker_custom")},o.createElement(Vs.Z,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:(0,l._t)("auth|server_picker_custom"),onChange:this.onHomeserverChange,onFocus:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,autoFocus:!0,id:"mx_homeserverInput"})),o.createElement("p",null,(0,l._t)("auth|server_picker_explainer")),o.createElement(ae.Z,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},(0,l._t)("action|continue")),o.createElement("h2",null,(0,l._t)("action|learn_more")),o.createElement(Cl.Z,{href:"https://matrix.org/docs/matrix-concepts/elements-of-matrix/#homeserver",target:"_blank",rel:"noreferrer noopener"},(0,l._t)("auth|server_picker_learn_more"))))}}const hx=()=>{const e=c.ZP.get().brand;T.ZP.createDialog(Sl.Z,{title:(0,l._t)("auth|server_picker_title_default"),description:(0,l._t)("auth|server_picker_description",{brand:e}),button:(0,l._t)("action|dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")},px=({title:e,dialogTitle:t,serverConfig:i,onServerConfigChange:n})=>{const s=c.ZP.get("disable_custom_urls");let a;if(!s&&n){const e=()=>{((e,t,i)=>{T.ZP.createDialog(mx,{title:e,serverConfig:t,onFinished:i})})(t,i,(e=>{e&&n(e)}))};a=o.createElement(ae.Z,{className:"mx_ServerPicker_change",kind:"link",onClick:e},(0,l._t)("action|edit"))}let r,d=i.isNameResolvable?i.hsName:i.hsUrl;return i.hsNameIsDifferent&&(d=o.createElement(Bm.Z,{class:"mx_Login_underlinedServerName",tooltip:i.hsUrl},i.hsName)),"matrix.org"===i.hsName&&(r=o.createElement("span",{className:"mx_ServerPicker_desc"},(0,l._t)("auth|server_picker_description_matrix.org"))),o.createElement("div",{className:"mx_ServerPicker"},o.createElement("h2",null,e||(0,l._t)("common|homeserver")),s?null:o.createElement(ae.Z,{className:"mx_ServerPicker_help",onClick:hx,"aria-label":(0,l._t)("common|help")}),o.createElement("span",{className:"mx_ServerPicker_server",title:"string"==typeof d?d:void 0},d),a,r)};var ux=i("../matrix-react-sdk/src/components/structures/auth/header/AuthHeaderContext.tsx");function gx({title:e,icon:t,serverPicker:i,children:n}){var s,a,r;const l=(0,o.useContext)(ux.B);if(!l)return o.createElement(o.Fragment,null);const c=null!==(s=l.state[0])&&void 0!==s?s:null;return o.createElement(o.Fragment,null,null!==(a=null==c?void 0:c.icon)&&void 0!==a?a:t,o.createElement("h1",null,null!==(r=null==c?void 0:c.title)&&void 0!==r?r:e),n,!0!==(null==c?void 0:c.hideServerPicker)&&i)}var vx=i("../matrix-react-sdk/src/components/structures/auth/header/AuthHeaderProvider.tsx");function _x(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const fx=(...e)=>{L.C.getValue("debug_registration")&&r.k.log.call(console,"Registration debuglog:",...e)};class Ex extends o.Component{constructor(e){super(e),(0,k.Z)(this,"loginLogic",void 0),(0,k.Z)(this,"latestServerConfig",void 0),(0,k.Z)(this,"oidcNativeFlowEnabled",!1),(0,k.Z)(this,"unloadCallback",(e=>{if(this.state.doingUIAuth)return e.preventDefault(),e.returnValue="",""})),(0,k.Z)(this,"onFormSubmit",(async e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})})),(0,k.Z)(this,"requestEmailToken",((e,t,i,n)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");return this.state.matrixClient.requestRegisterEmailToken(e,t,i)})),(0,k.Z)(this,"onUIAuthFinished",(async(e,t)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");if(fx("Registration: ui authentication finished: ",{success:e,response:t}),!e){var i;let e=t.message||t.toString();if(t instanceof n.MatrixError&&"M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const i=(0,Io.Lv)(t.data.limit_type,t.data.admin_contact,Io.gM),n=(0,Io.Lv)(t.data.limit_type,t.data.admin_contact,Io.EJ);e=o.createElement("div",null,o.createElement("p",null,i),o.createElement("p",null,n))}else if(null!==(i=t.flows)&&void 0!==i&&i.some((e=>e.stages.includes(n.AuthType.Msisdn)))){var s;(null!==(s=t.flows)&&void 0!==s?s:[]).some((e=>e.stages.includes(n.AuthType.Msisdn)))||(e=(0,l._t)("auth|unsupported_auth_msisdn"))}else t instanceof n.MatrixError&&"M_USER_IN_USE"===t.errcode?e=(0,l._t)("auth|username_in_use"):t instanceof n.MatrixError&&"M_THREEPID_IN_USE"===t.errcode&&(e=(0,l._t)("auth|3pid_in_use"));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}const a=t.user_id,c=t.access_token;if(!a||!c)throw new Error("Registration failed");E.p.setJustRegisteredUserId(a);const d={doingUIAuth:!1,registeredUsername:a,differentLoggedInUserId:void 0,completedNoSignin:!1,busy:!0},[m,h]=await sa();m&&!h&&m!==a&&(r.k.log(`Found a session for ${m} but ${a} has just registered.`),d.differentLoggedInUserId=m);const p=Boolean(this.state.formVals.email),u=Boolean(c);fx("Registration: ui auth finished:",{hasEmail:p,hasAccessToken:u}),u&&!d.differentLoggedInUserId?(await this.props.onLoggedIn({userId:a,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:c},this.state.formVals.password),this.setupPushers()):(d.busy=!1,d.completedNoSignin=!0),this.setState(d)})),(0,k.Z)(this,"onLoginClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()})),(0,k.Z)(this,"onGoToFormClicked",(e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})})),(0,k.Z)(this,"makeRegisterRequest",(e=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");const t={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(t.auth=e),fx("Registration: sending registration request:",e),this.state.matrixClient.registerRequest(t)})),(0,k.Z)(this,"onLoginClickWithCheck",(async e=>{e.preventDefault();const t=await na({ignoreGuest:!0});return t||this.props.onLoginClick(),t})),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.oidcNativeFlowEnabled=L.C.getValue(mg.AN.OidcNativeFlow);const{hsUrl:t,isUrl:i,delegatedAuthentication:s}=this.props.serverConfig;this.loginLogic=new D(t,i,null,{defaultDeviceDisplayName:"Element login check",delegatedAuthentication:this.oidcNativeFlowEnabled?s:void 0})}componentDidMount(){this.replaceClient(this.props.serverConfig),window.addEventListener("beforeunload",this.unloadCallback)}componentWillUnmount(){window.removeEventListener("beforeunload",this.unloadCallback)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(this.props.serverConfig)}async replaceClient(e){this.latestServerConfig=e;const{hsUrl:t,isUrl:i}=e;this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{if(await u.validateServerConfigWithStaticUrls(t,i),e!==this.latestServerConfig)return;this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(t){if(e!==this.latestServerConfig)return;if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?_x(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):_x(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({busy:!1},u.authComponentStateForError(t,"register"))),this.state.serverErrorIsFatal)return}const s=(0,n.createClient)({baseUrl:t,idBaseUrl:i});this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(i);const o=this.oidcNativeFlowEnabled?e.delegatedAuthentication:void 0;let a,c;this.loginLogic.setDelegatedAuthentication(o);try{const t=await this.loginLogic.getFlows(!0);if(e!==this.latestServerConfig)return;a=t.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type)),c=t.find((e=>"oidcNativeFlow"===e.type))}catch(t){if(e!==this.latestServerConfig)return;r.k.error("Failed to get login flows to check for SSO support",t)}if(this.setState((({flows:e})=>({matrixClient:s,ssoFlow:a,oidcNativeFlow:c,flows:c?[]:e,busy:!1}))),!c)try{if(!this.state.doingUIAuth){if(await this.makeRegisterRequest(null),e!==this.latestServerConfig)return;r.k.log("Expecting 401 from register request but got success!")}}catch(t){if(e!==this.latestServerConfig)return;t instanceof n.MatrixError&&401===t.httpStatus?this.setState({flows:t.data.flows}):t instanceof n.MatrixError&&(403===t.httpStatus||"M_FORBIDDEN"===t.errcode)?a?x.ZP.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:(0,l._t)("auth|registration_disabled"),flows:[]}):(r.k.log("Unable to query for supported registration methods.",t),this.setState({errorText:(0,l._t)("auth|failed_query_registration_methods"),flows:[]}))}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=E.p.safeGet();return e.getPushers().then((t=>{const i=t.pushers;for(let t=0;t<i.length;++t)if("email"===i[t].kind){const n=i[t];n.data={brand:this.props.brand},e.setPusher(n).then((()=>{r.k.log("Set email branding to "+this.props.brand)}),(e=>{r.k.error("Couldn't set email branding: "+e)}))}}),(e=>{r.k.error("Couldn't get pushers: "+e)}))}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){if(this.state.matrixClient&&this.state.doingUIAuth)return o.createElement(Uy.Z,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return o.createElement("div",{className:"mx_AuthBody_spinner"},o.createElement(re.Z,null));if(this.state.matrixClient&&this.state.oidcNativeFlow)return o.createElement(ae.Z,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await Mo(this.props.serverConfig.delegatedAuthentication,this.state.oidcNativeFlow.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl,!0)}},(0,l._t)("action|continue"));if(this.state.matrixClient&&this.state.flows.length){let e;if(this.state.ssoFlow){let t;(this.state.ssoFlow.identity_providers||[]).length>1&&(t=o.createElement("h2",{className:"mx_AuthBody_centered"},(0,l._t)("auth|continue_with_sso",{ssoButtons:""}).trim())),e=o.createElement(o.Fragment,null,t,o.createElement(dx,{matrixClient:this.loginLogic.createTemporaryClient(),flow:this.state.ssoFlow,loginType:"m.login.sso"===this.state.ssoFlow.type?"sso":"cas",fragmentAfterLogin:this.props.fragmentAfterLogin,action:n.SSOAction.REGISTER}),o.createElement("h2",{className:"mx_AuthBody_centered"},(0,l._t)("auth|sso_or_username_password",{ssoButtons:"",usernamePassword:""}).trim()))}return o.createElement(o.Fragment,null,e,o.createElement(_b,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,matrixClient:this.state.matrixClient}))}return null}render(){let e;const t=this.state.errorText;let i;if(t&&(e=o.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=yt()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});i=o.createElement("div",{className:e},this.state.serverDeadError)}const n=o.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,l._t)("auth|sign_in_instead_prompt",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.onLoginClick},e)}));let s,a;if(this.state.doingUIAuth&&(s=o.createElement(ae.Z,{kind:"link",className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked},(0,l._t)("action|go_back"))),this.state.completedNoSignin){let e;e=this.state.differentLoggedInUserId?o.createElement("div",null,o.createElement("p",null,(0,l._t)("auth|account_clash",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),o.createElement("p",null,o.createElement(ae.Z,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&x.ZP.dispatch({action:"view_welcome_page"})}},(0,l._t)("auth|account_clash_previous_account")))):o.createElement("h2",null,(0,l._t)("auth|log_in_new_account",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&x.ZP.dispatch({action:"view_home_page"})}},e)})),a=o.createElement("div",null,o.createElement("h1",null,(0,l._t)("auth|registration_successful")),e)}else a=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_Register_mainContent"},o.createElement(gx,{title:(0,l._t)("auth|create_account_title"),serverPicker:o.createElement(px,{title:(0,l._t)("auth|server_picker_title_registration"),dialogTitle:(0,l._t)("auth|server_picker_dialog_title"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange})},e,i),this.renderRegisterComponent()),o.createElement("div",{className:"mx_Register_footerActions"},s,n));return o.createElement(xk,null,o.createElement(Dk,null),o.createElement(vx.K,null,o.createElement(Mk,{flex:!0},a)))}}let yx,bx,wx;const Sx=/^[0-9()\-\s]*$/;var Cx=function(e){return e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_phone",e}(Cx||{});yx=Cx.Email,bx=Cx.Phone,wx=Cx.MatrixId;class kx extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,yx,null),(0,k.Z)(this,bx,null),(0,k.Z)(this,wx,null),(0,k.Z)(this,"onForgotPasswordClick",(e=>{var t,i;e.preventDefault(),e.stopPropagation(),null===(t=(i=this.props).onForgotPasswordClick)||void 0===t||t.call(i)})),(0,k.Z)(this,"onSubmitForm",(async e=>{e.preventDefault();if(await this.verifyFieldsBeforeSubmit())switch(this.state.loginType){case Cx.Email:case Cx.MatrixId:this.props.onSubmit(this.props.username,void 0,void 0,this.state.password);break;case Cx.Phone:this.props.onSubmit(void 0,this.props.phoneCountry,this.props.phoneNumber,this.state.password)}})),(0,k.Z)(this,"onUsernameChanged",(e=>{var t,i;null===(t=(i=this.props).onUsernameChanged)||void 0===t||t.call(i,e.target.value)})),(0,k.Z)(this,"onUsernameBlur",(e=>{var t,i;null===(t=(i=this.props).onUsernameBlur)||void 0===t||t.call(i,e.target.value)})),(0,k.Z)(this,"onLoginTypeChange",(e=>{var t,i;const n=e.target.value;this.setState({loginType:n}),null===(t=(i=this.props).onUsernameChanged)||void 0===t||t.call(i,"")})),(0,k.Z)(this,"onPhoneCountryChanged",(e=>{var t,i;null===(t=(i=this.props).onPhoneCountryChanged)||void 0===t||t.call(i,e.iso2)})),(0,k.Z)(this,"onPhoneNumberChanged",(e=>{var t,i;null===(t=(i=this.props).onPhoneNumberChanged)||void 0===t||t.call(i,e.target.value)})),(0,k.Z)(this,"onPasswordChanged",(e=>{this.setState({password:e.target.value})})),(0,k.Z)(this,"validateUsernameRules",(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|username_field_required_invalid")}]})),(0,k.Z)(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(Cx.MatrixId,t.valid),t})),(0,k.Z)(this,"onEmailValidate",(e=>{this.markFieldValid(Cx.Email,e.valid)})),(0,k.Z)(this,"validatePhoneNumberRules",(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|msisdn_field_required_invalid")},{key:"number",test:({value:e})=>!e||Sx.test(e),invalid:()=>(0,l._t)("auth|msisdn_field_number_invalid")}]})),(0,k.Z)(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(Cx.Password,t.valid),t})),(0,k.Z)(this,"validatePasswordRules",(0,Nh.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,l._t)("auth|password_field_label")}]})),(0,k.Z)(this,"onPasswordValidate",(async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(Cx.Password,t.valid),t})),this.state={fieldValid:{},loginType:Cx.MatrixId,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,Cx.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const i=this.findFirstInvalidField(t);return!i||(i.focus(),i.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:i}=this.state;i[e]=t,this.setState({fieldValid:i})}renderLoginField(e,t){const i={error:!1};switch(e){case Cx.Email:return i.error=this.props.loginIncorrect&&!this.props.username,o.createElement(rb,{id:"mx_LoginForm_email",className:yt()(i),name:"username",autoComplete:"email",type:"email",key:"email_input",placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onEmailValidate,fieldRef:e=>{this[Cx.Email]=e}});case Cx.MatrixId:return i.error=this.props.loginIncorrect&&!this.props.username,o.createElement(Vs.Z,{id:"mx_LoginForm_username",className:yt()(i),name:"username",autoComplete:"username",key:"username_input",type:"text",label:(0,l._t)("common|username"),placeholder:(0,l._t)("common|username").toLocaleLowerCase(),value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>{this[Cx.MatrixId]=e}});case Cx.Phone:{i.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=o.createElement(Jy,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return o.createElement(Vs.Z,{id:"mx_LoginForm_phone",className:yt()(i),name:"phoneNumber",autoComplete:"tel-national",key:"phone_input",type:"text",label:(0,l._t)("auth|msisdn_field_label"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,disabled:this.props.busy,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>{this[Cx.Password]=e}})}}}isLoginEmpty(){switch(this.state.loginType){case Cx.Email:case Cx.MatrixId:return!this.props.username;case Cx.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=o.createElement(ae.Z,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},(0,l._t)("auth|reset_password_button")));const t=yt()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),i=!this.isLoginEmpty(),n=this.renderLoginField(this.state.loginType,!i);let s;return c.ZP.get().disable_3pid_login||(s=o.createElement("div",{className:"mx_Login_type_container"},o.createElement("label",{className:"mx_Login_type_label"},(0,l._t)("auth|identifier_label")),o.createElement(Vs.Z,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.busy},o.createElement("option",{key:Cx.MatrixId,value:Cx.MatrixId},(0,l._t)("common|username")),o.createElement("option",{key:Cx.Email,value:Cx.Email},(0,l._t)("common|email_address")),o.createElement("option",{key:Cx.Password,value:Cx.Password},(0,l._t)("auth|msisdn_field_label"))))),o.createElement("div",null,o.createElement("form",{onSubmit:this.onSubmitForm},s,n,o.createElement(Vs.Z,{id:"mx_LoginForm_password",className:t,autoComplete:"current-password",type:"password",name:"password",label:(0,l._t)("common|password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.busy,autoFocus:i,onValidate:this.onPasswordValidate,ref:e=>this[Cx.Password]=e}),e,!this.props.busy&&o.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,l._t)("action|sign_in"),disabled:this.props.disableSubmit})))}}function xx(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Rx(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?xx(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):xx(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}(0,k.Z)(kx,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1});class Ix extends o.PureComponent{constructor(e){super(e),(0,k.Z)(this,"unmounted",!1),(0,k.Z)(this,"oidcNativeFlowEnabled",!1),(0,k.Z)(this,"loginLogic",void 0),(0,k.Z)(this,"stepRendererMap",void 0),(0,k.Z)(this,"isBusy",(()=>!!this.state.busy||!!this.props.busy)),(0,k.Z)(this,"onPasswordLogin",(async(e,t,i,n)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await u.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const i=u.authComponentStateForError(t);this.setState(Rx({busy:!1,busyLoggingIn:!1},i)),e=!i.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this.loginLogic.loginViaPassword(e,t,i,n).then((e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,n)}),(t=>{if(this.unmounted)return;let i;i=400===t.httpStatus&&e&&e.indexOf("@")>0?(0,l._t)("auth|unsupported_auth_email"):(0,Io.$E)(t,this.props.serverConfig),this.setState({busy:!1,busyLoggingIn:!1,errorText:i,loginIncorrect:401===t.httpStatus||403===t.httpStatus})}))})),(0,k.Z)(this,"onUsernameChanged",(e=>{this.setState({username:e})})),(0,k.Z)(this,"onUsernameBlur",(async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await u.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){r.k.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=(0,l._t)("auth|failed_homeserver_discovery");e instanceof l.yh&&e.translatedMessage&&(t=e.translatedMessage);let i=t,n={};u.isLivelinessError(e)&&(i=this.state.errorText,n=u.authComponentStateForError(e)),this.setState(Rx({busy:!1,errorText:i},n))}}})),(0,k.Z)(this,"onPhoneCountryChanged",(e=>{this.setState({phoneCountry:e})})),(0,k.Z)(this,"onPhoneNumberChanged",(e=>{this.setState({phoneNumber:e})})),(0,k.Z)(this,"onRegisterClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()})),(0,k.Z)(this,"onTryRegisterClick",(e=>{var t,i;const s=null===(t=this.state.flows)||void 0===t?void 0:t.find((e=>"m.login.password"===e.type)),o=null===(i=this.state.flows)||void 0===i?void 0:i.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type));if(o&&!s){var r;e.preventDefault(),e.stopPropagation();const t="m.login.sso"===o.type?"sso":"cas";null===(r=a.Z.get())||void 0===r||r.startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin,void 0,n.SSOAction.REGISTER)}else this.onRegisterClick(e)})),(0,k.Z)(this,"isSupportedFlow",(e=>!!this.stepRendererMap[e.type]||(r.k.log("Skipping flow",e,"due to unsupported login type",e.type),!1))),(0,k.Z)(this,"renderPasswordStep",(()=>o.createElement(kx,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn}))),(0,k.Z)(this,"renderOidcNativeStep",(()=>{const e=this.state.flows.find((e=>"oidcNativeFlow"===e.type));return o.createElement(ae.Z,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await Mo(this.props.serverConfig.delegatedAuthentication,e.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}},(0,l._t)("action|continue"))})),(0,k.Z)(this,"renderSsoStep",(e=>{var t,i;const s=null===(t=this.state.flows)||void 0===t?void 0:t.find((t=>t.type==="m.login."+e));return o.createElement(dx,{matrixClient:this.loginLogic.createTemporaryClient(),flow:s,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!(null!==(i=this.state.flows)&&void 0!==i&&i.find((e=>"m.login.password"===e.type))),action:n.SSOAction.LOGIN})})),this.oidcNativeFlowEnabled=L.C.getValue(mg.AN.OidcNativeFlow),this.state={busy:!1,errorText:null,loginIncorrect:!1,canTryLogin:!0,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:"",phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso"),oidcNativeFlow:()=>this.renderOidcNativeStep()}}componentDidMount(){this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl&&e.serverConfig.delegatedAuthentication===this.props.serverConfig.delegatedAuthentication||this.initLoginLogic(this.props.serverConfig)}async checkServerLiveliness({hsUrl:e,isUrl:t}){try{const{warning:i}=await u.validateServerConfigWithStaticUrls(e,t);i?this.setState(Rx(Rx({},u.authComponentStateForError(i)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(Rx({busy:!1},u.authComponentStateForError(e)))}}async initLoginLogic({hsUrl:e,isUrl:t}){let i=!1;this.props.serverConfig.isDefault&&e===this.props.serverConfig.hsUrl&&t===this.props.serverConfig.isUrl&&(i=!0);const n=i?this.props.fallbackHsUrl:null;this.setState({busy:!0,loginIncorrect:!1}),await this.checkServerLiveliness({hsUrl:e,isUrl:t});const s=new D(e,t,n,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,delegatedAuthentication:this.oidcNativeFlowEnabled?this.props.serverConfig.delegatedAuthentication:void 0});this.loginLogic=s,s.getFlows().then((e=>{const t=e.filter(this.isSupportedFlow);this.setState({flows:t}),0===t.length&&this.setState({errorText:(0,l._t)("auth|unsupported_auth")})}),(e=>{this.setState({errorText:(0,Io.GP)(e,this.props.serverConfig),loginIncorrect:!1,canTryLogin:!1})})).finally((()=>{this.setState({busy:!1})}))}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=(0,ne.gP)(["oidcNativeFlow","m.login.password","m.login.sso"].map((e=>{var t;return null===(t=this.state.flows)||void 0===t?void 0:t.find((t=>t.type===e))})));return o.createElement(o.Fragment,null,e.map((e=>{const t=this.stepRendererMap[e.type];return o.createElement(o.Fragment,{key:e.type},t())})))}render(){const e=this.isBusy()&&!this.state.busyLoggingIn?o.createElement("div",{className:"mx_Login_loader"},o.createElement(re.Z,null)):null,t=this.state.errorText;let i,n,s;if(t&&(i=o.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=yt()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=o.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?s=o.createElement("div",{className:"mx_AuthBody_paddedFooter"},o.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},o.createElement(_r.Z,{w:20,h:20}),this.props.isSyncing?(0,l._t)("auth|syncing"):(0,l._t)("auth|signing_in")),this.props.isSyncing&&o.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},(0,l._t)("auth|sync_footer_subtitle"))):L.C.getValue(Ye.H.Registration)&&(s=o.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,l._t)("auth|create_account_prompt",{},{a:e=>o.createElement(ae.Z,{kind:"link_inline",onClick:this.onTryRegisterClick},e)}))),o.createElement(xk,null,o.createElement(Dk,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),o.createElement(Mk,null,o.createElement("h1",null,(0,l._t)("action|sign_in"),e),i,n,o.createElement(px,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),this.renderLoginComponentForFlows(),s))}}var Px=i("../matrix-react-sdk/src/utils/KeyVerificationStateObserver.ts");class Tx extends o.PureComponent{constructor(e){var t;super(e),(0,k.Z)(this,"intervalHandle",void 0),(0,k.Z)(this,"checkRequestIsPending",(()=>{const{request:e}=this.props;(0,X.canAcceptVerificationRequest)(e)||F.Z.sharedInstance().dismissToast(this.props.toastKey)})),(0,k.Z)(this,"cancel",(()=>{F.Z.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){r.k.error("Error while cancelling verification request",e)}})),(0,k.Z)(this,"accept",(async()=>{F.Z.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=E.p.safeGet();try{if(e.roomId){var i;x.ZP.dispatch({action:W.a.ViewRoom,room_id:e.roomId,should_peek:!1,metricsTrigger:"VerificationRequest"});const n=null!==(i=t.getUser(e.otherUserId))&&void 0!==i?i:void 0;nm.Z.instance.setCards([{phase:im.q.RoomSummary},{phase:im.q.RoomMemberInfo,state:{member:n}},{phase:im.q.EncryptionPanel,state:{verificationRequest:e,member:n}}],void 0,e.roomId)}else T.ZP.createDialog(J,{verificationRequest:e,onFinished:()=>{e.cancel()}},void 0,!1,!0);await e.accept()}catch(e){r.k.error("Failed to accept verification request",e)}})),this.state={counter:Math.ceil((null!==(t=e.request.timeout)&&void 0!==t?t:0)/1e3)}}async componentDidMount(){const{request:e}=this.props;e.timeout&&e.timeout>0&&(this.intervalHandle=window.setInterval((()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})}),1e3)),e.on(X.VerificationRequestEvent.Change,this.checkRequestIsPending),this.checkRequestIsPending();const t=e.otherDeviceId;if(e.isSelfVerification&&t){const e=E.p.safeGet(),i=await e.getDevice(t);this.setState({ip:i.last_seen_ip,device:await(0,Qe.q)(e,e.getSafeUserId(),t)})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off(X.VerificationRequestEvent.Change,this.checkRequestIsPending)}render(){const{request:e}=this.props;let t,i;if(e.isSelfVerification)this.state.device&&(t=this.state.device.displayName,i=(0,l._t)("encryption|verification|request_toast_detail",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const i=E.p.safeGet(),n=e.otherUserId,s=e.roomId;if(t=s?(0,Px.s)(i,n,s):n,t===n){const e=i.getUser(n);e&&e.displayName&&(t=(0,l._t)("name_and_id",{name:e.displayName,userId:n}))}}const n=0===this.state.counter?(0,l._t)("action|ignore"):(0,l._t)("encryption|verification|request_toast_decline_counter",{counter:this.state.counter});return o.createElement(z.Z,{description:t,detail:i,acceptLabel:(0,l._t)("encryption|verification|request_toast_accept"),onAccept:this.accept,rejectLabel:n,onReject:this.cancel})}}let Zx=function(e){return e.APP_STARTUP="mx_AppStartup",e.PAGE_CHANGE="mx_PageChange",e.RESEND_EVENT="mx_ResendEvent",e.SEND_E2EE_EVENT="mx_SendE2EEEvent",e.SEND_ATTACHMENT="mx_SendAttachment",e.SWITCH_ROOM="mx_SwithRoom",e.JUMP_TO_ROOM="mx_JumpToRoom",e.JOIN_ROOM="mx_JoinRoom",e.CREATE_DM="mx_CreateDM",e.PEEK_ROOM="mx_PeekRoom",e.VERIFY_E2EE_USER="mx_VerifyE2EEUser",e.LOGIN="mx_Login",e.REGISTER="mx_Register",e.SETUP_VOIP_CALL="mx_SetupVoIPCall",e}({});class Nx{constructor(){(0,k.Z)(this,"START_PREFIX","start:"),(0,k.Z)(this,"STOP_PREFIX","stop:"),(0,k.Z)(this,"listeners",[]),(0,k.Z)(this,"entries",[])}static get instance(){return Nx._instance||(Nx._instance=new Nx),Nx._instance}start(e,t){if(!this.supportsPerformanceApi())return;const i=this.buildKey(e,t);performance.getEntriesByName(this.START_PREFIX+i).length>0?r.k.warn(`Recording already started for: ${e}`):performance.mark(this.START_PREFIX+i)}stop(e,t){if(!this.supportsPerformanceApi())return;const i=this.buildKey(e,t);if(0===performance.getEntriesByName(this.START_PREFIX+i).length)return void r.k.warn(`No recording started for: ${e}`);performance.mark(this.STOP_PREFIX+i),performance.measure(i,this.START_PREFIX+i,this.STOP_PREFIX+i),this.clear(e,t);const n=performance.getEntriesByName(i).pop();return this.entries.push(n),this.listeners.forEach((e=>{this.shouldEmit(e,n)&&e.callback([n])})),n}clear(e,t){if(!this.supportsPerformanceApi())return;const i=this.buildKey(e,t);performance.clearMarks(this.START_PREFIX+i),performance.clearMarks(this.STOP_PREFIX+i)}getEntries({name:e,type:t}={}){return this.entries.filter((i=>{const n=!e||i.name===e,s=!t||i.entryType===t;return n&&s}))}addPerformanceDataCallback(e,t=!1){if(this.listeners.push(e),t){const t=this.entries.filter((t=>this.shouldEmit(e,t)));t.length>0&&e.callback(t)}}removePerformanceDataCallback(e){e?this.listeners.splice(this.listeners.findIndex((t=>t.callback===e)),1):this.listeners=[]}supportsPerformanceApi(){return void 0!==performance&&void 0!==performance.mark}shouldEmit(e,t){return!e.entryNames||e.entryNames.includes(t.name)}buildKey(e,t){return`${e}${t?`:${t}`:""}`}}(0,k.Z)(Nx,"_instance",void 0),window.mxPerformanceMonitor=Nx.instance,window.mxPerformanceEntryNames=Zx;class Dx extends o.Component{constructor(...e){super(...e),(0,k.Z)(this,"onConfirm",(()=>{this.props.onFinished(!0)})),(0,k.Z)(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return o.createElement(q.Z,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,l._t)("auth|soft_logout|clear_data_title")},o.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},o.createElement("p",null,(0,l._t)("auth|soft_logout|clear_data_description"))),o.createElement(gt.Z,{primaryButton:(0,l._t)("auth|soft_logout|clear_data_button"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:(0,l._t)("action|cancel"),onCancel:this.onDecline}))}}var Mx=function(e){return e[e.Loading=0]="Loading",e[e.Password=1]="Password",e[e.CAS=2]="CAS",e[e.SSO=3]="SSO",e[e.PasswordWithSocialSignOn=4]="PasswordWithSocialSignOn",e[e.Unsupported=5]="Unsupported",e}(Mx||{});const Ox={"m.login.password":Mx.Password,"m.login.cas":Mx.CAS,"m.login.sso":Mx.SSO};class Ax extends o.Component{constructor(e,t){super(e,t),(0,k.Z)(this,"context",void 0),(0,k.Z)(this,"onClearAll",(()=>{T.ZP.createDialog(Dx,{onFinished:e=>{e&&(r.k.log("Clearing data from soft-logged-out session"),fa(this.context.oidcClientStore))}})})),(0,k.Z)(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),(0,k.Z)(this,"onForgotPassword",(()=>{x.ZP.dispatch({action:"start_password_recovery"})})),(0,k.Z)(this,"onPasswordLogin",(async e=>{var t;e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const i=E.p.safeGet(),s=i.getHomeserverUrl(),o=i.getIdentityServerUrl(),a={identifier:{type:"m.id.user",user:i.getUserId()},password:this.state.password,device_id:null!==(t=i.getDeviceId())&&void 0!==t?t:void 0};let c;try{c=await O(s,o,"m.login.password",a)}catch(e){let t=(0,l._t)("auth|failed_soft_logout_homeserver");return e instanceof n.MatrixError&&"M_FORBIDDEN"===e.errcode&&(401===e.httpStatus||403===e.httpStatus)&&(t=(0,l._t)("auth|incorrect_password")),void this.setState({busy:!1,errorText:t})}pa(c).catch((e=>{r.k.error(e),this.setState({busy:!1,errorText:(0,l._t)("auth|failed_soft_logout_auth")})}))})),this.context=t,this.state={loginView:Mx.Loading,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){ya()?this.initLogin():x.ZP.dispatch({action:"start_login"})}async initLogin(){const e=this.props.realQueryParams;if(null==e?void 0:e.loginToken){this.setState({loginView:Mx.Loading});if(await this.trySsoLogin())return}const t=E.p.safeGet(),i=(await t.loginFlows()).flows,n=i.map((e=>Ox[e.type])),s=n.includes(Mx.Password)&&n.includes(Mx.SSO),o=n.filter((e=>!!e))[0]||Mx.Unsupported,a=s?Mx.PasswordWithSocialSignOn:o;this.setState({flows:i,loginView:a})}async trySsoLogin(){var e;this.setState({busy:!0});const t=localStorage.getItem(tt.lc);if(!t)return r.k.error("Homeserver URL unknown for SSO login callback"),this.setState({busy:!1,loginView:Mx.Unsupported}),!1;const i=localStorage.getItem(tt.xV)||E.p.safeGet().getIdentityServerUrl(),n={token:this.props.realQueryParams.loginToken,device_id:null!==(e=E.p.safeGet().getDeviceId())&&void 0!==e?e:void 0};let s;try{s=await O(t,i,"m.login.token",n)}catch(e){return r.k.error(e),this.setState({busy:!1,loginView:Mx.Unsupported}),!1}return pa(s).then((()=>(this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted(),!0))).catch((e=>(r.k.error(e),this.setState({busy:!1,loginView:Mx.Unsupported}),!1)))}renderPasswordForm(e){let t;return this.state.errorText&&(t=o.createElement("span",{className:"mx_Login_error"},this.state.errorText)),o.createElement("form",{onSubmit:this.onPasswordLogin},e?o.createElement("p",null,e):null,t,o.createElement(Vs.Z,{type:"password",label:(0,l._t)("common|password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),o.createElement(ae.Z,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},(0,l._t)("action|sign_in")),o.createElement(ae.Z,{onClick:this.onForgotPassword,kind:"link"},(0,l._t)("auth|forgot_password_prompt")))}renderSsoForm(e){const t=this.state.loginView===Mx.CAS?"cas":"sso",i=this.state.flows.find((e=>e.type==="m.login."+t));return o.createElement("div",null,e?o.createElement("p",null,e):null,o.createElement(dx,{matrixClient:E.p.safeGet(),flow:i,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find((e=>"m.login.password"===e.type)),action:n.SSOAction.LOGIN}))}renderSignInSection(){return this.state.loginView===Mx.Loading?o.createElement(re.Z,null):this.state.loginView===Mx.Password?this.renderPasswordForm((0,l._t)("auth|soft_logout_intro_password")):this.state.loginView===Mx.SSO||this.state.loginView===Mx.CAS?this.renderSsoForm((0,l._t)("auth|soft_logout_intro_sso")):this.state.loginView===Mx.PasswordWithSocialSignOn?o.createElement(o.Fragment,null,o.createElement("p",null,(0,l._t)("auth|soft_logout_intro_sso")),this.renderSsoForm(null),o.createElement("h2",{className:"mx_AuthBody_centered"},(0,l._t)("auth|sso_or_username_password",{ssoButtons:"",usernamePassword:""}).trim()),this.renderPasswordForm(null)):o.createElement("p",null,(0,l._t)("auth|soft_logout_intro_unsupported_auth"))}render(){return o.createElement(xk,null,o.createElement(Dk,null),o.createElement(Mk,null,o.createElement("h1",null,(0,l._t)("auth|soft_logout_heading")),o.createElement("h2",null,(0,l._t)("action|sign_in")),o.createElement("div",null,this.renderSignInSection()),o.createElement("h2",null,(0,l._t)("auth|soft_logout_subheading")),o.createElement("p",null,(0,l._t)("auth|soft_logout_warning")),o.createElement("div",null,o.createElement(ae.Z,{onClick:this.onClearAll,kind:"danger"},(0,l._t)("auth|soft_logout|clear_data_button")))))}}(0,k.Z)(Ax,"contextType",ie.f);const Lx=["children","className"];function Ux(e){let{children:t,className:i}=e,n=(0,v.Z)(e,Lx);const s=yt()(i,"mx_SplashPage");return o.createElement("main",(0,kt.Z)({},n,{className:s}),t)}function Fx({useCase:e,onClick:t,selected:i}){let n;switch(e){case fd.PersonalMessaging:n=(0,l._t)("onboarding|use_case_personal_messaging");break;case fd.WorkMessaging:n=(0,l._t)("onboarding|use_case_work_messaging");break;case fd.CommunityMessaging:n=(0,l._t)("onboarding|use_case_community_messaging")}return o.createElement(ae.Z,{className:yt()("mx_UseCaseSelectionButton",{mx_UseCaseSelectionButton_selected:i}),onClick:async()=>t(e)},o.createElement("div",{className:yt()("mx_UseCaseSelectionButton_icon",{mx_UseCaseSelectionButton_messaging:e===fd.PersonalMessaging,mx_UseCaseSelectionButton_work:e===fd.WorkMessaging,mx_UseCaseSelectionButton_community:e===fd.CommunityMessaging})}),o.createElement("span",null,n),o.createElement("div",{className:"mx_UseCaseSelectionButton_selectedIcon"}))}function Bx({onFinished:e}){const[t,i]=(0,o.useState)(null);return(0,o.useEffect)((()=>{if(t){let i=window.setTimeout((()=>{i=null,e(t)}),1500);return()=>{null!==i&&clearTimeout(i),i=null}}}),[t,e]),o.createElement(Ux,{className:yt()("mx_UseCaseSelection",{mx_UseCaseSelection_selected:null!==t})},o.createElement("div",{className:"mx_UseCaseSelection_title mx_UseCaseSelection_slideIn"},o.createElement("h1",null,(0,l._t)("onboarding|use_case_heading1"))),o.createElement("div",{className:"mx_UseCaseSelection_info mx_UseCaseSelection_slideInDelayed"},o.createElement("h2",null,(0,l._t)("onboarding|use_case_heading2")),o.createElement("h3",null,(0,l._t)("onboarding|use_case_heading3"))),o.createElement("div",{className:"mx_UseCaseSelection_options mx_UseCaseSelection_slideInDelayed"},o.createElement(Fx,{useCase:fd.PersonalMessaging,selected:t===fd.PersonalMessaging,onClick:i}),o.createElement(Fx,{useCase:fd.WorkMessaging,selected:t===fd.WorkMessaging,onClick:i}),o.createElement(Fx,{useCase:fd.CommunityMessaging,selected:t===fd.CommunityMessaging,onClick:i})),o.createElement("div",{className:"mx_UseCaseSelection_skip mx_UseCaseSelection_slideInDelayed"},o.createElement(ae.Z,{kind:"link",onClick:async()=>i(fd.Skip)},(0,l._t)("action|skip"))))}function Vx(e,t,i){(0,o.useEffect)((()=>{let n=null;const s=()=>{n=null,t(...i)};if(!1!==e)return n=window.setTimeout(s,100),()=>{n&&clearTimeout(n)}}),[e,t,i])}const jx=e=>{const t=(0,o.useRef)(null);return[(0,o.useCallback)((e=>{t.current=e}),[]),(0,o.useCallback)(((i,n)=>{t.current===i&&e(n)}),[e])]},zx="ALL_ROOMS",Wx="mx_last_room_directory_server",Hx="mx_last_room_directory_instance";let Gx;const Kx="nsfw",qx=e=>{var t,i;return!(null!==(t=e.name)&&void 0!==t&&t.toLocaleLowerCase().includes(Kx)||null!==(i=e.topic)&&void 0!==i&&i.toLocaleLowerCase().includes(Kx))},$x=()=>{const[e,t]=(0,o.useState)([]),[i,n]=(0,o.useState)(void 0),[s,a]=(0,o.useState)(null),[r,l]=(0,o.useState)(!1),[d,m]=(0,o.useState)(!1),[h,p]=(0,o.useState)(),[u,g]=jx(t),v=(0,wt.t)("SpotlightSearch.showNsfwPublicRooms");const _=(0,o.useCallback)((async({limit:e=20,query:t,roomTypes:n})=>{const s={limit:e};(null==i?void 0:i.roomServer)!=E.p.getHomeserverName()&&(s.server=null==i?void 0:i.roomServer),(null==i?void 0:i.instanceId)===zx?s.include_all_networks=!0:null!=i&&i.instanceId&&(s.third_party_instance_id=i.instanceId),(t||n)&&(s.filter={generic_search_term:t,room_types:n&&await E.p.safeGet().doesServerSupportUnstableFeature("org.matrix.msc3827.stable")?Array.from(n):void 0}),u(s),m(!0),p(void 0);try{const{chunk:e}=await E.p.safeGet().publicRooms(s);return g(s,v?e:e.filter(qx)),!0}catch(e){return p(!(e instanceof Error)||e),console.error("Could not fetch public rooms for params",s,e),g(s,[]),!1}finally{m(!1)}}),[i,u,g,v]);return(0,o.useEffect)((()=>{!async function(){if(E.p.get())if(Gx)a(Gx);else{const e=await E.p.safeGet().getThirdpartyProtocols();Gx=e,a(e)}else l(!0)}()}),[]),(0,o.useEffect)((()=>{var e,t,i,o;if(null===s)return;const a=E.p.getHomeserverName(),r=localStorage.getItem(Wx),d=null!==(e=localStorage.getItem(Hx))&&void 0!==e?e:void 0;let m,h=a;r&&(null!==(t=c.ZP.getObject("room_directory"))&&void 0!==t&&null!==(i=t.get("servers"))&&void 0!==i&&i.includes(r)||null!==(o=L.C.getValue("room_directory_servers"))&&void 0!==o&&o.includes(r))&&(h=r),h!==a||d!==zx&&!Object.values(s).some((e=>{e.instances.some((e=>e.instance_id===d))}))||(m=d),l(!0),n({roomServer:h,instanceId:m})}),[s]),(0,o.useEffect)((()=>{i&&(localStorage.setItem(Wx,i.roomServer),i.instanceId?localStorage.setItem(Hx,i.instanceId):localStorage.removeItem(Hx))}),[i]),{ready:r,loading:d,publicRooms:e,protocols:s,config:i,search:_,setConfig:function(e){if(!r)throw new Error("public room configuration not initialised yet");n(e)},error:h}};var Jx=i("../matrix-react-sdk/src/utils/SortMembers.ts"),Yx=i("../matrix-react-sdk/src/components/views/avatars/SearchResultAvatar.tsx"),Qx=i("../matrix-react-sdk/src/accessibility/context_menu/MenuItemRadio.tsx");function Xx({label:e,description:t,onClick:i,isSelected:n,adornment:s}){return o.createElement(Qx.t,{active:n,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:i},o.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},o.createElement("span",null,e),o.createElement("span",null,t)),s)}function eR({label:e,description:t,adornment:i,children:n}){return o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--header"},o.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},o.createElement("span",null,e),o.createElement("span",null,t)),i),n)}function tR(e){return"options"in e}function iR({value:e,onChange:t,options:i,selectedLabel:n,onOpen:s,onClose:a,toKey:r,className:l,AdditionalOptions:c}){const[d,m,h,p]=(0,ii.av)(),u=i.flatMap((e=>tR(e)?[e,...e.options]:[e])).find((t=>r?r(t.key)===r(e):t.key===e));let g;g=i&&tR(i[0])?o.createElement(o.Fragment,null,i.map((e=>{var i;return o.createElement(eR,{key:null!==(i=null==r?void 0:r(e.key))&&void 0!==i?i:e.key,label:e.label,description:e.description,adornment:e.adornment},e.options.map((e=>{var i;return o.createElement(Xx,{key:null!==(i=null==r?void 0:r(e.key))&&void 0!==i?i:e.key,label:e.label,description:e.description,onClick:i=>{t(e.key),p(),null==a||a(i)},adornment:e.adornment,isSelected:e===u})})))}))):o.createElement(o.Fragment,null,i.map((e=>{var i;return o.createElement(Xx,{key:null!==(i=null==r?void 0:r(e.key))&&void 0!==i?i:e.key,label:e.label,description:e.description,onClick:i=>{t(e.key),p(),null==a||a(i)},adornment:e.adornment,isSelected:e===u})})));const v=d&&m.current?o.createElement(ii.ZP,(0,kt.Z)({onFinished:p,chevronFace:ii.N7.Top,wrapperClassName:yt()("mx_GenericDropdownMenu_wrapper",l)},(0,ii.LS)(m.current.getBoundingClientRect())),g,c&&o.createElement(c,{menuDisplayed:d,openMenu:h,closeMenu:p})):null;return o.createElement(o.Fragment,null,o.createElement(ii.lX,{className:"mx_GenericDropdownMenu_button",inputRef:m,isExpanded:d,onClick:e=>{h(),null==s||s(e)}},n(u)),v)}var nR=i("../matrix-react-sdk/src/components/views/dialogs/TextInputDialog.tsx");function sR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const oR=(0,Nh.Z)({deriveData:async({value:e})=>{try{return await E.p.safeGet().publicRooms({limit:1,server:null!=e?e:void 0}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>(0,l._t)("spotlight|public_rooms|network_dropdown_required_invalid")},{key:"available",final:!0,test:async(e,{error:t})=>!t,valid:()=>(0,l._t)("spotlight|public_rooms|network_dropdown_available_valid"),invalid:({error:e})=>e instanceof n.MatrixError&&"M_FORBIDDEN"===e.errcode?(0,l._t)("spotlight|public_rooms|network_dropdown_available_invalid_forbidden"):(0,l._t)("spotlight|public_rooms|network_dropdown_available_invalid")}],memoize:!0});function aR(e,...t){for(const i of t)e.delete(i)}function rR(){var e,t;const[i,n]=function(e,t,i=null,n=!1){const[s,a]=(0,o.useState)(L.C.getValue(e,null!=i?i:void 0,n)),r=(0,o.useCallback)((async n=>{a(n),L.C.setValue(e,i,t,n)}),[t,i,e]);return(0,o.useEffect)((()=>{const t=L.C.watchSetting(e,i,(()=>{a(L.C.getValue(e,i,n))}));return()=>{L.C.unwatchSetting(t)}}),[e,i,n]),[s,r]}("room_directory_servers",U.R.ACCOUNT),s=E.p.getHomeserverName(),a=new Set(null!==(e=null===(t=c.ZP.getObject("room_directory"))||void 0===t?void 0:t.get("servers"))&&void 0!==e?e:[]);aR(a,s);const r=new Set(i);return aR(r,s),aR(r,...a),{allServers:[s,...Array.from(a).sort(),...Array.from(r).sort()],homeServer:s,userDefinedServers:Array.from(r).sort(),setUserDefinedServers:n}}const lR=({protocols:e,config:t,setConfig:i})=>{const{allServers:n,homeServer:s,userDefinedServers:a,setUserDefinedServers:r}=rR(),c=n.map((t=>function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?sR(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):sR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({key:{roomServer:t,instanceId:void 0},label:t,description:t===s?(0,l._t)("spotlight|public_rooms|network_dropdown_your_server_description"):null,options:[{key:{roomServer:t,instanceId:void 0},label:(0,l._t)("common|matrix")},...t===s&&e?Object.values(e).flatMap((e=>e.instances)).map((e=>({key:{roomServer:t,instanceId:e.instance_id},label:e.desc}))):[]]},a.includes(t)?{adornment:o.createElement(ae.Z,{className:"mx_NetworkDropdown_removeServer",alt:(0,l._t)("spotlight|public_rooms|network_dropdown_remove_server_adornment",{roomServer:t}),onClick:()=>r((0,ln.without)(a,t))})}:{}))),d=(0,o.useCallback)((({closeMenu:e})=>o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_GenericDropdownMenu_divider"}),o.createElement(Qx.t,{active:!1,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:async()=>{e();const{finished:t}=T.ZP.createDialog(nR.Z,{title:(0,l._t)("spotlight|public_rooms|network_dropdown_add_dialog_title"),description:(0,l._t)("spotlight|public_rooms|network_dropdown_add_dialog_description"),button:(0,l._t)("action|add"),hasCancel:!1,placeholder:(0,l._t)("spotlight|public_rooms|network_dropdown_add_dialog_placeholder"),validator:oR,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[s,o]=await t;s&&(n.includes(o)||(r([...a,o]),i({roomServer:o})))}},o.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},o.createElement("span",{className:"mx_NetworkDropdown_addServer"},(0,l._t)("spotlight|public_rooms|network_dropdown_add_server_option")))))),[n,i,r,a]);return o.createElement(iR,{className:"mx_NetworkDropdown_wrapper",value:t,toKey:e=>e?`${e.roomServer}-${e.instanceId}`:"null",options:c,onChange:e=>i(e),selectedLabel:e=>null!=e&&e.key?(0,l._t)("spotlight|public_rooms|network_dropdown_selected_label_instance",{server:e.key.roomServer,instance:e.key.instanceId?e.label:"Matrix"}):(0,l._t)("spotlight|public_rooms|network_dropdown_selected_label"),AdditionalOptions:d})},cR=["inputRef","children","endAdornment","className"],dR=e=>{let{inputRef:t,children:i,endAdornment:n,className:s}=e,a=(0,v.Z)(e,cR);const[r,l,c]=(0,Gi.XZ)(t);return o.createElement(ae.Z,(0,kt.Z)({},a,{className:yt()(s,"mx_SpotlightDialog_option"),onFocus:r,inputRef:c,tabIndex:-1,"aria-selected":l,role:"option",element:"li"}),i,o.createElement("div",{className:"mx_SpotlightDialog_option--endAdornment"},o.createElement("kbd",{className:"mx_SpotlightDialog_enterPrompt","aria-hidden":!0},"âµ"),n))};function mR({room:e,labelId:t,descriptionId:i,detailsId:n}){var s,a,r;let c=e.name||(0,Ia.AH)(null!==(s=e.canonical_alias)&&void 0!==s?s:"",null!==(a=e.aliases)&&void 0!==a?a:[])||(0,l._t)("common|unnamed_room");c.length>80&&(c=`${c.substring(0,80)}...`);let d=e.topic||"";return d.length>800&&(d=`${d.substring(0,800)}...`),o.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomDetails"},o.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomHeader"},o.createElement("span",{id:t,className:"mx_SpotlightDialog_result_publicRoomName"},c),o.createElement("span",{id:i,className:"mx_SpotlightDialog_result_publicRoomAlias"},null!==(r=e.canonical_alias)&&void 0!==r?r:e.room_id)),o.createElement("div",{id:n,className:"mx_SpotlightDialog_result_publicRoomDescription"},o.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomMemberCount"},(0,l._t)("spotlight_dialog|count_of_members",{count:e.num_joined_members})),d&&o.createElement(o.Fragment,null,"Â Â·Â ",o.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomTopic",dangerouslySetInnerHTML:{__html:(0,hn.xU)(d)}}))))}var hR=i("../matrix-react-sdk/src/hooks/useRoomNotificationState.ts"),pR=i("../matrix-react-sdk/src/components/views/context_menus/RoomGeneralContextMenu.tsx"),uR=i("../matrix-react-sdk/src/components/views/context_menus/RoomNotificationContextMenu.tsx");function gR({room:e}){const[t]=(0,hR.t)(e),[i,n]=(0,o.useState)(null),[s,a]=(0,o.useState)(null);let r,c;null!==i&&(r=e.isSpaceRoom()?o.createElement(vr,(0,kt.Z)({},(0,f_.xR)(i),{space:e,onFinished:()=>n(null)})):o.createElement(pR.H,(0,kt.Z)({},(0,f_.xR)(i),{room:e,onFinished:()=>n(null)}))),null!==s&&(c=o.createElement(uR.t,(0,kt.Z)({},(0,f_.xR)(s),{room:e,onFinished:()=>a(null)})));const d=yt()("mx_SpotlightDialog_option--notifications",{mx_RoomNotificationContextMenu_iconBell:t===u_.OV.AllMessages,mx_RoomNotificationContextMenu_iconBellDot:t===u_.OV.AllMessagesLoud,mx_RoomNotificationContextMenu_iconBellMentions:t===u_.OV.MentionsOnly,mx_RoomNotificationContextMenu_iconBellCrossed:t===u_.OV.Mute});return o.createElement(o.Fragment,null,(0,hr.I)(Ye.y.RoomOptionsMenu)&&o.createElement(dn.J,{className:"mx_SpotlightDialog_option--menu",onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;n(t.getBoundingClientRect())},title:e.isSpaceRoom()?(0,l._t)("space|context_menu|options"):(0,l._t)("room|context_menu|title"),isExpanded:null!==i}),!e.isSpaceRoom()&&o.createElement(dn.J,{className:d,onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;a(t.getBoundingClientRect())},title:(0,l._t)("room_list|notification_options"),isExpanded:null!==s}),r,c)}const vR=["inputRef","className"],_R=e=>{let{inputRef:t,className:i}=e,n=(0,v.Z)(e,vR);const[s,a,r]=(0,Gi.XZ)(t);return o.createElement(gs.Z,(0,kt.Z)({},n,{className:yt()(i,"mx_SpotlightDialog_option"),onFocus:s,inputRef:r,tabIndex:-1,"aria-selected":a,role:"option"}))};var fR=i("../matrix-react-sdk/src/components/views/dialogs/spotlight/Filter.ts");const ER=50,yR="24px";function bR(e){var t,i;return!0===(null==e||null===(t=e.current)||void 0===t||null===(i=t.id)||void 0===i?void 0:i.startsWith("mx_SpotlightDialog_button_recentlyViewed_"))}function wR(e){const t=new Set;return e===fR.w.PublicRooms&&t.add(null),e===fR.w.PublicSpaces&&t.add(n.RoomType.Space),t}var SR=function(e){return e[e.People=0]="People",e[e.Rooms=1]="Rooms",e[e.Spaces=2]="Spaces",e[e.Suggestions=3]="Suggestions",e[e.PublicRoomsAndSpaces=4]="PublicRoomsAndSpaces",e}(SR||{});function CR(e){switch(e){case fR.w.People:return(0,l._t)("common|people");case fR.w.PublicRooms:return(0,l._t)("spotlight_dialog|public_rooms_label");case fR.w.PublicSpaces:return(0,l._t)("spotlight_dialog|public_spaces_label")}}const kR=e=>!(null==e||!e.room),xR=e=>!(null==e||!e.publicRoom),RR=e=>!(null==e||!e.member),IR=e=>{var t,i,n,s,o;return{publicRoom:e,section:SR.PublicRoomsAndSpaces,filter:[fR.w.PublicRooms,fR.w.PublicSpaces],query:(0,ne.gP)([e.room_id.toLowerCase(),null===(t=e.canonical_alias)||void 0===t?void 0:t.toLowerCase(),null===(i=e.name)||void 0===i?void 0:i.toLowerCase(),kd()(null!==(n=null===(s=e.topic)||void 0===s?void 0:s.toLowerCase())&&void 0!==n?n:"",{allowedTags:[]}),...(null===(o=e.aliases)||void 0===o?void 0:o.map((e=>e.toLowerCase())))||[]])}},PR=e=>{const t=E.p.safeGet().getUserId();if(P.Z.shared().getUserIdForRoomId(e.roomId)){const i=e.getMembers().filter((e=>e.userId!==t)),n=[...i.map((e=>e.name.toLowerCase())),...i.map((e=>e.userId.toLowerCase()))].filter(Boolean);return{room:e,section:SR.People,filter:[fR.w.People],query:n}}return e.isSpaceRoom()?{room:e,section:SR.Spaces,filter:[]}:{room:e,section:SR.Rooms,filter:[]}},TR=(e,t)=>({alreadyFiltered:t,member:e,section:SR.Suggestions,filter:[fR.w.People],query:[e.userId.toLowerCase(),e.name.toLowerCase()].filter(Boolean)}),ZR=new vs.oW,NR=(e,t)=>t.hasMentions?(0,l._t)("a11y|n_unread_messages_mentions",{count:t.count}):t.hasUnreadCount?(0,l._t)("a11y|n_unread_messages",{count:t.count}):t.isUnread?(0,l._t)("a11y|unread_messages"):void 0,DR=e=>L.C.getValue("feature_ask_to_join")&&n.JoinRule.Knock===e,MR=({initialText:e="",initialFilter:t=null,onFinished:i})=>{var s,a;const r=(0,o.useRef)(null),c=(0,o.useRef)(null),d=E.p.safeGet(),m=(0,o.useContext)(Gi.dl),[h,p]=(0,o.useState)(e),[u,g]=(()=>{const[e,t]=(0,o.useState)((()=>{const e=E.p.safeGet(),t=L.C.getValue("SpotlightSearch.recentSearches",null);return(0,ne.gP)(t.map((t=>e.getRoom(t))))}));return[e,()=>{L.C.setValue("SpotlightSearch.recentSearches",null,U.R.ACCOUNT,[]),t([])}]})(),[v,_]=(0,o.useState)(t),f=(0,o.useCallback)((e=>{var t,i,n;_(e),null===(t=r.current)||void 0===t||t.focus(),null===(i=c.current)||void 0===i||null===(n=i.scrollTo)||void 0===n||n.call(i,{top:0})}),[]),y=(0,o.useMemo)((()=>{const e=(0,Jx.re)(d),t=(0,Jx.Kv)(d);return(0,Jx.Mk)(e,t)}),[d]),b=(0,wt.n)("feature_dynamic_room_predecessors"),w=(0,Rt.KU)(d.getUserId()),[S,C]=(0,o.useState)(!1),k=(0,o.useMemo)((()=>h.trim()),[h]),[R,I]=(0,o.useState)(!0);(0,o.useEffect)((()=>{d.isVersionSupported("v1.4").then((e=>e||d.doesServerSupportUnstableFeature("org.matrix.msc3827.stable"))).then((e=>{I(e)}))}),[d]);const{loading:T,publicRooms:Z,protocols:N,config:D,setConfig:M,search:O,error:A}=$x(),{loading:F,users:B,search:V}=(()=>{const[e,t]=(0,o.useState)([]),[i,n]=(0,o.useState)(!1),[s,a]=jx(t);return{ready:!0,loading:i,users:e,search:(0,o.useCallback)((async({limit:e=20,query:i})=>{const o={limit:e,term:i};if(s(o),null==i||!i.length)return t([]),!0;try{n(!0);const{results:e}=await E.p.safeGet().searchUserDirectory(o);return a(o,e.map((e=>new zf.tL(e)))),!0}catch(t){return console.error("Could not fetch user in user directory for params",{limit:e,term:i},t),a(o,[]),!1}finally{n(!1)}}),[s,a])}})(),{loading:j,profile:z,search:H}=(()=>{const[e,t]=(0,o.useState)(null),[i,n]=(0,o.useState)(!1),[s,a]=jx(t);return{ready:!0,loading:i,profile:e,search:(0,o.useCallback)((async({query:e})=>{if(s(e),null==e||!e.length||!e.startsWith("@")||!e.includes(":"))return t(null),!0;n(!0);try{const t=await E.p.safeGet().getProfileInfo(e);return a(e,{user_id:e,avatar_url:t.avatar_url,display_name:t.displayname}),!0}catch(t){return console.error("Could not fetch profile info for params",{term:e},t),a(e,null),!1}finally{n(!1)}}),[s,a])}})(),G=(0,o.useMemo)((()=>[{query:k,roomTypes:wR(v),limit:ER}]),[k,v]);Vx(v===fR.w.PublicRooms||v===fR.w.PublicSpaces,O,G),Vx(v===fR.w.People,V,G),Vx(v===fR.w.People,H,G);const K=(0,o.useMemo)((()=>{const e=((e,t)=>e.getVisibleRooms(t).filter((e=>!(0,Wn.S)(e)&&("join"===e.getMyMembership()||"invite"==e.getMyMembership()))))(d,b),t=e.map(PR),i=[],n=t.reduce(((e,t)=>{const i=P.Z.shared().getUserIdForRoomId(t.room.roomId);return i?(t.room.getJoinedMemberCount()>2||e.set(i,t),e):e}),new Map);function s(e,t){for(const s of e){if(n.has(s.userId)){const e=n.get(s.userId);t&&RR(e)&&!e.alreadyFiltered&&(e.alreadyFiltered=!0);continue}const e=TR(s,t);n.set(s.userId,e),i.push(e)}}return s(((e,t,i=!0)=>Object.values(e.filter((e=>!i||!P.Z.shared().getUserIdForRoomId(e.roomId))).reduce(((e,t)=>{for(const i of t.getJoinedMembers())e[i.userId]=i;return e}),{})).filter((e=>e.userId!==t.getUserId())))(e,d),!1),s(B,!0),z&&s([new zf.tL(z)],!0),[...Rs.ZP.instance.enabledMetaSpaces.map((e=>({section:SR.Spaces,filter:[],avatar:o.createElement("div",{className:yt()("mx_SpotlightDialog_metaspaceResult",`mx_SpotlightDialog_metaspaceResult_${e}`)}),name:(0,cr.W4)(e,Rs.ZP.instance.allRoomsInHome),onClick(){Rs.ZP.instance.setActiveSpace(e)}}))),...t,...i,...Z.map(IR)].filter((e=>null===v||e.filter.includes(v)))}),[d,B,z,Z,v,b]),$=(0,o.useMemo)((()=>{const e={[SR.People]:[],[SR.Rooms]:[],[SR.Spaces]:[],[SR.Suggestions]:[],[SR.PublicRoomsAndSpaces]:[]};if(k){const t=k.toLowerCase(),i=(0,xa.Fv)(k);K.forEach((n=>{if(kR(n)){const e=P.Z.shared().getUserIdForRoomId(n.room.roomId);var s,o,a;if(!B.some((t=>t.userId===e)))if(!(null!==(s=n.room.normalizedName)&&void 0!==s&&s.includes(i)||null!==(o=n.room.getCanonicalAlias())&&void 0!==o&&o.toLowerCase().includes(t)||null!==(a=n.query)&&void 0!==a&&a.some((e=>e.includes(t)))))return}else if(RR(n)){var r;if(!(n.alreadyFiltered||null!==(r=n.query)&&void 0!==r&&r.some((e=>e.includes(t)))))return}else if(xR(n)){var l;if(null===(l=n.query)||void 0===l||!l.some((e=>e.includes(t))))return}else{var c;if(!(n.name.toLowerCase().includes(t)||null!==(c=n.query)&&void 0!==c&&c.some((e=>e.includes(t)))))return}e[n.section].push(n)}))}else v===fR.w.PublicRooms||v===fR.w.PublicSpaces?K.forEach((t=>{xR(t)&&e[t.section].push(t)})):v===fR.w.People&&K.forEach((t=>{RR(t)&&e[t.section].push(t)}));const t=d.getSafeUserId();for(const i of Object.values(e))i.sort(((e,i)=>kR(e)||kR(i)?kR(i)&&kR(e)?ZR.getLastTs(i.room,t)-ZR.getLastTs(e.room,t):-1:RR(e)||RR(i)?RR(i)&&RR(e)?y(e.member,i.member):-1:0));return e}),[k,v,d,K,B,y]);((e,t,i)=>{(0,o.useEffect)((()=>{if(!t)return;const n=window.setTimeout((()=>{rt.S.instance.trackEvent({eventName:"WebSearch",viaSpotlight:i,numResults:e,queryLength:t})}),1e3);return()=>{clearTimeout(n)}}),[e,t,i])})((0,ln.sum)(Object.values($).map((e=>e.length))),h.length,!0);const J=Rs.ZP.instance.activeSpaceRoom,[Y,Q]=((e,t)=>{var i;const[s,a]=(0,o.useState)([]),[r,l]=(0,o.useState)(),c=(0,o.useCallback)((()=>{l(e?new yf(e,50):void 0)}),[e]);return(0,o.useEffect)(c,[c]),(0,o.useEffect)((()=>{if(!e||!r)return;let t=!1;return(async()=>{for(;null!=r&&r.canLoadMore&&!t&&e===r.root;)await r.load(),r.canLoadMore&&r.load(),a(r.rooms)})(),()=>{t=!0}}),[e,r]),[(0,o.useMemo)((()=>{const e=t.trim(),i=e.toLowerCase(),o=(0,xa.Fv)(e),a=E.p.safeGet();return null==s?void 0:s.filter((e=>{var t;return e.room_type!==n.RoomType.Space&&"join"!==(null===(t=a.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())&&((0,xa.Fv)(e.name||"").includes(o)||(e.canonical_alias||"").includes(i))}))}),[s,t]),null!==(i=null==r?void 0:r.loading)&&void 0!==i&&i]})(null!=J?J:void 0,h);(0,o.useEffect)((()=>{setImmediate((()=>{const e=m.state.refs[0];var t,i;e&&(m.dispatch({type:Gi.Dy.SetFocus,payload:{ref:e}}),null===(t=e.current)||void 0===t||null===(i=t.scrollIntoView)||void 0===i||i.call(t,{block:"nearest"}))}))}),[$,v]);const X=(e,t=!1,n=!1)=>{if(t){const t=new Set(L.C.getValue("SpotlightSearch.recentSearches",null).reverse());t.delete(e.roomId),t.add(e.roomId),L.C.setValue("SpotlightSearch.recentSearches",null,U.R.ACCOUNT,Array.from(t).reverse().slice(0,10))}x.ZP.dispatch({action:W.a.ViewRoom,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:n,room_id:e.roomId,room_alias:e.roomAlias,auto_join:e.autoJoin&&!DR(e.joinRule),should_peek:e.shouldPeek,via_servers:e.viaServers}),DR(e.joinRule)&&x.ZP.dispatch({action:W.a.PromptAskToJoin}),i()};let ee,te;if((k||v!==fR.w.PublicRooms&&v!==fR.w.PublicSpaces)&&(ee=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_otherSearches"},o.createElement("h4",{id:"mx_SpotlightDialog_section_otherSearches"},k?(0,l._t)("spotlight_dialog|heading_with_query",{query:h}):(0,l._t)("spotlight_dialog|heading_without_query")),o.createElement("div",null,v!==fR.w.PublicSpaces&&R&&o.createElement(dR,{id:"mx_SpotlightDialog_button_explorePublicSpaces",className:"mx_SpotlightDialog_explorePublicSpaces",onClick:()=>f(fR.w.PublicSpaces)},CR(fR.w.PublicSpaces)),v!==fR.w.PublicRooms&&o.createElement(dR,{id:"mx_SpotlightDialog_button_explorePublicRooms",className:"mx_SpotlightDialog_explorePublicRooms",onClick:()=>f(fR.w.PublicRooms)},CR(fR.w.PublicRooms)),v!==fR.w.People&&o.createElement(dR,{id:"mx_SpotlightDialog_button_startChat",className:"mx_SpotlightDialog_startChat",onClick:()=>f(fR.w.People)},CR(fR.w.People))))),k||null!==v){const e=e=>{var t;if(kR(e)){const t=Zr.v.instance.getRoomState(e.room),i=NR(e.room,t),n={"aria-label":i?`${e.room.name} ${i}`:e.room.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.room.roomId}_details`};return o.createElement(dR,(0,kt.Z)({id:`mx_SpotlightDialog_button_result_${e.room.roomId}`,key:`${SR[e.section]}-${e.room.roomId}`,onClick:t=>{X({roomId:e.room.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:o.createElement(gR,{room:e.room})},n),o.createElement(us.Z,{room:e.room,size:yR,tooltipProps:{tabIndex:-1}}),e.room.name,o.createElement(ai.Z,{notification:t}),o.createElement(Zs,{id:`mx_SpotlightDialog_button_result_${e.room.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e.room}))}if(RR(e))return o.createElement(dR,{id:`mx_SpotlightDialog_button_result_${e.member.userId}`,key:`${SR[e.section]}-${e.member.userId}`,onClick:()=>{(0,zf.T0)(d,[e.member]),i()},"aria-label":e.member instanceof n.RoomMember?e.member.rawDisplayName:e.member.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.member.userId}_details`},o.createElement(Yx.h,{user:e.member,size:yR}),e.member instanceof n.RoomMember?e.member.rawDisplayName:e.member.name,o.createElement("div",{id:`mx_SpotlightDialog_button_result_${e.member.userId}_details`,className:"mx_SpotlightDialog_result_details"},e.member.userId));if(xR(e)){const t=d.getRoom(e.publicRoom.room_id),i=e.publicRoom.join_rule,n="join"===(null==t?void 0:t.getMyMembership())||e.publicRoom.world_readable&&!DR(i)||d.isGuest(),s=t=>{var n;t.stopPropagation();const{publicRoom:s}=e;X({roomAlias:s.canonical_alias||(null===(n=s.aliases)||void 0===n?void 0:n[0]),roomId:s.room_id,autoJoin:!e.publicRoom.world_readable&&!d.isGuest(),shouldPeek:e.publicRoom.world_readable||d.isGuest(),viaServers:D?[D.roomServer]:void 0,joinRule:i},!0,"click"!==t.type)};let a;return a=n?(0,l._t)("action|view"):DR(i)?(0,l._t)("action|ask_to_join"):(0,l._t)("action|join"),o.createElement(dR,{id:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}`,className:"mx_SpotlightDialog_result_multiline",key:`${SR[e.section]}-${e.publicRoom.room_id}`,onClick:s,endAdornment:o.createElement(ae.Z,{kind:n?"primary_outline":"primary",onClick:s,tabIndex:-1},a),"aria-labelledby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,"aria-describedby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,"aria-details":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`},o.createElement(ei.Z,{className:"mx_SearchResultAvatar",oobData:{roomId:e.publicRoom.room_id,name:e.publicRoom.name,avatarUrl:e.publicRoom.avatar_url,roomType:e.publicRoom.room_type},size:yR}),o.createElement(mR,{room:e.publicRoom,labelId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,descriptionId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,detailsId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`}))}return o.createElement(dR,{id:`mx_SpotlightDialog_button_result_${e.name}`,key:`${SR[e.section]}-${e.name}`,onClick:null!==(t=e.onClick)&&void 0!==t?t:null},e.avatar,e.name,e.description)};let t,s,a,r,c,m,h,p,u,g;if($[SR.People].length&&(t=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_people"},o.createElement("h4",{id:"mx_SpotlightDialog_section_people"},(0,l._t)("invite|recents_section")),o.createElement("div",null,$[SR.People].slice(0,ER).map(e)))),$[SR.Suggestions].length&&v===fR.w.People&&(s=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_suggestions"},o.createElement("h4",{id:"mx_SpotlightDialog_section_suggestions"},(0,l._t)("common|suggestions")),o.createElement("div",null,$[SR.Suggestions].slice(0,ER).map(e)))),$[SR.Rooms].length&&(a=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_rooms"},o.createElement("h4",{id:"mx_SpotlightDialog_section_rooms"},(0,l._t)("common|rooms")),o.createElement("div",null,$[SR.Rooms].slice(0,ER).map(e)))),$[SR.Spaces].length&&(r=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaces"},o.createElement("h4",{id:"mx_SpotlightDialog_section_spaces"},(0,l._t)("spotlight_dialog|spaces_title")),o.createElement("div",null,$[SR.Spaces].slice(0,ER).map(e)))),v===fR.w.PublicRooms||v===fR.w.PublicSpaces){let t;t=A?o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},v===fR.w.PublicRooms?(0,l._t)("spotlight_dialog|failed_querying_public_rooms"):(0,l._t)("spotlight_dialog|failed_querying_public_spaces")):$[SR.PublicRoomsAndSpaces].slice(0,ER).map(e),c=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_publicRooms"},o.createElement("div",{className:"mx_SpotlightDialog_sectionHeader"},o.createElement("h4",{id:"mx_SpotlightDialog_section_publicRooms"},(0,l._t)("common|suggestions")),o.createElement("div",{className:"mx_SpotlightDialog_options"},o.createElement(lR,{protocols:N,config:null!=D?D:null,setConfig:M}))),o.createElement("div",null,t))}Y.length&&J&&null===v&&(m=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaceRooms"},o.createElement("h4",{id:"mx_SpotlightDialog_section_spaceRooms"},(0,l._t)("spotlight_dialog|other_rooms_in_space",{spaceName:J.name})),o.createElement("div",null,Y.slice(0,ER).map((e=>o.createElement(dR,{id:`mx_SpotlightDialog_button_result_${e.room_id}`,key:e.room_id,onClick:t=>{X({roomId:e.room_id},!0,"click"!==(null==t?void 0:t.type))}},o.createElement(ys.Z,{name:e.name,idName:e.room_id,url:e.avatar_url?(0,mn.TS)(e.avatar_url).getSquareThumbnailHttp(parseInt(yR,10)):null,size:yR}),e.name||e.canonical_alias,e.name&&e.canonical_alias&&o.createElement("div",{className:"mx_SpotlightDialog_result_details"},e.canonical_alias)))),Q&&o.createElement(re.Z,null)))),!k.startsWith("#")||!k.includes(":")||(0,Ga.N)(k)&&d.getRoom((0,Ga.N)(k))||(h=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},o.createElement("div",null,o.createElement(dR,{id:"mx_SpotlightDialog_button_joinRoomAlias",className:"mx_SpotlightDialog_joinRoomAlias",onClick:e=>{x.ZP.dispatch({action:W.a.ViewRoom,room_alias:k,auto_join:!0,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:"click"!==(null==e?void 0:e.type)}),i()}},(0,l._t)("spotlight_dialog|join_button_text",{roomAddress:k}))))),v===fR.w.People?p=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},o.createElement("h4",null,(0,l._t)("spotlight_dialog|result_may_be_hidden_privacy_warning")),o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,l._t)("spotlight_dialog|cant_find_person_helpful_hint")),o.createElement(_R,{id:"mx_SpotlightDialog_button_inviteLink",className:"mx_SpotlightDialog_inviteLink",onClick:()=>{C(!0),(0,bn.RO)(w)},onHideTooltip:()=>C(!1),title:S?(0,l._t)("common|copied"):(0,l._t)("action|copy")},o.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,l._t)("spotlight_dialog|copy_link_text")))):!k||v!==fR.w.PublicRooms&&v!==fR.w.PublicSpaces||(p=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},o.createElement("h4",null,(0,l._t)("spotlight_dialog|result_may_be_hidden_warning")),o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,l._t)("spotlight_dialog|cant_find_room_helpful_hint")),o.createElement(dR,{id:"mx_SpotlightDialog_button_createNewRoom",className:"mx_SpotlightDialog_createRoom",onClick:()=>x.ZP.dispatch({action:"view_create_room",public:!0,defaultName:(0,ln.capitalize)(k)})},o.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,l._t)("spotlight_dialog|create_new_room_button"))))),v===fR.w.People&&(u=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_groupChat"},o.createElement("h4",{id:"mx_SpotlightDialog_section_groupChat"},(0,l._t)("spotlight_dialog|group_chat_section_title")),o.createElement(dR,{id:"mx_SpotlightDialog_button_startGroupChat",className:"mx_SpotlightDialog_startGroupChat",onClick:()=>(0,Ra.VR)(k)},(0,l._t)("spotlight_dialog|start_group_chat_button")))),null===v&&(g=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_messageSearch"},o.createElement("h4",{id:"mx_SpotlightDialog_section_messageSearch"},(0,l._t)("spotlight_dialog|message_search_section_title")),o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,l._t)("spotlight_dialog|search_messages_hint",{},{icon:()=>o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchIcon"})})))),te=o.createElement(o.Fragment,null,t,s,a,r,m,c,h,p,ee,u,g)}else{let e;u.length&&(e=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentSearches",role:"group",tabIndex:-1,"aria-labelledby":"mx_SpotlightDialog_section_recentSearches"},o.createElement("h4",null,o.createElement("span",{id:"mx_SpotlightDialog_section_recentSearches"},(0,l._t)("spotlight_dialog|recent_searches_section_title")),o.createElement(ae.Z,{kind:"link",onClick:g},(0,l._t)("action|clear"))),o.createElement("div",null,u.map((e=>{const t=Zr.v.instance.getRoomState(e),i=NR(0,t),n={"aria-label":i?`${e.name} ${i}`:e.name,"aria-describedby":`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`};return o.createElement(dR,(0,kt.Z)({id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}`,key:e.roomId,onClick:t=>{X({roomId:e.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:o.createElement(gR,{room:e})},n),o.createElement(us.Z,{room:e,size:yR,tooltipProps:{tabIndex:-1}}),e.name,o.createElement(ai.Z,{notification:t}),o.createElement(Zs,{id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e}))}))))),te=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentlyViewed",role:"group","aria-labelledby":"mx_SpotlightDialog_section_recentlyViewed"},o.createElement("h4",{id:"mx_SpotlightDialog_section_recentlyViewed"},(0,l._t)("spotlight_dialog|recently_viewed_section_title")),o.createElement("div",null,tc.$.instance.rooms.filter((e=>e.roomId!==ie.m.instance.roomViewStore.getRoomId())).map((e=>o.createElement(_R,{id:`mx_SpotlightDialog_button_recentlyViewed_${e.roomId}`,title:e.name,key:e.roomId,onClick:t=>{X({roomId:e.roomId},!1,"click"!==t.type)}},o.createElement(us.Z,{room:e,size:"32px",tooltipProps:{tabIndex:-1}}),e.name))))),e,ee)}const se=null===(s=m.state.activeRef)||void 0===s||null===(a=s.current)||void 0===a?void 0:a.id;return o.createElement(o.Fragment,null,o.createElement("div",{id:"mx_SpotlightDialog_keyboardPrompt"},(0,l._t)("spotlight_dialog|keyboard_scroll_hint",{},{arrows:()=>o.createElement(o.Fragment,null,o.createElement("kbd",null,"â"),o.createElement("kbd",null,"â"),null!==!v&&!h&&o.createElement("kbd",null,"â"),null!==!v&&!h&&o.createElement("kbd",null,"â"))})),o.createElement(q.Z,{className:"mx_SpotlightDialog",onFinished:i,hasCancel:!1,onKeyDown:e=>{if((0,dr.zL)().getNavigationAction(e)===tn.vB.FilterRooms)e.stopPropagation(),e.preventDefault(),i();let t;const n=(0,dr.zL)().getAccessibilityAction(e);switch(n){case tn.vB.Escape:e.stopPropagation(),e.preventDefault(),i();break;case tn.vB.ArrowUp:case tn.vB.ArrowDown:if(e.stopPropagation(),e.preventDefault(),m.state.activeRef&&m.state.refs.length>0){let e=m.state.refs;if(!h&&null!==!v){const t=bR(m.state.activeRef)?m.state.activeRef:e.find(bR);e=e.filter((e=>e===t||!bR(e)))}const i=e.indexOf(m.state.activeRef);t=(0,Gi.f4)(e,i+(n===tn.vB.ArrowUp?-1:1))}break;case tn.vB.ArrowLeft:case tn.vB.ArrowRight:if(!h&&null!==!v&&m.state.activeRef&&m.state.refs.length>0&&bR(m.state.activeRef)){e.stopPropagation(),e.preventDefault();const i=m.state.refs.filter(bR),s=i.indexOf(m.state.activeRef);t=(0,Gi.f4)(i,s+(n===tn.vB.ArrowLeft?-1:1))}}var s;t&&(m.dispatch({type:Gi.Dy.SetFocus,payload:{ref:t}}),null===(s=t.current)||void 0===s||s.scrollIntoView({block:"nearest"}))},screenName:"UnifiedSearch","aria-label":(0,l._t)("spotlight_dialog|search_dialog")},o.createElement("div",{className:"mx_SpotlightDialog_searchBox mx_textinput"},null!==v&&o.createElement("div",{className:yt()("mx_SpotlightDialog_filter",{mx_SpotlightDialog_filterPeople:v===fR.w.People,mx_SpotlightDialog_filterPublicRooms:v===fR.w.PublicRooms,mx_SpotlightDialog_filterPublicSpaces:v===fR.w.PublicSpaces})},o.createElement("span",null,CR(v)),o.createElement(ae.Z,{tabIndex:-1,alt:(0,l._t)("spotlight_dialog|remove_filter",{filter:CR(v)}),className:"mx_SpotlightDialog_filter--close",onClick:()=>f(null)})),o.createElement("input",{ref:r,autoFocus:!0,type:"text",autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:"false",placeholder:(0,l._t)("action|search"),value:h,onChange:e=>{const t=function(e){var t;const i=(0,Rt.My)(e);return null!==(t=null==i?void 0:i.primaryEntityId)&&void 0!==t?t:e}(e.currentTarget.value);p(t)},onKeyDown:e=>{var t,i;switch((0,dr.zL)().getAccessibilityAction(e)){case tn.vB.Backspace:h||null===v||(e.stopPropagation(),e.preventDefault(),f(null));break;case tn.vB.Enter:e.stopPropagation(),e.preventDefault(),null===(t=m.state.activeRef)||void 0===t||null===(i=t.current)||void 0===i||i.click()}},"aria-owns":"mx_SpotlightDialog_content","aria-activedescendant":se,"aria-label":(0,l._t)("action|search"),"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"}),(T||F||j)&&o.createElement(re.Z,{w:24,h:24})),o.createElement("div",{ref:c,id:"mx_SpotlightDialog_content",role:"listbox","aria-activedescendant":se,"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"},te)))},OR=e=>o.createElement(Gi.uP,null,(()=>o.createElement(MR,e)));var AR=i("../matrix-react-sdk/src/utils/dm/findDMForUser.ts"),LR=i("../matrix-react-sdk/src/utils/crypto/shouldForceDisableEncryption.ts");var UR=i("../matrix-react-sdk/node_modules/uuid/dist/esm-browser/v4.js");const FR="react_sdk_session_lock_ping",BR="react_sdk_session_lock_owner",VR="react_sdk_session_lock_claimant",jR=3e4;async function zR(e){const t=(0,UR.Z)(),i=r.k.withPrefix(`getSessionLock[${t}]`);let n=null;function s(){const e=window.localStorage.getItem(VR);if(e!==t)return i.warn(`Lock was claimed by ${e} while we were waiting for it: aborting startup`),-1;const n=window.localStorage.getItem(FR),s=window.localStorage.getItem(BR);if(null===n)return i.info("No other session has the lock: proceeding with startup"),0;const o=Date.now()-parseInt(n),a=jR-o;return a<=0?(i.info(`Last ping (from ${s}) was ${o}ms ago: proceeding with startup`),0):(i.info(`Last ping (from ${s}) was ${o}ms ago, waiting`),a)}function o(){window.localStorage.setItem(BR,t),window.localStorage.setItem(FR,Date.now().toString())}function a(){null!==n&&(i.debug("page hide: clearing our claim"),window.clearInterval(n),window.localStorage.removeItem(FR),window.localStorage.removeItem(BR),n=null)}for(window.localStorage.setItem(VR,t);;){const t=s();if(0==t)break;if(t<0)return await e(),!1;let i;const n=new Promise((e=>{i=t=>{t.key!==FR&&t.key!==VR||e(t)}})),o=new Promise((e=>{setTimeout(e,t,void 0)}));window.addEventListener("storage",i),await Promise.race([o,n]),window.removeEventListener("storage",i)}return o(),n=window.setInterval(o,5e3),window.addEventListener("storage",(function s(o){if(o.key===VR){const o=window.localStorage.getItem(VR);if(o===t)return;i.info(`Session ${o} is waiting for the lock`),window.removeEventListener("storage",s),async function(){await e(),null!==n&&window.clearInterval(n);window.localStorage.removeItem(FR),window.localStorage.removeItem(BR),n=null}().catch((e=>{i.error("Error releasing session lock",e)}))}})),window.addEventListener("pagehide",a),window.addEventListener("unload",a),!0}function WR(){const e=c.ZP.get().brand;return o.createElement(Ux,{className:"mx_SessionLockStolenView"},o.createElement("h1",null,(0,l._t)("error_app_open_in_another_tab_title",{brand:e})),o.createElement("h2",null,(0,l._t)("error_app_open_in_another_tab",{brand:e})))}function HR(e){const t=c.ZP.get().brand;return o.createElement("div",{className:"mx_ConfirmSessionLockTheftView"},o.createElement("div",{className:"mx_ConfirmSessionLockTheftView_body"},o.createElement("p",null,(0,l._t)("error_app_opened_in_another_window",{brand:t,label:(0,l._t)("action|continue")})),o.createElement(ae.Z,{kind:"primary",onClick:e.onConfirm},(0,l._t)("action|continue"))))}function GR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function KR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?GR(Object(i),!0).forEach((function(t){(0,k.Z)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):GR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const qR=["register","login","forgot_password","start_sso","start_cas","welcome"],$R=[W.a.ViewUserSettings,"view_create_chat","view_create_room"];class JR extends o.PureComponent{constructor(e){if(super(e),(0,k.Z)(this,"firstSyncComplete",!1),(0,k.Z)(this,"firstSyncPromise",void 0),(0,k.Z)(this,"screenAfterLogin",void 0),(0,k.Z)(this,"tokenLogin",void 0),(0,k.Z)(this,"focusComposer",void 0),(0,k.Z)(this,"subTitleStatus",void 0),(0,k.Z)(this,"prevWindowWidth",void 0),(0,k.Z)(this,"voiceBroadcastResumer",void 0),(0,k.Z)(this,"loggedInView",void 0),(0,k.Z)(this,"dispatcherRef",void 0),(0,k.Z)(this,"themeWatcher",void 0),(0,k.Z)(this,"fontWatcher",void 0),(0,k.Z)(this,"stores",void 0),(0,k.Z)(this,"startInitSession",(()=>{this.initSession().catch((e=>{r.k.error("Error initialising Matrix session",e)}))})),(0,k.Z)(this,"onWindowResized",(()=>{this.warnInConsole()})),(0,k.Z)(this,"warnInConsole",(0,ln.throttle)((()=>{const e="15px",t=(0,l._t)("console_wait"),n=(0,l._t)("console_scam_warning"),s=(0,l._t)("console_dev_note");i.g.mx_rage_logger.bypassRageshake("log",`%c${t}\n%c${n}\n%c${s}`,"font-size:50px; color:blue;",`font-size:${e}; color:red;`,`font-size:${e};`)}),1e3)),(0,k.Z)(this,"onAction",(e=>{var t;if(this.state.view!==He.Z.LOCK_STOLEN){if(null!==(t=E.p.get())&&void 0!==t&&t.isGuest()&&$R.includes(e.action))return x.ZP.dispatch({action:W.a.DoAfterSyncPrepared,deferred_action:e}),void x.ZP.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(E.p.safeGet().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(E.p.safeGet().setIdentityServerUrl(void 0),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),x.ZP.dispatch({action:"id_server_changed"})}break;case"logout":lt.ZP.instance.hangupAllCalls(),Promise.all([...[...lf.c.instance.activeCalls].map((e=>e.disconnect())),(0,Ut.Eh)(this.stores)]).finally((()=>fa(this.stores.oidcClientStore)));break;case"require_registration":!async function(e={}){const t=T.ZP.createDialog(mt.Z,{hasCancelButton:!0,quitOnly:!0,title:L.C.getValue(Ye.H.Registration)?(0,l._t)("auth|sign_in_or_register"):(0,l._t)("action|sign_in"),description:L.C.getValue(Ye.H.Registration)?(0,l._t)("auth|sign_in_or_register_description"):(0,l._t)("auth|sign_in_description"),button:(0,l._t)("action|sign_in"),extraButtons:L.C.getValue(Ye.H.Registration)?[o.createElement("button",{key:"register",onClick:()=>{t.close(),x.ZP.dispatch({action:"start_registration",screenAfterLogin:e.screen_after})}},(0,l._t)("auth|register_action"))]:[],onFinished:t=>{t?x.ZP.dispatch({action:"start_login",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?x.ZP.dispatch({action:W.a.ViewHomePage}):e.go_welcome_on_cancel&&x.ZP.dispatch({action:"view_welcome_page"})}})}(e);break;case"start_registration":if(ya()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(ya()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:He.Z.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":(0,Us.ZP)(E.p.safeGet(),{dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"copy_room":this.copyRoom(e.room_id);break;case"reject_invite":T.ZP.createDialog(mt.Z,{title:(0,l._t)("reject_invitation_dialog|title"),description:(0,l._t)("reject_invitation_dialog|confirmation"),onFinished:t=>{if(t){const t=T.ZP.createDialog(re.Z,void 0,"mx_Dialog_spinner");E.p.safeGet().leave(e.room_id).then((()=>{t.close(),this.state.currentRoomId===e.room_id&&x.ZP.dispatch({action:W.a.ViewHomePage})}),(e=>{t.close(),T.ZP.createDialog(dt.Z,{title:(0,l._t)("reject_invitation_dialog|failed"),description:e.toString()})}))}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"MatrixActions.RoomState.events":{const t=e.event;t.getType()===n.EventType.RoomCanonicalAlias&&t.getRoomId()===this.state.currentRoomId&&this.viewRoom({action:W.a.ViewRoom,room_id:this.state.currentRoomId,metricsTrigger:void 0});break}case W.a.ViewRoom:{const t=this.viewRoom(e);e.deferred_action&&t.then((()=>{x.ZP.dispatch(e.deferred_action)}));break}case W.a.ViewUserDeviceSettings:x.ZP.dispatch({action:W.a.ViewUserSettings,initialTabId:tl.o.SessionManager});break;case W.a.ViewUserSettings:{const t=e;T.ZP.createDialog(uk,{initialTabId:t.initialTabId,sdkContext:this.stores},void 0,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public,e.defaultName,e.type),this.viewSomethingBehindModal();break;case W.a.ViewRoomDirectory:T.ZP.createDialog(OR,{initialText:e.initialText,initialFilter:fR.w.PublicRooms},"mx_SpotlightDialog_wrapper",!1,!0),this.viewSomethingBehindModal();break;case"view_welcome_page":this.viewWelcome();break;case W.a.ViewHomePage:this.viewHome(e.justRegistered);break;case W.a.ViewStartChatOrReuse:this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":(0,Ra.VR)(e.initialText||""),this.viewSomethingBehindModal();break;case"view_invite":{const t=E.p.safeGet().getRoom(e.roomId);null!=t&&t.isSpaceRoom()?(0,ko.N2)(t):(0,Ra.DE)(e.roomId);break}case"view_last_screen":this.showScreenAfterLogin();break;case"hide_left_panel":this.setState({collapseLhs:!0},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case"show_left_panel":this.setState({collapseLhs:!1},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case W.a.OpenDialPad:T.ZP.createDialog(ky,{},"mx_Dialog_dialPadWrapper");break;case W.a.OnLoggedIn:this.stores.client=E.p.safeGet(),this.tokenLogin||ya()||this.state.view===He.Z.LOGIN||this.state.view===He.Z.REGISTER||this.state.view===He.Z.COMPLETE_SECURITY||this.state.view===He.Z.E2E_SETUP||this.state.view===He.Z.USE_CASE_SELECTION||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case W.a.OnLoggedOut:this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},(()=>{this.onWillStartClient()}));break;case"client_started":this.onClientStarted();break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case W.a.PseudonymousAnalyticsAccept:Sy(),L.C.setValue("pseudonymousAnalyticsOptIn",null,U.R.ACCOUNT,!0);break;case W.a.PseudonymousAnalyticsReject:Sy(),L.C.setValue("pseudonymousAnalyticsOptIn",null,U.R.ACCOUNT,!1);break;case W.a.ShowThread:{const{rootEvent:t,initialEvent:i,highlighted:n,scrollIntoView:s,push:o}=e,a={phase:im.q.ThreadView,state:{threadHeadEvent:t,initialEvent:i,isInitialEventHighlighted:n,initialEventScrollIntoView:s}};null!=o&&o?nm.Z.instance.pushCard(a):nm.Z.instance.setCards([{phase:im.q.ThreadPanel},a]),x.ZP.dispatch({action:W.a.FocusSendMessageComposer,context:qt.SB.Thread});break}case W.a.OpenSpotlight:T.ZP.createDialog(OR,{initialText:e.initialText,initialFilter:e.initialFilter},"mx_SpotlightDialog_wrapper",!1,!0)}}})),(0,k.Z)(this,"handleResize",(()=>{const e=1e3,t=mr.default.instance.windowWidth;this.prevWindowWidth<e&&t>=e&&x.ZP.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=e&&t<e&&x.ZP.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=t,this.state.resizeNotifier.notifyWindowResized()})),(0,k.Z)(this,"onRegisterClick",(()=>{this.showScreen("register")})),(0,k.Z)(this,"onLoginClick",(()=>{this.showScreen("login")})),(0,k.Z)(this,"onForgotPasswordClick",(()=>{this.showScreen("forgot_password")})),(0,k.Z)(this,"onRegisterFlowComplete",((e,t)=>this.onUserCompletedLoginFlow(e,t))),(0,k.Z)(this,"onUpdateStatusIndicator",((e,t)=>{const i=e.numUnreadStates;a.Z.get()&&(a.Z.get().setErrorStatus(t===n.SyncState.Error),a.Z.get().setNotificationCount(i)),this.subTitleStatus="",t===n.SyncState.Error&&(this.subTitleStatus+=`[${(0,l._t)("common|offline")}] `),i>0?this.subTitleStatus+=`[${i}]`:e.color>=Sr.v.Bold&&(this.subTitleStatus+="*"),this.setPageSubtitle()})),(0,k.Z)(this,"onServerConfigChange",(e=>{this.setState({serverConfig:e})})),(0,k.Z)(this,"onUserCompletedLoginFlow",(async(e,t)=>{this.stores.accountPasswordStore.setPassword(t),await ha(e),await this.postLoginSetup(),Nx.instance.stop(Zx.LOGIN),Nx.instance.stop(Zx.REGISTER)})),(0,k.Z)(this,"onCompleteSecurityE2eSetupFinished",(()=>{this.onLoggedIn()})),this.stores=ie.m.instance,this.stores.constructEagerStores(),this.state={view:He.Z.LOADING,collapseLhs:!1,currentRoomId:null,currentUserId:null,hideToSRUsers:!1,syncError:null,resizeNotifier:new za,ready:!1},this.loggedInView=(0,o.createRef)(),c.ZP.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=(0,xa.PQ)(),this.props.config.sync_timeline_limit&&(E.p.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring(5);at.instance.storeInvite(t,e)}}this.prevWindowWidth=mr.default.instance.windowWidth||1e3,mr.default.instance.on(mr.Q.Resize,this.handleResize),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),Zr.v.instance.on(Zr.w,this.onUpdateStatusIndicator),this.dispatcherRef=x.ZP.register(this.onAction),this.themeWatcher=new Wa.Z,this.fontWatcher=new Ha.C,this.themeWatcher.start(),this.fontWatcher.start(),this.focusComposer=!1,this.subTitleStatus="",(0,ft.j6)(c.ZP.get("sentry")),!function(){const e=window.localStorage.getItem(FR);return null===e||Date.now()-parseInt(e)>jR}()?setTimeout((()=>this.setState({view:He.Z.CONFIRM_LOCK_THEFT})),0):this.startInitSession()}async initSession(){var e,t,i;if(!await zR((()=>this.onSessionLockStolen())))return;if(ya())return void na();const n=await oa(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin());if((null!==(e=this.props.realQueryParams)&&void 0!==e&&e.loginToken||null!==(t=this.props.realQueryParams)&&void 0!==t&&t.code||null!==(i=this.props.realQueryParams)&&void 0!==i&&i.state)&&this.props.onTokenLoginCompleted(),n)return this.tokenLogin=!0,await ma({ignoreGuest:!0}),void await this.postLoginSetup();const s=this.screenAfterLogin?this.screenAfterLogin.screen:null;await this.loadSession()||null!==s&&qR.includes(s)&&this.showScreenAfterLogin()}async onSessionLockStolen(){await new Promise((e=>{this.setState({view:He.Z.LOCK_STOLEN},e)})),await async function(){ea=!0,Ca()}()}async postLoginSetup(){const e=E.p.safeGet(),t=e.isCryptoEnabled();t||this.onLoggedIn();const i=[this.firstSyncPromise.promise];let n=!1;t&&i.push((async()=>{n=await e.userHasCrossSigningKeys()})()),this.setState({pendingInitialSync:!0}),await Promise.all(i),t?(n?!1===y.Z.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:He.Z.COMPLETE_SECURITY}):await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")&&!(e=>(0,LR.Q)(e)&&!e.getRooms().some((t=>e.isRoomEncrypted(t.roomId))))(e)?this.setStateForNewView({view:He.Z.E2E_SETUP}):this.onLoggedIn(),this.setState({pendingInitialSync:!1})):this.setState({pendingInitialSync:!1})}setState(e,t){this.shouldTrackPageChange(this.state,KR(KR({},this.state),e))&&this.startPageChangeTimer(),super.setState(e,t)}componentDidMount(){window.addEventListener("resize",this.onWindowResized)}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();null!=e&&kn.Z.instance.trackPageChange(this.state.view,this.state.page_type,e)}this.focusComposer&&(x.ZP.fire(W.a.FocusSendMessageComposer),this.focusComposer=!1)}componentWillUnmount(){var e;Ca(),x.ZP.unregister(this.dispatcherRef),this.themeWatcher.stop(),this.fontWatcher.stop(),mr.default.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),window.removeEventListener("resize",this.onWindowResized),this.stores.accountPasswordStore.clearPassword(),null===(e=this.voiceBroadcastResumer)||void 0===e||e.destroy()}getFallbackHsUrl(){var e;if(null!==(e=this.getServerProperties().serverConfig)&&void 0!==e&&e.isDefault)return this.props.config.fallback_hs_url}getServerProperties(){return{serverConfig:this.state.serverConfig||c.ZP.get("validated_server_config")}}loadSession(){return Promise.resolve().then((()=>na({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName}))).then((e=>(e||(at.instance.pickBestInvite()?x.ZP.dispatch({action:"start_registration"}):x.ZP.dispatch({action:"view_welcome_page"})),e)))}startPageChangeTimer(){Nx.instance.start(Zx.PAGE_CHANGE)}stopPageChangeTimer(){const e=Nx.instance;e.stop(Zx.PAGE_CHANGE);const t=e.getEntries({name:Zx.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");this.setState(KR({currentUserId:void 0,justRegistered:!1},e))}setPage(e){this.setState({page_type:e})}async startRegistration(e){const t={view:He.Z.REGISTER};if(e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid){t.serverConfig=await u.validateServerConfigWithStaticUrls(e.hs_url,e.is_url);const i=c.ZP.get("validated_server_config");i&&i.hsUrl===t.serverConfig.hsUrl&&(t.serverConfig.hsName=i.hsName,t.serverConfig.hsNameIsDifferent=i.hsNameIsDifferent,t.serverConfig.isDefault=i.isDefault,t.serverConfig.isNameResolvable=i.isNameResolvable),t.register_client_secret=e.client_secret,t.register_session_id=e.session_id,t.register_id_sid=e.sid}this.setStateForNewView(t),Va.Z.isLogin=!0,this.themeWatcher.recheck(),this.notifyNewScreen("register")}async viewRoom(e){var t;if(this.focusComposer=!0,e.room_alias?r.k.log(`Switching to room alias ${e.room_alias} at event ${e.event_id}`):r.k.log(`Switching to room id ${e.room_id} at event ${e.event_id}`),!this.firstSyncComplete){if(!this.firstSyncPromise)return void r.k.warn("Cannot view a room before first sync. room_id:",e.room_id);await this.firstSyncPromise.promise}let i=e.room_alias||e.room_id;const n=E.p.safeGet().getRoom(e.room_id);if(n){var s;n.decryptAllEvents();const e=Ia.aE(n);e&&(i=e,(0,Ga.d)(e,n.roomId)),null===(s=localStorage)||void 0===s||s.setItem("mx_last_room_id",n.roomId)}let o="#"===i[0]&&e.room_id===this.state.currentRoomId;var a,l,c,d;((0,Wn.S)(this.state.currentRoomId)&&(o=!0),e.room_id===this.state.currentRoomId)&&(e.threepid_invite=null!==(a=e.threepid_invite)&&void 0!==a?a:this.state.threepidInvite,e.oob_data=null!==(l=e.oob_data)&&void 0!==l?l:this.state.roomOobData,e.forceTimeline=null!==(c=e.forceTimeline)&&void 0!==c?c:this.state.forceTimeline,e.justCreatedOpts=null!==(d=e.justCreatedOpts)&&void 0!==d?d:this.state.roomJustCreatedOpts);e.event_id&&e.highlighted&&(i+="/"+e.event_id),this.setState({view:He.Z.LOGGED_IN,currentRoomId:null!==(t=e.room_id)&&void 0!==t?t:null,page_type:Ba.Z.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,forceTimeline:e.forceTimeline,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},(()=>{Va.Z.isLogin=!1,this.themeWatcher.recheck(),this.notifyNewScreen("room/"+i,o)}))}viewSomethingBehindModal(){this.state.view===He.Z.LOGGED_IN?this.state.currentRoomId||this.state.currentUserId||this.viewHome():this.viewWelcome()}viewWelcome(){if(function(e){const t=new ka.B(e).get("embedded_pages");return!!t&&!0===new ka.B(t).get("login_for_welcome")}(c.ZP.get()))return this.viewLogin();this.setStateForNewView({view:He.Z.WELCOME}),this.notifyNewScreen("welcome"),Va.Z.isLogin=!0,this.themeWatcher.recheck()}viewLogin(e){this.setStateForNewView(KR({view:He.Z.LOGIN},e)),this.notifyNewScreen("login"),Va.Z.isLogin=!0,this.themeWatcher.recheck()}viewHome(e=!1){this.setStateForNewView({view:He.Z.LOGGED_IN,justRegistered:e,currentRoomId:null}),this.setPage(Ba.Z.HomePage),this.notifyNewScreen("home"),Va.Z.isLogin=!1,this.themeWatcher.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then((()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(Ba.Z.UserView)):this.chatCreateOrReuse(e)}))}async createRoom(e=!1,t,i){const n=T.ZP.createDialog(gk.Z,{type:i,defaultPublic:e,defaultName:t}),[s,o]=await n.finished;s&&(0,Us.ZP)(E.p.safeGet(),o)}chatCreateOrReuse(e){const t=new ka.B(this.props.config);if(E.p.safeGet().isGuest())return e!==t.get("welcome_user_id")&&x.ZP.dispatch({action:W.a.DoAfterSyncPrepared,deferred_action:{action:W.a.ViewStartChatOrReuse,user_id:e}}),void x.ZP.dispatch({action:"require_registration",go_welcome_on_cancel:!0,screen_after:{screen:`user/${t.get("welcome_user_id")}`,params:{action:"chat"}}});const i=E.p.safeGet(),n=(0,AR.n)(i,e);n?x.ZP.dispatch({action:W.a.ViewRoom,room_id:n.roomId,metricsTrigger:"MessageUser"}):x.ZP.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=E.p.safeGet().getRoom(e),i=null==t?void 0:t.isSpaceRoom(),n=[];if(1===(null==t?void 0:t.currentState.getJoinedMemberCount()))return n.push(o.createElement("span",{className:"warning",key:"only_member_warning"}," ",(0,l._t)("leave_room_dialog|last_person_warning"))),n;const s=null==t?void 0:t.currentState.getStateEvents("m.room.join_rules","");if(s){"public"!==s.getContent().join_rule&&n.push(o.createElement("span",{className:"warning",key:"non_public_warning"}," ",i?(0,l._t)("leave_room_dialog|space_rejoin_warning"):(0,l._t)("leave_room_dialog|room_rejoin_warning")))}return n}leaveRoom(e){var t,i;const n=E.p.safeGet(),s=n.getRoom(e),a=this.leaveRoomWarnings(e),r=null==s?void 0:s.isSpaceRoom();T.ZP.createDialog(mt.Z,{title:r?(0,l._t)("space|leave_dialog_action"):(0,l._t)("action|leave_room"),description:o.createElement("span",null,r?(0,l._t)("leave_room_dialog|leave_space_question",{spaceName:null!==(t=null==s?void 0:s.name)&&void 0!==t?t:(0,l._t)("common|unnamed_space")}):(0,l._t)("leave_room_dialog|leave_room_question",{roomName:null!==(i=null==s?void 0:s.name)&&void 0!==i?i:(0,l._t)("common|unnamed_room")}),a),button:(0,l._t)("action|leave"),onFinished:async t=>{t&&(await(0,oo.c)(n,e),x.ZP.dispatch({action:W.a.AfterLeaveRoom,room_id:e}))}})}forgetRoom(e){const t=E.p.safeGet().getRoom(e);E.p.safeGet().forget(e).then((()=>{this.state.currentRoomId===e&&x.ZP.dispatch({action:W.a.ViewHomePage}),t&&ic.ZP.instance.manualRoomUpdate(t,nr.GB.RoomRemoved)})).catch((e=>{const t=e.errcode||(0,l.I8)("error|unknown_error_code");T.ZP.createDialog(dt.Z,{title:(0,l._t)("error_dialog|forget_room_failed",{errCode:t}),description:e&&e.message?e.message:(0,l._t)("invite|failed_generic")})}))}async copyRoom(e){const t=(0,Rt.dl)(E.p.safeGet(),e);await(0,bn.RO)(t)||T.ZP.createDialog(dt.Z,{title:(0,l._t)("error_dialog|copy_room_link_failed|title"),description:(0,l._t)("error_dialog|copy_room_link_failed|description")})}async startWelcomeUserChat(){const e=new ka.B(this.props.config),t=e.get("welcome_user_id");if(!t)return null;let i;i=this.firstSyncComplete?Promise.resolve():this.firstSyncPromise.promise,await i;if(0===P.Z.shared().getDMRoomsForUserId(t).length){const i=await(0,Us.ZP)(E.p.safeGet(),{dmUserId:e.get("welcome_user_id"),andView:!this.state.currentRoomId,spinner:!1}),s=e=>{e.getType()===n.EventType.Direct&&e.getContent()[t]&&(E.p.safeGet().store.save(!0),E.p.safeGet().removeListener(n.ClientEvent.AccountData,s))};return E.p.safeGet().on(n.ClientEvent.AccountData,s),i}return null}async onLoggedIn(){if(Va.Z.isLogin=!1,this.themeWatcher.recheck(),A.bm(),!E.p.currentUserIsJustRegistered()||null!==L.C.getValue("FTUE.useCaseSelection"))return this.onShowPostLoginScreen();this.setStateForNewView({view:He.Z.USE_CASE_SELECTION}),L.C.watchSetting("FTUE.useCaseSelection",null,((e,t,i,n,s)=>{null!==s&&this.state.view===He.Z.USE_CASE_SELECTION&&this.onShowPostLoginScreen()}))}async onShowPostLoginScreen(e){var t;if(e&&(rt.S.instance.setProperty("ftueUseCaseSelection",e),L.C.setValue("FTUE.useCaseSelection",null,U.R.ACCOUNT,e)),this.setStateForNewView({view:He.Z.LOGGED_IN}),null!==(t=this.screenAfterLogin)&&void 0!==t&&t.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0;else if(E.p.currentUserIsJustRegistered()){E.p.setJustRegisteredUserId(null);if(new ka.B(this.props.config).get("welcome_user_id")&&(0,l.Wx)().startsWith("en")){null===await this.startWelcomeUserChat()&&x.ZP.dispatch({action:W.a.ViewHomePage,justRegistered:!0})}else if(at.instance.pickBestInvite()){const e=at.instance.pickBestInvite(),t=at.instance.translateToWireFormat(e);this.showScreen(`room/${e.roomId}`,t)}else x.ZP.dispatch({action:W.a.ViewHomePage,justRegistered:!0})}else this.showScreenAfterLogin();c.ZP.get("mobile_guide_toast")&&(()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent),i=c.ZP.get().brand;(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||F.Z.sharedInstance().addOrReplaceToast({key:Iy,title:(0,l._t)("mobile_guide|toast_title"),props:{description:(0,l._t)("mobile_guide|toast_description",{brand:i}),acceptLabel:(0,l._t)("mobile_guide|toast_accept"),onAccept:xy,rejectLabel:(0,l._t)("action|dismiss"),onReject:Ry},component:z.Z,priority:99}))})();const i=c.ZP.get("user_notice");if(i){const e="user_notice_"+i.title;i.show_once&&localStorage.getItem(e)||F.Z.sharedInstance().addOrReplaceToast({key:e,title:i.title,props:{description:o.createElement(hn.zR,null,i.description),acceptLabel:(0,l._t)("action|ok"),onAccept:()=>{F.Z.sharedInstance().dismissToast(e),localStorage.setItem(e,"1")}},component:z.Z,className:"mx_AnalyticsToast",priority:100})}}initPosthogAnalyticsToast(){null===L.C.getValue("pseudonymousAnalyticsOptIn")&&wy(),L.C.watchSetting("pseudonymousAnalyticsOptIn",null,((e,t,i,n,s)=>{null===s?wy():Sy()}))}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():E.p.safeGet().isGuest()?x.ZP.dispatch({action:"view_welcome_page"}):x.ZP.dispatch({action:W.a.ViewHomePage})}viewLastRoom(){var e;x.ZP.dispatch({action:W.a.ViewRoom,room_id:null!==(e=localStorage.getItem("mx_last_room_id"))&&void 0!==e?e:void 0,metricsTrigger:void 0})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle(),this.stores.onLoggedOut()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:He.Z.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=(0,xa.PQ)();const e=E.p.safeGet();e.setCanResetTimelineCallback((e=>(r.k.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e))))),e.on(n.ClientEvent.Sync,((e,t,i)=>{var s;e===n.SyncState.Error||e===n.SyncState.Reconnecting?((null==i?void 0:i.error)instanceof _.wu&&function(e){if(e.reason===_.wu.TOGGLED_LAZY_LOADING)Promise.resolve().then((()=>{const t=e.value;return new Promise(t?e=>{T.ZP.createDialog(ht,{onFinished:e})}:e=>{T.ZP.createDialog(pt,{onFinished:e,host:window.location.host})})})).then((()=>E.p.safeGet().store.deleteAllData())).then((()=>{var e;null===(e=a.Z.get())||void 0===e||e.reload()}))}(i.error),this.setState({syncError:null!==(s=null==i?void 0:i.error)&&void 0!==s?s:null})):this.state.syncError&&this.setState({syncError:null});e===n.SyncState.Syncing&&t===n.SyncState.Syncing||(r.k.debug(`MatrixClient sync state => ${e}`),e===n.SyncState.Prepared&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),S.default.shouldShowPrompt()&&!E.p.userRegisteredWithinLastHours(24)&&(0,uf.C)(!1),x.ZP.fire(W.a.FocusSendMessageComposer),this.setState({ready:!0})))})),e.on(n.HttpApiEvent.SessionLoggedOut,(function(e){if(!_a){if(T.ZP.closeCurrentModal("Session.logged_out"),401===e.httpStatus&&e.data&&e.data.soft_logout)return r.k.warn("Soft logout issued by server - avoiding data deletion"),void Ea();T.ZP.createDialog(dt.Z,{title:(0,l._t)("auth|session_logged_out_title"),description:(0,l._t)("auth|session_logged_out_description")}),x.ZP.dispatch({action:"logout"})}})),e.on(n.HttpApiEvent.NoConsent,(function(t,i){T.ZP.createDialog(mt.Z,{title:(0,l._t)("terms|tac_title"),description:o.createElement("div",null,o.createElement("p",null," ",(0,l._t)("terms|tac_description",{homeserverDomain:e.getDomain()}))),button:(0,l._t)("terms|tac_button"),cancelButton:(0,l._t)("action|dismiss"),onFinished:e=>{if(e){window.open(i,"_blank").opener=null}}},void 0,!0)}));const t=Sn.instance;t.start(),e.on(n.HttpApiEvent.SessionLoggedOut,(()=>t.stop())),e.on(n.MatrixEventEvent.Decrypted,((e,i)=>t.eventDecrypted(e,i))),e.on(n.ClientEvent.Room,(t=>{if(e.isCryptoEnabled()){const e=L.C.getValueAt(U.R.ROOM_DEVICE,"blacklistUnverifiedDevices",t.roomId,!0);t.setBlacklistUnverifiedDevices(e)}})),e.on(j.qG.Warning,(e=>{if("CRYPTO_WARNING_OLD_VERSION_DETECTED"===e)T.ZP.createDialog(dt.Z,{title:(0,l._t)("encryption|old_version_detected_title"),description:(0,l._t)("encryption|old_version_detected_description",{brand:c.ZP.get().brand})})})),e.on(j.qG.KeyBackupFailed,(async t=>{let n,s=null;if(e.getKeyBackupEnabled())n=!0;else try{s=await e.getKeyBackupVersion(),null!==s&&(n=!0)}catch(e){return void r.k.error("Saw key backup error but failed to check backup version!",e)}n?T.ZP.createDialogAsync(i.e(8481).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/security/NewRecoveryMethodDialog.tsx")),{newVersionInfo:s}):T.ZP.createDialogAsync(i.e(9415).then(i.bind(i,"../matrix-react-sdk/src/async-components/views/dialogs/security/RecoveryMethodRemovedDialog.tsx")))})),e.on(j.qG.KeySignatureUploadFailure,((e,t,i)=>{T.ZP.createDialog(vk,{failures:e,source:t,continuation:i})})),e.on(j.qG.VerificationRequestReceived,(e=>{e.verifier?T.ZP.createDialog(bk,{verifier:e.verifier},void 0,!1,!0):e.pending&&F.Z.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.transactionId,title:(0,l._t)("encryption|verification_requested_toast_title"),icon:"verification",props:{request:e},component:Tx,priority:90})})),this.voiceBroadcastResumer=new Ut.X8(e)}onClientStarted(){const e=E.p.safeGet();if(e.isCryptoEnabled()){const t=L.C.getValueAt(U.R.DEVICE,"blacklistUnverifiedDevices");e.setGlobalBlacklistUnverifiedDevices(t),e.setGlobalErrorOnUnknownDevices(!1)}rt.S.instance.isEnabled()&&L.C.isLevelSupported(U.R.ACCOUNT)&&this.initPosthogAnalyticsToast()}showScreen(e,t){const i=E.p.get();if(!i||i.isGuest()||!qR.includes(e))if("register"===e)x.ZP.dispatch({action:"start_registration",params:t}),Nx.instance.start(Zx.REGISTER);else if("login"===e)x.ZP.dispatch({action:"start_login",params:t}),Nx.instance.start(Zx.LOGIN);else if("forgot_password"===e)x.ZP.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)null!=i&&i.getUserId()&&!ya()?this.viewLastRoom():x.ZP.dispatch({action:"start_login",params:t});else if("new"===e)x.ZP.dispatch({action:"view_create_room"});else if("dm"===e)x.ZP.dispatch({action:"view_create_chat"});else if("settings"===e)x.ZP.fire(W.a.ViewUserSettings);else if("welcome"===e)x.ZP.dispatch({action:"view_welcome_page"});else if("home"===e)x.ZP.dispatch({action:W.a.ViewHomePage});else if("start"===e)this.showScreen("home"),x.ZP.dispatch({action:"require_registration"});else if("directory"===e)x.ZP.fire(W.a.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){var s;let t=E.p.get();if(!t){const{hsUrl:e,isUrl:i}=this.getServerProperties().serverConfig;t=(0,n.createClient)({baseUrl:e,idBaseUrl:i})}const i="start_sso"===e?"sso":"cas";null===(s=a.Z.get())||void 0===s||s.startSingleSignOn(t,i,this.getFragmentAfterLogin())}else if(0===e.indexOf("room/")){var o,l,c;const i=e.substring(5),n=i.indexOf(":")+1;let s=i.length;i.substring(n).indexOf("/")>-1&&(s=n+i.substring(n).indexOf("/"));const a=i.substring(0,s);let r,d=i.substring(s+1);if(d||(d=void 0),null!=t&&t.signurl&&null!=t&&t.email&&(r=at.instance.storeInvite(a,t)),!r){r=at.instance.getInvites().find((e=>e.roomId===a))}let m=[];null!=t&&t.via&&(m="string"==typeof t.via?[t.via]:t.via);const h={action:W.a.ViewRoom,event_id:d,via_servers:m,highlighted:Boolean(d),threepid_invite:r,oob_data:{name:null===(o=r)||void 0===o?void 0:o.roomName,avatarUrl:null===(l=r)||void 0===l?void 0:l.roomAvatarUrl,inviterName:null===(c=r)||void 0===c?void 0:c.inviterName},room_alias:void 0,room_id:void 0,metricsTrigger:void 0};"#"===a[0]?h.room_alias=a:h.room_id=a,x.ZP.dispatch(h)}else if(0===e.indexOf("user/")){const i=e.substring(5);x.ZP.dispatch({action:"view_user_info",userId:i,subAction:null==t?void 0:t.action})}else r.k.info(`Ignoring showScreen for '${e}'`);else x.ZP.dispatch({action:W.a.ViewHomePage})}notifyNewScreen(e,t=!1){this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onLogoutClick(e){x.ZP.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){x.ZP.dispatch({action:"timeline_resize"})}onRegistered(e){return ha(e)}onSendEvent(e,t){const i=E.p.get();i&&i.sendEvent(e,t.getType(),t.getContent()).then((()=>{x.ZP.dispatch({action:"message_sent"})}))}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=E.p.get(),i=null==t?void 0:t.getRoom(this.state.currentRoomId);i&&(e=`${this.subTitleStatus} | ${i.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${c.ZP.get().brand} ${e}`;document.title!==t&&(document.title=t)}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e=`/${t.screen}`),e}render(){const e=this.getFragmentAfterLogin();let t;if(this.state.view===He.Z.LOADING)t=o.createElement("div",{className:"mx_MatrixChat_splash"},o.createElement(re.Z,null));else if(this.state.view===He.Z.CONFIRM_LOCK_THEFT)t=o.createElement(HR,{onConfirm:()=>{this.setState({view:He.Z.LOADING}),this.startInitSession()}});else if(this.state.view===He.Z.COMPLETE_SECURITY)t=o.createElement(Rk,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===He.Z.E2E_SETUP)t=o.createElement(rx,{onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.stores.accountPasswordStore.getPassword(),tokenLogin:!!this.tokenLogin});else if(this.state.view===He.Z.LOGGED_IN){const e=this.state.syncError&&this.state.syncError instanceof _.wu;if(this.state.ready&&this.state.page_type&&!e)t=o.createElement(hy,(0,kt.Z)({},this.props,this.state,{ref:this.loggedInView,matrixClient:E.p.safeGet(),onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId}));else{let i;this.state.syncError&&!e&&(i=o.createElement("div",{className:"mx_MatrixChat_syncError"},(0,Io.G6)(this.state.syncError))),t=o.createElement("div",{className:"mx_MatrixChat_splash"},i,o.createElement(re.Z,null),o.createElement("div",{className:"mx_MatrixChat_splashButtons"},o.createElement(ae.Z,{kind:"link_inline",onClick:this.onLogoutClick},(0,l._t)("action|logout"))))}}else if(this.state.view===He.Z.WELCOME)t=o.createElement(Zk,null);else if(this.state.view===He.Z.REGISTER&&L.C.getValue(Ye.H.Registration)){var i;const n=null===(i=at.instance.pickBestInvite())||void 0===i?void 0:i.toEmail;t=o.createElement(Ex,(0,kt.Z)({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:n,brand:this.props.config.brand,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===He.Z.FORGOT_PASSWORD&&L.C.getValue(Ye.H.PasswordReset))t=o.createElement(ox,(0,kt.Z)({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick},this.getServerProperties()));else if(this.state.view===He.Z.LOGIN){var n;const i=L.C.getValue(Ye.H.PasswordReset);t=o.createElement(Ix,(0,kt.Z)({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:i?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:null===(n=this.props.startingFragmentQueryParams)||void 0===n?void 0:n.defaultUsername},this.getServerProperties()))}else if(this.state.view===He.Z.SOFT_LOGOUT)t=o.createElement(Ax,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e});else if(this.state.view===He.Z.USE_CASE_SELECTION)t=o.createElement(Bx,{onFinished:e=>this.onShowPostLoginScreen(e)});else{if(this.state.view!==He.Z.LOCK_STOLEN)return r.k.error(`Unknown view ${this.state.view}`),null;t=o.createElement(WR,null)}return o.createElement($h.Z,null,o.createElement(ie.f.Provider,{value:this.stores},t))}}(0,k.Z)(JR,"displayName","MatrixChat"),(0,k.Z)(JR,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}});var YR=i("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WrapperLifecycle.js"),QR=i("./src/vector/url_utils.ts");let XR=null;function eI(e){const t=(0,QR.D)(e);return{screen:t.location.substring(1),params:t.params}}function tI(){decodeURIComponent(window.location.hash)!==XR&&function(e){if(!window.matrixChat)return;r.k.log("Routing URL ",e.href);const t=eI(e);window.matrixChat.showScreen(t.screen,t.params)}(window.location)}function iI(e,t=!1){r.k.log("newscreen "+e);const i="#/"+e;XR=i,e.startsWith("room/")&&window.location.hash.includes("/$")===i.includes("/$")&&window.location.hash.startsWith(i)&&(t=!0),t?window.location.replace(i):window.location.assign(i)}const nI="mx_screen_after_login";function sI(e){const t=eI(e);(t.screen||t.params)&&function(e){null!=e&&e.screen&&sessionStorage.setItem(nI,JSON.stringify(e))}(t);const i=function(){const e=sessionStorage.getItem(nI);return e?JSON.parse(e):void 0}();return i}function oI(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),e.searchParams.delete("state"),e.searchParams.delete("code"),r.k.log(`Redirecting to ${e.href} to drop delegated authentication params from queryparams`),window.history.replaceState(null,"",e.href)}async function aI(e,t){var i;window.addEventListener("hashchange",tI);const s=a.Z.get(),l=(0,QR.l)(window.location),d=window.location.protocol+"//"+window.location.host+window.location.pathname;r.k.log("Vector starting at "+d),s.startUpdater();const m=await async function(){let e;try{r.k.log("Verifying homeserver configuration");const t=c.ZP.get();let i=t.default_server_config;const n=t.default_server_name,s=t.default_hs_url,o=t.default_is_url,a=[i,n,s].filter((e=>!!e));if(s&&(i||n))throw new Ck.yh("error|invalid_configuration_mixed_server");if(a.length<1)throw new Ck.yh("error|invalid_configuration_no_server");let l;s&&(r.k.log("Config uses a default_hs_url - constructing a default_server_config using this information"),r.k.warn("DEPRECATED CONFIG OPTION: In the future, default_hs_url will not be accepted. Please use default_server_config instead."),i={"m.homeserver":{base_url:s}},o&&(i["m.identity_server"]={base_url:o})),!n&&i&&(r.k.log("Config uses a default_server_config - validating object"),l=await g.mb.fromDiscoveryConfig(i)),n&&(r.k.log("Config uses a default_server_name - doing .well-known lookup"),r.k.warn("DEPRECATED CONFIG OPTION: In the future, default_server_name will not be accepted. Please use default_server_config instead."),l=await g.mb.findClientConfig(n),null===l["m.homeserver"].base_url&&i&&(r.k.log("Finding base_url failed but a default_server_config was found - using it as a fallback"),l=await g.mb.fromDiscoveryConfig(i))),e=u.buildValidatedConfigFromDiscovery(n,l,!0)}catch(t){const{hsUrl:i,isUrl:n,userId:s}=await ca();if(!i||!s)throw t;r.k.error(t),r.k.warn("A session was found - suppressing config error and using the session's homeserver"),r.k.log("Using pre-existing hsUrl and isUrl: ",{hsUrl:i,isUrl:n}),e=await u.validateServerConfigWithStaticUrls(i,n,!0)}return e.isDefault=!0,r.k.log("Using homeserver config:",e),r.k.log("Updating SdkConfig with validated discovery information"),c.ZP.add({validated_server_config:e}),c.ZP.get()}(),h=new ka.B(m),[p]=await sa(),v=!!p,_=!!l.loginToken,f=(0,c.vj)(m);let E=!0===f.immediate;const y="#/welcome"===window.location.hash||"#"===window.location.hash||""===window.location.hash;if(!E&&f.on_welcome_page&&y&&(E=!0),!v&&!_&&E){r.k.log("Bypassing app load to redirect to SSO");const e=(0,n.createClient)({baseUrl:m.validated_server_config.hsUrl,idBaseUrl:m.validated_server_config.isUrl});return a.Z.get().startSingleSignOn(e,"sso",`/${eI(window.location).screen}`),o.createElement(o.Fragment,null)}const b=null!==(i=h.get("default_device_display_name"))&&void 0!==i?i:null==s?void 0:s.getDefaultDeviceDisplayName(),w=sI(window.location),S={Wrapper:o.Fragment};return Am.E.instance.invoke(YR.U.Wrapper,S),o.createElement(S.Wrapper,null,o.createElement(JR,{ref:t,onNewScreen:iI,config:m,realQueryParams:l,startingFragmentQueryParams:e,enableGuest:!m.disable_guests,onTokenLoginCompleted:oI,initialScreenAfterLogin:w,defaultDeviceDisplayName:b}))}window.React=o,r.k.log("Application is running in production mode"),window.matrixLogger=r.k},"../matrix-react-sdk/src/components/views/auth/PassphraseConfirmField.tsx":(e,t,i)=>{"use strict";i.d(t,{Z:()=>c});var n=i("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=i("./node_modules/react/index.js"),o=i("../matrix-react-sdk/src/components/views/elements/Field.tsx"),a=i("../matrix-react-sdk/src/components/views/elements/Validation.tsx"),r=i("../matrix-react-sdk/src/languageHandler.tsx");class l extends s.PureComponent{constructor(...e){super(...e),(0,n.Z)(this,"validate",(0,a.Z)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,r._t)(this.props.labelRequired)},{key:"match",test:({value:e})=>!e||e===this.props.password,invalid:()=>(0,r._t)(this.props.labelInvalid)}]})),(0,n.Z)(this,"onValidate",(async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return s.createElement(o.Z,{id:this.props.id,ref:this.props.fieldRef,type:"password",label:(0,r._t)(this.props.label),autoComplete:this.props.autoComplete,value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate,autoFocus:this.props.autoFocus})}}(0,n.Z)(l,"defaultProps",{label:(0,r.I8)("auth|change_password_confirm_label"),labelRequired:(0,r.I8)("auth|change_password_confirm_label"),labelInvalid:(0,r.I8)("auth|change_password_confirm_invalid")});const c=l},"../matrix-react-sdk/src/components/views/auth/PassphraseField.tsx":(e,t,i)=>{"use strict";i.d(t,{Z:()=>p});var n=i("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=i("./node_modules/react/index.js"),o=i("../matrix-react-sdk/node_modules/classnames/index.js"),a=i.n(o),r=i("../matrix-react-sdk/src/SdkConfig.ts"),l=i("../matrix-react-sdk/src/components/views/elements/Validation.tsx"),c=i("../matrix-react-sdk/src/languageHandler.tsx"),d=i("../matrix-react-sdk/src/components/views/elements/Field.tsx"),m=i("../matrix-react-sdk/src/MatrixClientPeg.ts");class h extends s.PureComponent{constructor(...e){super(...e),(0,n.Z)(this,"validate",(0,l.Z)({description:function(e){const t=e?e.score:0;return s.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async({value:e})=>{if(!e)return null;const{scorePassword:t}=await Promise.all([i.e(794),i.e(109)]).then(i.bind(i,"../matrix-react-sdk/src/utils/PasswordScorer.ts"));return t(m.p.get(),e,this.props.userInputs)},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)(this.props.labelEnterPassword)},{key:"complexity",test:async function({value:e},t){if(!e||!t)return!1;const i=t.score>=this.props.minScore;return r.ZP.get("dangerously_allow_unsafe_and_insecure_passwords")||i},valid:function(e){return e&&e.score>=this.props.minScore?(0,c._t)(this.props.labelStrongPassword):(0,c._t)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||(0,c._t)("auth|password_field_keep_going_prompt")}}],memoize:!0})),(0,n.Z)(this,"onValidate",(async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return s.createElement(d.Z,{id:this.props.id,autoFocus:this.props.autoFocus,className:a()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:(0,c._t)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}}(0,n.Z)(h,"defaultProps",{label:(0,c.I8)("common|password"),labelEnterPassword:(0,c.I8)("auth|password_field_label"),labelStrongPassword:(0,c.I8)("auth|password_field_strong_label"),labelAllowedButUnsafe:(0,c.I8)("auth|password_field_weak_label")});const p=h},"../matrix-react-sdk/src/components/views/settings/KeyboardShortcut.tsx":(e,t,i)=>{"use strict";i.d(t,{e:()=>l});var n=i("./node_modules/react/index.js"),s=i("../matrix-react-sdk/src/accessibility/KeyboardShortcuts.ts"),o=i("../matrix-react-sdk/src/Keyboard.ts"),a=i("../matrix-react-sdk/src/languageHandler.tsx");const r=({name:e,last:t})=>{const i=s.v8[e],o=s.nk[e];return n.createElement(n.Fragment,null,n.createElement("kbd",null," ",i||o&&(0,a._t)(o)||e," "),!t&&"+")},l=({value:e,className:t="mx_KeyboardShortcut"})=>{if(!e)return null;const i=[];return e.ctrlOrCmdKey?i.push(n.createElement(r,{key:"ctrlOrCmdKey",name:o.Mq?o.sr.META:o.sr.CONTROL})):e.ctrlKey?i.push(n.createElement(r,{key:"ctrlKey",name:o.sr.CONTROL})):e.metaKey&&i.push(n.createElement(r,{key:"metaKey",name:o.sr.META})),e.altKey&&i.push(n.createElement(r,{key:"altKey",name:o.sr.ALT})),e.shiftKey&&i.push(n.createElement(r,{key:"shiftKey",name:o.sr.SHIFT})),n.createElement("div",{className:t},i,n.createElement(r,{name:e.key,last:!0}))}},"../matrix-react-sdk/src/indexing/EventIndexPeg.ts":(e,t,i)=>{"use strict";i.d(t,{Z:()=>u});var n=i("../matrix-react-sdk/node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=i("../matrix-js-sdk/src/logger.ts"),o=i("../matrix-react-sdk/src/PlatformPeg.ts"),a=i("../matrix-react-sdk/node_modules/events/events.js"),r=i("../matrix-js-sdk/src/matrix.ts"),l=i("../matrix-js-sdk/src/utils.ts"),c=i("../matrix-react-sdk/src/MatrixClientPeg.ts"),d=i("../matrix-react-sdk/src/settings/SettingsStore.ts"),m=i("../matrix-react-sdk/src/settings/SettingLevel.ts");class h extends a.EventEmitter{constructor(...e){super(...e),(0,n.Z)(this,"crawlerCheckpoints",[]),(0,n.Z)(this,"crawler",null),(0,n.Z)(this,"currentCheckpoint",null),(0,n.Z)(this,"onSync",(async(e,t,i)=>{var n;const s=null===(n=o.Z.get())||void 0===n?void 0:n.getEventIndexingManager();if(s){if("PREPARED"===t&&"SYNCING"===e){return await s.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"===t&&"SYNCING"===e&&await s.commitLiveEvents()}})),(0,n.Z)(this,"onRoomTimeline",(async(e,t,i,n,s)=>{if(!t)return;const o=c.p.safeGet();return o.isRoomEncrypted(e.getRoomId())?e.isRedaction()?this.redactEvent(e):void(!i&&s&&s.liveEvent&&!e.isRedacted()&&(await o.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))):void 0})),(0,n.Z)(this,"onRoomStateEvent",(async(e,t)=>{c.p.safeGet().isRoomEncrypted(t.roomId)&&(e.getType()!==r.EventType.RoomEncryption||await this.isRoomIndexed(t.roomId)||(s.k.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))})),(0,n.Z)(this,"redactEvent",(async e=>{var t;const i=null===(t=o.Z.get())||void 0===t?void 0:t.getEventIndexingManager();if(!i)return;const n=e.getAssociatedId();if(n)try{await i.deleteEvent(n)}catch(e){s.k.log("EventIndex: Error deleting event from index",e)}})),(0,n.Z)(this,"onTimelineReset",(async e=>{e&&c.p.safeGet().isRoomEncrypted(e.roomId)&&(s.k.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))}))}async init(){var e;const t=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(this.crawlerCheckpoints=await t.loadCheckpoints(),s.k.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners())}registerListeners(){const e=c.p.safeGet();e.on(r.ClientEvent.Sync,this.onSync),e.on(r.RoomEvent.Timeline,this.onRoomTimeline),e.on(r.RoomEvent.TimelineReset,this.onTimelineReset),e.on(r.RoomStateEvent.Events,this.onRoomStateEvent)}removeListeners(){const e=c.p.get();null!==e&&(e.removeListener(r.ClientEvent.Sync,this.onSync),e.removeListener(r.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(r.RoomEvent.TimelineReset,this.onTimelineReset),e.removeListener(r.RoomStateEvent.Events,this.onRoomStateEvent))}async addInitialCheckpoints(){var e;const t=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager();if(!t)return;const i=c.p.safeGet(),n=i.getRooms().filter((e=>i.isRoomEncrypted(e.roomId)));s.k.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(n.map((async e=>{const i=e.getLiveTimeline().getPaginationToken(r.Direction.Backward),n={roomId:e.roomId,token:i,direction:r.Direction.Backward,fullCrawl:!0},o={roomId:e.roomId,token:i,direction:r.Direction.Forward};try{n.token&&(await t.addCrawlerCheckpoint(n),this.crawlerCheckpoints.push(n)),o.token&&(await t.addCrawlerCheckpoint(o),this.crawlerCheckpoints.push(o))}catch(t){s.k.log("EventIndex: Error adding initial checkpoints for room",e.roomId,n,o,t)}})))}isValidEvent(e){const t=[r.EventType.RoomMessage,r.EventType.RoomName,r.EventType.RoomTopic].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let i=!0,n=!0;if(e.getType()!==r.EventType.RoomMessage||e.isRedacted())e.getType()!==r.EventType.RoomTopic||e.isRedacted()?e.getType()!==r.EventType.RoomName||e.isRedacted()||e.getContent().name||(n=!1):e.getContent().topic||(n=!1);else{const t=e.getContent().msgtype;i=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(n=!1)}return t&&i&&n}eventToJson(e){const t=e.getEffectiveEvent();return e.isEncrypted()?(t.curve25519Key=e.getSenderKey(),t.ed25519Key=e.getClaimedEd25519Key(),t.algorithm=e.getWireContent().algorithm,t.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete t.curve25519Key,delete t.ed25519Key,delete t.algorithm,delete t.forwardingCurve25519KeyChain),t}async addLiveEventToIndex(e){var t,i,n;const s=null===(t=o.Z.get())||void 0===t?void 0:t.getEventIndexingManager();if(!s||!this.isValidEvent(e))return;const a=this.eventToJson(e),r={displayname:null===(i=e.sender)||void 0===i?void 0:i.rawDisplayName,avatar_url:null===(n=e.sender)||void 0===n?void 0:n.getMxcAvatarUrl()};await s.addEventToIndex(a,r)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const i=t[e];await this.addLiveEventToIndex(i)}}async addRoomCheckpoint(e,t=!1){var i;const n=null===(i=o.Z.get())||void 0===i?void 0:i.getEventIndexingManager();if(!n)return;const a=c.p.safeGet().getRoom(e);if(!a)return;const l=a.getLiveTimeline(),d=l.getPaginationToken(r.Direction.Backward);if(!d)return void await this.addEventsFromLiveTimeline(l);const m={roomId:a.roomId,token:d,fullCrawl:t,direction:r.Direction.Backward};s.k.log("EventIndex: Adding checkpoint",m);try{await n.addCrawlerCheckpoint(m)}catch(e){s.k.log("EventIndex: Error adding new checkpoint for room",a.roomId,m,e)}this.crawlerCheckpoints.push(m)}async crawlerFunc(){var e;let t=!1;const i=c.p.safeGet(),n=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager();if(!n)return;this.crawler={cancel:()=>{t=!0}};let a=!1;for(;!t;){let e=d.C.getValueAt(m.R.DEVICE,"crawlerSleepTime");if(e=Math.max(e,100),a&&(e=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await(0,l._v)(e),t)break;const o=this.crawlerCheckpoints.shift();if(void 0===o){a=!0;continue}this.currentCheckpoint=o,this.emitNewCheckpoint(),a=!1;const c=i.getEventMapper({preventReEmit:!0});let h;try{h=await i.createMessagesRequest(o.roomId,o.token,100,o.direction)}catch(e){if(e instanceof r.HTTPError&&403===e.httpStatus){s.k.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",o);try{await n.removeCrawlerCheckpoint(o)}catch(e){s.k.log("EventIndex: Error removing checkpoint",o,e)}continue}s.k.log("EventIndex: Error crawling using checkpoint:",o,",",e),this.crawlerCheckpoints.push(o);continue}if(t){this.crawlerCheckpoints.push(o);break}if(0===h.chunk.length){s.k.log("EventIndex: Done with the checkpoint",o);try{await n.removeCrawlerCheckpoint(o)}catch(e){s.k.log("EventIndex: Error removing checkpoint",o,e)}continue}const p=h.chunk.map(c);let u=[];void 0!==h.state&&(u=h.state.map(c));const g={};u.forEach((e=>{"join"===e.getContent().membership&&(g[e.getSender()]={displayname:e.getContent().displayname,avatar_url:e.getContent().avatar_url})}));const v=p.filter((e=>e.isEncrypted())).map((e=>i.decryptEventIfNeeded(e,{emit:!1})));await Promise.all(v);const _=p.filter(this.isValidEvent),f=p.filter((e=>e.isRedaction())),E=_.map((e=>{const t=this.eventToJson(e);let i={};t.sender in g&&(i=g[t.sender]);return{event:t,profile:i}}));let y=null;h.end&&(y={roomId:o.roomId,token:h.end,fullCrawl:o.fullCrawl,direction:o.direction});try{for(let e=0;e<f.length;e++){const t=f[e],i=t.getAssociatedId();i?await n.deleteEvent(i):s.k.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await n.addHistoricEvents(E,y,o);if(!y){s.k.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",o);continue}!0===e&&!0!==y.fullCrawl?(s.k.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",o),await n.removeCrawlerCheckpoint(y)):(!0===e&&s.k.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",o),this.crawlerCheckpoints.push(y))}catch(e){s.k.log("EventIndex: Error during a crawl",e),this.crawlerCheckpoints.push(o)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){var e;const t=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await(null==t?void 0:t.closeEventIndex())}async search(e){var t;const i=null===(t=o.Z.get())||void 0===t?void 0:t.getEventIndexingManager();return null==i?void 0:i.searchEventIndex(e)}async loadFileEvents(e,t=10,i,n=r.EventTimeline.BACKWARDS){var a;const l=c.p.safeGet(),d=null===(a=o.Z.get())||void 0===a?void 0:a.getEventIndexingManager();if(!d)return[];const m={roomId:e.roomId,limit:t};let h;i&&(m.fromEvent=i,m.direction=n);try{h=await d.loadFileEvents(m)}catch(e){return s.k.log("EventIndex: Error getting file events",e),[]}const p=l.getEventMapper();return h.map((t=>{const i=p(t.event),n=new r.RoomMember(e.roomId,i.getSender());n.name=t.profile.displayname+" ("+i.getSender()+")";const s=p({content:{membership:"join",avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:r.EventType.RoomMember,event_id:i.getId()+":eventIndex",room_id:i.getRoomId(),sender:i.getSender(),origin_server_ts:i.getTs(),state_key:i.getSender()});return n.events.member=s,i.sender=n,i}))}async populateFileTimeline(e,t,i,n=10,o,a=r.EventTimeline.BACKWARDS){const l=await this.loadFileEvents(i,n,o,a);null===o&&(l.reverse(),a=a==r.EventTimeline.BACKWARDS?r.EventTimeline.FORWARDS:r.EventTimeline.BACKWARDS),l.forEach((i=>{e.eventIdToTimeline(i.getId())||e.addEventToTimeline(i,t,a==r.EventTimeline.BACKWARDS)}));let c=!1,d="";return l.length>0&&(d=l[l.length-1].getId(),c=!0),s.k.log("EventIndex: Populating file panel with",l.length,"events and setting the pagination token to",d),t.setPaginationToken(d,r.EventTimeline.BACKWARDS),c}paginateTimelineWindow(e,t,i,n){const s=t.getTimelineIndex(i);if(!s)return Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(t.extend(i,n))return Promise.resolve(!0);const o=(async(e,t,i,n,s)=>{var o;const a=t.timeline,r=a.getTimelineSet(),l=null!==(o=a.getPaginationToken(n))&&void 0!==o?o:void 0,c=await this.populateFileTimeline(r,a,i,s,l,n);return t.pendingPaginate=void 0,e.extend(n,s),c})(t,s,e,i,n);return s.pendingPaginate=o,o}async getStats(){var e;const t=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager();return null==t?void 0:t.getStats()}async isRoomIndexed(e){var t;const i=null===(t=o.Z.get())||void 0===t?void 0:t.getEventIndexingManager();return null==i?void 0:i.isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=c.p.safeGet();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach(((e,i)=>{t.add(e.roomId)})),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const i=c.p.safeGet();return i.getRooms().filter((e=>i.isRoomEncrypted(e.roomId))).forEach(((t,i)=>{e.add(t.roomId)})),{crawlingRooms:t,totalRooms:e}}}class p{constructor(){(0,n.Z)(this,"index",null),(0,n.Z)(this,"error",void 0),(0,n.Z)(this,"_supportIsInstalled",!1)}async init(){var e;const t=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager();return t?(this._supportIsInstalled=await t.supportsEventIndexing(),this.supportIsInstalled()?d.C.getValueAt(m.R.DEVICE,"enableEventIndexing")?this.initEventIndex():(s.k.log("EventIndex: Event indexing is disabled, not initializing"),!1):(s.k.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(s.k.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){var e;const t=new h,i=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager(),n=c.p.get();if(!i||!n)throw new Error("Unable to init event index");const a=n.getUserId(),r=n.getDeviceId();try{await i.initEventIndex(a,r);const e=await i.getUserVersion(),n=await i.isEventIndexEmpty();n?await i.setUserVersion(1):0!==e||n||(await i.closeEventIndex(),await this.deleteEventIndex(),await i.initEventIndex(a,r),await i.setUserVersion(1)),s.k.log("EventIndex: Successfully initialized the event index"),await t.init()}catch(e){return s.k.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=t,!0}platformHasSupport(){var e;return null!=(null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager())}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){var e;const t=null===(e=o.Z.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(await this.unset(),s.k.log("EventIndex: Deleting event index."),await t.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new p);const u=window.mxEventIndexPeg},"../matrix-react-sdk/res/img/stickerpack-placeholder.png":e=>{e.exports="img/stickerpack-placeholder.c50e1de.png"},"../matrix-react-sdk/res/img/user-onboarding/CommunityMessaging.png":e=>{e.exports="img/user-onboarding/CommunityMessaging.85955ea.png"},"../matrix-react-sdk/res/img/user-onboarding/PersonalMessaging.png":e=>{e.exports="img/user-onboarding/PersonalMessaging.b5ba3c4.png"},"../matrix-react-sdk/res/img/user-onboarding/WorkMessaging.png":e=>{e.exports="img/user-onboarding/WorkMessaging.f3c8ccf.png"},"../matrix-react-sdk/src/effects lazy recursive ^\\.\\/.*$ referencedExports: default":(e,t,i)=>{var n={"./":["../matrix-react-sdk/src/effects/index.ts",9],"./ICanvasEffect":["../matrix-react-sdk/src/effects/ICanvasEffect.ts",7,4208],"./ICanvasEffect.ts":["../matrix-react-sdk/src/effects/ICanvasEffect.ts",7,4208],"./confetti":["../matrix-react-sdk/src/effects/confetti/index.ts",9,7626],"./confetti/":["../matrix-react-sdk/src/effects/confetti/index.ts",9,7626],"./confetti/index":["../matrix-react-sdk/src/effects/confetti/index.ts",9,7626],"./confetti/index.ts":["../matrix-react-sdk/src/effects/confetti/index.ts",9,7626],"./effect":["../matrix-react-sdk/src/effects/effect.ts",9,8493],"./effect.ts":["../matrix-react-sdk/src/effects/effect.ts",9,8493],"./fireworks":["../matrix-react-sdk/src/effects/fireworks/index.ts",9,7280],"./fireworks/":["../matrix-react-sdk/src/effects/fireworks/index.ts",9,7280],"./fireworks/index":["../matrix-react-sdk/src/effects/fireworks/index.ts",9,7280],"./fireworks/index.ts":["../matrix-react-sdk/src/effects/fireworks/index.ts",9,7280],"./hearts":["../matrix-react-sdk/src/effects/hearts/index.ts",9,3231],"./hearts/":["../matrix-react-sdk/src/effects/hearts/index.ts",9,3231],"./hearts/index":["../matrix-react-sdk/src/effects/hearts/index.ts",9,3231],"./hearts/index.ts":["../matrix-react-sdk/src/effects/hearts/index.ts",9,3231],"./index":["../matrix-react-sdk/src/effects/index.ts",9],"./index.ts":["../matrix-react-sdk/src/effects/index.ts",9],"./rainfall":["../matrix-react-sdk/src/effects/rainfall/index.ts",9,3232],"./rainfall/":["../matrix-react-sdk/src/effects/rainfall/index.ts",9,3232],"./rainfall/index":["../matrix-react-sdk/src/effects/rainfall/index.ts",9,3232],"./rainfall/index.ts":["../matrix-react-sdk/src/effects/rainfall/index.ts",9,3232],"./snowfall":["../matrix-react-sdk/src/effects/snowfall/index.ts",9,4911],"./snowfall/":["../matrix-react-sdk/src/effects/snowfall/index.ts",9,4911],"./snowfall/index":["../matrix-react-sdk/src/effects/snowfall/index.ts",9,4911],"./snowfall/index.ts":["../matrix-react-sdk/src/effects/snowfall/index.ts",9,4911],"./spaceinvaders":["../matrix-react-sdk/src/effects/spaceinvaders/index.ts",9,562],"./spaceinvaders/":["../matrix-react-sdk/src/effects/spaceinvaders/index.ts",9,562],"./spaceinvaders/index":["../matrix-react-sdk/src/effects/spaceinvaders/index.ts",9,562],"./spaceinvaders/index.ts":["../matrix-react-sdk/src/effects/spaceinvaders/index.ts",9,562],"./utils":["../matrix-react-sdk/src/effects/utils.ts",9],"./utils.ts":["../matrix-react-sdk/src/effects/utils.ts",9]};function s(e){if(!i.o(n,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],s=t[0];return Promise.all(t.slice(2).map(i.e)).then((()=>i.t(s,16|t[1])))}s.keys=()=>Object.keys(n),s.id="../matrix-react-sdk/src/effects lazy recursive ^\\.\\/.*$ referencedExports: default",e.exports=s}}]);
//# sourceMappingURL=element-web-app.js.map